<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>AAVE V1 源码阅读 - 敬渊&#39;s Blog</title><meta name="author" content="">
<meta name="description" content="
1 架构鸟瞰（Bird&rsquo;s-eye View） 图 4 提供了 Aave V1 在执行层与状态层之间的完整流向：用户与外部协议主要通过 LendingPool 交互，这个无状态的业务控制器只负责校验与流程调度；资金托管、计息、估值与状态存储都被剥离到 LendingPoolCore。为将白皮书中的抽象模型映射到源码，本章按照“入口 → 状态 → 策略”的顺序梳理模块职责与依赖关系，后续章节将沿这些箭头展开函数与事件的细节。
"><meta name="keywords" content='论文阅读'>
  <meta itemprop="name" content="AAVE v1 源码阅读">
  <meta itemprop="description" content="1 架构鸟瞰（Bird’s-eye View） 图 4 提供了 Aave V1 在执行层与状态层之间的完整流向：用户与外部协议主要通过 LendingPool 交互，这个无状态的业务控制器只负责校验与流程调度；资金托管、计息、估值与状态存储都被剥离到 LendingPoolCore。为将白皮书中的抽象模型映射到源码，本章按照“入口 → 状态 → 策略”的顺序梳理模块职责与依赖关系，后续章节将沿这些箭头展开函数与事件的细节。">
  <meta itemprop="datePublished" content="2026-01-20T00:00:00+00:00">
  <meta itemprop="dateModified" content="2026-01-20T00:00:00+00:00">
  <meta itemprop="wordCount" content="18214">
  <meta itemprop="keywords" content="论文阅读"><meta property="og:url" content="https://nesl42.github.io/posts/202601-aavev1source/">
  <meta property="og:site_name" content="敬渊&#39;s Blog">
  <meta property="og:title" content="AAVE v1 源码阅读">
  <meta property="og:description" content="1 架构鸟瞰（Bird’s-eye View） 图 4 提供了 Aave V1 在执行层与状态层之间的完整流向：用户与外部协议主要通过 LendingPool 交互，这个无状态的业务控制器只负责校验与流程调度；资金托管、计息、估值与状态存储都被剥离到 LendingPoolCore。为将白皮书中的抽象模型映射到源码，本章按照“入口 → 状态 → 策略”的顺序梳理模块职责与依赖关系，后续章节将沿这些箭头展开函数与事件的细节。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2026-01-20T00:00:00+00:00">
    <meta property="article:modified_time" content="2026-01-20T00:00:00+00:00">
    <meta property="article:tag" content="论文阅读">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="AAVE v1 源码阅读">
  <meta name="twitter:description" content="1 架构鸟瞰（Bird’s-eye View） 图 4 提供了 Aave V1 在执行层与状态层之间的完整流向：用户与外部协议主要通过 LendingPool 交互，这个无状态的业务控制器只负责校验与流程调度；资金托管、计息、估值与状态存储都被剥离到 LendingPoolCore。为将白皮书中的抽象模型映射到源码，本章按照“入口 → 状态 → 策略”的顺序梳理模块职责与依赖关系，后续章节将沿这些箭头展开函数与事件的细节。">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="https://nesl42.github.io/posts/202601-aavev1source/" title="AAVE v1 源码阅读 - 敬渊&#39;s Blog" /><link rel="prev" type="text/html" href="https://nesl42.github.io/posts/202601-aavev1/" title="AAVE v1 白皮书阅读" /><link rel="next" type="text/html" href="https://nesl42.github.io/posts/202601-paper1/" title="论文阅读《中国市场的盈余公告：隔夜与日内收益差异》" /><link rel="stylesheet" href="/css/config.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "AAVE v1 源码阅读",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/nesl42.github.io\/posts\/202601-aavev1source\/"
    },"genre": "posts","keywords": "论文阅读","wordcount":  18214 ,
    "url": "https:\/\/nesl42.github.io\/posts\/202601-aavev1source\/","datePublished": "2026-01-20T00:00:00+00:00","dateModified": "2026-01-20T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "作者"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-instant-intensity="viewport" data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/">文章</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/">标签</a></li><li class="menu-item">
              <a class="menu-link" href="/about/">关于</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/">分类</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" role="button" aria-label="切换主题" title="切换主题"><i class="fa-solid fa-adjust" aria-hidden="true"></i></li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="theme-switch" role="button" aria-label="切换主题"><i class="fa-solid fa-adjust" aria-hidden="true"></i></div>
      <div class="menu-toggle" id="menu-toggle-mobile" role="button" aria-labelledby="menu-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="/posts/">文章</a></li><li class="menu-item"><a class="menu-link" href="/tags/">标签</a></li><li class="menu-item"><a class="menu-link" href="/about/">关于</a></li><li class="menu-item"><a class="menu-link" href="/categories/">分类</a></li><li class="menu-item menu-system"></li>
      </ul>
    </nav>
  </div>
</header><main class="fi-container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>AAVE V1 源码阅读</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/technology/" class="post-category" title="分类 - Technology"><i class="fa-regular fa-folder" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="发布于 2026-01-20 00:00:00"><i class="fa-solid fa-calendar-days me-1" aria-hidden="true"></i><time datetime="2026-01-20">2026-01-20</time></span>&nbsp;<span title="18214 字"><i class="fa-solid fa-pencil-alt me-1" aria-hidden="true"></i>约 18300 字</span>&nbsp;<span><i class="fa-regular fa-clock me-1" aria-hidden="true"></i>预计阅读 37 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-架构鸟瞰birds-eye-view">1 架构鸟瞰（Bird&rsquo;s-eye View）</a>
      <ul>
        <li><a href="#11-用户入口与门面层">1.1 用户入口与门面层</a></li>
        <li><a href="#12-状态与估值层">1.2 状态与估值层</a></li>
        <li><a href="#13-策略治理与注册表">1.3 策略、治理与注册表</a></li>
      </ul>
    </li>
    <li><a href="#2-lendingpool入口逻辑">2 LendingPool：入口逻辑</a>
      <ul>
        <li><a href="#21-deposit">2.1 <code>deposit</code></a></li>
        <li><a href="#22-borrow">2.2 <code>borrow</code></a></li>
        <li><a href="#23-repay">2.3 <code>repay</code></a></li>
        <li><a href="#24-flashloan">2.4 <code>flashLoan</code></a></li>
        <li><a href="#25-liquidationcall">2.5 <code>liquidationCall</code></a></li>
      </ul>
    </li>
    <li><a href="#3-lendingpoolcore资金与索引">3 LendingPoolCore：资金与索引</a>
      <ul>
        <li><a href="#31-状态结构reservedata-与-userreservedata">3.1 状态结构：ReserveData 与 UserReserveData</a></li>
        <li><a href="#32-惰性计息与状态刷新">3.2 惰性计息与状态刷新</a></li>
        <li><a href="#33-资金入口与费用路径">3.3 资金入口与费用路径</a></li>
        <li><a href="#34-利用率-白皮书-123--getreserveutilizationrate">3.4 利用率 ：白皮书 §1.2.3 ↔ <code>getReserveUtilizationRate</code></a></li>
        <li><a href="#35-指数体系白皮书-128-的链上实现">3.5 指数体系：白皮书 §1.2.8 的链上实现</a></li>
        <li><a href="#36-利率刷新白皮书-124127--defaultreserveinterestratestrategy">3.6 利率刷新：白皮书 §1.2.4/§1.2.7 ↔ <code>DefaultReserveInterestRateStrategy</code></a></li>
        <li><a href="#37-数据出口与抵押开关">3.7 数据出口与抵押开关</a></li>
      </ul>
    </li>
    <li><a href="#4-atoken-与-dataprovider凭证与估值">4 AToken 与 DataProvider：凭证与估值</a>
      <ul>
        <li><a href="#41-atoken-的指数余额模型">4.1 aToken 的指数余额模型</a></li>
        <li><a href="#42-健康因子--与-dataprovider白皮书-111210">4.2 健康因子  与 DataProvider：白皮书 §1.1/§1.2.10</a></li>
        <li><a href="#43-清算二次校验balancedecreaseallowed-与-liquidationcall">4.3 清算二次校验：<code>balanceDecreaseAllowed</code> 与 <code>liquidationCall</code></a></li>
        <li><a href="#44-转账与利息重定向延续原笔记">4.4 转账与利息重定向（延续原笔记）</a></li>
        <li><a href="#5-数学底座wadraymath-与利率分段策略">5 数学底座：WadRayMath 与利率分段策略</a>
          <ul>
            <li><a href="#51-wadray-精度白皮书-128-的数值基础">5.1 Wad/Ray 精度：白皮书 §1.2.8 的数值基础</a></li>
            <li><a href="#52-分段利率策略再访">5.2 分段利率策略再访</a></li>
          </ul>
        </li>
        <li><a href="#43-lendingpooldataprovider-的聚合视图">4.3 LendingPoolDataProvider 的聚合视图</a></li>
      </ul>
    </li>
    <li><a href="#5-策略与治理模块">5 策略与治理模块</a>
      <ul>
        <li><a href="#51-利率策略defaultreserveinterestratestrategy">5.1 利率策略：DefaultReserveInterestRateStrategy</a></li>
        <li><a href="#52-费用与参数提供者">5.2 费用与参数提供者</a></li>
        <li><a href="#53-配置器lendingpoolconfigurator">5.3 配置器：LendingPoolConfigurator</a></li>
        <li><a href="#54-注册表lendingpooladdressesprovider">5.4 注册表：LendingPoolAddressesProvider</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p><img loading="lazy" src='/posts/202601-aavev1source/file-20260121000438250.png' alt="/posts/202601-aavev1source/file-20260121000438250.png" height="1006" width="1426"></p>
<h2 class="heading-element" id="1-架构鸟瞰birds-eye-view"><span>1 架构鸟瞰（Bird&rsquo;s-eye View）</span>
  <a href="#1-%e6%9e%b6%e6%9e%84%e9%b8%9f%e7%9e%b0birds-eye-view" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>图 4 提供了 Aave V1 在执行层与状态层之间的完整流向：用户与外部协议主要通过 <code>LendingPool</code> 交互，这个无状态的业务控制器只负责校验与流程调度；资金托管、计息、估值与状态存储都被剥离到 <code>LendingPoolCore</code>。为将白皮书中的抽象模型映射到源码，本章按照“入口 → 状态 → 策略”的顺序梳理模块职责与依赖关系，后续章节将沿这些箭头展开函数与事件的细节。</p>
<div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    User->>LendingPool: deposit/borrow/repay
    LendingPool->>LendingPoolCore: updateState*()
    LendingPoolCore-->>LendingPool: 累计索引与可用流动性
    LendingPool->>AToken: mint/burn/transfer
    AToken-->>User: 凭证余额变动
    LendingPool->>DataProvider: global/account data
    Governance->>AddressesProvider: 更新各组件地址</pre>
  <pre class="mermaid-dark">sequenceDiagram
    User->>LendingPool: deposit/borrow/repay
    LendingPool->>LendingPoolCore: updateState*()
    LendingPoolCore-->>LendingPool: 累计索引与可用流动性
    LendingPool->>AToken: mint/burn/transfer
    AToken-->>User: 凭证余额变动
    LendingPool->>DataProvider: global/account data
    Governance->>AddressesProvider: 更新各组件地址</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    User->>LendingPool: deposit/borrow/repay
    LendingPool->>LendingPoolCore: updateState*()
    LendingPoolCore-->>LendingPool: 累计索引与可用流动性
    LendingPool->>AToken: mint/burn/transfer
    AToken-->>User: 凭证余额变动
    LendingPool->>DataProvider: global/account data
    Governance->>AddressesProvider: 更新各组件地址</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    User->>LendingPool: deposit/borrow/repay
    LendingPool->>LendingPoolCore: updateState*()
    LendingPoolCore-->>LendingPool: 累计索引与可用流动性
    LendingPool->>AToken: mint/burn/transfer
    AToken-->>User: 凭证余额变动
    LendingPool->>DataProvider: global/account data
    Governance->>AddressesProvider: 更新各组件地址</pre></template>
</div><h3 class="heading-element" id="11-用户入口与门面层"><span>1.1 用户入口与门面层</span>
  <a href="#11-%e7%94%a8%e6%88%b7%e5%85%a5%e5%8f%a3%e4%b8%8e%e9%97%a8%e9%9d%a2%e5%b1%82" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><code>contracts/lendingpool/LendingPool.sol</code> 对外暴露 <code>deposit / borrow / repay / redeem / swap / flashLoan</code>，内部遵循“权限验证 → 状态更新 → 资产划转”的三段式流程，各种修饰器（<code>onlyActiveReserve</code>、<code>onlyOverlyingAToken</code> 等）统一了安全边界。赎回场景中，用户往往直接与 <code>AToken.redeem</code> 交互，由 aToken 回调 <code>LendingPool.redeemUnderlying</code> 以销毁凭证并释放底层资产。<code>LendingPoolLiquidationManager.sol</code> 不是独立入口，而是通过 <code>delegatecall</code> 挂载到 <code>LendingPool</code> 上下文中执行清算逻辑，既复用了校验，又避免核心合约字节码过大。<code>flashLoan</code> 则在控制器内部完成计费与余额校验，再把控制权交给实现了 <code>IFlashLoanReceiver</code> 的外部合约；<code>FlashLoanReceiverBase.sol</code> 只是这些外部合约的开发模板，负责取核心地址和归还资金，并非协议自身的安全防线。所有依赖由 <code>LendingPoolAddressesProvider</code> 统一注册与注入，确保升级和组件寻址在同一入口完成。</p>
<div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    User->>LendingPool: 调用入口函数
    LendingPool->>AddressesProvider: 查询依赖 (Core/DataProvider/FeeProvider)
    LendingPool->>LendingPoolLiquidationManager: delegatecall 清算
    FlashLoanReceiver->>LendingPool: flashLoan
    LendingPool-->>FlashLoanReceiver: executeOperation 回调</pre>
  <pre class="mermaid-dark">sequenceDiagram
    User->>LendingPool: 调用入口函数
    LendingPool->>AddressesProvider: 查询依赖 (Core/DataProvider/FeeProvider)
    LendingPool->>LendingPoolLiquidationManager: delegatecall 清算
    FlashLoanReceiver->>LendingPool: flashLoan
    LendingPool-->>FlashLoanReceiver: executeOperation 回调</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    User->>LendingPool: 调用入口函数
    LendingPool->>AddressesProvider: 查询依赖 (Core/DataProvider/FeeProvider)
    LendingPool->>LendingPoolLiquidationManager: delegatecall 清算
    FlashLoanReceiver->>LendingPool: flashLoan
    LendingPool-->>FlashLoanReceiver: executeOperation 回调</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    User->>LendingPool: 调用入口函数
    LendingPool->>AddressesProvider: 查询依赖 (Core/DataProvider/FeeProvider)
    LendingPool->>LendingPoolLiquidationManager: delegatecall 清算
    FlashLoanReceiver->>LendingPool: flashLoan
    LendingPool-->>FlashLoanReceiver: executeOperation 回调</pre></template>
</div><h3 class="heading-element" id="12-状态与估值层"><span>1.2 状态与估值层</span>
  <a href="#12-%e7%8a%b6%e6%80%81%e4%b8%8e%e4%bc%b0%e5%80%bc%e5%b1%82" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><code>contracts/lendingpool/LendingPoolCore.sol</code> 是 V1 的“保险库”：底层资产直接托管在 Core 中，而非像 V2/V3 那样散布在 aToken。它维护 <code>ReserveData</code>、<code>UserReserveData</code>、<code>liquidityIndex</code>、<code>borrowIndex</code> 等惰性计息变量，并通过 <code>CoreLibrary.sol</code> 与 <code>WadRayMath.sol</code> 完成高精度利息累积与索引更新。<code>tokenization/AToken.sol</code> 将这些核心状态映射成 ERC20 凭证，结合 <code>principalBalance + redirectedBalance</code> 让余额随时间自动增长。<code>LendingPoolDataProvider.sol</code> 聚合视图数据：它直接从 Core 读取原始头寸，借助 <code>IPriceOracleGetter</code> 折算成 ETH 计价的 LTV、Liquidation Threshold、Health Factor 以及可借额度（注意：<code>calculateUserGlobalData</code> 等函数在估算费用时依赖 <code>msg.sender</code>，即结果与调用者相关）。三者形成“状态存储 → 数据聚合 → 头寸表示”的闭环，并把资金与会计逻辑与业务入口解耦。</p>
<div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    LendingPool->>LendingPoolCore: 读写 ReserveData/UserReserveData
    LendingPoolCore->>AToken: getReserveATokenAddress()
    AToken->>LendingPoolCore: balanceOf()/normalizedIncome
    DataProvider->>LendingPoolCore: getReserves()/getUserBasicReserveData
    DataProvider->>PriceOracle: getAssetPrice()</pre>
  <pre class="mermaid-dark">sequenceDiagram
    LendingPool->>LendingPoolCore: 读写 ReserveData/UserReserveData
    LendingPoolCore->>AToken: getReserveATokenAddress()
    AToken->>LendingPoolCore: balanceOf()/normalizedIncome
    DataProvider->>LendingPoolCore: getReserves()/getUserBasicReserveData
    DataProvider->>PriceOracle: getAssetPrice()</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    LendingPool->>LendingPoolCore: 读写 ReserveData/UserReserveData
    LendingPoolCore->>AToken: getReserveATokenAddress()
    AToken->>LendingPoolCore: balanceOf()/normalizedIncome
    DataProvider->>LendingPoolCore: getReserves()/getUserBasicReserveData
    DataProvider->>PriceOracle: getAssetPrice()</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    LendingPool->>LendingPoolCore: 读写 ReserveData/UserReserveData
    LendingPoolCore->>AToken: getReserveATokenAddress()
    AToken->>LendingPoolCore: balanceOf()/normalizedIncome
    DataProvider->>LendingPoolCore: getReserves()/getUserBasicReserveData
    DataProvider->>PriceOracle: getAssetPrice()</pre></template>
</div><h3 class="heading-element" id="13-策略治理与注册表"><span>1.3 策略、治理与注册表</span>
  <a href="#13-%e7%ad%96%e7%95%a5%e6%b2%bb%e7%90%86%e4%b8%8e%e6%b3%a8%e5%86%8c%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><code>LendingPoolAddressesProvider.sol</code> 扮演注册表（协议的 DNS）：它保存最新的 <code>LendingPool</code>、<code>Core</code>、<code>Configurator</code> 等地址，为可升级系统提供解耦。<code>DefaultReserveInterestRateStrategy.sol</code> 基于储备利用率（Kink 曲线）与 <code>ILendingRateOracle</code> 输出稳定/浮动利率，<code>FeeProvider.sol</code> 统一计算开仓费用；<code>LendingPoolConfigurator.sol</code> 则拥有极高权限，负责 <code>initReserve</code>、启用/禁用借款、调整 LTV、Liquidation Threshold、利率曲线等风险参数。通过注册表、策略合约和治理配置三件套，协议可以在不触碰资产托管层的前提下根据市场环境调整策略，与上游的价格预言机与数据提供层一道，形成完整的“参数 + 策略 + 注册表”控制面板。</p>
<div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    Governance->>AddressesProvider: setLendingPoolImpl()/...
    LendingPool->>AddressesProvider: getLendingPoolCore()
    Configurator->>LendingPoolCore: enableReserveAsCollateral()
    Core->>InterestRateStrategy: calculateInterestRates()
    LendingPool->>FeeProvider: calculateLoanOriginationFee()</pre>
  <pre class="mermaid-dark">sequenceDiagram
    Governance->>AddressesProvider: setLendingPoolImpl()/...
    LendingPool->>AddressesProvider: getLendingPoolCore()
    Configurator->>LendingPoolCore: enableReserveAsCollateral()
    Core->>InterestRateStrategy: calculateInterestRates()
    LendingPool->>FeeProvider: calculateLoanOriginationFee()</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    Governance->>AddressesProvider: setLendingPoolImpl()/...
    LendingPool->>AddressesProvider: getLendingPoolCore()
    Configurator->>LendingPoolCore: enableReserveAsCollateral()
    Core->>InterestRateStrategy: calculateInterestRates()
    LendingPool->>FeeProvider: calculateLoanOriginationFee()</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    Governance->>AddressesProvider: setLendingPoolImpl()/...
    LendingPool->>AddressesProvider: getLendingPoolCore()
    Configurator->>LendingPoolCore: enableReserveAsCollateral()
    Core->>InterestRateStrategy: calculateInterestRates()
    LendingPool->>FeeProvider: calculateLoanOriginationFee()</pre></template>
</div><blockquote>
<p>本章确定了合约之间的依赖图谱。接下来将以每个合约为单位，结合白皮书对应章节，分析函数实现、状态变迁以及跨模块的接口契约。</p>
</blockquote>
<h2 class="heading-element" id="2-lendingpool入口逻辑"><span>2 LendingPool：入口逻辑</span>
  <a href="#2-lendingpool%e5%85%a5%e5%8f%a3%e9%80%bb%e8%be%91" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>拆解关键流程（deposit/borrow/repay/flashLoan/liquidationCall），说明校验顺序、与 Core/DataProvider/FeeProvider 的交互、常见修饰器。可穿插函数调用图或伪代码。</p>
<div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    User->>LendingPool: 调用入口函数
    LendingPool->>DataProvider: calculateUserGlobalData()
    LendingPool->>FeeProvider: calculateLoanOriginationFee()
    LendingPool->>LendingPoolCore: updateState*()
    LendingPool->>AToken: mint/burn/redeem
    LendingPool-->>User: 事件 + 资产划转结果</pre>
  <pre class="mermaid-dark">sequenceDiagram
    User->>LendingPool: 调用入口函数
    LendingPool->>DataProvider: calculateUserGlobalData()
    LendingPool->>FeeProvider: calculateLoanOriginationFee()
    LendingPool->>LendingPoolCore: updateState*()
    LendingPool->>AToken: mint/burn/redeem
    LendingPool-->>User: 事件 + 资产划转结果</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    User->>LendingPool: 调用入口函数
    LendingPool->>DataProvider: calculateUserGlobalData()
    LendingPool->>FeeProvider: calculateLoanOriginationFee()
    LendingPool->>LendingPoolCore: updateState*()
    LendingPool->>AToken: mint/burn/redeem
    LendingPool-->>User: 事件 + 资产划转结果</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    User->>LendingPool: 调用入口函数
    LendingPool->>DataProvider: calculateUserGlobalData()
    LendingPool->>FeeProvider: calculateLoanOriginationFee()
    LendingPool->>LendingPoolCore: updateState*()
    LendingPool->>AToken: mint/burn/redeem
    LendingPool-->>User: 事件 + 资产划转结果</pre></template>
</div><h3 class="heading-element" id="21-deposit"><span>2.1 <code>deposit</code></span>
  <a href="#21-deposit" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>存款是 V1 流动性的来源，对应白皮书 §3.1 图 6 的“资产转移 → aToken 铸造 → 状态更新”。<code>LendingPool.deposit</code> 在入口层仍然先做安全校验，再把状态计算、凭证铸造与资金托管分发给下层组件：</p>
<ol>
<li><strong>权限与状态检查</strong>：<code>nonReentrant</code>、<code>onlyActiveReserve</code>、<code>onlyUnfreezedReserve</code>、<code>onlyAmountGreaterThanZero</code> 共同保证储备可用、金额有效、防止重入攻击。</li>
<li><strong>识别首次存款者</strong>：读取 <code>aToken.balanceOf(msg.sender)</code> 判定 <code>isFirstDeposit</code>，方便 Core 在更新状态时将 <code>useAsCollateral</code> 从 0 切换到 1。</li>
<li><strong>状态更新</strong>：<code>core.updateStateOnDeposit</code> 刷新储备的流动性指数和时间戳，并在首次存款时开启抵押标记；实际余额的变动由随后 <code>transferToReserve</code> 的资金转账体现。</li>
<li><strong>aToken 铸造</strong>：<code>aToken.mintOnDeposit</code> 将 <code>_amount</code> 直映为 ERC20 余额，不需要额外汇率，因为 aToken 余额后续会乘 <code>liquidityIndex</code> 自动增长。</li>
<li><strong>资金划转与事件</strong>：<code>core.transferToReserve</code> 将资产真正存入保险库（ERC20 路径调用 <code>safeTransferFrom</code>，ETH 路径根据 <code>msg.value</code> 进账并退还多余金额），随后 <code>Deposit</code> 事件把储备、金额、推荐码广播给前端或积分系统。</li>
<li><strong>资产类型处理</strong>：函数被标记为 <code>payable</code> 方便 ETH 存款，而 ERC20 存款所需的授权与转账逻辑全部封装在 Core 内部，协议代码显式区分两种资产路径。</li>
<li><strong>隐式前置条件</strong>：用户在存 ERC20 前必须先对 <code>LendingPoolCore</code> <code>approve</code> 足够额度；协议以组合操作的形式优化 gas 成本，因此需要前端流程引导。</li>
</ol>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @dev 将基础资产存入储备池中。同时会铸造相应数量的覆盖资产（aToken）
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param _reserve reserve 的地址
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param _amount 存入金额
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param _referralCode integrators are assigned a referral code and can potentially receive rewards.
</span></span></span><span class="line"><span class="cl"><span class="cm">     **/</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">deposit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint16</span> <span class="n">_referralCode</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">external</span>
</span></span><span class="line"><span class="cl">        <span class="k">payable</span>
</span></span><span class="line"><span class="cl">        <span class="n">nonReentrant</span>
</span></span><span class="line"><span class="cl">        <span class="n">onlyActiveReserve</span><span class="p">(</span><span class="n">_reserve</span><span class="p">)</span> <span class="c1">// 检查储备池是否处于活跃状态
</span></span></span><span class="line"><span class="cl">        <span class="n">onlyUnfreezedReserve</span><span class="p">(</span><span class="n">_reserve</span><span class="p">)</span> <span class="c1">// 检查储备池是否处于冻结状态
</span></span></span><span class="line"><span class="cl">        <span class="n">onlyAmountGreaterThanZero</span><span class="p">(</span><span class="n">_amount</span><span class="p">)</span> <span class="c1">// 检查存入金额是否大于0
</span></span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取 aToken 合约地址
</span></span></span><span class="line"><span class="cl">        <span class="n">AToken</span> <span class="n">aToken</span> <span class="o">=</span> <span class="n">AToken</span><span class="p">(</span><span class="n">core</span><span class="p">.</span><span class="n">getReserveATokenAddress</span><span class="p">(</span><span class="n">_reserve</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 判断是否是第一次存入
</span></span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">isFirstDeposit</span> <span class="o">=</span> <span class="n">aToken</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 更新状态
</span></span></span><span class="line"><span class="cl">        <span class="n">core</span><span class="p">.</span><span class="n">updateStateOnDeposit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_amount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">isFirstDeposit</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 按特定兑换率以1:1比例向用户铸造AToken
</span></span></span><span class="line"><span class="cl">        <span class="n">aToken</span><span class="p">.</span><span class="n">mintOnDeposit</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 将资产转账到核心合约
</span></span></span><span class="line"><span class="cl">        <span class="n">core</span><span class="p">.</span><span class="n">transferToReserve</span><span class="p">.</span><span class="nb">value</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">)(</span><span class="n">_reserve</span><span class="p">,</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//solium-disable-next-line
</span></span></span><span class="line"><span class="cl">        <span class="c1">// 发出存款事件
</span></span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Deposit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_amount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_referralCode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nb">block</span><span class="p">.</span><span class="nb">timestamp</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    User->>LendingPool: borrow(_reserve, _amount, _rateMode)
    LendingPool->>LendingPoolCore: isReserveBorrowingEnabled()/getReserveAvailableLiquidity()
    LendingPool->>LendingPoolDataProvider: calculateUserGlobalData()
    LendingPool->>FeeProvider: calculateLoanOriginationFee()
    LendingPool->>LendingPoolCore: updateStateOnBorrow(...)
    LendingPoolCore-->>LendingPool: 最终借款利率、borrowBalanceIncrease
    LendingPool->>User: transferToUser(_reserve, _amount)</pre>
  <pre class="mermaid-dark">sequenceDiagram
    User->>LendingPool: borrow(_reserve, _amount, _rateMode)
    LendingPool->>LendingPoolCore: isReserveBorrowingEnabled()/getReserveAvailableLiquidity()
    LendingPool->>LendingPoolDataProvider: calculateUserGlobalData()
    LendingPool->>FeeProvider: calculateLoanOriginationFee()
    LendingPool->>LendingPoolCore: updateStateOnBorrow(...)
    LendingPoolCore-->>LendingPool: 最终借款利率、borrowBalanceIncrease
    LendingPool->>User: transferToUser(_reserve, _amount)</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    User->>LendingPool: borrow(_reserve, _amount, _rateMode)
    LendingPool->>LendingPoolCore: isReserveBorrowingEnabled()/getReserveAvailableLiquidity()
    LendingPool->>LendingPoolDataProvider: calculateUserGlobalData()
    LendingPool->>FeeProvider: calculateLoanOriginationFee()
    LendingPool->>LendingPoolCore: updateStateOnBorrow(...)
    LendingPoolCore-->>LendingPool: 最终借款利率、borrowBalanceIncrease
    LendingPool->>User: transferToUser(_reserve, _amount)</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    User->>LendingPool: borrow(_reserve, _amount, _rateMode)
    LendingPool->>LendingPoolCore: isReserveBorrowingEnabled()/getReserveAvailableLiquidity()
    LendingPool->>LendingPoolDataProvider: calculateUserGlobalData()
    LendingPool->>FeeProvider: calculateLoanOriginationFee()
    LendingPool->>LendingPoolCore: updateStateOnBorrow(...)
    LendingPoolCore-->>LendingPool: 最终借款利率、borrowBalanceIncrease
    LendingPool->>User: transferToUser(_reserve, _amount)</pre></template>
</div><div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    User->>LendingPool: deposit(_reserve, _amount)
    LendingPool->>LendingPoolCore: updateStateOnDeposit(...)
    LendingPoolCore-->>LendingPool: 索引更新完成
    LendingPool->>AToken: mintOnDeposit(msg.sender, _amount)
    AToken-->>User: 增加 aToken 余额
    LendingPool->>LendingPoolCore: transferToReserve(...)</pre>
  <pre class="mermaid-dark">sequenceDiagram
    User->>LendingPool: deposit(_reserve, _amount)
    LendingPool->>LendingPoolCore: updateStateOnDeposit(...)
    LendingPoolCore-->>LendingPool: 索引更新完成
    LendingPool->>AToken: mintOnDeposit(msg.sender, _amount)
    AToken-->>User: 增加 aToken 余额
    LendingPool->>LendingPoolCore: transferToReserve(...)</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    User->>LendingPool: deposit(_reserve, _amount)
    LendingPool->>LendingPoolCore: updateStateOnDeposit(...)
    LendingPoolCore-->>LendingPool: 索引更新完成
    LendingPool->>AToken: mintOnDeposit(msg.sender, _amount)
    AToken-->>User: 增加 aToken 余额
    LendingPool->>LendingPoolCore: transferToReserve(...)</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    User->>LendingPool: deposit(_reserve, _amount)
    LendingPool->>LendingPoolCore: updateStateOnDeposit(...)
    LendingPoolCore-->>LendingPool: 索引更新完成
    LendingPool->>AToken: mintOnDeposit(msg.sender, _amount)
    AToken-->>User: 增加 aToken 余额
    LendingPool->>LendingPoolCore: transferToReserve(...)</pre></template>
</div><h3 class="heading-element" id="22-borrow"><span>2.2 <code>borrow</code></span>
  <a href="#22-borrow" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>借款对应白皮书 §3.2 中“抵押额度 → 借款模式 → 资金释放”的流程，V1 中的实现完全落在 <code>LendingPool.borrow</code>。函数使用 <code>BorrowLocalVars</code> 暂存数据，避免 “Stack too deep” 并保持流水线式的校验顺序：</p>
<ol>
<li><strong>入口修饰器与储备可借性</strong>：<code>nonReentrant</code>、<code>onlyActiveReserve</code>、<code>onlyUnfreezedReserve</code>、<code>onlyAmountGreaterThanZero</code> 校验基本条件，随后 <code>core.isReserveBorrowingEnabled</code>、<code>core.getReserveAvailableLiquidity</code> 保障储备层允许借款且流动性足够。传入的 <code>_interestRateMode</code> 必须是 1 (STABLE) 或 2 (VARIABLE)，否则直接 revert。</li>
<li><strong>账户总览校验</strong>：通过 <code>dataProvider.calculateUserGlobalData(msg.sender)</code> 一次性取回用户的抵押余额、借款余额、总费用、LTV、Liquidation Threshold 以及 <code>healthFactorBelowThreshold</code> 标记。要求抵押余额大于 0 且当前 Health Factor 不低于 1，否则禁止继续借款。</li>
<li><strong>开仓费用与抵押需求</strong>：<code>feeProvider.calculateLoanOriginationFee</code> 对借款金额计算开仓费用，并且要求费用 &gt; 0（防止金额过小）。接着使用 <code>dataProvider.calculateCollateralNeededInETH</code> 折算为 ETH 计价的最小抵押物需求，该公式将 <code>_amount</code>、<code>borrowFee</code>、已有借款与费用一并纳入，只有当 <code>userCollateralBalanceETH</code> ≥ <code>amountOfCollateralNeededETH</code> 时才能借款。</li>
<li><strong>稳定利率额外限制</strong>：若用户选择稳定利率，<code>core.isUserAllowedToBorrowAtStable</code> 会检查储备是否开启稳定模式、用户抵押资产是否与借款资产过度同质，以及当前金额是否允许；<code>parametersProvider.getMaxStableRateBorrowSizePercent</code> 则限制稳定利率借款在总可用流动性中的占比，防止一笔交易吸干储备。</li>
<li><strong>状态刷新与资金划转</strong>：<code>core.updateStateOnBorrow</code> 将债务指数与 <code>principalBalance</code> 更新为最新值，返回实际借款利率 (<code>finalUserBorrowRate</code>) 与自上次操作以来累积的 <code>borrowBalanceIncrease</code>；状态更新后才调用 <code>core.transferToUser</code> 把 <code>_amount</code> 下发给借款人，最后 <code>Borrow</code> 事件记录利率模式、费用和推荐码。</li>
</ol>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">borrow</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">_interestRateMode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint16</span> <span class="n">_referralCode</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">external</span>
</span></span><span class="line"><span class="cl">        <span class="n">nonReentrant</span>
</span></span><span class="line"><span class="cl">        <span class="n">onlyActiveReserve</span><span class="p">(</span><span class="n">_reserve</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">onlyUnfreezedReserve</span><span class="p">(</span><span class="n">_reserve</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">onlyAmountGreaterThanZero</span><span class="p">(</span><span class="n">_amount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">BorrowLocalVars</span> <span class="k">memory</span> <span class="n">vars</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 储备借款开关、利率模式、可用流动性检查
</span></span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 将利率模式转换为 coreLibrary.interestRateMode
</span></span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">rateMode</span> <span class="o">=</span> <span class="n">CoreLibrary</span><span class="p">.</span><span class="n">InterestRateMode</span><span class="p">(</span><span class="n">_interestRateMode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 检查储备池中是否有足够的可用金额，可用流动性即为核心合约的余额。
</span></span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">availableLiquidity</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">getReserveAvailableLiquidity</span><span class="p">(</span><span class="n">_reserve</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">userCollateralBalanceETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">userBorrowBalanceETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">userTotalFeesETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">currentLtv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">currentLiquidationThreshold</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">healthFactorBelowThreshold</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span> <span class="o">=</span> <span class="n">dataProvider</span><span class="p">.</span><span class="n">calculateUserGlobalData</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">);</span> <span class="c1">// 一次性获取抵押、借款、LTV、健康度
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 抵押&gt;0 与 Health Factor&gt;1 的 require
</span></span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">borrowFee</span> <span class="o">=</span> <span class="n">feeProvider</span><span class="p">.</span><span class="n">calculateLoanOriginationFee</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_amount</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span> <span class="c1">// 计算开仓费
</span></span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">amountOfCollateralNeededETH</span> <span class="o">=</span> <span class="n">dataProvider</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">calculateCollateralNeededInETH</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">_amount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">borrowFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">userBorrowBalanceETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">userTotalFeesETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">currentLtv</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span> <span class="c1">// 根据 LTV 推导所需抵押
</span></span></span><span class="line"><span class="cl">        <span class="c1">// 抵押覆盖校验
</span></span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         *  如果用户以稳定利率借款，需要满足以下条件：
</span></span></span><span class="line"><span class="cl"><span class="cm">         *  1. 储备池必须启用稳定利率借款
</span></span></span><span class="line"><span class="cl"><span class="cm">         *  2. 用户不能从储备池借款，如果他们的抵押品主要是他们正在借款的货币，以防止滥用。
</span></span></span><span class="line"><span class="cl"><span class="cm">         *  3. 用户只能借款储备池总流动性的一个相对较小、可配置的金额。
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">rateMode</span> <span class="o">==</span> <span class="n">CoreLibrary</span><span class="p">.</span><span class="n">InterestRateMode</span><span class="p">.</span><span class="n">STABLE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 检查借款模式是否为稳定利率，并且储备池是否启用了稳定利率借款
</span></span></span><span class="line"><span class="cl">            <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">maxLoanPercent</span> <span class="o">=</span> <span class="n">parametersProvider</span>
</span></span><span class="line"><span class="cl">                <span class="p">.</span><span class="n">getMaxStableRateBorrowSizePercent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">maxLoanSizeStable</span> <span class="o">=</span> <span class="n">vars</span>
</span></span><span class="line"><span class="cl">                <span class="p">.</span><span class="n">availableLiquidity</span>
</span></span><span class="line"><span class="cl">                <span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">maxLoanPercent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nb">require</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">_amount</span> <span class="o">&lt;=</span> <span class="n">maxLoanSizeStable</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;User is trying to borrow too much liquidity at a stable rate&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 更新储备池状态
</span></span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">finalUserBorrowRate</span><span class="p">,</span> <span class="n">vars</span><span class="p">.</span><span class="n">borrowBalanceIncrease</span><span class="p">)</span> <span class="o">=</span> <span class="n">core</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">updateStateOnBorrow</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">_amount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">borrowFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">rateMode</span> <span class="c1">// 同步更新储备曲线和用户债务指数
</span></span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 转移储备池中的资产到借款人
</span></span></span><span class="line"><span class="cl">        <span class="n">core</span><span class="p">.</span><span class="n">transferToUser</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Borrow</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_amount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_interestRateMode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">finalUserBorrowRate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">borrowFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">borrowBalanceIncrease</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_referralCode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nb">block</span><span class="p">.</span><span class="nb">timestamp</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    User->>LendingPool: repay(_reserve, _amount, _onBehalfOf)
    LendingPool->>LendingPoolCore: getUserBorrowBalances()
    LendingPool->>LendingPoolCore: getUserOriginationFee()
    LendingPool->>LendingPoolCore: updateStateOnRepay(...)
    alt 仅偿还费用
        LendingPool->>LendingPoolCore: transferToFeeCollectionAddress()
    else 本金 + 费用
        LendingPool->>LendingPoolCore: transferToFeeCollectionAddress()
        LendingPool->>LendingPoolCore: transferToReserve(...)
    end
    LendingPool-->>User: Repay 事件</pre>
  <pre class="mermaid-dark">sequenceDiagram
    User->>LendingPool: repay(_reserve, _amount, _onBehalfOf)
    LendingPool->>LendingPoolCore: getUserBorrowBalances()
    LendingPool->>LendingPoolCore: getUserOriginationFee()
    LendingPool->>LendingPoolCore: updateStateOnRepay(...)
    alt 仅偿还费用
        LendingPool->>LendingPoolCore: transferToFeeCollectionAddress()
    else 本金 + 费用
        LendingPool->>LendingPoolCore: transferToFeeCollectionAddress()
        LendingPool->>LendingPoolCore: transferToReserve(...)
    end
    LendingPool-->>User: Repay 事件</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    User->>LendingPool: repay(_reserve, _amount, _onBehalfOf)
    LendingPool->>LendingPoolCore: getUserBorrowBalances()
    LendingPool->>LendingPoolCore: getUserOriginationFee()
    LendingPool->>LendingPoolCore: updateStateOnRepay(...)
    alt 仅偿还费用
        LendingPool->>LendingPoolCore: transferToFeeCollectionAddress()
    else 本金 + 费用
        LendingPool->>LendingPoolCore: transferToFeeCollectionAddress()
        LendingPool->>LendingPoolCore: transferToReserve(...)
    end
    LendingPool-->>User: Repay 事件</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    User->>LendingPool: repay(_reserve, _amount, _onBehalfOf)
    LendingPool->>LendingPoolCore: getUserBorrowBalances()
    LendingPool->>LendingPoolCore: getUserOriginationFee()
    LendingPool->>LendingPoolCore: updateStateOnRepay(...)
    alt 仅偿还费用
        LendingPool->>LendingPoolCore: transferToFeeCollectionAddress()
    else 本金 + 费用
        LendingPool->>LendingPoolCore: transferToFeeCollectionAddress()
        LendingPool->>LendingPoolCore: transferToReserve(...)
    end
    LendingPool-->>User: Repay 事件</pre></template>
</div><h3 class="heading-element" id="23-repay"><span>2.3 <code>repay</code></span>
  <a href="#23-repay" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><code>repay</code> 负责关闭或部分偿还债务，对应白皮书 §3.3 的“偿还 + 费用回收”。函数既允许借款人自还，也允许别人带着 <code>_onBehalfOf</code> 参数帮忙清算，<code>UINT_MAX_VALUE</code>（<code>uint256(-1)</code>） 则代表“尽可能还多”：</p>
<ol>
<li><strong>读取债务与费用</strong>：通过 <code>core.getUserBorrowBalances</code> 得到 <code>principalBorrowBalance</code>、<code>compoundedBorrowBalance</code>、<code>borrowBalanceIncrease</code>，再取出 <code>core.getUserOriginationFee</code>。如果债务为零直接 revert。</li>
<li><strong>确定还款金额</strong>：默认 <code>paybackAmount = compounded + originationFee</code>，若调用者传入 <code>_amount != UINT_MAX_VALUE</code> 且更小，则裁剪，且要求“代还”场景必须显式金额。ETH 储备下 <code>msg.value</code> 至少等于 <code>paybackAmount</code>。</li>
<li><strong>仅偿还费用的分支</strong>：当 <code>paybackAmount &lt;= originationFee</code> 时，说明用户只需偿还费用。<code>core.updateStateOnRepay</code> 会以 0 principal 更新状态，并把 <code>vars.paybackAmount</code> 全额通过 <code>core.transferToFeeCollectionAddress</code> 送往 <code>TokenDistributor</code>（注意：此分支下费用从 <code>_onBehalfOf</code> 账户扣除）。</li>
<li><strong>标准偿还流程</strong>：<code>paybackAmountMinusFees = paybackAmount - originationFee</code>，随后调用 <code>core.updateStateOnRepay</code> 写入本金偿还金额、费用和借款增量，并标记是否还清。若存在 origination fee，则先 <code>transferToFeeCollectionAddress</code>，剩余本金部分通过 <code>core.transferToReserve</code> 入库；ETH 路径会把 <code>msg.value - fee</code> 作为 <code>value</code> 入参，多余 ETH 在 <code>transferToReserve</code> 内退还。在此分支中，origination fee 由 <code>msg.sender</code> 支付（ERC20 需 <code>msg.sender</code> 对 Core 授权）。</li>
<li><strong>事件记录</strong>：无论是哪条路径，最终都会 <code>emit Repay</code>，携带 <code>_reserve</code>、被还债用户、repayer 地址、偿还本金、费用与 <code>borrowBalanceIncrease</code>。</li>
</ol>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">repay</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">,</span><span class="err">ß</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="k">payable</span> <span class="n">_onBehalfOf</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">external</span>
</span></span><span class="line"><span class="cl">        <span class="k">payable</span>
</span></span><span class="line"><span class="cl">        <span class="n">nonReentrant</span>
</span></span><span class="line"><span class="cl">        <span class="n">onlyActiveReserve</span><span class="p">(</span><span class="n">_reserve</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">onlyAmountGreaterThanZero</span><span class="p">(</span><span class="n">_amount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">RepayLocalVars</span> <span class="k">memory</span> <span class="n">vars</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">(</span> <span class="c1">// 查询本金、复利余额与利息增量
</span></span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">principalBorrowBalance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">compoundedBorrowBalance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">borrowBalanceIncrease</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">getUserBorrowBalances</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="n">_onBehalfOf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">originationFee</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">getUserOriginationFee</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="n">_onBehalfOf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">isETH</span> <span class="o">=</span> <span class="n">EthAddressLib</span><span class="p">.</span><span class="n">ethAddress</span><span class="p">()</span> <span class="o">==</span> <span class="n">_reserve</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">...</span> <span class="c1">// require: 仍有债务、msg.sender 代还约束、msg.value 校验
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">paybackAmount</span> <span class="o">=</span> <span class="n">vars</span><span class="p">.</span><span class="n">compoundedBorrowBalance</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">originationFee</span> <span class="c1">// 需要偿还的总额 = 债务 + 开仓费
</span></span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_amount</span> <span class="o">!=</span> <span class="n">UINT_MAX_VALUE</span> <span class="o">&amp;&amp;</span> <span class="n">_amount</span> <span class="o">&lt;</span> <span class="n">vars</span><span class="p">.</span><span class="n">paybackAmount</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">paybackAmount</span> <span class="o">=</span> <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span> <span class="c1">// ETH 分支需要携带足量 msg.value
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果还款金额小于初始费用，直接转给费用接收地址
</span></span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">paybackAmount</span> <span class="o">&lt;=</span> <span class="n">vars</span><span class="p">.</span><span class="n">originationFee</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 只剩开仓费待付，principal 不变
</span></span></span><span class="line"><span class="cl">            <span class="n">core</span><span class="p">.</span><span class="n">updateStateOnRepay</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">_onBehalfOf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">paybackAmount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">borrowBalanceIncrease</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="kc">false</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span> <span class="c1">// core.transferToFeeCollectionAddress(... vars.paybackAmount ...)
</span></span></span><span class="line"><span class="cl">            <span class="n">emit</span> <span class="n">Repay</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">_onBehalfOf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">paybackAmount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">borrowBalanceIncrease</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nb">block</span><span class="p">.</span><span class="nb">timestamp</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">paybackAmountMinusFees</span> <span class="o">=</span> <span class="n">vars</span><span class="p">.</span><span class="n">paybackAmount</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">originationFee</span> <span class="c1">// 真正还掉的本金
</span></span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">core</span><span class="p">.</span><span class="n">updateStateOnRepay</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_onBehalfOf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">paybackAmountMinusFees</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">originationFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">borrowBalanceIncrease</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">compoundedBorrowBalance</span> <span class="o">==</span> <span class="n">vars</span><span class="p">.</span><span class="n">paybackAmountMinusFees</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果没有支付初始费用，将费用转给费用接收地址
</span></span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">originationFee</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span> <span class="c1">// core.transferToFeeCollectionAddress(... vars.originationFee ...)
</span></span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 发送总 msg.value（如果是 ETH）。
</span></span></span><span class="line"><span class="cl">        <span class="c1">// transferToReserve() 函数会负责将多余的 ETH 退还给调用者。
</span></span></span><span class="line"><span class="cl">        <span class="n">core</span><span class="p">.</span><span class="n">transferToReserve</span><span class="p">.</span><span class="nb">value</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">isETH</span> <span class="o">?</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">originationFee</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="p">)(</span><span class="n">_reserve</span><span class="p">,</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">vars</span><span class="p">.</span><span class="n">paybackAmountMinusFees</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Repay</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_onBehalfOf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">paybackAmountMinusFees</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">originationFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">borrowBalanceIncrease</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nb">block</span><span class="p">.</span><span class="nb">timestamp</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    FlashLoanReceiver->>LendingPool: flashLoan(_reserve, _amount)
    LendingPool->>LendingPoolCore: 查询 availableLiquidityBefore
    LendingPool->>ParametersProvider: getFlashLoanFeesInBips()
    LendingPool->>FlashLoanReceiver: transferToUser(_amount)
    FlashLoanReceiver-->>LendingPool: executeOperation 回调
    LendingPool->>LendingPoolCore: 校验 availableLiquidityAfter
    LendingPool->>LendingPoolCore: updateStateOnFlashLoan(...)</pre>
  <pre class="mermaid-dark">sequenceDiagram
    FlashLoanReceiver->>LendingPool: flashLoan(_reserve, _amount)
    LendingPool->>LendingPoolCore: 查询 availableLiquidityBefore
    LendingPool->>ParametersProvider: getFlashLoanFeesInBips()
    LendingPool->>FlashLoanReceiver: transferToUser(_amount)
    FlashLoanReceiver-->>LendingPool: executeOperation 回调
    LendingPool->>LendingPoolCore: 校验 availableLiquidityAfter
    LendingPool->>LendingPoolCore: updateStateOnFlashLoan(...)</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    FlashLoanReceiver->>LendingPool: flashLoan(_reserve, _amount)
    LendingPool->>LendingPoolCore: 查询 availableLiquidityBefore
    LendingPool->>ParametersProvider: getFlashLoanFeesInBips()
    LendingPool->>FlashLoanReceiver: transferToUser(_amount)
    FlashLoanReceiver-->>LendingPool: executeOperation 回调
    LendingPool->>LendingPoolCore: 校验 availableLiquidityAfter
    LendingPool->>LendingPoolCore: updateStateOnFlashLoan(...)</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    FlashLoanReceiver->>LendingPool: flashLoan(_reserve, _amount)
    LendingPool->>LendingPoolCore: 查询 availableLiquidityBefore
    LendingPool->>ParametersProvider: getFlashLoanFeesInBips()
    LendingPool->>FlashLoanReceiver: transferToUser(_amount)
    FlashLoanReceiver-->>LendingPool: executeOperation 回调
    LendingPool->>LendingPoolCore: 校验 availableLiquidityAfter
    LendingPool->>LendingPoolCore: updateStateOnFlashLoan(...)</pre></template>
</div><h3 class="heading-element" id="24-flashloan"><span>2.4 <code>flashLoan</code></span>
  <a href="#24-flashloan" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>闪电贷允许外部合约在一次交易内借出资金并归还，入口函数贯彻“余额守恒 + 费用拆分”原则：</p>
<ol>
<li><strong>准备与计费</strong>：<code>onlyActiveReserve</code>、<code>onlyAmountGreaterThanZero</code> 后，函数根据资产种类读取 <code>availableLiquidityBefore</code>（ETH 取 <code>address(core).balance</code>，ERC20 读取 <code>IERC20(_reserve).balanceOf(address(core))</code>），确认储备足以覆盖 <code>_amount</code>。<code>parametersProvider.getFlashLoanFeesInBips</code> 返回总费率与协议分润，<code>amountFee = _amount * totalFeeBips / 10000</code>，<code>protocolFee = amountFee * protocolFeeBips / 10000</code>，并要求这两个值都大于 0。</li>
<li><strong>借出与回调</strong>：将 <code>_receiver</code> 强转为 <code>IFlashLoanReceiver</code>，通过 <code>core.transferToUser</code> 把 <code>_amount</code> 划给 <code>receiver</code>，随后调用 <code>receiver.executeOperation(_reserve, _amount, amountFee, _params)</code>。此回调必须在同一交易内完成。</li>
<li><strong>归还与校验</strong>：执行完回调后再次读取 <code>availableLiquidityAfter</code>，要求其等于 <code>availableLiquidityBefore + amountFee</code>，即本金 + 总费用都已经回到 Core；若不满足则 revert。</li>
<li><strong>状态更新与事件</strong>：<code>core.updateStateOnFlashLoan</code> 把 <code>amountFee - protocolFee</code> 计入储备收益、将 <code>protocolFee</code> 发送到费用收集地址；事件 <code>FlashLoan</code> 记录 <code>_receiver</code>、<code>_reserve</code>、<code>_amount</code>、总费用与协议分润。</li>
</ol>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">flashLoan</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">_receiver</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">_params</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">public</span>
</span></span><span class="line"><span class="cl">        <span class="n">nonReentrant</span>
</span></span><span class="line"><span class="cl">        <span class="n">onlyActiveReserve</span><span class="p">(</span><span class="n">_reserve</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">onlyAmountGreaterThanZero</span><span class="p">(</span><span class="n">_amount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 检查储备池是否有足够的可用流动性
</span></span></span><span class="line"><span class="cl">        <span class="c1">// 避免使用 LendingPoolCore 中的 getAvailableLiquidity() 函数以节省 gas
</span></span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">availableLiquidityBefore</span> <span class="o">=</span> <span class="n">_reserve</span> <span class="o">==</span>
</span></span><span class="line"><span class="cl">            <span class="n">EthAddressLib</span><span class="p">.</span><span class="n">ethAddress</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">?</span> <span class="kt">address</span><span class="p">(</span><span class="n">core</span><span class="p">).</span><span class="nb">balance</span>
</span></span><span class="line"><span class="cl">            <span class="o">:</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">_reserve</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">core</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">...</span> <span class="c1">// require: 储备流动性必须覆盖 _amount
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="kt">uint256</span> <span class="n">totalFeeBips</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">protocolFeeBips</span><span class="p">)</span> <span class="o">=</span> <span class="n">parametersProvider</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">getFlashLoanFeesInBips</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">amountFee</span> <span class="o">=</span> <span class="n">_amount</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">totalFeeBips</span><span class="p">).</span><span class="n">div</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 协议费用是 amountFee 中为协议保留的部分 - 剩余部分归存款人所有
</span></span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">protocolFee</span> <span class="o">=</span> <span class="n">amountFee</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">protocolFeeBips</span><span class="p">).</span><span class="n">div</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span> <span class="c1">// require: 金额足够大且费用非零
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">IFlashLoanReceiver</span> <span class="n">receiver</span> <span class="o">=</span> <span class="n">IFlashLoanReceiver</span><span class="p">(</span><span class="n">_receiver</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="k">payable</span> <span class="n">userPayable</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="kt">uint160</span><span class="p">(</span><span class="n">_receiver</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 转移资金给接收者
</span></span></span><span class="line"><span class="cl">        <span class="n">core</span><span class="p">.</span><span class="n">transferToUser</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="n">userPayable</span><span class="p">,</span> <span class="n">_amount</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">        <span class="n">receiver</span><span class="p">.</span><span class="n">executeOperation</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="n">_amount</span><span class="p">,</span> <span class="n">amountFee</span><span class="p">,</span> <span class="n">_params</span><span class="p">);</span> <span class="c1">// 外部合约需在此回调内完成借款逻辑
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 检查核心合约的实际余额是否包含返回的金额
</span></span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">availableLiquidityAfter</span> <span class="o">=</span> <span class="n">_reserve</span> <span class="o">==</span> <span class="n">EthAddressLib</span><span class="p">.</span><span class="n">ethAddress</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">?</span> <span class="kt">address</span><span class="p">(</span><span class="n">core</span><span class="p">).</span><span class="nb">balance</span>
</span></span><span class="line"><span class="cl">            <span class="o">:</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">_reserve</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">core</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">availableLiquidityAfter</span> <span class="o">==</span> <span class="n">availableLiquidityBefore</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">amountFee</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;The actual balance of the protocol is inconsistent&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 更新储备池状态
</span></span></span><span class="line"><span class="cl">        <span class="n">core</span><span class="p">.</span><span class="n">updateStateOnFlashLoan</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">availableLiquidityBefore</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">amountFee</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">protocolFee</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">protocolFee</span> <span class="c1">// 结息：把收益分给存款人，协议抽象余
</span></span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">FlashLoan</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">_receiver</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_amount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">amountFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">protocolFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nb">block</span><span class="p">.</span><span class="nb">timestamp</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    Liquidator->>LendingPool: liquidationCall(_collateral, _reserve, _user, ...)
    LendingPool->>LiquidationManager: delegatecall liquidationCall(...)
    LiquidationManager->>DataProvider: calculateUserGlobalData(_user)
    LiquidationManager->>LendingPoolCore: getUserUnderlyingAssetBalance()/getUserBorrowBalances()
    LiquidationManager->>PriceOracle: getAssetPrice()
    LiquidationManager->>LendingPoolCore: updateStateOnLiquidation(...)
    alt receive aToken
        LiquidationManager->>AToken: transferOnLiquidation()
    else receive underlying
        LiquidationManager->>AToken: burnOnLiquidation()
        LiquidationManager->>LendingPoolCore: transferToUser()
    end
    Liquidator->>LendingPoolCore: transferToReserve(...)</pre>
  <pre class="mermaid-dark">sequenceDiagram
    Liquidator->>LendingPool: liquidationCall(_collateral, _reserve, _user, ...)
    LendingPool->>LiquidationManager: delegatecall liquidationCall(...)
    LiquidationManager->>DataProvider: calculateUserGlobalData(_user)
    LiquidationManager->>LendingPoolCore: getUserUnderlyingAssetBalance()/getUserBorrowBalances()
    LiquidationManager->>PriceOracle: getAssetPrice()
    LiquidationManager->>LendingPoolCore: updateStateOnLiquidation(...)
    alt receive aToken
        LiquidationManager->>AToken: transferOnLiquidation()
    else receive underlying
        LiquidationManager->>AToken: burnOnLiquidation()
        LiquidationManager->>LendingPoolCore: transferToUser()
    end
    Liquidator->>LendingPoolCore: transferToReserve(...)</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    Liquidator->>LendingPool: liquidationCall(_collateral, _reserve, _user, ...)
    LendingPool->>LiquidationManager: delegatecall liquidationCall(...)
    LiquidationManager->>DataProvider: calculateUserGlobalData(_user)
    LiquidationManager->>LendingPoolCore: getUserUnderlyingAssetBalance()/getUserBorrowBalances()
    LiquidationManager->>PriceOracle: getAssetPrice()
    LiquidationManager->>LendingPoolCore: updateStateOnLiquidation(...)
    alt receive aToken
        LiquidationManager->>AToken: transferOnLiquidation()
    else receive underlying
        LiquidationManager->>AToken: burnOnLiquidation()
        LiquidationManager->>LendingPoolCore: transferToUser()
    end
    Liquidator->>LendingPoolCore: transferToReserve(...)</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    Liquidator->>LendingPool: liquidationCall(_collateral, _reserve, _user, ...)
    LendingPool->>LiquidationManager: delegatecall liquidationCall(...)
    LiquidationManager->>DataProvider: calculateUserGlobalData(_user)
    LiquidationManager->>LendingPoolCore: getUserUnderlyingAssetBalance()/getUserBorrowBalances()
    LiquidationManager->>PriceOracle: getAssetPrice()
    LiquidationManager->>LendingPoolCore: updateStateOnLiquidation(...)
    alt receive aToken
        LiquidationManager->>AToken: transferOnLiquidation()
    else receive underlying
        LiquidationManager->>AToken: burnOnLiquidation()
        LiquidationManager->>LendingPoolCore: transferToUser()
    end
    Liquidator->>LendingPoolCore: transferToReserve(...)</pre></template>
</div><h3 class="heading-element" id="25-liquidationcall"><span>2.5 <code>liquidationCall</code></span>
  <a href="#25-liquidationcall" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>清算入口通过 <code>delegatecall</code> 把执行上下文交给 <code>LendingPoolLiquidationManager</code>，后者在同一个存储上下文中完成所有校验与资产转移：</p>
<ol>
<li><strong>入口与委托</strong>：<code>LendingPool.liquidationCall</code> 只做储备活跃性检查和 <code>nonReentrant</code> 保护，然后对 <code>addressesProvider.getLendingPoolLiquidationManager()</code> 发起 <code>delegatecall</code>。如果返回的 <code>(returnCode, returnMessage)</code> 非 0，会拼接字符串并 revert，确保只要清算失败就回滚整笔交易。</li>
<li><strong>健康度与抵押检查</strong>：管理器内首先调用 <code>dataProvider.calculateUserGlobalData(_user)</code>，只有当 <code>healthFactorBelowThreshold == true</code> 时才允许继续。随后读取 <code>core.getUserUnderlyingAssetBalance(_collateral)</code>、<code>core.isReserveUsageAsCollateralEnabled</code> 和 <code>core.isUserUseReserveAsCollateralEnabled</code>，确认该抵押品可被清算，再通过 <code>core.getUserBorrowBalances(_reserve, _user)</code> 检查该用户确实借入了指定的债务资产。</li>
<li><strong>可清算额度计算</strong>：遵循 <code>LIQUIDATION_CLOSE_FACTOR_PERCENT = 50</code>，<code>vars.maxPrincipalAmountToLiquidate = userCompoundedBorrowBalance * 50%</code>，实际处理金额取 <code>_purchaseAmount</code> 与上限的较小值。<code>calculateAvailableCollateralToLiquidate</code> 利用价格预言机读取 <code>_collateral</code> 与 <code>_reserve</code> 的 ETH 价格，再乘以 <code>core.getReserveLiquidationBonus(_collateral)</code> 得到最多可 seize 的抵押资产数量；若该抵押不足以覆盖 <code>_purchaseAmount</code>，函数会下调 <code>actualAmountToLiquidate</code>。</li>
<li><strong>费用与资产转移</strong>：若用户仍有 <code>originationFee</code>，会再调用 <code>calculateAvailableCollateralToLiquidate</code> 分配一部分抵押作为费用抵押并记账给协议。对于 <code>_receiveAToken == true</code>，直接 <code>AToken.transferOnLiquidation</code> 将 aToken 余额转给清算人；否则先 <code>burnOnLiquidation</code> 销毁 aToken，再由 <code>core.transferToUser</code> 发放等值底层资产。同时，清算人偿还的本金（ETH 或 ERC20）由 <code>core.transferToReserve.value(msg.value)</code> 收进协议，若费用被清算则额外 <code>core.liquidateFee</code> 发送到 <code>TokenDistributor</code> 并触发 <code>OriginationFeeLiquidated</code>。</li>
<li><strong>状态更新与事件</strong>：<code>core.updateStateOnLiquidation</code> 在资金移动前已经写入债务减少、抵押扣减、fee 分配以及 <code>borrowBalanceIncrease</code>，最终 <code>LiquidationCall</code> 事件会记录 collateral、reserve、用户、实际偿还金额、被扣抵押数量、利息增量、清算人地址以及是否领取 aToken。</li>
</ol>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">    <span class="c1">// LendingPool.sol
</span></span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">liquidationCall</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">_collateral</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">_user</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">_purchaseAmount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">_receiveAToken</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">external</span>
</span></span><span class="line"><span class="cl">        <span class="k">payable</span>
</span></span><span class="line"><span class="cl">        <span class="n">nonReentrant</span>
</span></span><span class="line"><span class="cl">        <span class="n">onlyActiveReserve</span><span class="p">(</span><span class="n">_reserve</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">onlyActiveReserve</span><span class="p">(</span><span class="n">_collateral</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">liquidationManager</span> <span class="o">=</span> <span class="n">addressesProvider</span><span class="p">.</span><span class="n">getLendingPoolLiquidationManager</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">result</span><span class="p">)</span> <span class="o">=</span> <span class="n">liquidationManager</span><span class="p">.</span><span class="nb">delegatecall</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nb">abi</span><span class="p">.</span><span class="nb">encodeWithSignature</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;liquidationCall(address,address,address,uint256,bool)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">_collateral</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">_user</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">_purchaseAmount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">_receiveAToken</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Liquidation call failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="kt">uint256</span> <span class="n">returnCode</span><span class="p">,</span> <span class="kt">string</span> <span class="k">memory</span> <span class="n">returnMessage</span><span class="p">)</span> <span class="o">=</span> <span class="nb">abi</span><span class="p">.</span><span class="nb">decode</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">uint256</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">returnCode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="kt">string</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="s">&#34;Liquidation failed: &#34;</span><span class="p">,</span> <span class="n">returnMessage</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="3" style="--fi-max-shown-lines:10;--fi-line-digit:3;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">    <span class="c1">// LendingPoolLiquidationManager.sol
</span></span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">liquidationCall</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">_collateral</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">_user</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">_purchaseAmount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">_receiveAToken</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="k">external</span> <span class="k">payable</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">,</span> <span class="kt">string</span> <span class="k">memory</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LiquidationCallLocalVars</span> <span class="k">memory</span> <span class="n">vars</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">(,</span> <span class="p">,</span> <span class="p">,</span> <span class="p">,</span> <span class="p">,</span> <span class="p">,</span> <span class="p">,</span> <span class="n">vars</span><span class="p">.</span><span class="n">healthFactorBelowThreshold</span><span class="p">)</span> <span class="o">=</span> <span class="n">dataProvider</span><span class="p">.</span><span class="n">calculateUserGlobalData</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">_user</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vars</span><span class="p">.</span><span class="n">healthFactorBelowThreshold</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="kt">uint256</span><span class="p">(</span><span class="n">LiquidationErrors</span><span class="p">.</span><span class="n">HEALTH_FACTOR_ABOVE_THRESHOLD</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;Health factor is not below the threshold&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">userCollateralBalance</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">getUserUnderlyingAssetBalance</span><span class="p">(</span><span class="n">_collateral</span><span class="p">,</span> <span class="n">_user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">userCollateralBalance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="kt">uint256</span><span class="p">(</span><span class="n">LiquidationErrors</span><span class="p">.</span><span class="n">NO_COLLATERAL_AVAILABLE</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;Invalid collateral to liquidate&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">isCollateralEnabled</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="n">core</span><span class="p">.</span><span class="n">isReserveUsageAsCollateralEnabled</span><span class="p">(</span><span class="n">_collateral</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="n">core</span><span class="p">.</span><span class="n">isUserUseReserveAsCollateralEnabled</span><span class="p">(</span><span class="n">_collateral</span><span class="p">,</span> <span class="n">_user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vars</span><span class="p">.</span><span class="n">isCollateralEnabled</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="kt">uint256</span><span class="p">(</span><span class="n">LiquidationErrors</span><span class="p">.</span><span class="n">COLLATERAL_CANNOT_BE_LIQUIDATED</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;The collateral chosen cannot be liquidated&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">(,</span> <span class="n">vars</span><span class="p">.</span><span class="n">userCompoundedBorrowBalance</span><span class="p">,</span> <span class="n">vars</span><span class="p">.</span><span class="n">borrowBalanceIncrease</span><span class="p">)</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">getUserBorrowBalances</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_user</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">userCompoundedBorrowBalance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="kt">uint256</span><span class="p">(</span><span class="n">LiquidationErrors</span><span class="p">.</span><span class="n">CURRRENCY_NOT_BORROWED</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;User did not borrow the specified currency&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">maxPrincipalAmountToLiquidate</span> <span class="o">=</span> <span class="n">vars</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">userCompoundedBorrowBalance</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">LIQUIDATION_CLOSE_FACTOR_PERCENT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">actualAmountToLiquidate</span> <span class="o">=</span> <span class="n">_purchaseAmount</span> <span class="o">&gt;</span> <span class="n">vars</span><span class="p">.</span><span class="n">maxPrincipalAmountToLiquidate</span>
</span></span><span class="line"><span class="cl">            <span class="o">?</span> <span class="n">vars</span><span class="p">.</span><span class="n">maxPrincipalAmountToLiquidate</span>
</span></span><span class="line"><span class="cl">            <span class="o">:</span> <span class="n">_purchaseAmount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">maxCollateralToLiquidate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">principalAmountNeeded</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span> <span class="o">=</span> <span class="n">calculateAvailableCollateralToLiquidate</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">_collateral</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">actualAmountToLiquidate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">userCollateralBalance</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">originationFee</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">getUserOriginationFee</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="n">_user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">originationFee</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">liquidatedCollateralForFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">feeLiquidated</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span> <span class="o">=</span> <span class="n">calculateAvailableCollateralToLiquidate</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">_collateral</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">originationFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">userCollateralBalance</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">maxCollateralToLiquidate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">principalAmountNeeded</span> <span class="o">&lt;</span> <span class="n">vars</span><span class="p">.</span><span class="n">actualAmountToLiquidate</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">actualAmountToLiquidate</span> <span class="o">=</span> <span class="n">principalAmountNeeded</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_receiveAToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">availableCollateral</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">getReserveAvailableLiquidity</span><span class="p">(</span><span class="n">_collateral</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">availableCollateral</span> <span class="o">&lt;</span> <span class="n">maxCollateralToLiquidate</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">uint256</span><span class="p">(</span><span class="n">LiquidationErrors</span><span class="p">.</span><span class="n">NOT_ENOUGH_LIQUIDITY</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;There isn&#39;t enough liquidity available to liquidate&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">core</span><span class="p">.</span><span class="n">updateStateOnLiquidation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_collateral</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_user</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">actualAmountToLiquidate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">maxCollateralToLiquidate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">feeLiquidated</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">liquidatedCollateralForFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">borrowBalanceIncrease</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_receiveAToken</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">AToken</span> <span class="n">collateralAtoken</span> <span class="o">=</span> <span class="n">AToken</span><span class="p">(</span><span class="n">core</span><span class="p">.</span><span class="n">getReserveATokenAddress</span><span class="p">(</span><span class="n">_collateral</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_receiveAToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">collateralAtoken</span><span class="p">.</span><span class="n">transferOnLiquidation</span><span class="p">(</span><span class="n">_user</span><span class="p">,</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">maxCollateralToLiquidate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">collateralAtoken</span><span class="p">.</span><span class="n">burnOnLiquidation</span><span class="p">(</span><span class="n">_user</span><span class="p">,</span> <span class="n">maxCollateralToLiquidate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">core</span><span class="p">.</span><span class="n">transferToUser</span><span class="p">(</span><span class="n">_collateral</span><span class="p">,</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">maxCollateralToLiquidate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">core</span><span class="p">.</span><span class="n">transferToReserve</span><span class="p">.</span><span class="nb">value</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">)(</span>
</span></span><span class="line"><span class="cl">            <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">actualAmountToLiquidate</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">feeLiquidated</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">collateralAtoken</span><span class="p">.</span><span class="n">burnOnLiquidation</span><span class="p">(</span><span class="n">_user</span><span class="p">,</span> <span class="n">vars</span><span class="p">.</span><span class="n">liquidatedCollateralForFee</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">core</span><span class="p">.</span><span class="n">liquidateFee</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">_collateral</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">liquidatedCollateralForFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">addressesProvider</span><span class="p">.</span><span class="n">getTokenDistributor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">emit</span> <span class="n">OriginationFeeLiquidated</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">_collateral</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">_user</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">feeLiquidated</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">vars</span><span class="p">.</span><span class="n">liquidatedCollateralForFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nb">block</span><span class="p">.</span><span class="nb">timestamp</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">LiquidationCall</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">_collateral</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_user</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">actualAmountToLiquidate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">maxCollateralToLiquidate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">vars</span><span class="p">.</span><span class="n">borrowBalanceIncrease</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">_receiveAToken</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nb">block</span><span class="p">.</span><span class="nb">timestamp</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">(</span><span class="n">LiquidationErrors</span><span class="p">.</span><span class="n">NO_ERROR</span><span class="p">),</span> <span class="s">&#34;No errors&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><h2 class="heading-element" id="3-lendingpoolcore资金与索引"><span>3 LendingPoolCore：资金与索引</span>
  <a href="#3-lendingpoolcore%e8%b5%84%e9%87%91%e4%b8%8e%e7%b4%a2%e5%bc%95" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>LendingPoolCore 保管全部底层资产，并把协议状态拆成 <code>reserves[address]</code> 与 <code>usersReserveData[user][reserve]</code> 两层，业务入口只在 <code>LendingPool</code> 中做权限校验，具体的利率积累、余额记账、资产转移都下沉到 Core 与 <code>CoreLibrary</code>。这一层的所有金额在 <code>WadRayMath</code> 的 ray 精度 (1e27) 下运算，确保利息累积不会丢精度。</p>
<h3 class="heading-element" id="31-状态结构reservedata-与-userreservedata"><span>3.1 状态结构：ReserveData 与 UserReserveData</span>
  <a href="#31-%e7%8a%b6%e6%80%81%e7%bb%93%e6%9e%84reservedata-%e4%b8%8e-userreservedata" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li><code>CoreLibrary.ReserveData</code> 同时保存资金侧指标（<code>lastLiquidityCumulativeIndex</code>、<code>lastVariableBorrowCumulativeIndex</code>、<code>currentLiquidityRate</code>、<code>totalBorrowsStable/Variable</code>）和风险参数（<code>baseLTVasCollateral</code>、<code>liquidationThreshold</code>、<code>liquidationBonus</code>、<code>borrowingEnabled</code>、<code>isStableBorrowRateEnabled</code> 等）。初始化时 <code>init()</code> 把两个指数都设为 <code>1e27</code>，后续所有收益都在此基础上累乘。</li>
<li><code>CoreLibrary.UserReserveData</code> 记录单个用户在某个储备上的本金、借款指数、<code>originationFee</code> 和 <code>stableBorrowRate</code>，再辅以 <code>lastUpdateTimestamp</code> 与 <code>useAsCollateral</code> 标记。入口层通过 <code>setUserUseReserveAsCollateral</code> 打开或关闭抵押权，所有借款模式切换和稳定利率重平衡都直接写入这份结构。</li>
<li><code>reservesList</code>/<code>getReserves()</code> 提供了一个可迭代的储备数组，<code>LendingPoolDataProvider.calculateUserGlobalData</code> 就依赖它遍历所有资产。</li>
</ul>
<div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    LendingPoolConfigurator->>LendingPoolCore: initReserve()
    LendingPoolCore->>CoreLibrary: init(ReserveData)
    LendingPool->>LendingPoolCore: getUserBasicReserveData()
    LendingPoolCore-->>LendingPool: UserReserveData(useAsCollateral, principal, fee)</pre>
  <pre class="mermaid-dark">sequenceDiagram
    LendingPoolConfigurator->>LendingPoolCore: initReserve()
    LendingPoolCore->>CoreLibrary: init(ReserveData)
    LendingPool->>LendingPoolCore: getUserBasicReserveData()
    LendingPoolCore-->>LendingPool: UserReserveData(useAsCollateral, principal, fee)</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    LendingPoolConfigurator->>LendingPoolCore: initReserve()
    LendingPoolCore->>CoreLibrary: init(ReserveData)
    LendingPool->>LendingPoolCore: getUserBasicReserveData()
    LendingPoolCore-->>LendingPool: UserReserveData(useAsCollateral, principal, fee)</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    LendingPoolConfigurator->>LendingPoolCore: initReserve()
    LendingPoolCore->>CoreLibrary: init(ReserveData)
    LendingPool->>LendingPoolCore: getUserBasicReserveData()
    LendingPoolCore-->>LendingPool: UserReserveData(useAsCollateral, principal, fee)</pre></template>
</div><h3 class="heading-element" id="32-惰性计息与状态刷新"><span>3.2 惰性计息与状态刷新</span>
  <a href="#32-%e6%83%b0%e6%80%a7%e8%ae%a1%e6%81%af%e4%b8%8e%e7%8a%b6%e6%80%81%e5%88%b7%e6%96%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>每个流转动作都会先 <code>reserves[_reserve].updateCumulativeIndexes()</code>，再调用 <code>updateReserveInterestRatesAndTimestampInternal()</code>。<code>updateCumulativeIndexes</code> 通过 <code>calculateLinearInterest</code> 和 <code>calculateCompoundedInterest</code> 把当前利率与上次时间戳之间的利息累加到两个指数上，只有 <code>totalBorrows&gt;0</code> 时才真正更新。</li>
<li><code>updateStateOnDeposit</code> 与 <code>updateStateOnRedeem</code> 分别在 <code>_amount</code> 作为正负流动性注入/抽离后刷新利率；首次存款时会把 <code>useAsCollateral</code> 切成 <code>true</code>，赎回至 0 则反向关闭。</li>
<li><code>updateStateOnBorrow</code> 把储备借款指标与用户借款指标拆开处理：<code>updateReserveStateOnBorrowInternal</code> 更新 <code>totalBorrows</code>、平均利率与时间戳，<code>updateUserStateOnBorrowInternal</code> 把用户本金加上新借款，并记录 <code>_borrowFee</code> 与利率模式，返回最新的 <code>borrowBalanceIncrease</code> 提供给事件。</li>
<li><code>updateStateOnRepay</code>、<code>updateStateOnLiquidation</code> 和 <code>updateStateOnRebalance</code> 则把刚才的模式镜像回来，按“先储备 -&gt; 后用户 -&gt; 再刷新利率”的顺序执行，保证索引与本金始终匹配。</li>
<li>闪电贷路径中，<code>updateStateOnFlashLoan</code> 通过 <code>cumulateToLiquidityIndex(totalLiquidityBefore, income)</code> 把额外收益一次性打入流动性指数，再将 <code>protocolFee</code> 单独转给 <code>TokenDistributor</code>，实现“收益给存款人，抽成给协议”的两段拆分。</li>
</ul>
<p>关键函数片段如下（留意入口限定 <code>onlyLendingPool</code>，确保 Core 不直接暴露敏感操作）：</p>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">updateStateOnDeposit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_user</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">_isFirstDeposit</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="k">external</span> <span class="n">onlyLendingPool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 累积上一个区块的收益，防止旧利率污染当前操作
</span></span></span><span class="line"><span class="cl">    <span class="n">reserves</span><span class="p">[</span><span class="n">_reserve</span><span class="p">].</span><span class="n">updateCumulativeIndexes</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 将本次存入金额计入储备，刷新流动性利率与时间戳
</span></span></span><span class="line"><span class="cl">    <span class="n">updateReserveInterestRatesAndTimestampInternal</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="n">_amount</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_isFirstDeposit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">setUserUseReserveAsCollateral</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="n">_user</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> <span class="c1">// 首次存款直接作为抵押
</span></span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">updateStateOnBorrow</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_user</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_amountBorrowed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_borrowFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">CoreLibrary</span><span class="p">.</span><span class="n">InterestRateMode</span> <span class="n">_rateMode</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="k">external</span> <span class="n">onlyLendingPool</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">,</span> <span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="kt">uint256</span> <span class="n">principalBorrowBalance</span><span class="p">,</span> <span class="p">,</span> <span class="kt">uint256</span> <span class="n">balanceIncrease</span><span class="p">)</span> <span class="o">=</span> <span class="n">getUserBorrowBalances</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="n">_user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 先把储备维度的借款统计更新，否则用户状态会依赖旧的 `totalBorrows`
</span></span></span><span class="line"><span class="cl">    <span class="n">updateReserveStateOnBorrowInternal</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_user</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">principalBorrowBalance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">balanceIncrease</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_amountBorrowed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_rateMode</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 再记录到用户维度：本金、费用与利率模式
</span></span></span><span class="line"><span class="cl">    <span class="n">updateUserStateOnBorrowInternal</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_user</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_amountBorrowed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">balanceIncrease</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_borrowFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_rateMode</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 借款等价于抽离流动性，因此在负方向刷新利率
</span></span></span><span class="line"><span class="cl">    <span class="n">updateReserveInterestRatesAndTimestampInternal</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_amountBorrowed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">getUserCurrentBorrowRate</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="n">_user</span><span class="p">),</span> <span class="n">balanceIncrease</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    LendingPool->>LendingPoolCore: updateStateOnDeposit()
    LendingPoolCore->>CoreLibrary: updateCumulativeIndexes()
    CoreLibrary-->>LendingPoolCore: 新的 liquidityIndex/variableIndex
    LendingPool->>LendingPoolCore: updateStateOnBorrow()
    LendingPoolCore->>CoreLibrary: updateReserveStateOnBorrowInternal()
    LendingPoolCore-->>LendingPool: balanceIncrease/borrowRate</pre>
  <pre class="mermaid-dark">sequenceDiagram
    LendingPool->>LendingPoolCore: updateStateOnDeposit()
    LendingPoolCore->>CoreLibrary: updateCumulativeIndexes()
    CoreLibrary-->>LendingPoolCore: 新的 liquidityIndex/variableIndex
    LendingPool->>LendingPoolCore: updateStateOnBorrow()
    LendingPoolCore->>CoreLibrary: updateReserveStateOnBorrowInternal()
    LendingPoolCore-->>LendingPool: balanceIncrease/borrowRate</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    LendingPool->>LendingPoolCore: updateStateOnDeposit()
    LendingPoolCore->>CoreLibrary: updateCumulativeIndexes()
    CoreLibrary-->>LendingPoolCore: 新的 liquidityIndex/variableIndex
    LendingPool->>LendingPoolCore: updateStateOnBorrow()
    LendingPoolCore->>CoreLibrary: updateReserveStateOnBorrowInternal()
    LendingPoolCore-->>LendingPool: balanceIncrease/borrowRate</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    LendingPool->>LendingPoolCore: updateStateOnDeposit()
    LendingPoolCore->>CoreLibrary: updateCumulativeIndexes()
    CoreLibrary-->>LendingPoolCore: 新的 liquidityIndex/variableIndex
    LendingPool->>LendingPoolCore: updateStateOnBorrow()
    LendingPoolCore->>CoreLibrary: updateReserveStateOnBorrowInternal()
    LendingPoolCore-->>LendingPool: balanceIncrease/borrowRate</pre></template>
</div><h3 class="heading-element" id="33-资金入口与费用路径"><span>3.3 资金入口与费用路径</span>
  <a href="#33-%e8%b5%84%e9%87%91%e5%85%a5%e5%8f%a3%e4%b8%8e%e8%b4%b9%e7%94%a8%e8%b7%af%e5%be%84" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>Core 对 ETH 与 ERC20 的资金流分别封装：<code>transferToReserve</code> 负责收款（ERC20 走 <code>safeTransferFrom</code>，ETH 要求 <code>msg.value &gt;= amount</code> 并主动退回多余部分）；<code>transferToUser</code> 则在出金时对 ETH 使用带 50k gas 的 <code>call</code> (<code>contracts/lendingpool/LendingPoolCore.sol:439-441</code>)。</li>
<li>所有费用都走单独通道：<code>transferToFeeCollectionAddress</code> 用于借款开仓费、<code>liquidateFee</code> 用于清算费，调用方需要显式传入 <code>_destination</code>，从而把费用直接打到 <code>TokenDistributor</code>。</li>
<li>合约 <code>fallback()</code> 禁止 EOA 主动给 Core 汇入 ETH，只有合约才能向它转账，避免用户误充。闪电贷归还逻辑正是借助这一点，通过 <code>LendingPool</code> 检查 Core 的 <code>address(this).balance</code> 是否等于借出前余额加手续费。</li>
</ul>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">transferToUser</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="k">payable</span> <span class="n">_user</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_amount</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="k">external</span> <span class="n">onlyLendingPool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_reserve</span> <span class="o">!=</span> <span class="n">EthAddressLib</span><span class="p">.</span><span class="n">ethAddress</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ERC20 路径直接将资产转出给用户
</span></span></span><span class="line"><span class="cl">        <span class="n">ERC20</span><span class="p">(</span><span class="n">_reserve</span><span class="p">).</span><span class="n">safeTransfer</span><span class="p">(</span><span class="n">_user</span><span class="p">,</span> <span class="n">_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ETH 路径使用 call，固定 50k gas 以降低重入面
</span></span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="kt">bool</span> <span class="n">result</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">_user</span><span class="p">.</span><span class="nb">call</span><span class="p">.</span><span class="nb">value</span><span class="p">(</span><span class="n">_amount</span><span class="p">).</span><span class="nb">gas</span><span class="p">(</span><span class="mi">50000</span><span class="p">)(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#34;Transfer of ETH failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">transferToReserve</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="k">payable</span> <span class="n">_user</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_amount</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="k">external</span> <span class="k">payable</span> <span class="n">onlyLendingPool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_reserve</span> <span class="o">!=</span> <span class="n">EthAddressLib</span><span class="p">.</span><span class="n">ethAddress</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ERC20 入金必须通过 `safeTransferFrom`，防止多余 ETH
</span></span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;User is sending ETH along with the ERC20 transfer.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ERC20</span><span class="p">(</span><span class="n">_reserve</span><span class="p">).</span><span class="n">safeTransferFrom</span><span class="p">(</span><span class="n">_user</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ETH 入金需要附带足量 msg.value，并在多付时立刻退款
</span></span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span> <span class="o">&gt;=</span> <span class="n">_amount</span><span class="p">,</span> <span class="s">&#34;The amount and the value sent to deposit do not match&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span> <span class="o">&gt;</span> <span class="n">_amount</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">excessAmount</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">bool</span> <span class="n">result</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">_user</span><span class="p">.</span><span class="nb">call</span><span class="p">.</span><span class="nb">value</span><span class="p">(</span><span class="n">excessAmount</span><span class="p">).</span><span class="nb">gas</span><span class="p">(</span><span class="mi">50000</span><span class="p">)(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nb">require</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#34;Transfer of ETH failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">transferToFeeCollectionAddress</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_token</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_user</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_destination</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="k">external</span> <span class="k">payable</span> <span class="n">onlyLendingPool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="k">payable</span> <span class="n">feeAddress</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="kt">uint160</span><span class="p">(</span><span class="n">_destination</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_token</span> <span class="o">!=</span> <span class="n">EthAddressLib</span><span class="p">.</span><span class="n">ethAddress</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 借款费的 ERC20 路径直接由 Core 从用户账户划走
</span></span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;User is sending ETH along with the ERC20 transfer...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ERC20</span><span class="p">(</span><span class="n">_token</span><span class="p">).</span><span class="n">safeTransferFrom</span><span class="p">(</span><span class="n">_user</span><span class="p">,</span> <span class="n">feeAddress</span><span class="p">,</span> <span class="n">_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ETH 费用需要携带 value，并直接转发给 TokenDistributor
</span></span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span> <span class="o">&gt;=</span> <span class="n">_amount</span><span class="p">,</span> <span class="s">&#34;The amount and the value sent to deposit do not match&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="kt">bool</span> <span class="n">result</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">feeAddress</span><span class="p">.</span><span class="nb">call</span><span class="p">.</span><span class="nb">value</span><span class="p">(</span><span class="n">_amount</span><span class="p">).</span><span class="nb">gas</span><span class="p">(</span><span class="mi">50000</span><span class="p">)(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#34;Transfer of ETH failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    LendingPool->>LendingPoolCore: transferToReserve()
    alt ERC20
        LendingPoolCore->>ERC20: safeTransferFrom(user, core, amount)
    else ETH
        LendingPoolCore->>User: refund excess ETH
    end
    LendingPool->>LendingPoolCore: transferToUser()
    LendingPoolCore-->>User: ERC20/ETH
    LendingPool->>LendingPoolCore: transferToFeeCollectionAddress()
    LendingPoolCore-->>TokenDistributor: 协议费用</pre>
  <pre class="mermaid-dark">sequenceDiagram
    LendingPool->>LendingPoolCore: transferToReserve()
    alt ERC20
        LendingPoolCore->>ERC20: safeTransferFrom(user, core, amount)
    else ETH
        LendingPoolCore->>User: refund excess ETH
    end
    LendingPool->>LendingPoolCore: transferToUser()
    LendingPoolCore-->>User: ERC20/ETH
    LendingPool->>LendingPoolCore: transferToFeeCollectionAddress()
    LendingPoolCore-->>TokenDistributor: 协议费用</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    LendingPool->>LendingPoolCore: transferToReserve()
    alt ERC20
        LendingPoolCore->>ERC20: safeTransferFrom(user, core, amount)
    else ETH
        LendingPoolCore->>User: refund excess ETH
    end
    LendingPool->>LendingPoolCore: transferToUser()
    LendingPoolCore-->>User: ERC20/ETH
    LendingPool->>LendingPoolCore: transferToFeeCollectionAddress()
    LendingPoolCore-->>TokenDistributor: 协议费用</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    LendingPool->>LendingPoolCore: transferToReserve()
    alt ERC20
        LendingPoolCore->>ERC20: safeTransferFrom(user, core, amount)
    else ETH
        LendingPoolCore->>User: refund excess ETH
    end
    LendingPool->>LendingPoolCore: transferToUser()
    LendingPoolCore-->>User: ERC20/ETH
    LendingPool->>LendingPoolCore: transferToFeeCollectionAddress()
    LendingPoolCore-->>TokenDistributor: 协议费用</pre></template>
</div><h3 class="heading-element" id="34-利用率-白皮书-123--getreserveutilizationrate"><span>3.4 利用率 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span>：白皮书 §1.2.3 ↔ <code>getReserveUtilizationRate</code></span>
  <a href="#34-%e5%88%a9%e7%94%a8%e7%8e%87-%e7%99%bd%e7%9a%ae%e4%b9%a6-123--getreserveutilizationrate" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><blockquote>
<p>公式：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo>=</mo><mfrac><msub><mi>B</mi><mi>t</mi></msub><msub><mi>L</mi><mi>t</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">U = \frac{B_t}{L_t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.3335em;vertical-align:-0.4451em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8884em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:-0.0502em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>（当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>t</mi></msub><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">L_t&gt;0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>）</p>
</blockquote>
<ul>
<li><code>contracts/lendingpool/LendingPoolCore.sol:962-975</code> 直接以 <code>totalBorrows.rayDiv(availableLiquidity.add(totalBorrows))</code> 计算 RAY 精度的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span>（若 totalBorrows 和 availableLiquidity 均为 0，则 U=0）。这里的 <code>rayDiv</code> 就是白皮书中提到的“按 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>10</mn><mn>27</mn></msup></mrow><annotation encoding="application/x-tex">10^{27}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">27</span></span></span></span></span></span></span></span></span></span></span></span> 精度表示的利用率”。</li>
<li><code>totalBorrows</code> 由 <code>CoreLibrary.ReserveData.getTotalBorrows()</code> 给出，即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>t</mi></msub><mo>=</mo><msub><mi>B</mi><mi>s</mi></msub><mo>+</mo><msub><mi>B</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">B_t = B_s + B_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>；<code>availableLiquidity</code> 为核心合约持有的实际余额（Balance）；<code>totalLiquidity = availableLiquidity + totalBorrows</code>，对应白皮书的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">L_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</li>
<li>该函数被 <code>updateReserveInterestRatesAndTimestampInternal()</code> 调用，将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span> 传入 <code>DefaultReserveInterestRateStrategy.calculateInterestRates()</code>，触发白皮书 §1.2.4 描述的分段利率曲线。</li>
<li>当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>t</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">B_t = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> 时返回 0，避免了除零情况，也符合白皮书对“无人借款时资金成本为 0”的假设。</li>
</ul>
<h3 class="heading-element" id="35-指数体系白皮书-128-的链上实现"><span>3.5 指数体系：白皮书 §1.2.8 的链上实现</span>
  <a href="#35-%e6%8c%87%e6%95%b0%e4%bd%93%e7%b3%bb%e7%99%bd%e7%9a%ae%e4%b9%a6-128-%e7%9a%84%e9%93%be%e4%b8%8a%e5%ae%9e%e7%8e%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><blockquote>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>C</mi><mi>t</mi><mi>i</mi></msubsup><mo>=</mo><mo stretchy="false">(</mo><msub><mi>R</mi><mi>l</mi></msub><mo>⋅</mo><mi mathvariant="normal">Δ</mi><mi>T</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><msubsup><mi>C</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow><mi>i</mi></msubsup></mrow><annotation encoding="application/x-tex">C_t^i = (R_l \cdot \Delta T + 1) C_{t-1}^i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0717em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8247em;"><span style="top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord">Δ</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1311em;vertical-align:-0.3064em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8247em;"><span style="top:-2.4519em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3064em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>B</mi><mi>t</mi><mrow><mi>v</mi><mi>c</mi></mrow></msubsup><mo>=</mo><msup><mrow><mo fence="true">(</mo><mn>1</mn><mo>+</mo><mfrac><msub><mi>R</mi><mi>v</mi></msub><msub><mi>T</mi><mrow><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow></msub></mfrac><mo fence="true">)</mo></mrow><mrow><mi mathvariant="normal">Δ</mi><mi>T</mi></mrow></msup><msubsup><mi>B</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow><mrow><mi>v</mi><mi>c</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">B_t^{vc} = \left(1+\frac{R_v}{T_{year}}\right)^{\Delta T} B_{t-1}^{vc}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9303em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.453em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0313em;vertical-align:-0.65em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8884em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ye</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0077em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5423em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.3812em;"><span style="top:-3.6029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Δ</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4519em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3064em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>I</mi><mi>t</mi><mi>n</mi></msubsup></mrow><annotation encoding="application/x-tex">I_t^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9303em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.453em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> 为“不落地的指数快照”。</p>
</blockquote>
<ul>
<li><code>contracts/libraries/CoreLibrary.sol:94-155</code> 的 <code>getNormalizedIncome()</code>、<code>updateCumulativeIndexes()</code> 完整复现上述公式：
<ul>
<li><code>calculateLinearInterest(currentLiquidityRate, lastUpdateTimestamp)</code> 等价于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>R</mi><mi>l</mi></msub><mo>⋅</mo><mi mathvariant="normal">Δ</mi><mi>T</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(R_l \cdot \Delta T + 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord">Δ</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>。</li>
<li><code>calculateCompoundedInterest(currentVariableBorrowRate, lastUpdateTimestamp)</code> 借助 <code>WadRayMath.rayPow</code> 计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><msub><mi>R</mi><mi>v</mi></msub><mi mathvariant="normal">/</mi><msub><mi>T</mi><mrow><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow></msub><msup><mo stretchy="false">)</mo><mrow><mi mathvariant="normal">Δ</mi><mi>T</mi></mrow></msup></mrow><annotation encoding="application/x-tex">(1+R_v/T_{year})^{\Delta T}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1274em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ye</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Δ</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span>。</li>
<li>把二者分别乘上 <code>lastLiquidityCumulativeIndex</code>、<code>lastVariableBorrowCumulativeIndex</code>，即可得到白皮书所述的惰性累计。</li>
</ul>
</li>
<li><code>contracts/lendingpool/LendingPoolCore.sol:1407-1476</code> 所有 <code>updateStateOn*</code> 在修改本金前都会先调用 <code>reserves[_reserve].updateCumulativeIndexes()</code>，使用的是和白皮书一样的“先补齐指数，再变更本金”的顺序。</li>
<li><code>AToken.balanceOf()</code> 依赖 <code>core.getReserveNormalizedIncome()</code>（白皮书的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>I</mi><mi>t</mi><mi>n</mi></msubsup></mrow><annotation encoding="application/x-tex">I_t^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9303em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.453em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>），将指数差转换为余额增长，见 §4.1。</li>
</ul>
<h3 class="heading-element" id="36-利率刷新白皮书-124127--defaultreserveinterestratestrategy"><span>3.6 利率刷新：白皮书 §1.2.4/§1.2.7 ↔ <code>DefaultReserveInterestRateStrategy</code></span>
  <a href="#36-%e5%88%a9%e7%8e%87%e5%88%b7%e6%96%b0%e7%99%bd%e7%9a%ae%e4%b9%a6-124127--defaultreserveinterestratestrategy" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><code>contracts/lendingpool/DefaultReserveInterestRateStrategy.sol:1180-1218</code> 内部重新计算 <code>utilizationRate = totalBorrows.rayDiv(available.add(totalBorrows))</code>，并按照白皮书的 Kink 曲线输出浮动/稳定/流动性利率：</p>
<ol>
<li>当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo>≤</mo><msub><mi>U</mi><mrow><mi>o</mi><mi>p</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">U \le U_{optimal}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8193em;vertical-align:-0.136em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">pt</span><span class="mord mathnormal mtight">ima</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>：
<ul>
<li><code>currentVariableBorrowRate = baseVariableBorrowRate + (U/U_{optimal}) * variableRateSlope1</code></li>
<li><code>currentStableBorrowRate = marketBorrowRate + (U/U_{optimal}) * stableRateSlope1</code></li>
</ul>
</li>
<li>当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo>&gt;</mo><msub><mi>U</mi><mrow><mi>o</mi><mi>p</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">U &gt; U_{optimal}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">pt</span><span class="mord mathnormal mtight">ima</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>：
<ul>
<li>先算 <code>excess = (U - U_{optimal}) / (1 - U_{optimal})</code></li>
<li>变量/稳定利率分别额外叠加 <code>slope2 * excess</code></li>
</ul>
</li>
<li><code>currentLiquidityRate = getOverallBorrowRateInternal(...) * utilizationRate</code>，正是白皮书公式 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>l</mi></msub><mo>=</mo><msub><mi>R</mi><mi>O</mi></msub><mo>⋅</mo><mi>U</mi></mrow><annotation encoding="application/x-tex">R_l = R_O \cdot U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span>。</li>
</ol>
<p>这些新利率由 <code>LendingPoolCore.updateReserveInterestRatesAndTimestampInternal()</code> 写回 <code>ReserveData</code>，再由指数函数消化，形成“公式 → 状态 → 余额”的闭环。</p>
<h3 class="heading-element" id="37-数据出口与抵押开关"><span>3.7 数据出口与抵押开关</span>
  <a href="#37-%e6%95%b0%e6%8d%ae%e5%87%ba%e5%8f%a3%e4%b8%8e%e6%8a%b5%e6%8a%bc%e5%bc%80%e5%85%b3" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>Core 自身提供 <code>getUserBasicReserveData</code>、<code>getReserveConfiguration</code>、<code>getReserveNormalizedIncome</code>、<code>getReserveCurrent[Stable|Variable]BorrowRate</code> 等视图函数，DataProvider 直接从这里取原始值，外部前端不用触碰复杂的存储结构。</li>
<li><code>isUserAllowedToBorrowAtStable</code>、<code>isReserveBorrowingEnabled</code>、<code>isUserUseReserveAsCollateralEnabled</code> 这些布尔接口被入口层频繁调用，用于组合出“是否可以进行稳定利率借款”“余额减少是否被允许”等策略。</li>
<li>对于上层治理，<code>LendingPoolConfigurator</code> 只是代理，把各种 set/enable/disable 直接委托给 Core 执行，Core 保持最小权限并只负责最终数据写入。</li>
</ul>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">getUserBasicReserveData</span><span class="p">(</span><span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span> <span class="kt">address</span> <span class="n">_user</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">external</span>
</span></span><span class="line"><span class="cl">    <span class="k">view</span>
</span></span><span class="line"><span class="cl">    <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">,</span> <span class="kt">uint256</span><span class="p">,</span> <span class="kt">uint256</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CoreLibrary</span><span class="p">.</span><span class="n">ReserveData</span> <span class="k">storage</span> <span class="n">reserve</span> <span class="o">=</span> <span class="n">reserves</span><span class="p">[</span><span class="n">_reserve</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">CoreLibrary</span><span class="p">.</span><span class="n">UserReserveData</span> <span class="k">storage</span> <span class="n">user</span> <span class="o">=</span> <span class="n">usersReserveData</span><span class="p">[</span><span class="n">_user</span><span class="p">][</span><span class="n">_reserve</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">underlyingBalance</span> <span class="o">=</span> <span class="n">getUserUnderlyingAssetBalance</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="n">_user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">principalBorrowBalance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 没有借款时只需要返回存款余额与抵押标记
</span></span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">underlyingBalance</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">useAsCollateral</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">underlyingBalance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 通过用户的借款指数计算复利后的债务
</span></span></span><span class="line"><span class="cl">        <span class="n">user</span><span class="p">.</span><span class="n">getCompoundedBorrowBalance</span><span class="p">(</span><span class="n">reserve</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span><span class="p">.</span><span class="n">originationFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span><span class="p">.</span><span class="n">useAsCollateral</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">isUserAllowedToBorrowAtStable</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_user</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_amount</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CoreLibrary</span><span class="p">.</span><span class="n">ReserveData</span> <span class="k">storage</span> <span class="n">reserve</span> <span class="o">=</span> <span class="n">reserves</span><span class="p">[</span><span class="n">_reserve</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">CoreLibrary</span><span class="p">.</span><span class="n">UserReserveData</span> <span class="k">storage</span> <span class="n">user</span> <span class="o">=</span> <span class="n">usersReserveData</span><span class="p">[</span><span class="n">_user</span><span class="p">][</span><span class="n">_reserve</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reserve</span><span class="p">.</span><span class="n">isStableBorrowRateEnabled</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 若用户未将该储备作为抵押或储备本身不可抵押，则允许稳定模式
</span></span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="n">user</span><span class="p">.</span><span class="n">useAsCollateral</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="n">reserve</span><span class="p">.</span><span class="n">usageAsCollateralEnabled</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 否则要求借款金额大于其抵押余额，避免“同资产自借”套利
</span></span></span><span class="line"><span class="cl">        <span class="n">_amount</span> <span class="o">&gt;</span> <span class="n">getUserUnderlyingAssetBalance</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="n">_user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    LendingPool->>LendingPoolCore: getUserBasicReserveData()
    LendingPoolCore-->>LendingPool: (liquidity, borrow, fee, collateralFlag)
    LendingPool->>LendingPoolCore: isUserAllowedToBorrowAtStable()
    LendingPoolCore-->>LendingPool: true/false
    DataProvider->>LendingPoolCore: getReserveConfiguration()</pre>
  <pre class="mermaid-dark">sequenceDiagram
    LendingPool->>LendingPoolCore: getUserBasicReserveData()
    LendingPoolCore-->>LendingPool: (liquidity, borrow, fee, collateralFlag)
    LendingPool->>LendingPoolCore: isUserAllowedToBorrowAtStable()
    LendingPoolCore-->>LendingPool: true/false
    DataProvider->>LendingPoolCore: getReserveConfiguration()</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    LendingPool->>LendingPoolCore: getUserBasicReserveData()
    LendingPoolCore-->>LendingPool: (liquidity, borrow, fee, collateralFlag)
    LendingPool->>LendingPoolCore: isUserAllowedToBorrowAtStable()
    LendingPoolCore-->>LendingPool: true/false
    DataProvider->>LendingPoolCore: getReserveConfiguration()</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    LendingPool->>LendingPoolCore: getUserBasicReserveData()
    LendingPoolCore-->>LendingPool: (liquidity, borrow, fee, collateralFlag)
    LendingPool->>LendingPoolCore: isUserAllowedToBorrowAtStable()
    LendingPoolCore-->>LendingPool: true/false
    DataProvider->>LendingPoolCore: getReserveConfiguration()</pre></template>
</div><h2 class="heading-element" id="4-atoken-与-dataprovider凭证与估值"><span>4 AToken 与 DataProvider：凭证与估值</span>
  <a href="#4-atoken-%e4%b8%8e-dataprovider%e5%87%ad%e8%af%81%e4%b8%8e%e4%bc%b0%e5%80%bc" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>AToken 作为 <code>LendingPoolCore</code> 上资产的凭证，负责把 <code>liquidityIndex</code> 映射到 ERC20 余额，并通过 <code>LendingPoolDataProvider</code> 产生的全局数据来限制转账、计算健康度。本章聚焦两个文件：<code>contracts/tokenization/AToken.sol</code> 与 <code>contracts/lendingpool/LendingPoolDataProvider.sol</code>。</p>
<h3 class="heading-element" id="41-atoken-的指数余额模型"><span>4.1 aToken 的指数余额模型</span>
  <a href="#41-atoken-%e7%9a%84%e6%8c%87%e6%95%b0%e4%bd%99%e9%a2%9d%e6%a8%a1%e5%9e%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li><code>mintOnDeposit</code>、<code>burnOnLiquidation</code>、<code>transferOnLiquidation</code> 都只能被 <code>LendingPool</code> 调用；铸造或销毁之前，<code>cumulateBalanceInternal</code> 会把用户的 <code>balanceIncrease</code> 铸造成一小段额外 aToken，并刷新 <code>userIndexes[address] = core.getReserveNormalizedIncome()</code>.</li>
<li><code>redeem</code> 先累加余额、校验 <code>isTransferAllowed</code>，再调用 <code>pool.redeemUnderlying</code> 把资产解锁，同时在余额被清零时通过 <code>resetDataOnZeroBalanceInternal</code> 清除利息重定向与用户索引。</li>
<li><code>balanceOf</code> 会把本金与重定向来的余额一起乘以 <code>core.getReserveNormalizedIncome / userIndex</code>，<code>totalSupply</code> 也用同样的指数，所以存款人无需单独领取收益，余额在链上自动随时间增长。</li>
</ul>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">mintOnDeposit</span><span class="p">(</span><span class="kt">address</span> <span class="n">_account</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">)</span> <span class="k">external</span> <span class="n">onlyLendingPool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 先把已有利息累积到本金，保证指数与余额同步
</span></span></span><span class="line"><span class="cl">    <span class="p">(,</span> <span class="p">,</span> <span class="kt">uint256</span> <span class="n">balanceIncrease</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">index</span><span class="p">)</span> <span class="o">=</span> <span class="n">cumulateBalanceInternal</span><span class="p">(</span><span class="n">_account</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">updateRedirectedBalanceOfRedirectionAddressInternal</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">_account</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">balanceIncrease</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">_amount</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span> <span class="c1">// 若用户正在 redirect，先把新增余额同步给重定向地址
</span></span></span><span class="line"><span class="cl">    <span class="n">_mint</span><span class="p">(</span><span class="n">_account</span><span class="p">,</span> <span class="n">_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">emit</span> <span class="n">MintOnDeposit</span><span class="p">(</span><span class="n">_account</span><span class="p">,</span> <span class="n">_amount</span><span class="p">,</span> <span class="n">balanceIncrease</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">redeem</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">_amount</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">(,</span> <span class="kt">uint256</span> <span class="n">currentBalance</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">balanceIncrease</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">index</span><span class="p">)</span> <span class="o">=</span> <span class="n">cumulateBalanceInternal</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">amountToRedeem</span> <span class="o">=</span> <span class="n">_amount</span> <span class="o">==</span> <span class="n">UINT_MAX_VALUE</span> <span class="o">?</span> <span class="n">currentBalance</span> <span class="o">:</span> <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">(</span><span class="n">amountToRedeem</span> <span class="o">&lt;=</span> <span class="n">currentBalance</span><span class="p">,</span> <span class="s">&#34;User cannot redeem more than the available balance&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">(</span><span class="n">isTransferAllowed</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">amountToRedeem</span><span class="p">),</span> <span class="s">&#34;Transfer cannot be allowed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">updateRedirectedBalanceOfRedirectionAddressInternal</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">balanceIncrease</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">amountToRedeem</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_burn</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">amountToRedeem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 若余额被清空，重置利息重定向以减少存储
</span></span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">userIndexReset</span> <span class="o">=</span> <span class="n">currentBalance</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">amountToRedeem</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">resetDataOnZeroBalanceInternal</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pool</span><span class="p">.</span><span class="n">redeemUnderlying</span><span class="p">(</span><span class="n">underlyingAssetAddress</span><span class="p">,</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">amountToRedeem</span><span class="p">,</span> <span class="n">currentBalance</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">amountToRedeem</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">emit</span> <span class="n">Redeem</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">amountToRedeem</span><span class="p">,</span> <span class="n">balanceIncrease</span><span class="p">,</span> <span class="n">userIndexReset</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    LendingPool->>AToken: mintOnDeposit(account, amount)
    AToken->>LendingPoolCore: cumulateBalanceInternal(account)
    LendingPoolCore-->>AToken: normalizedIncome/index
    AToken-->>User: 铸造 aToken
    User->>AToken: redeem(amount)
    AToken->>LendingPool: redeemUnderlying(...)</pre>
  <pre class="mermaid-dark">sequenceDiagram
    LendingPool->>AToken: mintOnDeposit(account, amount)
    AToken->>LendingPoolCore: cumulateBalanceInternal(account)
    LendingPoolCore-->>AToken: normalizedIncome/index
    AToken-->>User: 铸造 aToken
    User->>AToken: redeem(amount)
    AToken->>LendingPool: redeemUnderlying(...)</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    LendingPool->>AToken: mintOnDeposit(account, amount)
    AToken->>LendingPoolCore: cumulateBalanceInternal(account)
    LendingPoolCore-->>AToken: normalizedIncome/index
    AToken-->>User: 铸造 aToken
    User->>AToken: redeem(amount)
    AToken->>LendingPool: redeemUnderlying(...)</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    LendingPool->>AToken: mintOnDeposit(account, amount)
    AToken->>LendingPoolCore: cumulateBalanceInternal(account)
    LendingPoolCore-->>AToken: normalizedIncome/index
    AToken-->>User: 铸造 aToken
    User->>AToken: redeem(amount)
    AToken->>LendingPool: redeemUnderlying(...)</pre></template>
</div><h3 class="heading-element" id="42-健康因子--与-dataprovider白皮书-111210"><span>4.2 健康因子 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>f</mi></msub></mrow><annotation encoding="application/x-tex">H_f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 与 DataProvider：白皮书 §1.1/§1.2.10</span>
  <a href="#42-%e5%81%a5%e5%ba%b7%e5%9b%a0%e5%ad%90--%e4%b8%8e-dataprovider%e7%99%bd%e7%9a%ae%e4%b9%a6-111210" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><blockquote>
<p>白皮书公式：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>f</mi></msub><mo>=</mo><mfrac><mrow><mi>T</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>l</mi><mi>C</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>a</mi><mi>l</mi><mi>E</mi><mi>T</mi><mi>H</mi><mo>×</mo><msubsup><mi>L</mi><mi>Q</mi><mi>a</mi></msubsup></mrow><mrow><mi>T</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>l</mi><mi>B</mi><mi>o</mi><mi>r</mi><mi>r</mi><mi>o</mi><mi>w</mi><mi>s</mi><mi>E</mi><mi>T</mi><mi>H</mi><mo>+</mo><mi>T</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>l</mi><mi>F</mi><mi>e</mi><mi>e</mi><mi>s</mi><mi>E</mi><mi>T</mi><mi>H</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">H_f = \frac{TotalCollateralETH \times L_Q^a}{TotalBorrowsETH + TotalFeesETH}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.5277em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1244em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">lB</span><span class="mord mathnormal mtight">orro</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">ET</span><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">lF</span><span class="mord mathnormal mtight">ees</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">ET</span><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.6074em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">lC</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">lET</span><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7385em;"><span style="top:-2.214em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">Q</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4249em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>
</blockquote>
<ul>
<li><code>contracts/lendingpool/LendingPoolDataProvider.sol:70-155</code> 的 <code>calculateUserGlobalData</code> 会：
<ol>
<li>遍历所有储备，以预言机价格把存款/借款折算成 ETH；</li>
<li>按照储备的 <code>baseLtv</code> 与 <code>liquidationThreshold</code> 加权求出全局 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>T</mi><msup><mi>V</mi><mi>a</mi></msup></mrow><annotation encoding="application/x-tex">LTV^a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span></span></span></span></span></span></span></span> 与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>L</mi><mi>Q</mi><mi>a</mi></msubsup></mrow><annotation encoding="application/x-tex">L_Q^a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0948em;vertical-align:-0.4114em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4247em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4114em;"><span></span></span></span></span></span></span></span></span></span>；</li>
<li>返回 <code>healthFactor</code>，其内部调用 <code>calculateHealthFactorFromBalancesInternal</code>，完全等价于白皮书的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>f</mi></msub></mrow><annotation encoding="application/x-tex">H_f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 公式。</li>
</ol>
</li>
<li><code>calculateHealthFactorFromBalancesInternal</code>（L322-L334）直接复刻公式，且以 <code>HEALTH_FACTOR_LIQUIDATION_THRESHOLD = 1e18</code> 作为“是否低于 1”的判断基准。</li>
<li>需要注意 <code>currentLiquidationThreshold</code> 在储备配置中是以“百分比（0-100）”储存的，因此函数内部先执行 <code>collateralBalanceETH.mul(liquidationThreshold).div(100)</code> 把抵押价值按阈值折算，再交给 <code>wadDiv</code> 以 1e18 精度除以借款与费用。白皮书里的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>L</mi><mi>Q</mi><mi>a</mi></msubsup></mrow><annotation encoding="application/x-tex">L_Q^a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0948em;vertical-align:-0.4114em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4247em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4114em;"><span></span></span></span></span></span></span></span></span></span> 同样是 0-1 的比率，所以链上实现与公式在单位上保持一致。</li>
<li><code>balanceDecreaseAllowed</code>（L180-L247）在 aToken 转账/赎回前调用同样的健康因子计算：把要转出的 <code>_amount</code> 转为 ETH，重新计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>L</mi><mi>Q</mi><mi>a</mi></msubsup></mrow><annotation encoding="application/x-tex">L_Q^a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0948em;vertical-align:-0.4114em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4247em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4114em;"><span></span></span></span></span></span></span></span></span></span> 与新的抵押余额，再判断 <code>healthFactorAfterDecrease &gt; 1e18</code>。这就是白皮书 §3.2/§3.3 中“赎回/转移必须保持 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>f</mi></msub><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">H_f&gt;1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>”的实现。</li>
<li><code>calculateCollateralNeededInETH</code>（L258-L284）则给出了“为了新增借款需要多少抵押”的推导，依赖前面求得的加权 LTV，和白皮书 §3.3 的理论一致。</li>
</ul>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">calculateHealthFactorFromBalancesInternal</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_collateralBalanceETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_borrowBalanceETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_totalFeesETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_currentLiquidationThreshold</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="k">internal</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_borrowBalanceETH</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kt">uint256</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="n">_collateralBalanceETH</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">wadMul</span><span class="p">(</span><span class="n">_currentLiquidationThreshold</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">wadDiv</span><span class="p">(</span><span class="n">_borrowBalanceETH</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">_totalFeesETH</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><p><code>wadMul/wadDiv</code> 保证 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>f</mi></msub></mrow><annotation encoding="application/x-tex">H_f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>10</mn><mn>18</mn></msup></mrow><annotation encoding="application/x-tex">10^{18}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">18</span></span></span></span></span></span></span></span></span></span></span></span> 精度计算，避免了浮点误差。</p>
<h3 class="heading-element" id="43-清算二次校验balancedecreaseallowed-与-liquidationcall"><span>4.3 清算二次校验：<code>balanceDecreaseAllowed</code> 与 <code>liquidationCall</code></span>
  <a href="#43-%e6%b8%85%e7%ae%97%e4%ba%8c%e6%ac%a1%e6%a0%a1%e9%aa%8cbalancedecreaseallowed-%e4%b8%8e-liquidationcall" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>当清算人调用 <code>LendingPool.liquidationCall</code> 时，<code>LendingPoolLiquidationManager</code> 会再次通过 <code>calculateUserGlobalData</code> 获取 <code>healthFactorBelowThreshold</code>（<code>contracts/lendingpool/LendingPoolLiquidationManager.sol:534-542</code>），只有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>f</mi></msub><mo>&lt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">H_f &lt; 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 才会继续执行，这与白皮书“以健康因子判断是否可被清算”保持一致。</li>
<li><code>calculateAvailableCollateralToLiquidate</code>（L585-L600）是白皮书清算公式的链上版本：
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>a</mi><msub><mi>l</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><mfrac><mrow><mi>B</mi><mi>o</mi><mi>r</mi><mi>r</mi><mi>o</mi><mi>w</mi><mi>P</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mo>×</mo><mi>A</mi><mi>m</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mo>×</mo><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mi>B</mi><mi>o</mi><mi>n</mi><mi>u</mi><mi>s</mi><mo stretchy="false">)</mo></mrow><mrow><mi>C</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>a</mi><mi>l</mi><mi>P</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">Collateral_{max} = \frac{BorrowPrice \times Amount \times (1 + Bonus)}{CollateralPrice}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.355em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">lP</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">ce</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mord mathnormal mtight">orro</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">wP</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">ce</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">×</span><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">s</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>
当抵押不足以覆盖 <code>Amount</code> 时，会反推 <code>principalAmountNeeded</code>，实现白皮书所述“按比例扣抵押”的机制。</li>
<li>Origination fee 清算逻辑（L591-L605）则将费用视作额外的 <code>Amount</code> 再跑一次上述公式，确保费用也能按 liquidation bonus 折价买入。</li>
</ul>
<h3 class="heading-element" id="44-转账与利息重定向延续原笔记"><span>4.4 转账与利息重定向（延续原笔记）</span>
  <a href="#44-%e8%bd%ac%e8%b4%a6%e4%b8%8e%e5%88%a9%e6%81%af%e9%87%8d%e5%ae%9a%e5%90%91%e5%bb%b6%e7%bb%ad%e5%8e%9f%e7%ac%94%e8%ae%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>所有 <code>_transfer</code> 都走 <code>whenTransferAllowed</code> 修饰器，它会调用 <code>balanceDecreaseAllowed</code>，因此上一节的健康因子计算同样适用于普通转账/赎回。</li>
<li><code>executeTransferInternal</code> 在实际转账前会分别对 <code>from</code> 和 <code>to</code> 做一次 <code>cumulateBalanceInternal</code>，并通过 <code>updateRedirectedBalanceOfRedirectionAddressInternal</code> 把应计利息同步到重定向地址。这样即便用户开启了 <code>redirectInterestStream</code>，其委托人也能接收到每一笔余额变化。</li>
<li><code>redirectInterestStream</code>/<code>redirectInterestStreamOf</code> 允许用户或被授权者把未来利息重定向到另一个地址，<code>allowInterestRedirectionTo</code> 和 <code>redirectedBalances</code> 则负责授信与记账；清算与赎回完成后若余额归零，利息重定向也会被自动重置。</li>
</ul>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">executeTransferInternal</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_from</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_to</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_value</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">(</span><span class="n">_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;Transferred amount needs to be greater than zero&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">(,</span> <span class="kt">uint256</span> <span class="n">fromBalance</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">fromBalanceIncrease</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">fromIndex</span><span class="p">)</span> <span class="o">=</span> <span class="n">cumulateBalanceInternal</span><span class="p">(</span><span class="n">_from</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">(,</span> <span class="p">,</span> <span class="kt">uint256</span> <span class="n">toBalanceIncrease</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">toIndex</span><span class="p">)</span> <span class="o">=</span> <span class="n">cumulateBalanceInternal</span><span class="p">(</span><span class="n">_to</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">updateRedirectedBalanceOfRedirectionAddressInternal</span><span class="p">(</span><span class="n">_from</span><span class="p">,</span> <span class="n">fromBalanceIncrease</span><span class="p">,</span> <span class="n">_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">updateRedirectedBalanceOfRedirectionAddressInternal</span><span class="p">(</span><span class="n">_to</span><span class="p">,</span> <span class="n">toBalanceIncrease</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">_value</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nb">super</span><span class="p">.</span><span class="n">_transfer</span><span class="p">(</span><span class="n">_from</span><span class="p">,</span> <span class="n">_to</span><span class="p">,</span> <span class="n">_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">fromIndexReset</span> <span class="o">=</span> <span class="n">fromBalance</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">resetDataOnZeroBalanceInternal</span><span class="p">(</span><span class="n">_from</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">emit</span> <span class="n">BalanceTransfer</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">_from</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_to</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">fromBalanceIncrease</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">toBalanceIncrease</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">fromIndexReset</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">fromIndex</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">toIndex</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><h3 class="heading-element" id="5-数学底座wadraymath-与利率分段策略"><span>5 数学底座：WadRayMath 与利率分段策略</span>
  <a href="#5-%e6%95%b0%e5%ad%a6%e5%ba%95%e5%ba%a7wadraymath-%e4%b8%8e%e5%88%a9%e7%8e%87%e5%88%86%e6%ae%b5%e7%ad%96%e7%95%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 class="heading-element" id="51-wadray-精度白皮书-128-的数值基础"><span>5.1 Wad/Ray 精度：白皮书 §1.2.8 的数值基础</span>
  <a href="#51-wadray-%e7%b2%be%e5%ba%a6%e7%99%bd%e7%9a%ae%e4%b9%a6-128-%e7%9a%84%e6%95%b0%e5%80%bc%e5%9f%ba%e7%a1%80" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><blockquote>
<p>公式中的所有利率、指数都以 ray（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>10</mn><mn>27</mn></msup></mrow><annotation encoding="application/x-tex">10^{27}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">27</span></span></span></span></span></span></span></span></span></span></span></span>）或 wad（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>10</mn><mn>18</mn></msup></mrow><annotation encoding="application/x-tex">10^{18}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">18</span></span></span></span></span></span></span></span></span></span></span></span>）表示</p>
</blockquote>
<ul>
<li><code>contracts/libraries/WadRayMath.sol:37-84</code> 定义了 <code>wadMul/wadDiv/rayMul/rayDiv</code>，它们分别实现
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>rayMul</mtext><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>a</mi><mo>⋅</mo><mi>b</mi><mo>+</mo><mn>0.5</mn><mo>×</mo><msup><mn>10</mn><mn>27</mn></msup></mrow><msup><mn>10</mn><mn>27</mn></msup></mfrac></mrow><annotation encoding="application/x-tex">\text{rayMul}(a,b) = \frac{a\cdot b + 0.5\times10^{27}}{10^{27}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">rayMul</span></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.3629em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0179em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">27</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mbin mtight">⋅</span><span class="mord mathnormal mtight">b</span><span class="mbin mtight">+</span><span class="mord mtight">0.5</span><span class="mbin mtight">×</span><span class="mord mtight">1</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">27</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>rayDiv</mtext><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>a</mi><mo>⋅</mo><msup><mn>10</mn><mn>27</mn></msup><mo>+</mo><mn>0.5</mn><mi>b</mi></mrow><mi>b</mi></mfrac></mrow><annotation encoding="application/x-tex">\text{rayDiv}(a,b) = \frac{a\cdot10^{27}+0.5b}{b}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">rayDiv</span></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.3629em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0179em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mbin mtight">⋅</span><span class="mord mtight">1</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">27</span></span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight">0.5</span><span class="mord mathnormal mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>
通过在分子加半个单位实现四舍五入（half-up rounding），而非银行家舍入（ties-to-even），从而保证利率/指数乘除不会因为 Solidity <code>uint256</code> 整除而失去精度。</li>
<li><code>wadToRay</code> / <code>rayToWad</code> 用 <code>WAD_RAY_RATIO = 1e9</code> 在两个精度之间转换，供 <code>calculateHealthFactorFromBalancesInternal</code> 等函数把 LTV/HealthFactor（wad）与指数（ray）混用。</li>
<li><code>rayPow</code> 则是白皮书 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mi>R</mi><mi mathvariant="normal">/</mi><msub><mi>T</mi><mrow><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi></mrow></msub><msup><mo stretchy="false">)</mo><mrow><mi mathvariant="normal">Δ</mi><mi>T</mi></mrow></msup></mrow><annotation encoding="application/x-tex">(1 + R/T_{year})^{\Delta T}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1274em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">/</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ye</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Δ</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span> 的实现：它通过“二进制快速幂 + 每次迭代的 <code>rayMul</code>”计算指数函数，供 <code>CoreLibrary.calculateCompoundedInterest</code> 调用。因为 <code>rayPow</code> 只接受 ray 单位，整个协议的复利计算才能保持高精度。</li>
</ul>
<h4 class="heading-element" id="52-分段利率策略再访"><span>5.2 分段利率策略再访</span>
  <a href="#52-%e5%88%86%e6%ae%b5%e5%88%a9%e7%8e%87%e7%ad%96%e7%95%a5%e5%86%8d%e8%ae%bf" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><code>DefaultReserveInterestRateStrategy</code> 的 piecewise 函数前面已经在 §3.6 讨论，这里强调该策略与 <code>WadRayMath</code> 完全绑定：
<ul>
<li>所有 slope/基础利率都以 ray 表示；</li>
<li><code>utilizationRate</code>、<code>excessUtilizationRateRatio</code> 使用 <code>rayDiv</code>，避免浮点误差；</li>
<li><code>getOverallBorrowRateInternal</code> 将稳定/浮动借款金额先 <code>wadToRay</code> 再 <code>rayMul</code>，与白皮书“按金额加权”一致。</li>
</ul>
</li>
<li>这种“Ray 精度 + 两段斜率”的组合确保白皮书中的连续函数可以直接映射为 Solidity 算术。</li>
</ul>
<hr>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">redirectInterestStreamInternal</span><span class="p">(</span><span class="kt">address</span> <span class="n">_from</span><span class="p">,</span> <span class="kt">address</span> <span class="n">_to</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">currentRedirectionAddress</span> <span class="o">=</span> <span class="n">interestRedirectionAddresses</span><span class="p">[</span><span class="n">_from</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">(</span><span class="n">_to</span> <span class="o">!=</span> <span class="n">currentRedirectionAddress</span><span class="p">,</span> <span class="s">&#34;Interest is already redirected to the user&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">previousPrincipalBalance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">fromBalance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">balanceIncrease</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">fromIndex</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">=</span> <span class="n">cumulateBalanceInternal</span><span class="p">(</span><span class="n">_from</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">(</span><span class="n">fromBalance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;Interest stream can only be redirected if there is a valid balance&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">currentRedirectionAddress</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 旧重定向账户需要减去用户本金，否则会重复计息
</span></span></span><span class="line"><span class="cl">        <span class="n">updateRedirectedBalanceOfRedirectionAddressInternal</span><span class="p">(</span><span class="n">_from</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">previousPrincipalBalance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_to</span> <span class="o">==</span> <span class="n">_from</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 将利息重定向给自己意味着撤销重定向
</span></span></span><span class="line"><span class="cl">        <span class="n">interestRedirectionAddresses</span><span class="p">[</span><span class="n">_from</span><span class="p">]</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">InterestStreamRedirected</span><span class="p">(</span><span class="n">_from</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fromBalance</span><span class="p">,</span> <span class="n">balanceIncrease</span><span class="p">,</span> <span class="n">fromIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">interestRedirectionAddresses</span><span class="p">[</span><span class="n">_from</span><span class="p">]</span> <span class="o">=</span> <span class="n">_to</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">updateRedirectedBalanceOfRedirectionAddressInternal</span><span class="p">(</span><span class="n">_from</span><span class="p">,</span> <span class="n">fromBalance</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">emit</span> <span class="n">InterestStreamRedirected</span><span class="p">(</span><span class="n">_from</span><span class="p">,</span> <span class="n">_to</span><span class="p">,</span> <span class="n">fromBalance</span><span class="p">,</span> <span class="n">balanceIncrease</span><span class="p">,</span> <span class="n">fromIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    User->>AToken: transfer(to, value)
    AToken->>LendingPoolDataProvider: balanceDecreaseAllowed()
    AToken->>LendingPoolCore: cumulateBalanceInternal(from/to)
    AToken->>AToken: updateRedirectedBalanceOfRedirectionAddressInternal()
    AToken-->>User: BalanceTransfer 事件
    User->>AToken: redirectInterestStream(target)
    AToken->>LendingPoolCore: cumulateBalanceInternal(user)</pre>
  <pre class="mermaid-dark">sequenceDiagram
    User->>AToken: transfer(to, value)
    AToken->>LendingPoolDataProvider: balanceDecreaseAllowed()
    AToken->>LendingPoolCore: cumulateBalanceInternal(from/to)
    AToken->>AToken: updateRedirectedBalanceOfRedirectionAddressInternal()
    AToken-->>User: BalanceTransfer 事件
    User->>AToken: redirectInterestStream(target)
    AToken->>LendingPoolCore: cumulateBalanceInternal(user)</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    User->>AToken: transfer(to, value)
    AToken->>LendingPoolDataProvider: balanceDecreaseAllowed()
    AToken->>LendingPoolCore: cumulateBalanceInternal(from/to)
    AToken->>AToken: updateRedirectedBalanceOfRedirectionAddressInternal()
    AToken-->>User: BalanceTransfer 事件
    User->>AToken: redirectInterestStream(target)
    AToken->>LendingPoolCore: cumulateBalanceInternal(user)</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    User->>AToken: transfer(to, value)
    AToken->>LendingPoolDataProvider: balanceDecreaseAllowed()
    AToken->>LendingPoolCore: cumulateBalanceInternal(from/to)
    AToken->>AToken: updateRedirectedBalanceOfRedirectionAddressInternal()
    AToken-->>User: BalanceTransfer 事件
    User->>AToken: redirectInterestStream(target)
    AToken->>LendingPoolCore: cumulateBalanceInternal(user)</pre></template>
</div><h3 class="heading-element" id="43-lendingpooldataprovider-的聚合视图"><span>4.3 LendingPoolDataProvider 的聚合视图</span>
  <a href="#43-lendingpooldataprovider-%e7%9a%84%e8%81%9a%e5%90%88%e8%a7%86%e5%9b%be" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li><code>calculateUserGlobalData</code> 遍历 <code>core.getReserves()</code>，为每个储备读取 <code>getUserBasicReserveData</code> 和 <code>getReserveConfiguration</code>，再结合 <code>IPriceOracleGetter</code> 估值成 ETH，计算 <code>totalLiquidityBalanceETH</code>/<code>totalCollateralBalanceETH</code>/<code>totalBorrowBalanceETH</code>/<code>totalFeesETH</code>、加权 LTV 与 Liquidation Threshold，并输出 <code>healthFactor</code> 与 <code>healthFactorBelowThreshold</code>。</li>
<li><code>balanceDecreaseAllowed</code>、<code>calculateCollateralNeededInETH</code>、<code>calculateAvailableBorrowsETHInternal</code> 和 <code>calculateHealthFactorFromBalancesInternal</code> 是入口层风险控制的支撑：前者用于 aToken 转账/赎回时的余额减少校验，后两者则告诉借款路径“想再借多少需要多少抵押物”“当前抵押还能借多少 ETH”。</li>
<li>对前端或分析工具，<code>getReserveData</code>、<code>getReserveConfigurationData</code>、<code>getUserAccountData</code> 与 <code>getUserReserveData</code> 提供了完整的储备与账户视图，免去了直接读 Core 底层存储的复杂度。</li>
</ul>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">calculateUserGlobalData</span><span class="p">(</span><span class="kt">address</span> <span class="n">_user</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span>
</span></span><span class="line"><span class="cl">    <span class="k">view</span>
</span></span><span class="line"><span class="cl">    <span class="k">returns</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">totalLiquidityBalanceETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">totalCollateralBalanceETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">totalBorrowBalanceETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">totalFeesETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">currentLtv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">currentLiquidationThreshold</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">healthFactor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">healthFactorBelowThreshold</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">IPriceOracleGetter</span> <span class="n">oracle</span> <span class="o">=</span> <span class="n">IPriceOracleGetter</span><span class="p">(</span><span class="n">addressesProvider</span><span class="p">.</span><span class="n">getPriceOracle</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">reserves</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">getReserves</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reserves</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">compoundedLiquidityBalance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">compoundedBorrowBalance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">originationFee</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="kt">bool</span> <span class="n">userUsesReserveAsCollateral</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">getUserBasicReserveData</span><span class="p">(</span><span class="n">reserves</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">compoundedLiquidityBalance</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">compoundedBorrowBalance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">reserveDecimals</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">baseLtv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">liquidationThreshold</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="kt">bool</span> <span class="n">usageAsCollateralEnabled</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">getReserveConfiguration</span><span class="p">(</span><span class="n">reserves</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">tokenUnit</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">reserveDecimals</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">reserveUnitPrice</span> <span class="o">=</span> <span class="n">oracle</span><span class="p">.</span><span class="n">getAssetPrice</span><span class="p">(</span><span class="n">reserves</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">compoundedLiquidityBalance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 使用预言机价格将存款折算成 ETH
</span></span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">liquidityBalanceETH</span> <span class="o">=</span> <span class="n">reserveUnitPrice</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">compoundedLiquidityBalance</span><span class="p">).</span><span class="n">div</span><span class="p">(</span><span class="n">tokenUnit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">totalLiquidityBalanceETH</span> <span class="o">=</span> <span class="n">totalLiquidityBalanceETH</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">liquidityBalanceETH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">usageAsCollateralEnabled</span> <span class="o">&amp;&amp;</span> <span class="n">userUsesReserveAsCollateral</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 只有开启抵押的储备才会累加到 collateral
</span></span></span><span class="line"><span class="cl">                <span class="n">totalCollateralBalanceETH</span> <span class="o">=</span> <span class="n">totalCollateralBalanceETH</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">liquidityBalanceETH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">currentLtv</span> <span class="o">=</span> <span class="n">currentLtv</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">liquidityBalanceETH</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">baseLtv</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="n">currentLiquidationThreshold</span> <span class="o">=</span> <span class="n">currentLiquidationThreshold</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">liquidityBalanceETH</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">liquidationThreshold</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">compoundedBorrowBalance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 借款和 origination fee 同样按 ETH 计价
</span></span></span><span class="line"><span class="cl">            <span class="n">totalBorrowBalanceETH</span> <span class="o">=</span> <span class="n">totalBorrowBalanceETH</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">reserveUnitPrice</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">compoundedBorrowBalance</span><span class="p">).</span><span class="n">div</span><span class="p">(</span><span class="n">tokenUnit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">totalFeesETH</span> <span class="o">=</span> <span class="n">totalFeesETH</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">originationFee</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">reserveUnitPrice</span><span class="p">).</span><span class="n">div</span><span class="p">(</span><span class="n">tokenUnit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">currentLtv</span> <span class="o">=</span> <span class="n">totalCollateralBalanceETH</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">currentLtv</span><span class="p">.</span><span class="n">div</span><span class="p">(</span><span class="n">totalCollateralBalanceETH</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">currentLiquidationThreshold</span> <span class="o">=</span> <span class="n">totalCollateralBalanceETH</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="o">?</span> <span class="n">currentLiquidationThreshold</span><span class="p">.</span><span class="n">div</span><span class="p">(</span><span class="n">totalCollateralBalanceETH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Health Factor &lt; 1 即可被清算
</span></span></span><span class="line"><span class="cl">    <span class="n">healthFactor</span> <span class="o">=</span> <span class="n">calculateHealthFactorFromBalancesInternal</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">totalCollateralBalanceETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">totalBorrowBalanceETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">totalFeesETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">currentLiquidationThreshold</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">healthFactorBelowThreshold</span> <span class="o">=</span> <span class="n">healthFactor</span> <span class="o">&lt;</span> <span class="n">HEALTH_FACTOR_LIQUIDATION_THRESHOLD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    Frontend->>LendingPoolDataProvider: calculateUserGlobalData(user)
    DataProvider->>LendingPoolCore: getReserves()
    loop 每个储备
        DataProvider->>LendingPoolCore: getUserBasicReserveData()
        DataProvider->>LendingPoolCore: getReserveConfiguration()
        DataProvider->>PriceOracle: getAssetPrice(reserve)
    end
    DataProvider-->>Frontend: collateral/borrow/healthFactor
    AToken->>LendingPoolDataProvider: balanceDecreaseAllowed()</pre>
  <pre class="mermaid-dark">sequenceDiagram
    Frontend->>LendingPoolDataProvider: calculateUserGlobalData(user)
    DataProvider->>LendingPoolCore: getReserves()
    loop 每个储备
        DataProvider->>LendingPoolCore: getUserBasicReserveData()
        DataProvider->>LendingPoolCore: getReserveConfiguration()
        DataProvider->>PriceOracle: getAssetPrice(reserve)
    end
    DataProvider-->>Frontend: collateral/borrow/healthFactor
    AToken->>LendingPoolDataProvider: balanceDecreaseAllowed()</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    Frontend->>LendingPoolDataProvider: calculateUserGlobalData(user)
    DataProvider->>LendingPoolCore: getReserves()
    loop 每个储备
        DataProvider->>LendingPoolCore: getUserBasicReserveData()
        DataProvider->>LendingPoolCore: getReserveConfiguration()
        DataProvider->>PriceOracle: getAssetPrice(reserve)
    end
    DataProvider-->>Frontend: collateral/borrow/healthFactor
    AToken->>LendingPoolDataProvider: balanceDecreaseAllowed()</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    Frontend->>LendingPoolDataProvider: calculateUserGlobalData(user)
    DataProvider->>LendingPoolCore: getReserves()
    loop 每个储备
        DataProvider->>LendingPoolCore: getUserBasicReserveData()
        DataProvider->>LendingPoolCore: getReserveConfiguration()
        DataProvider->>PriceOracle: getAssetPrice(reserve)
    end
    DataProvider-->>Frontend: collateral/borrow/healthFactor
    AToken->>LendingPoolDataProvider: balanceDecreaseAllowed()</pre></template>
</div><div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">balanceDecreaseAllowed</span><span class="p">(</span><span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span> <span class="kt">address</span> <span class="n">_user</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">external</span>
</span></span><span class="line"><span class="cl">    <span class="k">view</span>
</span></span><span class="line"><span class="cl">    <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">balanceDecreaseAllowedLocalVars</span> <span class="k">memory</span> <span class="n">vars</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">decimals</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">reserveLiquidationThreshold</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">reserveUsageAsCollateralEnabled</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">getReserveConfiguration</span><span class="p">(</span><span class="n">_reserve</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="n">vars</span><span class="p">.</span><span class="n">reserveUsageAsCollateralEnabled</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="n">core</span><span class="p">.</span><span class="n">isUserUseReserveAsCollateralEnabled</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="n">_user</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">collateralBalanceETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">borrowBalanceETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">totalFeesETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">currentLiquidationThreshold</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">=</span> <span class="n">calculateUserGlobalData</span><span class="p">(</span><span class="n">_user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">borrowBalanceETH</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 没有借款则随意转出
</span></span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IPriceOracleGetter</span> <span class="n">oracle</span> <span class="o">=</span> <span class="n">IPriceOracleGetter</span><span class="p">(</span><span class="n">addressesProvider</span><span class="p">.</span><span class="n">getPriceOracle</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">vars</span><span class="p">.</span><span class="n">amountToDecreaseETH</span> <span class="o">=</span> <span class="n">oracle</span><span class="p">.</span><span class="n">getAssetPrice</span><span class="p">(</span><span class="n">_reserve</span><span class="p">).</span><span class="n">mul</span><span class="p">(</span><span class="n">_amount</span><span class="p">).</span><span class="n">div</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">vars</span><span class="p">.</span><span class="n">decimals</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">vars</span><span class="p">.</span><span class="n">collateralBalancefterDecrease</span> <span class="o">=</span> <span class="n">vars</span><span class="p">.</span><span class="n">collateralBalanceETH</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">amountToDecreaseETH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">collateralBalancefterDecrease</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">vars</span><span class="p">.</span><span class="n">liquidationThresholdAfterDecrease</span> <span class="o">=</span> <span class="n">vars</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">collateralBalanceETH</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">currentLiquidationThreshold</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">amountToDecreaseETH</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">reserveLiquidationThreshold</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">div</span><span class="p">(</span><span class="n">vars</span><span class="p">.</span><span class="n">collateralBalancefterDecrease</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">healthFactorAfterDecrease</span> <span class="o">=</span> <span class="n">calculateHealthFactorFromBalancesInternal</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">collateralBalancefterDecrease</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">borrowBalanceETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">totalFeesETH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">vars</span><span class="p">.</span><span class="n">liquidationThresholdAfterDecrease</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 只有在转出后 health factor 仍大于阈值时才允许
</span></span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">healthFactorAfterDecrease</span> <span class="o">&gt;</span> <span class="n">HEALTH_FACTOR_LIQUIDATION_THRESHOLD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><h2 class="heading-element" id="5-策略与治理模块"><span>5 策略与治理模块</span>
  <a href="#5-%e7%ad%96%e7%95%a5%e4%b8%8e%e6%b2%bb%e7%90%86%e6%a8%a1%e5%9d%97" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>入口层与核心层之间还有一组“控制平面”合约，负责利率曲线、费用、参数治理与地址注册，确保状态与策略可以独立升级。</p>
<h3 class="heading-element" id="51-利率策略defaultreserveinterestratestrategy"><span>5.1 利率策略：DefaultReserveInterestRateStrategy</span>
  <a href="#51-%e5%88%a9%e7%8e%87%e7%ad%96%e7%95%a5defaultreserveinterestratestrategy" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li><code>DefaultReserveInterestRateStrategy</code> 在构造时固定 <code>OPTIMAL_UTILIZATION_RATE = 80%</code>，把利用率划成两段 Kink 曲线：未超过拐点时按 <code>baseVariableBorrowRate + utilization/optimal * slope1</code> 增长，一旦突破则用 <code>slope2</code> 快速抬升利率。</li>
<li>稳定利率部分以上述曲线叠加 <code>ILendingRateOracle</code> 提供的市场利率；变量利率则直接围绕 <code>baseVariableBorrowRate</code> 调整。<code>calculateInterestRates</code> 返回 (liquidityRate, stableBorrowRate, variableBorrowRate)，再由 Core 缓存成储备的当前利率。</li>
<li><code>getOverallBorrowRateInternal</code> 把稳定/浮动借款金额按权重换算成单一利率，供 <code>liquidityRate = utilization * overallBorrowRate</code> 使用，从而把借款收入在指数中摊给存款人。</li>
</ul>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">calculateInterestRates</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_availableLiquidity</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_totalBorrowsStable</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_totalBorrowsVariable</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_averageStableBorrowRate</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">external</span>
</span></span><span class="line"><span class="cl">    <span class="k">view</span>
</span></span><span class="line"><span class="cl">    <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">currentLiquidityRate</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">currentStableBorrowRate</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">currentVariableBorrowRate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">totalBorrows</span> <span class="o">=</span> <span class="n">_totalBorrowsStable</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">_totalBorrowsVariable</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">utilizationRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">totalBorrows</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">_availableLiquidity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">?</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="n">totalBorrows</span><span class="p">.</span><span class="n">rayDiv</span><span class="p">(</span><span class="n">_availableLiquidity</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">totalBorrows</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 稳定利率以预言机的市场借款利率为基线
</span></span></span><span class="line"><span class="cl">    <span class="n">currentStableBorrowRate</span> <span class="o">=</span> <span class="n">ILendingRateOracle</span><span class="p">(</span><span class="n">addressesProvider</span><span class="p">.</span><span class="n">getLendingRateOracle</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">getMarketBorrowRate</span><span class="p">(</span><span class="n">_reserve</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">utilizationRate</span> <span class="o">&gt;</span> <span class="n">OPTIMAL_UTILIZATION_RATE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">excessUtilizationRateRatio</span> <span class="o">=</span> <span class="n">utilizationRate</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">OPTIMAL_UTILIZATION_RATE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">rayDiv</span><span class="p">(</span><span class="n">EXCESS_UTILIZATION_RATE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 超过拐点后使用 slope2 快速抬升借款利率
</span></span></span><span class="line"><span class="cl">        <span class="n">currentStableBorrowRate</span> <span class="o">=</span> <span class="n">currentStableBorrowRate</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">stableRateSlope1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">stableRateSlope2</span><span class="p">.</span><span class="n">rayMul</span><span class="p">(</span><span class="n">excessUtilizationRateRatio</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">currentVariableBorrowRate</span> <span class="o">=</span> <span class="n">baseVariableBorrowRate</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">variableRateSlope1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">variableRateSlope2</span><span class="p">.</span><span class="n">rayMul</span><span class="p">(</span><span class="n">excessUtilizationRateRatio</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 未超过拐点时按 slope1 线性插值
</span></span></span><span class="line"><span class="cl">        <span class="n">currentStableBorrowRate</span> <span class="o">=</span> <span class="n">currentStableBorrowRate</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">stableRateSlope1</span><span class="p">.</span><span class="n">rayMul</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">utilizationRate</span><span class="p">.</span><span class="n">rayDiv</span><span class="p">(</span><span class="n">OPTIMAL_UTILIZATION_RATE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">currentVariableBorrowRate</span> <span class="o">=</span> <span class="n">baseVariableBorrowRate</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">utilizationRate</span><span class="p">.</span><span class="n">rayDiv</span><span class="p">(</span><span class="n">OPTIMAL_UTILIZATION_RATE</span><span class="p">).</span><span class="n">rayMul</span><span class="p">(</span><span class="n">variableRateSlope1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">currentLiquidityRate</span> <span class="o">=</span> <span class="n">getOverallBorrowRateInternal</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">_totalBorrowsStable</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_totalBorrowsVariable</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">currentVariableBorrowRate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_averageStableBorrowRate</span>
</span></span><span class="line"><span class="cl">    <span class="p">).</span><span class="n">rayMul</span><span class="p">(</span><span class="n">utilizationRate</span><span class="p">);</span> <span class="c1">// 存款收益 = 利用率 * 借款平均利率
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    LendingPoolCore->>InterestRateStrategy: calculateInterestRates(reserveData)
    InterestRateStrategy->>LendingRateOracle: getMarketBorrowRate()
    InterestRateStrategy-->>LendingPoolCore: (liquidityRate, stableRate, variableRate)
    LendingPoolCore-->>Reserves: 更新 currentLiquidityRate/currentBorrowRates</pre>
  <pre class="mermaid-dark">sequenceDiagram
    LendingPoolCore->>InterestRateStrategy: calculateInterestRates(reserveData)
    InterestRateStrategy->>LendingRateOracle: getMarketBorrowRate()
    InterestRateStrategy-->>LendingPoolCore: (liquidityRate, stableRate, variableRate)
    LendingPoolCore-->>Reserves: 更新 currentLiquidityRate/currentBorrowRates</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    LendingPoolCore->>InterestRateStrategy: calculateInterestRates(reserveData)
    InterestRateStrategy->>LendingRateOracle: getMarketBorrowRate()
    InterestRateStrategy-->>LendingPoolCore: (liquidityRate, stableRate, variableRate)
    LendingPoolCore-->>Reserves: 更新 currentLiquidityRate/currentBorrowRates</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    LendingPoolCore->>InterestRateStrategy: calculateInterestRates(reserveData)
    InterestRateStrategy->>LendingRateOracle: getMarketBorrowRate()
    InterestRateStrategy-->>LendingPoolCore: (liquidityRate, stableRate, variableRate)
    LendingPoolCore-->>Reserves: 更新 currentLiquidityRate/currentBorrowRates</pre></template>
</div><h3 class="heading-element" id="52-费用与参数提供者"><span>5.2 费用与参数提供者</span>
  <a href="#52-%e8%b4%b9%e7%94%a8%e4%b8%8e%e5%8f%82%e6%95%b0%e6%8f%90%e4%be%9b%e8%80%85" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li><code>FeeProvider</code> 目前把 <code>originationFeePercentage</code> 固定为 0.25% (<code>0.0025 * 1e18</code>)，<code>calculateLoanOriginationFee</code> 简单地对 <code>_amount</code> 做 <code>wadMul</code>。如果未来要做折扣或分级收费，也可以通过替换实现来完成。</li>
<li><code>LendingPoolParametersProvider</code> 给入口层提供全局的常量，如 <code>MAX_STABLE_RATE_BORROW_SIZE_PERCENT = 25</code>（单次稳定利率借款最多占可用流动性的 25%）、<code>REBALANCE_DOWN_RATE_DELTA</code>（触发稳定利率重平衡的阈值）以及闪电贷费率 <code>(FLASHLOAN_FEE_TOTAL=35, FLASHLOAN_FEE_PROTOCOL=3000)</code>。这些值直接被 <code>LendingPool.borrow</code>、<code>flashLoan</code> 和 <code>LendingPoolLiquidationManager</code> 使用。</li>
</ul>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">calculateLoanOriginationFee</span><span class="p">(</span><span class="kt">address</span> <span class="n">_user</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">external</span>
</span></span><span class="line"><span class="cl">    <span class="k">view</span>
</span></span><span class="line"><span class="cl">    <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 目前未根据 _user 区分费率，直接返回金额 * 0.25%
</span></span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">_amount</span><span class="p">.</span><span class="n">wadMul</span><span class="p">(</span><span class="n">originationFeePercentage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">getFlashLoanFeesInBips</span><span class="p">()</span> <span class="k">external</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">,</span> <span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// (总费率, 协议分润)；其余部分将流向存款人
</span></span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">FLASHLOAN_FEE_TOTAL</span><span class="p">,</span> <span class="n">FLASHLOAN_FEE_PROTOCOL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    LendingPool->>FeeProvider: calculateLoanOriginationFee(user, amount)
    FeeProvider-->>LendingPool: amount * originationFee%
    LendingPool->>ParametersProvider: getFlashLoanFeesInBips()
    ParametersProvider-->>LendingPool: (totalFee, protocolFee)</pre>
  <pre class="mermaid-dark">sequenceDiagram
    LendingPool->>FeeProvider: calculateLoanOriginationFee(user, amount)
    FeeProvider-->>LendingPool: amount * originationFee%
    LendingPool->>ParametersProvider: getFlashLoanFeesInBips()
    ParametersProvider-->>LendingPool: (totalFee, protocolFee)</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    LendingPool->>FeeProvider: calculateLoanOriginationFee(user, amount)
    FeeProvider-->>LendingPool: amount * originationFee%
    LendingPool->>ParametersProvider: getFlashLoanFeesInBips()
    ParametersProvider-->>LendingPool: (totalFee, protocolFee)</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    LendingPool->>FeeProvider: calculateLoanOriginationFee(user, amount)
    FeeProvider-->>LendingPool: amount * originationFee%
    LendingPool->>ParametersProvider: getFlashLoanFeesInBips()
    ParametersProvider-->>LendingPool: (totalFee, protocolFee)</pre></template>
</div><h3 class="heading-element" id="53-配置器lendingpoolconfigurator"><span>5.3 配置器：LendingPoolConfigurator</span>
  <a href="#53-%e9%85%8d%e7%bd%ae%e5%99%a8lendingpoolconfigurator" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li><code>LendingPoolConfigurator</code> 只允许 <code>addressesProvider.getLendingPoolManager()</code> 调用，负责所有储备级别的治理操作。<code>initReserve</code> 会部署一个新的 <code>AToken</code>、把它注册到 Core，并绑定外部提供的利率策略；<code>removeLastAddedReserve</code> 则可删除尾部储备。</li>
<li>参数修改方面，包括 <code>enable/disableBorrowingOnReserve</code>、<code>enableReserveAsCollateral</code>、<code>setReserveBaseLTVasCollateral</code>、<code>setReserveLiquidationThreshold/Bonus/Decimals</code>、<code>enableReserveStableBorrowRate</code>、<code>activate/deactivate/freeze/unfreezeReserve</code> 等函数。治理合约或多签只需调用 Configurator，就能同步调整 Core 内的所有风险字段。</li>
</ul>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">initReserve</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8</span> <span class="n">_underlyingAssetDecimals</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_interestRateStrategyAddress</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="k">external</span> <span class="n">onlyLendingPoolManager</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ERC20Detailed</span> <span class="n">asset</span> <span class="o">=</span> <span class="n">ERC20Detailed</span><span class="p">(</span><span class="n">_reserve</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="k">memory</span> <span class="n">aTokenName</span> <span class="o">=</span> <span class="kt">string</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="s">&#34;Aave Interest bearing &#34;</span><span class="p">,</span> <span class="n">asset</span><span class="p">.</span><span class="nb">name</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="k">memory</span> <span class="n">aTokenSymbol</span> <span class="o">=</span> <span class="kt">string</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="s">&#34;a&#34;</span><span class="p">,</span> <span class="n">asset</span><span class="p">.</span><span class="n">symbol</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 若底层 ERC20 未提供 name/decimals，可使用 initReserveWithData 直接传自定义值
</span></span></span><span class="line"><span class="cl">    <span class="n">initReserveWithData</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">aTokenName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">aTokenSymbol</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_underlyingAssetDecimals</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_interestRateStrategyAddress</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">enableBorrowingOnReserve</span><span class="p">(</span><span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">_stableRateEnabled</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">external</span>
</span></span><span class="line"><span class="cl">    <span class="n">onlyLendingPoolManager</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LendingPoolCore</span> <span class="n">core</span> <span class="o">=</span> <span class="n">LendingPoolCore</span><span class="p">(</span><span class="n">poolAddressesProvider</span><span class="p">.</span><span class="n">getLendingPoolCore</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 直接调用 Core 的可借开关，顺便设置是否允许稳定利率
</span></span></span><span class="line"><span class="cl">    <span class="n">core</span><span class="p">.</span><span class="n">enableBorrowingOnReserve</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="n">_stableRateEnabled</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">emit</span> <span class="n">BorrowingEnabledOnReserve</span><span class="p">(</span><span class="n">_reserve</span><span class="p">,</span> <span class="n">_stableRateEnabled</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">enableReserveAsCollateral</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_baseLTVasCollateral</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_liquidationThreshold</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">_liquidationBonus</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="k">external</span> <span class="n">onlyLendingPoolManager</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LendingPoolCore</span> <span class="n">core</span> <span class="o">=</span> <span class="n">LendingPoolCore</span><span class="p">(</span><span class="n">poolAddressesProvider</span><span class="p">.</span><span class="n">getLendingPoolCore</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">core</span><span class="p">.</span><span class="n">enableReserveAsCollateral</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_baseLTVasCollateral</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_liquidationThreshold</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_liquidationBonus</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 事件中会带出新的 LTV、阈值与清算奖励，方便前端追踪
</span></span></span><span class="line"><span class="cl">    <span class="n">emit</span> <span class="n">ReserveEnabledAsCollateral</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">_reserve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_baseLTVasCollateral</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_liquidationThreshold</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">_liquidationBonus</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    Governance->>Configurator: initReserve(reserve,...)
    Configurator->>LendingPoolCore: initReserve()
    Governance->>Configurator: enableBorrowingOnReserve()
    Configurator->>LendingPoolCore: enableBorrowingOnReserve()
    Governance->>Configurator: enableReserveAsCollateral()
    Configurator->>LendingPoolCore: enableReserveAsCollateral()</pre>
  <pre class="mermaid-dark">sequenceDiagram
    Governance->>Configurator: initReserve(reserve,...)
    Configurator->>LendingPoolCore: initReserve()
    Governance->>Configurator: enableBorrowingOnReserve()
    Configurator->>LendingPoolCore: enableBorrowingOnReserve()
    Governance->>Configurator: enableReserveAsCollateral()
    Configurator->>LendingPoolCore: enableReserveAsCollateral()</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    Governance->>Configurator: initReserve(reserve,...)
    Configurator->>LendingPoolCore: initReserve()
    Governance->>Configurator: enableBorrowingOnReserve()
    Configurator->>LendingPoolCore: enableBorrowingOnReserve()
    Governance->>Configurator: enableReserveAsCollateral()
    Configurator->>LendingPoolCore: enableReserveAsCollateral()</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    Governance->>Configurator: initReserve(reserve,...)
    Configurator->>LendingPoolCore: initReserve()
    Governance->>Configurator: enableBorrowingOnReserve()
    Configurator->>LendingPoolCore: enableBorrowingOnReserve()
    Governance->>Configurator: enableReserveAsCollateral()
    Configurator->>LendingPoolCore: enableReserveAsCollateral()</pre></template>
</div><h3 class="heading-element" id="54-注册表lendingpooladdressesprovider"><span>5.4 注册表：LendingPoolAddressesProvider</span>
  <a href="#54-%e6%b3%a8%e5%86%8c%e8%a1%a8lendingpooladdressesprovider" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li><code>LendingPoolAddressesProvider</code> 是协议的 DNS，所有上层组件在初始化时都会向它拉取地址。<code>setLendingPoolImpl</code>、<code>setLendingPoolCoreImpl</code>、<code>setLendingPoolConfiguratorImpl</code> 等函数内部统一调用 <code>updateImplInternal</code>，使用 <code>InitializableAdminUpgradeabilityProxy</code> 把新实现部署到同一代理地址上，实现平滑升级。</li>
<li>对于不适合走代理的合约（如 <code>LendingPoolLiquidationManager</code> 需要 <code>delegatecall</code>），地址提供者则直接 <code>_setAddress</code>。同时它还统一存储了价格预言机、借贷利率预言机、FeeProvider、TokenDistributor、LendingPoolManager 等治理位置信息。</li>
<li>因为所有组件都依赖这一注册表，升级流程通常是：部署新实现 -&gt; 通过地址提供者设置代理 -&gt; 相关合约在下一次调用时读取到新地址，从而实现模块化演进。</li>
</ul>
<div class="code-block highlight line-nos-hidden" data-mode="classic" data-copyable="true"><div class="code-header language-solidity"><span class="code-title"><i class="arrow fa-solid fa-chevron-down" aria-hidden="true"></i></span><span class="ellipses-btn" aria-label="Show more options" role="button"><i class="fa-solid fa-ellipsis-h" aria-hidden="true"></i></span><span class="line-nos-btn" aria-label="切换行号" role="button" title="切换行号"><i class="fa-solid fa-list-ol" aria-hidden="true"></i></span><span class="line-wrap-btn" aria-label="切换自动换行" role="button" title="切换自动换行"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span><span class="copy-btn" aria-label="复制到剪贴板" role="button" title="复制到剪贴板"><i class="fa-regular fa-clone" aria-hidden="true"></i></span></div><div class="code-wrapper" data-max="10" data-line-digit="2" style="--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1;"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">setLendingPoolImpl</span><span class="p">(</span><span class="kt">address</span> <span class="n">_pool</span><span class="p">)</span> <span class="k">public</span> <span class="n">onlyOwner</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 所有实现升级都统一通过 updateImplInternal，保持代理地址不变
</span></span></span><span class="line"><span class="cl">    <span class="n">updateImplInternal</span><span class="p">(</span><span class="n">LENDING_POOL</span><span class="p">,</span> <span class="n">_pool</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">emit</span> <span class="n">LendingPoolUpdated</span><span class="p">(</span><span class="n">_pool</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">setLendingPoolCoreImpl</span><span class="p">(</span><span class="kt">address</span> <span class="n">_lendingPoolCore</span><span class="p">)</span> <span class="k">public</span> <span class="n">onlyOwner</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">updateImplInternal</span><span class="p">(</span><span class="n">LENDING_POOL_CORE</span><span class="p">,</span> <span class="n">_lendingPoolCore</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">emit</span> <span class="n">LendingPoolCoreUpdated</span><span class="p">(</span><span class="n">_lendingPoolCore</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">setLendingPoolConfiguratorImpl</span><span class="p">(</span><span class="kt">address</span> <span class="n">_configurator</span><span class="p">)</span> <span class="k">public</span> <span class="n">onlyOwner</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">updateImplInternal</span><span class="p">(</span><span class="n">LENDING_POOL_CONFIGURATOR</span><span class="p">,</span> <span class="n">_configurator</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">emit</span> <span class="n">LendingPoolConfiguratorUpdated</span><span class="p">(</span><span class="n">_configurator</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">updateImplInternal</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">_id</span><span class="p">,</span> <span class="kt">address</span> <span class="n">_newAddress</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="k">payable</span> <span class="n">proxyAddress</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="kt">uint160</span><span class="p">(</span><span class="n">getAddress</span><span class="p">(</span><span class="n">_id</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="n">InitializableAdminUpgradeabilityProxy</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">InitializableAdminUpgradeabilityProxy</span><span class="p">(</span><span class="n">proxyAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">params</span> <span class="o">=</span> <span class="nb">abi</span><span class="p">.</span><span class="nb">encodeWithSignature</span><span class="p">(</span><span class="s">&#34;initialize(address)&#34;</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">proxyAddress</span> <span class="o">==</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 首次设置时直接部署新的代理，并把实现与 admin 指向当前 provider
</span></span></span><span class="line"><span class="cl">        <span class="n">proxy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitializableAdminUpgradeabilityProxy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">proxy</span><span class="p">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">_newAddress</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_setAddress</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="n">proxy</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">ProxyCreated</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="n">proxy</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 已存在则直接调用 upgradeToAndCall 完成滚动升级
</span></span></span><span class="line"><span class="cl">        <span class="n">proxy</span><span class="p">.</span><span class="n">upgradeToAndCall</span><span class="p">(</span><span class="n">_newAddress</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="code-expand-btn" aria-label="展开或折叠代码块" role="button"><i class="fa-solid fa-angles-down" aria-hidden="true"></i></div></div><div class="diagram-container">
  <pre class="mermaid">sequenceDiagram
    Governance->>AddressesProvider: setLendingPoolImpl(newImpl)
    AddressesProvider->>Proxy: updateImplInternal()
    Proxy-->>Governance: ProxyCreated/upgrade event
    LendingPool->>AddressesProvider: getLendingPoolCore()
    AddressesProvider-->>LendingPool: proxy address</pre>
  <pre class="mermaid-dark">sequenceDiagram
    Governance->>AddressesProvider: setLendingPoolImpl(newImpl)
    AddressesProvider->>Proxy: updateImplInternal()
    Proxy-->>Governance: ProxyCreated/upgrade event
    LendingPool->>AddressesProvider: getLendingPoolCore()
    AddressesProvider-->>LendingPool: proxy address</pre>
  <pre class="mermaid-neutral">sequenceDiagram
    Governance->>AddressesProvider: setLendingPoolImpl(newImpl)
    AddressesProvider->>Proxy: updateImplInternal()
    Proxy-->>Governance: ProxyCreated/upgrade event
    LendingPool->>AddressesProvider: getLendingPoolCore()
    AddressesProvider-->>LendingPool: proxy address</pre><div class="diagram-copy-btn" aria-label="Copy Mermaid code" role="button"><i class="fa-regular fa-clone fa-width-auto" aria-hidden="true"></i></div>
<template><pre>sequenceDiagram
    Governance->>AddressesProvider: setLendingPoolImpl(newImpl)
    AddressesProvider->>Proxy: updateImplInternal()
    Proxy-->>Governance: ProxyCreated/upgrade event
    LendingPool->>AddressesProvider: getLendingPoolCore()
    AddressesProvider-->>LendingPool: proxy address</pre></template>
</div></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod"><span title="更新于 2026-01-20 00:00:00">更新于 2026-01-20&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="分享到 X" data-sharer="twitter" data-url="https://nesl42.github.io/posts/202601-aavev1source/" data-title="AAVE V1 源码阅读" data-hashtags="论文阅读"><i class="fa-brands fa-x-twitter" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://nesl42.github.io/posts/202601-aavev1source/" data-hashtag="论文阅读"><i class="fa-brands fa-facebook-square" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://nesl42.github.io/posts/202601-aavev1source/" data-title="AAVE V1 源码阅读"><i class="fa-brands fa-weibo" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags me-1" aria-hidden="true"></i><a href="/tags/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/" class="post-tag" title="标签 - 论文阅读">论文阅读</a></section>
    <section><span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/202601-aavev1/" class="post-nav-item" rel="prev" title="AAVE V1 白皮书阅读"><i class="fa-solid fa-angle-left" aria-hidden="true"></i>AAVE V1 白皮书阅读</a><a href="/posts/202601-paper1/" class="post-nav-item" rel="next" title="论文阅读《中国市场的盈余公告：隔夜与日内收益差异》">论文阅读《中国市场的盈余公告：隔夜与日内收益差异》<i class="fa-solid fa-angle-right" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside><dialog id="toc-dialog" aria-labelledby="toc-dialog-title" role="dialog">
      <div class="toc">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content" id="toc-content-drawer"><nav >
  <ul>
    <li><a href="#1-架构鸟瞰birds-eye-view">1 架构鸟瞰（Bird&rsquo;s-eye View）</a>
      <ul>
        <li><a href="#11-用户入口与门面层">1.1 用户入口与门面层</a></li>
        <li><a href="#12-状态与估值层">1.2 状态与估值层</a></li>
        <li><a href="#13-策略治理与注册表">1.3 策略、治理与注册表</a></li>
      </ul>
    </li>
    <li><a href="#2-lendingpool入口逻辑">2 LendingPool：入口逻辑</a>
      <ul>
        <li><a href="#21-deposit">2.1 <code>deposit</code></a></li>
        <li><a href="#22-borrow">2.2 <code>borrow</code></a></li>
        <li><a href="#23-repay">2.3 <code>repay</code></a></li>
        <li><a href="#24-flashloan">2.4 <code>flashLoan</code></a></li>
        <li><a href="#25-liquidationcall">2.5 <code>liquidationCall</code></a></li>
      </ul>
    </li>
    <li><a href="#3-lendingpoolcore资金与索引">3 LendingPoolCore：资金与索引</a>
      <ul>
        <li><a href="#31-状态结构reservedata-与-userreservedata">3.1 状态结构：ReserveData 与 UserReserveData</a></li>
        <li><a href="#32-惰性计息与状态刷新">3.2 惰性计息与状态刷新</a></li>
        <li><a href="#33-资金入口与费用路径">3.3 资金入口与费用路径</a></li>
        <li><a href="#34-利用率-白皮书-123--getreserveutilizationrate">3.4 利用率 ：白皮书 §1.2.3 ↔ <code>getReserveUtilizationRate</code></a></li>
        <li><a href="#35-指数体系白皮书-128-的链上实现">3.5 指数体系：白皮书 §1.2.8 的链上实现</a></li>
        <li><a href="#36-利率刷新白皮书-124127--defaultreserveinterestratestrategy">3.6 利率刷新：白皮书 §1.2.4/§1.2.7 ↔ <code>DefaultReserveInterestRateStrategy</code></a></li>
        <li><a href="#37-数据出口与抵押开关">3.7 数据出口与抵押开关</a></li>
      </ul>
    </li>
    <li><a href="#4-atoken-与-dataprovider凭证与估值">4 AToken 与 DataProvider：凭证与估值</a>
      <ul>
        <li><a href="#41-atoken-的指数余额模型">4.1 aToken 的指数余额模型</a></li>
        <li><a href="#42-健康因子--与-dataprovider白皮书-111210">4.2 健康因子  与 DataProvider：白皮书 §1.1/§1.2.10</a></li>
        <li><a href="#43-清算二次校验balancedecreaseallowed-与-liquidationcall">4.3 清算二次校验：<code>balanceDecreaseAllowed</code> 与 <code>liquidationCall</code></a></li>
        <li><a href="#44-转账与利息重定向延续原笔记">4.4 转账与利息重定向（延续原笔记）</a></li>
        <li><a href="#5-数学底座wadraymath-与利率分段策略">5 数学底座：WadRayMath 与利率分段策略</a>
          <ul>
            <li><a href="#51-wadray-精度白皮书-128-的数值基础">5.1 Wad/Ray 精度：白皮书 §1.2.8 的数值基础</a></li>
            <li><a href="#52-分段利率策略再访">5.2 分段利率策略再访</a></li>
          </ul>
        </li>
        <li><a href="#43-lendingpooldataprovider-的聚合视图">4.3 LendingPoolDataProvider 的聚合视图</a></li>
      </ul>
    </li>
    <li><a href="#5-策略与治理模块">5 策略与治理模块</a>
      <ul>
        <li><a href="#51-利率策略defaultreserveinterestratestrategy">5.1 利率策略：DefaultReserveInterestRateStrategy</a></li>
        <li><a href="#52-费用与参数提供者">5.2 费用与参数提供者</a></li>
        <li><a href="#53-配置器lendingpoolconfigurator">5.3 配置器：LendingPoolConfigurator</a></li>
        <li><a href="#54-注册表lendingpooladdressesprovider">5.4 注册表：LendingPoolAddressesProvider</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div>
    </dialog></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.154.5"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.4.3-20260123080729-2a5bd268"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2026</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons"><div class="fixed-button back-to-top animate__faster d-none" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up" aria-hidden="true"></i></div><div id="toc-drawer-button" class="fixed-button toc-drawer-button d-none" role="button" aria-label="目录"><i class="fa-solid fa-bars" aria-hidden="true"></i></div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">该网站在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/js/config/a1ef0d0305ff74899cc1531a86fcac7a.js" defer></script><script src="/js/lib/mermaid.min.js" type="module"></script><script src="/js/theme.min.js" defer></script></body>
</html>
