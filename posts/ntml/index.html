<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>NTLM认证 - 敬渊&#39;s Blog</title><meta name="author" content="">
<meta name="description" content="[toc]
NTLM的东西在github之前写过，但是不够详细，这里重新再过一遍。
NTLM使用在Windows的工作组环境中，而kerberos则使用在域的情况下。
"><meta name="keywords" content='内网'>
  <meta itemprop="name" content="NTLM认证">
  <meta itemprop="description" content="[toc]
NTLM的东西在github之前写过，但是不够详细，这里重新再过一遍。
NTLM使用在Windows的工作组环境中，而kerberos则使用在域的情况下。">
  <meta itemprop="datePublished" content="2022-05-23T00:00:00+00:00">
  <meta itemprop="dateModified" content="2022-05-23T00:00:00+00:00">
  <meta itemprop="wordCount" content="5525">
  <meta itemprop="keywords" content="内网"><meta property="og:url" content="http://localhost:1313/posts/ntml/">
  <meta property="og:site_name" content="敬渊&#39;s Blog">
  <meta property="og:title" content="NTLM认证">
  <meta property="og:description" content="[toc]
NTLM的东西在github之前写过，但是不够详细，这里重新再过一遍。
NTLM使用在Windows的工作组环境中，而kerberos则使用在域的情况下。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-05-23T00:00:00+00:00">
    <meta property="article:modified_time" content="2022-05-23T00:00:00+00:00">
    <meta property="article:tag" content="内网">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="NTLM认证">
  <meta name="twitter:description" content="[toc]
NTLM的东西在github之前写过，但是不够详细，这里重新再过一遍。
NTLM使用在Windows的工作组环境中，而kerberos则使用在域的情况下。">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/posts/ntml/" title="NTLM认证 - 敬渊&#39;s Blog" /><link rel="prev" type="text/html" href="http://localhost:1313/posts/%E5%9F%9F%E5%A7%94%E6%B4%BE/" title="kerberos认证&amp;PAC" /><link rel="next" type="text/html" href="http://localhost:1313/posts/2022-6-29-bypassavdynamics/" title="BypassAVDynamics[译]" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "NTLM认证",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/posts\/ntml\/"
    },"genre": "posts","keywords": "内网","wordcount":  5525 ,
    "url": "http:\/\/localhost:1313\/posts\/ntml\/","datePublished": "2022-05-23T00:00:00+00:00","dateModified": "2022-05-23T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Author"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/">文章</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/">标签</a></li><li class="menu-item">
              <a class="menu-link" href="/about/">关于</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/">分类</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="/posts/">文章</a></li><li class="menu-item"><a class="menu-link" href="/tags/">标签</a></li><li class="menu-item"><a class="menu-link" href="/about/">关于</a></li><li class="menu-item"><a class="menu-link" href="/categories/">分类</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>NTLM认证</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="published on 2022-05-23 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2022-05-23">2022-05-23</time></span>&nbsp;<span title="5525 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 5600 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>12 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#lm-hash--ntlm-hash">LM hash &amp; NTLM hash</a>
          <ul>
            <li><a href="#lm-hash">LM Hash</a></li>
            <li><a href="#ntlm-hash">NTLM Hash</a></li>
          </ul>
        </li>
        <li><a href="#ntlm身份认证">NTLM身份认证</a>
          <ul>
            <li><a href="#本地认证">本地认证</a></li>
            <li><a href="#网络认证">网络认证</a></li>
            <li><a href="#三个过程">三个过程</a>
              <ul>
                <li><a href="#协商type1">协商type1</a></li>
                <li><a href="#质询type2">质询type2</a></li>
                <li><a href="#身份验证type3">身份验证type3</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#ntlm-v1v2协议">NTLM v1/v2协议</a>
          <ul>
            <li><a href="#ntlm与ntlm-v1v2与net-ntlm-v1v2区别">NTLM与NTLM v1/v2与Net NTLM v1/v2区别</a></li>
            <li><a href="#ntlm-v1v2">NTLM v1/v2</a></li>
            <li><a href="#response提取ntlm-v2">Response提取NTLM v2</a></li>
          </ul>
        </li>
        <li><a href="#ssp-sspi">SSP &amp;SSPI</a></li>
        <li><a href="#引用">引用</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>[toc]</p>
<p>NTLM的东西在github之前写过，但是不够详细，这里重新再过一遍。</p>
<p>NTLM使用在Windows的工作组环境中，而kerberos则使用在域的情况下。</p>
<h2 id="lm-hash--ntlm-hash" class="heading-element"><span>LM hash &amp; NTLM hash</span>
  <a href="#lm-hash--ntlm-hash" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>在写NTLM认证之前先写下LM和NTLM。</p>
<p>hash密码格式：</p>
<pre tabindex="0"><code>Administrator:500:AAD3B435B51404EEAAD3B435B51404EE:31D6CFE0D16AE931B73C59D7E0C089C0:::
用户名:SID:LM-Hash:NTML-Hash:::</code></pre><h3 id="lm-hash" class="heading-element"><span>LM Hash</span>
  <a href="#lm-hash" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>全称LAN Manager Hash, windows最早使用的加密算法。</p>
<p>LM Hash计算步骤：</p>
<ol>
<li>密码全部转换为大写，转换为16进制，14字节，不足用0补全。</li>
<li>分成两个7字节，每部分为56bit</li>
<li>每7bit分组，在后面加一个0bit，即每组8bit</li>
<li>上述两组，使用DES分别加密，key为：<code>KGS!@#$%</code></li>
<li>完成后，两组拼接，得到LM Hash</li>
</ol>
<p>代码实现：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">##coding=utf-8</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">binascii</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyDes</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">DesEncrypt</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Des_Key</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">k</span> <span class="o">=</span> <span class="n">des</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">a2b_hex</span><span class="p">(</span><span class="n">Des_Key</span><span class="p">),</span> <span class="n">ECB</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">EncryptStr</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">EncryptStr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">group_just</span><span class="p">(</span><span class="n">length</span><span class="p">,</span><span class="n">text</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># text 00110001001100100011001100110100001101010011011000000000</span>
</span></span><span class="line"><span class="cl">    <span class="n">text_area</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.{</span><span class="si">%d</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">),</span> <span class="n">text</span><span class="p">)</span> <span class="c1"># [&#39;0011000&#39;, &#39;1001100&#39;, &#39;1000110&#39;, &#39;0110011&#39;, &#39;0100001&#39;, &#39;1010100&#39;, &#39;1101100&#39;, &#39;0000000&#39;]</span>
</span></span><span class="line"><span class="cl">    <span class="n">text_area_padding</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="s1">&#39;0&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">text_area</span><span class="p">]</span> <span class="c1">#[&#39;00110000&#39;, &#39;10011000&#39;, &#39;10001100&#39;, &#39;01100110&#39;, &#39;01000010&#39;, &#39;10101000&#39;, &#39;11011000&#39;, &#39;00000000&#39;]</span>
</span></span><span class="line"><span class="cl">    <span class="n">hex_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text_area_padding</span><span class="p">)</span> <span class="c1"># 0011000010011000100011000110011001000010101010001101100000000000</span>
</span></span><span class="line"><span class="cl">    <span class="n">hex_int</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hex_str</span><span class="p">,</span> <span class="mi">2</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&#34;L&#34;</span><span class="p">)</span> <span class="c1">#30988c6642a8d800</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">hex_int</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">hex_int</span> <span class="o">=</span> <span class="s1">&#39;0000000000000000&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">hex_int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">lm_hash</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 1. 用户的密码转换为大写，密码转换为16进制字符串，不足14字节将会用0来再后面补全。</span>
</span></span><span class="line"><span class="cl">    <span class="n">pass_hex</span> <span class="o">=</span> <span class="n">password</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;hex&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="c1">#3132333435360000000000000000</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">pass_hex</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="c1"># 2. 密码的16进制字符串被分成两个7byte部分。每部分转换成比特流，并且长度位56bit，长度不足使用0在左边补齐长度</span>
</span></span><span class="line"><span class="cl">    <span class="n">left_str</span> <span class="o">=</span> <span class="n">pass_hex</span><span class="p">[:</span><span class="mi">14</span><span class="p">]</span> <span class="c1">#31323334353600</span>
</span></span><span class="line"><span class="cl">    <span class="n">right_str</span> <span class="o">=</span> <span class="n">pass_hex</span><span class="p">[</span><span class="mi">14</span><span class="p">:]</span> <span class="c1">#00000000000000</span>
</span></span><span class="line"><span class="cl">    <span class="n">left_stream</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">left_str</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0b&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">56</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="c1"># 00110001001100100011001100110100001101010011011000000000</span>
</span></span><span class="line"><span class="cl">    <span class="n">right_stream</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">right_str</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0b&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">56</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="c1"># 00000000000000000000000000000000000000000000000000000000</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 3. 再分7bit为一组,每组末尾加0，再组成一组</span>
</span></span><span class="line"><span class="cl">    <span class="n">left_stream</span> <span class="o">=</span> <span class="n">group_just</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="n">left_stream</span><span class="p">)</span> <span class="c1"># 30988c6642a8d800</span>
</span></span><span class="line"><span class="cl">    <span class="n">right_stream</span> <span class="o">=</span> <span class="n">group_just</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="n">right_stream</span><span class="p">)</span> <span class="c1"># 0000000000000000</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 4. 上步骤得到的二组，分别作为key 为 &#34;KGS!@#$%&#34;进行DES加密。</span>
</span></span><span class="line"><span class="cl">    <span class="n">left_lm</span> <span class="o">=</span> <span class="n">DesEncrypt</span><span class="p">(</span><span class="s1">&#39;KGS!@#$%&#39;</span><span class="p">,</span><span class="n">left_stream</span><span class="p">)</span> <span class="c1">#44efce164ab921ca</span>
</span></span><span class="line"><span class="cl">    <span class="n">right_lm</span> <span class="o">=</span> <span class="n">DesEncrypt</span><span class="p">(</span><span class="s1">&#39;KGS!@#$%&#39;</span><span class="p">,</span><span class="n">right_stream</span><span class="p">)</span> <span class="c1"># aad3b435b51404ee</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 5. 将加密后的两组拼接在一起，得到最终LM HASH值。</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">left_lm</span> <span class="o">+</span> <span class="n">right_lm</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">hash</span> <span class="o">=</span> <span class="n">lm_hash</span><span class="p">(</span><span class="s2">&#34;aaaaa&#34;</span><span class="p">)</span></span></span></code></pre></div><p>上述LM Hash有一些问题：</p>
<ol>
<li>密码长度不超过14字节</li>
<li>不区分大小写</li>
<li>长度小于7位的话，后半部分唯一确定:<code>aad3b435b51404ee</code></li>
<li>14字节转化为2*7，降低了复杂度，即7字节DES的2倍</li>
<li>DES强度低</li>
<li>key固定</li>
</ol>
<h3 id="ntlm-hash" class="heading-element"><span>NTLM Hash</span>
  <a href="#ntlm-hash" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>为解决上述问题，微软在1993年的Windows NT 3.1引入NTLM Hash，下面为各Windows对LM和NTLM的支持：</p>
<table>
  <thead>
      <tr>
          <th></th>
          <th>2000</th>
          <th>XP</th>
          <th>2003</th>
          <th>Vista</th>
          <th>Win7</th>
          <th>2008</th>
          <th>Win8</th>
          <th>2012</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>LM</td>
          <td>√</td>
          <td>√</td>
          <td>√</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>NTLM</td>
          <td>√</td>
          <td>√</td>
          <td>√</td>
          <td>√</td>
          <td>√</td>
          <td>√</td>
          <td>√</td>
          <td>√</td>
      </tr>
  </tbody>
</table>
<p>其中，在Win 2000/XP/2003中，长度不超过14的话，依旧使用LM，超过的话使用NTLM。</p>
<p>在Vista开始，默认只存储NTLM Hash，不存LM Hash(LM Hash固定<code>AAD3B435B51404EEAAD3B435B51404EE</code>，NULL之后运算的结果)，有些工具的格式固定，需要填写LM Hash，0填充即可。LM Hash的位置依旧存在，只不过没有价值。</p>
<p>NTLM Hash计算步骤：</p>
<ol>
<li>转16进制</li>
<li>Unicode编码，就是加00</li>
<li>使用MD4对Unicode进行hash</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;import hashlib,binascii; print binascii.hexlify(hashlib.new(&#34;md4&#34;, &#34;p@Assword!123&#34;.encode(&#34;utf-16le&#34;)).digest())&#39;</span></span></span></code></pre></div><h2 id="ntlm身份认证" class="heading-element"><span>NTLM身份认证</span>
  <a href="#ntlm%e8%ba%ab%e4%bb%bd%e8%ae%a4%e8%af%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>分为本地认证和网络认证</p>
<h3 id="本地认证" class="heading-element"><span>本地认证</span>
  <a href="#%e6%9c%ac%e5%9c%b0%e8%ae%a4%e8%af%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Windows在保存密码的时候，保存的不是密码的明文，而是密码的hash。</p>
<p>保存的位置：<code>%SystemRoot%\system32\config\sam</code></p>
<p>SAM文件中保留了计算机本地所有用户的凭证信息，可以理解为是一个数据库</p>
<p><img loading="lazy" src='/posts/ntml/image-20220523145537700.png' alt="image-20220523145537700" height="543" width="808"></p>
<p>当登陆的时候，系统读SAM文件中内容与输入的比较，相同则认证成功。</p>
<p>认证流程：<code>winlogon.exe --&gt; 用户输入 --&gt; lsass.exe（认证）</code></p>
<p>用户注销、重启、锁屏后，系统会让<code>winlogon.exe</code>显示登陆界面，之后用户输入，得到输入后交给lsass进程，将明文加密为NTLM后，与SAM中的内容进行比较。</p>
<p>lsass：用于微软Windows系统的安全机制，用于本地安全和登陆策略。</p>
<h3 id="网络认证" class="heading-element"><span>网络认证</span>
  <a href="#%e7%bd%91%e7%bb%9c%e8%ae%a4%e8%af%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>上面是本地认证，下面这里来写网络认证。</p>
<p>NTLM是一种网络认证协议，它是基于挑战（Challenge）/响应（Response）认证机制的一种认证模式。这个协议只支持Windows。</p>
<p>由三种消息组成，即三步：</p>
<ol>
<li>协商type1：协商确定协议版本，重要的是用户名</li>
<li>质询type2：挑战/响应起作用的范畴，重要的是challenge，服务端生成</li>
<li>身份验证type3：质询完成后的验证，重要的是response，客户端生成，又称为<code>Net NTLM Hash</code>，用户NTLM Hash计算challenge的结果</li>
</ol>
<p>在工作组中完整流程：</p>
<ol>
<li>
<p>用户名/密码登陆客户端</p>
</li>
<li>
<p>客户端将密码进行hash存储，丢弃密码明文。客户端发送协商消息type1(NEGOTIATE)，包含客户端支持和服务端请求的功能列表，请求还包含用户名、机器以及需要使用的安全服务等信息。</p>
</li>
<li>
<p>服务端使用type2(质询)消息进行响应，包含服务端支持和同意的功能列表。其中最重要的是服务端生成的challenge，即服务端随机生成的16位随机数。</p>
</li>
<li>
<p>客户端收到上述响应后，发送type3(验证)消息。用户收到上述响应后，使用用户NTLM Hash加密challenge，得到response，发送的验证消息包含[response，username，challenge]。</p>
<p>这里NTLM Hash计算challenge的结果在网络协议中成为<code>Net NTLM Hash</code>。</p>
</li>
<li>
<p>服务端拿到type3(验证)消息后，服务端使用用户的NTLM Hash加密challenge，得到response1，将其与客户端发送的response进行比较验证。</p>
</li>
</ol>
<p>上述是在工作组中的流程，下面是在域中的流程，前4步是一样的，只有最后一步不一样，分为两步：</p>
<ol start="5">
<li>服务端拿到type3(验证)消息后，服务端使用用户的NTLM Hash(如果服务端有的话)加密challenge，得到response1，将其与客户端发送的response进行比较验证。如果服务端本地没有该用户NTLM Hash的话，也就计算不了response1，这时服务端使用netlogon协议联系域控，建立好安全通道后，将type1,type2,type3一起发送给域控(这个过程也叫作Pass Through Authentication认证流程)</li>
<li>域控使用challenge和用户NTLM Hash计算并与response比较验证。</li>
</ol>
<h3 id="三个过程" class="heading-element"><span>三个过程</span>
  <a href="#%e4%b8%89%e4%b8%aa%e8%bf%87%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="协商type1" class="heading-element"><span>协商type1</span>
  <a href="#%e5%8d%8f%e5%95%86type1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>每个字段的含义见微软文档：https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/b34032e5-3aae-4bc6-84c3-c6d80eadf7f2</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">字段</th>
          <th style="text-align: left">含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Signature</td>
          <td style="text-align: left">签名，一个 8 字节字符数组，必须包含 ASCII 字符串（&lsquo;N&rsquo;、&lsquo;T&rsquo;、&lsquo;L&rsquo;、&lsquo;M&rsquo;、&lsquo;S&rsquo;、&lsquo;S&rsquo;、&lsquo;P&rsquo;、&rsquo;\0 &lsquo;）</td>
      </tr>
      <tr>
          <td style="text-align: left">MessageType</td>
          <td style="text-align: left">消息类型，必须为0x00000001</td>
      </tr>
      <tr>
          <td style="text-align: left">NegotiateFlags</td>
          <td style="text-align: left">包含一组<strong>NEGOTIATE</strong>结构</td>
      </tr>
      <tr>
          <td style="text-align: left">DomainNameFields</td>
          <td style="text-align: left">包含域名信息字段。</td>
      </tr>
      <tr>
          <td style="text-align: left">WorkstationFields</td>
          <td style="text-align: left">包含<strong>WorkstationName</strong>信息字段</td>
      </tr>
      <tr>
          <td style="text-align: left">Version</td>
          <td style="text-align: left">版本</td>
      </tr>
      <tr>
          <td style="text-align: left">Payload (variable)</td>
          <td style="text-align: left"></td>
      </tr>
  </tbody>
</table>
<h4 id="质询type2" class="heading-element"><span>质询type2</span>
  <a href="#%e8%b4%a8%e8%af%a2type2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>详细字段信息见微软文档：https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/801a4681-8809-4be9-ab0d-61dcfe762786</p>
<p>质询的信息重要的就是服务端产生的challenge</p>
<table>
  <thead>
      <tr>
          <th>字段</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Signature</td>
          <td>签名，同上</td>
      </tr>
      <tr>
          <td>MessageType</td>
          <td>消息类型，必须为0x00000002</td>
      </tr>
      <tr>
          <td>TargetNameFields</td>
          <td>包含<strong>TargetName</strong>信息的字段</td>
      </tr>
      <tr>
          <td>NegotiateFlags</td>
          <td>包含一组<strong>NEGOTIATE</strong>结构</td>
      </tr>
      <tr>
          <td>ServerChallenge</td>
          <td>包含NTLM质询的8字节</td>
      </tr>
      <tr>
          <td>Reserved</td>
          <td>一个 8 字节数组，其元素在发送时必须为零，并且在接收时必须被忽略。</td>
      </tr>
      <tr>
          <td>TargetInfoFields</td>
          <td>包含<strong>TargetInfo</strong>信息的字段</td>
      </tr>
      <tr>
          <td>Version</td>
          <td>版本</td>
      </tr>
      <tr>
          <td>Payload (variable)</td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>示例：</p>
<p><img loading="lazy" src='/posts/ntml/t017f0ae4b36b11e5ae.png' alt="img" height="828" width="1734"></p>
<h4 id="身份验证type3" class="heading-element"><span>身份验证type3</span>
  <a href="#%e8%ba%ab%e4%bb%bd%e9%aa%8c%e8%af%81type3" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>详细字段信息见微软文档：https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/033d32cc-88f9-4483-9bf2-b273055038ce</p>
<table>
  <thead>
      <tr>
          <th>字段</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Signature</td>
          <td>签名，同上</td>
      </tr>
      <tr>
          <td>MessageType</td>
          <td>消息类型，必须为0x00000003</td>
      </tr>
      <tr>
          <td>LmChallengeResponseFields</td>
          <td>包含<strong>LmChallengeResponse</strong>信息的字段</td>
      </tr>
      <tr>
          <td>NtChallengeResponseFields</td>
          <td>包含<strong>NtChallengeResponse</strong>信息的字段</td>
      </tr>
      <tr>
          <td>DomainNameFields</td>
          <td>包含<strong>DomainName</strong>信息的字段</td>
      </tr>
      <tr>
          <td>UserNameFields</td>
          <td>包含<strong>UserName</strong> 信息的字段</td>
      </tr>
      <tr>
          <td>WorkstationFields</td>
          <td>包含<strong>Workstation</strong>信息的字段</td>
      </tr>
      <tr>
          <td>EncryptedRandomSessionKeyFields</td>
          <td>包含<strong>EncryptedRandomSessionKey</strong>信息的字段</td>
      </tr>
      <tr>
          <td>NegotiateFlags</td>
          <td></td>
      </tr>
      <tr>
          <td>Version</td>
          <td></td>
      </tr>
      <tr>
          <td>MIC (16 bytes)</td>
          <td>NTLM NEGOTIATE_MESSAGE、CHALLENGE_MESSAGE 和 AUTHENTICATE_MESSAGE 的消息完整性</td>
      </tr>
      <tr>
          <td>Payload (variable)</td>
          <td></td>
      </tr>
  </tbody>
</table>
<h2 id="ntlm-v1v2协议" class="heading-element"><span>NTLM v1/v2协议</span>
  <a href="#ntlm-v1v2%e5%8d%8f%e8%ae%ae" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="ntlm与ntlm-v1v2与net-ntlm-v1v2区别" class="heading-element"><span>NTLM与NTLM v1/v2与Net NTLM v1/v2区别</span>
  <a href="#ntlm%e4%b8%8entlm-v1v2%e4%b8%8enet-ntlm-v1v2%e5%8c%ba%e5%88%ab" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>首先是NTLM，就是最上面的那个，例子：<code>AAD3B435B51404EEAAD3B435B51404EE:31D6CFE0D16AE931B73C59D7E0C089C0</code></p>
<p>而<code>NTLM v1/v2</code>与NTLM不一样，<code>NTLM v1/v2</code>是<code>Net NTLM v1/v2</code>的缩写，也就是说他俩才是一回事。Net NTLM用于网络身份验证，就是上面那个challenge/response认证的那个，下面举个NTLM v2的例子，来源<a href="https://hashcat.net/wiki/doku.php?id=example_hashes"target="_blank" rel="external nofollow noopener noreferrer">hashcat</a>：</p>
<pre tabindex="0"><code>admin::N46iSNekpT:08ca45b7d7ea58ee:88dcbe4446168966a153a0064958dac6:5c7830315c7830310000000000000b45c67103d07d7b95acd12ffa11230e0000000052920b85f78d013c31cdb3b92f5d765c783030 </code></pre><h3 id="ntlm-v1v2" class="heading-element"><span>NTLM v1/v2</span>
  <a href="#ntlm-v1v2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>NTLM v2是在Windows NT4.0 SP4中引入的，与NTLM v1的区别是challenge和hash算法不同，相同点是使用的都是NTLM Hash</p>
<ul>
<li>challenge
<ul>
<li>NTLM v1：8byte</li>
<li>NTLM v2：16byte</li>
</ul>
</li>
<li>Net NTLM Hash
<ul>
<li>v1：DES</li>
<li>v2：HMAC-MD5</li>
</ul>
</li>
</ul>
<p>NTLM  v1格式：</p>
<pre tabindex="0"><code>username::hostname:LM response:NTLM response:challenge</code></pre><p>NTML v2格式：</p>
<pre tabindex="0"><code>username::domain:challenge:HMAC-MD5:blob</code></pre><pre tabindex="0"><code>## NTLM

C = 8-byte server challenge, random
K1 | K2 | K3 = NTLM-Hash | 5-bytes-0
response = DES(K1,C) | DES(K2,C) | DES(K3,C)</code></pre><pre tabindex="0"><code>## NTLM v2

SC = 8-byte server challenge, random
CC = 8-byte client challenge, random
CC* = (X, time, CC2, domain name)
v2-Hash = HMAC-MD5(NT-Hash, user name, domain name)
LMv2 = HMAC-MD5(v2-Hash, SC, CC)
NTv2 = HMAC-MD5(v2-Hash, SC, CC*)
response = LMv2 | CC | NTv2 | CC*</code></pre><h3 id="response提取ntlm-v2" class="heading-element"><span>Response提取NTLM v2</span>
  <a href="#response%e6%8f%90%e5%8f%96ntlm-v2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>这里就不搭建了，使用的<a href="https://3gstudent.github.io/Windows%E4%B8%8B%E7%9A%84%E5%AF%86%E7%A0%81hash-NTLM-hash%E5%92%8CNet-NTLM-hash%E4%BB%8B%E7%BB%8D"target="_blank" rel="external nofollow noopener noreferrer">3gstudent师傅</a></p>
<pre tabindex="0"><code>Server
	IP:192.168.62.139
	username:a
	password:test123
Client
	IP:192.168.62.130</code></pre><p>客户端连接服务端：</p>
<p><code>net use \\192.168.52.139 /u:a test123</code></p>
<p>抓包：</p>
<p><img loading="lazy" src='/posts/ntml/2-3.png' alt="Alt text" height="177" width="950"></p>
<p>前4个对应的就是NTLM认证的几个步骤，第二个查看数据包，其中的challenge：<code>c0b5429111f9c5f4</code></p>
<p><img loading="lazy" src='/posts/ntml/2-4.png' alt="Alt text" height="374" width="953"></p>
<p>查看第三个数据包得到客户端加密的challenge：</p>
<pre tabindex="0"><code>challenge:a9134eee81ca25de

response:a5f1c47844e5b3b9c6f67736a2e1916d:0101000000000000669dae86ba8bd301a9134eee81ca25de0000000002001e00570049004e002d003100550041004200430047004200470049005500330001001e00570049004e002d003100550041004200430047004200470049005500330004001e00570049004e002d003100550041004200430047004200470049005500330003001e00570049004e002d003100550041004200430047004200470049005500330007000800669dae86ba8bd30106000400020000000800300030000000000000000000000000300000e9d9e613613097d1e2f47c1fd97fa099f65dfd78075d8bdb5ca162492ea5d2990a001000000000000000000000000000000000000900260063006900660073002f003100390032002e003100360038002e00360032002e00310033003900000000000000000000000000</code></pre><p><img loading="lazy" src='/posts/ntml/2-5.png' alt="Alt text" height="403" width="944"></p>
<p>其中NTLM v2格式：</p>
<pre tabindex="0"><code>username::domain:challenge:HMAC-MD5:blob</code></pre><ul>
<li>
<p>domain可由数据包获得</p>
</li>
<li>
<p>HMAC-MD5对应数据包中的NTProofStr，见上图。</p>
</li>
<li>
<p>blob对应数据包中Response去掉NTProofStr的后半部分</p>
</li>
</ul>
<p>完整NTLM v2的数据：</p>
<pre tabindex="0"><code>a::192.168.62.139:c0b5429111f9c5f4:a5f1c47844e5b3b9c6f67736a2e1916d:0101000000000000669dae86ba8bd301a9134eee81ca25de0000000002001e00570049004e002d003100550041004200430047004200470049005500330001001e00570049004e002d003100550041004200430047004200470049005500330004001e00570049004e002d003100550041004200430047004200470049005500330003001e00570049004e002d003100550041004200430047004200470049005500330007000800669dae86ba8bd30106000400020000000800300030000000000000000000000000300000e9d9e613613097d1e2f47c1fd97fa099f65dfd78075d8bdb5ca162492ea5d2990a001000000000000000000000000000000000000900260063006900660073002f003100390032002e003100360038002e00360032002e00310033003900000000000000000000000000</code></pre><p>可以使用Hashcat对该Net-NTLM hash进行破解</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">hashcat -m <span class="m">5600</span> a::192.168.62.139:c0b5429111f9c5f4:a5f1c47844e5b3b9c6f67736a2e1916d:0101000000000000669dae86ba8bd301a9134eee81ca25de0000000002001e00570049004e002d003100550041004200430047004200470049005500330001001e00570049004e002d003100550041004200430047004200470049005500330004001e00570049004e002d003100550041004200430047004200470049005500330003001e00570049004e002d003100550041004200430047004200470049005500330007000800669dae86ba8bd30106000400020000000800300030000000000000000000000000300000e9d9e613613097d1e2f47c1fd97fa099f65dfd78075d8bdb5ca162492ea5d2990a001000000000000000000000000000000000000900260063006900660073002f003100390032002e003100360038002e00360032002e00310033003900000000000000000000000000 /tmp/password.list -o found.txt --force</span></span></code></pre></div><p>参数：</p>
<ul>
<li>-m：hash-type，其中Net NTLM v2对应5600</li>
<li>-o：输出文件</li>
<li>-force：强制执行</li>
</ul>
<h2 id="ssp-sspi" class="heading-element"><span>SSP &amp;SSPI</span>
  <a href="#ssp-sspi" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><img loading="lazy" src='/posts/ntml/6308e85c-09ca-4a40-9c2b-3e310e1f2a69.jpg' alt="img" height="503" width="471"></p>
<p>SSPI(Security Support Provider Interface)：这是 Windows 定义的一套接口，此接口定义了与安全有关的功能函数， 用来获得验证、信息完整性、信息隐私等安全功能，就是定义了一套接口函数用来身份验证，签名等，但是没有具体的实现。</p>
<p>SSP(Security Support Provider)：SSPI 的实现者，对SSPI相关功能函数的具体实现。微软自己实现了如下的 SSP，用于提供安全功能：</p>
<ul>
<li>NTLM SSP ( Challenge/Response 验证机制 )</li>
<li>Kerberos ( 基于 ticket 的身份验证机制 )</li>
<li>Cred SSP (CredSSP 凭据安全支持提供程序 )</li>
<li>Digest SSP (摘要式安全支持提供程序)</li>
<li>Negotiate SSP(协商安全支持提供程序)</li>
<li>Schannel SSP</li>
<li>Negotiate Extensions SSP</li>
<li>PKU2U SSP</li>
</ul>
<p>系统层面，SSP其实就是一个dll，来实现身份验证等安全功能。NTLM是基于Challenge/Response机制，Kerberos是基于ticket的身份验证。所以，我们也可以实现自己的SSP，让系统实现更多的身份验证方法，Mimikatz就自己实现了一个利用SSP机制的记录密码。</p>
<p>抓包的时候可以看到啊NTLMSSp是在GSSAPI下面的。</p>
<blockquote>
<p><strong>因为sspi是gssapi的变体，这里出现gssapi是为了兼容。注册为SSP的好处就是，SSP实现了了与安全有关的功能函数，那上层协议(比如SMB)在进行身份认证等功能的时候，就可以不用考虑协议细节，只需要调用相关的函数即可。而认证过程中的流量嵌入在上层协议里面。不像kerbreos，既可以镶嵌在上层协议里面，也可以作为独立的应用层协议。ntlm是只能镶嵌在上层协议里面，消息的传输依赖于使用ntlm的上层协议。</strong></p></blockquote>
<h2 id="引用" class="heading-element"><span>引用</span>
  <a href="#%e5%bc%95%e7%94%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><blockquote>
<p><a href="https://daiker.gitbook.io/windows-protocol/ntlm-pian/4"target="_blank" rel="external nofollow noopener noreferrer">https://daiker.gitbook.io/windows-protocol/ntlm-pian/4</a></p>
<p><a href="https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html"target="_blank" rel="external nofollow noopener noreferrer">https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html</a></p>
<p><a href="http://davenport.sourceforge.net/ntlm.html"target="_blank" rel="external nofollow noopener noreferrer">http://davenport.sourceforge.net/ntlm.html</a></p>
<p><a href="https://1sparrow.com/2019/12/04/Windows%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/"target="_blank" rel="external nofollow noopener noreferrer">https://1sparrow.com/2019/12/04/Windows%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/</a></p>
<p><a href="https://atsud0.me/2022/03/07/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"target="_blank" rel="external nofollow noopener noreferrer">https://atsud0.me/2022/03/07/%E3%80%90%E5%9F%9F%E6%B8%97%E9%80%8F%E3%80%91%E6%B5%85%E6%B7%A1NTLM-%E5%86%85%E7%BD%91%E5%B0%8F%E7%99%BD%E7%9A%84NTLM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></p></blockquote>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2022-05-23 00:00:00">Updated on 2022-05-23&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on X" data-sharer="twitter" data-url="http://localhost:1313/posts/ntml/" data-title="NTLM认证" data-hashtags="内网"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/ntml/" data-hashtag="内网"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://localhost:1313/posts/ntml/" data-title="NTLM认证"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/%E5%86%85%E7%BD%91/" class="post-tag" title="Tags - 内网">内网</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/%E5%9F%9F%E5%A7%94%E6%B4%BE/" class="post-nav-item" rel="prev" title="Kerberos认证&amp;PAC"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Kerberos认证&amp;PAC</a><a href="/posts/2022-6-29-bypassavdynamics/" class="post-nav-item" rel="next" title="BypassAVDynamics[译]">BypassAVDynamics[译]<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.145.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.17-8212d6fd"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"version":"v0.3.17-8212d6fd"};console.log('Page config:', window.config);</script><script src="/js/theme.min.js" defer></script></body>
</html>
