<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>再战PE结构 - SmallT40&#39;s Blog</title><meta name="author" content="">
<meta name="description" content="[toc]
PE文件结构解析 0.总述 大致结构如下：
"><meta name="keywords" content='RE'>
  <meta itemprop="name" content="再战PE结构">
  <meta itemprop="description" content="[toc]
PE文件结构解析 0.总述 大致结构如下：">
  <meta itemprop="datePublished" content="2021-10-23T00:00:00+00:00">
  <meta itemprop="dateModified" content="2021-10-23T00:00:00+00:00">
  <meta itemprop="wordCount" content="2730">
  <meta itemprop="keywords" content="RE"><meta property="og:url" content="https://nesl42.github.io/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/">
  <meta property="og:site_name" content="SmallT40&#39;s Blog">
  <meta property="og:title" content="再战PE结构">
  <meta property="og:description" content="[toc]
PE文件结构解析 0.总述 大致结构如下：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-10-23T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-10-23T00:00:00+00:00">
    <meta property="article:tag" content="RE">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="再战PE结构">
  <meta name="twitter:description" content="[toc]
PE文件结构解析 0.总述 大致结构如下：">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="https://nesl42.github.io/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/" title="再战PE结构 - SmallT40&#39;s Blog" /><link rel="prev" type="text/html" href="https://nesl42.github.io/posts/tcache_stashing_unlink_atack%E8%B0%83%E8%AF%95/" title="Tcache_stashing_unlink_atack调试记录" /><link rel="next" type="text/html" href="https://nesl42.github.io/posts/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" title="编译原理Note" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "再战PE结构",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/nesl42.github.io\/posts\/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90\/"
    },"genre": "posts","keywords": "RE","wordcount":  2730 ,
    "url": "https:\/\/nesl42.github.io\/posts\/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90\/","datePublished": "2021-10-23T00:00:00+00:00","dateModified": "2021-10-23T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Author"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="SmallT40&#39;s Blog"><span class="header-title-text">SmallT40&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/">文章</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/">标签</a></li><li class="menu-item">
              <a class="menu-link" href="/about/">关于</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/">分类</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="SmallT40&#39;s Blog"><span class="header-title-text">SmallT40&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="/posts/">文章</a></li><li class="menu-item"><a class="menu-link" href="/tags/">标签</a></li><li class="menu-item"><a class="menu-link" href="/about/">关于</a></li><li class="menu-item"><a class="menu-link" href="/categories/">分类</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>再战PE结构</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="published on 2021-10-23 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2021-10-23">2021-10-23</time></span>&nbsp;<span title="2730 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 2800 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>6 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#pe文件结构解析">PE文件结构解析</a>
          <ul>
            <li><a href="#0总述">0.总述</a></li>
            <li><a href="#1dos头">1.DOS头</a></li>
            <li><a href="#2dos存根">2.DOS存根</a></li>
            <li><a href="#4nt头">4.NT头</a></li>
            <li><a href="#5节表">5.节表</a></li>
            <li><a href="#6rva与raw地址转换">6.RVA与RAW地址转换</a></li>
          </ul>
        </li>
        <li><a href="#iat表分析">IAT表分析</a></li>
        <li><a href="#导出表分析">导出表分析</a>
          <ul>
            <li><a href="#示例">示例</a>
              <ul>
                <li><a href="#addressofname">AddressOfName</a></li>
                <li><a href="#addressofnameordinals">AddressOfNameOrdinals</a></li>
                <li><a href="#addressoffunctions">AddressOfFunctions</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#重定位表">重定位表</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>[toc]</p>
<h2 id="pe文件结构解析" class="heading-element"><span>PE文件结构解析</span>
  <a href="#pe%e6%96%87%e4%bb%b6%e7%bb%93%e6%9e%84%e8%a7%a3%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="0总述" class="heading-element"><span>0.总述</span>
  <a href="#0%e6%80%bb%e8%bf%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>大致结构如下：</p>
<ol>
<li>DOS头（占位），仅适用于映像文件</li>
<li>DOS存根（又叫签名），仅适用于映像文件</li>
<li>COFF文件头，适用于映像文件和目标文件</li>
<li>NT（可选文件头），仅适用于映像文件</li>
<li>节表（节区头）</li>
<li>节</li>
</ol>
<p>其中，PE头包含DOS头、DOS存根、NT头、节表。</p>
<p>用到的结构体都在<code>winnt.h</code>头文件中。</p>
<h3 id="1dos头" class="heading-element"><span>1.DOS头</span>
  <a href="#1dos%e5%a4%b4" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Mz那里</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_DOS_HEADER</span> <span class="p">{</span>      <span class="c1">// DOS .EXE header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_magic</span><span class="p">;</span>                     <span class="c1">// Magic number
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_cblp</span><span class="p">;</span>                      <span class="c1">// Bytes on last page of file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_cp</span><span class="p">;</span>                        <span class="c1">// Pages in file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_crlc</span><span class="p">;</span>                      <span class="c1">// Relocations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_cparhdr</span><span class="p">;</span>                   <span class="c1">// Size of header in paragraphs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_minalloc</span><span class="p">;</span>                  <span class="c1">// Minimum extra paragraphs needed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_maxalloc</span><span class="p">;</span>                  <span class="c1">// Maximum extra paragraphs needed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_ss</span><span class="p">;</span>                        <span class="c1">// Initial (relative) SS value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_sp</span><span class="p">;</span>                        <span class="c1">// Initial SP value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_csum</span><span class="p">;</span>                      <span class="c1">// Checksum
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_ip</span><span class="p">;</span>                        <span class="c1">// Initial IP value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_cs</span><span class="p">;</span>                        <span class="c1">// Initial (relative) CS value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_lfarlc</span><span class="p">;</span>                    <span class="c1">// File address of relocation table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_ovno</span><span class="p">;</span>                      <span class="c1">// Overlay number
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>                    <span class="c1">// Reserved words
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_oemid</span><span class="p">;</span>                     <span class="c1">// OEM identifier (for e_oeminfo)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_oeminfo</span><span class="p">;</span>                   <span class="c1">// OEM information; e_oemid specific
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span>   <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>                  <span class="c1">// Reserved words
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LONG</span>   <span class="n">e_lfanew</span><span class="p">;</span>                    <span class="c1">// File address of new exe header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span> <span class="n">IMAGE_DOS_HEADER</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">;</span></span></span></code></pre></div><p>重要的只有最后的：<code>e_lfanew</code>，表示NT头的偏移</p>
<h3 id="2dos存根" class="heading-element"><span>2.DOS存根</span>
  <a href="#2dos%e5%ad%98%e6%a0%b9" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>就是<code>This program cannot be run in DOS mode.</code>那里，</p>
<h3 id="4nt头" class="heading-element"><span>4.NT头</span>
  <a href="#4nt%e5%a4%b4" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>以下为<code>notepad.exe</code>的NT头：</p>
<p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/image-20211019192747065.png' alt="image-20211019192747065" height="706" width="1327"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_NT_HEADERS64</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">IMAGE_OPTIONAL_HEADER64</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">IMAGE_NT_HEADERS64</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_NT_HEADERS64</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">IMAGE_OPTIONAL_HEADER32</span> <span class="n">OptionalHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">IMAGE_NT_HEADERS32</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_NT_HEADERS32</span><span class="p">;</span></span></span></code></pre></div><p>由3部分构成：签名，文件头，可选头</p>
<p>其中Signature就是上面的PE:<code>504B</code>。</p>
<p>下面是文件头<code>IMAGE_FILE_HEADER</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_FILE_HEADER</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">Machine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">NumberOfSections</span><span class="p">;</span> <span class="c1">//节的数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">PointerToSymbolTable</span><span class="p">;</span> <span class="c1">//符号表的文件offset
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">NumberOfSymbols</span><span class="p">;</span>      <span class="c1">//符号表中元素数目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span> <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>  <span class="c1">//指出下面结构体IMAGE_OPTIONAL_HEADER32（32位系统）的长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span> <span class="n">Characteristics</span><span class="p">;</span>       <span class="c1">//标识文件属性，文件是否是可运行形态、是否为DLL等，以bit OR形式进行组合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">IMAGE_FILE_HEADER</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_FILE_HEADER</span><span class="p">;</span></span></span></code></pre></div><p>接下来是可选头：</p>
<p>前几个是标准，后面的是可选</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_OPTIONAL_HEADER</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Standard fields.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">Magic</span><span class="p">;</span> <span class="c1">//32位为0x10B,64位为0x20B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">BYTE</span> <span class="n">MajorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BYTE</span> <span class="n">MinorLinkerVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">SizeOfCode</span><span class="p">;</span>              <span class="c1">//代码节(.test)大小，有多个的话是总和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">SizeOfInitializedData</span><span class="p">;</span>   <span class="c1">//已初始化数据节的大小，有多个的话是总和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">SizeOfUninitializedData</span><span class="p">;</span> <span class="c1">//未初始化数据节的大小，有多个的话是总和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">AddressOfEntryPoint</span><span class="p">;</span>     <span class="c1">//EP的RVA值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">BaseOfCode</span><span class="p">;</span>              <span class="c1">//内存中代码节的开头相对于映像基址的偏移地址。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">BaseOfData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// NT additional fields.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">ImageBase</span><span class="p">;</span>        <span class="c1">//载入内存时优先装载的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">SectionAlignment</span><span class="p">;</span> <span class="c1">//节区在内存中的最小单位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">FileAlignment</span><span class="p">;</span>    <span class="c1">//节区在磁盘文件中的最小单位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">MajorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">MinorImageVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Win32VersionValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">SizeOfImage</span><span class="p">;</span>   <span class="c1">//指定了PE Image在虚拟内存中所占空间的大小，包含所有头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">SizeOfHeaders</span><span class="p">;</span> <span class="c1">//整个PE头的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">CheckSum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">Subsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">DllCharacteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">SizeOfStackReserve</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">SizeOfStackCommit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">SizeOfHeapReserve</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">SizeOfHeapCommit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">LoaderFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>                                            <span class="c1">//下面数组的个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IMAGE_DATA_DIRECTORY</span> <span class="n">DataDirectory</span><span class="p">[</span><span class="n">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span><span class="p">];</span> <span class="c1">//16个
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">IMAGE_OPTIONAL_HEADER32</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_OPTIONAL_HEADER32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_DATA_DIRECTORY</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span> <span class="c1">//表的RVA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">IMAGE_DATA_DIRECTORY</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_DATA_DIRECTORY</span><span class="p">;</span></span></span></code></pre></div><h3 id="5节表" class="heading-element"><span>5.节表</span>
  <a href="#5%e8%8a%82%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_SECTION_HEADER</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BYTE</span> <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span> <span class="c1">//8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">union</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DWORD</span> <span class="n">PhysicalAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">DWORD</span> <span class="n">VirtualSize</span><span class="p">;</span> <span class="c1">//载入内存时此节区的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="n">Misc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span>   <span class="c1">//内存中节区起始地址(RVA)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">SizeOfRawData</span><span class="p">;</span>    <span class="c1">//磁盘中节区所占大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">PointerToRawData</span><span class="p">;</span> <span class="c1">//磁盘中本节对于文件头的距离
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">PointerToRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">PointerToLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">NumberOfRelocations</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">IMAGE_SECTION_HEADER</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_SECTION_HEADER</span><span class="p">;</span></span></span></code></pre></div><h3 id="6rva与raw地址转换" class="heading-element"><span>6.RVA与RAW地址转换</span>
  <a href="#6rva%e4%b8%8eraw%e5%9c%b0%e5%9d%80%e8%bd%ac%e6%8d%a2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><strong>RAW - PointerToRawData = RVA - VirtualAddress</strong></p>
<p><strong>RAW = RVA - VirtualAddress + PointerToRawData</strong></p>
<p>rva = RAW - PointerToRawData + VirtualAddress</p>
<h2 id="iat表分析" class="heading-element"><span>IAT表分析</span>
  <a href="#iat%e8%a1%a8%e5%88%86%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>首先是INT和IAT导入的步骤：</p>
<ol>
<li>读<code>IMAGE_IMPORT_DESCRIPTOR</code>的<code>Name</code>成员获取库名称的字符串(比如&rsquo;kernel32.dll')</li>
<li>装载相应的库，LoadLibrary(&ldquo;kernel32.dll&rdquo;)</li>
<li>读<code>IMAGE_IMPORT_DESCRIPTOR</code>的<code>OriginalFirstThunk</code>成员，获得INT表的地址</li>
<li>逐一获取INT数组的<code>IMAGE_IMPORT_BY_NAME</code>地址</li>
<li>使用<code>IMAGE_IMPORT_BY_NAME</code>的hint或者name项，获取相应函数的起始地址</li>
<li>读<code>IMAGE_IMPORT_DESCRIPTOR</code>的<code>FirstThunk</code>(IAT)，获取IAT的地址</li>
<li>将上面获得的函数地址输入相应的IAT数组值</li>
<li>重复4~7</li>
</ol>
<p>导入表、导入地址表(<code>IMPORT ADDRESS TABLE</code>)，导入表在上面16个数组的第2个。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_DATA_DIRECTORY</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">VirtualAddress</span><span class="p">;</span> <span class="c1">//该表的RVA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">IMAGE_DATA_DIRECTORY</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_DATA_DIRECTORY</span><span class="p">;</span></span></span></code></pre></div><p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/image-20211020202318348.png' alt="image-20211020202318348" height="336" width="724"></p>
<p>可以看出导入表的RVA为0x2647C，在.idata段，</p>
<p>那么RAW= 0x2647C - 0x26000 + 0x23200 =0x2367C</p>
<p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/image-20211021075308064.png' alt="image-20211021075308064" height="280" width="1032"></p>
<p>有多少导入的库就有多少<code>IMAGE_IMPORT_DESCRIPTOR</code>结构体：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_IMPORT_DESCRIPTOR</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>    <span class="c1">// 0 for terminating null import descriptor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">DWORD</span> <span class="n">OriginalFirstThunk</span><span class="p">;</span> <span class="c1">// INT address(RVA)，数组，指向IMAGE_IMPORT_BY_NAME结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="n">DUMMYUNIONNAME</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">ForwarderChain</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Name</span><span class="p">;</span>       <span class="c1">//library name string address(RVA)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">FirstThunk</span><span class="p">;</span> <span class="c1">//IAT address(RVA)，数组，指向IMAGE_IMPORT_BY_NAME结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">IMAGE_IMPORT_DESCRIPTOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_IMPORT_BY_NAME</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span>    <span class="n">Hint</span><span class="p">;</span><span class="c1">//可能为0，编译器决定，如果不为0，是函数在导出表中的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">CHAR</span>   <span class="n">Name</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">IMAGE_IMPORT_BY_NAME</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_IMPORT_BY_NAME</span><span class="p">;</span></span></span></code></pre></div><p>程序加载前IAT和INT都之指向同一个位置。</p>
<p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/SouthEast.png' alt="这里写图片描述" height="632" width="1392"></p>
<p>每个库只有一个<code>IMAGE_IMPORT_DESCRIPTOR</code>，但是每个该结构体的<code>INT(OriginalFirstThunk)</code>和<code>IAT(FirstThunk)</code>为数组，表示该库所有导入的API的地址:</p>
<p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/image-20211021075648706.png' alt="image-20211021075648706" height="228" width="931"></p>
<p>INT的RAW= 0x26700 -  0x26000 + 0x23200  = 0x23900</p>
<p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/image-20211021080941861.png' alt="image-20211021080941861" height="292" width="832"></p>
<p>上面都是需要导入的INT的<code>IMAGE_IMPORT_BY_NAME</code>的地址，比如第一个0x26D3C:</p>
<p>RAW= 0x26D3C-  0x26000 + 0x23200 =0x23F3C</p>
<p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/image-20211021081249113.png' alt="image-20211021081249113" height="413" width="915"></p>
<p>INT就是上面那样，IAT也是如此</p>
<p>上面都是导入前，导入后INT不变，IAT为函数的地址：</p>
<p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/SouthEast.png' alt="这里写图片描述" height="632" width="1392"></p>
<h2 id="导出表分析" class="heading-element"><span>导出表分析</span>
  <a href="#%e5%af%bc%e5%87%ba%e8%a1%a8%e5%88%86%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>在上面16个数组的第一个，这里拿kernel32.dll来测试（notepad没有导出表</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_EXPORT_DIRECTORY</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Characteristics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">TimeDateStamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">MajorVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">MinorVersion</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Name</span><span class="p">;</span>                  <span class="c1">//要导出的名字的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">Base</span><span class="p">;</span>                  <span class="c1">//oridinal base
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">NumberOfFunctions</span><span class="p">;</span>     <span class="c1">//实际导出函数个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">NumberOfNames</span><span class="p">;</span>         <span class="c1">//导出函数中有名字的个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">AddressOfFunctions</span><span class="p">;</span>    <span class="c1">//导出函数的地址(数组，RVA，元素个数=NumberOfFunctions )
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">AddressOfNames</span><span class="p">;</span>        <span class="c1">//导出函数的名称的地址(数组，RVA，元素个数=NumberOfNames)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">AddressOfNameOrdinals</span><span class="p">;</span> <span class="c1">//导出函数序号表的地址(数组，RVA，元素个数=NumberOfNames)，函数序号表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">IMAGE_EXPORT_DIRECTORY</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_EXPORT_DIRECTORY</span><span class="p">;</span></span></span></code></pre></div><p>获得函数地址的API为：<code>GetProcAddress</code>，原理：</p>
<blockquote>
<ol>
<li>利用adressofname转到函数名称的数组</li>
<li>上面的数组存着的是地址，通过strcmp，查到指定的函数名，这时索引记为name_index</li>
<li>用addressofnameordinals转到ordinal数组，</li>
<li>通过name_index查找相应index值</li>
<li>利用addressoffunction转到 函数地址数组</li>
<li>用ordinal找到需要函数的地址。</li>
</ol></blockquote>
<p>图胜千言</p>
<p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/1586953-20200217214947470-1447184500.png' alt="img" height="362" width="654"></p>
<p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/779730_7HXD6CYRBH5QTP4.jpg' alt="eat3" height="1062" width="1094"></p>
<p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/SouthEast.png' alt="img" height="632" width="1392"></p>
<h3 id="示例" class="heading-element"><span>示例</span>
  <a href="#%e7%a4%ba%e4%be%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>下面实际找一下，使用kernel32.dll，找AddConsoleAlisaA函数：</p>
<p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/image-20211102123648075.png' alt="image-20211102123648075" height="503" width="1405"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nl">AddressOfFunctions</span> <span class="p">:</span>   <span class="n">RVA</span> <span class="o">=</span> <span class="mh">0x2654</span>  <span class="n">FOA</span> <span class="o">=</span> <span class="mh">0x1A54</span>
</span></span><span class="line"><span class="cl"><span class="nl">AddressOfNames</span><span class="p">:</span>        <span class="n">RVA</span> <span class="o">=</span> <span class="mh">0x3538</span>  <span class="n">FOA</span> <span class="o">=</span> <span class="mh">0x2938</span>
</span></span><span class="line"><span class="cl"><span class="nl">AddressOfNameOrdinals</span><span class="p">:</span> <span class="n">RVA</span> <span class="o">=</span> <span class="mh">0x441C</span>  <span class="n">FOA</span> <span class="o">=</span> <span class="mh">0x381C</span></span></span></code></pre></div><h4 id="addressofname" class="heading-element"><span>AddressOfName</span>
  <a href="#addressofname" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>是一个个的RVA，个数为0x953，经过转换，FOA = 0x2938：</p>
<p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/image-20211102123953820.png' alt="image-20211102123953820" height="302" width="745"></p>
<p>RVA = 4B9B ==&gt; FOA = 3F9B ：</p>
<p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/image-20211102124237902.png' alt="image-20211102124237902" height="282" width="751"></p>
<p>是第4个，索引为3，</p>
<h4 id="addressofnameordinals" class="heading-element"><span>AddressOfNameOrdinals</span>
  <a href="#addressofnameordinals" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/image-20211102124406631.png' alt="image-20211102124406631" height="232" width="735"></p>
<p>索引和值是一样的，也是第4个，下面查地址：</p>
<h4 id="addressoffunctions" class="heading-element"><span>AddressOfFunctions</span>
  <a href="#addressoffunctions" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/image-20211102124531765.png' alt="image-20211102124531765" height="262" width="751"></p>
<p>第4个是0x071cdf，kernel32.dll的imagebase是0x7c800000，加起来是'0x7c871cdf'</p>
<p><img loading="lazy" src='/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/image-20211102124718782.png' alt="image-20211102124718782" height="252" width="647"></p>
<h2 id="重定位表" class="heading-element"><span>重定位表</span>
  <a href="#%e9%87%8d%e5%ae%9a%e4%bd%8d%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2021-10-23 00:00:00">Updated on 2021-10-23&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on X" data-sharer="twitter" data-url="https://nesl42.github.io/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/" data-title="再战PE结构" data-hashtags="RE"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://nesl42.github.io/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/" data-hashtag="RE"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://nesl42.github.io/posts/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/" data-title="再战PE结构"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/re/" class="post-tag" title="Tags - RE">RE</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/tcache_stashing_unlink_atack%E8%B0%83%E8%AF%95/" class="post-nav-item" rel="prev" title="Tcache_stashing_unlink_atack调试记录"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Tcache_stashing_unlink_atack调试记录</a><a href="/posts/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" class="post-nav-item" rel="next" title="编译原理Note">编译原理Note<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.145.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.17-8212d6fd"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"version":"v0.3.17-8212d6fd"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
