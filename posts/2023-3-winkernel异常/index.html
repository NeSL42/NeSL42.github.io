<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Windows内核(八)——异常 - 敬渊&#39;s Blog</title><meta name="author" content="">
<meta name="description" content="[toc]
01.CPU异常记录 一个异常产生后，首先是要记录异常信息（异常的类型、异常发生的位置等），然后要寻找异常的处理函数，称为异常的分发,最后找到异常处理函数并调用，称为异常处理。
"><meta name="keywords" content='Win32'>
  <meta itemprop="name" content="Windows内核(八)——异常">
  <meta itemprop="description" content="[toc]
01.CPU异常记录 一个异常产生后，首先是要记录异常信息（异常的类型、异常发生的位置等），然后要寻找异常的处理函数，称为异常的分发,最后找到异常处理函数并调用，称为异常处理。">
  <meta itemprop="datePublished" content="2023-03-02T00:00:00+00:00">
  <meta itemprop="dateModified" content="2023-03-02T00:00:00+00:00">
  <meta itemprop="wordCount" content="11859">
  <meta itemprop="keywords" content="Win32"><meta property="og:url" content="https://nesl42.github.io/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/">
  <meta property="og:site_name" content="敬渊&#39;s Blog">
  <meta property="og:title" content="Windows内核(八)——异常">
  <meta property="og:description" content="[toc]
01.CPU异常记录 一个异常产生后，首先是要记录异常信息（异常的类型、异常发生的位置等），然后要寻找异常的处理函数，称为异常的分发,最后找到异常处理函数并调用，称为异常处理。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-03-02T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-03-02T00:00:00+00:00">
    <meta property="article:tag" content="Win32">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Windows内核(八)——异常">
  <meta name="twitter:description" content="[toc]
01.CPU异常记录 一个异常产生后，首先是要记录异常信息（异常的类型、异常发生的位置等），然后要寻找异常的处理函数，称为异常的分发,最后找到异常处理函数并调用，称为异常处理。">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="https://nesl42.github.io/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/" title="Windows内核(八)——异常 - 敬渊&#39;s Blog" /><link rel="prev" type="text/html" href="https://nesl42.github.io/posts/2023-2-winkernelapc/" title="Windows内核(七)——APC机制" /><link rel="next" type="text/html" href="https://nesl42.github.io/posts/2023-3-winkernel%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" title="Windows内核(九)——内存管理" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Windows内核(八)——异常",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/nesl42.github.io\/posts\/2023-3-winkernel%E5%BC%82%E5%B8%B8\/"
    },"genre": "posts","keywords": "Win32","wordcount":  11859 ,
    "url": "https:\/\/nesl42.github.io\/posts\/2023-3-winkernel%E5%BC%82%E5%B8%B8\/","datePublished": "2023-03-02T00:00:00+00:00","dateModified": "2023-03-02T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Author"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/">文章</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/">标签</a></li><li class="menu-item">
              <a class="menu-link" href="/about/">关于</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/">分类</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="/posts/">文章</a></li><li class="menu-item"><a class="menu-link" href="/tags/">标签</a></li><li class="menu-item"><a class="menu-link" href="/about/">关于</a></li><li class="menu-item"><a class="menu-link" href="/categories/">分类</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Windows内核(八)——异常</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="published on 2023-03-02 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-03-02">2023-03-02</time></span>&nbsp;<span title="11859 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 11900 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>24 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#01cpu异常记录">01.CPU异常记录</a>
          <ul>
            <li><a href="#异常处理流程">异常处理流程</a></li>
            <li><a href="#_kitrap00">_KiTrap00</a>
              <ul>
                <li><a href="#commondispatchexception">CommonDispatchException</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#02模拟异常记录">02.模拟异常记录</a>
          <ul>
            <li><a href="#分析模拟异常">分析模拟异常</a></li>
            <li><a href="#cpu异常和软件模拟异常流程">CPU异常和软件模拟异常流程</a></li>
          </ul>
        </li>
        <li><a href="#03内核异常处理流程">03.内核异常处理流程</a>
          <ul>
            <li><a href="#kidispatchexception分析">KiDispatchException分析</a></li>
            <li><a href="#rtldispatchexception分析">RtlDispatchException分析</a></li>
            <li><a href="#总结">总结</a></li>
          </ul>
        </li>
        <li><a href="#04用户异常的分发">04.用户异常的分发</a>
          <ul>
            <li>
              <ul>
                <li><a href="#kidispatchexception">KiDispatchException</a></li>
              </ul>
            </li>
            <li><a href="#小结">小结</a></li>
          </ul>
        </li>
        <li><a href="#05veh">05.VEH</a>
          <ul>
            <li><a href="#处理流程">处理流程</a></li>
            <li><a href="#rtldispatchexception">RtlDispatchException</a></li>
            <li><a href="#_rtlcallvectoredexceptionhandlers">_RtlCallVectoredExceptionHandlers</a></li>
            <li><a href="#veh">VEH</a>
              <ul>
                <li><a href="#自定义veh">自定义VEH</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#06seh">06.SEH</a>
          <ul>
            <li><a href="#kiuserexceptiondispatcher">KiUserExceptionDispatcher</a></li>
            <li><a href="#自定义seh">自定义SEH</a></li>
            <li><a href="#总结-1">总结</a></li>
          </ul>
        </li>
        <li><a href="#07编译器扩展seh">07.编译器扩展SEH</a>
          <ul>
            <li><a href="#编译器支持的seh">编译器支持的SEH</a></li>
            <li><a href="#拓展seh结构体">拓展SEH结构体</a>
              <ul>
                <li><a href="#scopetable">scopetable</a></li>
                <li><a href="#trylevel">trylevel</a></li>
                <li><a href="#_except_handler3执行过程">_except_handler3执行过程</a></li>
              </ul>
            </li>
            <li><a href="#__try__finally">__try__finally</a></li>
          </ul>
        </li>
        <li><a href="#08未处理异常">08.未处理异常</a>
          <ul>
            <li><a href="#入口程序的最后一道防线">入口程序的最后一道防线</a></li>
            <li><a href="#新线程的最后一道防线">新线程的最后一道防线</a></li>
            <li><a href="#unhandledexceptionfilter">UnhandledExceptionFilter</a></li>
            <li><a href="#未处理异常">未处理异常</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>[toc]</p>
<h2 id="01cpu异常记录" class="heading-element"><span>01.CPU异常记录</span>
  <a href="#01cpu%e5%bc%82%e5%b8%b8%e8%ae%b0%e5%bd%95" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>一个异常产生后，首先是要<strong>记录异常信息</strong>（异常的类型、异常发生的位置等），然后要寻找异常的处理函数，称为<strong>异常的分发</strong>,最后找到异常处理函数并调用，称为<strong>异常处理</strong>。</p>
<p>分类：</p>
<ol>
<li>CPU产生的异常</li>
<li>软件产生的异常</li>
</ol>
<h3 id="异常处理流程" class="heading-element"><span>异常处理流程</span>
  <a href="#%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86%e6%b5%81%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ol>
<li>CPU指令检测到异常（例：除0），异常一定是先由CPU发现的</li>
<li>查IDT表，执行中断处理函数，不同的异常调用不同的中断处理函数</li>
<li><code>CommonDispatchException</code></li>
<li><code>KiDispatchExceeption</code></li>
</ol>
<p>Windows异常代码：</p>
<p><img loading="lazy" src='/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/image-20230224184604177.png' alt="image-20230224184604177" height="689" width="1087"></p>
<h3 id="_kitrap00" class="heading-element"><span>_KiTrap00</span>
  <a href="#_kitrap00" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>ida中alt+t搜索<code>_IDT</code>，这里使用0号举例</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407522</span> <span class="nf">_KiTrap00</span>       <span class="no">proc</span> <span class="no">near</span>               <span class="c1">; DATA XREF: INIT:_IDT↓o
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00407522</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407522</span> <span class="nf">var_2</span>           <span class="err">=</span> <span class="no">word</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407522</span> <span class="nf">arg_4</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407522</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407522</span> <span class="c1">; FUNCTION CHUNK AT .text:00407399 SIZE 00000021 BYTES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00407522</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407522</span>                 <span class="nf">push</span>    <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407524</span>                 <span class="nf">mov</span>     <span class="no">word</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="p">(</span><span class="no">_KTRAP_FRAME.DbgEbp</span><span class="err">+</span><span class="mi">2</span><span class="p">)],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040752</span><span class="nf">B</span>                 <span class="no">push</span>    <span class="no">ebp</span><span class="c1">;_Trap_Frame保存现场
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040752</span><span class="nf">C</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040752</span><span class="nf">D</span>                 <span class="no">push</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040752</span><span class="nf">E</span>                 <span class="no">push</span>    <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040752</span><span class="nf">F</span>                 <span class="no">push</span>    <span class="no">fs</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407531</span>                 <span class="nf">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="mi">30</span><span class="no">h</span> <span class="c1">; &#39;0&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00407536</span>                 <span class="nf">mov</span>     <span class="no">fs</span><span class="p">,</span> <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407538</span>                 <span class="nf">assume</span> <span class="no">fs</span><span class="p">:</span><span class="no">nothing</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407538</span>                 <span class="nf">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040753</span><span class="nf">F</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407540</span>                 <span class="nf">sub</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407543</span>                 <span class="nf">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407544</span>                 <span class="nf">push</span>    <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407545</span>                 <span class="nf">push</span>    <span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407546</span>                 <span class="nf">push</span>    <span class="no">ds</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407547</span>                 <span class="nf">push</span>    <span class="no">es</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407548</span>                 <span class="nf">push</span>    <span class="no">gs</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040754</span><span class="nf">A</span>                 <span class="no">mov</span>     <span class="no">ax</span><span class="p">,</span> <span class="mi">23</span><span class="no">h</span> <span class="c1">; &#39;#&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040754</span><span class="nf">E</span>                 <span class="no">sub</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">30</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407551</span>                 <span class="nf">mov</span>     <span class="no">ds</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407553</span>                 <span class="nf">assume</span> <span class="no">ds</span><span class="p">:</span><span class="no">nothing</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407553</span>                 <span class="nf">mov</span>     <span class="no">es</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407555</span>                 <span class="nf">assume</span> <span class="no">es</span><span class="p">:</span><span class="no">nothing</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407555</span>                 <span class="nf">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407557</span>                 <span class="nf">test</span>    <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="no">_KTRAP_FRAME.EFlags</span><span class="p">],</span> <span class="mi">20000</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040755</span><span class="nf">F</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">V86_kit0_a</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407561</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407561</span> <span class="nl">loc_407561:</span>                             <span class="c1">; CODE XREF: V86_kit0_a+25↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00407561</span>                 <span class="nf">cld</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407562</span>                 <span class="nf">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">_KTRAP_FRAME._Ebp</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407565</span>                 <span class="nf">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">_KTRAP_FRAME._Eip</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407568</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">_KTRAP_FRAME.DbgArgPointer</span><span class="p">],</span> <span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040756</span><span class="nf">B</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">_KTRAP_FRAME.DbgArgMark</span><span class="p">],</span> <span class="mi">0</span><span class="no">BADB0D00h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407572</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">_KTRAP_FRAME.DbgEbp</span><span class="p">],</span> <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407575</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">_KTRAP_FRAME.DbgEip</span><span class="p">],</span> <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407578</span>                 <span class="nf">test</span>    <span class="no">large</span> <span class="no">byte</span> <span class="no">ptr</span> <span class="no">fs</span><span class="p">:</span><span class="no">_KTRAP_FRAME.SegFs</span><span class="p">,</span> <span class="mi">0</span><span class="no">FFh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407580</span>                 <span class="nf">jnz</span>     <span class="no">Dr_kit0_a</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407586</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407586</span> <span class="nl">loc_407586:</span>                             <span class="c1">; CODE XREF: Dr_kit0_a+10↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00407586</span>                                         <span class="c1">; Dr_kit0_a+7C↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00407586</span>                 <span class="nf">test</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">_KTRAP_FRAME.EFlags</span><span class="p">],</span> <span class="mi">20000</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040758</span><span class="nf">D</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">loc_4075CC</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040758</span><span class="nf">F</span>                 <span class="no">test</span>    <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">_KTRAP_FRAME.SegCs</span><span class="p">],</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407593</span>                 <span class="nf">jz</span>      <span class="no">short</span> <span class="no">loc_40759C</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407595</span>                 <span class="nf">cmp</span>     <span class="no">word</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">_KTRAP_FRAME.SegCs</span><span class="p">],</span> <span class="mi">1</span><span class="no">Bh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040759</span><span class="nf">A</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">loc_4075B9</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040759</span><span class="nf">C</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040759</span><span class="nf">C</span> <span class="no">loc_40759C</span><span class="p">:</span>                             <span class="c1">; CODE XREF: _KiTrap00+71↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040759</span><span class="nf">C</span>                 <span class="no">sti</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040759</span><span class="nf">D</span>                 <span class="no">push</span>    <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040759</span><span class="nf">E</span>                 <span class="no">call</span>    <span class="no">_Ki386CheckDivideByZeroTrap@4</span> <span class="c1">; Ki386CheckDivideByZeroTrap(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004075</span><span class="nf">A3</span>                 <span class="no">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">_KTRAP_FRAME._Eip</span><span class="p">]</span><span class="c1">;保存进入异常处理前的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004075</span><span class="nf">A6</span>                 <span class="no">jmp</span>     <span class="no">loc_407399</span><span class="c1">;这里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004075</span><span class="nf">AB</span> <span class="c1">; ---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004075</span><span class="nf">AB</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004075</span><span class="nf">AB</span> <span class="no">loc_4075AB</span><span class="p">:</span>                             <span class="c1">; CODE XREF: _KiTrap00+A8↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004075</span><span class="nf">AB</span>                                         <span class="c1">; _KiTrap00+B9↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004075</span><span class="nf">AB</span>                 <span class="no">sti</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004075</span><span class="nf">AC</span>                 <span class="no">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">_KTRAP_FRAME._Eip</span><span class="p">]</span><span class="c1">;保存进入异常处理前的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004075</span><span class="nf">AF</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span><span class="no">C0000094h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004075</span><span class="nf">B4</span>                 <span class="no">jmp</span>     <span class="no">loc_407399</span><span class="c1">;这里
</span></span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00407399</span> <span class="nl">loc_407399:</span>                             <span class="c1">; CODE XREF: _KiTrap00+84↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00407399</span>                                         <span class="c1">; _KiTrap00+92↓j ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00407399</span>                 <span class="nf">xor</span>     <span class="no">ecx</span><span class="p">,</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040739</span><span class="nf">B</span>                 <span class="no">call</span>    <span class="no">CommonDispatchException</span></span></span></code></pre></div><h4 id="commondispatchexception" class="heading-element"><span>CommonDispatchException</span>
  <a href="#commondispatchexception" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><code>CommonDispatchException</code>这个函数就是构建一个<code>_EXCEPTION_RECORD</code>结构体并赋值</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_EXCEPTION_RECORD</span>
</span></span><span class="line"><span class="cl"><span class="n">nt</span><span class="o">!</span><span class="n">_EXCEPTION_RECORD</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">ExceptionCode</span>    <span class="p">:</span> <span class="n">Int4B</span><span class="c1">//异常码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">ExceptionFlags</span>   <span class="p">:</span> <span class="n">Uint4B</span><span class="c1">//异常标志 cpu 0 ,软件模拟 1,嵌套异常10h ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x008</span> <span class="nl">ExceptionRecord</span>  <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_EXCEPTION_RECORD</span><span class="c1">//下一个异常 一般为NULL 除非出现嵌套异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x00c</span> <span class="nl">ExceptionAddress</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>	<span class="c1">//发生异常的指令地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x010</span> <span class="nl">NumberParameters</span> <span class="p">:</span> <span class="n">Uint4B</span><span class="c1">//参数个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x014</span> <span class="nl">ExceptionInformation</span> <span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="n">Uint4B</span><span class="c1">//附加参数指针
</span></span></span></code></pre></div><p>代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">BA</span> <span class="no">CommonDispatchException</span> <span class="no">proc</span> <span class="no">near</span>       <span class="c1">; CODE XREF: _KiTrap00-187↑p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004073</span><span class="nf">BA</span>                                         <span class="c1">; _KiTrap00-17B↑p ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004073</span><span class="nf">BA</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">BA</span> <span class="no">var_50</span>          <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">50</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">BA</span> <span class="no">var_4C</span>          <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">4</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">BA</span> <span class="no">var_48</span>          <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">48</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">BA</span> <span class="no">var_44</span>          <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">44</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">BA</span> <span class="no">var_40</span>          <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">40</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">BA</span> <span class="no">var_3C</span>          <span class="err">=</span> <span class="no">byte</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">3</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">BA</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">BA</span>                 <span class="no">sub</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">50</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">BD</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="no">_EXCEPTION_RECORD.ExceptionCode</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">C0</span>                 <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">C2</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="no">_EXCEPTION_RECORD.ExceptionFlags</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">C6</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="no">_EXCEPTION_RECORD.ExceptionRecord</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">CA</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="no">_EXCEPTION_RECORD.ExceptionAddress</span><span class="p">],</span> <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">CE</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="no">_EXCEPTION_RECORD.NumberParameters</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">D2</span>                 <span class="no">cmp</span>     <span class="no">ecx</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">D5</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_4073E3</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">D7</span>                 <span class="no">lea</span>     <span class="no">ebx</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="no">_EXCEPTION_RECORD.ExceptionInformation</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">DB</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="p">],</span> <span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">DD</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_EXCEPTION_RECORD.ExceptionFlags</span><span class="p">],</span> <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">E0</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_EXCEPTION_RECORD.ExceptionRecord</span><span class="p">],</span> <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">E3</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">E3</span> <span class="no">loc_4073E3</span><span class="p">:</span>                             <span class="c1">; CODE XREF: CommonDispatchException+1B↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004073</span><span class="nf">E3</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">E5</span>                 <span class="no">test</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">_KTRAP_FRAME.EFlags</span><span class="p">],</span> <span class="mi">20000</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">EC</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_4073F5</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">EE</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span><span class="no">FFFFh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">F3</span>                 <span class="no">jmp</span>     <span class="no">short</span> <span class="no">loc_4073F8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">F5</span> <span class="c1">; ---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004073</span><span class="nf">F5</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">F5</span> <span class="no">loc_4073F5</span><span class="p">:</span>                             <span class="c1">; CODE XREF: CommonDispatchException+32↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004073</span><span class="nf">F5</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">_KTRAP_FRAME.SegCs</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">F8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">F8</span> <span class="no">loc_4073F8</span><span class="p">:</span>                             <span class="c1">; CODE XREF: CommonDispatchException+39↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004073</span><span class="nf">F8</span>                 <span class="no">and</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004073</span><span class="nf">FB</span>                 <span class="no">push</span>    <span class="mi">1</span>               <span class="c1">; char
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004073</span><span class="nf">FD</span>                 <span class="no">push</span>    <span class="no">eax</span>             <span class="c1">; int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004073</span><span class="nf">FE</span>                 <span class="no">push</span>    <span class="no">ebp</span>             <span class="c1">; BugCheckParameter3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004073</span><span class="nf">FF</span>                 <span class="no">push</span>    <span class="mi">0</span>               <span class="c1">; int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00407401</span>                 <span class="nf">push</span>    <span class="no">ecx</span>             <span class="c1">; ExceptionRecord
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00407402</span>                 <span class="nf">call</span>    <span class="no">_KiDispatchException@20</span> <span class="c1">; KiDispatchException(x,x,x,x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00407407</span>                 <span class="nf">mov</span>     <span class="no">esp</span><span class="p">,</span> <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00407409</span>                 <span class="nf">jmp</span>     <span class="no">Kei386EoiHelper@0</span> <span class="c1">; Kei386EoiHelper()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00407409</span> <span class="nf">CommonDispatchException</span> <span class="no">endp</span></span></span></code></pre></div><h2 id="02模拟异常记录" class="heading-element"><span>02.模拟异常记录</span>
  <a href="#02%e6%a8%a1%e6%8b%9f%e5%bc%82%e5%b8%b8%e8%ae%b0%e5%bd%95" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>模拟异常的产生：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">CxxThrowException</span><span class="p">()</span><span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">KERNEL32</span><span class="p">.</span><span class="n">DLL</span><span class="p">)</span><span class="nf">RaiseException</span><span class="p">()</span><span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NTDLL</span><span class="p">.</span><span class="n">DLL</span><span class="o">!</span><span class="nf">RtlRaiseException</span><span class="p">()</span><span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NT</span><span class="o">!</span><span class="n">NtRaiseException</span><span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NT</span><span class="o">!</span><span class="n">KiRaiseException</span></span></span></code></pre></div><h3 id="分析模拟异常" class="heading-element"><span>分析模拟异常</span>
  <a href="#%e5%88%86%e6%9e%90%e6%a8%a1%e6%8b%9f%e5%bc%82%e5%b8%b8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">throw</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>可以看到调用了<code>CxxThrowException</code>：</p>
<blockquote>
<p>本实验使用的编辑器为vc6.0，为C++环境，在不同的环境中，调用的函数可能是不同的，但是最终调用的系统函数都是相同的</p></blockquote>
<p><img loading="lazy" src='/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/image-20230225143409781.png' alt="image-20230225143409781" height="192" width="558"></p>
<p>F11跟进去，可以看到调用了<code>RaiseException</code>，位于<strong>Kernel32.dll</strong>：</p>
<p>当CPU产生异常时会记录一个<strong>ErrorCode</strong>，通过查表可以查到ErrorCode具体的含义，不同的异常对应不同的错误代码，但是软件抛出的ErrorCode是根据编译环境决定的，如下图的EDX中存储的值即为当前编译环境的ErrorCode：</p>
<p><img loading="lazy" src='/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/image-20230225144037458.png' alt="image-20230225144037458" height="370" width="940"></p>
<p><strong>CPU</strong>记录异常的地址是真正发生异常的地址，但软件抛出异常时记录的地址是__RaiseException函数的地址</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ECE</span> <span class="c1">; __stdcall RaiseException(x, x, x, x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ECE</span> <span class="no">_RaiseException@16</span> <span class="no">proc</span> <span class="no">near</span>            <span class="c1">; CODE XREF: __raise_exc+194↓p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ECE</span>                                         <span class="c1">; DATA XREF: RaiseException(x,x,x,x)+21↓o
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ECE</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ECE</span> <span class="no">ExceptionRecord</span> <span class="err">=</span> <span class="no">_EXCEPTION_RECORD</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">50</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ECE</span> <span class="no">arg_0</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ECE</span> <span class="no">arg_4</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">0</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ECE</span> <span class="no">arg_8</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">10</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ECE</span> <span class="no">arg_C</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">14</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ECE</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ECE</span>                 <span class="no">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ED0</span>                 <span class="no">push</span>    <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ED1</span>                 <span class="no">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ED3</span>                 <span class="no">sub</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">50</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ED6</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">ED9</span>                 <span class="no">and</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ExceptionRecord.ExceptionRecord</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">EDD</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ExceptionRecord.ExceptionCode</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">EE0</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">EE3</span>                 <span class="no">push</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">EE4</span>                 <span class="no">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_C</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">EE7</span>                 <span class="no">and</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">EEA</span>                 <span class="no">test</span>    <span class="no">esi</span><span class="p">,</span> <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">EEC</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ExceptionRecord.ExceptionFlags</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">EEF</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ExceptionRecord.ExceptionAddress</span><span class="p">],</span> <span class="no">offset</span> <span class="no">_RaiseException@16</span> <span class="c1">; RaiseException(x,x,x,x);CPU记录异常的地址是真正发生异常的地址，但软件抛出异常时记录的地址是__RaiseException函数的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00474</span><span class="nf">EF6</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_474F13</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">EF8</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">EFB</span>                 <span class="no">cmp</span>     <span class="no">ecx</span><span class="p">,</span> <span class="mi">0</span><span class="no">Fh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">EFE</span>                 <span class="no">jbe</span>     <span class="no">short</span> <span class="no">loc_474F03</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F00</span>                 <span class="no">push</span>    <span class="mi">0</span><span class="no">Fh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F02</span>                 <span class="no">pop</span>     <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F03</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F03</span> <span class="no">loc_474F03</span><span class="p">:</span>                             <span class="c1">; CODE XREF: RaiseException(x,x,x,x)+30↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F03</span>                 <span class="no">test</span>    <span class="no">ecx</span><span class="p">,</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F05</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ExceptionRecord.NumberParameters</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F08</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_474F17</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F0A</span>                 <span class="no">push</span>    <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F0B</span>                 <span class="no">lea</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ExceptionRecord.ExceptionInformation</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F0E</span>                 <span class="no">rep</span> <span class="no">movsd</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F10</span>                 <span class="no">pop</span>     <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F11</span>                 <span class="no">jmp</span>     <span class="no">short</span> <span class="no">loc_474F17</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F13</span> <span class="c1">; ---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F13</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F13</span> <span class="no">loc_474F13</span><span class="p">:</span>                             <span class="c1">; CODE XREF: RaiseException(x,x,x,x)+28↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F13</span>                 <span class="no">and</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ExceptionRecord.NumberParameters</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F17</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F17</span> <span class="no">loc_474F17</span><span class="p">:</span>                             <span class="c1">; CODE XREF: RaiseException(x,x,x,x)+3A↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F17</span>                                         <span class="c1">; RaiseException(x,x,x,x)+43↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F17</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ExceptionRecord</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F1A</span>                 <span class="no">push</span>    <span class="no">eax</span>             <span class="c1">; ExceptionRecord
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F1B</span>                 <span class="no">call</span>    <span class="no">_RtlRaiseException@4</span> <span class="c1">; RtlRaiseException(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F20</span>                 <span class="no">pop</span>     <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F21</span>                 <span class="no">leave</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F22</span>                 <span class="no">retn</span>    <span class="mi">10</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00474</span><span class="nf">F22</span> <span class="no">_RaiseException@16</span> <span class="no">endp</span></span></span></code></pre></div><p>最后调用了<code>_RtlRaiseException</code>，位于<strong>Ntdll.dll</strong></p>
<p><code>_RtlRaiseException</code>调用了<code>ZwRaiseException</code>，之后继续调用了<code>NtRaiseException</code>，之后是<code>KiRaiseException</code>，最终和CPU异常一样调用到了<code>KiDispatchException</code>分发异常</p>
<h3 id="cpu异常和软件模拟异常流程" class="heading-element"><span>CPU异常和软件模拟异常流程</span>
  <a href="#cpu%e5%bc%82%e5%b8%b8%e5%92%8c%e8%bd%af%e4%bb%b6%e6%a8%a1%e6%8b%9f%e5%bc%82%e5%b8%b8%e6%b5%81%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>如下图所示：</p>
<p><img loading="lazy" src='/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/image-20230225144809214.png' alt="image-20230225144809214" height="986" width="908"></p>
<h2 id="03内核异常处理流程" class="heading-element"><span>03.内核异常处理流程</span>
  <a href="#03%e5%86%85%e6%a0%b8%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86%e6%b5%81%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>异常可以发生在用户空间，也可以发生在内核空间</p>
<p>内核异常处理流程：</p>
<ol>
<li><code>KeContextFromKframes</code>将<code>TrapFrame</code>备份到<code>Context</code>，为返回3环做准备。</li>
<li>判断先前模式，0是内核调用反之是用户层调用。</li>
<li>是否是第一次机会。</li>
<li>是否有内核调试器。</li>
<li>如果没有或者内核调试器不处理。</li>
<li>调用<code>RtlDispatchException</code>，查找并调用异常处理函数。</li>
<li>如果返回<code>FALSE</code>，再次判断是否有内核调试器，有调用，没有直接蓝屏。</li>
</ol>
<h3 id="kidispatchexception分析" class="heading-element"><span>KiDispatchException分析</span>
  <a href="#kidispatchexception%e5%88%86%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>函数原型：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">KiDispatchException</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">IN</span> <span class="n">PEXCEPTION_RECORD</span> <span class="n">ExceptionRecord</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">IN</span> <span class="n">PKEXCEPTION_FRAME</span> <span class="n">ExceptionFrame</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">IN</span> <span class="n">PKTRAP_FRAME</span> <span class="n">TrapFrame</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">IN</span> <span class="n">KPROCESSOR_MODE</span> <span class="n">PreviousMode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">IN</span> <span class="n">BOOLEAN</span> <span class="n">FirstChance</span> <span class="c1">//TRUE第一次处理该异常，FALSE不是第一次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span></span></span></code></pre></div><p>首先备份<code>TrapFrame</code>到<code>Context</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">text:</span><span class="err">00424</span><span class="nf">A69</span> <span class="no">loc_424A69</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDispatchException(x,x,x,x,x)+55↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">A69</span>                                         <span class="c1">; KiDispatchException(x,x,x,x,x)+68↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">A69</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">Context</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">A6F</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">A70</span>                 <span class="no">push</span>    <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">A71</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">A72</span>                 <span class="no">call</span>    <span class="no">_KeContextFromKframes@12</span> <span class="c1">; 1)KeContextFromKframes将TrapFrame备份到Context，为返回3环做准备。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">A77</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">A79</span>                 <span class="no">cmp</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">80000003</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">A7E</span>                 <span class="no">jnz</span>     <span class="no">loc_44110E</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">A84</span>                 <span class="no">dec</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">Context._Eip</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">A8C</span> <span class="no">loc_424A8C</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDispatchException(x,x,x,x,x)+266BE↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">A8C</span>                 <span class="no">cmp</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">CONTEXT.Dr6</span><span class="p">],</span> <span class="mi">0</span> <span class="c1">; 2)判断先前模式，0是内核调用，1是用户层调用，此时能够知道要分发的异常来自哪里。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">A90</span>                 <span class="no">jnz</span>     <span class="no">loc_440F9E</span>      <span class="c1">; 用户层调用跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">A96</span>                 <span class="no">cmp</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">CONTEXT.Dr7</span><span class="p">],</span> <span class="mi">1</span> <span class="c1">; 3)是否是第一次调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">A9A</span>                 <span class="no">jnz</span>     <span class="no">loc_44B0C0</span>      <span class="c1">; 不是第一次调用跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AA0</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">ds</span><span class="p">:</span><span class="no">_KiDebugRoutine</span> <span class="c1">; 4)是否有内核调试器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AA5</span>                 <span class="no">cmp</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AA7</span>                 <span class="no">jz</span>      <span class="no">loc_4335A6</span>      <span class="c1">; 没有内核调试则跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AAD</span>                 <span class="no">push</span>    <span class="no">edi</span>             <span class="c1">; _DWORD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AAE</span>                 <span class="no">push</span>    <span class="no">edi</span>             <span class="c1">; _DWORD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AAF</span>                 <span class="no">lea</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">Context</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AB5</span>                 <span class="no">push</span>    <span class="no">ecx</span>             <span class="c1">; _DWORD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AB6</span>                 <span class="no">push</span>    <span class="no">esi</span>             <span class="c1">; _DWORD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AB7</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_2F0</span><span class="p">]</span>   <span class="c1">; _DWORD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">ABD</span>                 <span class="no">push</span>    <span class="no">ebx</span>             <span class="c1">; _DWORD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">ABE</span>                 <span class="no">call</span>    <span class="no">eax</span> <span class="c1">; _KiDebugRoutine ; 有内核调试先 调用内核调试器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">ABE</span>                                         <span class="c1">; 如果调用返回成功,说明内核调试器已经处理异常,就将CONTEXT再转成Trap_Frame直接返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">ABE</span>                                         <span class="c1">; 如果调试器未处理,就让3环处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AC0</span>                 <span class="no">test</span>    <span class="no">al</span><span class="p">,</span> <span class="no">al</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AC2</span>                 <span class="no">jz</span>      <span class="no">loc_4335A6</span>      <span class="c1">; 若内核调试器未处理(返回值为FALSE), 跳转
</span></span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004335</span><span class="nf">A6</span> <span class="c1">; START OF FUNCTION CHUNK FOR KiDispatchException(x,x,x,x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004335</span><span class="nf">A6</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004335</span><span class="nf">A6</span> <span class="no">loc_4335A6</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDispatchException(x,x,x,x,x)+B2↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004335</span><span class="nf">A6</span>                                         <span class="c1">; KiDispatchException(x,x,x,x,x)+CD↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004335</span><span class="nf">A6</span> <span class="c1">; __unwind { // __SEH_prolog            ; 5)如果没有或者内核调试器不处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004335</span><span class="nf">A6</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">Context</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004335</span><span class="nf">AC</span>                 <span class="no">push</span>    <span class="no">eax</span>             <span class="c1">; Context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004335</span><span class="nf">AD</span>                 <span class="no">push</span>    <span class="no">esi</span>             <span class="c1">; ExceptionRecord
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004335</span><span class="nf">AE</span>                 <span class="no">call</span>    <span class="no">_RtlDispatchException@8</span> <span class="c1">; 6)调用RtlDispatchException，查找并调用异常处理函数。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004335</span><span class="nf">B3</span>                 <span class="no">jmp</span>     <span class="no">loc_44B0B8</span>      
</span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0B8</span> <span class="no">loc_44B0B8</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDispatchException(x,x,x,x,x)+EBBE↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0B8</span>                 <span class="no">cmp</span>     <span class="no">al</span><span class="p">,</span> <span class="mi">1</span>           <span class="c1">; 7)判断异常是否被解决，解决了跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0BA</span>                 <span class="no">jz</span>      <span class="no">loc_424AC8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0C0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0C0</span> <span class="no">loc_44B0C0</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDispatchException(x,x,x,x,x)+A5↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0C0</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">ds</span><span class="p">:</span><span class="no">_KiDebugRoutine</span> <span class="c1">; 判断是否有内核调试器，有就调用，没有会直接蓝屏
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0C5</span>                 <span class="no">cmp</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0C7</span>                 <span class="no">jz</span>      <span class="no">loc_44B1C2</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0CD</span>                 <span class="no">push</span>    <span class="mi">1</span>               <span class="c1">; _DWORD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0CF</span>                 <span class="no">push</span>    <span class="no">edi</span>             <span class="c1">; _DWORD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0D0</span>                 <span class="no">lea</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">Context</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0D6</span>                 <span class="no">push</span>    <span class="no">ecx</span>             <span class="c1">; _DWORD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0D7</span>                 <span class="no">push</span>    <span class="no">esi</span>             <span class="c1">; _DWORD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0D8</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_2F0</span><span class="p">]</span>   <span class="c1">; _DWORD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0DE</span>                 <span class="no">push</span>    <span class="no">ebx</span>             <span class="c1">; _DWORD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0DF</span>                 <span class="no">call</span>    <span class="no">eax</span> <span class="c1">; _KiDebugRoutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0E1</span>                 <span class="no">test</span>    <span class="no">al</span><span class="p">,</span> <span class="no">al</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0E3</span>                 <span class="no">jz</span>      <span class="no">loc_44B1C2</span>      <span class="c1">; 内核调试器调用结束，未解决，跳转，蓝屏
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0E9</span>                 <span class="no">jmp</span>     <span class="no">loc_424AC8</span>      <span class="c1">; 成功解决跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0E9</span> <span class="c1">; } // starts at 44B06C
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B0E9</span> <span class="c1">; END OF FUNCTION CHUNK FOR KiDispatchException(x,x,x,x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1">;蓝屏
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B1C2</span> <span class="no">loc_44B1C2</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDispatchException(x,x,x,x,x)+266D2↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B1C2</span>                                         <span class="c1">; KiDispatchException(x,x,x,x,x)+266EE↑j ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B1C2</span>                 <span class="no">push</span>    <span class="no">edi</span>             <span class="c1">; BugCheckParameter4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B1C3</span>                 <span class="no">push</span>    <span class="no">ebx</span>             <span class="c1">; BugCheckParameter3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B1C4</span>                 <span class="no">push</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="mi">0</span><span class="no">Ch</span><span class="p">]</span> <span class="c1">; BugCheckParameter2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B1C7</span>                 <span class="no">push</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">esi</span><span class="p">]</span> <span class="c1">; BugCheckParameter1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B1C9</span>                 <span class="no">push</span>    <span class="mi">8</span><span class="no">Eh</span>             <span class="c1">; BugCheckCode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B1CE</span>                 <span class="no">call</span>    <span class="no">_KeBugCheckEx@20</span> <span class="c1">; KeBugCheckEx(x,x,x,x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B1CE</span> <span class="c1">; } // starts at 44B14A
</span></span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AC8</span> <span class="no">loc_424AC8</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDispatchException(x,x,x,x,x)+1C5EB↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AC8</span>                                         <span class="c1">; KiDispatchException(x,x,x,x,x)+1C743↓j ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AC8</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_C</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">ACB</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">Context.ContextFlags</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AD1</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">Context</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AD7</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AD8</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_2F0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">ADE</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">ADF</span>                 <span class="no">call</span>    <span class="no">_KeContextToKframes@20</span> <span class="err">;</span> <span class="err">成功解决，复原</span></span></span></code></pre></div><h3 id="rtldispatchexception分析" class="heading-element"><span>RtlDispatchException分析</span>
  <a href="#rtldispatchexception%e5%88%86%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>没有调试器或者内核调试器没有处理</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">D8</span> <span class="c1">; BOOLEAN __stdcall RtlDispatchException(PEXCEPTION_RECORD ExceptionRecord, PCONTEXT Context)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004257</span><span class="nf">D8</span> <span class="no">_RtlDispatchException@8</span> <span class="no">proc</span> <span class="no">near</span>       <span class="c1">; CODE XREF: ExRaiseException(x)+92↑p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004257</span><span class="nf">D8</span>                 <span class="no">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">DA</span>                 <span class="no">push</span>    <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">DB</span>                 <span class="no">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">DD</span>                 <span class="no">sub</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">64</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">E0</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">E1</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">HighLimit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">E4</span>                 <span class="no">push</span>    <span class="no">eax</span>             <span class="c1">; HighLimit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004257</span><span class="nf">E5</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">LowLimit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">E8</span>                 <span class="no">push</span>    <span class="no">eax</span>             <span class="c1">; LowLimit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004257</span><span class="nf">E9</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_1</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">ED</span>                 <span class="no">call</span>    <span class="no">_RtlpGetStackLimits@8</span> <span class="c1">; RtlpGetStackLimits(x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004257</span><span class="nf">F2</span>                 <span class="no">call</span>    <span class="no">_RtlpGetRegistrationHead@0</span> <span class="c1">; RtlpGetRegistrationHead()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004257</span><span class="nf">F7</span>                 <span class="no">and</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_8</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">FB</span>                 <span class="no">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">FD</span>                 <span class="no">cmp</span>     <span class="no">ebx</span><span class="p">,</span> <span class="mi">0</span><span class="no">FFFFFFFFh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00425800</span>                 <span class="nf">jz</span>      <span class="no">loc_455060</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00425806</span>                 <span class="nf">push</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00425807</span>                 <span class="nf">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ExceptionRecord</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0042580</span><span class="nf">A</span>                 <span class="no">push</span>    <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405230</span> <span class="nf">_RtlpGetRegistrationHead@0</span> <span class="no">proc</span> <span class="no">near</span>    <span class="c1">; CODE XREF: RtlUnwind(x,x,x,x)+90↓p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405230</span>                                         <span class="c1">; RtlDispatchException(x,x)+1A↓p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405230</span>                 <span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405236</span>                 <span class="nf">retn</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405236</span> <span class="nf">_RtlpGetRegistrationHead@0</span> <span class="no">endp</span></span></span></code></pre></div><p><code>fs:0</code>也就是KPCR的<code>ExceptionList</code>，结构如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_EXCEPTION_REGISTRATION_RECORD</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span> 
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">EXCEPTION_REGISTRATION_RECORD</span><span class="o">*</span> <span class="n">Next</span><span class="p">;</span>	<span class="c1">//下一个节点，如过为-1就是没有下一个节点了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PEXCEPTION_ROUTINE</span> <span class="n">Handler</span><span class="p">;</span> <span class="c1">//指向下一个异常处理函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">EXCEPTION_REGISTRATION_RECORD</span><span class="p">;</span></span></span></code></pre></div><p><img loading="lazy" src='/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/image-20230225153154252.png' alt="image-20230225153154252" height="470" width="750"></p>
<ol>
<li>遍历异常链表,调用异常处理函数,如果异常被正确处理了,该函数返回1</li>
<li>如果当前异常处理函数不能处理该异常,那么调用下一个,以此类推。</li>
<li>如果到最后也没有人处理这个异常,返回0。</li>
</ol>
<h3 id="总结" class="heading-element"><span>总结</span>
  <a href="#%e6%80%bb%e7%bb%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><img loading="lazy" src='/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/835440_CA2S8CBBYXKKJ7B.png' alt="avatar" height="795" width="566"></p>
<h2 id="04用户异常的分发" class="heading-element"><span>04.用户异常的分发</span>
  <a href="#04%e7%94%a8%e6%88%b7%e5%bc%82%e5%b8%b8%e7%9a%84%e5%88%86%e5%8f%91" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ol>
<li>
<p>异常如果发生在内核层，处理起来比较简单，因为异常处理函数也在0环，不用切换堆栈，但是如果异常发生在3环，就意味着必须要切换堆栈，回到3环执行处理函数</p>
</li>
<li>
<p>切换堆栈的处理方式与用户APC的执行过程几乎是一样的，惟一的区别就是执行用户APC时返回3环后执行的函数是<code>KiUserApcDispatcher</code>，而异常处理时返回3环后执行的函数是<code>KiUserExceptionDispatcher</code></p>
</li>
<li>
<p>理解用户APC的执行过程是理解3环异常处理的关键</p>
</li>
</ol>
<p>用户异常处理流程：</p>
<ol>
<li>KeContextFromKframes将Trap_frame备份到 context 为返回3环做准备</li>
<li>判断先前模式0是内核调用1是用户层调</li>
<li>是否是第一次机会</li>
<li>是否有内核调试器</li>
<li>发送给3环调试</li>
<li>如果3环调试器没有处理这个异常,把异常数据填充到用户栈。</li>
<li>修正EIP为<code>KiUserExceptionDispatcher</code>。这个函数是<code>ntdll</code>的</li>
</ol>
<h4 id="kidispatchexception" class="heading-element"><span>KiDispatchException</span>
  <a href="#kidispatchexception" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>前面的部分和内核异常处理流程一样，关键：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00440</span><span class="nf">F9E</span> <span class="no">loc_440F9E</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDispatchException(x,x,x,x,x)+9B↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00440</span><span class="nf">F9E</span> <span class="c1">; __unwind { // __SEH_prolog            ; 判断是否是第一次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00440</span><span class="nf">F9E</span>                 <span class="no">cmp</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">CONTEXT.Dr7</span><span class="p">],</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FA2</span>                 <span class="no">jnz</span>     <span class="no">loc_44B196</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FA8</span>                 <span class="no">cmp</span>     <span class="no">ds</span><span class="p">:</span><span class="no">_KiDebugRoutine</span><span class="p">,</span> <span class="no">edi</span> <span class="c1">; 判断是否存在内核调试器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FAE</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_440FE6</span> <span class="c1">; 没有则跳转
</span></span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FE6</span> <span class="no">loc_440FE6</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDispatchException(x,x,x,x,x)+EBCB↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FE6</span>                                         <span class="c1">; KiDispatchException(x,x,x,x,x)+1C5B9↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FE6</span>                 <span class="no">push</span>    <span class="no">edi</span>             <span class="c1">; 5)发送给3环调试
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FE7</span>                 <span class="no">push</span>    <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FE9</span>                 <span class="no">push</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FEA</span>                 <span class="no">call</span>    <span class="no">_DbgkForwardException@12</span> <span class="c1">; DbgkForwardException(ExceptionRecord,TRUE,FALSE);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FEA</span>                                         <span class="c1">; 参数1:ExceptionRecord异常结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FEA</span>                                         <span class="c1">; 参数2:调试端口-TRUE，异常端口-FALSE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FEA</span>                                         <span class="c1">; 参数3:是否是第二次机会(1/0)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FEF</span>                 <span class="no">test</span>    <span class="no">al</span><span class="p">,</span> <span class="no">al</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FF1</span>                 <span class="no">jnz</span>     <span class="no">loc_424AE4</span>      <span class="c1">; 若存在三环调试器，并处理了该异常，跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FF7</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_3A0</span><span class="p">],</span> <span class="no">edi</span> <span class="c1">; 若三环调试器没处理这个异常，则准备返回3环
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FF7</span>                                         <span class="c1">; 走到这一步说明即不存在0环调试器也不存在3环调试器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00440</span><span class="nf">FF7</span>                                         <span class="c1">; 为返回3环做准备(修改_ TRAP_ FRAME里各寄存器的值)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="na">........................</span>
</span></span><span class="line"><span class="cl"><span class="c1">;这里一堆为TRAP_FRAME结构体赋值，结束的地方：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="na">.........................</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004410</span><span class="nf">D3</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTRAP_FRAME.SegDs</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004410</span><span class="nf">D6</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTRAP_FRAME.SegEs</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004410</span><span class="nf">D9</span>                 <span class="no">neg</span>     <span class="no">al</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004410</span><span class="nf">DB</span>                 <span class="no">sbb</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004410</span><span class="nf">DD</span>                 <span class="no">and</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004410</span><span class="nf">E0</span>                 <span class="no">add</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">38</span><span class="no">h</span> <span class="c1">; &#39;8&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004410</span><span class="nf">E3</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTRAP_FRAME.SegFs</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004410</span><span class="nf">E6</span>                 <span class="no">and</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTRAP_FRAME.SegGs</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004410</span><span class="nf">EA</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">ds</span><span class="p">:</span><span class="no">_KeUserExceptionDispatcher</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004410</span><span class="nf">EF</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTRAP_FRAME._Eip</span><span class="p">],</span> <span class="no">eax</span> <span class="c1">; 最关键的修改:回到3环的什么地方
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004410</span><span class="nf">EF</span>                                         <span class="c1">; 此时eax = KiUserExceptionDispatcher
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004410</span><span class="nf">EF</span>                                         <span class="c1">; 改完之后，当前函数执行结束，CPU异常与模拟异常返回地点不同
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004410</span><span class="nf">F2</span>                 <span class="no">or</span>      <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.registration.TryLevel</span><span class="p">],</span> <span class="mi">0</span><span class="no">FFFFFFFFh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004410</span><span class="nf">F6</span>                 <span class="no">jmp</span>     <span class="no">loc_424AE4</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AE4</span> <span class="no">loc_424AE4</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDispatchException(x,x,x,x,x)+1C5FC↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AE4</span>                                         <span class="c1">; KiDispatchException(x,x,x,x,x)+1C701↓j ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AE4</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_1C</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AE7</span>                 <span class="no">call</span>    <span class="no">sub_403063</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AEC</span>                 <span class="no">call</span>    <span class="no">__SEH_epilog</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AF1</span>                 <span class="no">retn</span>    <span class="mi">14</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AF1</span> <span class="c1">; } // starts at 4249F5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00424</span><span class="nf">AF1</span> <span class="no">_KiDispatchException@20</span> <span class="no">endp</span></span></span></code></pre></div><p>KiDispatchException结束后返回KiRaiseException，之后继续返回NtRaiseException，然后调用KiServiceExit返回</p>
<p>r3执行<code>_KeUserExceptionDispatcher</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">A20D</span>                 <span class="no">call</span>    <span class="no">_KiRaiseException@20</span> <span class="c1">; KiRaiseException(x,x,x,x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">A212</span>                 <span class="no">pop</span>     <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">A213</span>                 <span class="no">mov</span>     <span class="no">esp</span><span class="p">,</span> <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">A215</span>                 <span class="no">or</span>      <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">A217</span>                 <span class="no">jz</span>      <span class="no">_KiServiceExit2</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">A21D</span>                 <span class="no">jmp</span>     <span class="no">_KiServiceExit</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">A21D</span> <span class="no">_NtRaiseException@12</span> <span class="no">endp</span></span></span></code></pre></div><h3 id="小结" class="heading-element"><span>小结</span>
  <a href="#%e5%b0%8f%e7%bb%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>CPU异常与模拟异常返回地点不同</p>
<blockquote>
<p>CPU异常：
CPU检测到异常
→查IDT执行处理函数
→CommonDispatchException
→KiDispatchException通过<code>IRETD</code>返回3环
模拟异常：
CxxThrowException
→RaiseException
→RtlRaiseException
→NT!NtRaiseException
→NT!KiRaiseException
→KiDispatchException通过系统调用返回3环</p></blockquote>
<h2 id="05veh" class="heading-element"><span>05.VEH</span>
  <a href="#05veh" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ol>
<li>当用户异常产生后，内核函数<code>KiDispatchException</code>并不是像处理内核异常那样在0环直接进行处理 ，而是修正3环EIP为<code>KiUserExceptionDispatcher</code>函数后就结束了</li>
<li>当线程再次回到3环时，将会从<code>KiUserExceptionDispatcher</code>函数开始执行</li>
</ol>
<h3 id="处理流程" class="heading-element"><span>处理流程</span>
  <a href="#%e5%a4%84%e7%90%86%e6%b5%81%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ol>
<li><code>CPU</code>捕获异常信息；</li>
<li>通过<code>KiDispatchException</code>进行分发；</li>
<li><code>KiUserExceptionDispatcher</code>调用<code>RtlDispatchException</code>；</li>
<li><code>RtlDispatchException</code>查找<code>VEH</code>处理函数链表 并调用相关处理函数；</li>
<li>代码返回到<code>KiUserExceptionDispatcher</code>；</li>
<li>调用<code>ZwContinue</code>再次进入0环（<code>ZwContinue</code>调用<code>NtContinue</code>,主要作用就是恢复<code>_TRAP_FRAME</code>然后通过<code>KiServiceExit</code>返回到3环）；</li>
<li>线程再次返回3环后，从修正后的位置开始执行；</li>
</ol>
<p>其中，RtlDispatchException是个库函数，内核调用与用户调用的是不一样的：</p>
<p>ntoskrn：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">D8</span>                 <span class="no">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">DA</span>                 <span class="no">push</span>    <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">DB</span>                 <span class="no">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">DD</span>                 <span class="no">sub</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">64</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">E0</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">E1</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">HighLimit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">E4</span>                 <span class="no">push</span>    <span class="no">eax</span>             <span class="c1">; HighLimit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004257</span><span class="nf">E5</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">LowLimit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">E8</span>                 <span class="no">push</span>    <span class="no">eax</span>             <span class="c1">; LowLimit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004257</span><span class="nf">E9</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_1</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">ED</span>                 <span class="no">call</span>    <span class="no">_RtlpGetStackLimits@8</span> <span class="c1">; RtlpGetStackLimits(x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004257</span><span class="nf">F2</span>                 <span class="no">call</span>    <span class="no">_RtlpGetRegistrationHead@0</span> <span class="c1">; RtlpGetRegistrationHead()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004257</span><span class="nf">F7</span>                 <span class="no">and</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_8</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">FB</span>                 <span class="no">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004257</span><span class="nf">FD</span>                 <span class="no">cmp</span>     <span class="no">ebx</span><span class="p">,</span> <span class="mi">0</span><span class="no">FFFFFFFFh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00425800</span>                 <span class="nf">jz</span>      <span class="no">loc_455060</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00425806</span>                 <span class="nf">push</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00425807</span>                 <span class="nf">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ExceptionRecord</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0042580</span><span class="nf">A</span>                 <span class="no">push</span>    <span class="no">edi</span></span></span></code></pre></div><p>ntdll.dll中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A950</span>                 <span class="no">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A952</span>                 <span class="no">push</span>    <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A953</span>                 <span class="no">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A955</span>                 <span class="no">sub</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">64</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A958</span>                 <span class="no">push</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A959</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A95C</span>                 <span class="no">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A95F</span>                 <span class="no">push</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A960</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_1</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A964</span>                 <span class="no">call</span>    <span class="no">_RtlCallVectoredExceptionHandlers@8</span> <span class="c1">; RtlCallVectoredExceptionHandlers(x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A969</span>                 <span class="no">test</span>    <span class="no">al</span><span class="p">,</span> <span class="no">al</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A96B</span>                 <span class="no">jnz</span>     <span class="no">loc_7C96E2DA</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A971</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A972</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_C</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A975</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A976</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A979</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A97A</span>                 <span class="no">call</span>    <span class="no">_RtlpGetStackLimits@8</span> <span class="c1">; RtlpGetStackLimits(x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A97F</span>                 <span class="no">call</span>    <span class="no">_RtlpGetRegistrationHead@0</span> <span class="c1">; RtlpGetRegistrationHead()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A984</span>                 <span class="no">and</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_0</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A988</span>                 <span class="no">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A98A</span>                 <span class="no">cmp</span>     <span class="no">ebx</span><span class="p">,</span> <span class="mi">0</span><span class="no">FFFFFFFFh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A98D</span>                 <span class="no">jz</span>      <span class="no">loc_7C94AA22</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A993</span>                 <span class="no">push</span>    <span class="no">edi</span></span></span></code></pre></div><h3 id="rtldispatchexception" class="heading-element"><span>RtlDispatchException</span>
  <a href="#rtldispatchexception" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><code>ntdll.dll</code>中的<code>RtlDispatchException</code>调用了<code>_RtlCallVectoredExceptionHandlers</code></p>
<h3 id="_rtlcallvectoredexceptionhandlers" class="heading-element"><span>_RtlCallVectoredExceptionHandlers</span>
  <a href="#_rtlcallvectoredexceptionhandlers" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><strong>作用</strong>：</p>
<ol>
<li>查找<strong>VEH</strong>链表(<strong>全局链表</strong>)，如果有则调用</li>
<li>查找<strong>SEH</strong>链表(<strong>局部链表</strong>，在堆栈中)，如果有则调用</li>
</ol>
<h3 id="veh" class="heading-element"><span>VEH</span>
  <a href="#veh" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>VEH(向量化异常处理)，这个是<code>XP</code>及其之后才有的。不同的线程共用一个。</p>
<h4 id="自定义veh" class="heading-element"><span>自定义VEH</span>
  <a href="#%e8%87%aa%e5%ae%9a%e4%b9%89veh" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>示例代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="nf">PVOID</span> <span class="p">(</span><span class="n">NTAPI</span> <span class="o">*</span><span class="n">FnAddVectoredExceptionHandler</span><span class="p">)(</span><span class="n">ULONG</span><span class="p">,</span> <span class="n">_EXCEPTION_POINTERS</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">FnAddVectoredExceptionHandler</span> <span class="n">MyAddVectoredExceptionHandler</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// VEH异常处理只能返回2个值
</span></span></span><span class="line"><span class="cl"><span class="c1">// EXCEPTION_CONTINUE_EXECUTION 已处理
</span></span></span><span class="line"><span class="cl"><span class="c1">// EXCEPTION_CONTINUE_SEARCH    未处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">LONG</span> <span class="n">NTAPI</span> <span class="nf">VectExcepHandler</span><span class="p">(</span> <span class="n">PEXCEPTION_POINTERS</span> <span class="n">pExcepInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// pExcepInfo-&gt;ContextRecord	保存进入异常处理前的线程信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// pExcepInfo-&gt;ExceptionRecord	保存异常信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span> <span class="n">pExcepInfo</span><span class="o">-&gt;</span><span class="n">ExceptionRecord</span><span class="o">-&gt;</span><span class="n">ExceptionCode</span> <span class="o">==</span> <span class="mh">0xC0000094</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">::</span><span class="nf">MessageBoxA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;VEH除0异常触发了&#34;</span><span class="p">,</span> <span class="s">&#34;VEH异常&#34;</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//修改完EIP之后并不是异常处理结束后直接返回，而是通过ZwContinue进行修正
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">pExcepInfo</span><span class="o">-&gt;</span><span class="n">ContextRecord</span><span class="o">-&gt;</span><span class="n">Eip</span> <span class="o">=</span> <span class="n">pExcepInfo</span><span class="o">-&gt;</span><span class="n">ContextRecord</span><span class="o">-&gt;</span><span class="n">Eip</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//pExcepInfo-&gt;ContextRecord-&gt;Ecx = 1;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="n">EXCEPTION_CONTINUE_EXECUTION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">EXCEPTION_CONTINUE_SEARCH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//1. 动态获取AddVectoredExceptionHandler函数地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">HMODULE</span> <span class="n">hMyModule</span> <span class="o">=</span> <span class="nf">GetModuleHandle</span><span class="p">(</span><span class="s">&#34;kernel32.dll&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">MyAddVectoredExceptionHandler</span> <span class="o">=</span> <span class="p">(</span><span class="n">FnAddVectoredExceptionHandler</span><span class="p">)</span><span class="nf">GetProcAddress</span><span class="p">(</span><span class="n">hMyModule</span><span class="p">,</span> <span class="s">&#34;AddVectoredExceptionHandler&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//2. 参数1表示插入到VEH头部，0表示插入到VEH尾部
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">MyAddVectoredExceptionHandler</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">_EXCEPTION_POINTERS</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">VectExcepHandler</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//3. 构造除0异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">xor</span> <span class="n">edx</span><span class="p">,</span> <span class="n">edx</span>
</span></span><span class="line"><span class="cl">		<span class="n">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0x10</span>
</span></span><span class="line"><span class="cl">		<span class="n">idiv</span> <span class="n">ecx</span>		<span class="c1">//EDX:EAX 除以 ECX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//4. 产生异常，从这里继续
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;代码从这里继续执行</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>可以看到：</p>
<p><img loading="lazy" src='/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/image-20230225175242015.png' alt="image-20230225175242015" height="94" width="123"></p>
<p><img loading="lazy" src='/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/image-20230225175253317.png' alt="image-20230225175253317" height="125" width="263"></p>
<h2 id="06seh" class="heading-element"><span>06.SEH</span>
  <a href="#06seh" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>SEH(结构化异常处理)</p>
<p>KiUserExceptionDispatcher会调用RtIDispatchException函数来查找并调用异常处理函数,查找的顺序：</p>
<ol>
<li>先查局链表: VEH</li>
<li>如果VEH没找到，再查局部链表: SEH</li>
</ol>
<p>fs寄存器：</p>
<ul>
<li>3环<code>fs[0]-&gt;TEB.+ 0x0 _NT_TIB</code></li>
<li>0环<code>fs[0]-&gt;KPCR.+ 0x0 _NT_TIB</code></li>
</ul>
<p>SEH与VEH不同，VEH所有线程都能用的与线程无关，SEH哪个线程想用这个异常处理函数，就必须往自己的堆栈里压入<code>_EXCEPTION_REGISTRATION_RECORD</code>这种结构（你压入当前进程的A线程对B线程没有影响的），然后让fs[0]指向新构建的结构体，再给Handler提供异常处理函数。</p>
<h3 id="kiuserexceptiondispatcher" class="heading-element"><span>KiUserExceptionDispatcher</span>
  <a href="#kiuserexceptiondispatcher" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A950</span> <span class="no">_RtlDispatchException@8</span> <span class="no">proc</span> <span class="no">near</span>       <span class="c1">; CODE XREF: KiUserExceptionDispatcher(x,x)+9↑p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="na">......</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A964</span>                 <span class="no">call</span>    <span class="no">_RtlCallVectoredExceptionHandlers@8</span> <span class="c1">; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="na">.....</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A97A</span>                 <span class="no">call</span>    <span class="no">_RtlpGetStackLimits@8</span> <span class="c1">; 得到StackBase与StackLimit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A97A</span>                                         <span class="c1">; 用于校验找到的SEH结构体是否位于当前线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A97F</span>                 <span class="no">call</span>    <span class="no">_RtlpGetRegistrationHead@0</span> <span class="c1">; 获得链表头fs:[0]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="na">.....</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A9DE</span> <span class="no">loc_7C94A9DE</span><span class="p">:</span>                           <span class="c1">; CODE XREF: RtlDispatchException(x,x)+239A4↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A9DE</span>                 <span class="no">push</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A9E1</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_14</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A9E4</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A9E5</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A9E8</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A9E9</span>                 <span class="no">push</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A9EA</span>                 <span class="no">call</span>    <span class="no">_RtlpExecuteHandlerForException@20</span> <span class="c1">; 这里真正调用了SEH异常处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A9EA</span>                                         <span class="c1">; Handler必须遵守相关调用约定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A9EF</span>                 <span class="no">test</span>    <span class="no">byte_7C99B3FA</span><span class="p">,</span> <span class="mi">80</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A9F6</span>                 <span class="no">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C94A9F8</span>                 <span class="no">jnz</span>     <span class="no">loc_7C96E2F9</span></span></span></code></pre></div><p>Handler结构：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">EXCEPTION_DISPOSITION</span> <span class="kr">__cdecl</span> <span class="nf">MyExceptionHandler</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">_EXCEPTION_RECORD</span> <span class="o">*</span><span class="n">ExceptionRecord</span><span class="p">,</span>	<span class="c1">//存储异常信息：类型、产生位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="o">*</span> <span class="n">EstablisherFrame</span><span class="p">,</span>					<span class="c1">//MyException结构体地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">_CONTEXT</span> <span class="o">*</span><span class="n">ContextRecord</span><span class="p">,</span>				<span class="c1">//结构体，异常发生时各种寄存器的值，堆栈位置等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="o">*</span> <span class="n">Dispatchercontext</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span></span></span></code></pre></div><h3 id="自定义seh" class="heading-element"><span>自定义SEH</span>
  <a href="#%e8%87%aa%e5%ae%9a%e4%b9%89seh" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">//0环异常处理时讲过这个结构体
</span></span></span><span class="line"><span class="cl"><span class="cm">typedef struct _EXCEPTION_REGISTRATION_RECORD
</span></span></span><span class="line"><span class="cl"><span class="cm">{
</span></span></span><span class="line"><span class="cl"><span class="cm">	struct _EXCEPTION_REGISTRATION_RECORD *Next;
</span></span></span><span class="line"><span class="cl"><span class="cm">	PEXCEPtiON_ROUTINE Handler;
</span></span></span><span class="line"><span class="cl"><span class="cm">}
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//定义时结构体名字可以不同，但必须遵守这个格式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="n">MyException</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">MyException</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">handler</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">EXCEPTION_DISPOSITION</span> <span class="kr">__cdecl</span> <span class="nf">MyExceptionHandler</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">_EXCEPTION_RECORD</span> <span class="o">*</span><span class="n">ExceptionRecord</span><span class="p">,</span>	<span class="c1">//存储异常信息：类型、产生位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="o">*</span> <span class="n">EstablisherFrame</span><span class="p">,</span>					<span class="c1">//MyException结构体地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">_CONTEXT</span> <span class="o">*</span><span class="n">ContextRecord</span><span class="p">,</span>				<span class="c1">//结构体，异常发生时各种寄存器的值，堆栈位置等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="o">*</span> <span class="n">Dispatchercontext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span> <span class="n">ExceptionRecord</span><span class="o">-&gt;</span><span class="n">ExceptionCode</span> <span class="o">==</span> <span class="mh">0xC0000094</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">MessageBoxA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;SEH除0异常触发了&#34;</span><span class="p">,</span> <span class="s">&#34;SEH异常&#34;</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">ContextRecord</span><span class="o">-&gt;</span><span class="n">Eip</span> <span class="o">=</span> <span class="n">ContextRecord</span><span class="o">-&gt;</span><span class="n">Eip</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//pExcepInfo-&gt;ContextRecord-&gt;Ecx = 1;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="n">ExceptionContinueExecution</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ExceptionContinueSearch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TestException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">//插入异常，必须在当前线程的堆栈当中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//若定义成全局变量则无效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">MyException</span> <span class="n">myException</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="nl">FS</span><span class="p">:[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">temp</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">lea</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">myException</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="nl">FS</span><span class="p">:[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ecx</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">//原来的异常链表中也许有值，因此需要挂上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">myException</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">MyException</span><span class="o">*</span><span class="p">)</span><span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">myException</span><span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="n">MyExceptionHandler</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//构造除0异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">xor</span> <span class="n">edx</span><span class="p">,</span> <span class="n">edx</span>
</span></span><span class="line"><span class="cl">		<span class="n">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0x10</span>
</span></span><span class="line"><span class="cl">		<span class="n">idiv</span> <span class="n">ecx</span>		<span class="c1">//EDX:EAX 除以 ECX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//处理完成，摘掉异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">temp</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="nl">FS</span><span class="p">:[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;函数执行完毕</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">TestException</span><span class="p">();</span>	
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>结果：</p>
<p><img loading="lazy" src='/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/image-20230225182333244.png' alt="image-20230225182333244" height="115" width="137"></p>
<p><img loading="lazy" src='/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/image-20230225182342263.png' alt="image-20230225182342263" height="104" width="245"></p>
<h3 id="总结-1" class="heading-element"><span>总结</span>
  <a href="#%e6%80%bb%e7%bb%93-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>SEH异常处理流程</p>
<ol>
<li>FS:[0]指向SEH链表的第一个成员</li>
<li>SEH的目标结构体必须在当前线程的堆栈中</li>
<li>只有当VEH中的异常处理函数不存在或者不处理才会到SEH链表中查找</li>
</ol>
<h2 id="07编译器扩展seh" class="heading-element"><span>07.编译器扩展SEH</span>
  <a href="#07%e7%bc%96%e8%af%91%e5%99%a8%e6%89%a9%e5%b1%95seh" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="编译器支持的seh" class="heading-element"><span>编译器支持的SEH</span>
  <a href="#%e7%bc%96%e8%af%91%e5%99%a8%e6%94%af%e6%8c%81%e7%9a%84seh" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>语法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">_try</span>				<span class="c1">//挂入链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//代码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">_except</span><span class="p">(</span><span class="err">过滤表达式</span><span class="p">)</span>	<span class="c1">//异常过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//异常处理程序	//异常处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span></span></span></code></pre></div><p>其中</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">_try</span>
</span></span><span class="line"><span class="cl"><span class="c1">//相当于
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">__asm</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="nl">FS</span><span class="p">:[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="n">mov</span> <span class="n">temp</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">	<span class="n">lea</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">myException</span>
</span></span><span class="line"><span class="cl">	<span class="n">mov</span> <span class="nl">FS</span><span class="p">:[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ecx</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">/////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">_except</span><span class="p">(</span><span class="err">过滤表达式</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">//相当于
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span><span class="p">(</span> <span class="n">ExceptionRecord</span><span class="o">-&gt;</span><span class="n">ExceptionCode</span> <span class="o">==</span> <span class="mh">0xC0000094</span> <span class="p">)</span> <span class="c1">//除0异常
</span></span></span></code></pre></div><p>过滤表达式有三个值：</p>
<pre tabindex="0"><code>1. EXCEPTION_EXECUTE_HANDLER(1)		执行except代码
2. EXCEPTION_CONTINUE_SEARCH(0)		不处理异常，寻找下一个异常处理函数
3. EXCEPTION_CONTINUE_EXECUTION(-1)	返回出错位置重新执行</code></pre><h3 id="拓展seh结构体" class="heading-element"><span>拓展SEH结构体</span>
  <a href="#%e6%8b%93%e5%b1%95seh%e7%bb%93%e6%9e%84%e4%bd%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>当嵌套try-except的时候，还是挂一个，代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TestException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_try</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">_try</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nf">_except</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">_except</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_try</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">_except</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">TestException</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>汇编：</p>
<p>可以看到只改了一次fs:0</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D810</span>   <span class="no">push</span>        <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D811</span>   <span class="no">mov</span>         <span class="no">ebp</span><span class="p">,</span><span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D813</span>   <span class="no">push</span>        <span class="mi">0</span><span class="no">FFh</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D815</span>   <span class="no">push</span>        <span class="no">offset</span> <span class="no">string</span> <span class="err">&#34;\</span><span class="no">xb4</span><span class="err">\</span><span class="no">xfa</span><span class="err">\</span><span class="no">xc2</span><span class="err">\</span><span class="no">xeb</span><span class="err">\</span><span class="no">xb4</span><span class="err">\</span><span class="no">xd3</span><span class="err">\</span><span class="no">xd5</span><span class="err">\</span><span class="no">xe2</span><span class="err">\</span><span class="no">xc0</span><span class="err">\</span><span class="no">xef</span><span class="err">\</span><span class="no">xbc</span><span class="err">\</span><span class="no">xcc</span><span class="err">\</span><span class="no">xd0</span><span class="err">\</span><span class="no">xf8</span><span class="err">\</span><span class="no">xd6</span><span class="err">\</span><span class="no">xb4</span><span class="err">\</span><span class="no">xd0</span><span class="err">\</span><span class="no">xd0</span><span class="err">\</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D81A</span>   <span class="no">push</span>        <span class="no">offset</span> <span class="no">__except_handler3</span> <span class="p">(</span><span class="mi">00404300</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D81F</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="no">fs</span><span class="p">:[</span><span class="mi">00000000</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D825</span>   <span class="no">push</span>        <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D826</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="no">fs</span><span class="p">:[</span><span class="mi">0</span><span class="p">],</span><span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D82D</span>   <span class="no">add</span>         <span class="no">esp</span><span class="p">,</span><span class="mi">0</span><span class="no">FFFFFFB8h</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D830</span>   <span class="no">push</span>        <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D831</span>   <span class="no">push</span>        <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D832</span>   <span class="no">push</span>        <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D833</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-18h</span><span class="p">],</span><span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D836</span>   <span class="no">lea</span>         <span class="no">edi</span><span class="p">,[</span><span class="no">ebp-58h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D839</span>   <span class="no">mov</span>         <span class="no">ecx</span><span class="p">,</span><span class="mi">10</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D83E</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="mi">0</span><span class="no">CCCCCCCCh</span>
</span></span><span class="line"><span class="cl"><span class="err">0040</span><span class="nf">D843</span>   <span class="no">rep</span> <span class="no">stos</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">edi</span><span class="p">]</span></span></span></code></pre></div><p>那边一起是怎么实现对所有异常进行处理的呢？扩展<code>_EXCEPTION_REGISTRATION_RECORD</code>结构体</p>
<p>原本只有next和handler，现在扩展：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">_EXCEPTION_REGISTRATION</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">_EXCEPTION_REGISTRATION</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="n">PEXCEPTION_RECORD</span><span class="p">,</span> <span class="n">PEXCEPTION_REGISTRATION</span><span class="p">,</span> <span class="n">PCONTEXT</span><span class="p">,</span> <span class="n">PEXCEPTION_RECORD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">scopetable_entry</span> <span class="o">*</span><span class="n">scopetable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">trylevel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">_ebp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>一般情况下，当我们将代码分别编译为debug与release版本时，其汇编代码变化较大（release进行了优化），而当函数中存在<code>_try_except</code>这样的语法时，两者变化较小（保证异常处理语句的堆栈结构）</p>
<h4 id="scopetable" class="heading-element"><span>scopetable</span>
  <a href="#scopetable" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><strong>描述</strong>：结构体指针，指向了一堆结构体数组</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">scopetable_entry</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span>	<span class="n">previousTryLevel</span>	<span class="c1">//上一个try{}结构编号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PDWRD</span>	<span class="n">lpfnFilter</span>			<span class="c1">//过滤函数的起始地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PDWRD</span>	<span class="n">lpfnHandler</span>			<span class="c1">//异常处理程序的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">scopetable[0].previousTryLevel = -1;
</span></span></span><span class="line"><span class="cl"><span class="cm">scopetable[0].lpfnFilter = 过滤函数1;
</span></span></span><span class="line"><span class="cl"><span class="cm">scopetable[0].lpfnHandler = 异常处理函数1;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">scopetable[1].previousTryLevel = -1;
</span></span></span><span class="line"><span class="cl"><span class="cm">scopetable[1].lpfnFilter = 过滤函数2;
</span></span></span><span class="line"><span class="cl"><span class="cm">scopetable[1].lpfnHandler = 异常处理函数2;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">scopetable[2].previousTryLevel = 1;
</span></span></span><span class="line"><span class="cl"><span class="cm">scopetable[2].lpfnFilter = 过滤函数3;
</span></span></span><span class="line"><span class="cl"><span class="cm">scopetable[2].lpfnHandler = 异常处理函数3;
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span></span></span></code></pre></div><p>示例代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">ExceptFilter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">EXCEPTION_CONTINUE_EXECUTION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TestException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_try</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">_except</span><span class="p">(</span><span class="n">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;异常处理函数X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_try</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">_try</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nf">_except</span><span class="p">(</span><span class="nf">GetExceptionCode</span><span class="p">()</span> <span class="o">==</span> <span class="mh">0xC0000094</span><span class="o">?</span><span class="nl">EXCEPTION_EXECUTE_HANDLER</span><span class="p">:</span><span class="n">EXCEPTION_CONTINUE_SEARCH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;异常处理函数Y</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">_except</span><span class="p">(</span><span class="nf">ExceptFilter</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;异常处理函数Z</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>汇编：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="err">00401060</span>   <span class="nf">push</span>        <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="err">00401061</span>   <span class="nf">mov</span>         <span class="no">ebp</span><span class="p">,</span><span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="err">00401063</span>   <span class="nf">push</span>        <span class="mi">0</span><span class="no">FFh</span>
</span></span><span class="line"><span class="cl"><span class="err">00401065</span>   <span class="nf">push</span>        <span class="no">offset</span> <span class="no">string</span> <span class="err">&#34;\</span><span class="no">xd2</span><span class="err">\</span><span class="no">xec</span><span class="err">\</span><span class="no">xb3</span><span class="err">\</span><span class="no">xa3</span><span class="err">\</span><span class="no">xb4</span><span class="err">\</span><span class="no">xa6</span><span class="err">\</span><span class="no">xc0</span><span class="err">\</span><span class="no">xed</span><span class="err">\</span><span class="no">xba</span><span class="err">\</span><span class="no">xaf</span><span class="err">\</span><span class="no">xca</span><span class="err">\</span><span class="no">xfdX</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;+</span><span class="mi">14</span><span class="no">h</span> <span class="p">(</span><span class="mi">00423058</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0040106</span><span class="nf">A</span>   <span class="no">push</span>        <span class="no">offset</span> <span class="no">__except_handler3</span> <span class="p">(</span><span class="mi">004013</span><span class="no">e0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0040106</span><span class="nf">F</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="no">fs</span><span class="p">:[</span><span class="mi">00000000</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">00401075</span>   <span class="nf">push</span>        <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">00401076</span>   <span class="nf">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="no">fs</span><span class="p">:[</span><span class="mi">0</span><span class="p">],</span><span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="err">0040107</span><span class="nf">D</span>   <span class="no">add</span>         <span class="no">esp</span><span class="p">,</span><span class="mi">0</span><span class="no">FFFFFFB4h</span>
</span></span><span class="line"><span class="cl"><span class="err">00401080</span>   <span class="nf">push</span>        <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="err">00401081</span>   <span class="nf">push</span>        <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="err">00401082</span>   <span class="nf">push</span>        <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="err">00401083</span>   <span class="nf">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-18h</span><span class="p">],</span><span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="err">00401086</span>   <span class="nf">lea</span>         <span class="no">edi</span><span class="p">,[</span><span class="no">ebp-5Ch</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">00401089</span>   <span class="nf">mov</span>         <span class="no">ecx</span><span class="p">,</span><span class="mi">11</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="err">0040108</span><span class="nf">E</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="mi">0</span><span class="no">CCCCCCCCh</span>
</span></span><span class="line"><span class="cl"><span class="err">00401093</span>   <span class="na">rep</span> <span class="nf">stos</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">edi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">11:</span>       <span class="nf">_try</span>
</span></span><span class="line"><span class="cl"><span class="err">00401095</span>   <span class="nf">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="err">12:</span>       <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">13:</span>
</span></span><span class="line"><span class="cl"><span class="err">14:</span>       <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">0040109</span><span class="nf">C</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span><span class="no">FFFFFFFFh</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">A3</span>   <span class="no">jmp</span>         <span class="no">$L42284</span><span class="err">+</span><span class="mi">17</span><span class="no">h</span> <span class="p">(</span><span class="mi">004010</span><span class="no">c2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">15:</span>       <span class="nf">_except</span><span class="p">(</span><span class="no">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">A5</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">$L42285:</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">AA</span>   <span class="no">ret</span>
</span></span><span class="line"><span class="cl"><span class="nl">$L42284:</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">AB</span>   <span class="no">mov</span>         <span class="no">esp</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-18h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">16:</span>       <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">17:</span>           <span class="nf">printf</span><span class="p">(</span><span class="err">&#34;异常处理函数</span><span class="no">X</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span><span class="p">)</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">004010</span><span class="nf">AE</span>   <span class="no">push</span>        <span class="no">offset</span> <span class="no">string</span> <span class="err">&#34;\</span><span class="no">xd2</span><span class="err">\</span><span class="no">xec</span><span class="err">\</span><span class="no">xb3</span><span class="err">\</span><span class="no">xa3</span><span class="err">\</span><span class="no">xb4</span><span class="err">\</span><span class="no">xa6</span><span class="err">\</span><span class="no">xc0</span><span class="err">\</span><span class="no">xed</span><span class="err">\</span><span class="no">xba</span><span class="err">\</span><span class="no">xaf</span><span class="err">\</span><span class="no">xca</span><span class="err">\</span><span class="no">xfdX</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span> <span class="p">(</span><span class="mi">00423044</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">B3</span>   <span class="no">call</span>        <span class="no">printf</span> <span class="p">(</span><span class="mi">00401230</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">B8</span>   <span class="no">add</span>         <span class="no">esp</span><span class="p">,</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="err">18:</span>       <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">BB</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span><span class="no">FFFFFFFFh</span>
</span></span><span class="line"><span class="cl"><span class="err">19:</span>
</span></span><span class="line"><span class="cl"><span class="err">20:</span>       <span class="nf">_try</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">C2</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="err">21:</span>       <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">22:</span>           <span class="nf">_try</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">C9</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="err">23:</span>           <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">24:</span>
</span></span><span class="line"><span class="cl"><span class="err">25:</span>           <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">D0</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">D7</span>   <span class="no">jmp</span>         <span class="no">$L42292</span><span class="err">+</span><span class="mi">17</span><span class="no">h</span> <span class="p">(</span><span class="mi">0040110</span><span class="no">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">26:</span>           <span class="nf">_except</span><span class="p">(</span><span class="no">GetExceptionCode</span><span class="p">()</span> <span class="err">==</span> <span class="mi">0xC0000094</span><span class="err">?</span><span class="no">EXCEPTION_EXECUTE_HANDLER</span><span class="p">:</span><span class="no">EXCEPTION_CONTINUE_SEARCH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">D9</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-14h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">DC</span>   <span class="no">mov</span>         <span class="no">ecx</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">DE</span>   <span class="no">mov</span>         <span class="no">edx</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ecx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">E0</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-1Ch</span><span class="p">],</span><span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">E3</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-1Ch</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">E6</span>   <span class="no">xor</span>         <span class="no">ecx</span><span class="p">,</span><span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">E8</span>   <span class="no">cmp</span>         <span class="no">eax</span><span class="p">,</span><span class="mi">0</span><span class="no">C0000094h</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">ED</span>   <span class="no">sete</span>        <span class="no">cl</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">F0</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">$L42293:</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">F2</span>   <span class="no">ret</span>
</span></span><span class="line"><span class="cl"><span class="nl">$L42292:</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">F3</span>   <span class="no">mov</span>         <span class="no">esp</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-18h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">27:</span>           <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">28:</span>               <span class="nf">printf</span><span class="p">(</span><span class="err">&#34;异常处理函数</span><span class="no">Y</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span><span class="p">)</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">004010</span><span class="nf">F6</span>   <span class="no">push</span>        <span class="no">offset</span> <span class="no">string</span> <span class="err">&#34;\</span><span class="no">xd2</span><span class="err">\</span><span class="no">xec</span><span class="err">\</span><span class="no">xb3</span><span class="err">\</span><span class="no">xa3</span><span class="err">\</span><span class="no">xb4</span><span class="err">\</span><span class="no">xa6</span><span class="err">\</span><span class="no">xc0</span><span class="err">\</span><span class="no">xed</span><span class="err">\</span><span class="no">xba</span><span class="err">\</span><span class="no">xaf</span><span class="err">\</span><span class="no">xca</span><span class="err">\</span><span class="no">xfdY</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span> <span class="p">(</span><span class="mi">00423030</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">FB</span>   <span class="no">call</span>        <span class="no">printf</span> <span class="p">(</span><span class="mi">00401230</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">00401100</span>   <span class="nf">add</span>         <span class="no">esp</span><span class="p">,</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="err">29:</span>           <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">00401103</span>   <span class="nf">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="err">30:</span>       <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">0040110</span><span class="nf">A</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span><span class="no">FFFFFFFFh</span>
</span></span><span class="line"><span class="cl"><span class="err">00401111</span>   <span class="nf">jmp</span>         <span class="no">$L42288</span><span class="err">+</span><span class="mi">17</span><span class="no">h</span> <span class="p">(</span><span class="mi">00401130</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">31:</span>       <span class="nf">_except</span><span class="p">(</span><span class="no">ExceptFilter</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="err">00401113</span>   <span class="nf">call</span>        <span class="err">@</span><span class="no">ILT</span><span class="err">+</span><span class="mi">5</span><span class="p">(</span><span class="no">ExceptFilter</span><span class="p">)</span> <span class="p">(</span><span class="mi">0040100</span><span class="no">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">$L42289:</span>
</span></span><span class="line"><span class="cl"><span class="err">00401118</span>   <span class="nf">ret</span>
</span></span><span class="line"><span class="cl"><span class="nl">$L42288:</span>
</span></span><span class="line"><span class="cl"><span class="err">00401119</span>   <span class="nf">mov</span>         <span class="no">esp</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-18h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">32:</span>       <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">33:</span>           <span class="nf">printf</span><span class="p">(</span><span class="err">&#34;异常处理函数</span><span class="no">Z</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span><span class="p">)</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0040111</span><span class="nf">C</span>   <span class="no">push</span>        <span class="no">offset</span> <span class="no">string</span> <span class="err">&#34;\</span><span class="no">xd2</span><span class="err">\</span><span class="no">xec</span><span class="err">\</span><span class="no">xb3</span><span class="err">\</span><span class="no">xa3</span><span class="err">\</span><span class="no">xb4</span><span class="err">\</span><span class="no">xa6</span><span class="err">\</span><span class="no">xc0</span><span class="err">\</span><span class="no">xed</span><span class="err">\</span><span class="no">xba</span><span class="err">\</span><span class="no">xaf</span><span class="err">\</span><span class="no">xca</span><span class="err">\</span><span class="no">xfdZ</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span> <span class="p">(</span><span class="mi">0042301</span><span class="no">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">00401121</span>   <span class="nf">call</span>        <span class="no">printf</span> <span class="p">(</span><span class="mi">00401230</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">00401126</span>   <span class="nf">add</span>         <span class="no">esp</span><span class="p">,</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="err">34:</span>       <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">00401129</span>   <span class="nf">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span><span class="no">FFFFFFFFh</span>
</span></span><span class="line"><span class="cl"><span class="err">35:</span>   <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">00401130</span>   <span class="nf">mov</span>         <span class="no">ecx</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-10h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">00401133</span>   <span class="nf">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="no">fs</span><span class="p">:[</span><span class="mi">0</span><span class="p">],</span><span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="err">0040113</span><span class="nf">A</span>   <span class="no">pop</span>         <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="err">0040113</span><span class="nf">B</span>   <span class="no">pop</span>         <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="err">0040113</span><span class="nf">C</span>   <span class="no">pop</span>         <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="err">0040113</span><span class="nf">D</span>   <span class="no">add</span>         <span class="no">esp</span><span class="p">,</span><span class="mi">5</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="err">00401140</span>   <span class="nf">cmp</span>         <span class="no">ebp</span><span class="p">,</span><span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="err">00401142</span>   <span class="nf">call</span>        <span class="no">__chkesp</span> <span class="p">(</span><span class="mi">004012</span><span class="no">b0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">00401147</span>   <span class="nf">mov</span>         <span class="no">esp</span><span class="p">,</span><span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="err">00401149</span>   <span class="nf">pop</span>         <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="err">0040114</span><span class="nf">A</span>   <span class="no">ret</span></span></span></code></pre></div><p>内存</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mo">0042305</span><span class="mi">8</span> <span class="o">:</span> <span class="n">FFFFFFFF</span> <span class="cm">/*不存在上级异常处理*/</span> <span class="mo">004010</span><span class="n">A5</span>  <span class="mo">004010</span><span class="n">AB</span>  
</span></span><span class="line"><span class="cl"><span class="mo">00423064</span> <span class="o">:</span> <span class="n">FFFFFFFF</span> <span class="cm">/*不存在上级异常处理*/</span> <span class="mo">00401113</span>  <span class="mo">0040111</span><span class="mi">9</span>  
</span></span><span class="line"><span class="cl"><span class="mo">00423070</span> <span class="o">:</span> <span class="mo">00000001</span> <span class="cm">/*存在上级异常处理*/</span> <span class="mo">004010</span><span class="n">D9</span>  <span class="mf">004010F</span><span class="mi">3</span></span></span></code></pre></div><p><strong>思考</strong>：如何判断当前需要调用第几个<code>scopetable_entry</code>？
<strong>答案</strong>：根据trylevel的值进行判断</p>
<h4 id="trylevel" class="heading-element"><span>trylevel</span>
  <a href="#trylevel" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">ExceptFilter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">EXCEPTION_CONTINUE_EXECUTION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TestException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_try</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">_try</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nf">_except</span><span class="p">(</span><span class="n">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;异常处理函数</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">_except</span><span class="p">(</span><span class="n">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;异常处理函数X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">_try</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">_try</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nf">_except</span><span class="p">(</span><span class="nf">GetExceptionCode</span><span class="p">()</span> <span class="o">==</span> <span class="mh">0xC0000094</span><span class="o">?</span><span class="nl">EXCEPTION_EXECUTE_HANDLER</span><span class="p">:</span><span class="n">EXCEPTION_CONTINUE_SEARCH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;异常处理函数Y</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">_except</span><span class="p">(</span><span class="nf">ExceptFilter</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;异常处理函数Z</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>汇编：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="err">9:</span>    <span class="nf">void</span> <span class="no">TestException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">10:</span>   <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">00401050</span>   <span class="nf">push</span>        <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="err">00401051</span>   <span class="nf">mov</span>         <span class="no">ebp</span><span class="p">,</span><span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="err">00401053</span>   <span class="nf">push</span>        <span class="mi">0</span><span class="no">FFh</span>		<span class="c1">//trylevel，初始值为-1，位于[ebp-4]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">00401055</span>   <span class="nf">push</span>        <span class="no">offset</span> <span class="no">string</span> <span class="err">&#34;\</span><span class="no">xd2</span><span class="err">\</span><span class="no">xec</span><span class="err">\</span><span class="no">xb3</span><span class="err">\</span><span class="no">xa3</span><span class="err">\</span><span class="no">xb4</span><span class="err">\</span><span class="no">xa6</span><span class="err">\</span><span class="no">xc0</span><span class="err">\</span><span class="no">xed</span><span class="err">\</span><span class="no">xba</span><span class="err">\</span><span class="no">xaf</span><span class="err">\</span><span class="no">xca</span><span class="err">\</span><span class="no">xfd</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;+</span><span class="mi">10</span><span class="no">h</span> <span class="p">(</span><span class="mi">00423018</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0040105</span><span class="nf">A</span>   <span class="no">push</span>        <span class="no">offset</span> <span class="no">__except_handler3</span> <span class="p">(</span><span class="mi">0040127</span><span class="no">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0040105</span><span class="nf">F</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="no">fs</span><span class="p">:[</span><span class="mi">00000000</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">00401065</span>   <span class="nf">push</span>        <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">00401066</span>   <span class="nf">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="no">fs</span><span class="p">:[</span><span class="mi">0</span><span class="p">],</span><span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="err">0040106</span><span class="nf">D</span>   <span class="no">add</span>         <span class="no">esp</span><span class="p">,</span><span class="mi">0</span><span class="no">FFFFFFB4h</span>
</span></span><span class="line"><span class="cl"><span class="err">00401070</span>   <span class="nf">push</span>        <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="err">00401071</span>   <span class="nf">push</span>        <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="err">00401072</span>   <span class="nf">push</span>        <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="err">00401073</span>   <span class="nf">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-18h</span><span class="p">],</span><span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="err">00401076</span>   <span class="nf">lea</span>         <span class="no">edi</span><span class="p">,[</span><span class="no">ebp-5Ch</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">00401079</span>   <span class="nf">mov</span>         <span class="no">ecx</span><span class="p">,</span><span class="mi">11</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="err">0040107</span><span class="nf">E</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="mi">0</span><span class="no">CCCCCCCCh</span>
</span></span><span class="line"><span class="cl"><span class="err">00401083</span>   <span class="na">rep</span> <span class="nf">stos</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">edi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">11:</span>       <span class="nf">_try</span>
</span></span><span class="line"><span class="cl"><span class="err">00401085</span>   <span class="nf">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span>	<span class="c1">//修改trylevel为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">12:</span>       <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">13:</span>           <span class="nf">_try</span>
</span></span><span class="line"><span class="cl"><span class="err">0040108</span><span class="nf">C</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">1</span>	<span class="c1">//修改trylevel为1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">14:</span>           <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">15:</span>
</span></span><span class="line"><span class="cl"><span class="err">16:</span>           <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">00401093</span>   <span class="nf">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span>	<span class="c1">//恢复到0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0040109</span><span class="nf">A</span>   <span class="no">jmp</span>         <span class="no">$L53982</span><span class="err">+</span><span class="mi">17</span><span class="no">h</span> <span class="p">(</span><span class="mi">004010</span><span class="no">b9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">17:</span>           <span class="nf">_except</span><span class="p">(</span><span class="no">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0040109</span><span class="nf">C</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">$L53983:</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">A1</span>   <span class="no">ret</span>
</span></span><span class="line"><span class="cl"><span class="nl">$L53982:</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">A2</span>   <span class="no">mov</span>         <span class="no">esp</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-18h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">18:</span>           <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">19:</span>               <span class="nf">printf</span><span class="p">(</span><span class="err">&#34;异常处理函数\</span><span class="no">n</span><span class="err">&#34;</span><span class="p">)</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">004010</span><span class="nf">A5</span>   <span class="no">push</span>        <span class="no">offset</span> <span class="no">string</span> <span class="err">&#34;\</span><span class="no">xd2</span><span class="err">\</span><span class="no">xec</span><span class="err">\</span><span class="no">xb3</span><span class="err">\</span><span class="no">xa3</span><span class="err">\</span><span class="no">xb4</span><span class="err">\</span><span class="no">xa6</span><span class="err">\</span><span class="no">xc0</span><span class="err">\</span><span class="no">xed</span><span class="err">\</span><span class="no">xba</span><span class="err">\</span><span class="no">xaf</span><span class="err">\</span><span class="no">xca</span><span class="err">\</span><span class="no">xfd</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span> <span class="p">(</span><span class="mi">00423008</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">AA</span>   <span class="no">call</span>        <span class="no">printf</span> <span class="p">(</span><span class="mi">0040</span><span class="no">de70</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">AF</span>   <span class="no">add</span>         <span class="no">esp</span><span class="p">,</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="err">20:</span>           <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">B2</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span>	<span class="c1">//恢复到0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">21:</span>       <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">B9</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span><span class="no">FFFFFFFFh</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">C0</span>   <span class="no">jmp</span>         <span class="no">$L53978</span><span class="err">+</span><span class="mi">17</span><span class="no">h</span> <span class="p">(</span><span class="mi">004010</span><span class="no">df</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">22:</span>       <span class="nf">_except</span><span class="p">(</span><span class="no">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">C2</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">$L53979:</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">C7</span>   <span class="no">ret</span>
</span></span><span class="line"><span class="cl"><span class="nl">$L53978:</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">C8</span>   <span class="no">mov</span>         <span class="no">esp</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-18h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">23:</span>       <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">24:</span>           <span class="nf">printf</span><span class="p">(</span><span class="err">&#34;异常处理函数</span><span class="no">X</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span><span class="p">)</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">004010</span><span class="nf">CB</span>   <span class="no">push</span>        <span class="no">offset</span> <span class="no">string</span> <span class="err">&#34;\</span><span class="no">xd2</span><span class="err">\</span><span class="no">xec</span><span class="err">\</span><span class="no">xb3</span><span class="err">\</span><span class="no">xa3</span><span class="err">\</span><span class="no">xb4</span><span class="err">\</span><span class="no">xa6</span><span class="err">\</span><span class="no">xc0</span><span class="err">\</span><span class="no">xed</span><span class="err">\</span><span class="no">xba</span><span class="err">\</span><span class="no">xaf</span><span class="err">\</span><span class="no">xca</span><span class="err">\</span><span class="no">xfdX</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span> <span class="p">(</span><span class="mi">00422</span><span class="no">fc8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">D0</span>   <span class="no">call</span>        <span class="no">printf</span> <span class="p">(</span><span class="mi">0040</span><span class="no">de70</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">D5</span>   <span class="no">add</span>         <span class="no">esp</span><span class="p">,</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="err">25:</span>       <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">D8</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span><span class="no">FFFFFFFFh</span>	<span class="c1">//恢复到-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">26:</span>
</span></span><span class="line"><span class="cl"><span class="err">27:</span>       <span class="nf">_try</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">DF</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">2</span>	<span class="c1">//修改trylevel为2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">28:</span>       <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">29:</span>           <span class="nf">_try</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">E6</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">3</span>	<span class="c1">//修改trylevel为3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">30:</span>           <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">31:</span>
</span></span><span class="line"><span class="cl"><span class="err">32:</span>           <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">ED</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">2</span>	<span class="c1">//恢复到2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">004010</span><span class="nf">F4</span>   <span class="no">jmp</span>         <span class="no">$L53990</span><span class="err">+</span><span class="mi">17</span><span class="no">h</span> <span class="p">(</span><span class="mi">00401127</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">33:</span>           <span class="nf">_except</span><span class="p">(</span><span class="no">GetExceptionCode</span><span class="p">()</span> <span class="err">==</span> <span class="mi">0xC0000094</span><span class="err">?</span><span class="no">EXCEPTION_EXECUTE_HANDLER</span><span class="p">:</span><span class="no">EXCEPTION_CONTINUE_SEARCH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">F6</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-14h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">F9</span>   <span class="no">mov</span>         <span class="no">ecx</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">FB</span>   <span class="no">mov</span>         <span class="no">edx</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ecx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">004010</span><span class="nf">FD</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-1Ch</span><span class="p">],</span><span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="err">00401100</span>   <span class="nf">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-1Ch</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">00401103</span>   <span class="nf">xor</span>         <span class="no">ecx</span><span class="p">,</span><span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="err">00401105</span>   <span class="nf">cmp</span>         <span class="no">eax</span><span class="p">,</span><span class="mi">0</span><span class="no">C0000094h</span>
</span></span><span class="line"><span class="cl"><span class="err">0040110</span><span class="nf">A</span>   <span class="no">sete</span>        <span class="no">cl</span>
</span></span><span class="line"><span class="cl"><span class="err">0040110</span><span class="nf">D</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">$L53991:</span>
</span></span><span class="line"><span class="cl"><span class="err">0040110</span><span class="nf">F</span>   <span class="no">ret</span>
</span></span><span class="line"><span class="cl"><span class="nl">$L53990:</span>
</span></span><span class="line"><span class="cl"><span class="err">00401110</span>   <span class="nf">mov</span>         <span class="no">esp</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-18h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">34:</span>           <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">35:</span>               <span class="nf">printf</span><span class="p">(</span><span class="err">&#34;异常处理函数</span><span class="no">Y</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span><span class="p">)</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">00401113</span>   <span class="nf">push</span>        <span class="no">offset</span> <span class="no">string</span> <span class="err">&#34;\</span><span class="no">xd2</span><span class="err">\</span><span class="no">xec</span><span class="err">\</span><span class="no">xb3</span><span class="err">\</span><span class="no">xa3</span><span class="err">\</span><span class="no">xb4</span><span class="err">\</span><span class="no">xa6</span><span class="err">\</span><span class="no">xc0</span><span class="err">\</span><span class="no">xed</span><span class="err">\</span><span class="no">xba</span><span class="err">\</span><span class="no">xaf</span><span class="err">\</span><span class="no">xca</span><span class="err">\</span><span class="no">xfdY</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span> <span class="p">(</span><span class="mi">00422</span><span class="no">fb8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">00401118</span>   <span class="nf">call</span>        <span class="no">printf</span> <span class="p">(</span><span class="mi">0040</span><span class="no">de70</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0040111</span><span class="nf">D</span>   <span class="no">add</span>         <span class="no">esp</span><span class="p">,</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="err">36:</span>           <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">00401120</span>   <span class="nf">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">2</span>	<span class="c1">//恢复到2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">37:</span>       <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">00401127</span>   <span class="nf">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span><span class="no">FFFFFFFFh</span>	<span class="c1">//恢复到-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0040112</span><span class="nf">E</span>   <span class="no">jmp</span>         <span class="no">$L53986</span><span class="err">+</span><span class="mi">17</span><span class="no">h</span> <span class="p">(</span><span class="mi">0040114</span><span class="no">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">38:</span>       <span class="nf">_except</span><span class="p">(</span><span class="no">ExceptFilter</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="err">00401130</span>   <span class="nf">call</span>        <span class="err">@</span><span class="no">ILT</span><span class="err">+</span><span class="mi">10</span><span class="p">(</span><span class="no">ExceptFilter</span><span class="p">)</span> <span class="p">(</span><span class="mi">0040100</span><span class="no">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">$L53987:</span>
</span></span><span class="line"><span class="cl"><span class="err">00401135</span>   <span class="nf">ret</span>
</span></span><span class="line"><span class="cl"><span class="nl">$L53986:</span>
</span></span><span class="line"><span class="cl"><span class="err">00401136</span>   <span class="nf">mov</span>         <span class="no">esp</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-18h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">39:</span>       <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">40:</span>           <span class="nf">printf</span><span class="p">(</span><span class="err">&#34;异常处理函数</span><span class="no">Z</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span><span class="p">)</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">00401139</span>   <span class="nf">push</span>        <span class="no">offset</span> <span class="no">string</span> <span class="err">&#34;\</span><span class="no">xd2</span><span class="err">\</span><span class="no">xec</span><span class="err">\</span><span class="no">xb3</span><span class="err">\</span><span class="no">xa3</span><span class="err">\</span><span class="no">xb4</span><span class="err">\</span><span class="no">xa6</span><span class="err">\</span><span class="no">xc0</span><span class="err">\</span><span class="no">xed</span><span class="err">\</span><span class="no">xba</span><span class="err">\</span><span class="no">xaf</span><span class="err">\</span><span class="no">xca</span><span class="err">\</span><span class="no">xfdZ</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span> <span class="p">(</span><span class="mi">00422</span><span class="no">fa8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0040113</span><span class="nf">E</span>   <span class="no">call</span>        <span class="no">printf</span> <span class="p">(</span><span class="mi">0040</span><span class="no">de70</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">00401143</span>   <span class="nf">add</span>         <span class="no">esp</span><span class="p">,</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="err">41:</span>       <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">00401146</span>   <span class="nf">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span><span class="no">FFFFFFFFh</span>	<span class="c1">//恢复到-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">42:</span>   <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">0040114</span><span class="nf">D</span>   <span class="no">mov</span>         <span class="no">ecx</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-10h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">00401150</span>   <span class="nf">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="no">fs</span><span class="p">:[</span><span class="mi">0</span><span class="p">],</span><span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="err">00401157</span>   <span class="nf">pop</span>         <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="err">00401158</span>   <span class="nf">pop</span>         <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="err">00401159</span>   <span class="nf">pop</span>         <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="err">0040115</span><span class="nf">A</span>   <span class="no">add</span>         <span class="no">esp</span><span class="p">,</span><span class="mi">5</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="err">0040115</span><span class="nf">D</span>   <span class="no">cmp</span>         <span class="no">ebp</span><span class="p">,</span><span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="err">0040115</span><span class="nf">F</span>   <span class="no">call</span>        <span class="no">__chkesp</span> <span class="p">(</span><span class="mi">00401690</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">00401164</span>   <span class="nf">mov</span>         <span class="no">esp</span><span class="p">,</span><span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="err">00401166</span>   <span class="nf">pop</span>         <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="err">00401167</span>   <span class="nf">ret</span></span></span></code></pre></div><h4 id="_except_handler3执行过程" class="heading-element"><span>_except_handler3执行过程</span>
  <a href="#_except_handler3%e6%89%a7%e8%a1%8c%e8%bf%87%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ol>
<li>
<p>根据<strong>trylevel</strong>选择<strong>scopetable</strong>数组</p>
</li>
<li>
<p>调用<strong>scopetable</strong>数组中对应的<strong>lpfnFilter</strong>函数</p>
</li>
<li>
<p>如果<strong>lpfnFilter</strong>函数<strong>返回0</strong>，向上遍历，直到<strong>previousTryLevel = -1</strong></p>
</li>
</ol>
<h3 id="__try__finally" class="heading-element"><span>__try__finally</span>
  <a href="#__try__finally" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>示例代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TestException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kr">__try</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//continue;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">//break;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">//return;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;其他代码</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="kr">__finally</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;一定会执行的代码</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>可以把上面三个注释逐次删掉运行试试</p>
<h2 id="08未处理异常" class="heading-element"><span>08.未处理异常</span>
  <a href="#08%e6%9c%aa%e5%a4%84%e7%90%86%e5%bc%82%e5%b8%b8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>windows异常处理流程：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">CPU检测到异常</span>
</span></span><span class="line"><span class="cl"><span class="err">↓</span>
</span></span><span class="line"><span class="cl"><span class="err">查</span><span class="n">IDT表执行中断处理函数</span>
</span></span><span class="line"><span class="cl"><span class="err">↓</span>
</span></span><span class="line"><span class="cl"><span class="n">CommonDispatchException</span>		<span class="c1">//存储异常相关信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">↓</span>
</span></span><span class="line"><span class="cl"><span class="n">KiDispatchException</span>			<span class="c1">//异常分发处理函数，查找由哪一个处理程序处理这个异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>							<span class="c1">//判断0环异常还是3环异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>							<span class="c1">//若为3环，修正EIP，指向KiUserExceptionDispatcher（ntdll.dll）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">↓</span>
</span></span><span class="line"><span class="cl"><span class="n">KiUserExceptionDispatcher</span>	<span class="c1">//通过RtlDispatchException查找异常处理函数位置，VEH/SEH
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">↓</span>
</span></span><span class="line"><span class="cl"><span class="n">RtlDispatchException</span>		<span class="c1">//先查找VEH，若找不到，查找SEH（从FS:[0]开始遍历）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">↓</span>
</span></span><span class="line"><span class="cl"><span class="n">VEH</span>
</span></span><span class="line"><span class="cl"><span class="err">↓</span>
</span></span><span class="line"><span class="cl"><span class="n">SEH</span></span></span></code></pre></div><p>一般来说，不存在SEH中也没有能处理当前程的序异常</p>
<h3 id="入口程序的最后一道防线" class="heading-element"><span>入口程序的最后一道防线</span>
  <a href="#%e5%85%a5%e5%8f%a3%e7%a8%8b%e5%ba%8f%e7%9a%84%e6%9c%80%e5%90%8e%e4%b8%80%e9%81%93%e9%98%b2%e7%ba%bf" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>main的上面还有其他函数调用它：</p>
<p><img loading="lazy" src='/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/image-20230225191306047.png' alt="image-20230225191306047" height="172" width="588"></p>
<p><img loading="lazy" src='/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/image-20230225191407445.png' alt="image-20230225191407445" height="183" width="784"></p>
<p>ida中搜<code>BaseProcessStart</code>就能找到对应上面的代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817054</span> <span class="c1">; __unwind { // __SEH_prolog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817054</span>                 <span class="no">push</span>    <span class="mi">0</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817056</span>                 <span class="no">push</span>    <span class="no">offset</span> <span class="no">stru_7C817080</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C81705B</span>                 <span class="no">call</span>    <span class="no">__SEH_prolog</span><span class="c1">;注册了一个异常处理程序
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817060</span> <span class="c1">;   __try { // __except at loc_7C843900
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817060</span>                 <span class="no">and</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.registration.TryLevel</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817064</span>                 <span class="no">push</span>    <span class="mi">4</span>               <span class="c1">; ThreadInformationLength
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817066</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ThreadInformation</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817069</span>                 <span class="no">push</span>    <span class="no">eax</span>             <span class="c1">; ThreadInformation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C81706A</span>                 <span class="no">push</span>    <span class="mi">9</span>               <span class="c1">; ThreadInformationClass
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C81706C</span>                 <span class="no">push</span>    <span class="mi">0</span><span class="no">FFFFFFFEh</span>      <span class="c1">; ThreadHandle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C81706E</span>                 <span class="no">call</span>    <span class="no">ds</span><span class="p">:</span><span class="no">__imp__NtSetInformationThread@16</span> <span class="c1">; NtSetInformationThread(x,x,x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817074</span>                 <span class="no">call</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ThreadInformation</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817077</span>                 <span class="no">push</span>    <span class="no">eax</span>             <span class="c1">; dwExitCode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817078</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817078</span> <span class="no">loc_7C817078</span><span class="p">:</span>                           <span class="c1">; CODE XREF: BaseProcessStart(x)+2C8B9↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817078</span>                 <span class="no">call</span>    <span class="no">_ExitThread@4</span>   <span class="c1">; ExitThread(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817078</span> <span class="c1">;   } // starts at 7C817060
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817078</span> <span class="c1">; } // starts at 7C817054
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C817078</span> <span class="no">_BaseProcessStart@4</span> <span class="no">endp</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024D6</span> <span class="no">__SEH_prolog</span>    <span class="no">proc</span> <span class="no">near</span>               <span class="c1">; CODE XREF: DeviceIoControl(x,x,x,x,x,x,x,x)+7↑p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024D6</span>                                         <span class="c1">; ReadFile(x,x,x,x,x)+7↑p ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024D6</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024D6</span> <span class="no">arg_4</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024D6</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024D6</span>                 <span class="no">push</span>    <span class="no">offset</span> <span class="no">__except_handler3</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024DB</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024E1</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024E2</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">8</span><span class="err">+</span><span class="no">arg_4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024E6</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">8</span><span class="err">+</span><span class="no">arg_4</span><span class="p">],</span> <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024EA</span>                 <span class="no">lea</span>     <span class="no">ebp</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">8</span><span class="err">+</span><span class="no">arg_4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024EE</span>                 <span class="no">sub</span>     <span class="no">esp</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024F0</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024F1</span>                 <span class="no">push</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024F2</span>                 <span class="no">push</span>    <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024F3</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp-8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024F6</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp-18h</span><span class="p">],</span> <span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024F9</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024FA</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C8024FD</span>                 <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span> <span class="mi">0</span><span class="no">FFFFFFFFh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C802504</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp-8</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C802507</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp-10h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C80250A</span>                 <span class="no">mov</span>     <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C802510</span>                 <span class="no">retn</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C802510</span> <span class="no">__SEH_prolog</span>    <span class="no">endp</span></span></span></code></pre></div><p>kernel32：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C817054</span>   <span class="no">push</span>        <span class="mi">0</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C817056</span>   <span class="no">push</span>        <span class="mi">7</span><span class="no">C817080h</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C81705B</span>   <span class="no">call</span>        <span class="mi">7</span><span class="no">C8024D6</span><span class="c1">;在堆栈中注册了一个异常处理程序
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">7</span><span class="nf">C817060</span>   <span class="no">and</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C817064</span>   <span class="no">push</span>        <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C817066</span>   <span class="no">lea</span>         <span class="no">eax</span><span class="p">,[</span><span class="no">ebp</span><span class="err">+</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C817069</span>   <span class="no">push</span>        <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C81706A</span>   <span class="no">push</span>        <span class="mi">9</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C81706C</span>   <span class="no">push</span>        <span class="mi">0</span><span class="no">FEh</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C81706E</span>   <span class="no">call</span>        <span class="no">dword</span> <span class="no">ptr</span> <span class="no">ds</span><span class="p">:[</span><span class="mi">7</span><span class="no">C8013B0h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C817074</span>   <span class="no">call</span>        <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="mi">8</span><span class="p">]</span><span class="c1">;这里是mainCRTStartup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">7</span><span class="nf">C817077</span>   <span class="no">push</span>        <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C817078</span>   <span class="no">call</span>        <span class="mi">7</span><span class="no">C80C0F8</span></span></span></code></pre></div><p>ctrl+G查看<code>7C8024D6</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C8024D6</span>   <span class="no">push</span>        <span class="mi">7</span><span class="no">C839AD8h</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C8024DB</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="no">fs</span><span class="p">:[</span><span class="mi">00000000</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C8024E1</span>   <span class="no">push</span>        <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C8024E2</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C8024E6</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="p">],</span><span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C8024EA</span>   <span class="no">lea</span>         <span class="no">ebp</span><span class="p">,[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C8024EE</span>   <span class="no">sub</span>         <span class="no">esp</span><span class="p">,</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C8024F0</span>   <span class="no">push</span>        <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C8024F1</span>   <span class="no">push</span>        <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C8024F2</span>   <span class="no">push</span>        <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C8024F3</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C8024F6</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-18h</span><span class="p">],</span><span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C8024F9</span>   <span class="no">push</span>        <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C8024FA</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C8024FD</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span><span class="no">FFFFFFFFh</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C802504</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-8</span><span class="p">],</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C802507</span>   <span class="no">lea</span>         <span class="no">eax</span><span class="p">,[</span><span class="no">ebp-10h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80250A</span>   <span class="no">mov</span>         <span class="no">fs</span><span class="p">:[</span><span class="mi">00000000</span><span class="p">],</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C802510</span>   <span class="no">ret</span></span></span></code></pre></div><h3 id="新线程的最后一道防线" class="heading-element"><span>新线程的最后一道防线</span>
  <a href="#%e6%96%b0%e7%ba%bf%e7%a8%8b%e7%9a%84%e6%9c%80%e5%90%8e%e4%b8%80%e9%81%93%e9%98%b2%e7%ba%bf" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">ThreadProc</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">lpParam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ThreadProc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>可以看到也不是从提供的线程函数开始运行的，还是kernel32的一个位置：</p>
<p><img loading="lazy" src='/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/image-20230225192811099.png' alt="image-20230225192811099" height="317" width="731"></p>
<p>kernel32的代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80B6F2</span>   <span class="no">push</span>        <span class="mi">10</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80B6F4</span>   <span class="no">push</span>        <span class="mi">7</span><span class="no">C80B730h</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80B6F9</span>   <span class="no">call</span>        <span class="mi">7</span><span class="no">C8024D6</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80B6FE</span>   <span class="no">and</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80B702</span>   <span class="no">mov</span>         <span class="no">eax</span><span class="p">,</span><span class="no">fs</span><span class="p">:[</span><span class="mi">00000018</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80B708</span>   <span class="no">mov</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-20h</span><span class="p">],</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80B70B</span>   <span class="no">cmp</span>         <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="p">],</span><span class="mi">1</span><span class="no">E00h</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80B712</span>   <span class="no">jne</span>         <span class="mi">7</span><span class="no">C80B723</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80B714</span>   <span class="no">cmp</span>         <span class="no">byte</span> <span class="no">ptr</span> <span class="no">ds</span><span class="p">:[</span><span class="mi">7</span><span class="no">C885008h</span><span class="p">],</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80B71B</span>   <span class="no">jne</span>         <span class="mi">7</span><span class="no">C80B723</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80B71D</span>   <span class="no">call</span>        <span class="no">dword</span> <span class="no">ptr</span> <span class="no">ds</span><span class="p">:[</span><span class="mi">7</span><span class="no">C8012F8h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80B723</span>   <span class="no">push</span>        <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="mi">0</span><span class="no">Ch</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80B726</span>   <span class="no">call</span>        <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80B729</span>   <span class="no">push</span>        <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">7</span><span class="nf">C80B72A</span>   <span class="no">call</span>        <span class="mi">7</span><span class="no">C80C0F8</span></span></span></code></pre></div><p>在地址<code>7C80B6F9</code>处也调用了地址<code>7C8024D6</code>的代码（<strong>__SEH_prolog</strong>），注册了异常处理函数</p>
<h3 id="unhandledexceptionfilter" class="heading-element"><span>UnhandledExceptionFilter</span>
  <a href="#unhandledexceptionfilter" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>可以理解为线程开始的时候都加了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kr">__try</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">__except</span><span class="p">(</span><span class="nf">UnhandledExceptionFilter</span><span class="p">(</span><span class="nf">GetExceptionInformation</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//终止线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//终止进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">如果</span><span class="n">UnhandledExceptionFilter</span><span class="p">(</span><span class="nf">GetExceptionlnformation</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">返回</span><span class="mi">0</span><span class="err">那就是真正找不到对应的异常处理程序了，</span>
</span></span><span class="line"><span class="cl"><span class="err">但这中情况如果你的程序在没有被</span> <span class="err">调试</span> <span class="err">的情况下是不会发生的</span>
</span></span><span class="line"><span class="cl"><span class="err">只有程序被调试时，才会存在未处理异常</span></span></span></code></pre></div><p><strong>描述</strong>：</p>
<ol>
<li>最后一道防线调用的异常处理程序的过滤函数</li>
<li>只有当它的返回值为<strong>EXCEPTION_CONTINUE_SEARCH</strong>(0)时，当前线程不存在对应的SEH</li>
<li>只有在当前程序处于调试状态时，才会发生上述情况</li>
</ol>
<p>执行流程：</p>
<p>通过<code>NtQueryInformationProcess</code>查询当前进程是否正在被调试，如果是，返回<code>EXCEPTION_CONTINUE_SEARCH</code>，此时会进入第二轮分发
如果没有被调试：</p>
<ol>
<li>
<p>查询是否通过<code>SetUnhandledExceptionFilter</code>注册处理函数 如果有就调用</p>
</li>
<li>
<p>如果没有通过<code>SetUnhandledExceptionFilter</code>注册处理函数，弹出窗口，让用户选择终止程序还是启动即时调试器</p>
</li>
<li>
<p>如果用户没有启用即时调试器，那么该函数返回<code>EXCEPTION_EXECUTE_HANDLER</code>，此时会执行except中的代码</p>
</li>
</ol>
<p>示例代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="kr">__stdcall</span> <span class="nf">callback</span><span class="p">(</span><span class="n">_EXCEPTION_POINTERS</span> <span class="o">*</span><span class="n">excp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">excp</span><span class="o">-&gt;</span><span class="n">ContextRecord</span><span class="o">-&gt;</span><span class="n">Ecx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">EXCEPTION_CONTINUE_EXECUTION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">SetUnhandledExceptionFilter</span><span class="p">(</span><span class="n">callback</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">xor</span> <span class="n">edx</span><span class="p">,</span> <span class="n">edx</span>
</span></span><span class="line"><span class="cl">		<span class="n">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0x10</span>
</span></span><span class="line"><span class="cl">		<span class="n">idiv</span> <span class="n">ecx</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;程序正常执行</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h3 id="未处理异常" class="heading-element"><span>未处理异常</span>
  <a href="#%e6%9c%aa%e5%a4%84%e7%90%86%e5%bc%82%e5%b8%b8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>执行流程：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">KiUserExceptionDispatcher</span>
</span></span><span class="line"><span class="cl"><span class="err">↓</span>
</span></span><span class="line"><span class="cl"><span class="nf">RtlDispatchException</span>			<span class="c1">//查找并执行异常处理函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>								<span class="c1">//如果返回真,调用ZwContinue再次进入0环
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>								<span class="c1">//但线程再次返回3环时，会从修正后的位置开始执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>							
</span></span><span class="line"><span class="cl">								<span class="c1">//如果返回假,调用ZwRaiseException进行第二轮异常分发
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>								<span class="err">//(参见</span><span class="nf">KiUserExceptionDispatcher代码</span><span class="p">)</span></span></span></code></pre></div><p><code>KiUserExceptionDispatcher</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E45C</span> <span class="c1">; __stdcall KiUserExceptionDispatcher(x, x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E45C</span>                 <span class="no">public</span> <span class="no">_KiUserExceptionDispatcher@8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E45C</span> <span class="no">_KiUserExceptionDispatcher@8</span> <span class="no">proc</span> <span class="no">near</span>  <span class="c1">; DATA XREF: .text:off_7C923428↑o
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E45C</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E45C</span> <span class="no">var_C</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">0</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E45C</span> <span class="no">var_8</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E45C</span> <span class="no">var_4</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E45C</span> <span class="no">arg_0</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E45C</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E45C</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="no">arg_0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E460</span>                 <span class="no">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E463</span>                 <span class="no">push</span>    <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E464</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E465</span>                 <span class="no">call</span>    <span class="no">_RtlDispatchException@8</span> <span class="c1">; RtlDispatchException(x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E46A</span>                 <span class="no">or</span>      <span class="no">al</span><span class="p">,</span> <span class="no">al</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E46C</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_7C92E47A</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E46E</span>                 <span class="no">pop</span>     <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E46F</span>                 <span class="no">pop</span>     <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E470</span>                 <span class="no">push</span>    <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E472</span>                 <span class="no">push</span>    <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E473</span>                 <span class="no">call</span>    <span class="no">_ZwContinue@8</span>   <span class="c1">; ZwContinue(x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E478</span>                 <span class="no">jmp</span>     <span class="no">short</span> <span class="no">loc_7C92E485</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E47A</span> <span class="c1">; ---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E47A</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E47A</span> <span class="no">loc_7C92E47A</span><span class="p">:</span>                           <span class="c1">; CODE XREF: KiUserExceptionDispatcher(x,x)+10↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E47A</span>                 <span class="no">pop</span>     <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E47B</span>                 <span class="no">pop</span>     <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E47C</span>                 <span class="no">push</span>    <span class="mi">0</span><span class="c1">;第一次调用为1，第二次调用为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E47E</span>                 <span class="no">push</span>    <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E47F</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E480</span>                 <span class="no">call</span>    <span class="no">_ZwRaiseException@12</span> <span class="err">;</span> <span class="err">进入二次分发</span></span></span></code></pre></div></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2023-03-02 00:00:00">Updated on 2023-03-02&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on X" data-sharer="twitter" data-url="https://nesl42.github.io/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/" data-title="Windows内核(八)——异常" data-hashtags="Win32"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://nesl42.github.io/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/" data-hashtag="Win32"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://nesl42.github.io/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/" data-title="Windows内核(八)——异常"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/win32/" class="post-tag" title="Tags - Win32">Win32</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/2023-2-winkernelapc/" class="post-nav-item" rel="prev" title="Windows内核(七)——APC机制"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Windows内核(七)——APC机制</a><a href="/posts/2023-3-winkernel%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" class="post-nav-item" rel="next" title="Windows内核(九)——内存管理">Windows内核(九)——内存管理<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.149.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.17-8212d6fd"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"version":"v0.3.17-8212d6fd"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
