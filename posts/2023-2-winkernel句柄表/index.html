<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Windows内核(五)——句柄表 - 敬渊&#39;s Blog</title><meta name="author" content="">
<meta name="description" content="[toc]
01.句柄表 当一个进程创建或者打开一个内核对象时，将获得一个句柄，通过这个句柄可以访问对应的内核对象
"><meta name="keywords" content='Win32'>
  <meta itemprop="name" content="Windows内核(五)——句柄表">
  <meta itemprop="description" content="[toc]
01.句柄表 当一个进程创建或者打开一个内核对象时，将获得一个句柄，通过这个句柄可以访问对应的内核对象">
  <meta itemprop="datePublished" content="2023-02-19T00:00:00+00:00">
  <meta itemprop="dateModified" content="2023-02-19T00:00:00+00:00">
  <meta itemprop="wordCount" content="3916">
  <meta itemprop="keywords" content="Win32"><meta property="og:url" content="https://nesl42.github.io/posts/2023-2-winkernel%E5%8F%A5%E6%9F%84%E8%A1%A8/">
  <meta property="og:site_name" content="敬渊&#39;s Blog">
  <meta property="og:title" content="Windows内核(五)——句柄表">
  <meta property="og:description" content="[toc]
01.句柄表 当一个进程创建或者打开一个内核对象时，将获得一个句柄，通过这个句柄可以访问对应的内核对象">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-02-19T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-02-19T00:00:00+00:00">
    <meta property="article:tag" content="Win32">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Windows内核(五)——句柄表">
  <meta name="twitter:description" content="[toc]
01.句柄表 当一个进程创建或者打开一个内核对象时，将获得一个句柄，通过这个句柄可以访问对应的内核对象">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="https://nesl42.github.io/posts/2023-2-winkernel%E5%8F%A5%E6%9F%84%E8%A1%A8/" title="Windows内核(五)——句柄表 - 敬渊&#39;s Blog" /><link rel="prev" type="text/html" href="https://nesl42.github.io/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/" title="Windows内核(四)——进程线程" /><link rel="next" type="text/html" href="https://nesl42.github.io/posts/2023-2-winkernel%E4%BA%8B%E4%BB%B6%E7%AD%89%E5%BE%85/" title="Windows内核(六)——事件等待" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Windows内核(五)——句柄表",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/nesl42.github.io\/posts\/2023-2-winkernel%E5%8F%A5%E6%9F%84%E8%A1%A8\/"
    },"genre": "posts","keywords": "Win32","wordcount":  3916 ,
    "url": "https:\/\/nesl42.github.io\/posts\/2023-2-winkernel%E5%8F%A5%E6%9F%84%E8%A1%A8\/","datePublished": "2023-02-19T00:00:00+00:00","dateModified": "2023-02-19T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Author"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/">文章</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/">标签</a></li><li class="menu-item">
              <a class="menu-link" href="/about/">关于</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/">分类</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="/posts/">文章</a></li><li class="menu-item"><a class="menu-link" href="/tags/">标签</a></li><li class="menu-item"><a class="menu-link" href="/about/">关于</a></li><li class="menu-item"><a class="menu-link" href="/categories/">分类</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Windows内核(五)——句柄表</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="published on 2023-02-19 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-02-19">2023-02-19</time></span>&nbsp;<span title="3916 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 4000 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>8 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#01句柄表">01.句柄表</a>
          <ul>
            <li><a href="#查看句柄表">查看句柄表</a></li>
            <li><a href="#句柄表结构">句柄表结构</a>
              <ul>
                <li><a href="#根据句柄定位内核对象">根据句柄定位内核对象</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#02-全局句柄表">02 全局句柄表</a>
          <ul>
            <li><a href="#全局句柄表">全局句柄表</a></li>
            <li><a href="#全局句柄表结构">全局句柄表结构</a>
              <ul>
                <li><a href="#在windbg中查看全局句柄表">在WinDbg中查看全局句柄表</a></li>
              </ul>
            </li>
            <li><a href="#遍历全局句柄表">遍历全局句柄表</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>[toc]</p>
<h2 id="01句柄表" class="heading-element"><span>01.句柄表</span>
  <a href="#01%e5%8f%a5%e6%9f%84%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ol>
<li>
<p>当一个进程创建或者打开一个内核对象时，将获得一个句柄，通过这个句柄可以访问对应的内核对象</p>
</li>
<li>
<p>句柄表存储在零环，一个进程使用了几个句柄，在该进程的句柄表中就会存储几个句柄</p>
</li>
<li>
<p>所有的句柄所对应的内核对象，都包含在**_OBJECT_HEADER** 中，真正的内核对象保存在 <strong>_OBJECT_HEADER +0x018 body</strong> 的位置(<code>ETHREAD</code>和<code>EPROCESS</code>也都放在这个位置)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; dt _OBJECT_HEADER
</span></span><span class="line"><span class="cl">nt!_OBJECT_HEADER
</span></span><span class="line"><span class="cl">   +0x000 PointerCount     : Int4B
</span></span><span class="line"><span class="cl">   +0x004 HandleCount      : Int4B
</span></span><span class="line"><span class="cl">   +0x004 NextToFree       : Ptr32 Void
</span></span><span class="line"><span class="cl">   +0x008 Type             : Ptr32 _OBJECT_TYPE
</span></span><span class="line"><span class="cl">   +0x00c NameInfoOffset   : UChar
</span></span><span class="line"><span class="cl">   +0x00d HandleInfoOffset : UChar
</span></span><span class="line"><span class="cl">   +0x00e QuotaInfoOffset  : UChar
</span></span><span class="line"><span class="cl">   +0x00f Flags            : UChar
</span></span><span class="line"><span class="cl">   +0x010 ObjectCreateInfo : Ptr32 _OBJECT_CREATE_INFORMATION
</span></span><span class="line"><span class="cl">   +0x010 QuotaBlockCharged : Ptr32 Void
</span></span><span class="line"><span class="cl">   +0x014 SecurityDescriptor : Ptr32 Void
</span></span><span class="line"><span class="cl">   +0x018 Body             : _QUAD</span></span></code></pre></div></li>
<li>
<p>窗口、字体、笔刷等句柄与本章所学句柄是两码事</p>
</li>
<li>
<p>创建句柄不等同于打开句柄，当创建的时候，操作系统会在零环为内核对象分配一个结构体（例如CreateEvent），如果自己或他人打开了这个内核对象（例如OpenProcess），那么将不会再次为这个内核对象分配一个结构体，而是返回一个句柄的索引值</p>
</li>
<li>
<p>若同一个内核对象被引用了100次，那么在句柄表中就会存储100个内核对象的地址</p>
</li>
<li>
<p>句柄的值并非如上图所显示的只占4个字节，而是占8个字节，但是句柄表的值仍然按照4个字节进行计算</p>
<p>计算：<code>handle = index / 4 * 8</code></p>
</li>
</ol>
<h3 id="查看句柄表" class="heading-element"><span>查看句柄表</span>
  <a href="#%e6%9f%a5%e7%9c%8b%e5%8f%a5%e6%9f%84%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>示例代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PID</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">HANDLE</span> <span class="n">hPro</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">HWND</span> <span class="n">hWnd</span> <span class="o">=</span> <span class="o">::</span><span class="nf">FindWindow</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;计算器&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">::</span><span class="nf">GetWindowThreadProcessId</span><span class="p">(</span><span class="n">hWnd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">100</span> <span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">hPro</span> <span class="o">=</span> <span class="o">::</span><span class="nf">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_CREATE_THREAD</span><span class="o">|</span><span class="n">PROCESS_VM_OPERATION</span><span class="o">|</span><span class="n">PROCESS_VM_READ</span><span class="o">|</span><span class="n">PROCESS_VM_WRITE</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">PID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;句柄：%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">hPro</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>运行结果：</p>
<p><img loading="lazy" src='/posts/2023-2-winkernel%E5%8F%A5%E6%9F%84%E8%A1%A8/image-20230219172158354.png' alt="image-20230219172158354" height="412" width="657"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; !process <span class="m">0</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Failed to get VadRoot
</span></span><span class="line"><span class="cl">PROCESS 8613b688  SessionId: <span class="m">0</span>  Cid: 07b4    Peb: 7ffde000  ParentCid: 07ac
</span></span><span class="line"><span class="cl">    DirBase: 06bc0340  ObjectTable: e35367b8  HandleCount: 116.
</span></span><span class="line"><span class="cl">    Image: test.exe
</span></span><span class="line"><span class="cl">------------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">kd&gt; dt _EPROCESS 8613b688
</span></span><span class="line"><span class="cl">ntdll!_EPROCESS
</span></span><span class="line"><span class="cl">   ...
</span></span><span class="line"><span class="cl">   +0x0c4 ObjectTable      : 0xe35367b8 _HANDLE_TABLE //这里
</span></span><span class="line"><span class="cl">   ...
</span></span><span class="line"><span class="cl">------------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">kd&gt; dt _HANDLE_TABLE 0xe35367b8
</span></span><span class="line"><span class="cl">nt_exe!_HANDLE_TABLE
</span></span><span class="line"><span class="cl">   +0x000 TableCode        : 0xe1251000 //这里
</span></span><span class="line"><span class="cl">   +0x004 QuotaProcess     : 0x8613b688 _EPROCESS
</span></span><span class="line"><span class="cl">   +0x008 UniqueProcessId  : 0x000007b4 Void
</span></span><span class="line"><span class="cl">   +0x00c HandleTableLock  : <span class="o">[</span>4<span class="o">]</span> _EX_PUSH_LOCK
</span></span><span class="line"><span class="cl">   +0x01c HandleTableList  : _LIST_ENTRY <span class="o">[</span> 0x80565ba8 - 0xe2f363b4 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x024 HandleContentionEvent : _EX_PUSH_LOCK
</span></span><span class="line"><span class="cl">   +0x028 DebugInfo        : <span class="o">(</span>null<span class="o">)</span> 
</span></span><span class="line"><span class="cl">   +0x02c ExtraInfoPages   : 0n0
</span></span><span class="line"><span class="cl">   +0x030 FirstFree        : 0x63c
</span></span><span class="line"><span class="cl">   +0x034 LastFree         : <span class="m">0</span>
</span></span><span class="line"><span class="cl">   +0x038 NextHandleNeedingPool : 0x800
</span></span><span class="line"><span class="cl">   +0x03c HandleCount      : 0n116
</span></span><span class="line"><span class="cl">   +0x040 Flags            : <span class="m">0</span>
</span></span><span class="line"><span class="cl">   +0x040 StrictFIFO       : 0y0
</span></span><span class="line"><span class="cl">------------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">kd&gt; dq 0xe1251000
</span></span><span class="line"><span class="cl">ReadVirtual: e1251000 not properly sign extended
</span></span><span class="line"><span class="cl">e1251000  fffffffe<span class="sb">`</span><span class="m">00000000</span> 00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">e1251010  00000004<span class="sb">`</span><span class="m">00000000</span> 00000008<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">e1251020  0000000c<span class="sb">`</span><span class="m">00000000</span> 00000010<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">e1251030  00000014<span class="sb">`</span><span class="m">00000000</span> 00000018<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">e1251040  0000001c<span class="sb">`</span><span class="m">00000000</span> 00000020<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">e1251050  00000024<span class="sb">`</span><span class="m">00000000</span> 00000028<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">e1251060  0000002c<span class="sb">`</span><span class="m">00000000</span> 00000030<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">e1251070  00000034<span class="sb">`</span><span class="m">00000000</span> 00000038<span class="sb">`</span><span class="m">00000000</span></span></span></code></pre></div><h3 id="句柄表结构" class="heading-element"><span>句柄表结构</span>
  <a href="#%e5%8f%a5%e6%9f%84%e8%a1%a8%e7%bb%93%e6%9e%84" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; dt _HANDLE_TABLE 
</span></span><span class="line"><span class="cl">nt_exe!_HANDLE_TABLE
</span></span><span class="line"><span class="cl">   +0x000 TableCode        : Uint4B
</span></span><span class="line"><span class="cl">   +0x004 QuotaProcess     : Ptr32 _EPROCESS
</span></span><span class="line"><span class="cl">   +0x008 UniqueProcessId  : Ptr32 Void
</span></span><span class="line"><span class="cl">   +0x00c HandleTableLock  : <span class="o">[</span>4<span class="o">]</span> _EX_PUSH_LOCK
</span></span><span class="line"><span class="cl">   +0x01c HandleTableList  : _LIST_ENTRY
</span></span><span class="line"><span class="cl">   +0x024 HandleContentionEvent : _EX_PUSH_LOCK
</span></span><span class="line"><span class="cl">   +0x028 DebugInfo        : Ptr32 _HANDLE_TRACE_DEBUG_INFO
</span></span><span class="line"><span class="cl">   +0x02c ExtraInfoPages   : Int4B
</span></span><span class="line"><span class="cl">   +0x030 FirstFree        : Uint4B
</span></span><span class="line"><span class="cl">   +0x034 LastFree         : Uint4B
</span></span><span class="line"><span class="cl">   +0x038 NextHandleNeedingPool : Uint4B
</span></span><span class="line"><span class="cl">   +0x03c HandleCount      : Int4B
</span></span><span class="line"><span class="cl">   +0x040 Flags            : Uint4B
</span></span><span class="line"><span class="cl">   +0x040 StrictFIFO       : Pos 0, <span class="m">1</span> Bit</span></span></code></pre></div><p><code>TableCode</code>就是的句柄表，结构如下：</p>
<p><img loading="lazy" src='/posts/2023-2-winkernel%E5%8F%A5%E6%9F%84%E8%A1%A8/2520882-20220119172827300-822756739.png' alt="img" height="49" width="757"></p>
<ol>
<li>
<p>这一块共计两个字节，高位字节是给<code>SetHandleInformation</code>这个函数用的，比如写成如下形式，那么这个位置将被写入<code>0x02</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">SetHandleInformation</span><span class="p">(</span><span class="n">Handle</span><span class="p">,</span><span class="n">HANDLE_FLAG_PROTECT_FROM_CLOSE</span><span class="p">,</span><span class="n">HANDLE_FLAG_PROTECT_FROM_CLOSE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//HANDLE_FLAG_PROTECT_FROM_CLOSE宏的值为0x00000002，取最低字节，最终这块是0x0200
</span></span></span></code></pre></div></li>
<li>
<p>这块是访问掩码，是给<strong>OpenProess</strong>这个函数用的，具体的存的值就是这个函数的第一个参数的值。</p>
</li>
<li>
<p>③ 和 ④ 这两个块共计四个字节，其中<code>bit0-bit2</code>存的是这个句柄的属性，其中<code>bit2</code>和<code>bit0</code>默认为<code>0</code>和<code>1</code>；<code>bit1</code>表示的函数是该句柄是否可继承，<code>OpenProcess</code>的第二个参数与<code>bit1</code>有关，<code>bit31-bit3</code>则是存放的该内核对象在内核中的具体的地址。</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">//代码中第一个句柄是7cc
</span></span><span class="line"><span class="cl">kd&gt; dq 0xe1251000+7cc*2
</span></span><span class="line"><span class="cl">ReadVirtual: e1251f98 not properly sign extended
</span></span><span class="line"><span class="cl">e1251f98  0000003a<span class="sb">`</span>85fcc00b 000f01ff<span class="sb">`</span><span class="m">86187571</span>
</span></span><span class="line"><span class="cl">e1251fa8  000f037f<span class="sb">`</span><span class="m">86408651</span> 021f0003<span class="sb">`</span>85f98551
</span></span><span class="line"><span class="cl">e1251fb8  020f003f<span class="sb">`</span>e2e7dc19 000f037f<span class="sb">`</span><span class="m">86408651</span>
</span></span><span class="line"><span class="cl">e1251fc8  001f0003<span class="sb">`</span>85fc21d1 00100003<span class="sb">`</span>85fbb221
</span></span><span class="line"><span class="cl">e1251fd8  021f0001<span class="sb">`</span>e1132cc9 000f000f<span class="sb">`</span>e135f6e9
</span></span><span class="line"><span class="cl">e1251fe8  00100003<span class="sb">`</span>8613b5f9 00000003<span class="sb">`</span>e156d471
</span></span><span class="line"><span class="cl">e1251ff8  000f0003<span class="sb">`</span>e1001109 63416553<span class="sb">`</span><span class="m">04810600</span>
</span></span><span class="line"><span class="cl">e1252008  00000000<span class="sb">`</span>e11aec30 864cd650<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kd&gt; dq 0xe1251000+640*2
</span></span><span class="line"><span class="cl">ReadVirtual: e1251c80 not properly sign extended
</span></span><span class="line"><span class="cl">e1251c80  0000003a<span class="sb">`</span>85fcc00b 0000003a<span class="sb">`</span>85fcc00b
</span></span><span class="line"><span class="cl">e1251c90  0000003a<span class="sb">`</span>85fcc00b 0000003a<span class="sb">`</span>85fcc00b
</span></span><span class="line"><span class="cl">e1251ca0  0000003a<span class="sb">`</span>85fcc00b 0000003a<span class="sb">`</span>85fcc00b
</span></span><span class="line"><span class="cl">e1251cb0  0000003a<span class="sb">`</span>85fcc00b 0000003a<span class="sb">`</span>85fcc00b
</span></span><span class="line"><span class="cl">e1251cc0  0000003a<span class="sb">`</span>85fcc00b 0000003a<span class="sb">`</span>85fcc00b
</span></span><span class="line"><span class="cl">e1251cd0  0000003a<span class="sb">`</span>85fcc00b 0000003a<span class="sb">`</span>85fcc00b
</span></span><span class="line"><span class="cl">e1251ce0  0000003a<span class="sb">`</span>85fcc00b 0000003a<span class="sb">`</span>85fcc00b
</span></span><span class="line"><span class="cl">e1251cf0  0000003a<span class="sb">`</span>85fcc00b 0000003a<span class="sb">`</span>85fcc00b</span></span></code></pre></div><p>下面是置句柄表高两字节为0x20</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">PID</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">HANDLE</span> <span class="n">hPro</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">HWND</span> <span class="n">hWnd</span> <span class="o">=</span> <span class="o">::</span><span class="nf">FindWindow</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;计算器&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">::</span><span class="nf">GetWindowThreadProcessId</span><span class="p">(</span><span class="n">hWnd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">100</span> <span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">hPro</span> <span class="o">=</span> <span class="o">::</span><span class="nf">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_CREATE_THREAD</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">PID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;句柄：%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">hPro</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//HANDLE_FLAG_PROTECT_FROM_CLOSE：句柄不可用CloseHandle关闭
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">SetHandleInformation</span><span class="p">(</span><span class="n">hPro</span><span class="p">,</span> <span class="n">HANDLE_FLAG_PROTECT_FROM_CLOSE</span><span class="p">,</span> <span class="n">HANDLE_FLAG_PROTECT_FROM_CLOSE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>windbg中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; dq 0xe11cf000+640*2
</span></span><span class="line"><span class="cl">ReadVirtual: e11cfc80 not properly sign extended
</span></span><span class="line"><span class="cl">e11cfc80  02000002<span class="sb">`</span>85fcc00b 00000002<span class="sb">`</span>85fcc00b
</span></span><span class="line"><span class="cl">e11cfc90  00000002<span class="sb">`</span>85fcc00b 00000002<span class="sb">`</span>85fcc00b
</span></span><span class="line"><span class="cl">e11cfca0  00000002<span class="sb">`</span>85fcc00b 00000002<span class="sb">`</span>85fcc00b
</span></span><span class="line"><span class="cl">e11cfcb0  00000002<span class="sb">`</span>85fcc00b 00000002<span class="sb">`</span>85fcc00b
</span></span><span class="line"><span class="cl">e11cfcc0  00000002<span class="sb">`</span>85fcc00b 00000002<span class="sb">`</span>85fcc00b
</span></span><span class="line"><span class="cl">e11cfcd0  00000002<span class="sb">`</span>85fcc00b 00000002<span class="sb">`</span>85fcc00b
</span></span><span class="line"><span class="cl">e11cfce0  00000002<span class="sb">`</span>85fcc00b 00000002<span class="sb">`</span>85fcc00b
</span></span><span class="line"><span class="cl">e11cfcf0  00000002<span class="sb">`</span>85fcc00b 00000002<span class="sb">`</span>85fcc00b</span></span></code></pre></div><h4 id="根据句柄定位内核对象" class="heading-element"><span>根据句柄定位内核对象</span>
  <a href="#%e6%a0%b9%e6%8d%ae%e5%8f%a5%e6%9f%84%e5%ae%9a%e4%bd%8d%e5%86%85%e6%a0%b8%e5%af%b9%e8%b1%a1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>此时该地址指向<code>_OBJECT_HEADER</code>，想查看真正的内核对象结构体还要加上0x18</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">//根据句柄查找对应的结构体地址：
</span></span><span class="line"><span class="cl">/清理后三位bit，后四个字节为地址：85fcc008
</span></span><span class="line"><span class="cl">kd&gt; dt _EPROCESS  85fcc008+18
</span></span><span class="line"><span class="cl">nt_exe!_EPROCESS
</span></span><span class="line"><span class="cl">   ...
</span></span><span class="line"><span class="cl">   +0x174 ImageFileName    : <span class="o">[</span>16<span class="o">]</span>  <span class="s2">&#34;calc.exe&#34;</span>
</span></span><span class="line"><span class="cl">   ...</span></span></code></pre></div><h2 id="02-全局句柄表" class="heading-element"><span>02 全局句柄表</span>
  <a href="#02-%e5%85%a8%e5%b1%80%e5%8f%a5%e6%9f%84%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="全局句柄表" class="heading-element"><span>全局句柄表</span>
  <a href="#%e5%85%a8%e5%b1%80%e5%8f%a5%e6%9f%84%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ol>
<li>
<p>进程的句柄表是私有的，每个进程都有一个自己的句柄表。</p>
</li>
<li>
<p>除此之外，系统还有一个全局句柄表：<code>PsdCidTable</code> ，为 <strong>_HANDLE_TABLE</strong> 结构，所有的进程和线程无论无论是否打开，都在这个表中</p>
</li>
<li>
<p>每个进程和线程都有一个唯一的编号：<strong>PID</strong>和<strong>CID</strong> 这两个值其实就是全局句柄表中的索引</p>
</li>
<li>
<p>进程和线程的查询,主要是以下三个函数,按照给定的PID或CID从<code>PspCidTable</code>从查找相应的进线程对象：</p>
<ul>
<li><code>PsLookupProcessThreadByCid()</code></li>
<li><code>PsLookupProcessByProcessId()</code></li>
<li><code>PsLookupThreadByThreadId()</code></li>
</ul>
</li>
</ol>
<h3 id="全局句柄表结构" class="heading-element"><span>全局句柄表结构</span>
  <a href="#%e5%85%a8%e5%b1%80%e5%8f%a5%e6%9f%84%e8%a1%a8%e7%bb%93%e6%9e%84" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ol>
<li>若TableCode的低两位值为0，说明<code>handle_max = 4KB / 8 = 512</code>，此时，句柄表为一级句柄表</li>
<li>若打开句柄数量超过512个，TableCode的低两位值就会置为1，此时，句柄表变为两级句柄表。第一级句柄表中每个成员存储着第二级句柄表的地址，第二级句柄表中才真正存储着内核对象的地址，<code>handle_max = 1024 * 512</code></li>
<li>若打开句柄数量超过1024 * 512个，TableCode低两位的值就会置为2，此时，句柄表变为三级句柄表，第一级为地址，第二级也为地址，第三级才是句柄，<code>handle_max = 1024 * 1024 * 512</code></li>
<li>全局句柄表存储了所有 <code>EPROCESS</code> 和 <code>ETHREAD</code>。和进程的句柄表不同，全局句柄表项低32位指向的就是内核对象，而非 <code>OBJECT_HEADER</code>.</li>
</ol>
<p><img loading="lazy" src='/posts/2023-2-winkernel%E5%8F%A5%E6%9F%84%E8%A1%A8/image-20230219180656748.png' alt="image-20230219180656748" height="423" width="677"></p>
<h4 id="在windbg中查看全局句柄表" class="heading-element"><span>在WinDbg中查看全局句柄表</span>
  <a href="#%e5%9c%a8windbg%e4%b8%ad%e6%9f%a5%e7%9c%8b%e5%85%a8%e5%b1%80%e5%8f%a5%e6%9f%84%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>这里还是使用计算器举例：</p>
<p><img loading="lazy" src='/posts/2023-2-winkernel%E5%8F%A5%E6%9F%84%E8%A1%A8/image-20230219181053778.png' alt="image-20230219181053778" height="413" width="529"></p>
<p><strong>index = 1900 / 4 = 0x1DB</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; dd PspCidTable
</span></span><span class="line"><span class="cl">805649c0  e1003c58 <span class="m">00000002</span> <span class="m">00000000</span> <span class="m">00000000</span>
</span></span><span class="line"><span class="cl">805649d0  <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00000000</span>
</span></span><span class="line"><span class="cl">805649e0  <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00000000</span>
</span></span><span class="line"><span class="cl">805649f0  <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00000000</span>
</span></span><span class="line"><span class="cl">80564a00  <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00000000</span>
</span></span><span class="line"><span class="cl">80564a10  <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00000000</span>
</span></span><span class="line"><span class="cl">80564a20  <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00000000</span>
</span></span><span class="line"><span class="cl">80564a30  <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00000000</span>
</span></span><span class="line"><span class="cl">------------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">kd&gt; dt _HANDLE_TABLE e1003c58
</span></span><span class="line"><span class="cl">ntdll!_HANDLE_TABLE
</span></span><span class="line"><span class="cl">   +0x000 TableCode        : 0xe1005000
</span></span><span class="line"><span class="cl">   +0x004 QuotaProcess     : <span class="o">(</span>null<span class="o">)</span> 
</span></span><span class="line"><span class="cl">   +0x008 UniqueProcessId  : <span class="o">(</span>null<span class="o">)</span> 
</span></span><span class="line"><span class="cl">   +0x00c HandleTableLock  : <span class="o">[</span>4<span class="o">]</span> _EX_PUSH_LOCK
</span></span><span class="line"><span class="cl">   +0x01c HandleTableList  : _LIST_ENTRY <span class="o">[</span> 0xe1003c74 - 0xe1003c74 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x024 HandleContentionEvent : _EX_PUSH_LOCK
</span></span><span class="line"><span class="cl">   +0x028 DebugInfo        : <span class="o">(</span>null<span class="o">)</span> 
</span></span><span class="line"><span class="cl">   +0x02c ExtraInfoPages   : 0n0
</span></span><span class="line"><span class="cl">   +0x030 FirstFree        : 0x774
</span></span><span class="line"><span class="cl">   +0x034 LastFree         : 0x768
</span></span><span class="line"><span class="cl">   +0x038 NextHandleNeedingPool : 0x800
</span></span><span class="line"><span class="cl">   +0x03c HandleCount      : 0n253
</span></span><span class="line"><span class="cl">   +0x040 Flags            : <span class="m">1</span>
</span></span><span class="line"><span class="cl">   +0x040 StrictFIFO       : 0y1
</span></span><span class="line"><span class="cl">------------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">kd&gt; dq 0xe1005000+1DB*8
</span></span><span class="line"><span class="cl">ReadVirtual: e1005ed8 not properly sign extended
</span></span><span class="line"><span class="cl">e1005ed8  00000000<span class="sb">`</span>8632fda1 00000000<span class="sb">`</span>8632f989
</span></span><span class="line"><span class="cl">e1005ee8  00000778<span class="sb">`</span><span class="m">00000000</span> 0000077c<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">e1005ef8  00000780<span class="sb">`</span><span class="m">00000000</span> 0000078c<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">e1005f08  00000000<span class="sb">`</span>86475ce9 00000000<span class="sb">`</span>864756c1
</span></span><span class="line"><span class="cl">e1005f18  00000790<span class="sb">`</span><span class="m">00000000</span> 00000794<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">e1005f28  00000798<span class="sb">`</span><span class="m">00000000</span> 0000079c<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">e1005f38  000007a0<span class="sb">`</span><span class="m">00000000</span> 000007a4<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">e1005f48  000007a8<span class="sb">`</span><span class="m">00000000</span> 000007ac<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">------------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">kd&gt; dt _EPROCESS 8632fda0//全局句柄表直接指向内核对象，不用加0x18
</span></span><span class="line"><span class="cl">nt_exe!_EPROCESS
</span></span><span class="line"><span class="cl">   ...
</span></span><span class="line"><span class="cl">   +0x174 ImageFileName    : <span class="o">[</span>16<span class="o">]</span>  <span class="s2">&#34;calc.exe&#34;</span>
</span></span><span class="line"><span class="cl">   ...</span></span></code></pre></div><h3 id="遍历全局句柄表" class="heading-element"><span>遍历全局句柄表</span>
  <a href="#%e9%81%8d%e5%8e%86%e5%85%a8%e5%b1%80%e5%8f%a5%e6%9f%84%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><blockquote>
<p>编写程序，通过全局句柄表PsdCidTable，遍历所有进程(包括隐藏进程)。</p>
<p>打印全局句柄表中内核对象的所有类型</p>
<p>一、需要解决的问题：</p>
<p>1、如何通过找到全局句柄表?</p>
<p>2、如何判断是否是进程?</p>
<p>二、有用的系统函数：MmGetSystemRoutineAddress</p>
<p>这个函数用来得到导出函数的地址，优点是：</p>
<p>1、不会被IAT Hook影响(从内核模块导出表中找函数地址的)</p>
<p>2、有些内核函数虽然导出了 但并没有函数说明，无法直接使用</p></blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//#include &lt;ntddk.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1">//#include &lt;ntstatus.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##include &lt;ntifs.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//-----------------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">//-----------------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_LDR_DATA_TABLE_ENTRY</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">LIST_ENTRY</span> <span class="n">InLoadOrderLinks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LIST_ENTRY</span> <span class="n">InMemoryOrderLinks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LIST_ENTRY</span> <span class="n">InInitializationOrderLinks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PVOID</span> <span class="n">DllBase</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PVOID</span> <span class="n">EntryPoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">SizeOfImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">UNICODE_STRING</span> <span class="n">FullDllName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">UNICODE_STRING</span> <span class="n">BaseDllName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">Flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">UINT16</span> <span class="n">LoadCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">UINT16</span> <span class="n">TlsIndex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LIST_ENTRY</span> <span class="n">HashLinks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PVOID</span> <span class="n">SectionPointer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">CheckSum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">TimeDateStamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PVOID</span> <span class="n">LoadedImports</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PVOID</span> <span class="n">EntryPointActivationContext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PVOID</span> <span class="n">PatchInformation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">LDR_DATA_TABLE_ENTRY</span><span class="p">,</span> <span class="o">*</span><span class="n">PLDR_DATA_TABLE_ENTRY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_HANDLE_TABLE_ENTRY</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//  The pointer to the object overloaded with three ob attributes bits in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//  the lower order and the high bit to denote locked or unlocked entries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">union</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">PVOID</span> <span class="n">Object</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">ULONG</span> <span class="n">ObAttributes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// PHANDLE_TABLE_ENTRY_INFO InfoTable; // 用不到
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="n">ULONG_PTR</span> <span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//  This field either contains the granted access mask for the handle or an
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//  ob variation that also stores the same information.  Or in the case of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//  a free entry the field stores the index for the next free entry in the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//  free list.  This is like a FAT chain, and is used instead of pointers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//  to make table duplication easier, because the entries can just be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//  copied without needing to modify pointers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">union</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">union</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">ACCESS_MASK</span> <span class="n">GrantedAccess</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">struct</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="n">USHORT</span> <span class="n">GrantedAccessIndex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="n">USHORT</span> <span class="n">CreatorBackTraceIndex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">};</span>
</span></span><span class="line"><span class="cl">		<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LONG</span> <span class="n">NextFreeTableEntry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">HANDLE_TABLE_ENTRY</span><span class="p">,</span> <span class="o">*</span><span class="n">PHANDLE_TABLE_ENTRY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_OBJECT_TYPE</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ERESOURCE</span> <span class="n">Mutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LIST_ENTRY</span> <span class="n">TypeList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">UNICODE_STRING</span> <span class="n">Name</span><span class="p">;</span> <span class="c1">// Copy from object header for convenience
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						 <span class="c1">//	PVOID DefaultObject;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						 <span class="c1">//	ULONG Index;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						 <span class="c1">//	ULONG TotalNumberOfObjects;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						 <span class="c1">//	ULONG TotalNumberOfHandles;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						 <span class="c1">//	ULONG HighWaterNumberOfObjects;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						 <span class="c1">//	ULONG HighWaterNumberOfHandles;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						 <span class="c1">//	OBJECT_TYPE_INITIALIZER TypeInfo;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						 <span class="c1">// #ifdef POOL_TAGGING
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						 <span class="c1">//	ULONG Key;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						 <span class="c1">// #endif //POOL_TAGGING
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						 <span class="c1">//	ERESOURCE ObjectLocks[ OBJECT_LOCK_COUNT ];
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">OBJECT_TYPE</span><span class="p">,</span> <span class="o">*</span><span class="n">POBJECT_TYPE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_OBJECT_HEADER</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">LONG</span> <span class="n">PointerCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">union</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">LONG</span> <span class="n">HandleCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">PVOID</span> <span class="n">NextToFree</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">POBJECT_TYPE</span> <span class="n">Type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">UCHAR</span> <span class="n">NameInfoOffset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">UCHAR</span> <span class="n">HandleInfoOffset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">UCHAR</span> <span class="n">QuotaInfoOffset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">UCHAR</span> <span class="n">Flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">union</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// POBJECT_CREATE_INFORMATION ObjectCreateInfo;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">PVOID</span> <span class="n">ObjectCreateInfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">PVOID</span> <span class="n">QuotaBlockCharged</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">PSECURITY_DESCRIPTOR</span> <span class="n">SecurityDescriptor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">QUAD</span> <span class="n">Body</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">OBJECT_HEADER</span><span class="p">,</span> <span class="o">*</span><span class="n">POBJECT_HEADER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//-----------------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">//-----------------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">,</span> <span class="n">PUNICODE_STRING</span> <span class="n">reg_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//-----------------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">//-----------------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">ULONG</span> <span class="n">PspCidTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 驱动入口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">,</span> <span class="n">PUNICODE_STRING</span> <span class="n">reg_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">typedef</span> <span class="n">HANDLE_TABLE_ENTRY</span> <span class="o">*</span><span class="n">L1P</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">typedef</span> <span class="k">volatile</span> <span class="n">L1P</span> <span class="o">*</span><span class="n">L2P</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">typedef</span> <span class="k">volatile</span> <span class="n">L2P</span> <span class="o">*</span><span class="n">L3P</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">TableCode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">TableLevel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">L1P</span> <span class="n">TableLevel1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">L2P</span> <span class="n">TableLevel2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">L3P</span> <span class="n">TableLevel3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">UNICODE_STRING</span> <span class="n">ProcessString</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">UNICODE_STRING</span> <span class="n">ThreadString</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">HandleAddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PEPROCESS</span> <span class="n">pEprocess</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PCHAR</span> <span class="n">ImageFileName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">POBJECT_HEADER</span> <span class="n">pObjectHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 使用 MmGetSystemRoutineAddress 动态获取函数地址可以防 IAT hook
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//这里是用MmGetSystemRoutineAddress实现的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//https://www.cnblogs.com/wingsummer/p/15864867.html
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PspCidTable</span> <span class="o">=</span> <span class="o">**</span><span class="p">(</span><span class="n">PULONG</span> <span class="o">*</span><span class="p">)((</span><span class="n">ULONG</span><span class="p">)</span><span class="n">PsLookupProcessByProcessId</span> <span class="o">+</span> <span class="mi">26</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// DbgPrint(&#34;PspCidTable = %x\n&#34;,PspCidTable);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TableCode</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">PULONG</span><span class="p">)</span><span class="n">PspCidTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// DbgPrint(&#34;%x\n&#34;, TableCode);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TableLevel</span> <span class="o">=</span> <span class="n">TableCode</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span> <span class="c1">// 句柄表等级
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TableCode</span> <span class="o">=</span> <span class="n">TableCode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span> <span class="c1">// 清除等级标志位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;TableLevel = %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">TableLevel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;TableCode = %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">TableCode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ProcessString</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;Process&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ThreadString</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;Thread&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 要测试这个程序，可以创建一个进程，进程创建512个线程，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 这样全局句柄表的结构就是二级的，就会进入 case 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 如果想测试 case 2，要创建大于 1024 * 512 个内核对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">switch</span> <span class="p">(</span><span class="n">TableLevel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;一级句柄表...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">TableLevel1</span> <span class="o">=</span> <span class="p">(</span><span class="n">L1P</span><span class="p">)</span><span class="n">TableCode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">MmIsAddressValid</span><span class="p">(</span><span class="n">TableLevel1</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Object</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// DbgPrint(&#34;%x\n&#34;,TableLevel1[i].Object);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">HandleAddr</span> <span class="o">=</span> <span class="p">((</span><span class="n">ULONG</span><span class="p">)(</span><span class="n">TableLevel1</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Object</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="n">pObjectHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">POBJECT_HEADER</span><span class="p">)(</span><span class="n">HandleAddr</span> <span class="o">-</span> <span class="mh">0x18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="nf">RtlCompareUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pObjectHeader</span><span class="o">-&gt;</span><span class="n">Type</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ProcessString</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// DbgPrint(&#34;EPROCESS: %x\n&#34;, HandleAddr);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">pEprocess</span> <span class="o">=</span> <span class="p">(</span><span class="n">PEPROCESS</span><span class="p">)</span><span class="n">HandleAddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">					<span class="n">ImageFileName</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCHAR</span><span class="p">)</span><span class="n">pEprocess</span> <span class="o">+</span> <span class="mh">0x174</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">					<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;进程镜像名：%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ImageFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">RtlCompareUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pObjectHeader</span><span class="o">-&gt;</span><span class="n">Type</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThreadString</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">pEprocess</span> <span class="o">=</span> <span class="p">(</span><span class="n">PEPROCESS</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">PULONG</span><span class="p">)(</span><span class="n">HandleAddr</span> <span class="o">+</span> <span class="mh">0x220</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="n">ImageFileName</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCHAR</span><span class="p">)</span><span class="n">pEprocess</span> <span class="o">+</span> <span class="mh">0x174</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">					<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;----ETHREAD: %x, 所属进程：%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">HandleAddr</span><span class="p">,</span> <span class="n">ImageFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">else</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;既不是线程也不是进程 0x%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">HandleAddr</span><span class="p">);</span> <span class="c1">// 应该是不可能的...因为全局句柄表只存进程和线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;二级句柄表...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">TableLevel2</span> <span class="o">=</span> <span class="p">(</span><span class="n">L2P</span><span class="p">)</span><span class="n">TableCode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">MmIsAddressValid</span><span class="p">((</span><span class="n">PVOID</span><span class="p">)((</span><span class="n">PULONG</span><span class="p">)</span><span class="n">TableLevel2</span><span class="p">)[</span><span class="n">i</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="p">(</span><span class="nf">MmIsAddressValid</span><span class="p">(</span><span class="n">TableLevel2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">Object</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">					<span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="n">HandleAddr</span> <span class="o">=</span> <span class="p">((</span><span class="n">ULONG</span><span class="p">)(</span><span class="n">TableLevel2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">Object</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">						<span class="n">pObjectHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">POBJECT_HEADER</span><span class="p">)(</span><span class="n">HandleAddr</span> <span class="o">-</span> <span class="mh">0x18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">						<span class="k">if</span> <span class="p">(</span><span class="nf">RtlCompareUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pObjectHeader</span><span class="o">-&gt;</span><span class="n">Type</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ProcessString</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="c1">// DbgPrint(&#34;EPROCESS: %x\n&#34;, HandleAddr);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>							<span class="n">pEprocess</span> <span class="o">=</span> <span class="p">(</span><span class="n">PEPROCESS</span><span class="p">)</span><span class="n">HandleAddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">							<span class="n">ImageFileName</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCHAR</span><span class="p">)</span><span class="n">pEprocess</span> <span class="o">+</span> <span class="mh">0x174</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">							<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;进程镜像名：%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ImageFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">						<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">RtlCompareUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pObjectHeader</span><span class="o">-&gt;</span><span class="n">Type</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThreadString</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="n">pEprocess</span> <span class="o">=</span> <span class="p">(</span><span class="n">PEPROCESS</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">PULONG</span><span class="p">)(</span><span class="n">HandleAddr</span> <span class="o">+</span> <span class="mh">0x220</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">							<span class="n">ImageFileName</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCHAR</span><span class="p">)</span><span class="n">pEprocess</span> <span class="o">+</span> <span class="mh">0x174</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">							<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;----ETHREAD: %x, 所属进程：%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">HandleAddr</span><span class="p">,</span> <span class="n">ImageFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">						<span class="k">else</span>
</span></span><span class="line"><span class="cl">						<span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;既不是线程也不是进程 0x%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">HandleAddr</span><span class="p">);</span> <span class="c1">// 应该是不可能的...因为全局句柄表只存进程和线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;三级句柄表...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">TableLevel3</span> <span class="o">=</span> <span class="p">(</span><span class="n">L3P</span><span class="p">)</span><span class="n">TableCode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">MmIsAddressValid</span><span class="p">((</span><span class="n">PVOID</span><span class="p">)((</span><span class="n">PULONG</span><span class="p">)</span><span class="n">TableLevel3</span><span class="p">)[</span><span class="n">i</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="p">(</span><span class="nf">MmIsAddressValid</span><span class="p">((</span><span class="n">PVOID</span><span class="p">)((</span><span class="n">PULONG</span> <span class="o">*</span><span class="p">)</span><span class="n">TableLevel3</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">					<span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="k">if</span> <span class="p">(</span><span class="nf">MmIsAddressValid</span><span class="p">(</span><span class="n">TableLevel3</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">].</span><span class="n">Object</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">							<span class="p">{</span>
</span></span><span class="line"><span class="cl">								<span class="n">HandleAddr</span> <span class="o">=</span> <span class="p">((</span><span class="n">ULONG</span><span class="p">)(</span><span class="n">TableLevel3</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">].</span><span class="n">Object</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">								<span class="n">pObjectHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">POBJECT_HEADER</span><span class="p">)(</span><span class="n">HandleAddr</span> <span class="o">-</span> <span class="mh">0x18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">								<span class="k">if</span> <span class="p">(</span><span class="nf">RtlCompareUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pObjectHeader</span><span class="o">-&gt;</span><span class="n">Type</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ProcessString</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">								<span class="p">{</span>
</span></span><span class="line"><span class="cl">									<span class="c1">// DbgPrint(&#34;EPROCESS: %x\n&#34;, HandleAddr);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>									<span class="n">pEprocess</span> <span class="o">=</span> <span class="p">(</span><span class="n">PEPROCESS</span><span class="p">)</span><span class="n">HandleAddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">									<span class="n">ImageFileName</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCHAR</span><span class="p">)</span><span class="n">pEprocess</span> <span class="o">+</span> <span class="mh">0x174</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">									<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;进程镜像名：%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ImageFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">								<span class="p">}</span>
</span></span><span class="line"><span class="cl">								<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">RtlCompareUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pObjectHeader</span><span class="o">-&gt;</span><span class="n">Type</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThreadString</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">								<span class="p">{</span>
</span></span><span class="line"><span class="cl">									<span class="n">pEprocess</span> <span class="o">=</span> <span class="p">(</span><span class="n">PEPROCESS</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">PULONG</span><span class="p">)(</span><span class="n">HandleAddr</span> <span class="o">+</span> <span class="mh">0x220</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">									<span class="n">ImageFileName</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCHAR</span><span class="p">)</span><span class="n">pEprocess</span> <span class="o">+</span> <span class="mh">0x174</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">									<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;----ETHREAD: %x, 所属进程：%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">HandleAddr</span><span class="p">,</span> <span class="n">ImageFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">								<span class="p">}</span>
</span></span><span class="line"><span class="cl">								<span class="k">else</span>
</span></span><span class="line"><span class="cl">								<span class="p">{</span>
</span></span><span class="line"><span class="cl">									<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;既不是线程也不是进程 0x%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">HandleAddr</span><span class="p">);</span> <span class="c1">// 应该是不可能的...因为全局句柄表只存进程和线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>								<span class="p">}</span>
</span></span><span class="line"><span class="cl">							<span class="p">}</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">pDriver</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="n">DriverUnload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 卸载驱动
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">VOID</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;Driver unloaded.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ULONG</span> <span class="nf">GetHandleFromTable</span><span class="p">(</span><span class="n">ULONG</span> <span class="n">TableCode</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">Handle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p><img loading="lazy" src='/posts/2023-2-winkernel%E5%8F%A5%E6%9F%84%E8%A1%A8/image-20230219184646960.png' alt="image-20230219184646960" height="589" width="505"></p>
<p>找全局句柄表也可以这么写：</p>
<p>KPCR有一个成员，<strong>KdVersionBlock</strong>。这个成员非常奇妙，在他指向地址（+0x80）位置处有一个地址，这个地址指向的就是PspCidTable。</p>
<p>(当线程运行在R0下时, FS指向的段是GDT中的0x30段.该段的长度也为4K,基地址为0xFFDFF000.该地址指向系统的处理器控制区域（KPCR）)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">	<span class="n">PULONG</span> <span class="n">PspCidTable</span><span class="p">,</span> <span class="n">TableCode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PUCHAR</span> <span class="n">pEPROCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">_asm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="nl">fs</span><span class="p">:[</span><span class="mh">0x34</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">PspCidTable</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">TableCode</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span></span></span></code></pre></div><p><img loading="lazy" src='/posts/2023-2-winkernel%E5%8F%A5%E6%9F%84%E8%A1%A8/image-20230219190424244.png' alt="image-20230219190424244" height="828" width="712"></p>
<p>Ref：</p>
<blockquote>
<p><a href="https://drunkmars.top/2021/03/13/readme/"target="_blank" rel="external nofollow noopener noreferrer">https://drunkmars.top/2021/03/13/readme/</a></p>
<p><a href="https://cataloc.gitee.io/blog/2020/04/26/%E5%85%A8%E5%B1%80%E5%8F%A5%E6%9F%84%E8%A1%A8/"target="_blank" rel="external nofollow noopener noreferrer">https://cataloc.gitee.io/blog/2020/04/26/%E5%85%A8%E5%B1%80%E5%8F%A5%E6%9F%84%E8%A1%A8/</a></p>
<p><a href="https://blog.csdn.net/Kwansy/article/details/109853108"target="_blank" rel="external nofollow noopener noreferrer">https://blog.csdn.net/Kwansy/article/details/109853108</a></p>
<p><a href="https://www.cnblogs.com/wingsummer/p/15864867.html"target="_blank" rel="external nofollow noopener noreferrer">https://www.cnblogs.com/wingsummer/p/15864867.html</a></p></blockquote>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2023-02-19 00:00:00">Updated on 2023-02-19&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on X" data-sharer="twitter" data-url="https://nesl42.github.io/posts/2023-2-winkernel%E5%8F%A5%E6%9F%84%E8%A1%A8/" data-title="Windows内核(五)——句柄表" data-hashtags="Win32"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://nesl42.github.io/posts/2023-2-winkernel%E5%8F%A5%E6%9F%84%E8%A1%A8/" data-hashtag="Win32"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://nesl42.github.io/posts/2023-2-winkernel%E5%8F%A5%E6%9F%84%E8%A1%A8/" data-title="Windows内核(五)——句柄表"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/win32/" class="post-tag" title="Tags - Win32">Win32</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/" class="post-nav-item" rel="prev" title="Windows内核(四)——进程线程"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Windows内核(四)——进程线程</a><a href="/posts/2023-2-winkernel%E4%BA%8B%E4%BB%B6%E7%AD%89%E5%BE%85/" class="post-nav-item" rel="next" title="Windows内核(六)——事件等待">Windows内核(六)——事件等待<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.148.2"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.17-8212d6fd"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"version":"v0.3.17-8212d6fd"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
