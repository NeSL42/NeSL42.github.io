<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Windows内核(二)——驱动 - 敬渊&#39;s Blog</title><meta name="author" content="">
<meta name="description" content="[toc]
001.驱动开发环境配置 vs2010:https://learn.microsoft.com/zh-cn/visualstudio/releasenotes/vs2010-sp1-vs
"><meta name="keywords" content='Win32'>
  <meta itemprop="name" content="Windows内核(二)——驱动">
  <meta itemprop="description" content="[toc]
001.驱动开发环境配置 vs2010:https://learn.microsoft.com/zh-cn/visualstudio/releasenotes/vs2010-sp1-vs">
  <meta itemprop="datePublished" content="2023-01-18T00:00:00+00:00">
  <meta itemprop="dateModified" content="2023-01-18T00:00:00+00:00">
  <meta itemprop="wordCount" content="9387">
  <meta itemprop="keywords" content="Win32"><meta property="og:url" content="http://localhost:1313/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/">
  <meta property="og:site_name" content="敬渊&#39;s Blog">
  <meta property="og:title" content="Windows内核(二)——驱动">
  <meta property="og:description" content="[toc]
001.驱动开发环境配置 vs2010:https://learn.microsoft.com/zh-cn/visualstudio/releasenotes/vs2010-sp1-vs">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-01-18T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-01-18T00:00:00+00:00">
    <meta property="article:tag" content="Win32">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Windows内核(二)——驱动">
  <meta name="twitter:description" content="[toc]
001.驱动开发环境配置 vs2010:https://learn.microsoft.com/zh-cn/visualstudio/releasenotes/vs2010-sp1-vs">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/" title="Windows内核(二)——驱动 - 敬渊&#39;s Blog" /><link rel="prev" type="text/html" href="http://localhost:1313/posts/2023-1-winkernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" title="Windows内核(三)——系统调用" /><link rel="next" type="text/html" href="http://localhost:1313/posts/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" title="2022年终总结" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Windows内核(二)——驱动",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/posts\/2023-1-winkernel%E9%A9%B1%E5%8A%A8\/"
    },"genre": "posts","keywords": "Win32","wordcount":  9387 ,
    "url": "http:\/\/localhost:1313\/posts\/2023-1-winkernel%E9%A9%B1%E5%8A%A8\/","datePublished": "2023-01-18T00:00:00+00:00","dateModified": "2023-01-18T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Author"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/">文章</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/">标签</a></li><li class="menu-item">
              <a class="menu-link" href="/about/">关于</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/">分类</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="/posts/">文章</a></li><li class="menu-item"><a class="menu-link" href="/tags/">标签</a></li><li class="menu-item"><a class="menu-link" href="/about/">关于</a></li><li class="menu-item"><a class="menu-link" href="/categories/">分类</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Windows内核(二)——驱动</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="published on 2023-01-18 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-01-18">2023-01-18</time></span>&nbsp;<span title="9387 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 9400 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>19 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#001驱动开发环境配置">001.驱动开发环境配置</a></li>
        <li><a href="#002第一个驱动程序">002.第一个驱动程序</a></li>
        <li><a href="#003如何调试驱动程序">003.如何调试驱动程序</a></li>
        <li><a href="#004内核编程基础">004.内核编程基础</a>
          <ul>
            <li><a href="#未文档化函数与未导出函数">未文档化函数与未导出函数</a></li>
            <li><a href="#数据类型">数据类型</a></li>
            <li><a href="#返回值">返回值</a></li>
            <li><a href="#异常处理">异常处理</a></li>
            <li><a href="#常用的内核内存函数">常用的内核内存函数</a></li>
            <li><a href="#内核字符串及常用字符串函数">内核字符串及常用字符串函数</a></li>
          </ul>
        </li>
        <li><a href="#005内核空间与内核模块">005.内核空间与内核模块</a></li>
        <li><a href="#006r0与r3通信常规方式">006.r0与r3通信(常规方式)</a>
          <ul>
            <li><a href="#数据交互的方式">数据交互的方式</a></li>
            <li><a href="#device与">&ldquo;\\Device\\&ldquo;与“\\??\\”</a></li>
            <li><a href="#派遣函数格式">派遣函数格式</a></li>
            <li><a href="#0环与3环通信实验">0环与3环通信实验</a></li>
          </ul>
        </li>
        <li><a href="#设置派遣函数majorfunctionirp_mj_device_control指win32api调用deviceiocontrol时会执行">设置派遣函数：<code>MajorFunction</code>，<code>IRP_MJ_DEVICE_CONTROL</code>指win32api调用<code>DeviceIoControl</code>时会执行。</a>
          <ul>
            <li><a href="#代码">代码</a></li>
          </ul>
        </li>
        <li><a href="#007sstd-hook">007.SSTD Hook</a>
          <ul>
            <li><a href="#得到函数表的地址">得到函数表的地址</a></li>
            <li><a href="#ssdt-hook">SSDT Hook</a></li>
            <li><a href="#代码-1">代码</a></li>
          </ul>
        </li>
        <li><a href="#008inline-hook">008.Inline Hook</a>
          <ul>
            <li><a href="#实验13环inline-hook">实验1：3环Inline Hook</a></li>
            <li><a href="#实验20环inline-hook">实验2：0环Inline Hook</a></li>
          </ul>
        </li>
        <li><a href="#009多核同步之临界区">009.多核同步之临界区</a>
          <ul>
            <li><a href="#单行指令的同步">单行指令的同步</a>
              <ul>
                <li><a href="#lock指令">Lock指令</a></li>
                <li><a href="#interlockedincrement">InterlockedIncrement</a></li>
              </ul>
            </li>
            <li><a href="#多行指令的同步">多行指令的同步</a>
              <ul>
                <li><a href="#临界区">临界区</a></li>
                <li><a href="#自己实现临界区">自己实现临界区</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#010多核同步之自旋锁">010.多核同步之自旋锁</a>
          <ul>
            <li><a href="#keacquirespinlockatdpclevel">KeAcquireSpinLockAtDpcLevel</a></li>
            <li><a href="#思考题">思考题</a></li>
          </ul>
        </li>
        <li><a href="#011内核重载">011.内核重载</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>[toc]</p>
<h2 id="001驱动开发环境配置" class="heading-element"><span>001.驱动开发环境配置</span>
  <a href="#001%e9%a9%b1%e5%8a%a8%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>vs2010:https://learn.microsoft.com/zh-cn/visualstudio/releasenotes/vs2010-sp1-vs</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20221213184310074.png' alt="image-20221213184310074" height="620" width="1387"></p>
<p>wdk7600:https://www.microsoft.com/en-us/download/details.aspx?id=11800</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20221213184334246.png' alt="image-20221213184334246" height="481" width="1174"></p>
<p>添加项目属性表：</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230104160816744.png' alt="image-20230104160816744" height="295" width="456"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;Project</span> <span class="na">ToolsVersion=</span><span class="s">&#34;4.0&#34;</span> <span class="na">xmlns=</span><span class="s">&#34;http://schemas.microsoft.com/developer/msbuild/2003&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;ImportGroup</span> <span class="na">Label=</span><span class="s">&#34;PropertySheets&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;PropertyGroup</span> <span class="na">Label=</span><span class="s">&#34;UserMacros&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;PropertyGroup&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;ExecutablePath&gt;</span>D:\WinDDK\7600.16385.1\bin\x86;$(ExecutablePath)<span class="nt">&lt;/ExecutablePath&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/PropertyGroup&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;PropertyGroup&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;IncludePath&gt;</span>D:\WinDDK\7600.16385.1\inc\api;D:\WinDDK\7600.16385.1\inc\ddk;D:\WinDDK\7600.16385.1\inc\crt;$(IncludePath)<span class="nt">&lt;/IncludePath&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/PropertyGroup&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;PropertyGroup&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;LibraryPath&gt;</span>D:\WinDDK\7600.16385.1\lib\wxp\i386;$(LibraryPath)<span class="nt">&lt;/LibraryPath&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;TargetExt&gt;</span>.sys<span class="nt">&lt;/TargetExt&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;LinkIncremental&gt;</span>false<span class="nt">&lt;/LinkIncremental&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;GenerateManifest&gt;</span>false<span class="nt">&lt;/GenerateManifest&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/PropertyGroup&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;ItemDefinitionGroup&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;ClCompile&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;PreprocessorDefinitions&gt;</span>_X86_;DBG<span class="nt">&lt;/PreprocessorDefinitions&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;CallingConvention&gt;</span>StdCall<span class="nt">&lt;/CallingConvention&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ExceptionHandling&gt;</span>false<span class="nt">&lt;/ExceptionHandling&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;BasicRuntimeChecks&gt;</span>Default<span class="nt">&lt;/BasicRuntimeChecks&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;BufferSecurityCheck&gt;</span>false<span class="nt">&lt;/BufferSecurityCheck&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;CompileAs&gt;</span>Default<span class="nt">&lt;/CompileAs&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;DebugInformationFormat&gt;</span>ProgramDatabase<span class="nt">&lt;/DebugInformationFormat&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;AssemblerOutput&gt;</span>All<span class="nt">&lt;/AssemblerOutput&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/ClCompile&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Link&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;AdditionalDependencies&gt;</span>ntoskrnl.lib;wdm.lib;wdmsec.lib;wmilib.lib;ndis.lib;Hal.lib;MSVCRT.LIB;LIBCMT.LIB;%(AdditionalDependencies)<span class="nt">&lt;/AdditionalDependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Link&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Link&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;IgnoreAllDefaultLibraries&gt;</span>true<span class="nt">&lt;/IgnoreAllDefaultLibraries&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;EnableUAC&gt;</span>false<span class="nt">&lt;/EnableUAC&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;SubSystem&gt;</span>Native<span class="nt">&lt;/SubSystem&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;EntryPointSymbol&gt;</span>DriverEntry<span class="nt">&lt;/EntryPointSymbol&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;BaseAddress&gt;</span>0x10000<span class="nt">&lt;/BaseAddress&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;RandomizedBaseAddress&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/RandomizedBaseAddress&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;DataExecutionPrevention&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/DataExecutionPrevention&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;GenerateDebugInformation&gt;</span>true<span class="nt">&lt;/GenerateDebugInformation&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Driver&gt;</span>Driver<span class="nt">&lt;/Driver&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Link&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/ItemDefinitionGroup&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;ItemGroup</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/Project&gt;</span></span></span></code></pre></div><h2 id="002第一个驱动程序" class="heading-element"><span>002.第一个驱动程序</span>
  <a href="#002%e7%ac%ac%e4%b8%80%e4%b8%aa%e9%a9%b1%e5%8a%a8%e7%a8%8b%e5%ba%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>驱动开发流程：</p>
<blockquote>
<p>代码 =&gt; 生成sys文件 =&gt; 部署 =&gt; 启动 =&gt; 停止 =&gt; 卸载</p></blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;ntddk.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//卸载函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">VOID</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">driver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;启动程序运行了。</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//入口函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">driver</span><span class="p">,</span><span class="n">PUNICODE_STRING</span> <span class="n">RegistryPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;这里是入口点。</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="n">DriverUnload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>生成两个文件为驱动文件和调试文件：</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230104201904553.png' alt="image-20230104201904553" height="74" width="252"></p>
<p>之后在虚拟机里还需要两个软件：DebugView和KmdManager</p>
<p>DebugView在使用的时候要选择监视核心</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230104204933253.png' alt="image-20230104204933253" height="262" width="858"></p>
<h2 id="003如何调试驱动程序" class="heading-element"><span>003.如何调试驱动程序</span>
  <a href="#003%e5%a6%82%e4%bd%95%e8%b0%83%e8%af%95%e9%a9%b1%e5%8a%a8%e7%a8%8b%e5%ba%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>PDB文件：</p>
<blockquote>
<p>PDB文件是编译驱动的同时生成的调试信息文件，它可以帮助我们像调试应用程序一样调试驱动程序。其实之前我们已经使用过PDB，我们配置双机调试环境时，在物理机上安装了符号文件，并在windbg中导入过。</p>
<p>有了PDB，我们就可以知道当前汇编语句属于哪个函数，程序定义的结构体等关键信息，说一句题外话，软件发布的时候，切记不要把PDB也发布出去，因为这会给别人破解你的软件提供巨大便利。</p></blockquote>
<p>调试的话下个VirtualKD，之后将target目录放到虚拟机里，点击install(其实这步就是重新配了下环境)，物理机上点vmmon64，记得选windbg路径，重启虚拟机就ok了。</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230105122422110.png' alt="image-20230105122422110" height="895" width="1410"></p>
<p>之后在windbg的symbols里面加上：<code>E:\DriverLearn\_01HelloDriver\Driver</code></p>
<p>下断点的时候在代码里加上：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">	<span class="nf">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="err">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">int</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">			<span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl">			<span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl">			<span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl">	<span class="err">}</span></span></span></code></pre></div><p>这个就是最终界面了：</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230105123953034.png' alt="image-20230105123953034" height="800" width="1445"></p>
<h2 id="004内核编程基础" class="heading-element"><span>004.内核编程基础</span>
  <a href="#004%e5%86%85%e6%a0%b8%e7%bc%96%e7%a8%8b%e5%9f%ba%e7%a1%80" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>微软提供的内核专用API在<code>ntddk.h</code>这个头文件中</p>
<h3 id="未文档化函数与未导出函数" class="heading-element"><span>未文档化函数与未导出函数</span>
  <a href="#%e6%9c%aa%e6%96%87%e6%a1%a3%e5%8c%96%e5%87%bd%e6%95%b0%e4%b8%8e%e6%9c%aa%e5%af%bc%e5%87%ba%e5%87%bd%e6%95%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>未文档化函数与未导出函数：</p>
<ul>
<li>未文档化就是WDK文档里搜不到，但是在导出表里的函数，要使用这种函数可以使用GetProcAddress函数获取函数地址；</li>
<li>未导出函数就是不在导出表的函数，可以通过特征码搜索或者解析内核PDB的方式找到函数地址，通过函数指针调用。</li>
</ul>
<p>如果要使用未导出的函数，只要自己定义一个函数指针，并且为函数指针提供正确的函数地址就可以使用了。有两种办法都可以获取为导出的函数地址:</p>
<ol>
<li>特征码搜索</li>
<li>解析内核PDB文件</li>
</ol>
<h3 id="数据类型" class="heading-element"><span>数据类型</span>
  <a href="#%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>在ntdef.h中定义，习惯使用WDK自己的类型：</p>
<table>
  <thead>
      <tr>
          <th>通用类型</th>
          <th>wdk规范</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>unsigned long</td>
          <td>ULONG</td>
          <td>无符号长整形</td>
      </tr>
      <tr>
          <td>unsigned char</td>
          <td>UCHAR</td>
          <td>无符号字符型</td>
      </tr>
      <tr>
          <td>unisgned int</td>
          <td>UINT</td>
          <td>无符号整形</td>
      </tr>
      <tr>
          <td>void</td>
          <td>VOID</td>
          <td>无类型</td>
      </tr>
      <tr>
          <td>unsigned long*</td>
          <td>PULONG</td>
          <td>无符号长整形指针</td>
      </tr>
      <tr>
          <td>unsigned char*</td>
          <td>PUCHAR</td>
          <td>无符号字符型指针</td>
      </tr>
      <tr>
          <td>unsigned int*</td>
          <td>PUINT</td>
          <td>无符号整形指针</td>
      </tr>
      <tr>
          <td>void*</td>
          <td>PVOID</td>
          <td>无类型指针</td>
      </tr>
      <tr>
          <td>char*</td>
          <td>UNICODE_STRING</td>
          <td>字符串类型</td>
      </tr>
  </tbody>
</table>
<h3 id="返回值" class="heading-element"><span>返回值</span>
  <a href="#%e8%bf%94%e5%9b%9e%e5%80%bc" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>大部分内核函数返回值都是NTSTATUS类型，其实就是定义的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">STATUS_SUCCESS</span>				<span class="mh">0x00000000</span>	<span class="err">成功</span>		
</span></span><span class="line"><span class="cl"><span class="n">STATUS_INVALID_PARAMETER</span>	<span class="mh">0xC000000D</span>	<span class="err">参数无效</span>	
</span></span><span class="line"><span class="cl"><span class="n">STATUS_BUFFER_OVERFLOW</span>		<span class="mh">0x80000005</span>	<span class="err">缓冲区长度不够</span></span></span></code></pre></div><p>在ntstatus.h文件中定义</p>
<h3 id="异常处理" class="heading-element"><span>异常处理</span>
  <a href="#%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Windows提供了结构化异常处理机制，一般的编译器都是支持的，如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kr">__try</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//可能出错的代码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">__except</span><span class="p">(</span><span class="n">filter_value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//出错时要执行的代码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span></span></span></code></pre></div><p>出现异常时，可根据filter_value的值来决定程序该如果执行，当filter_value的值为：</p>
<ul>
<li>EXCEPTION_EXECUTE_HANDLER(1)，代码进入except块</li>
<li>EXCEPTION_CONTINUE_SEARCH(0)，不处理异常，由上一层调用函数处理</li>
<li>EXCEPTION_CONTINUE_EXECUTION(-1)，回去继续执行错误处的代码</li>
</ul>
<h3 id="常用的内核内存函数" class="heading-element"><span>常用的内核内存函数</span>
  <a href="#%e5%b8%b8%e7%94%a8%e7%9a%84%e5%86%85%e6%a0%b8%e5%86%85%e5%ad%98%e5%87%bd%e6%95%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><table>
  <thead>
      <tr>
          <th>C语言</th>
          <th>内核</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>malloc</td>
          <td>ExAllocatePool</td>
      </tr>
      <tr>
          <td>memset</td>
          <td>RtlFillMemory</td>
      </tr>
      <tr>
          <td>memcpy</td>
          <td>RtlMoveMemory</td>
      </tr>
      <tr>
          <td>free</td>
          <td>ExFreePool</td>
      </tr>
  </tbody>
</table>
<h3 id="内核字符串及常用字符串函数" class="heading-element"><span>内核字符串及常用字符串函数</span>
  <a href="#%e5%86%85%e6%a0%b8%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%8f%8a%e5%b8%b8%e7%94%a8%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%87%bd%e6%95%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>为了提高安全性，内核中的字符串不再是字符串首地址指针作为开始，0作为结尾，而是采用了以下两个结构体：</p>
<p><strong>ANSI_STRING字符串：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_STRING</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">USHORT</span> <span class="n">Length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">USHORT</span> <span class="n">MaximumLength</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PCHAR</span> <span class="n">Buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="n">STRING</span><span class="p">;</span></span></span></code></pre></div><p><strong>UNICODE_STRING字符串：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_UNICODE_STRING</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">USHORT</span> <span class="n">Length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">USHORT</span> <span class="n">MaxmumLength</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PWSTR</span> <span class="n">Buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">UNICODE_STRING</span><span class="p">;</span></span></span></code></pre></div><p>下面的表格列出了常用的字符串函数：</p>
<table>
  <thead>
      <tr>
          <th>功能</th>
          <th>ANSI_STRING字符串</th>
          <th>UNICODE_STRING字符串</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>创建</td>
          <td>RtlInitAnsiString</td>
          <td>RtlInitUnicodeString</td>
      </tr>
      <tr>
          <td>复制</td>
          <td>RtlCopyString</td>
          <td>RtlCopyUnicodeString</td>
      </tr>
      <tr>
          <td>比较</td>
          <td>RtlCompareString</td>
          <td>RtlCompareUnicoodeString</td>
      </tr>
      <tr>
          <td>转换</td>
          <td>RtlAnsiStringToUnicodeString</td>
          <td>RtlUnicodeStringToAnsiString</td>
      </tr>
  </tbody>
</table>
<h2 id="005内核空间与内核模块" class="heading-element"><span>005.内核空间与内核模块</span>
  <a href="#005%e5%86%85%e6%a0%b8%e7%a9%ba%e9%97%b4%e4%b8%8e%e5%86%85%e6%a0%b8%e6%a8%a1%e5%9d%97" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><pre tabindex="0"><code>!process 0 0 #查看所有程序
.process [dirbase]
dd 线性地址
dt _DRIVER_OBJECT #查看DRIVER_OBJECT结构体，注意要加杠</code></pre><p>查看DRIVER_OBJECT结构体：</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230105133925444.png' alt="image-20230105133925444" height="343" width="652"></p>
<p>写份代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//入口函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">driver</span><span class="p">,</span><span class="n">PUNICODE_STRING</span> <span class="n">RegistryPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;PDRIVER_OBJECT: %p %wZ</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">driver</span><span class="p">,</span><span class="n">RegistryPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="n">DriverUnload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>在windbg中查看这个驱动进程的 _DRIVER_OBJECT 结构体：</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230105134550612.png' alt="image-20230105134550612" height="353" width="1161"></p>
<p>其中的DriverSection，它实际上是 <code>_LDR_DATA_TABLE_ENTRY</code> 类型，它是一个链表的项，将所有驱动链在了一起</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230105134937086.png' alt="image-20230105134937086" height="402" width="712"></p>
<p>通过这个驱动查的时候第一个就是自己的驱动，</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230105135002493.png' alt="image-20230105135002493" height="400" width="1278"></p>
<p>可以一直往下查：</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230105135139857.png' alt="image-20230105135139857" height="406" width="879"></p>
<h2 id="006r0与r3通信常规方式" class="heading-element"><span>006.r0与r3通信(常规方式)</span>
  <a href="#006r0%e4%b8%8er3%e9%80%9a%e4%bf%a1%e5%b8%b8%e8%a7%84%e6%96%b9%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>常规方式也就是正常驱动开发的人是如何做的。</p>
<p>3环窗口程序中的MSG结构体和窗口对象，与0环的设备对象和IRP结构体的关系有点像；在窗口程序中，能够接收消息的只能是窗口对象。在内核中，能够接收IRP消息的只能是设备对象。</p>
<p>驱动程序原本的目的是用来控制硬件，但我们也可以用驱动做一些安全相关的事情，因为驱动运行在0环。为了控制驱动运行，我们需要在3环向驱动发数据，所以我们需要有一种方法来建立0环到3环的通信。本文介绍常规方式，也就是创建设备对象的方式。</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230105141141521.png' alt="image-20230105141141521" height="312" width="710"></p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230105143451165.png' alt="image-20230105143451165" height="382" width="968"></p>
<h3 id="数据交互的方式" class="heading-element"><span>数据交互的方式</span>
  <a href="#%e6%95%b0%e6%8d%ae%e4%ba%a4%e4%ba%92%e7%9a%84%e6%96%b9%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>主要有两种方式，数据量小，一般用拷贝缓冲区的方式(DO_BUFFERED_IO)；数据量大，一般用直接方式读写(DO_DIRECT_IO)。</p>
<ul>
<li>
<p>缓冲区方式读写(DO_BUFFERED_IO) ：操作系统将应用程序提供缓冲区的数据复制到内核模式下的地址中。</p>
</li>
<li>
<p>直接方式读写(DO_DIRECT_IO) ：操作系统会将用户模式下的缓冲区锁住。然后操作系统将这段缓冲区在内核模式地址再次映射一遍。这样，用户模式的缓冲区和内核模式的缓冲区指向的是同一区域的物理内存。缺点就是要单独占用物理页面。</p>
</li>
</ul>
<p>推荐使用以上两种，当然还有其他的。</p>
<h3 id="device与" class="heading-element"><span>&ldquo;\\Device\\&ldquo;与“\\??\\”</span>
  <a href="#device%e4%b8%8e" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>注意设备名和符号链接名：</p>
<ul>
<li>
<p>设备名：r0使用，开头是&rdquo;\\Device\\&rdquo;</p>
</li>
<li>
<p>符号链接名：r3使用，</p>
<ul>
<li>内核模式下开头是：<code>\\??\\</code></li>
<li>用户模式下开头是：<code>\\.\</code>，加上转义就是：<code>\\\\.\\</code></li>
</ul>
</li>
</ul>
<h3 id="派遣函数格式" class="heading-element"><span>派遣函数格式</span>
  <a href="#%e6%b4%be%e9%81%a3%e5%87%bd%e6%95%b0%e6%a0%bc%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="nf">functionName</span><span class="p">(</span><span class="n">PDEVICE_OBJECT</span> <span class="n">pDeviceObject</span><span class="p">,</span> <span class="n">PIRP</span> <span class="n">pIrp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//业务代码区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">//设置返回状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pIrp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span><span class="c1">//getLastError()得到的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pIrp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Information</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>            <span class="c1">//返回给3环多少数据，没有填0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">IoCompleteRequest</span><span class="p">(</span><span class="n">pIrp</span><span class="p">,</span> <span class="n">IO_NO_INCREMENT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h3 id="0环与3环通信实验" class="heading-element"><span>0环与3环通信实验</span>
  <a href="#0%e7%8e%af%e4%b8%8e3%e7%8e%af%e9%80%9a%e4%bf%a1%e5%ae%9e%e9%aa%8c" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>步骤：</p>
<p>R0：</p>
<ul>
<li>创建设备：<code>IoCreateDevice</code></li>
<li>设置交互数据的方式</li>
<li>创建符号链接：<code>IoCreateSymbolicLink</code></li>
<li>
<h2 id="设置派遣函数majorfunctionirp_mj_device_control指win32api调用deviceiocontrol时会执行" class="heading-element"><span>设置派遣函数：<code>MajorFunction</code>，<code>IRP_MJ_DEVICE_CONTROL</code>指win32api调用<code>DeviceIoControl</code>时会执行。</span>
  <a href="#%e8%ae%be%e7%bd%ae%e6%b4%be%e9%81%a3%e5%87%bd%e6%95%b0majorfunctionirp_mj_device_control%e6%8c%87win32api%e8%b0%83%e7%94%a8deviceiocontrol%e6%97%b6%e4%bc%9a%e6%89%a7%e8%a1%8c" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2></li>
<li>派遣函数中：
<ul>
<li>获取IRP数据：<code>IoGetCurrentIrpStackLocation</code></li>
<li>获取控制码</li>
<li>获取缓冲区地址</li>
<li>读写</li>
<li>设置状态</li>
</ul>
</li>
</ul>
<p>R3：</p>
<ul>
<li>获取设备句柄：<code>CreateFileW</code></li>
<li>使用<code>DeviceIoControl</code>通信</li>
</ul>
<h3 id="代码" class="heading-element"><span>代码</span>
  <a href="#%e4%bb%a3%e7%a0%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;ntddk.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 设备名，0环用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##define DEVICE_NAME L&#34;\\Device\\HbgDev&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// 符号链接名，3环用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##define SYMBOLICLINK_NAME L&#34;\\??\\HbgDevLnk&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">##define OPER1 CTL_CODE(FILE_DEVICE_UNKNOWN,0x800,METHOD_BUFFERED,FILE_ANY_ACCESS)
</span></span></span><span class="line"><span class="cl"><span class="cp">##define OPER2 CTL_CODE(FILE_DEVICE_UNKNOWN,0x900,METHOD_BUFFERED,FILE_ANY_ACCESS)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 函数声明
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">,</span> <span class="n">PUNICODE_STRING</span> <span class="n">RegPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="nf">IrpCreateProc</span><span class="p">(</span><span class="n">PDEVICE_OBJECT</span> <span class="n">pDevObj</span><span class="p">,</span> <span class="n">PIRP</span> <span class="n">pIrp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="nf">IrpCloseProc</span><span class="p">(</span><span class="n">PDEVICE_OBJECT</span> <span class="n">pDevObj</span><span class="p">,</span> <span class="n">PIRP</span> <span class="n">pIrp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="nf">IrpDeviceControlProc</span><span class="p">(</span><span class="n">PDEVICE_OBJECT</span> <span class="n">pDevObj</span><span class="p">,</span> <span class="n">PIRP</span> <span class="n">pIrp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 入口函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">,</span> <span class="n">PUNICODE_STRING</span> <span class="n">RegPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">NTSTATUS</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">uIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PDEVICE_OBJECT</span> <span class="n">pDeviceObj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="c1">// 设备对象指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="n">UNICODE_STRING</span> <span class="n">DeviceName</span><span class="p">;</span> <span class="c1">// 设备名，0环用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">UNICODE_STRING</span> <span class="n">SymbolicLinkName</span><span class="p">;</span> <span class="c1">// 符号链接名，3环用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	
</span></span><span class="line"><span class="cl">	<span class="c1">// 创建设备名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DeviceName</span><span class="p">,</span><span class="n">DEVICE_NAME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 创建设备
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">status</span> <span class="o">=</span> <span class="nf">IoCreateDevice</span><span class="p">(</span><span class="n">pDriver</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">DeviceName</span><span class="p">,</span><span class="n">FILE_DEVICE_UNKNOWN</span><span class="p">,</span><span class="n">FILE_DEVICE_SECURE_OPEN</span><span class="p">,</span><span class="n">FALSE</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pDeviceObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">IoDeleteDevice</span><span class="p">(</span><span class="n">pDeviceObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;创建设备失败.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;创建设备成功.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 设置交互数据的方式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pDeviceObj</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">|=</span> <span class="n">DO_BUFFERED_IO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 创建符号链接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SymbolicLinkName</span><span class="p">,</span> <span class="n">SYMBOLICLINK_NAME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">IoCreateSymbolicLink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SymbolicLinkName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DeviceName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 设置分发函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pDriver</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">IRP_MJ_CREATE</span><span class="p">]</span> <span class="o">=</span> <span class="n">IrpCreateProc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">pDriver</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">IRP_MJ_CLOSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">IrpCloseProc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">pDriver</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">IRP_MJ_DEVICE_CONTROL</span><span class="p">]</span> <span class="o">=</span> <span class="n">IrpDeviceControlProc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 设置卸载函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pDriver</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="n">DriverUnload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 卸载驱动
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">VOID</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">UNICODE_STRING</span> <span class="n">SymbolicLinkName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 删除符号链接，删除设备
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SymbolicLinkName</span><span class="p">,</span> <span class="n">SYMBOLICLINK_NAME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">IoDeleteSymbolicLink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SymbolicLinkName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">IoDeleteDevice</span><span class="p">(</span><span class="n">pDriver</span><span class="o">-&gt;</span><span class="n">DeviceObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;驱动卸载成功</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 不设置这个函数，则Ring3调用CreateFile会返回1
</span></span></span><span class="line"><span class="cl"><span class="c1">// IRP_MJ_CREATE 处理函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NTSTATUS</span> <span class="nf">IrpCreateProc</span><span class="p">(</span><span class="n">PDEVICE_OBJECT</span> <span class="n">pDevObj</span><span class="p">,</span> <span class="n">PIRP</span> <span class="n">pIrp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;应用层连接设备.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 返回状态如果不设置，Ring3返回值是失败
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pIrp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">pIrp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Information</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">IoCompleteRequest</span><span class="p">(</span><span class="n">pIrp</span><span class="p">,</span> <span class="n">IO_NO_INCREMENT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// IRP_MJ_CLOSE 处理函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NTSTATUS</span> <span class="nf">IrpCloseProc</span><span class="p">(</span><span class="n">PDEVICE_OBJECT</span> <span class="n">pDevObj</span><span class="p">,</span> <span class="n">PIRP</span> <span class="n">pIrp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;应用层断开连接设备.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 返回状态如果不设置，Ring3返回值是失败
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pIrp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">pIrp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Information</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">IoCompleteRequest</span><span class="p">(</span><span class="n">pIrp</span><span class="p">,</span> <span class="n">IO_NO_INCREMENT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// IRP_MJ_DEVICE_CONTROL 处理函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NTSTATUS</span> <span class="nf">IrpDeviceControlProc</span><span class="p">(</span><span class="n">PDEVICE_OBJECT</span> <span class="n">pDevObj</span><span class="p">,</span> <span class="n">PIRP</span> <span class="n">pIrp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// DbgPrint(&#34;IrpDeviceControlProc.\n&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">NTSTATUS</span> <span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_INVALID_DEVICE_REQUEST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PIO_STACK_LOCATION</span> <span class="n">pIrpStack</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">uIoControlCode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PVOID</span> <span class="n">pIoBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">uInLength</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">uOutLength</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">uRead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">uWrite</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// 设置临时变量的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">uRead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">uWrite</span> <span class="o">=</span> <span class="mh">0x12345678</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 获取IRP数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pIrpStack</span> <span class="o">=</span> <span class="nf">IoGetCurrentIrpStackLocation</span><span class="p">(</span><span class="n">pIrp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 获取控制码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">uIoControlCode</span> <span class="o">=</span> <span class="n">pIrpStack</span><span class="o">-&gt;</span><span class="n">Parameters</span><span class="p">.</span><span class="n">DeviceIoControl</span><span class="p">.</span><span class="n">IoControlCode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 获取缓冲区地址（输入输出是同一个）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pIoBuffer</span> <span class="o">=</span> <span class="n">pIrp</span><span class="o">-&gt;</span><span class="n">AssociatedIrp</span><span class="p">.</span><span class="n">SystemBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ring3 发送数据的长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">uInLength</span> <span class="o">=</span> <span class="n">pIrpStack</span><span class="o">-&gt;</span><span class="n">Parameters</span><span class="p">.</span><span class="n">DeviceIoControl</span><span class="p">.</span><span class="n">InputBufferLength</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ring0 发送数据的长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">uOutLength</span> <span class="o">=</span> <span class="n">pIrpStack</span><span class="o">-&gt;</span><span class="n">Parameters</span><span class="p">.</span><span class="n">DeviceIoControl</span><span class="p">.</span><span class="n">OutputBufferLength</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="p">(</span><span class="n">uIoControlCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">OPER1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;IrpDeviceControlProc -&gt; OPER1...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">pIrp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Information</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">OPER2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;IrpDeviceControlProc -&gt; OPER2 输入字节数: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">uInLength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;IrpDeviceControlProc -&gt; OPER2 输出字节数: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">uOutLength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 读取缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uRead</span><span class="p">,</span><span class="n">pIoBuffer</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;IrpDeviceControlProc -&gt; OPER2 uRead: %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">uRead</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 写入缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">memcpy</span><span class="p">(</span><span class="n">pIoBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uWrite</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 设置状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">pIrp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Information</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// 返回两字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 返回状态如果不设置，Ring3返回值是失败
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pIrp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">IoCompleteRequest</span><span class="p">(</span><span class="n">pIrp</span><span class="p">,</span> <span class="n">IO_NO_INCREMENT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>应用程序代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;winioctl.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##define SYMBOLICLINK_NAME L&#34;\\\\.\\HbgDevLnk&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">##define OPER1 CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)
</span></span></span><span class="line"><span class="cl"><span class="cp">##define OPER2 CTL_CODE(FILE_DEVICE_UNKNOWN, 0x900, METHOD_BUFFERED, FILE_ANY_ACCESS)
</span></span></span><span class="line"><span class="cl"><span class="cp">##define IN_BUFFER_MAXLENGTH 4
</span></span></span><span class="line"><span class="cl"><span class="cp">##define OUT_BUFFER_MAXLENGTH 4
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取设备句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="nf">CreateFileW</span><span class="p">(</span><span class="n">SYMBOLICLINK_NAME</span><span class="p">,</span> <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="n">FILE_ATTRIBUTE_READONLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">dwError</span> <span class="o">=</span> <span class="nf">GetLastError</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hDevice</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;获取设备句柄失败 %d.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">dwError</span><span class="p">);</span> <span class="c1">// 如果返回1，请在驱动中指定 IRP_MJ_CREATE 处理函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;获取设备句柄成功.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 测试通信
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">dwInBuffer</span> <span class="o">=</span> <span class="mh">0x11111111</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">dwOutBuffer</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">dwOut</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="n">OPER2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwInBuffer</span><span class="p">,</span> <span class="n">IN_BUFFER_MAXLENGTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOutBuffer</span><span class="p">,</span> <span class="n">OUT_BUFFER_MAXLENGTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOut</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;dwOutBuffer: %08X dwOut: %08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">dwOutBuffer</span><span class="p">,</span> <span class="n">dwOut</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CloseHandle</span><span class="p">(</span><span class="n">hDevice</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>可以看到r0和r3成功建立通信：</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230105213719638.png' alt="image-20230105213719638" height="138" width="872"></p>
<h2 id="007sstd-hook" class="heading-element"><span>007.SSTD Hook</span>
  <a href="#007sstd-hook" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>SSDT 的全称是 System Services Descriptor Table，系统服务描述符表。这个表就是一个把 Ring3 的 Win32 API 和 Ring0 的内核 API 联系起来。</p>
<p>前者有 ntoskrnl.exe 导出,后者由 Win32k.sys 导出。</p>
<hr>
<p>SSDT  的全称是 System Services Descriptor Table，系统服务描述符表</p>
<blockquote>
<p>kd&gt; dd  KeServiceDescriptorTable(SSDT)</p></blockquote>
<p>导出的 声明一下就可以使用了</p>
<blockquote>
<p>kd&gt; dd  KeServiceDescriptorTableShadow(SSDT Shadow)</p></blockquote>
<p>未导出 需要用其他的方式来查找</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230107230553238.png' alt="image-20230107230553238" height="570" width="955"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// 系统服务表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_KSYSTEM_SERVICE_TABLE</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">PULONG</span> <span class="n">ServiceTableBase</span><span class="p">;</span>			<span class="c1">// 函数地址表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PULONG</span> <span class="n">ServiceCounterTableBase</span><span class="p">;</span>		<span class="c1">// SSDT 函数被调用的次数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ULONG</span> <span class="n">NumberOfService</span><span class="p">;</span>				<span class="c1">// 函数个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PULONG</span> <span class="n">ParamTableBase</span><span class="p">;</span>				<span class="c1">// 函数参数表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">KSYSTEM_SERVICE_TABLE</span><span class="p">,</span> <span class="o">*</span><span class="n">PKSYSTEM_SERVICE_TABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SSDT表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_KSERVICE_TABLE_DESCRIPTOR</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">KSYSTEM_SERVICE_TABLE</span> <span class="n">ntoskrnl</span><span class="p">;</span>		<span class="c1">// 内核函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">KSYSTEM_SERVICE_TABLE</span> <span class="n">win32k</span><span class="p">;</span>		<span class="c1">// win32k.sys 函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">KSYSTEM_SERVICE_TABLE</span> <span class="n">unUsed1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">KSYSTEM_SERVICE_TABLE</span> <span class="n">unUsed2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">KSERVICE_TABLE_DESCRIPTOR</span><span class="p">,</span> <span class="o">*</span><span class="n">PKSERVICE_TABLE_DESCRIPTOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 内核导出的全局变量
</span></span></span><span class="line"><span class="cl"><span class="c1">// 导出由ntoskrnl所导出的SSDT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="n">PKSERVICE_TABLE_DESCRIPTOR</span> <span class="n">KeServiceDescriptorTable</span><span class="p">;</span> 
</span></span></code></pre></div><h3 id="得到函数表的地址" class="heading-element"><span>得到函数表的地址</span>
  <a href="#%e5%be%97%e5%88%b0%e5%87%bd%e6%95%b0%e8%a1%a8%e7%9a%84%e5%9c%b0%e5%9d%80" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;ntddk.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;ntstatus.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 系统服务表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_KSYSTEM_SERVICE_TABLE</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PULONG</span> <span class="n">ServiceTableBase</span><span class="p">;</span>        <span class="c1">// 函数地址表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PULONG</span> <span class="n">ServiceCounterTableBase</span><span class="p">;</span> <span class="c1">// SSDT 函数被调用的次数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONG</span> <span class="n">NumberOfService</span><span class="p">;</span>          <span class="c1">// 函数个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PULONG</span> <span class="n">ParamTableBase</span><span class="p">;</span>          <span class="c1">// 函数参数表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">KSYSTEM_SERVICE_TABLE</span><span class="p">,</span> <span class="o">*</span><span class="n">PKSYSTEM_SERVICE_TABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SSDT表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_KSERVICE_TABLE_DESCRIPTOR</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">KSYSTEM_SERVICE_TABLE</span> <span class="n">ntoskrnl</span><span class="p">;</span> <span class="c1">// 内核函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">KSYSTEM_SERVICE_TABLE</span> <span class="n">win32k</span><span class="p">;</span>   <span class="c1">// win32k.sys 函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">KSYSTEM_SERVICE_TABLE</span> <span class="n">unUsed1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">KSYSTEM_SERVICE_TABLE</span> <span class="n">unUsed2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">KSERVICE_TABLE_DESCRIPTOR</span><span class="p">,</span> <span class="o">*</span><span class="n">PKSERVICE_TABLE_DESCRIPTOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 内核导出的全局变量
</span></span></span><span class="line"><span class="cl"><span class="c1">// 导出由ntoskrnl所导出的SSDT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="n">PKSERVICE_TABLE_DESCRIPTOR</span> <span class="n">KeServiceDescriptorTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">,</span> <span class="n">PUNICODE_STRING</span> <span class="n">reg_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">,</span> <span class="n">PUNICODE_STRING</span> <span class="n">reg_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;--%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">KeServiceDescriptorTable</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pDriver</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="n">DriverUnload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;Driver unloaded.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>运行：</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230117144628641.png' alt="image-20230117144628641" height="285" width="773"></p>
<p>可以看到是没问题的：</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230117144735160.png' alt="image-20230117144735160" height="218" width="603"></p>
<h3 id="ssdt-hook" class="heading-element"><span>SSDT Hook</span>
  <a href="#ssdt-hook" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>其实就是再写一份函数代替上面的函数表里的函数</p>
<p>这里使用修改<code>NtOpenProcess</code>这个函数。</p>
<p>跟IDA可以知道是<code>0x7A</code>的位置，so：</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230117145313399.png' alt="image-20230117145313399" height="646" width="1033"></p>
<p>在改之前还需要改一下页的属性：</p>
<p>SSDT所在的物理页是只读的，如果要修改，先要修改页属性为可写，可以直接通过页表基址修改：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="n">RCR4</span> <span class="o">&amp;</span> <span class="mh">0x00000020</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="c1">//说明是2-9-9-12分页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;2-9-9-12分页 %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">RCR4</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;PTE1 %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="mh">0xC0000000</span> <span class="o">+</span> <span class="p">((</span><span class="n">HookFunAddr</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x007FFFF8</span><span class="p">))));</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD64</span><span class="o">*</span><span class="p">)(</span><span class="mh">0xC0000000</span> <span class="o">+</span> <span class="p">((</span><span class="n">HookFunAddr</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x007FFFF8</span><span class="p">))</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">	<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;PTE1 %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="mh">0xC0000000</span> <span class="o">+</span> <span class="p">((</span><span class="n">HookFunAddr</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x007FFFF8</span><span class="p">))));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="c1">//说明是10-10-12分页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;10-10-12分页</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;PTE1 %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="mh">0xC0000000</span> <span class="o">+</span> <span class="p">((</span><span class="n">HookFunAddr</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x003FFFFC</span><span class="p">))));</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="mh">0xC0000000</span> <span class="o">+</span> <span class="p">((</span><span class="n">HookFunAddr</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x003FFFFC</span><span class="p">))</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;PTE2 %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="mh">0xC0000000</span> <span class="o">+</span> <span class="p">((</span><span class="n">HookFunAddr</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x003FFFFC</span><span class="p">))));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>还有一种方法，就是修改CR0寄存器，CR0寄存器的第16位叫做保护属性位，控制着页的读或写属性。</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230117145749081.png' alt="image-20230117145749081" height="113" width="788"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">PageProtectOn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">mov</span>  <span class="n">eax</span><span class="p">,</span><span class="n">cr0</span>
</span></span><span class="line"><span class="cl">			<span class="n">or</span>   <span class="n">eax</span><span class="p">,</span><span class="mi">10000</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">			<span class="n">mov</span>  <span class="n">cr0</span><span class="p">,</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">			<span class="n">sti</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">PageProtectOff</span><span class="p">()</span>				
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">cli</span>					
</span></span><span class="line"><span class="cl">			<span class="n">mov</span>  <span class="n">eax</span><span class="p">,</span><span class="n">cr0</span>
</span></span><span class="line"><span class="cl">			<span class="n">and</span>  <span class="n">eax</span><span class="p">,</span><span class="n">not</span> <span class="mi">10000</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">			<span class="n">mov</span>  <span class="n">cr0</span><span class="p">,</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>这里要注意无论是通过页改的还是通过寄存器改的最后都要改回来。</p>
<h3 id="代码-1" class="heading-element"><span>代码</span>
  <a href="#%e4%bb%a3%e7%a0%81-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>就是简单将<code>OpenProcess</code>的参数打印出来。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;ntddk.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;ntstatus.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/************************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 类型声明                                                             */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/************************************************************************/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 系统服务表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_KSYSTEM_SERVICE_TABLE</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PULONG</span> <span class="n">ServiceTableBase</span><span class="p">;</span>        <span class="c1">// 函数地址表（SSDT）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PULONG</span> <span class="n">ServiceCounterTableBase</span><span class="p">;</span> <span class="c1">// SSDT 函数被调用的次数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONG</span> <span class="n">NumberOfService</span><span class="p">;</span>          <span class="c1">// 函数个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PULONG</span> <span class="n">ParamTableBase</span><span class="p">;</span>          <span class="c1">// 函数参数表（SSPT）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">KSYSTEM_SERVICE_TABLE</span><span class="p">,</span> <span class="o">*</span><span class="n">PKSYSTEM_SERVICE_TABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_KSERVICE_TABLE_DESCRIPTOR</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">KSYSTEM_SERVICE_TABLE</span> <span class="n">ntoskrnl</span><span class="p">;</span> <span class="c1">// 内核函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">KSYSTEM_SERVICE_TABLE</span> <span class="n">win32k</span><span class="p">;</span>   <span class="c1">// win32k.sys 函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">KSYSTEM_SERVICE_TABLE</span> <span class="n">unUsed1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">KSYSTEM_SERVICE_TABLE</span> <span class="n">unUsed2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">KSERVICE_TABLE_DESCRIPTOR</span><span class="p">,</span> <span class="o">*</span><span class="n">PKSERVICE_TABLE_DESCRIPTOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// NTOPENPROCESS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="o">*</span><span class="n">NTOPENPROCESS</span><span class="p">)(</span><span class="n">PHANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span> <span class="n">POBJECT_ATTRIBUTES</span> <span class="n">ObjectAttributes</span><span class="p">,</span> <span class="n">PCLIENT_ID</span> <span class="n">ClientId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/************************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 函数声明                                                             */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/************************************************************************/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">,</span> <span class="n">PUNICODE_STRING</span> <span class="n">reg_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">PageProtectOff</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">PageProtectOn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">HookNtOpenProcess</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">UnHookNtOpenProcess</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="nf">HbgNtOpenProcess</span><span class="p">(</span><span class="n">PHANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span> <span class="n">POBJECT_ATTRIBUTES</span> <span class="n">ObjectAttributes</span><span class="p">,</span> <span class="n">PCLIENT_ID</span> <span class="n">ClientId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/************************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 全局变量                                                             */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/************************************************************************/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">PKSERVICE_TABLE_DESCRIPTOR</span> <span class="n">KeServiceDescriptorTable</span><span class="p">;</span> <span class="c1">// ntoskrnl.exe 导出的全局变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ULONG</span> <span class="n">uOldNtOpenProcess</span><span class="p">;</span>                                    <span class="c1">// 旧的函数地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/************************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 函数定义                                                             */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/************************************************************************/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 驱动入口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">,</span> <span class="n">PUNICODE_STRING</span> <span class="n">reg_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// HOOK
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">HookNtOpenProcess</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pDriver</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="n">DriverUnload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 卸载驱动
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">VOID</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">UnHookNtOpenProcess</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;Driver unloaded.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 关闭页保护
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">VOID</span> <span class="nf">PageProtectOff</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">cli</span><span class="p">;</span> <span class="c1">// 关闭中断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">cr0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">and</span> <span class="n">eax</span><span class="p">,</span> <span class="n">not</span> <span class="mh">0x10000</span><span class="p">;</span> <span class="c1">// WP位置0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">cr0</span><span class="p">,</span> <span class="n">eax</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 开启页保护
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">VOID</span> <span class="nf">PageProtectOn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">cr0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">or</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">;</span> <span class="c1">// WP位置1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">cr0</span><span class="p">,</span> <span class="n">eax</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">sti</span><span class="p">;</span> <span class="c1">// 恢复中断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HOOK NtOpenProcess
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">VOID</span> <span class="nf">HookNtOpenProcess</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">PageProtectOff</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">uOldNtOpenProcess</span> <span class="o">=</span> <span class="n">KeServiceDescriptorTable</span><span class="o">-&gt;</span><span class="n">ntoskrnl</span><span class="p">.</span><span class="n">ServiceTableBase</span><span class="p">[</span><span class="mh">0x7A</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">KeServiceDescriptorTable</span><span class="o">-&gt;</span><span class="n">ntoskrnl</span><span class="p">.</span><span class="n">ServiceTableBase</span><span class="p">[</span><span class="mh">0x7A</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="n">HbgNtOpenProcess</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">PageProtectOn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// UnHOOK NtOpenProcess
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">VOID</span> <span class="nf">UnHookNtOpenProcess</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">PageProtectOff</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">KeServiceDescriptorTable</span><span class="o">-&gt;</span><span class="n">ntoskrnl</span><span class="p">.</span><span class="n">ServiceTableBase</span><span class="p">[</span><span class="mh">0x7A</span><span class="p">]</span> <span class="o">=</span> <span class="n">uOldNtOpenProcess</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">PageProtectOn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 被修改的 NtOpenProcess 函数，简单打印参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NTSTATUS</span> <span class="nf">HbgNtOpenProcess</span><span class="p">(</span><span class="n">PHANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span> <span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span> <span class="n">POBJECT_ATTRIBUTES</span> <span class="n">ObjectAttributes</span><span class="p">,</span> <span class="n">PCLIENT_ID</span> <span class="n">ClientId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;%x %x %x %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ProcessHandle</span><span class="p">,</span> <span class="n">DesiredAccess</span><span class="p">,</span> <span class="n">ObjectAttributes</span><span class="p">,</span> <span class="n">ClientId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">((</span><span class="n">NTOPENPROCESS</span><span class="p">)</span><span class="n">uOldNtOpenProcess</span><span class="p">)(</span><span class="n">ProcessHandle</span><span class="p">,</span> <span class="n">DesiredAccess</span><span class="p">,</span> <span class="n">ObjectAttributes</span><span class="p">,</span> <span class="n">ClientId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>这是没挂钩子之前的：</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230117150934452.png' alt="image-20230117150934452" height="563" width="896"></p>
<p>这是挂上之后的：</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230117151105934.png' alt="image-20230117151105934" height="288" width="859"></p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230117151029551.png' alt="image-20230117151029551" height="563" width="887"></p>
<p>可以看到还是很容易被发现的。</p>
<h2 id="008inline-hook" class="heading-element"><span>008.Inline Hook</span>
  <a href="#008inline-hook" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><blockquote>
<p><a href="https://cataloc.gitee.io/blog/2020/04/20/Inline-Hook-SSDT/"target="_blank" rel="external nofollow noopener noreferrer">https://cataloc.gitee.io/blog/2020/04/20/Inline-Hook-SSDT/</a></p>
<p><a href="https://www.cnblogs.com/luoyesiqiu/p/12306336.html"target="_blank" rel="external nofollow noopener noreferrer">https://www.cnblogs.com/luoyesiqiu/p/12306336.html</a></p>
<p><a href="https://blog.csdn.net/qq_41988448/article/details/103557383"target="_blank" rel="external nofollow noopener noreferrer">https://blog.csdn.net/qq_41988448/article/details/103557383</a></p></blockquote>
<p>SSDT Hook缺点：</p>
<ul>
<li>容易发现，容易绕过</li>
<li>只能Hook系统服务表里面有的函数</li>
</ul>
<p>无论是3环还是0环，Inline Hook的原理是一样的：</p>
<ol>
<li>通过<strong>修改</strong>函数中的<strong>指令</strong>，改变程序执行的流程</li>
<li><strong>跳转到自己定义的代码段</strong>中执行</li>
<li>最后再<strong>返回到原始函数</strong>中</li>
</ol>
<p>inline hook是一种通过修改机器码的方式来实现hook的技术。</p>
<p>挂钩：</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230117235442739.png' alt="image-20230117235442739" height="322" width="638"></p>
<p>执行流程：</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230117201023604.png' alt="image-20230117201023604" height="376" width="946"></p>
<p>脱钩：</p>
<p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230117235457065.png' alt="image-20230117235457065" height="313" width="637"></p>
<h3 id="实验13环inline-hook" class="heading-element"><span>实验1：3环Inline Hook</span>
  <a href="#%e5%ae%9e%e9%aa%8c13%e7%8e%afinline-hook" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">_declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="kt">void</span> <span class="nf">OnCall</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">......</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>OnCall函数用<code>_declspec(naked)</code>修饰，被它修饰的函数我们常称它为裸函数，裸函数的特点是在编译生成的时候不会产生过多用于平衡堆栈的指令，这意味着在裸函数中我们要编写<strong>内联汇编</strong>控制堆栈平衡。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">BYTE</span> <span class="o">*</span><span class="n">ProcAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="c1">// 原函数地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">DWORD</span> <span class="n">OldProtect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// 保存旧的内存保护
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">BYTE</span> <span class="n">OldCmd</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span> <span class="c1">// 存储原函数头部原始指令 在最后面构造返回到原函数的指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">BYTE</span> <span class="o">*</span><span class="n">HookProcAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 钩子函数的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 函数指针 将数据作为指令执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">POLDCMD</span><span class="p">)();</span>
</span></span><span class="line"><span class="cl"><span class="n">POLDCMD</span> <span class="n">pOldCmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">POLDCMD</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">OldCmd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// printf的格式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="s">&#34;%x&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">add</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">a</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="nf">HookProc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 保存现场
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">    	<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">    	<span class="n">pushfd</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 获得参数1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;a = &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">    	<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">esp</span>
</span></span><span class="line"><span class="cl">    	<span class="n">add</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">40</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    	<span class="n">push</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    	<span class="n">push</span> <span class="n">format</span>
</span></span><span class="line"><span class="cl">    	<span class="n">call</span> <span class="n">printf</span>
</span></span><span class="line"><span class="cl">    	<span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 获得参数2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">b = &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">    	<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">esp</span>
</span></span><span class="line"><span class="cl">    	<span class="n">add</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">44</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    	<span class="n">push</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    	<span class="n">push</span> <span class="n">format</span>
</span></span><span class="line"><span class="cl">    	<span class="n">call</span> <span class="n">printf</span>
</span></span><span class="line"><span class="cl">    	<span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 还原现场
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    	<span class="n">popfd</span>
</span></span><span class="line"><span class="cl">    	<span class="n">popad</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// 执行原函数头部指令 并返回到原函数下一行继续执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    	<span class="n">jmp</span> <span class="n">pOldCmd</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">InlineHook</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 获得需要挂钩的函数地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ProcAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">add</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ProcAddr</span> <span class="o">+=</span> <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">ProcAddr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 修改内存保护
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">VirtualProtect</span><span class="p">(</span><span class="n">ProcAddr</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">OldProtect</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 将被覆盖的指令复制到数组中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">OldCmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ProcAddr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 数组末尾添上跳转指令 用于返回到被挂钩的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">OldCmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xE9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">OldCmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">ProcAddr</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="n">OldCmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 获得钩子函数的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">HookProcAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">HookProc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">HookProcAddr</span> <span class="o">+=</span> <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">HookProcAddr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 修改原函数的头部 跳转到钩子函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ProcAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xE9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ProcAddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HookProcAddr</span> <span class="o">-</span> <span class="n">ProcAddr</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 跳转指令只占五个字节 原函数头部三行指令占六个字节 因此将多余字节填充为nop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ProcAddr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">UnInlineHook</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 判断函数是否被挂钩
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">ProcAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xE9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ProcAddr</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">OldCmd</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 挂钩
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">InlineHook</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">sum</span> <span class="o">=</span> <span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;sum = %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 脱钩
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// UnInlineHook();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">sum</span> <span class="o">=</span> <span class="nf">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;sum = %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230117235309994.png' alt="image-20230117235309994" height="198" width="660"></p>
<h3 id="实验20环inline-hook" class="heading-element"><span>实验2：0环Inline Hook</span>
  <a href="#%e5%ae%9e%e9%aa%8c20%e7%8e%afinline-hook" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>这里还是使用<code>OpenProcess</code>举例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;ntddk.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;ntstatus.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">PUCHAR</span> <span class="n">pNtOpenProcess</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">UCHAR</span>  <span class="n">OldCmd</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">//函数指针 用于将数据作为指令执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="nf">VOID</span> <span class="p">(</span><span class="o">*</span><span class="n">POLDCMD</span><span class="p">)();</span>
</span></span><span class="line"><span class="cl"><span class="n">POLDCMD</span> <span class="n">pOldCmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">POLDCMD</span><span class="p">)(</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">OldCmd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PCHAR</span> <span class="n">format</span> <span class="o">=</span> <span class="s">&#34;%x %x %x %x </span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="nf">NTSTATUS</span> <span class="p">(</span><span class="o">*</span><span class="n">NTOPENPROCESS</span><span class="p">)(</span>
</span></span><span class="line"><span class="cl">	<span class="n">PHANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">POBJECT_ATTRIBUTES</span> <span class="n">ObjectAttributes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">PCLIENT_ID</span> <span class="n">ClientId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_KSYSTEM_SERVICE_TABLE</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">	<span class="n">PULONG</span>  <span class="n">ServiceTableBase</span><span class="p">;</span>			<span class="c1">// 服务函数地址表基址  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PULONG</span>  <span class="n">ServiceCounterTableBase</span><span class="p">;</span>	<span class="c1">// SSDT函数被调用的次数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ULONG</span>   <span class="n">NumberOfService</span><span class="p">;</span>			<span class="c1">// 服务函数的个数  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PULONG</span>   <span class="n">ParamTableBase</span><span class="p">;</span>			<span class="c1">// 服务函数参数表基址   
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">KSYSTEM_SERVICE_TABLE</span><span class="p">,</span> <span class="o">*</span><span class="n">PKSYSTEM_SERVICE_TABLE</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_KSERVICE_TABLE_DESCRIPTOR</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">	<span class="n">KSYSTEM_SERVICE_TABLE</span>   <span class="n">ntoskrnl</span><span class="p">;</span>		<span class="c1">// ntoskrnl.exe 的服务函数  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">KSYSTEM_SERVICE_TABLE</span>   <span class="n">win32k</span><span class="p">;</span>			<span class="c1">// win32k.sys 的服务函数(GDI32.dll/User32.dll 的内核支持)  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">KSYSTEM_SERVICE_TABLE</span>   <span class="n">notUsed1</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">	<span class="n">KSYSTEM_SERVICE_TABLE</span>   <span class="n">notUsed2</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="n">KSERVICE_TABLE_DESCRIPTOR</span><span class="p">,</span> <span class="o">*</span><span class="n">PKSERVICE_TABLE_DESCRIPTOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// KeServiceDescriptorTable 是 ntoskrnl.exe 所导出的全局变量 申明一下就可以直接使用了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="n">PKSERVICE_TABLE_DESCRIPTOR</span> <span class="n">KeServiceDescriptorTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">PageProtectOn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span><span class="p">{</span><span class="c1">//开启内存保护
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span>  <span class="n">eax</span><span class="p">,</span><span class="n">cr0</span>
</span></span><span class="line"><span class="cl">		<span class="n">or</span>   <span class="n">eax</span><span class="p">,</span><span class="mi">10000</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span>  <span class="n">cr0</span><span class="p">,</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">sti</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">PageProtectOff</span><span class="p">()</span>				
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span><span class="p">{</span><span class="c1">//关闭内存保护
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">cli</span>					
</span></span><span class="line"><span class="cl">		<span class="n">mov</span>  <span class="n">eax</span><span class="p">,</span><span class="n">cr0</span>
</span></span><span class="line"><span class="cl">		<span class="n">and</span>  <span class="n">eax</span><span class="p">,</span><span class="n">not</span> <span class="mi">10000</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span>  <span class="n">cr0</span><span class="p">,</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="nf">HookProc</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//保存现场
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushfd</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">esp</span>
</span></span><span class="line"><span class="cl">		<span class="n">add</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">40</span>		<span class="c1">//eflags + 8个通用寄存器 + 返回地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">add</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">12</span>		<span class="c1">//定位到最后一个参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">push</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>		<span class="c1">//ClientId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">push</span> <span class="p">[</span><span class="n">eax</span><span class="o">-</span><span class="mh">0x4</span><span class="p">]</span>	<span class="c1">//ObjectAttributes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">push</span> <span class="p">[</span><span class="n">eax</span><span class="o">-</span><span class="mh">0x8</span><span class="p">]</span>	<span class="c1">//DesiredAccess
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">push</span> <span class="p">[</span><span class="n">eax</span><span class="o">-</span><span class="mh">0xC</span><span class="p">]</span>	<span class="c1">//ProcessHandle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">push</span> <span class="n">format</span>
</span></span><span class="line"><span class="cl">		<span class="n">call</span> <span class="n">DbgPrint</span>
</span></span><span class="line"><span class="cl">		<span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//还原现场
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">popfd</span>
</span></span><span class="line"><span class="cl">		<span class="n">popad</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//调用原本的指令，然后返回到原函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">jmp</span> <span class="n">pOldCmd</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="nf">InlineHook</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">NTSTATUS</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">PageProtectOff</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//保存原来的指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pNtOpenProcess</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">KeServiceDescriptorTable</span><span class="o">-&gt;</span><span class="n">ntoskrnl</span><span class="p">.</span><span class="n">ServiceTableBase</span><span class="p">[</span><span class="mh">0x7A</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RtlMoveMemory</span><span class="p">(</span><span class="n">OldCmd</span><span class="p">,</span> <span class="n">pNtOpenProcess</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//构造回去的指令，用于返回到原函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">OldCmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xE9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">PULONG</span><span class="p">)</span><span class="o">&amp;</span><span class="n">OldCmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">ULONG</span><span class="p">)</span><span class="n">pNtOpenProcess</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="o">&amp;</span><span class="n">OldCmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//内核函数不存在中间人（call后通过jmp跳转），函数地址为实际地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pNtOpenProcess</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xE9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">PULONG</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pNtOpenProcess</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="n">HookProc</span> <span class="o">-</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="n">pNtOpenProcess</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">PageProtectOn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="nf">UnInlineHook</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">NTSTATUS</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">pNtOpenProcess</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xE9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">PageProtectOff</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="nf">RtlMoveMemory</span><span class="p">(</span><span class="n">pNtOpenProcess</span><span class="p">,</span> <span class="n">OldCmd</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">PageProtectOn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//卸载函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">VOID</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">driver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//卸载驱动时脱钩
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">UnInlineHook</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;驱动程序已停止.</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//驱动程序入口函数，相当于控制台的main函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">DriverObject</span><span class="p">,</span><span class="n">PUNICODE_STRING</span> <span class="n">RegistryPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;驱动程序已运行.</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//运行驱动时挂钩
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">InlineHook</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//设置一个卸载函数  便于退出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DriverObject</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="n">DriverUnload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p><img loading="lazy" src='/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/image-20230117235958593.png' alt="image-20230117235958593" height="281" width="852"></p>
<h2 id="009多核同步之临界区" class="heading-element"><span>009.多核同步之临界区</span>
  <a href="#009%e5%a4%9a%e6%a0%b8%e5%90%8c%e6%ad%a5%e4%b9%8b%e4%b8%b4%e7%95%8c%e5%8c%ba" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>并发：指多个线程在同时执行</p>
<ul>
<li><code>单核</code>：各个线程分时执行，不是真正意义上的同时</li>
<li><code>多核</code>：在某一时刻，会同时有多个线程在执行</li>
</ul>
<p><strong>同步</strong>：保证在并发执行的环境中各个线程可以有序的执行</p>
<h3 id="单行指令的同步" class="heading-element"><span>单行指令的同步</span>
  <a href="#%e5%8d%95%e8%a1%8c%e6%8c%87%e4%bb%a4%e7%9a%84%e5%90%8c%e6%ad%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">dwVal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">//全局变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">....</span>
</span></span><span class="line"><span class="cl"><span class="p">....</span>    
</span></span><span class="line"><span class="cl"><span class="c1">//某个线程中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">dwVal</span><span class="o">++</span><span class="p">;</span>		<span class="c1">//这行代码是否安全？
</span></span></span></code></pre></div><p>实际上是<strong>不安全</strong>的，</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="mi">0x12345678</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">add</span> <span class="no">eax</span><span class="p">,</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="p">[</span><span class="mi">0x12345678</span><span class="p">],</span> <span class="no">eax</span></span></span></code></pre></div><p>程序<strong>在执行dwVal++时</strong>，<strong>需要按</strong>照顺序<strong>执行3条汇编指令</strong>，才能实现这条语句的功能。</p>
<p>现在我们来考虑一种情况，线程A和线程B均要进行dwVal++这条指令，理想状态下，这两个线程执行完后，该全局变量的值会增加2。但是<strong>如果在线程A执行完第二条指令后</strong>，<strong>发生了线程切换</strong>，情况就会变的不一样了。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1">//线程A
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="mi">0x12345678</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">add</span> <span class="no">eax</span><span class="p">,</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//发生线程切换
</span></span></span><span class="line"><span class="cl"><span class="c1">//线程B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="mi">0x12345678</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">add</span> <span class="no">eax</span><span class="p">,</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="p">[</span><span class="mi">0x12345678</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//发生线程切换
</span></span></span><span class="line"><span class="cl"><span class="c1">//线程A
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span> <span class="p">[</span><span class="mi">0x12345678</span><span class="p">],</span> <span class="no">eax</span></span></span></code></pre></div><p>那单行指令安全吗？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">inc</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="no">ds</span><span class="p">:[</span><span class="mi">0x12345678</span><span class="p">]</span>	<span class="err">//一行汇编指令，安全吗?</span></span></span></code></pre></div><p>这条汇编指令仅有一行，看上去不会出现上述的情况。即使线程发生切换了，也不会造成指令的重复执行。的确，在<strong>单核</strong>的情况下，这条指令是<strong>安全</strong>的，但是<strong>多核</strong>的情况下，还是有可能发生，不同线程同时执行这条指令的情况，所以这条指令并<strong>不安全</strong>。那如何才能在多核的情况下，依旧保证线程间的同步呢？那就需要用到下面介绍的这条指令了。</p>
<h4 id="lock指令" class="heading-element"><span>Lock指令</span>
  <a href="#lock%e6%8c%87%e4%bb%a4" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>只需要增加一个lock指令，就能让<strong>单条指令</strong>在多核的情况下做到同步，</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="na">lock</span> <span class="nf">inc</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="no">ds</span><span class="p">:[</span><span class="mi">0x12345678</span><span class="p">]</span></span></span></code></pre></div><p><strong>lock指令可以锁定当前指令执行时线程所访问的内存</strong>，上述代码执行时，会对0x12345678地址处的值进行修改，<strong>有了lock指令</strong>的限制，此时<strong>其它线程</strong>是<strong>不能访问或修改0x12345678地址处的值</strong>的，只有在这条指令执行完后，其余线程才可以对此地址的值进行访问或者修改。这样就避免了多核情况下，不同线程同时修改此地址处的值的情况。</p>
<p>像上面这样通过Lock指令进行限制，从而<strong>不可被中断的操作</strong>叫做<strong>原子操作</strong>。Windows提供了一部分API（主要位于Kernel32.dll和Ntdll.dll）供用户使用从而保证在多核情况下的线程同步：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//原子操作相关的API：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">InterlockedIncrement</span>			<span class="n">InterlockedExchangeAdd</span>
</span></span><span class="line"><span class="cl"><span class="n">InterlockedDecrement</span>			<span class="n">InterlockedFlushSList</span>		
</span></span><span class="line"><span class="cl"><span class="n">InterlockedExchange</span>			<span class="n">InterlockedPopEntrySList</span>
</span></span><span class="line"><span class="cl"><span class="n">InterlockedCompareExchange</span>		<span class="n">InterlockedPushEntrySList</span></span></span></code></pre></div><h4 id="interlockedincrement" class="heading-element"><span>InterlockedIncrement</span>
  <a href="#interlockedincrement" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>挑一个来分析，该API在kernel32.dll中</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C809806</span> <span class="c1">; LONG __stdcall InterlockedIncrement(volatile LONG *lpAddend)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C809806</span>                 <span class="no">public</span> <span class="no">InterlockedIncrement</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C809806</span> <span class="no">InterlockedIncrement</span> <span class="no">proc</span> <span class="no">near</span>          <span class="c1">; CODE XREF: CreatePipe+57↓p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C809806</span>                                         <span class="c1">; sub_7C82CBB2+41↓p ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C809806</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C809806</span> <span class="no">lpAddend</span>        <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C809806</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C809806</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="no">lpAddend</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C80980A</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">1</span>          <span class="c1">; 将需要修改的变量的地址赋给ecx，此时可以通过[ecx]访问该变量的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C80980F</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C80980F</span> <span class="no">loc_7C80980F</span><span class="p">:</span>                           <span class="c1">; DATA XREF: .data:off_7C88500C↓o
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C80980F</span>                 <span class="no">lock</span> <span class="no">xadd</span> <span class="p">[</span><span class="no">ecx</span><span class="p">],</span> <span class="no">eax</span>    <span class="c1">; 第一部分是lock，用来锁住内存；另一部分核心在于xadd指令，该指令接收2个参数，先交换两个操作数的值，再进行算术加法操作:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C80980F</span>                                         <span class="c1">; DWORD　temp;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C80980F</span>                                         <span class="c1">; temp = [ecx];
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C80980F</span>                                         <span class="c1">; [ecx] = eax;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C80980F</span>                                         <span class="c1">; eax = temp;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C80980F</span>                                         <span class="c1">; [ecx] += eax;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C809813</span>                 <span class="no">inc</span>     <span class="no">eax</span>             <span class="c1">; eax自增1，此时eax和[ecx]的值相同，eax可以起到返回值的作用（尽管已经完成对[ecx]值的修改）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C809814</span>                 <span class="no">retn</span>    <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C809814</span> <span class="no">InterlockedIncrement</span> <span class="no">endp</span></span></span></code></pre></div><h3 id="多行指令的同步" class="heading-element"><span>多行指令的同步</span>
  <a href="#%e5%a4%9a%e8%a1%8c%e6%8c%87%e4%bb%a4%e7%9a%84%e5%90%8c%e6%ad%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="临界区" class="heading-element"><span>临界区</span>
  <a href="#%e4%b8%b4%e7%95%8c%e5%8c%ba" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>可以设置一个临界区：一次只允许一个线程进入直到离开，从而保证线程的同步（这里的临界区指的是广义的临界区，各个操作系统根据临界区的思想都有各自的实现，后面也会学习到Windows提供的临界区实现）参考如下代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">dwFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="c1">//实现临界区的方式就是加锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						<span class="c1">//锁：全局变量  进去加一 出去减一
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span><span class="p">(</span><span class="n">dwFlag</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		<span class="c1">//进入临界区	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>	
</span></span><span class="line"><span class="cl">	<span class="n">dwFlag</span>   <span class="o">=</span> <span class="mi">1</span>	
</span></span><span class="line"><span class="cl">	<span class="p">.......</span>
</span></span><span class="line"><span class="cl">	<span class="p">.......</span>
</span></span><span class="line"><span class="cl">	<span class="p">.......</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">	<span class="n">dwFlag</span>   <span class="o">=</span> <span class="mi">0</span>		<span class="c1">//离开临界区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span></span></span></code></pre></div><p>仔细观察一遍这个代码，其实是有问题的，考虑一种情况，在进入临界区后，如果dwFlag = 1这条指令还没有执行，此时发生了线程切换，这时，切换后的新线程也可以进入临界区，这样临界区的作用就失效了。</p>
<h4 id="自己实现临界区" class="heading-element"><span>自己实现临界区</span>
  <a href="#%e8%87%aa%e5%b7%b1%e5%ae%9e%e7%8e%b0%e4%b8%b4%e7%95%8c%e5%8c%ba" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1">//定义全局变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">Flag</span> <span class="err">=</span> <span class="mi">0</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//进入临界区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">Lab</span><span class="err">：</span>
</span></span><span class="line"><span class="cl">	<span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//多核情况下必须加lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="na">lock</span> <span class="nf">xadd</span> <span class="p">[</span><span class="no">Flag</span><span class="p">],</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl">	<span class="nf">cmp</span> <span class="no">eax</span><span class="p">,</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="nf">jz</span> <span class="no">endLab</span>
</span></span><span class="line"><span class="cl">	<span class="nf">dec</span> <span class="p">[</span><span class="no">Flag</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//线程等待Sleep..
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">jmp</span> <span class="no">Lab</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//临界区内部
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">endLab:</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ret</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"><span class="c1">//离开临界区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="na">lock</span> <span class="nf">dec</span> <span class="p">[</span><span class="no">Flag</span><span class="p">]</span></span></span></code></pre></div><p>这份伪代码提供了一个新的思路，在进入临界区之前，先判断锁的值，若达到进入临界区的条件，则<strong>先修改锁的值</strong>，<strong>再进入临界区</strong>；<strong>若条件不符合</strong>，则调用sleep()函数，进行<strong>线程等待</strong>。一段时间后，在跳回进入临界区的地方重新判断。在<strong>线程退出临界区</strong>后，<strong>再</strong>通过原子操作<strong>还原锁的值</strong>。</p>
<h2 id="010多核同步之自旋锁" class="heading-element"><span>010.多核同步之自旋锁</span>
  <a href="#010%e5%a4%9a%e6%a0%b8%e5%90%8c%e6%ad%a5%e4%b9%8b%e8%87%aa%e6%97%8b%e9%94%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><blockquote>
<p><a href="https://cataloc.gitee.io/blog/2020/05/09/%E5%A4%9A%E6%A0%B8%E5%90%8C%E6%AD%A5%E4%B9%8B%E8%87%AA%E6%97%8B%E9%94%81/"target="_blank" rel="external nofollow noopener noreferrer">多核同步之自旋锁</a></p>
<p><a href="https://blog.csdn.net/Kwansy/article/details/109995196"target="_blank" rel="external nofollow noopener noreferrer">自旋锁 ， cmpxchg8b 指令</a></p>
<p><a href="https://blog.csdn.net/qq_41988448/article/details/103585673"target="_blank" rel="external nofollow noopener noreferrer">多核同步&amp;内核重载</a></p>
<p><a href="https://blog.csdn.net/whatday/article/details/13170495"target="_blank" rel="external nofollow noopener noreferrer">读书笔记之《Windows内核原理与实现》</a></p></blockquote>
<p>Windows提供的一种实现多核同步的机制：<strong>自旋锁</strong>。</p>
<pre tabindex="0"><code>//单核
ntkrnlpa.exe					2-9-9-12分页
ntoskrnl.exe					10-10-12分页

//多核:
ntkrnlpa.exe（ntkrpamp.exe）			2-9-9-12分页
ntoskrnl.exe（ntkrnlmp.exe）			10-10-12分页</code></pre><p>Intel的CPU，<strong>多核情况下</strong>，<strong>系统安装时将ntkrnlmp.exe拷贝为ntoskrnl.exe</strong>，系统加载时加载这个（原来是ntkrnlmp.exe的）ntoskrnl.exe。所以Intel多核情况下，内核<strong>文件名仍然是ntoskrnl.exe</strong>，但是其<strong>源文件名是ntkrnlmp.exe</strong>，如果加载符号，符号文件名也是ntkrnlmp.pdb。也因此，单核，多核情况下都叫做ntoskrnl.exe。</p>
<p>注意设置虚拟机CPU核心数量，</p>
<blockquote>
<p>用一个例子来解释临界区和自旋锁的区别。只有一个厕所，有一个人进去了。</p>
<p>临界区就是外面的人过来看一眼发现没位子，就回家睡觉了，睡醒了再回来看看有没有位子，重复这样的步骤；</p>
<p>自旋锁就是外面人一看没位置，他就在原地打转，一有位子马上就进去了。</p></blockquote>
<h3 id="keacquirespinlockatdpclevel" class="heading-element"><span>KeAcquireSpinLockAtDpcLevel</span>
  <a href="#keacquirespinlockatdpclevel" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><blockquote>
<p><a href="https://www.cnblogs.com/del/archive/2010/04/15/1712467.html"target="_blank" rel="external nofollow noopener noreferrer">BT、BTS、BTR、BTC: 位测试指令</a></p></blockquote>
<p>首先介绍两个指令，一个是bt一个是bts：</p>
<ul>
<li>
<p>BT(Bit Test)：位测试</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1">;BT 把 10000001b 的第七位复制到 CF, 得知是 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span> <span class="no">dx</span><span class="p">,</span> <span class="mi">10000001</span><span class="no">b</span>
</span></span><span class="line"><span class="cl"><span class="nf">bt</span>  <span class="no">dx</span><span class="p">,</span> <span class="mi">7</span></span></span></code></pre></div></li>
<li>
<p>BTS(Bit Test and Set：位测试并置位</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1">;BTS 在执行 BT 命令的同时, 把操作数的指定位置为 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span> <span class="no">dx</span><span class="p">,</span> <span class="mi">10000001</span><span class="no">b</span>
</span></span><span class="line"><span class="cl"><span class="nf">bts</span> <span class="no">dx</span><span class="p">,</span> <span class="mi">6</span></span></span></code></pre></div></li>
</ul>
<p>单核的是直接retn了。</p>
<p>多核：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">text:</span><span class="err">0040</span><span class="nf">B38B</span> <span class="c1">; __stdcall KeAcquireSpinLockAtDpcLevel(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B38B</span>                 <span class="no">public</span> <span class="no">_KeAcquireSpinLockAtDpcLevel@4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B38B</span> <span class="no">_KeAcquireSpinLockAtDpcLevel@4</span> <span class="no">proc</span> <span class="no">near</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B38B</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B38B</span> <span class="no">arg_0</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B38B</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B38B</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="no">arg_0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B38F</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B38F</span> <span class="no">loc_40B38F</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KeAcquireSpinLockAtDpcLevel(x)+14↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B38F</span>                 <span class="no">lock</span> <span class="no">bts</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ecx</span><span class="p">],</span> <span class="mi">0</span> <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B38F</span>                                         <span class="c1">; 1.先判断[ecx]是否为0，是的话CF=1，否则为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B38F</span>                                         <span class="c1">; 2.将[ecx]指定的下标置1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B38F</span>                                         <span class="c1">; 加lock保证多核情况下的安全
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B394</span>                 <span class="no">jb</span>      <span class="no">short</span> <span class="no">loc_40B399</span> <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B394</span>                                         <span class="c1">; 如果[ecx]!=0则跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B394</span>                                         <span class="c1">; 如果[ecx]==0说明没有线程进入当前临界区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B396</span>                 <span class="no">retn</span>    <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B399</span> <span class="c1">; ---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B399</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B399</span> <span class="no">loc_40B399</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KeAcquireSpinLockAtDpcLevel(x)+9↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B399</span>                                         <span class="c1">; KeAcquireSpinLockAtDpcLevel(x)+18↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B399</span>                 <span class="no">test</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ecx</span><span class="p">],</span> <span class="mi">1</span> <span class="c1">; 如果[ecx]!=1则跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B399</span>                                         <span class="c1">; 如果[ecx]==1说明当前资源被占用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B39F</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_40B38F</span> <span class="c1">; 跳到开头再来KeAcquireSpinLockAtDpcLevel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B3A1</span>                 <span class="no">pause</span>                   <span class="c1">; CPU降温指令，短时间内降低CPU功率
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B3A3</span>                 <span class="no">jmp</span>     <span class="no">short</span> <span class="no">loc_40B399</span> <span class="c1">; 重复执行这几行指令，故称为自旋锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">B3A3</span> <span class="no">_KeAcquireSpinLockAtDpcLevel@4</span> <span class="no">endp</span></span></span></code></pre></div><h3 id="思考题" class="heading-element"><span>思考题</span>
  <a href="#%e6%80%9d%e8%80%83%e9%a2%98" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>如何HOOK高并发的内核函数？</li>
</ul>
<blockquote>
<p>这个问题的关键是，hook 后一般是 e8 / e9 后跟4字节，总共5字节，但没办法一次性改5个字节，可能改了第一个字节，正要改后4个字节时，别的线程进来了，就会出错。</p>
<p>有三种办法：</p>
<ul>
<li>短跳中转</li>
<li>中断门</li>
<li>找一条一次性修改8字节的指令</li>
</ul></blockquote>
<ol>
<li>先在附近未使用的内存空间构造一个<strong>长跳转</strong>（五个字节），再在要hook的地方构造一个<strong>短跳转</strong>（一次性写入两个字节）指向长跳转位置</li>
<li>使用 <strong>cmpxchg8b</strong> 指令最多可一次性写入<strong>八个字节</strong></li>
</ol>
<hr>
<p><strong>cmpxchg8b</strong>指令</p>
<blockquote>
<p>cmpxchg8b mem64 指令的工作如下：
比较 mem64 和 EDX:EAX
如果相等，那么把 ECX:EBX 存储到 mem64
如果不相等，那么把 mem64 存储到 EDX:EAX</p></blockquote>
<h2 id="011内核重载" class="heading-element"><span>011.内核重载</span>
  <a href="#011%e5%86%85%e6%a0%b8%e9%87%8d%e8%bd%bd" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li>
<p>描述：</p>
<ul>
<li>
<p>内核中的很多函数被层层HOOK，重载一份内核可以绕过这些HOOK</p>
</li>
<li>
<p>内核重载与映射PE文件的方法无异，本质上没有区别</p>
</li>
<li>
<p>内核重载就是重新加载一份内核文件（ntkrnlpa.exe）</p>
</li>
</ul>
</li>
<li>
<p>步骤：</p>
<ol>
<li>
<p>申请内存，按内存对齐展开</p>
</li>
<li>
<p>根据重定位表修复全局变量</p>
</li>
<li>
<p>修复IAT表(修复导入表的说法不准确)</p>
</li>
<li>
<p>山寨系统服务表</p>
</li>
<li>
<p>狸猫换太子（Hook KiFastCallEntry）</p>
</li>
</ol>
</li>
</ul>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2023-01-18 00:00:00">Updated on 2023-01-18&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on X" data-sharer="twitter" data-url="http://localhost:1313/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/" data-title="Windows内核(二)——驱动" data-hashtags="Win32"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/" data-hashtag="Win32"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://localhost:1313/posts/2023-1-winkernel%E9%A9%B1%E5%8A%A8/" data-title="Windows内核(二)——驱动"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/win32/" class="post-tag" title="Tags - Win32">Win32</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/2023-1-winkernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" class="post-nav-item" rel="prev" title="Windows内核(三)——系统调用"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Windows内核(三)——系统调用</a><a href="/posts/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" class="post-nav-item" rel="next" title="2022年终总结">2022年终总结<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.145.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.17-8212d6fd"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"version":"v0.3.17-8212d6fd"};console.log('Page config:', window.config);</script><script src="/js/theme.min.js" defer></script></body>
</html>
