<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Syscall Journey - 敬渊&#39;s Blog</title><meta name="author" content="">
<meta name="description" content="本文记录一下syscall的“旅程”。
这里使用的是win10x64 22H2 19045.3086
与其他进程、内存、驱动器或文件系统交互时，使用 Kernel32.dll 中的函数
与 Windows GUI 交互，使用的是 user32.dll 和 gdi32.dll 中的函数
"><meta name="keywords" content='WINDOWS'>
  <meta itemprop="name" content="Syscall Journey">
  <meta itemprop="description" content="本文记录一下syscall的“旅程”。
这里使用的是win10x64 22H2 19045.3086
与其他进程、内存、驱动器或文件系统交互时，使用 Kernel32.dll 中的函数
与 Windows GUI 交互，使用的是 user32.dll 和 gdi32.dll 中的函数">
  <meta itemprop="datePublished" content="2023-07-03T00:00:00+00:00">
  <meta itemprop="dateModified" content="2023-07-03T00:00:00+00:00">
  <meta itemprop="wordCount" content="6027">
  <meta itemprop="keywords" content="Windows"><meta property="og:url" content="https://nesl42.github.io/posts/2023-7-win-syscalljourney/">
  <meta property="og:site_name" content="敬渊&#39;s Blog">
  <meta property="og:title" content="Syscall Journey">
  <meta property="og:description" content="本文记录一下syscall的“旅程”。
这里使用的是win10x64 22H2 19045.3086
与其他进程、内存、驱动器或文件系统交互时，使用 Kernel32.dll 中的函数
与 Windows GUI 交互，使用的是 user32.dll 和 gdi32.dll 中的函数">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-07-03T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-07-03T00:00:00+00:00">
    <meta property="article:tag" content="Windows">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Syscall Journey">
  <meta name="twitter:description" content="本文记录一下syscall的“旅程”。
这里使用的是win10x64 22H2 19045.3086
与其他进程、内存、驱动器或文件系统交互时，使用 Kernel32.dll 中的函数
与 Windows GUI 交互，使用的是 user32.dll 和 gdi32.dll 中的函数">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="https://nesl42.github.io/posts/2023-7-win-syscalljourney/" title="Syscall Journey - 敬渊&#39;s Blog" /><link rel="prev" type="text/html" href="https://nesl42.github.io/posts/2023-5aflwritepaper/" title="【译】AFL白皮书" /><link rel="next" type="text/html" href="https://nesl42.github.io/posts/2023-7-sdqrcode/" title="Stable Diffusion QR Code" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Syscall Journey",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/nesl42.github.io\/posts\/2023-7-win-syscalljourney\/"
    },"genre": "posts","keywords": "WINDOWS","wordcount":  6027 ,
    "url": "https:\/\/nesl42.github.io\/posts\/2023-7-win-syscalljourney\/","datePublished": "2023-07-03T00:00:00+00:00","dateModified": "2023-07-03T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Author"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/">文章</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/">标签</a></li><li class="menu-item">
              <a class="menu-link" href="/about/">关于</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/">分类</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="/posts/">文章</a></li><li class="menu-item"><a class="menu-link" href="/tags/">标签</a></li><li class="menu-item"><a class="menu-link" href="/about/">关于</a></li><li class="menu-item"><a class="menu-link" href="/categories/">分类</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Syscall Journey</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="published on 2023-07-03 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-07-03">2023-07-03</time></span>&nbsp;<span title="6027 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 6100 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>13 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#kisystemserviceuser">KiSystemServiceUser()</a></li>
        <li><a href="#syscall-number-和-kisystemservicestart">Syscall Number 和 KiSystemServiceStart()</a></li>
        <li><a href="#kisystemservicerepeat">KiSystemServiceRepeat()</a></li>
        <li><a href="#kisystemservicecopyend">KiSystemServiceCopyEnd()</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>本文记录一下syscall的“旅程”。</p>
<p>这里使用的是<code>win10x64  22H2 19045.3086</code></p>
<ul>
<li>
<p>与其他进程、内存、驱动器或文件系统交互时，使用 <code>Kernel32.dll</code> 中的函数</p>
</li>
<li>
<p>与 Windows GUI 交互，使用的是 <code>user32.dll</code> 和 <code>gdi32.dll</code> 中的函数</p>
</li>
<li>
<p>并非所有 <code>Kernel32</code> 、 <code>user32</code> 和 <code>gdi32</code> 函数都以直接系统调用结束</p>
</li>
</ul>
<p><strong><code>Nt*</code> 、 <code>Zw*</code> 、 <code>NtUser*</code> 和 <code>NtGdi*</code> 函数的“真正”代码在内核模式下运行。</strong></p>
<p>在本文中， <code>Nt*</code> 和 <code>Zw*</code> 函数将被称为 <code>Native functions</code> 。 <code>NtUser*</code> 和 <code>NtGdi*</code> 函数将被称为 <code>GUI functions</code></p>
<p>直接系统调用的代码也称为 <code>syscall stub</code></p>
<p><code>syscall stub</code> 的作用是将函数的执行流程转发到内核中的相关代码（ <code>kernel routine</code> ）。这是用户模式的最后一步。由 <code>syscall</code> 完成的，该数字称为 <code>syscall ID</code> 或 <code>syscall number</code> 或 <code>system service number (SSN)</code></p>
<p>在64位系统上，当执行 <code>syscall</code> 指令时， <code>LSTAR</code> 寄存器中的地址被放入 <code>RIP</code> 寄存器中</p>
<p>图示：</p>
<p><img loading="lazy" src='/posts/2023-7-win-syscalljourney/Pasted-image-20230629170115.png' alt="Pasted-image-20230629170115" height="323" width="691"></p>
<p><code>LSTAR</code> 寄存器的唯一目的是存储 <code>syscall</code> 指令之后在内核模式下执行的第一个函数的地址。 <code>LSTAR</code> 寄存器是称为 MSR（模型特定寄存器  Model-specific register）的许多其他寄存器之一。</p>
<p>系统中， <code>LSTAR</code> 被标识为 <code>msr[c0000082]</code>，使用命令 <code>rdmsr</code> 读取MSR</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">0: kd&gt; rdmsr c0000082
</span></span><span class="line"><span class="cl">msr<span class="o">[</span>c0000082<span class="o">]</span> <span class="o">=</span> fffff801<span class="sb">`</span>54a751c0
</span></span><span class="line"><span class="cl">1: kd&gt; ln fffff801<span class="sb">`</span>54a751c0
</span></span><span class="line"><span class="cl"><span class="o">(</span>fffff801<span class="sb">`</span>54a751c0<span class="o">)</span>   nt!KiSystemCall64   <span class="p">|</span>  <span class="o">(</span>fffff801<span class="sb">`</span>54a753eb<span class="o">)</span>   nt!KiSystemServiceUser</span></span></code></pre></div><p>执行syscall后进入内核态，之后大致流程为：</p>
<ul>
<li>KiSystemCall64Shadow</li>
<li>KiSystemServiceUser</li>
<li>KiSystemServiceStart</li>
<li>KiSystemServiceRepeat</li>
<li>KiSystemServiceGdiTebAccess</li>
<li>KiSystemServiceCopyStart</li>
<li>KiSystemServiceCopyEnd</li>
</ul>
<p>本文重点关注<code>KiSystemServiceUser</code> 、 <code>KiSystemServiceStart</code> 、 <code>KiSystemServiceRepeat</code> 和 <code>KiSystemServiceCopyEnd</code> 函数</p>
<h2 id="kisystemserviceuser" class="heading-element"><span>KiSystemServiceUser()</span>
  <a href="#kisystemserviceuser" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><code>KiSystemCall64</code> 结束后，执行<code>KiSystemServiceUser</code>，获取当前线程KTHREAD结构体地址</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">KiSystemServiceUser:</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp-55h</span><span class="p">],</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">rbx</span><span class="p">,</span> <span class="no">gs</span><span class="p">:</span><span class="no">KPCR.Prcb.CurrentThread</span>
</span></span><span class="line"><span class="cl"><span class="nf">prefetchw</span> <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbx</span><span class="err">+</span><span class="mi">90</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">stmxcsr</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp-54h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ldmxcsr</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="no">gs</span><span class="p">:</span><span class="mi">180</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nf">cmp</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbx</span><span class="err">+</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">word</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span><span class="err">+</span><span class="no">KPCR.KernelReserved</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nf">jz</span>      <span class="no">loc_1401C44C7</span></span></span></code></pre></div><p><img loading="lazy" src='/posts/2023-7-win-syscalljourney/Pasted-image-20230630163830.png' alt="Pasted-image-20230630163830" height="190" width="344"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">1: kd&gt; dt nt!_KPCR
</span></span><span class="line"><span class="cl">   +0x000 NtTib            : _NT_TIB
</span></span><span class="line"><span class="cl">   +0x000 GdtBase          : Ptr64 _KGDTENTRY64
</span></span><span class="line"><span class="cl">   +0x008 TssBase          : Ptr64 _KTSS64
</span></span><span class="line"><span class="cl">   +0x010 UserRsp          : Uint8B
</span></span><span class="line"><span class="cl">   +0x018 Self             : Ptr64 _KPCR
</span></span><span class="line"><span class="cl">   +0x020 CurrentPrcb      : Ptr64 _KPRCB
</span></span><span class="line"><span class="cl">   +0x028 LockArray        : Ptr64 _KSPIN_LOCK_QUEUE
</span></span><span class="line"><span class="cl">   +0x030 Used_Self        : Ptr64 Void
</span></span><span class="line"><span class="cl">   +0x038 IdtBase          : Ptr64 _KIDTENTRY64
</span></span><span class="line"><span class="cl">   +0x040 Unused           : <span class="o">[</span>2<span class="o">]</span> Uint8B
</span></span><span class="line"><span class="cl">   +0x050 Irql             : UChar
</span></span><span class="line"><span class="cl">   +0x051 SecondLevelCacheAssociativity : UChar
</span></span><span class="line"><span class="cl">   +0x052 ObsoleteNumber   : UChar
</span></span><span class="line"><span class="cl">   +0x053 Fill0            : UChar
</span></span><span class="line"><span class="cl">   +0x054 Unused0          : <span class="o">[</span>3<span class="o">]</span> Uint4B
</span></span><span class="line"><span class="cl">   +0x060 MajorVersion     : Uint2B
</span></span><span class="line"><span class="cl">   +0x062 MinorVersion     : Uint2B
</span></span><span class="line"><span class="cl">   +0x064 StallScaleFactor : Uint4B
</span></span><span class="line"><span class="cl">   +0x068 Unused1          : <span class="o">[</span>3<span class="o">]</span> Ptr64 Void
</span></span><span class="line"><span class="cl">   +0x080 KernelReserved   : <span class="o">[</span>15<span class="o">]</span> Uint4B
</span></span><span class="line"><span class="cl">   +0x0bc SecondLevelCacheSize : Uint4B
</span></span><span class="line"><span class="cl">   +0x0c0 HalReserved      : <span class="o">[</span>16<span class="o">]</span> Uint4B
</span></span><span class="line"><span class="cl">   +0x100 Unused2          : Uint4B
</span></span><span class="line"><span class="cl">   +0x108 KdVersionBlock   : Ptr64 Void
</span></span><span class="line"><span class="cl">   +0x110 Unused3          : Ptr64 Void
</span></span><span class="line"><span class="cl">   +0x118 PcrAlign1        : <span class="o">[</span>24<span class="o">]</span> Uint4B
</span></span><span class="line"><span class="cl">   +0x180 Prcb             : _KPRCB
</span></span><span class="line"><span class="cl">lkd&gt; dt nt!_KPRCB
</span></span><span class="line"><span class="cl">   +0x000 MxCsr            : Uint4B
</span></span><span class="line"><span class="cl">   +0x004 LegacyNumber     : UChar
</span></span><span class="line"><span class="cl">   +0x005 ReservedMustBeZero : UChar
</span></span><span class="line"><span class="cl">   +0x006 InterruptRequest : UChar
</span></span><span class="line"><span class="cl">   +0x007 IdleHalt         : UChar
</span></span><span class="line"><span class="cl">   +0x008 CurrentThread    : Ptr64 _KTHREAD
</span></span><span class="line"><span class="cl">   +0x010 NextThread       : Ptr64 _KTHREAD
</span></span><span class="line"><span class="cl">   +0x018 IdleThread       : Ptr64 _KTHREAD
</span></span><span class="line"><span class="cl">   ....</span></span></code></pre></div><p><code>_KPRCB</code>与 <code>_KPCR</code> 一样，包含处理器特定的数据，它还包含指向当前、下一个和空闲执行线程计划的指针。</p>
<p><code>KiSystemServiceUser()</code> 的末尾，<code>KTHREAD</code> 结构中初始化了两个值：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44C7</span> <span class="no">loc_1401C44C7</span><span class="p">:</span>                          <span class="c1">; CODE XREF: KiSystemCall64+259↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44C7</span>                 <span class="no">mov</span>     <span class="no">rax</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp-50h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44CB</span>                 <span class="no">mov</span>     <span class="no">rcx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp-48h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44CF</span>                 <span class="no">mov</span>     <span class="no">rdx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp-40h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44D3</span>                 <span class="no">sti</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44D4</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbx</span><span class="err">+</span><span class="no">_KTHREAD.FirstArgument</span><span class="p">],</span> <span class="no">rcx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44DB</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbx</span><span class="err">+</span><span class="no">_KTHREAD.SystemCallNumber</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44E1</span>                 <span class="no">db</span>      <span class="mi">66</span><span class="no">h</span><span class="p">,</span> <span class="mi">66</span><span class="no">h</span><span class="p">,</span> <span class="mi">66</span><span class="no">h</span><span class="p">,</span> <span class="mi">66</span><span class="no">h</span><span class="p">,</span> <span class="mi">66</span><span class="no">h</span><span class="p">,</span> <span class="mi">66</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44E1</span>                 <span class="no">nop</span>     <span class="no">word</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rax</span><span class="err">+</span><span class="no">rax</span><span class="err">+</span><span class="mi">00000000</span><span class="no">h</span><span class="p">]</span></span></span></code></pre></div><p>现在<code>rcx</code> = <code>FirstArgument</code>，<code>eax</code> = <code>SystemCallNumber</code>，之后是<code>KiSystemServiceStart</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44F0</span> <span class="no">KiSystemServiceStart</span><span class="p">:</span>                   <span class="c1">; DATA XREF: KiServiceInternal+5A↑o
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44F0</span>                                         <span class="c1">; .data:00000001403FF340↓o
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44F0</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbx</span><span class="err">+</span><span class="no">_KTHREAD.TrapFrame</span><span class="p">],</span> <span class="no">rsp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44F7</span>                 <span class="no">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44F9</span>                 <span class="no">shr</span>     <span class="no">edi</span><span class="p">,</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44FC</span>                 <span class="no">and</span>     <span class="no">edi</span><span class="p">,</span> <span class="mi">20</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C44FF</span>                 <span class="no">and</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span><span class="no">FFFh</span></span></span></code></pre></div><h2 id="syscall-number-和-kisystemservicestart" class="heading-element"><span>Syscall Number 和 KiSystemServiceStart()</span>
  <a href="#syscall-number-%e5%92%8c-kisystemservicestart" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>System Call Number包含两部分，<code>Table Identifier</code> 和 <code>System Call Index</code></p>
<p><img loading="lazy" src='/posts/2023-7-win-syscalljourney/Pasted-image-20230630170058.png' alt="Pasted-image-20230630170058" height="231" width="631"></p>
<p>这里以<code>NtQueryVirtualMemory()</code> 举例，系统调用号为<code>0x23</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span><span class="c1">#  edi = 23h = 0010 0011 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">shr</span>     <span class="no">edi</span><span class="p">,</span> <span class="mi">7</span><span class="c1">#右移6位 = 0000 0000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">and</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">20</span><span class="no">h</span>    <span class="c1"># edi = 00h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">and</span> <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span><span class="no">FFFh</span>  <span class="err">#</span> <span class="no">eax</span> <span class="err">=</span> <span class="mi">23</span><span class="no">h</span></span></span></code></pre></div><p><code>NtQueryVirtualMemory()</code> 的 <code>System Call Index</code> 是 <code>0x23</code></p>
<p>对于 <code>win32u.dll</code> 的函数 <code>NtUserSetMenu()</code> 来说， <code>System Call Number</code> 是 <code>0x1496h</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>    <span class="c1">// edi = 1496h = 0001 0100 1001 0110
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">shr</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">7</span>      <span class="c1">// 右移6位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">and</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">20</span><span class="no">h</span>    <span class="c1">// edi = 29h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">and</span> <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span><span class="no">FFFh</span>  <span class="err">//</span> <span class="no">eax</span> <span class="err">=</span> <span class="mi">1496</span><span class="no">h</span></span></span></code></pre></div><p><code>NtUserSetMenu()</code> 的 <code>System Call Index</code> 是 <code>496h</code> 。</p>
<p>如今，在 Windows 10 和 11 中， <code>Table Identifier</code> 上的初始值只能导致结果 <code>20h</code> 或 <code>00h</code> 。</p>
<ul>
<li>如果数字在 <code>1000h</code> 和 <code>1FFFh</code> 之间，则 <code>Table Identifier</code> 为 <code>20h</code> 。这种可以在 <code>win32u.dll</code> 上找到。与 Windows GUI 相关。</li>
<li>如果 <code>Syscall Number</code> 位于 <code>0h</code> 和 <code>FFFh</code> 之间，则 <code>Table Identifier</code> 为 <code>00h</code> 。这种可以在 <code>ntdll.dll</code> 上找到。与 <code>Native Function</code> 相关。</li>
</ul>
<p>后面会用到这里写的东西。</p>
<h2 id="kisystemservicerepeat" class="heading-element"><span>KiSystemServiceRepeat()</span>
  <a href="#kisystemservicerepeat" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>接下来是KiSystemServiceRepeat</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4504</span> <span class="no">KiSystemServiceRepeat</span><span class="p">:</span>                  <span class="c1">; CODE XREF: KiSystemCall64+8DE↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4504</span>                 <span class="no">lea</span>     <span class="no">r10</span><span class="p">,</span> <span class="no">KeServiceDescriptorTable</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C450B</span>                 <span class="no">lea</span>     <span class="no">r11</span><span class="p">,</span> <span class="no">KeServiceDescriptorTableShadow</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4512</span>                 <span class="no">test</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbx</span><span class="err">+</span><span class="mi">78</span><span class="no">h</span><span class="p">],</span> <span class="mi">80</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4519</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_1401C452E</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C451B</span>                 <span class="no">test</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbx</span><span class="err">+</span><span class="mi">78</span><span class="no">h</span><span class="p">],</span> <span class="mi">200000</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4522</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_1401C452B</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4524</span>                 <span class="no">lea</span>     <span class="no">r11</span><span class="p">,</span> <span class="no">KeServiceDescriptorTableFilter</span></span></span></code></pre></div><p>先加载了<code>KeServiceDescriptorTable</code>和<code>KeServiceDescriptorTableShadow</code>，统称为<code>SDT(Service Descriptor Table)</code></p>
<p><code>SDT</code> 包含4个<code>SERVICE_DESCRIPTOR_TABLE</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">tag_SERVICE_DESCRIPTOR_TABLE</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SYSTEM_SERVICE_TABLE</span> <span class="n">item1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SYSTEM_SERVICE_TABLE</span> <span class="n">item2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SYSTEM_SERVICE_TABLE</span> <span class="n">item3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SYSTEM_SERVICE_TABLE</span> <span class="n">item4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">SERVICE_DESCRIPTOR_TABLE</span><span class="p">;</span></span></span></code></pre></div><p><code>SERVICE_DESCRIPTOR_TABLE</code>包含4个元素：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">tag_SYSTEM_SERVICE_TABLE</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PULONG</span>      <span class="n">ServiceTable</span><span class="p">;</span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PULONG_PTR</span>  <span class="n">CounterTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG_PTR</span>   <span class="n">ServiceLimit</span><span class="p">;</span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PBYTE</span>       <span class="n">ArgumentTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">SYSTEM_SERVICE_TABLE</span><span class="p">;</span></span></span></code></pre></div><p><code>SYSTEM_SERVICE_TABLE</code> 由 4 个元素组成，但对我们来说只有 <code>ServiceTable</code> 和 <code>ServiceLimit</code> 有用</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">0: kd&gt; dps nt!KeServiceDescriptorTable
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b880  fffff801<span class="sb">`</span>54caf4c0 nt!KiServiceTable
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b888  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b890  00000000<span class="sb">`</span>000001cf
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b898  fffff801<span class="sb">`</span>54cafc00 nt!KiArgumentTable
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8a0  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8a8  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8b0  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8b8  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8c0  fffff801<span class="sb">`</span>54a6f780 nt!KiBreakpointTrap
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8c8  fffff801<span class="sb">`</span>54a6fa80 nt!KiOverflowTrap
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8d0  fffff801<span class="sb">`</span>54a74100 nt!KiRaiseSecurityCheckFailure
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8d8  fffff801<span class="sb">`</span>54a74440 nt!KiRaiseAssertion
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8e0  fffff801<span class="sb">`</span>54a74780 nt!KiDebugServiceTrap
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8e8  fffff801<span class="sb">`</span>54a751c0 nt!KiSystemCall64
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8f0  fffff801<span class="sb">`</span>54a74d00 nt!KiSystemCall32
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8f8  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0: kd&gt; dps nt!KeServiceDescriptorTableShadow
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df4980  fffff801<span class="sb">`</span>54caf4c0 nt!KiServiceTable
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df4988  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df4990  00000000<span class="sb">`</span>000001cf
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df4998  fffff801<span class="sb">`</span>54cafc00 nt!KiArgumentTable
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49a0  ffffb34b<span class="sb">`</span>e904b000
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49a8  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49b0  00000000<span class="sb">`</span>000004da
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49b8  ffffb34b<span class="sb">`</span>e904c84c
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49c0  00000000<span class="sb">`</span><span class="m">00111311</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49c8  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49d0  ffffffff<span class="sb">`</span><span class="m">80000018</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49d8  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49e0  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49e8  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49f0  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49f8  00000000<span class="sb">`</span><span class="m">00000000</span></span></span></code></pre></div><p>图示：</p>
<p><img loading="lazy" src='/posts/2023-7-win-syscalljourney/Pasted-image-20230630171806.png' alt="Pasted-image-20230630171806" height="554" width="791"></p>
<p>之后<code>test dword ptr [rbx+78h], 80h</code>，其中，KTHREAD偏移0x78的位置是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">union</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ULONG</span> <span class="nl">ThreadFlagsSpare</span><span class="p">:</span><span class="mi">2</span><span class="p">;</span>                                       <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">AutoAlignment</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                          <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">DisableBoost</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                           <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">AlertedByThreadId</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                      <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">QuantumDonation</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                        <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">EnableStackSwap</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                        <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">GuiThread</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                              <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">DisableQuantum</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                         <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">ChargeOnlySchedulingGroup</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                              <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">DeferPreemption</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                        <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">QueueDeferPreemption</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                   <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">ForceDeferSchedule</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                     <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">SharedReadyQueueAffinity</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                               <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">FreezeCount</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                            <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">TerminationApcRequest</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                  <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">AutoBoostEntriesExhausted</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                              <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">KernelStackResident</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                    <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">TerminateRequestReason</span><span class="p">:</span><span class="mi">2</span><span class="p">;</span>                                 <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">ProcessStackCountDecremented</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                           <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">RestrictedGuiThread</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                    <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">VpBackingThread</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                        <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">ThreadFlagsSpare2</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>                                      <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">EtwStackTraceApcInserted</span><span class="p">:</span><span class="mi">8</span><span class="p">;</span>                               <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">volatile</span> <span class="n">LONG</span> <span class="n">ThreadFlags</span><span class="p">;</span>                                          <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span></span></span></code></pre></div><p><code>0x80</code> 为检查 <code>GuiThread</code> 标志是否已设置，如果设置，检查<code>test    dword ptr [rbx+78h], 200000h</code>，之后巴拉巴拉&hellip;..但是第一次没有设置<code>GuiThread</code>，所以走<code>loc_1401C452E</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4512</span>                 <span class="no">test</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbx</span><span class="err">+</span><span class="mi">78</span><span class="no">h</span><span class="p">],</span> <span class="mi">80</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4519</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_1401C452E</span>
</span></span><span class="line"><span class="cl"><span class="na">........</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C452E</span>                 <span class="no">cmp</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">r10</span><span class="err">+</span><span class="no">rdi</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4533</span>                 <span class="no">jnb</span>     <span class="no">loc_1401C4A65</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A65</span> <span class="no">loc_1401C4A65</span><span class="p">:</span>                          <span class="c1">; CODE XREF: KiSystemCall64+373↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A65</span>                 <span class="no">cmp</span>     <span class="no">edi</span><span class="p">,</span> <span class="mi">20</span><span class="no">h</span> <span class="c1">; &#39; &#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A68</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">loc_1401C4AC5</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A6A</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbp-80h</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A6D</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbp-78h</span><span class="p">],</span> <span class="no">rcx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A71</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbp-70h</span><span class="p">],</span> <span class="no">rdx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A75</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbp-68h</span><span class="p">],</span> <span class="no">r8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A79</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbp-60h</span><span class="p">],</span> <span class="no">r9</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A7D</span>                 <span class="no">call</span>    <span class="no">KiConvertToGuiThread</span></span></span></code></pre></div><p>检查 <code>eax</code> 的值是否高于地址 <code>[r10+rdi+10h]</code> 处的值，其中</p>
<ul>
<li><code>eax</code> = <code>System Call Index</code></li>
<li><code>rdi</code> ：<code>KiSystemServiceStart()</code> 中先前提取的 <code>Table Identifier</code> 。值为 <code>0x20h</code> 或 <code>0x00h</code></li>
<li><code>r10</code> 包含 <code>KeServiceDescriptorTable</code> 的地址</li>
</ul>
<p><code>System Call Index</code> 与 <code>KeServiceDescriptorTable</code> 中的内容进行了比较。</p>
<p>如果系统调用与 GUI 函数相关，则有 <code>[KeServiceDescriptorTable+20h+10h]</code> ，否则 <code>[KeServiceDescriptorTable+00h+10h]</code> 。</p>
<p><code>KeServiceDescriptorTable</code>为:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">0: kd&gt; dps nt!KeServiceDescriptorTable
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b880  fffff801<span class="sb">`</span>54caf4c0 nt!KiServiceTable
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b888  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b890  00000000<span class="sb">`</span>000001cf  &lt;- <span class="o">[</span>KeServiceDescriptorTable+00h+10h<span class="o">]</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b898  fffff801<span class="sb">`</span>54cafc00 nt!KiArgumentTable
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8a0  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8a8  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8b0  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8b8  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8c0  fffff801<span class="sb">`</span>54a6f780 nt!KiBreakpointTrap
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8c8  fffff801<span class="sb">`</span>54a6fa80 nt!KiOverflowTrap
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8d0  fffff801<span class="sb">`</span>54a74100 nt!KiRaiseSecurityCheckFailure
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8d8  fffff801<span class="sb">`</span>54a74440 nt!KiRaiseAssertion
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8e0  fffff801<span class="sb">`</span>54a74780 nt!KiDebugServiceTrap
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8e8  fffff801<span class="sb">`</span>54a751c0 nt!KiSystemCall64
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8f0  fffff801<span class="sb">`</span>54a74d00 nt!KiSystemCall32
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b8f8  00000000<span class="sb">`</span><span class="m">00000000</span></span></span></code></pre></div><p>对于 GUI 函数（表标识符位于 <code>20h</code> ），公式为 <code>[KeServiceDescriptorTable+20h+10h]</code> -&gt; <code>[54e0b880+20h+10h]</code> -&gt; <code>[54e0b8b0]</code> 。这个地址的值为 <code>0h</code> 。</p>
<p>但是，如果我们的系统调用是本机函数，则表标识符将为 <code>00h</code> 和公式 <code>[KeServiceDescriptorTable+00h+10h]</code> -&gt; <code>[54e0b880+00h+10h]</code> -&gt; <code>[54e0b890]</code> 。我们可以看到这个地址的值为 <code>1CFh</code> 。这个值是<code>SYSTEM_SERVICE_TABLE.ServiceLimit</code>，表示 <code>ServiceTable</code> 中的元素个数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">tag_SYSTEM_SERVICE_TABLE</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PULONG</span>      <span class="n">ServiceTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PULONG_PTR</span>  <span class="n">CounterTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG_PTR</span>   <span class="n">ServiceLimit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PBYTE</span>       <span class="n">ArgumentTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">SYSTEM_SERVICE_TABLE</span><span class="p">;</span></span></span></code></pre></div><p><code>SYSTEM_SERVICE_TABLE</code> 的 <code>ServiceTable</code> 项是 <code>relative value address</code> (RVA) 的数组。该数组的每个元素都链接到一个内核例程函数。</p>
<p>所以，这个检查用来检查 <code>System Call Index</code> 是否有效。</p>
<p>如果是 <code>NtUserSetMenu()</code> 这样的 GUI 函数。它的 <code>Sytem Call Index</code> 是 <code>496h</code> ！因此检查将是 <code>496h &gt; 0h</code> 并且我们的 <code>System Call Index</code> 将被视为无效（也称为跳转）！</p>
<p>如果是 <code>NtQueryVirtualMemory()</code> ，不是 GUI 函数。所以在这种情况下，检查将是 if <code>23h (the System call Index of the function) &gt; 1CFh</code> 。由于 <code>23h</code> 低于 <code>1CFh</code> ，因此不会进行跳转，并且将在此函数中继续执行。</p>
<p>但是，在 <code>NtUserSetMenu()</code> 的情况下， <code>496h &gt; 00h</code> 。所以这里跳到 <code>loc_1401C4A65</code> 。</p>
<p>假设我们处于 <code>NtUserSetMenu()</code> 的情况，并且这是该线程第一次处理 GUI 函数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A65</span> <span class="no">loc_1401C4A65</span><span class="p">:</span>                          <span class="c1">; CODE XREF: KiSystemCall64+373↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A65</span>                 <span class="no">cmp</span>     <span class="no">edi</span><span class="p">,</span> <span class="mi">20</span><span class="no">h</span> <span class="c1">; &#39; &#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A68</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">loc_1401C4AC5</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A6A</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbp-80h</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A6D</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbp-78h</span><span class="p">],</span> <span class="no">rcx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A71</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbp-70h</span><span class="p">],</span> <span class="no">rdx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A75</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbp-68h</span><span class="p">],</span> <span class="no">r8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A79</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbp-60h</span><span class="p">],</span> <span class="no">r9</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A7D</span>                 <span class="no">call</span>    <span class="no">KiConvertToGuiThread</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A82</span>                 <span class="no">or</span>      <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A84</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp-80h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A87</span>                 <span class="no">mov</span>     <span class="no">rcx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp-78h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A8B</span>                 <span class="no">mov</span>     <span class="no">rdx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp-70h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A8F</span>                 <span class="no">mov</span>     <span class="no">r8</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp-68h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A93</span>                 <span class="no">mov</span>     <span class="no">r9</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp-60h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A97</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbx</span><span class="err">+</span><span class="mi">90</span><span class="no">h</span><span class="p">],</span> <span class="no">rsp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4A9E</span>                 <span class="no">jz</span>      <span class="no">KiSystemServiceRepeat</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4AA4</span>                 <span class="no">lea</span>     <span class="no">rdi</span><span class="p">,</span> <span class="no">xmmword_1405439A0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4AAB</span>                 <span class="no">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="p">[</span><span class="no">rdi</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4AAE</span>                 <span class="no">mov</span>     <span class="no">rdi</span><span class="p">,</span> <span class="p">[</span><span class="no">rdi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4AB1</span>                 <span class="no">cmp</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4AB3</span>                 <span class="no">jnb</span>     <span class="no">short</span> <span class="no">loc_1401C4AC5</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4AB5</span>                 <span class="no">lea</span>     <span class="no">rdi</span><span class="p">,</span> <span class="p">[</span><span class="no">rdi</span><span class="err">+</span><span class="no">rsi</span><span class="p">*</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4AB9</span>                 <span class="no">movsx</span>   <span class="no">eax</span><span class="p">,</span> <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rdi</span><span class="err">+</span><span class="no">rax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4ABD</span>                 <span class="no">or</span>      <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4ABF</span>                 <span class="no">jle</span>     <span class="no">KiSystemServiceExit</span></span></span></code></pre></div><p>如果 <code>edi</code> 是 <code>20h</code> ，这意味着我们正在处理一个GUI函数，我们需要通过函数 <code>KiConvertGuiThread</code> 将当前线程转换为GUI线程，然后返回到 <code>KiSystemServiceRepeat</code></p>
<p>但如果 <code>edi</code> 不是 <code>20h</code> ，则意味着我们的系统调用不是来自 GUI 函数，并且 <code>System Call Index</code> 超出了 <code>ServiceTable</code> .因此，在最后一种情况下，例程基本上退出系统调用处理工作流程</p>
<p>处于 <code>NtUserSetMenu()</code> 的情况，当前的线程将转换为 GUI 线程，然后我们回到 <code>KiSystemServiceRepeat()</code> 的开头</p>
<p>用 <code>test dword ptr [rbx+78h], 80h</code> 检查的 <code>GuiThread</code> 标志将被设置，跳转并执行下面的指令</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4504</span> <span class="no">KiSystemServiceRepeat</span><span class="p">:</span>                  <span class="c1">; CODE XREF: KiSystemCall64+8DE↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4504</span>                 <span class="no">lea</span>     <span class="no">r10</span><span class="p">,</span> <span class="no">KeServiceDescriptorTable</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C450B</span>                 <span class="no">lea</span>     <span class="no">r11</span><span class="p">,</span> <span class="no">KeServiceDescriptorTableShadow</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4512</span>                 <span class="no">test</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbx</span><span class="err">+</span><span class="mi">78</span><span class="no">h</span><span class="p">],</span> <span class="mi">80</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4519</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_1401C452E</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C451B</span>                 <span class="no">test</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbx</span><span class="err">+</span><span class="mi">78</span><span class="no">h</span><span class="p">],</span> <span class="mi">200000</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4522</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_1401C452B</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4524</span>                 <span class="no">lea</span>     <span class="no">r11</span><span class="p">,</span> <span class="no">KeServiceDescriptorTableFilter</span></span></span></code></pre></div><p>0x200000是<code>RestrictedGuiThread</code>，如果设置了此标志，则 <code>r10</code> 的值将是 <code>KeServiceDescriptorTableFilter</code> 的地址，否则它将是 <code>KeServiceDescriptorTableShadow</code></p>
<p>因此，从这里看来，对于<code>Native</code>函数，将使用 <code>KeServiceDescriptorTable</code>，对于 GUI 函数，它将使用 <code>KeServiceDescriptorTableFilter</code> 或 <code>KeServiceDescriptorTableShadow</code></p>
<p>在 Windows 10 之前，仅存在两个 <code>Service Descriptor Table</code> 。 <code>KeServiceDescriptorTable</code> 和 <code>KeServiceDescriptorTableShadow</code> 。</p>
<p>自 Windows 10 起，引入了 <code>KeServiceDescriptorTableFilter</code> 表。</p>
<p>由于内核处理的 GUI 函数通常是漏洞利用研究的目标，因此 Microsoft 决定引入这个新表来减少攻击面。这里有一篇 Google Project Zero 的文章：</p>
<blockquote>
<p><a href="https://googleprojectzero.blogspot.com/2016/11/breaking-chain.html"target="_blank" rel="external nofollow noopener noreferrer">https://googleprojectzero.blogspot.com/2016/11/breaking-chain.html</a></p></blockquote>
<p>关于这张表的信息很少。在 <code>Windows Internals Part 1</code> 一书中可以找到的内容：</p>
<blockquote>
<p><strong>Filter Win32k System Call</strong>: This filters access to the Win32k kernel-mode subsystem driver only to certain API allowing simple GUI and Direct X access, mitigating many of the possible attacks, without completely disabling availability of the GUI/GDI Services.</p>
<p>过滤 Win32k 系统调用：这会过滤对 Win32k 内核模式子系统驱动程序的访问，仅允许某些 API 允许简单的 GUI 和 Direct X 访问，从而减轻许多可能的攻击，而不会完全禁用 GUI/GDI 服务的可用性。</p>
<p>This [filtering] is set through an internal process creation attribute flag, which can define one out of three possible sets of Win32k filters that are enabled. However, because the filter sets are hard-coded, this mitigation is reserved for Microsoft internal usage.</p>
<p>此[过滤]是通过内部进程创建属性标志设置的，该标志可以定义启用的三组可能的 Win32k 过滤器中的一组。但是，由于筛选器集是硬编码的，因此此缓解措施保留供 Microsoft 内部使用。</p></blockquote>
<p>继续，如果是 GUI 函数，则会跳转到<code>loc_1401C4A65</code></p>
<p><img loading="lazy" src='/posts/2023-7-win-syscalljourney/Pasted-image-20230702142244.png' alt="Pasted-image-20230702142244" height="315" width="593"></p>
<p>但是这次是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C452E</span> <span class="no">loc_1401C452E</span><span class="p">:</span>                          <span class="c1">; CODE XREF: KiSystemCall64+359↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C452E</span>                 <span class="no">cmp</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">r10</span><span class="err">+</span><span class="no">rdi</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4533</span>                 <span class="no">jnb</span>     <span class="no">loc_1401C4A65</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4539</span>                 <span class="no">mov</span>     <span class="no">r10</span><span class="p">,</span> <span class="p">[</span><span class="no">r10</span><span class="err">+</span><span class="no">rdi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C453D</span>                 <span class="no">movsxd</span>  <span class="no">r11</span><span class="p">,</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">r10</span><span class="err">+</span><span class="no">rax</span><span class="p">*</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4541</span>                 <span class="no">mov</span>     <span class="no">rax</span><span class="p">,</span> <span class="no">r11</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4544</span>                 <span class="no">sar</span>     <span class="no">r11</span><span class="p">,</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4548</span>                 <span class="no">add</span>     <span class="no">r10</span><span class="p">,</span> <span class="no">r11</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C454B</span>                 <span class="no">cmp</span>     <span class="no">edi</span><span class="p">,</span> <span class="mi">20</span><span class="no">h</span> <span class="c1">; &#39; &#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C454E</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">loc_1401C45A0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4550</span>                 <span class="no">mov</span>     <span class="no">r11</span><span class="p">,</span> <span class="p">[</span><span class="no">rbx</span><span class="err">+</span><span class="no">_KTHREAD.Teb</span><span class="p">]</span></span></span></code></pre></div><p>根据标志 <code>RestrictedGuiThread</code> 的值， <code>r10</code> 的值现在是 <code>KeServiceDescriptorTableFilter</code> 或 <code>KeServiceDescriptorTableShadow</code>的地址</p>
<p>为了简化，我们会说在这种情况下，我们的进程不受 <code>Win32k filters</code> 保护，因此使用 <code>KeServiceDescriptorTableShadow</code></p>
<p>再看一下<code>KeServiceDescriptorTableShadow</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">0: kd&gt; dps nt!KeServiceDescriptorTableShadow
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df4980  fffff801<span class="sb">`</span>54caf4c0 nt!KiServiceTable
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df4988  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df4990  00000000<span class="sb">`</span>000001cf
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df4998  fffff801<span class="sb">`</span>54cafc00 nt!KiArgumentTable
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49a0  ffffb34b<span class="sb">`</span>e904b000
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49a8  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49b0  00000000<span class="sb">`</span>000004da &lt;- <span class="o">[</span>KeServiceDescriptorTableShadow+20h+10h<span class="o">]</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49b8  ffffb34b<span class="sb">`</span>e904c84c
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49c0  00000000<span class="sb">`</span><span class="m">00111311</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49c8  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49d0  ffffffff<span class="sb">`</span><span class="m">80000018</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49d8  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49e0  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49e8  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49f0  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49f8  00000000<span class="sb">`</span><span class="m">00000000</span></span></span></code></pre></div><p><code>[r10+rdi+10h]</code> -&gt; <code>[KeServiceDescriptorTableShadow+20h+10h]</code> -&gt; <code>[54df4980+20h+10h]</code> -&gt; <code>[54df49b0]</code> 。我们可以看到这个地址的值为 <code>4DAh</code></p>
<p><code>NtUserSetMenu</code> 的<code>syscall number</code> 是 <code>0x496 &lt; 0x4da</code></p>
<p>其中</p>
<ul>
<li><code>r10</code> = <code>KeServiceDescriptorTableShadow</code> 或者 <code>KeServiceDescriptorTable</code></li>
<li><code>rdi</code> = <code>TI</code></li>
<li><code>rax</code> = <code>syscall number</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">r10</span><span class="p">,</span> <span class="p">[</span><span class="no">r10</span><span class="err">+</span><span class="no">rdi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1">// For NtQueryVirtualMemory()   -&gt; [KeServiceDescriptorTable+00h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">//</span> <span class="nf">For</span> <span class="no">NtUserSetMenu</span><span class="p">()</span>          <span class="p">-</span><span class="err">&gt;</span> <span class="p">[</span><span class="no">KeServiceDescriptorTableShadow</span><span class="err">+</span><span class="mi">20</span><span class="no">h</span><span class="p">]</span></span></span></code></pre></div><p>如果是<code>NtQueryVirtualMemory</code>的话，r10 就是 <code>KiServiceTable</code> 的地址：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">0: kd&gt; dps nt!KeServiceDescriptorTable
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b880  fffff801<span class="sb">`</span>54caf4c0 nt!KiServiceTable &lt;- <span class="o">[</span>KeServiceDescriptorTable+00h<span class="o">]</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b888  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b890  00000000<span class="sb">`</span>000001cf
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54e0b898  fffff801<span class="sb">`</span>54cafc00 nt!KiArgumentTable</span></span></code></pre></div><p>如果是<code>NtUserSetMenu</code>的话，r10 就是 <code>W32pServiceTable</code> 的地址：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">0: kd&gt; dps nt!KeServiceDescriptorTableShadow
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df4980  fffff801<span class="sb">`</span>54caf4c0 nt!KiServiceTable
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df4988  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df4990  00000000<span class="sb">`</span>000001cf
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df4998  fffff801<span class="sb">`</span>54cafc00 nt!KiArgumentTable
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49a0  ffffb34b<span class="sb">`</span>e904b000 win32k!W32pServiceTable &lt;- <span class="o">[</span>KeServiceDescriptorTableShadow+20h<span class="o">]</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49a8  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49b0  00000000<span class="sb">`</span>000004da
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49b8  ffffb34b<span class="sb">`</span>e904c84c win32k!W32pArgumentTable
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49c0  00000000<span class="sb">`</span><span class="m">00111311</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49c8  00000000<span class="sb">`</span><span class="m">00000000</span>
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54df49d0  ffffffff<span class="sb">`</span><span class="m">80000018</span></span></span></code></pre></div><blockquote>
<p>在你想要加载的那个模块， .reload /f xxx.dll 。
.reload</p></blockquote>
<p>符号 <code>nt!</code> 表示该地址位于模块 <code>ntoskrnl.exe</code> 中。 <code>win32k!</code> 表示该地址位于驱动程序 <code>win32k.sys</code> 中。</p>
<p>在这里我们可以明确地看到 GUI 函数和 Native 函数根本不在内核的同一部分。</p>
<p>继续：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">movsxd</span>  <span class="no">r11</span><span class="p">,</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">r10</span><span class="err">+</span><span class="no">rax</span><span class="p">*</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// For NtQueryVirtualMemory()   -&gt; [nt!KiServiceTable + 23h*4h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">//</span> <span class="nf">For</span> <span class="no">NtUserSetMenu</span><span class="p">()</span>          <span class="p">-</span><span class="err">&gt;</span> <span class="p">[</span><span class="no">win32k</span><span class="p">!</span><span class="no">W32pServiceTable</span> <span class="err">+</span> <span class="mi">496</span><span class="no">h</span><span class="p">*</span><span class="mi">4</span><span class="no">h</span><span class="p">]</span></span></span></code></pre></div><p>这里 <code>r11</code> 将存储 <code>Service Table</code> 中的值。 <code>Service Table</code> 也称为 <code>System Service Dispatch Table</code> (S​​SDT)。</p>
<blockquote>
<p><code>movsxd</code> 是一个 <code>mov</code> ，它允许在将较小的寄存器复制到 64 位寄存器时保留符号扩展。这是通过用符号扩展填充额外的位来完成的</p></blockquote>
<p><code>Service Table</code> 是与内核例程相关的 <code>RVA</code> 数组</p>
<p>对于<code>NtQueryVirtualMemory</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">0: kd&gt; dd /c1 nt!KiServiceTable + 4*0x23 L1
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54caf54c  02950d02</span></span></code></pre></div><p>对于<code>NtUserSetMenu</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">1: kd&gt; dd /c1 W32pServiceTable + 4*0x496 L1
</span></span><span class="line"><span class="cl">ffffb34b<span class="sb">`</span>e904c258  ff9a8ca0</span></span></code></pre></div><p>乘4是因为 数组中的每一项都是 4 个字节长</p>
<p><img loading="lazy" src='/posts/2023-7-win-syscalljourney/Pasted-image-20230702203238.png' alt="Pasted-image-20230702203238" height="713" width="761"></p>
<p>继续：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">rax</span><span class="p">,</span> <span class="no">r11</span>
</span></span><span class="line"><span class="cl"><span class="nf">sar</span>     <span class="no">r11</span><span class="p">,</span> <span class="mi">4</span> <span class="err">//</span> <span class="err">右移</span><span class="mi">4</span><span class="err">位</span></span></span></code></pre></div><p>RVA保存到<code>rax</code>.</p>
<p>对于 <code>NtQueryVirtualMemory()</code> 的情况，在 <code>RVA</code> <code>02950d02</code> 上向右算术移位 4 位将得到 <code>02950d0</code>
对于 <code>NtUserSetMenu()</code> 的情况，在 <code>RVA</code> <code>ff9a8ca0h</code> 上向右移动 4 位将得到 <code>0xFFF9A8CA</code></p>
<p>右移4位是因为 <code>SSDT</code> 中检索到的数据实际上包含2个东西。
最右面 4 位是使用<strong>堆栈</strong>传递的参数数量，其余的是我们的 RVA。因此，通过右移 4 位可以检索 <code>RVA</code> 的实际值。</p>
<ul>
<li><code>NtQueryVirtualMemory</code>：<code>02953402</code>，两个参数</li>
<li><code>NtUserSetMenu</code>：<code>ff9a8ca0</code>，0个参数</li>
</ul>
<p>但是 <code>NtQueryVirtualMemory</code> 的参数其实是6个：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">NtQueryVirtualMemory</span><span class="p">(</span>
</span></span><span class="line"><span class="cl"> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">PVOID</span> <span class="n">BaseAddress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">MEMORY_INFORMATION_CLASS</span> <span class="n">MemoryInformationClass</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">PVOID</span> <span class="n">Buffer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">ULONG</span> <span class="n">Length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">PULONG</span> <span class="n">ResultLength</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>	
</span></span></code></pre></div><p>在 32 位中，函数的所有参数都是使用堆栈传递的。在 Windows 64 位系统中，前 4 个参数按以下顺序使用以下寄存器传递：</p>
<ul>
<li><code>RCX</code>; </li>
<li><code>RDX</code>;  </li>
<li><code>R8</code>; </li>
<li><code>R9</code>.</li>
</ul>
<p><code>NtUserSetMenu()</code> 使用 3 个参数，因此将使用 <code>RCX</code> 、 <code>RDX</code> 和 <code>R8</code> 寄存器传递它们。这里不会涉及堆栈，因此 <code>ff9a8ca0</code> 中使用堆栈传递 0 个参数。
<code>NtQueryVirtualMemory()</code> 使用 6 个参数，前 4 个参数将使用 <code>RCX</code> 、 <code>RDX</code> 、 <code>R8</code> 和 <code>R9</code> 中的 2 个参数使用堆栈传递</p>
<p>将 <code>RVA</code> 添加到 <code>System Service Dispatch Table</code> 的地址中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">add</span>     <span class="no">r10</span><span class="p">,</span> <span class="no">r11</span> <span class="err">//</span> <span class="no">r10</span> <span class="err">=</span> <span class="no">SSDT</span><span class="p">,</span> <span class="no">r11</span> <span class="err">=</span> <span class="no">RVA</span></span></span></code></pre></div><p>来看看这个地址有什么。</p>
<p>对于 <code>NtQueryVirtualMemory()</code> 这里有问题，，，得改改（）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">1: kd&gt; u nt!KiServiceTable + <span class="m">00295340</span> L1
</span></span><span class="line"><span class="cl">nt!MmQueryVirtualMemory+0x240:
</span></span><span class="line"><span class="cl">fffff801<span class="sb">`</span>54f44800 <span class="m">2440</span>            and     al,40h</span></span></code></pre></div><p>对于<code>NtUserSetMenu()</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">1: kd&gt; u W32pServiceTable +  <span class="o">(</span>-65736<span class="o">)</span> L1
</span></span><span class="line"><span class="cl">win32k!NtUserSetMenu:
</span></span><span class="line"><span class="cl">ffffb34b<span class="sb">`</span>e8fe58ca 48ff2587730500  jmp     qword ptr <span class="o">[</span>win32k!_imp_NtUserSetMenu <span class="o">(</span>ffffb34b<span class="sb">`</span>e903cc58<span class="o">)]</span></span></span></code></pre></div><p>在内核中找到了函数的地址！！！</p>
<p><img loading="lazy" src='/posts/2023-7-win-syscalljourney/Pasted-image-20230702211312.png' alt="Pasted-image-20230702211312" height="662" width="760"></p>
<p>继续来看<code>NtUserSetMenu</code>，但这次是在 <code>KeServiceDescriptorTableFilter</code> 表中</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">1: kd&gt;  .reload /f win32k.sys
</span></span><span class="line"><span class="cl">1: kd&gt; dd /c1 win32k!W32pServiceTableFilter+4*0x496 L1
</span></span><span class="line"><span class="cl">ffffb34b<span class="sb">`</span>e904df88  ffd2b100
</span></span><span class="line"><span class="cl">1: kd&gt; ? <span class="o">(</span>ffd2b100&gt;&gt;&gt;4<span class="o">)</span>
</span></span><span class="line"><span class="cl">Evaluate expression: <span class="nv">268249872</span> <span class="o">=</span> 00000000<span class="sb">`</span>0ffd2b10
</span></span><span class="line"><span class="cl">1: kd&gt; dd /c1 win32k!W32pServiceTableFilter+ffffffff<span class="sb">`</span>fffd2b10 L1
</span></span><span class="line"><span class="cl">ffffb34b<span class="sb">`</span>e901f840  48ec8348
</span></span><span class="line"><span class="cl">1: kd&gt; u win32k!W32pServiceTableFilter+ffffffff<span class="sb">`</span>fffd2b10 L1
</span></span><span class="line"><span class="cl">win32k!stub_UserSetMenu:
</span></span><span class="line"><span class="cl">ffffb34b<span class="sb">`</span>e901f840 4883ec48        sub     rsp,48h</span></span></code></pre></div><p>这里的函数名称不同。该函数称为 <code>stub_UserSetMenu</code> 而不是 <code>NtUserSetMenu</code></p>
<p>可以在 <code>Windows Internals Part 2</code> 书中找到答案。</p>
<blockquote>
<p>The only material difference between the Filter entries is that they point to system calls in Win32k.sys <strong>with names like stub_UserGetThreadState, while the real array [SSDT not filtered] points to NtUserGetThreadState</strong>. The former stubs will <strong>check if Win32k.sys filtering enabled for this system call</strong>, based, in part, on the filter set that’s been loaded for the process.</p>
<p>Filter 条目之间唯一的实质性区别是它们指向 Win32k.sys 中的系统调用，其名称类似于 Stub_UserGetThreadState，而实际数组 [SSDT 未过滤] 指向 NtUserGetThreadState。前一个存根将检查是否为此系统调用启用了 Win32k.sys 过滤，部分基于已为进程加载的过滤器集。</p>
<p>Based on this determination, <strong>they will either fail the call and return STATUS_INVALID_SYSTEM_SERVICE if the filter set prohibits it or end up calling the original function</strong> (such as NtUserGetThreadState), with potential telemetry if auditing is enabled.</p>
<p>基于此确定，如果过滤器集禁止调用，它们将导致调用失败并返回 STATUS_INVALID_SYSTEM_SERVICE，或者最终调用原始函数（例如 NtUserGetThreadState），如果启用了审核，则可能会进行遥测。</p></blockquote>
<h2 id="kisystemservicecopyend" class="heading-element"><span>KiSystemServiceCopyEnd()</span>
  <a href="#kisystemservicecopyend" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>之后执行<code>KiSystemServiceGdiTebAccess</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4557</span> <span class="no">KiSystemServiceGdiTebAccess</span><span class="p">:</span>            <span class="c1">; DATA XREF: KiSystemServiceHandler+D↑o
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4557</span>                 <span class="no">cmp</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">r11</span><span class="err">+</span><span class="mi">1740</span><span class="no">h</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C455F</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_1401C45A0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4561</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbp-50h</span><span class="p">],</span> <span class="no">rax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4565</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbp-48h</span><span class="p">],</span> <span class="no">rcx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4569</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rbp-40h</span><span class="p">],</span> <span class="no">rdx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C456D</span>                 <span class="no">mov</span>     <span class="no">rbx</span><span class="p">,</span> <span class="no">r8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4570</span>                 <span class="no">mov</span>     <span class="no">rdi</span><span class="p">,</span> <span class="no">r9</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4573</span>                 <span class="no">mov</span>     <span class="no">rsi</span><span class="p">,</span> <span class="no">r10</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4576</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C457B</span>                 <span class="no">xor</span>     <span class="no">edx</span><span class="p">,</span> <span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C457D</span>                 <span class="no">xor</span>     <span class="no">r8</span><span class="p">,</span> <span class="no">r8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4580</span>                 <span class="no">xor</span>     <span class="no">r9</span><span class="p">,</span> <span class="no">r9</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4583</span>                 <span class="no">call</span>    <span class="no">PsInvokeWin32Callout</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4588</span>                 <span class="no">mov</span>     <span class="no">rax</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp-50h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C458C</span>                 <span class="no">mov</span>     <span class="no">rcx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp-48h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4590</span>                 <span class="no">mov</span>     <span class="no">rdx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp-40h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4594</span>                 <span class="no">mov</span>     <span class="no">r8</span><span class="p">,</span> <span class="no">rbx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4597</span>                 <span class="no">mov</span>     <span class="no">r9</span><span class="p">,</span> <span class="no">rdi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C459A</span>                 <span class="no">mov</span>     <span class="no">r10</span><span class="p">,</span> <span class="no">rsi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C459D</span>                 <span class="no">nop</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C45A0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C45A0</span> <span class="no">loc_1401C45A0</span><span class="p">:</span>                          <span class="c1">; CODE XREF: KiSystemCall64+38E↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C45A0</span>                                         <span class="c1">; KiSystemCall64+39F↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C45A0</span>                 <span class="no">and</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span><span class="no">Fh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C45A3</span>                 <span class="no">jz</span>      <span class="no">KiSystemServiceCopyEnd</span></span></span></code></pre></div><p>再之后是<code>KiSystemServiceCopyEnd</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4660</span> <span class="no">KiSystemServiceCopyEnd</span><span class="p">:</span>                 <span class="c1">; CODE XREF: KiSystemCall64+3E3↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4660</span>                                         <span class="c1">; DATA XREF: KiSystemServiceHandler+27↑o ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4660</span>                 <span class="no">test</span>    <span class="no">cs</span><span class="p">:</span><span class="no">KiDynamicTraceMask</span><span class="p">,</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C466A</span>                 <span class="no">jnz</span>     <span class="no">loc_1401C4B03</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4670</span>                 <span class="no">test</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="no">cs</span><span class="p">:</span><span class="no">PerfGlobalGroupMask</span><span class="err">+</span><span class="mi">8</span><span class="p">,</span> <span class="mi">40</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C467A</span>                 <span class="no">jnz</span>     <span class="no">loc_1401C4B77</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4680</span>                 <span class="no">mov</span>     <span class="no">rax</span><span class="p">,</span> <span class="no">r10</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000001401</span><span class="nf">C4683</span>                 <span class="no">call</span>    <span class="no">rax</span></span></span></code></pre></div><p>这里有个 <code>call rax</code>，<code>rax</code>来自<code>r10</code>，<code>r10</code>保存的是内核函数的具体地址，至此，<code>syscall</code>的流程就走完了</p>
<pre tabindex="0"><code>**Security Note**: 安全注意事项：

At this point you may think “Ok, so I just have to make a malicious driver and place hooks on the `LSTAR` register or in the `SSDT` to hijack the kernel workflow”. Well, there was a time when this was possible. Actually, it was a way for EDR or AV to perform analysis (like today with hooks in DLLs).  
此时您可能会想“好吧，所以我只需制作一个恶意驱动程序并在 `LSTAR` 寄存器或 `SSDT` 寄存器或 `SSDT` 中放置挂钩来劫持内核工作流程”。嗯，曾经有一段时间这是可能的。实际上，这是 EDR 或 AV 执行分析的一种方式（就像今天在 DLL 中使用钩子一样）。

However, it’s not possible anymore. To prevent this kind of change, Microsoft invented the `Kernel Patch Protection` (KPP) also known as `Patch Guard` (PG). With `KPP`, any attempt to patch the `SSDT` or `LSTAR` will lead to a a `BSOD` (blue screen of death).  
然而，这已经不可能了。为了防止这种变化，微软发明了 `Kernel Patch Protection` （KPP）也称为 `Patch Guard` （PG）。对于 `KPP` ，任何修补 `SSDT` 或 `LSTAR` 的尝试都将导致 `BSOD` （蓝屏死机）。</code></pre><p><strong>Security Note</strong>:</p>
<p>此时可能会想：好吧，所以我只需制作一个恶意驱动程序并在 <code>LSTAR</code> 寄存器或 <code>SSDT</code> 寄存器或 <code>SSDT</code> 中放置挂钩来劫持内核工作流程”。嗯，曾经有一段时间这是可能的。实际上，这是 EDR 或 AV 执行分析的一种方式（就像今天在 DLL 中使用钩子一样）。</p>
<p>然而，这已经不可能了。为了防止这种变化，微软发明了 <code>Kernel Patch Protection</code> （KPP）也称为 <code>Patch Guard</code> （PG）。对于 <code>KPP</code> ，任何修补 <code>SSDT</code> 或 <code>LSTAR</code> 的尝试都将导致 <code>BSOD</code> （蓝屏死机）。</p>
<p>ref：</p>
<blockquote>
<p><a href="https://alice.climent-pommeret.red/posts/a-syscall-journey-in-the-windows-kernel/#the-execution-of-the-kernel-routine-via-kisystemservicecopyend"target="_blank" rel="external nofollow noopener noreferrer">https://alice.climent-pommeret.red/posts/a-syscall-journey-in-the-windows-kernel/#the-execution-of-the-kernel-routine-via-kisystemservicecopyend</a></p>
<p><a href="https://www.codeproject.com/Articles/1191465/The-Quest-for-the-SSDTs"target="_blank" rel="external nofollow noopener noreferrer">https://www.codeproject.com/Articles/1191465/The-Quest-for-the-SSDTs</a></p>
<p><a href="https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/glimpse-into-ssdt-in-windows-x64-kernel"target="_blank" rel="external nofollow noopener noreferrer">https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/glimpse-into-ssdt-in-windows-x64-kernel</a></p></blockquote>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2023-07-03 00:00:00">Updated on 2023-07-03&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on X" data-sharer="twitter" data-url="https://nesl42.github.io/posts/2023-7-win-syscalljourney/" data-title="Syscall Journey" data-hashtags="WINDOWS"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://nesl42.github.io/posts/2023-7-win-syscalljourney/" data-hashtag="WINDOWS"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://nesl42.github.io/posts/2023-7-win-syscalljourney/" data-title="Syscall Journey"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/windows/" class="post-tag" title="Tags - Windows">Windows</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/2023-5aflwritepaper/" class="post-nav-item" rel="prev" title="【译】AFL白皮书"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>【译】AFL白皮书</a><a href="/posts/2023-7-sdqrcode/" class="post-nav-item" rel="next" title="Stable Diffusion QR Code">Stable Diffusion QR Code<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.145.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.17-8212d6fd"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"version":"v0.3.17-8212d6fd"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
