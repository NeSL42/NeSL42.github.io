<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>10.Uniswap V3 流动性计算 - 敬渊&#39;s Blog</title><meta name="author" content="">
<meta name="description" content="好的，这是根据你的要求修改和完善后的最终学习笔记。
核心摘要 (Key Takeaways) Uniswap V3 的核心创新：通过引入价格区间 $p \in [p_a, p_b]$ 和虚拟流动性 ($x_{virtual}$, $y_{virtual}$) 的概念，实现了集中流动性，允许用户将资金集中在特定价格范围，从而极大地提高了资金效率。 V3 核心公式：V3 的流动性计算公式是 V2 中 $x \cdot y = L^2$ 的演进，具体形式为 $$(x_{real} &#43; \frac{L}{\sqrt{p_b}}) \cdot (y_{real} &#43; L\sqrt{p_a}) = L^2$$。这个公式是理解 V3 机制的关键。 资金效率与价格区间的关系：用户设定的价格区间 $[p_a, p_b]$ 越窄（即 $p_a$ 越大，$p_b$ 越小，两者越接近），提供的虚拟流动性就越大。这意味着可以用更少的真实资金（$x_{real}$, $y_{real}$）达到与 V2 相同的流动性深度（L 值），即资金效率越高。 模拟限价订单：利用价格区间特性，用户可以通过在价格区间的某一端点（如 $p_a$）存入单一资产，当市场价格穿过整个区间到达另一端点（$p_b$）时，该资产会被完全兑换成另一种资产，从而实现类似限价订单的效果。 1. Uniswap V3 核心概念回顾 1.1 集中流动性与虚拟流动性 Uniswap V2: 流动性平均分布在 $(0, &#43;∞)` 的整个价格曲线上。 Uniswap V3: 引入了价格区间 $[p_a, p_b]$ 的概念，允许流动性提供者（LP）将资金集中在他们认为最可能发生交易的价格范围内。 虚拟流动性 (Virtual Liquidity): 为了在有限的价格区间 $[p_a, p_b]$ 内构建出一条标准的 $x \cdot y = k$ 曲线，V3 引入了虚拟的 x 和 y 资产（$x_{virtual}$ 和 $y_{virtual}$）。 这些虚拟资产仅用于数学计算，并不需要用户真实提供。 用户实际提供的资产被称为真实流动性 (Real Liquidity)（$x_{real}$ 和 $y_{real}$）。 总流动性 = 真实流动性 &#43; 虚拟流动性。 总 X: $$x_{total} = x_{real} &#43; x_{virtual}$$ 总 Y: $$y_{total} = y_{real} &#43; y_{virtual}$$ 2. Uniswap V3 核心公式推导 2.1 基础关系：确定 X, Y, L, P 的关系 基础恒定乘积公式: $$ x \cdot y = k = L^2 $$ 其中 $L$ 代表流动性 (Liquidity)。
"><meta name="keywords" content='Web3'>
  <meta itemprop="name" content="10.Uniswap V3 流动性计算">
  <meta itemprop="description" content="好的，这是根据你的要求修改和完善后的最终学习笔记。
核心摘要 (Key Takeaways) Uniswap V3 的核心创新：通过引入价格区间 $p \in [p_a, p_b]$ 和虚拟流动性 ($x_{virtual}$, $y_{virtual}$) 的概念，实现了集中流动性，允许用户将资金集中在特定价格范围，从而极大地提高了资金效率。 V3 核心公式：V3 的流动性计算公式是 V2 中 $x \cdot y = L^2$ 的演进，具体形式为 $$(x_{real} &#43; \frac{L}{\sqrt{p_b}}) \cdot (y_{real} &#43; L\sqrt{p_a}) = L^2$$。这个公式是理解 V3 机制的关键。 资金效率与价格区间的关系：用户设定的价格区间 $[p_a, p_b]$ 越窄（即 $p_a$ 越大，$p_b$ 越小，两者越接近），提供的虚拟流动性就越大。这意味着可以用更少的真实资金（$x_{real}$, $y_{real}$）达到与 V2 相同的流动性深度（L 值），即资金效率越高。 模拟限价订单：利用价格区间特性，用户可以通过在价格区间的某一端点（如 $p_a$）存入单一资产，当市场价格穿过整个区间到达另一端点（$p_b$）时，该资产会被完全兑换成另一种资产，从而实现类似限价订单的效果。 1. Uniswap V3 核心概念回顾 1.1 集中流动性与虚拟流动性 Uniswap V2: 流动性平均分布在 $(0, &#43;∞)` 的整个价格曲线上。 Uniswap V3: 引入了价格区间 $[p_a, p_b]$ 的概念，允许流动性提供者（LP）将资金集中在他们认为最可能发生交易的价格范围内。 虚拟流动性 (Virtual Liquidity): 为了在有限的价格区间 $[p_a, p_b]$ 内构建出一条标准的 $x \cdot y = k$ 曲线，V3 引入了虚拟的 x 和 y 资产（$x_{virtual}$ 和 $y_{virtual}$）。 这些虚拟资产仅用于数学计算，并不需要用户真实提供。 用户实际提供的资产被称为真实流动性 (Real Liquidity)（$x_{real}$ 和 $y_{real}$）。 总流动性 = 真实流动性 &#43; 虚拟流动性。 总 X: $$x_{total} = x_{real} &#43; x_{virtual}$$ 总 Y: $$y_{total} = y_{real} &#43; y_{virtual}$$ 2. Uniswap V3 核心公式推导 2.1 基础关系：确定 X, Y, L, P 的关系 基础恒定乘积公式: $$ x \cdot y = k = L^2 $$ 其中 $L$ 代表流动性 (Liquidity)。">
  <meta itemprop="datePublished" content="2025-09-02T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-09-02T00:00:00+00:00">
  <meta itemprop="wordCount" content="2884">
  <meta itemprop="keywords" content="Web3"><meta property="og:url" content="https://nesl42.github.io/posts/202509-uniswap10/">
  <meta property="og:site_name" content="敬渊&#39;s Blog">
  <meta property="og:title" content="10.Uniswap V3 流动性计算">
  <meta property="og:description" content="好的，这是根据你的要求修改和完善后的最终学习笔记。
核心摘要 (Key Takeaways) Uniswap V3 的核心创新：通过引入价格区间 $p \in [p_a, p_b]$ 和虚拟流动性 ($x_{virtual}$, $y_{virtual}$) 的概念，实现了集中流动性，允许用户将资金集中在特定价格范围，从而极大地提高了资金效率。 V3 核心公式：V3 的流动性计算公式是 V2 中 $x \cdot y = L^2$ 的演进，具体形式为 $$(x_{real} &#43; \frac{L}{\sqrt{p_b}}) \cdot (y_{real} &#43; L\sqrt{p_a}) = L^2$$。这个公式是理解 V3 机制的关键。 资金效率与价格区间的关系：用户设定的价格区间 $[p_a, p_b]$ 越窄（即 $p_a$ 越大，$p_b$ 越小，两者越接近），提供的虚拟流动性就越大。这意味着可以用更少的真实资金（$x_{real}$, $y_{real}$）达到与 V2 相同的流动性深度（L 值），即资金效率越高。 模拟限价订单：利用价格区间特性，用户可以通过在价格区间的某一端点（如 $p_a$）存入单一资产，当市场价格穿过整个区间到达另一端点（$p_b$）时，该资产会被完全兑换成另一种资产，从而实现类似限价订单的效果。 1. Uniswap V3 核心概念回顾 1.1 集中流动性与虚拟流动性 Uniswap V2: 流动性平均分布在 $(0, &#43;∞)` 的整个价格曲线上。 Uniswap V3: 引入了价格区间 $[p_a, p_b]$ 的概念，允许流动性提供者（LP）将资金集中在他们认为最可能发生交易的价格范围内。 虚拟流动性 (Virtual Liquidity): 为了在有限的价格区间 $[p_a, p_b]$ 内构建出一条标准的 $x \cdot y = k$ 曲线，V3 引入了虚拟的 x 和 y 资产（$x_{virtual}$ 和 $y_{virtual}$）。 这些虚拟资产仅用于数学计算，并不需要用户真实提供。 用户实际提供的资产被称为真实流动性 (Real Liquidity)（$x_{real}$ 和 $y_{real}$）。 总流动性 = 真实流动性 &#43; 虚拟流动性。 总 X: $$x_{total} = x_{real} &#43; x_{virtual}$$ 总 Y: $$y_{total} = y_{real} &#43; y_{virtual}$$ 2. Uniswap V3 核心公式推导 2.1 基础关系：确定 X, Y, L, P 的关系 基础恒定乘积公式: $$ x \cdot y = k = L^2 $$ 其中 $L$ 代表流动性 (Liquidity)。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-09-02T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-09-02T00:00:00+00:00">
    <meta property="article:tag" content="Web3">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="10.Uniswap V3 流动性计算">
  <meta name="twitter:description" content="好的，这是根据你的要求修改和完善后的最终学习笔记。
核心摘要 (Key Takeaways) Uniswap V3 的核心创新：通过引入价格区间 $p \in [p_a, p_b]$ 和虚拟流动性 ($x_{virtual}$, $y_{virtual}$) 的概念，实现了集中流动性，允许用户将资金集中在特定价格范围，从而极大地提高了资金效率。 V3 核心公式：V3 的流动性计算公式是 V2 中 $x \cdot y = L^2$ 的演进，具体形式为 $$(x_{real} &#43; \frac{L}{\sqrt{p_b}}) \cdot (y_{real} &#43; L\sqrt{p_a}) = L^2$$。这个公式是理解 V3 机制的关键。 资金效率与价格区间的关系：用户设定的价格区间 $[p_a, p_b]$ 越窄（即 $p_a$ 越大，$p_b$ 越小，两者越接近），提供的虚拟流动性就越大。这意味着可以用更少的真实资金（$x_{real}$, $y_{real}$）达到与 V2 相同的流动性深度（L 值），即资金效率越高。 模拟限价订单：利用价格区间特性，用户可以通过在价格区间的某一端点（如 $p_a$）存入单一资产，当市场价格穿过整个区间到达另一端点（$p_b$）时，该资产会被完全兑换成另一种资产，从而实现类似限价订单的效果。 1. Uniswap V3 核心概念回顾 1.1 集中流动性与虚拟流动性 Uniswap V2: 流动性平均分布在 $(0, &#43;∞)` 的整个价格曲线上。 Uniswap V3: 引入了价格区间 $[p_a, p_b]$ 的概念，允许流动性提供者（LP）将资金集中在他们认为最可能发生交易的价格范围内。 虚拟流动性 (Virtual Liquidity): 为了在有限的价格区间 $[p_a, p_b]$ 内构建出一条标准的 $x \cdot y = k$ 曲线，V3 引入了虚拟的 x 和 y 资产（$x_{virtual}$ 和 $y_{virtual}$）。 这些虚拟资产仅用于数学计算，并不需要用户真实提供。 用户实际提供的资产被称为真实流动性 (Real Liquidity)（$x_{real}$ 和 $y_{real}$）。 总流动性 = 真实流动性 &#43; 虚拟流动性。 总 X: $$x_{total} = x_{real} &#43; x_{virtual}$$ 总 Y: $$y_{total} = y_{real} &#43; y_{virtual}$$ 2. Uniswap V3 核心公式推导 2.1 基础关系：确定 X, Y, L, P 的关系 基础恒定乘积公式: $$ x \cdot y = k = L^2 $$ 其中 $L$ 代表流动性 (Liquidity)。">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="https://nesl42.github.io/posts/202509-uniswap10/" title="10.Uniswap V3 流动性计算 - 敬渊&#39;s Blog" /><link rel="prev" type="text/html" href="https://nesl42.github.io/posts/202509-uniswap11/" title="11.Uniswap V3 tick 与价格表示" /><link rel="next" type="text/html" href="https://nesl42.github.io/posts/202509-uniswap09/" title="09.Uniswap V3 集中流动性" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "10.Uniswap V3 流动性计算",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/nesl42.github.io\/posts\/202509-uniswap10\/"
    },"genre": "posts","keywords": "Web3","wordcount":  2884 ,
    "url": "https:\/\/nesl42.github.io\/posts\/202509-uniswap10\/","datePublished": "2025-09-02T00:00:00+00:00","dateModified": "2025-09-02T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Author"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/">文章</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/">标签</a></li><li class="menu-item">
              <a class="menu-link" href="/about/">关于</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/">分类</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="/posts/">文章</a></li><li class="menu-item"><a class="menu-link" href="/tags/">标签</a></li><li class="menu-item"><a class="menu-link" href="/about/">关于</a></li><li class="menu-item"><a class="menu-link" href="/categories/">分类</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>10.Uniswap V3 流动性计算</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="published on 2025-09-02 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2025-09-02">2025-09-02</time></span>&nbsp;<span title="2884 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 2900 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>6 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#核心摘要-key-takeaways"><strong>核心摘要 (Key Takeaways)</strong></a></li>
            <li><a href="#1-uniswap-v3-核心概念回顾"><strong>1. Uniswap V3 核心概念回顾</strong></a>
              <ul>
                <li><a href="#11-集中流动性与虚拟流动性"><strong>1.1 集中流动性与虚拟流动性</strong></a></li>
              </ul>
            </li>
            <li><a href="#2-uniswap-v3-核心公式推导"><strong>2. Uniswap V3 核心公式推导</strong></a>
              <ul>
                <li><a href="#21-基础关系确定-x-y-l-p-的关系"><strong>2.1 基础关系：确定 X, Y, L, P 的关系</strong></a></li>
                <li><a href="#22-引入-v3-价格区间与边界条件"><strong>2.2 引入 V3 价格区间与边界条件</strong></a></li>
                <li><a href="#23-推导虚拟流动性-x_"><strong>2.3 推导虚拟流动性 ($x_{virtual}$ 和 $y_{virtual}$)</strong></a></li>
                <li><a href="#24-得出-uniswap-v3-最终公式"><strong>2.4 得出 Uniswap V3 最终公式</strong></a></li>
                <li><a href="#25-价格区间与资金效率的动态关系"><strong>2.5 价格区间与资金效率的动态关系</strong></a></li>
              </ul>
            </li>
            <li><a href="#3-案例分析与计算"><strong>3. 案例分析与计算</strong></a>
              <ul>
                <li><a href="#31-案例背景"><strong>3.1 案例背景</strong></a></li>
                <li><a href="#32-计算虚拟流动性-x_"><strong>3.2 计算虚拟流动性 ($x_{virtual}$ 和 $y_{virtual}$)</strong></a></li>
                <li><a href="#33-理解真实流动性曲线"><strong>3.3 理解真实流动性曲线</strong></a></li>
                <li><a href="#34-与-uniswap-v2-对比-资金效率"><strong>3.4 与 Uniswap V2 对比 (资金效率)</strong></a></li>
              </ul>
            </li>
            <li><a href="#4-模拟限价订单-simulating-limit-orders"><strong>4. 模拟限价订单 (Simulating Limit Orders)</strong></a>
              <ul>
                <li><a href="#案例-在-1000-16000-区间内将-15-eth-以不低于-4000-daieth-的均价卖出"><strong>案例</strong>: 在 <code>[1000, 16000]</code> 区间内，将 1.5 ETH 以不低于 4000 DAI/ETH 的均价卖出。</a></li>
              </ul>
            </li>
            <li><a href="#5-练习"><strong>5. 练习</strong></a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>好的，这是根据你的要求修改和完善后的最终学习笔记。</p>
<h3 id="核心摘要-key-takeaways" class="heading-element"><span><strong>核心摘要 (Key Takeaways)</strong></span>
  <a href="#%e6%a0%b8%e5%bf%83%e6%91%98%e8%a6%81-key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li><strong>Uniswap V3 的核心创新</strong>：通过引入<strong>价格区间</strong> $p \in [p_a, p_b]$ 和<strong>虚拟流动性</strong> ($x_{virtual}$, $y_{virtual}$) 的概念，实现了<strong>集中流动性</strong>，允许用户将资金集中在特定价格范围，从而极大地提高了资金效率。</li>
<li><strong>V3 核心公式</strong>：V3 的流动性计算公式是 V2 中 $x \cdot y = L^2$ 的演进，具体形式为 $$(x_{real} + \frac{L}{\sqrt{p_b}}) \cdot (y_{real} + L\sqrt{p_a}) = L^2$$。这个公式是理解 V3 机制的关键。</li>
<li><strong>资金效率与价格区间的关系</strong>：用户设定的价格区间 $[p_a, p_b]$ 越窄（即 $p_a$ 越大，$p_b$ 越小，两者越接近），提供的虚拟流动性就越大。这意味着可以用更少的真实资金（$x_{real}$, $y_{real}$）达到与 V2 相同的流动性深度（<code>L</code> 值），即资金效率越高。</li>
<li><strong>模拟限价订单</strong>：利用价格区间特性，用户可以通过在价格区间的某一端点（如 $p_a$）存入单一资产，当市场价格穿过整个区间到达另一端点（$p_b$）时，该资产会被完全兑换成另一种资产，从而实现类似<strong>限价订单</strong>的效果。</li>
</ul>
<hr>
<h3 id="1-uniswap-v3-核心概念回顾" class="heading-element"><span><strong>1. Uniswap V3 核心概念回顾</strong></span>
  <a href="#1-uniswap-v3-%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5%e5%9b%9e%e9%a1%be" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="11-集中流动性与虚拟流动性" class="heading-element"><span><strong>1.1 集中流动性与虚拟流动性</strong></span>
  <a href="#11-%e9%9b%86%e4%b8%ad%e6%b5%81%e5%8a%a8%e6%80%a7%e4%b8%8e%e8%99%9a%e6%8b%9f%e6%b5%81%e5%8a%a8%e6%80%a7" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>Uniswap V2</strong>: 流动性平均分布在 $(0, +∞)` 的整个价格曲线上。</li>
<li><strong>Uniswap V3</strong>: 引入了<strong>价格区间</strong> $[p_a, p_b]$ 的概念，允许流动性提供者（LP）将资金集中在他们认为最可能发生交易的价格范围内。</li>
<li><strong>虚拟流动性 (Virtual Liquidity)</strong>: 为了在有限的价格区间 $[p_a, p_b]$ 内构建出一条标准的 $x \cdot y = k$ 曲线，V3 引入了虚拟的 <code>x</code> 和 <code>y</code> 资产（$x_{virtual}$ 和 $y_{virtual}$）。
<ul>
<li>这些虚拟资产<strong>仅用于数学计算</strong>，并不需要用户真实提供。</li>
<li>用户实际提供的资产被称为<strong>真实流动性 (Real Liquidity)</strong>（$x_{real}$ 和 $y_{real}$）。</li>
<li>总流动性 = 真实流动性 + 虚拟流动性。
<ul>
<li>总 X: $$x_{total} = x_{real} + x_{virtual}$$</li>
<li>总 Y: $$y_{total} = y_{real} + y_{virtual}$$</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="2-uniswap-v3-核心公式推导" class="heading-element"><span><strong>2. Uniswap V3 核心公式推导</strong></span>
  <a href="#2-uniswap-v3-%e6%a0%b8%e5%bf%83%e5%85%ac%e5%bc%8f%e6%8e%a8%e5%af%bc" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="21-基础关系确定-x-y-l-p-的关系" class="heading-element"><span><strong>2.1 基础关系：确定 X, Y, L, P 的关系</strong></span>
  <a href="#21-%e5%9f%ba%e7%a1%80%e5%85%b3%e7%b3%bb%e7%a1%ae%e5%ae%9a-x-y-l-p-%e7%9a%84%e5%85%b3%e7%b3%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ol>
<li>
<p><strong>基础恒定乘积公式</strong>:
$$
x \cdot y = k = L^2
$$
其中 $L$ 代表流动性 (Liquidity)。</p>
</li>
<li>
<p><strong>价格定义</strong>: 使用 $y$ 资产来表示 $x$ 资产的价格 $P$。
$$
P = \frac{y}{x}
$$</p>
</li>
<li>
<p><strong>推导 X 和 Y</strong>: 联立以上两个公式，可以分别用流动性 $L$ 和价格 $P$ 来表示 $x$ 和 $y$ 的数量。</p>
<ul>
<li><strong>推导 X</strong>: 从 $P = y/x$ 得 $y = Px$。代入基础公式得 $x \cdot (Px) = L^2$，化简后得到：
$$
x = \frac{L}{\sqrt{P}}
$$</li>
<li><strong>推导 Y</strong>: 从 $P = y/x$ 得 $x = y/P$。代入基础公式得 $(y/P) \cdot y = L^2$，化简后得到：
$$
y = L \cdot \sqrt{P}
$$</li>
</ul>
</li>
</ol>
<h4 id="22-引入-v3-价格区间与边界条件" class="heading-element"><span><strong>2.2 引入 V3 价格区间与边界条件</strong></span>
  <a href="#22-%e5%bc%95%e5%85%a5-v3-%e4%bb%b7%e6%a0%bc%e5%8c%ba%e9%97%b4%e4%b8%8e%e8%be%b9%e7%95%8c%e6%9d%a1%e4%bb%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><img loading="lazy" src='/posts/202509-uniswap10/virtual-liquidity-20250902214247773.png' alt="img" height="806" width="894"></p>
<p>在 V3 的价格区间 $[p_a, p_b]$ 中存在两个边界：</p>
<ul>
<li>当价格 $P$ 上升到区间的上限 $p_b$ 时，池中所有的真实 $x$ 资产（$x_{real}$）都被卖出，此时 $x_{real} = 0$。池中与 $x$ 相关的流动性完全由虚拟 $x$（$x_{virtual}$）构成。</li>
<li>当价格 $P$ 下降到区间的下限 $p_a$ 时，池中所有的真实 $y$ 资产（$y_{real}$）都被卖出，此时 $y_{real} = 0$。池中与 $y$ 相关的流动性完全由虚拟 $y$（$y_{virtual}$）构成。</li>
</ul>
<h4 id="23-推导虚拟流动性-x_" class="heading-element"><span><strong>2.3 推导虚拟流动性 ($x_{virtual}$ 和 $y_{virtual}$)</strong></span>
  <a href="#23-%e6%8e%a8%e5%af%bc%e8%99%9a%e6%8b%9f%e6%b5%81%e5%8a%a8%e6%80%a7-x_" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>根据上述边界条件和基础关系式：</p>
<ol>
<li>
<p><strong>计算 $x_{virtual}$</strong>: 在价格点 $P = p_b$ 时，$x_{total} = x_{virtual}$。将 $P = p_b$ 代入 $x = L / \sqrt{P}$ 公式中：
$$
x_{virtual} = \frac{L}{\sqrt{p_b}}
$$</p>
</li>
<li>
<p><strong>计算 $y_{virtual}$</strong>: 在价格点 $P = p_a$ 时，$y_{total} = y_{virtual}$。将 $P = p_a$ 代入 $y = L \cdot \sqrt{P}$ 公式中：
$$
y_{virtual} = L \cdot \sqrt{p_a}
$$</p>
</li>
</ol>
<h4 id="24-得出-uniswap-v3-最终公式" class="heading-element"><span><strong>2.4 得出 Uniswap V3 最终公式</strong></span>
  <a href="#24-%e5%be%97%e5%87%ba-uniswap-v3-%e6%9c%80%e7%bb%88%e5%85%ac%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>V3 的总流动性也遵循恒定乘积公式，即 $(x_{real} + x_{virtual}) \cdot (y_{real} + y_{virtual}) = L^2$。将我们刚刚推导出的 $x_{virtual}$ 和 $y_{virtual}$ 代入，即可得到 Uniswap V3 白皮书中的核心公式：
$$
(x_{real} + \frac{L}{\sqrt{p_b}}) \cdot (y_{real} + L\sqrt{p_a}) = L^2
$$
这个公式描述了在指定价格区间 $[p_a, p_b]$ 内，用户提供的<strong>真实流动性</strong> ($x_{real}$, $y_{real}$) 与总流动性 <code>L</code> 之间的关系。</p>
<h4 id="25-价格区间与资金效率的动态关系" class="heading-element"><span><strong>2.5 价格区间与资金效率的动态关系</strong></span>
  <a href="#25-%e4%bb%b7%e6%a0%bc%e5%8c%ba%e9%97%b4%e4%b8%8e%e8%b5%84%e9%87%91%e6%95%88%e7%8e%87%e7%9a%84%e5%8a%a8%e6%80%81%e5%85%b3%e7%b3%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>从虚拟流动性的公式可以看出：</p>
<ul>
<li>当价格区间下限 $p_a$ 增大时，$y_{virtual} = L \cdot \sqrt{p_a}$ 会随之增大。</li>
<li>当价格区间上限 $p_b$ 减小时，$x_{virtual} = L / \sqrt{p_b}$ 会随之增大。</li>
<li><strong>结论</strong>: 当价格区间 $[p_a, p_b]$ 变得<strong>越窄</strong>，$x_{virtual}$ 和 $y_{virtual}$ 的值就越大。这意味着系统提供的“虚拟”支持越多，用户需要投入的真实资产 $x_{real}$ 和 $y_{real}$ 就越少，即可支撑起同样大小的流动性 $L$，从而实现更高的资金效率。</li>
</ul>
<hr>
<h3 id="3-案例分析与计算" class="heading-element"><span><strong>3. 案例分析与计算</strong></span>
  <a href="#3-%e6%a1%88%e4%be%8b%e5%88%86%e6%9e%90%e4%b8%8e%e8%ae%a1%e7%ae%97" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="31-案例背景" class="heading-element"><span><strong>3.1 案例背景</strong></span>
  <a href="#31-%e6%a1%88%e4%be%8b%e8%83%8c%e6%99%af" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li>
<p><strong>交易对</strong>: ETH / DAI</p>
</li>
<li>
<p><strong>价格区间端点</strong>:</p>
<ul>
<li><strong>A点</strong>: 2 ETH, 2000 DAI</li>
<li><strong>B点</strong>: 0.5 ETH, 8000 DAI</li>
</ul>
</li>
<li>
<p><strong>当前价格点</strong>:</p>
<ul>
<li><strong>P点</strong>: 1 ETH, 4000 DAI</li>
</ul>
</li>
<li>
<p><strong>计算价格</strong>:</p>
<ul>
<li>价格下限 <strong>pa</strong>: $p_a = 2000 / 2 = 1000 \text{ DAI/ETH}$</li>
<li>价格上限 <strong>pb</strong>: $p_b = 8000 / 0.5 = 16000 \text{ DAI/ETH}$</li>
<li>当前价格 <strong>P</strong>: $P = 4000 / 1 = 4000 \text{ DAI/ETH}$</li>
</ul>
</li>
</ul>
<h4 id="32-计算虚拟流动性-x_" class="heading-element"><span><strong>3.2 计算虚拟流动性 ($x_{virtual}$ 和 $y_{virtual}$)</strong></span>
  <a href="#32-%e8%ae%a1%e7%ae%97%e8%99%9a%e6%8b%9f%e6%b5%81%e5%8a%a8%e6%80%a7-x_" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ol>
<li>
<p><strong>计算流动性 L</strong>: 在这条曲线上的任意一点计算 $L$ 都是相同的。我们使用 P 点的数据。
$$
L = \sqrt{x \cdot y} = \sqrt{1 \cdot 4000} = \sqrt{4000}
$$</p>
</li>
<li>
<p><strong>计算 $x_{virtual}$</strong>:
$$
x_{virtual} = \frac{L}{\sqrt{p_b}} = \frac{\sqrt{4000}}{\sqrt{16000}} = \sqrt{\frac{4000}{16000}} = \sqrt{\frac{1}{4}} = 0.5 \text{ ETH}
$$</p>
</li>
<li>
<p><strong>计算 $y_{virtual}$</strong>:
$$
y_{virtual} = L \cdot \sqrt{p_a} = \sqrt{4000} \cdot \sqrt{1000} = \sqrt{4,000,000} = 2000 \text{ DAI}
$$</p>
</li>
<li>
<p><strong>此案例的曲线方程</strong>:
$$
(x_{real} + 0.5) \cdot (y_{real} + 2000) = 4000
$$</p>
</li>
</ol>
<h4 id="33-理解真实流动性曲线" class="heading-element"><span><strong>3.3 理解真实流动性曲线</strong></span>
  <a href="#33-%e7%90%86%e8%a7%a3%e7%9c%9f%e5%ae%9e%e6%b5%81%e5%8a%a8%e6%80%a7%e6%9b%b2%e7%ba%bf" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><img loading="lazy" src='/posts/202509-uniswap10/virtual-real-liquidity-20250902214720398.png' alt="img" height="832" width="888"></p>
<p>Uniswap V3 白皮书会画两条曲线：</p>
<ul>
<li><strong>绿色曲线</strong>: 代表包含虚拟流动性的<strong>总流动性曲线</strong> ($x_{total} \cdot y_{total} = L^2$)。这是一条标准的双曲线，不与坐标轴相交。我们所有的计算都基于这条曲线。</li>
<li><strong>黄色曲线</strong>: 代表<strong>真实流动性曲线</strong> ($(x_{real} + 0.5) \cdot (y_{real} + 2000) = 4000$)。这条曲线是标准双曲线平移后的结果，它会与坐标轴相交，真实地反映了用户提供的 $x_{real}$ 和 $y_{real}$ 之间的关系。</li>
</ul>
<h4 id="34-与-uniswap-v2-对比-资金效率" class="heading-element"><span><strong>3.4 与 Uniswap V2 对比 (资金效率)</strong></span>
  <a href="#34-%e4%b8%8e-uniswap-v2-%e5%af%b9%e6%af%94-%e8%b5%84%e9%87%91%e6%95%88%e7%8e%87" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li>
<p><strong>Uniswap V3</strong>: 在当前价格 $P=4000$ 时，要达到 $L=\sqrt{4000}$ 的流动性深度，用户实际需要提供的资产为：</p>
<ul>
<li>$$x_{real} = x_{total} - x_{virtual} = 1 - 0.5 = 0.5 \text{ ETH}$$</li>
<li>$$y_{real} = y_{total} - y_{virtual} = 4000 - 2000 = 2000 \text{ DAI}$$</li>
</ul>
</li>
<li>
<p><strong>Uniswap V2</strong>: 要达到同样的流动性深度，用户需要提供完整的 <code>1 ETH</code> 和 <code>4000 DAI</code>。</p>
</li>
<li>
<p><strong>结论</strong>: 在此案例中，通过将流动性集中在 <code>[1000, 16000]</code> 的价格区间，Uniswap V3 使用了<strong>一半的资金就达到了与 V2 相同的流动性深度</strong>，资金效率提升了一倍。</p>
</li>
</ul>
<hr>
<h3 id="4-模拟限价订单-simulating-limit-orders" class="heading-element"><span><strong>4. 模拟限价订单 (Simulating Limit Orders)</strong></span>
  <a href="#4-%e6%a8%a1%e6%8b%9f%e9%99%90%e4%bb%b7%e8%ae%a2%e5%8d%95-simulating-limit-orders" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>利用 V3 的价格区间机制，可以模拟出订单簿交易所的限价单功能。</p>
<h4 id="案例-在-1000-16000-区间内将-15-eth-以不低于-4000-daieth-的均价卖出" class="heading-element"><span><strong>案例</strong>: 在 <code>[1000, 16000]</code> 区间内，将 1.5 ETH 以不低于 4000 DAI/ETH 的均价卖出。</span>
  <a href="#%e6%a1%88%e4%be%8b-%e5%9c%a8-1000-16000-%e5%8c%ba%e9%97%b4%e5%86%85%e5%b0%86-15-eth-%e4%bb%a5%e4%b8%8d%e4%bd%8e%e4%ba%8e-4000-daieth-%e7%9a%84%e5%9d%87%e4%bb%b7%e5%8d%96%e5%87%ba" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ol>
<li>
<p><strong>第一步：在价格下限 $p_a$ 添加流动性</strong></p>
<ul>
<li>当价格为 $p_a = 1000$ 时，流动性池中只有 ETH。用户只需提供单一资产 ETH。</li>
<li>需要提供的真实 ETH 数量为：$$x_{real} = x_{total_at_A} - x_{virtual} = 2 - 0.5 = 1.5 \text{ ETH}$$</li>
<li>此时 $y_{real} = 0$。</li>
</ul>
</li>
<li>
<p><strong>第二步：市场价格波动</strong></p>
<ul>
<li>市场价格从 1000 DAI/ETH 开始上涨，穿过用户设定的整个价格区间。</li>
</ul>
</li>
<li>
<p><strong>第三步：在价格上限 $p_b$ 移除流动性</strong></p>
<ul>
<li>当价格到达 $p_b = 16000$ 时，用户提供的 1.5 ETH 已被完全兑换成 DAI。</li>
<li>此时，用户可以移除的真实 DAI 数量为：$$y_{real} = y_{total_at_B} - y_{virtual} = 8000 - 2000 = 6000 \text{ DAI}$$</li>
<li>此时 $x_{real} = 0$。</li>
</ul>
</li>
<li>
<p><strong>结果分析</strong></p>
<ul>
<li>用户投入 <code>1.5 ETH</code>，最终取回 <code>6000 DAI</code>。</li>
<li>这相当于以平均 $6000 / 1.5 = 4000 \text{ DAI/ETH}$ 的价格成功卖出了自己的 ETH。</li>
<li><strong>效果</strong>: 这就模拟了一个在价格从 1000 上涨到 16000 的过程中，逐步卖出 ETH 的限价订单。如果价格区间设置得非常窄（如 <code>[1000, 1010]</code>），成交效果会更接近于一个精确价格的限价单。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="5-练习" class="heading-element"><span><strong>5. 练习</strong></span>
  <a href="#5-%e7%bb%83%e4%b9%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><strong>题目</strong>: 在以上案例中，如果用户在当前价格点（1 ETH, 4000 DAI）真实提供了 <code>1 ETH</code> 和 <code>4000 DAI</code> 的流动性（即 $x_{real}=1$, $y_{real}=4000$），那么他所提供的总流动性 <code>L</code> 是多少？</p>
<p><strong>解答过程</strong>:</p>
<ol>
<li>
<p><strong>写出核心公式</strong>:
$$
(x_{real} + \frac{L}{\sqrt{p_b}}) \cdot (y_{real} + L\sqrt{p_a}) = L^2
$$</p>
</li>
<li>
<p><strong>代入已知数值</strong>:
$x_{real} = 1$
$y_{real} = 4000$
$p_a = 1000$
$p_b = 16000$
$$
(1 + \frac{L}{\sqrt{16000}}) \cdot (4000 + L\sqrt{1000}) = L^2
$$</p>
</li>
<li>
<p><strong>化简并展开方程</strong>:
$$\sqrt{16000} = \sqrt{1600 \cdot 10} = 40\sqrt{10}$$
$$\sqrt{1000} = \sqrt{100 \cdot 10} = 10\sqrt{10}$$
代入得：$$(1 + \frac{L}{40\sqrt{10}}) \cdot (4000 + 10\sqrt{10}L) = L^2$$
展开括号：$$4000 + 10\sqrt{10}L + \frac{4000L}{40\sqrt{10}} + \frac{10\sqrt{10}L^2}{40\sqrt{10}} = L^2$$
化简各项：$$4000 + 10\sqrt{10}L + \frac{100L}{\sqrt{10}} + \frac{1}{4}L^2 = L^2$$
$$\frac{100}{\sqrt{10}} = \frac{100\sqrt{10}}{10} = 10\sqrt{10}$$
合并同类项：$$4000 + 20\sqrt{10}L + 0.25L^2 = L^2$$</p>
</li>
<li>
<p><strong>整理成一元二次方程</strong>:
$$
0.75L^2 - 20\sqrt{10}L - 4000 = 0
$$</p>
</li>
<li>
<p><strong>使用求根公式求解 $L$</strong>:
$$L = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$$
$$a = 0.75$$  $$b = -20\sqrt{10}$$  $$c = -4000$$
$$b^2 = (-20\sqrt{10})^2 = 400 \cdot 10 = 4000$$
$$-4ac = -4 \cdot (0.75) \cdot (-4000) = -3 \cdot (-4000) = 12000$$
$$L = \frac{20\sqrt{10} + \sqrt{4000 + 12000}}{2 \cdot 0.75}$$ (取正根)
$$L = \frac{20\sqrt{10} + \sqrt{16000}}{1.5} = \frac{20\sqrt{10} + 40\sqrt{10}}{1.5}$$
$$L = \frac{60\sqrt{10}}{1.5} = 40\sqrt{10}$$</p>
</li>
</ol>
<p><strong>最终结果</strong>:
该用户提供的总流动性 $L$ 为 $40\sqrt{10}$，约等于 <strong>126.49</strong>。对应的 $k$ 值或 $L^2$ 值为 <strong>16000</strong>。</p>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2025-09-02 00:00:00">Updated on 2025-09-02&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on X" data-sharer="twitter" data-url="https://nesl42.github.io/posts/202509-uniswap10/" data-title="10.Uniswap V3 流动性计算" data-hashtags="Web3"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://nesl42.github.io/posts/202509-uniswap10/" data-hashtag="Web3"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://nesl42.github.io/posts/202509-uniswap10/" data-title="10.Uniswap V3 流动性计算"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/web3/" class="post-tag" title="Tags - Web3">Web3</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/202509-uniswap11/" class="post-nav-item" rel="prev" title="11.Uniswap V3 Tick 与价格表示"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>11.Uniswap V3 Tick 与价格表示</a><a href="/posts/202509-uniswap09/" class="post-nav-item" rel="next" title="09.Uniswap V3 集中流动性">09.Uniswap V3 集中流动性<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.149.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.17-8212d6fd"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"version":"v0.3.17-8212d6fd"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
