<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>IO_FILE调试&#43;详解 - SmallT40&#39;s Blog</title><meta name="author" content="">
<meta name="description" content="[TOC]
开始干__IO_FILE。会依次调fopen,fwrite,fread之类的IO函数的源码。
IO_FILE之fopen详解 demo程序 ##include&lt;stdio.h&gt; int main() { FILE*fp=fopen(&#34;test&#34;,&#34;wb&#34;); char *ptr=malloc(0x20); return 0; }源码分析 跟进去之后可以看到fopen实际是_IO_new_fopen函数。它调用的是__fopen_internal
"><meta name="keywords" content='PWN'>
  <meta itemprop="name" content="IO_FILE调试&#43;详解">
  <meta itemprop="description" content="[TOC]
开始干__IO_FILE。会依次调fopen,fwrite,fread之类的IO函数的源码。
IO_FILE之fopen详解 demo程序 ##include&lt;stdio.h&gt; int main() { FILE*fp=fopen(&#34;test&#34;,&#34;wb&#34;); char *ptr=malloc(0x20); return 0; }源码分析 跟进去之后可以看到fopen实际是_IO_new_fopen函数。它调用的是__fopen_internal">
  <meta itemprop="datePublished" content="2021-09-24T23:09:51+00:00">
  <meta itemprop="dateModified" content="2021-09-24T23:09:51+00:00">
  <meta itemprop="wordCount" content="7266">
  <meta itemprop="keywords" content="PWN"><meta property="og:url" content="http://localhost:1313/posts/io_file/">
  <meta property="og:site_name" content="SmallT40&#39;s Blog">
  <meta property="og:title" content="IO_FILE调试&#43;详解">
  <meta property="og:description" content="[TOC]
开始干__IO_FILE。会依次调fopen,fwrite,fread之类的IO函数的源码。
IO_FILE之fopen详解 demo程序 ##include&lt;stdio.h&gt; int main() { FILE*fp=fopen(&#34;test&#34;,&#34;wb&#34;); char *ptr=malloc(0x20); return 0; }源码分析 跟进去之后可以看到fopen实际是_IO_new_fopen函数。它调用的是__fopen_internal">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-09-24T23:09:51+00:00">
    <meta property="article:modified_time" content="2021-09-24T23:09:51+00:00">
    <meta property="article:tag" content="PWN">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="IO_FILE调试&#43;详解">
  <meta name="twitter:description" content="[TOC]
开始干__IO_FILE。会依次调fopen,fwrite,fread之类的IO函数的源码。
IO_FILE之fopen详解 demo程序 ##include&lt;stdio.h&gt; int main() { FILE*fp=fopen(&#34;test&#34;,&#34;wb&#34;); char *ptr=malloc(0x20); return 0; }源码分析 跟进去之后可以看到fopen实际是_IO_new_fopen函数。它调用的是__fopen_internal">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/posts/io_file/" title="IO_FILE调试&#43;详解 - SmallT40&#39;s Blog" /><link rel="prev" type="text/html" href="http://localhost:1313/posts/buu-web-0x30-0x3f/" title="BUU_WEB刷题_0x30-0x3F" /><link rel="next" type="text/html" href="http://localhost:1313/posts/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%95%B4%E7%90%86/" title="PHP反序列化整理" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "IO_FILE调试+详解",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/posts\/io_file\/"
    },"genre": "posts","keywords": "PWN","wordcount":  7266 ,
    "url": "http:\/\/localhost:1313\/posts\/io_file\/","datePublished": "2021-09-24T23:09:51+00:00","dateModified": "2021-09-24T23:09:51+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Author"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="SmallT40&#39;s Blog"><span class="header-title-text">SmallT40&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/">文章</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/">标签</a></li><li class="menu-item">
              <a class="menu-link" href="/about/">关于</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/">分类</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="SmallT40&#39;s Blog"><span class="header-title-text">SmallT40&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="/posts/">文章</a></li><li class="menu-item"><a class="menu-link" href="/tags/">标签</a></li><li class="menu-item"><a class="menu-link" href="/about/">关于</a></li><li class="menu-item"><a class="menu-link" href="/categories/">分类</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>IO_FILE调试&#43;详解</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="published on 2021-09-24 23:09:51"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2021-09-24">2021-09-24</time></span>&nbsp;<span title="7266 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 7300 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>15 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#io_file之fopen详解">IO_FILE之fopen详解</a>
          <ul>
            <li><a href="#demo程序">demo程序</a></li>
            <li><a href="#源码分析">源码分析</a>
              <ul>
                <li><a href="#step1malloc分配内存空间">step1:malloc分配内存空间</a></li>
                <li><a href="#step2_io_no_init-对file结构体进行null初始化">step2:_IO_no_init 对file结构体进行null初始化</a></li>
                <li><a href="#step3-_io_file_init将结构体链接进_io_list_all">step3: _IO_file_init将结构体链接进_IO_list_all</a></li>
                <li><a href="#step4_io_file_fopen打开文件句柄">step4:_IO_file_fopen打开文件句柄</a></li>
              </ul>
            </li>
            <li><a href="#小结">小结</a></li>
          </ul>
        </li>
        <li><a href="#io_file之fread详解">IO_FILE之fread详解</a>
          <ul>
            <li><a href="#demo">demo</a></li>
            <li><a href="#源码分析-1">源码分析</a>
              <ul>
                <li><a href="#step1初始化输入缓冲区">step1：初始化输入缓冲区</a></li>
                <li><a href="#step2拷贝输入缓冲区数据">step2：拷贝输入缓冲区数据</a></li>
                <li><a href="#step3执行系统调用读取数据">step3：执行系统调用读取数据</a></li>
              </ul>
            </li>
            <li><a href="#小结-1">小结</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>[TOC]</p>
<p>开始干__IO_FILE。会依次调fopen,fwrite,fread之类的IO函数的源码。</p>
<h2 id="io_file之fopen详解" class="heading-element"><span>IO_FILE之fopen详解</span>
  <a href="#io_file%e4%b9%8bfopen%e8%af%a6%e8%a7%a3" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="demo程序" class="heading-element"><span>demo程序</span>
  <a href="#demo%e7%a8%8b%e5%ba%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include&lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span><span class="o">*</span><span class="n">fp</span><span class="o">=</span><span class="nf">fopen</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">,</span><span class="s">&#34;wb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="o">=</span><span class="nf">malloc</span><span class="p">(</span><span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h3 id="源码分析" class="heading-element"><span>源码分析</span>
  <a href="#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>跟进去之后可以看到fopen实际是<code>_IO_new_fopen</code>函数。它调用的是<code>__fopen_internal</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">─────────────────────────────────────────────────────────────────────────────────────────────<span class="o">[</span> SOURCE <span class="o">(</span>CODE<span class="o">)</span> <span class="o">]</span>──────────────────────────────────────────────────────────────────────────────────────────────
</span></span><span class="line"><span class="cl">In file: /usr/src/glibc/glibc-2.23/libio/iofopen.c
</span></span><span class="line"><span class="cl">    <span class="m">91</span>   <span class="k">return</span> NULL<span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="m">92</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="m">93</span> 
</span></span><span class="line"><span class="cl">    <span class="m">94</span> _IO_FILE *
</span></span><span class="line"><span class="cl">    <span class="m">95</span> _IO_new_fopen <span class="o">(</span>const char *filename, const char *mode<span class="o">)</span>
</span></span><span class="line"><span class="cl"> ►  <span class="m">96</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="m">97</span>   <span class="k">return</span> __fopen_internal <span class="o">(</span>filename, mode, 1<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="m">98</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="m">99</span> 
</span></span><span class="line"><span class="cl">   <span class="m">100</span> <span class="c1">#ifdef _LIBC</span>
</span></span><span class="line"><span class="cl">   <span class="m">101</span> strong_alias <span class="o">(</span>_IO_new_fopen, __new_fopen<span class="o">)</span></span></span></code></pre></div><p>跟进<code>__fopen_internal</code>看下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">_IO_FILE</span> <span class="o">*</span><span class="nf">__fopen_internal</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">locked_FILE</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">_IO_FILE_plus</span> <span class="n">fp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##ifdef _IO_MTSAFE_IO
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="n">_IO_lock_t</span> <span class="n">lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">struct</span> <span class="n">_IO_wide_data</span> <span class="n">wd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="o">*</span><span class="n">new_f</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">locked_FILE</span> <span class="o">*</span><span class="p">)</span> <span class="nf">malloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">locked_FILE</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//step1:分配内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">new_f</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##ifdef _IO_MTSAFE_IO
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">new_f</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">new_f</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp">##if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="nf">_IO_no_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">new_f</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">.</span><span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_f</span><span class="o">-&gt;</span><span class="n">wd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_IO_wfile_jumps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//step2:NULL初始化结构体数组  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl"><span class="cp">##else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="nf">_IO_no_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">new_f</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">.</span><span class="n">file</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="nf">_IO_JUMPS</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">new_f</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_IO_file_jumps</span><span class="p">;</span><span class="c1">// 设置vtable为_IO_file_jumps
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">_IO_file_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">new_f</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">);</span><span class="c1">//step3:将file结构体链接进去_IO_list_all
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##if  !_IO_UNIFIED_JUMPTABLES
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">new_f</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">.</span><span class="n">vtable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="c1">//打开文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nf">_IO_file_fopen</span> <span class="p">((</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="p">)</span> <span class="n">new_f</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">is32</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">__fopen_maybe_mmap</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">new_f</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">.</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">_IO_un_link</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">new_f</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">free</span> <span class="p">(</span><span class="n">new_f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><blockquote>
<p>整个<code>__fopen_internal</code>函数包含四个部分：</p>
<ol>
<li>malloc分配内存</li>
<li><code>_IO_no_init</code> 对file结构体进行<code>null</code>初始化。</li>
<li><code>_IO_file_init</code>将结构体链接进<code>_IO_list_all</code>链表。</li>
<li><code>_IO_file_fopen</code>执行系统调用打开文件。</li>
</ol></blockquote>
<h4 id="step1malloc分配内存空间" class="heading-element"><span>step1:malloc分配内存空间</span>
  <a href="#step1malloc%e5%88%86%e9%85%8d%e5%86%85%e5%ad%98%e7%a9%ba%e9%97%b4" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>可以看到先malloc了 <code>sizeof (struct locked_FILE)</code>大小的结构体，x64中为0x230，包含了三个结构体：<code>_IO_FILE_plus</code>，<code>_IO_lock_t</code>，<code>_IO_wide_data</code>。分别为fp，lock，wd。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; print new_f
</span></span><span class="line"><span class="cl"><span class="nv">$3</span> <span class="o">=</span> <span class="o">(</span>struct locked_FILE *<span class="o">)</span> 0x602010
</span></span><span class="line"><span class="cl">pwndbg&gt; x/10gx 0x602010-0x10
</span></span><span class="line"><span class="cl">0x602000:	0x0000000000000000	0x0000000000000231
</span></span><span class="line"><span class="cl">0x602010:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x602020:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x602030:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x602040:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">pwndbg&gt; print *new_f
</span></span><span class="line"><span class="cl"><span class="nv">$2</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">fp</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">file</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="nv">_flags</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_IO_read_ptr</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_IO_read_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_IO_read_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_IO_write_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_IO_write_ptr</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_IO_write_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_IO_buf_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_IO_buf_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_IO_save_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_IO_backup_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_IO_save_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_markers</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_chain</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_fileno</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_flags2</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_old_offset</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_cur_column</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_vtable_offset</span> <span class="o">=</span> <span class="m">0</span> <span class="s1">&#39;\000&#39;</span>, 
</span></span><span class="line"><span class="cl">      <span class="nv">_shortbuf</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>, 
</span></span><span class="line"><span class="cl">      <span class="nv">_lock</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_offset</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_codecvt</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_wide_data</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_freeres_list</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_freeres_buf</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">__pad5</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_mode</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">      <span class="nv">_unused2</span> <span class="o">=</span> <span class="s1">&#39;\000&#39;</span> &lt;repeats <span class="m">19</span> times&gt;
</span></span><span class="line"><span class="cl">    <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">vtable</span> <span class="o">=</span> 0x0
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">  <span class="nv">lock</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">lock</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">cnt</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">owner</span> <span class="o">=</span> 0x0
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">  <span class="nv">wd</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_ptr</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_ptr</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_buf_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_buf_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_save_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_backup_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_save_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_state</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="nv">__count</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">      <span class="nv">__value</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">__wch</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">        <span class="nv">__wchb</span> <span class="o">=</span> <span class="s2">&#34;\000\000\000&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_last_state</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="nv">__count</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">      <span class="nv">__value</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">__wch</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">        <span class="nv">__wchb</span> <span class="o">=</span> <span class="s2">&#34;\000\000\000&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_codecvt</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="nv">__codecvt_destr</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">__codecvt_do_out</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">__codecvt_do_unshift</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">__codecvt_do_in</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">__codecvt_do_encoding</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">__codecvt_do_always_noconv</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">__codecvt_do_length</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">__codecvt_do_max_length</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">      <span class="nv">__cd_in</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">__cd</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="nv">__nsteps</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">          <span class="nv">__steps</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">          <span class="nv">__data</span> <span class="o">=</span> 0x6021b8
</span></span><span class="line"><span class="cl">        <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">        <span class="nv">__combined</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="nv">__cd</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">__nsteps</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__steps</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__data</span> <span class="o">=</span> 0x6021b8
</span></span><span class="line"><span class="cl">          <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">          <span class="nv">__data</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">__outbuf</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__outbufend</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__flags</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__invocation_counter</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__internal_use</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__statep</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__state</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">              <span class="nv">__count</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">              <span class="nv">__value</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">__wch</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">                <span class="nv">__wchb</span> <span class="o">=</span> <span class="s2">&#34;\000\000\000&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">          <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">      <span class="nv">__cd_out</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">__cd</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="nv">__nsteps</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">          <span class="nv">__steps</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">          <span class="nv">__data</span> <span class="o">=</span> 0x6021f8
</span></span><span class="line"><span class="cl">        <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">        <span class="nv">__combined</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="nv">__cd</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">__nsteps</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__steps</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__data</span> <span class="o">=</span> 0x6021f8
</span></span><span class="line"><span class="cl">          <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">          <span class="nv">__data</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">__outbuf</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__outbufend</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__flags</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__invocation_counter</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__internal_use</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__statep</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">            <span class="nv">__state</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">              <span class="nv">__count</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">              <span class="nv">__value</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">__wch</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">                <span class="nv">__wchb</span> <span class="o">=</span> <span class="s2">&#34;\000\000\000&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">          <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_shortbuf</span> <span class="o">=</span> L<span class="s2">&#34;&#34;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_wide_vtable</span> <span class="o">=</span> 0x0
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></div><h4 id="step2_io_no_init-对file结构体进行null初始化" class="heading-element"><span>step2:_IO_no_init 对file结构体进行null初始化</span>
  <a href="#step2_io_no_init-%e5%af%b9file%e7%bb%93%e6%9e%84%e4%bd%93%e8%bf%9b%e8%a1%8cnull%e5%88%9d%e5%a7%8b%e5%8c%96" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>分配完后，调用了<code>_IO_no_init</code>初始化改结构体</p>
<p>跟进去，在<code>/libio/genops.c</code>中</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">_IO_old_init</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">=</span> <span class="n">_IO_MAGIC</span><span class="o">|</span><span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_end</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_chain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* Not necessary. */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_save_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_backup_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_save_end</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_markers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_cur_column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##if _IO_JUMPS_OFFSET
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_vtable_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp">##ifdef _IO_MTSAFE_IO
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_IO_lock_init</span> <span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">_IO_no_init</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">orientation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	     <span class="k">struct</span> <span class="n">_IO_wide_data</span> <span class="o">*</span><span class="n">wd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="o">*</span><span class="n">jmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_IO_old_init</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">orientation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">orientation</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//初始化_wide_data字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span> <span class="o">=</span> <span class="n">wd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_end</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_save_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_backup_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_save_end</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_wide_vtable</span> <span class="o">=</span> <span class="n">jmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Cause predictable crash when a wide function is called on a byte
</span></span></span><span class="line"><span class="cl"><span class="cm">       stream.  */</span>
</span></span><span class="line"><span class="cl">    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_IO_wide_data</span> <span class="o">*</span><span class="p">)</span> <span class="o">-</span><span class="mi">1L</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_freeres_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>初始化了<code>locked_FILE</code>结构体中的<code>_IO_FILE_plus</code>结构体，以及其中的<code>_wide_data</code>字段，执行完<code>IO_no_init</code>后：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; print new_f-&gt;fp
</span></span><span class="line"><span class="cl"><span class="nv">$4</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">file</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">_flags</span> <span class="o">=</span> -72548352, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_ptr</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_ptr</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_buf_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_buf_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_save_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_backup_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_save_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_markers</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_chain</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_fileno</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_flags2</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_old_offset</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_cur_column</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_vtable_offset</span> <span class="o">=</span> <span class="m">0</span> <span class="s1">&#39;\000&#39;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_shortbuf</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_lock</span> <span class="o">=</span> 0x6020f0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_offset</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_codecvt</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_wide_data</span> <span class="o">=</span> 0x602100, 
</span></span><span class="line"><span class="cl">    <span class="nv">_freeres_list</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_freeres_buf</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">__pad5</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_mode</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_unused2</span> <span class="o">=</span> <span class="s1">&#39;\000&#39;</span> &lt;repeats <span class="m">19</span> times&gt;
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">  <span class="nv">vtable</span> <span class="o">=</span> 0x0
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></div><h4 id="step3-_io_file_init将结构体链接进_io_list_all" class="heading-element"><span>step3: _IO_file_init将结构体链接进_IO_list_all</span>
  <a href="#step3-_io_file_init%e5%b0%86%e7%bb%93%e6%9e%84%e4%bd%93%e9%93%be%e6%8e%a5%e8%bf%9b_io_list_all" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>回到<code>__fopen_internal</code>后，函数将<code>_IO_FILE_plus</code>结构体的vtable设置成了<code>_IO_file_jumps</code>，然后调用<code>_IO_file_init</code>将<code>_IO_FILE_plus</code>结构体链接进入<code>_IO_list_all</code>链表，跟进去后：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">_IO_new_file_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_IO_FILE_plus</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">_IO_pos_BAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">.</span><span class="n">_IO_file_flags</span> <span class="o">|=</span> <span class="n">CLOSED_FILEBUF_FLAGS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//调用_IO_link_in并设置_fileno
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">_IO_link_in</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">.</span><span class="n">_fileno</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_ver</span> <span class="p">(</span><span class="n">_IO_new_file_init</span><span class="p">,</span> <span class="n">_IO_file_init</span><span class="p">)</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; print *fp
</span></span><span class="line"><span class="cl"><span class="nv">$9</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">file</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">_flags</span> <span class="o">=</span> -72548352, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_ptr</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_ptr</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_buf_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_buf_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_save_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_backup_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_save_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_markers</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_chain</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_fileno</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_flags2</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_old_offset</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_cur_column</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_vtable_offset</span> <span class="o">=</span> <span class="m">0</span> <span class="s1">&#39;\000&#39;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_shortbuf</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_lock</span> <span class="o">=</span> 0x6020f0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_offset</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_codecvt</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_wide_data</span> <span class="o">=</span> 0x602100, 
</span></span><span class="line"><span class="cl">    <span class="nv">_freeres_list</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_freeres_buf</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">__pad5</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_mode</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_unused2</span> <span class="o">=</span> <span class="s1">&#39;\000&#39;</span> &lt;repeats <span class="m">19</span> times&gt;
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">  <span class="nv">vtable</span> <span class="o">=</span> 0x7ffff7dd06e0 &lt;_IO_file_jumps&gt;
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></div><p>继续跟<code>_IO_link_in</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_link_in</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_IO_FILE_plus</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//检查_flags标志位是否是_IO_LINKED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">.</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_LINKED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//设置标志位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">.</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_LINKED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##ifdef _IO_MTSAFE_IO
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>      <span class="nf">_IO_cleanup_region_start_noarg</span> <span class="p">(</span><span class="n">flush_cleanup</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">_IO_lock_lock</span> <span class="p">(</span><span class="n">list_all_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">run_fp</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">_IO_flockfile</span> <span class="p">((</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">.</span><span class="n">_chain</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="p">)</span> <span class="n">_IO_list_all</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">_IO_list_all</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">++</span><span class="n">_IO_list_all_stamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##ifdef _IO_MTSAFE_IO
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>      <span class="nf">_IO_funlockfile</span> <span class="p">((</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">run_fp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">_IO_lock_unlock</span> <span class="p">(</span><span class="n">list_all_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">_IO_cleanup_region_end</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_def</span> <span class="p">(</span><span class="n">_IO_link_in</span><span class="p">)</span></span></span></code></pre></div><p>FILE结构体是通过<code>_IO_list_all</code>的单链表来进行管理的 ，这里<code>_IO_link_in</code>是检查FILE结构体是否包含<code>_IO_LINKED</code>标志，如果不包含则表示这个结构体没有链接进<code>_IO_list_all</code>，之后会将它链接进<code>_IO_list_all</code>链表，同时设置<code>_chain</code>为之前的链表的值。</p>
<pre tabindex="0"><code>pwndbg&gt; print _IO_list_all
$10 = (struct _IO_FILE_plus *) 0x7ffff7dd2540 &lt;_IO_2_1_stderr_&gt;
pwndbg&gt; print _IO_list_all
$11 = (struct _IO_FILE_plus *) 0x602010
pwndbg&gt; print *fp
$12 = {
  file = {
    _flags = -72538996, 
    _IO_read_ptr = 0x0, 
    _IO_read_end = 0x0, 
    _IO_read_base = 0x0, 
    _IO_write_base = 0x0, 
    _IO_write_ptr = 0x0, 
    _IO_write_end = 0x0, 
    _IO_buf_base = 0x0, 
    _IO_buf_end = 0x0, 
    _IO_save_base = 0x0, 
    _IO_backup_base = 0x0, 
    _IO_save_end = 0x0, 
    _markers = 0x0, 
    _chain = 0x7ffff7dd2540 &lt;_IO_2_1_stderr_&gt;, 
    _fileno = 0, 
    _flags2 = 0, 
    _old_offset = 0, 
    _cur_column = 0, 
    _vtable_offset = 0 &#39;\000&#39;, 
    _shortbuf = &#34;&#34;, 
    _lock = 0x6020f0, 
    _offset = -1, 
    _codecvt = 0x0, 
    _wide_data = 0x602100, 
    _freeres_list = 0x0, 
    _freeres_buf = 0x0, 
    __pad5 = 0, 
    _mode = 0, 
    _unused2 = &#39;\000&#39; &lt;repeats 19 times&gt;
  }, 
  vtable = 0x7ffff7dd06e0 &lt;_IO_file_jumps&gt;
}</code></pre><p>可以看到没有执行<code>_IO_file_init</code>的时候指向<code>stderr</code>结构体，执行后指向申请出来的结构体。</p>
<p>并且<code>_chain</code>指向<code>stderr</code>结构体。</p>
<h4 id="step4_io_file_fopen打开文件句柄" class="heading-element"><span>step4:_IO_file_fopen打开文件句柄</span>
  <a href="#step4_io_file_fopen%e6%89%93%e5%bc%80%e6%96%87%e4%bb%b6%e5%8f%a5%e6%9f%84" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>之后回到，继续跟进</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">_IO_FILE</span> <span class="o">*</span> <span class="nf">_IO_new_file_fopen</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is32not64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">oflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">omode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">read_write</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">oprot</span> <span class="o">=</span> <span class="mo">0666</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##ifdef _LIBC
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">last_recognized</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="c1">//检查文件是否已打开
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nf">_IO_file_is_open</span> <span class="p">(</span><span class="n">fp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//设置打开模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="sc">&#39;r&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">omode</span> <span class="o">=</span> <span class="n">O_RDONLY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">read_write</span> <span class="o">=</span> <span class="n">_IO_NO_WRITES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//调用_IO_file_open
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">result</span> <span class="o">=</span> <span class="nf">_IO_file_open</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">omode</span><span class="o">|</span><span class="n">oflags</span><span class="p">,</span> <span class="n">oprot</span><span class="p">,</span> <span class="n">read_write</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			  <span class="n">is32not64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_ver</span> <span class="p">(</span><span class="n">_IO_new_file_fopen</span><span class="p">,</span> <span class="n">_IO_file_fopen</span><span class="p">)</span></span></span></code></pre></div><p>检查是否打开，之后设置打开模式，然后调用<code>_IO_file_open</code>继续跟进：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">_IO_FILE</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_file_open</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">int</span> <span class="n">posix_mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prot</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	       <span class="kt">int</span> <span class="n">read_write</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is32not64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">fdesc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##ifdef _LIBC
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="nf">__glibc_unlikely</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags2</span> <span class="o">&amp;</span> <span class="n">_IO_FLAGS2_NOTCANCEL</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">fdesc</span> <span class="o">=</span> <span class="nf">open_not_cancel</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			     <span class="n">posix_mode</span> <span class="o">|</span> <span class="p">(</span><span class="n">is32not64</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">O_LARGEFILE</span><span class="p">),</span> <span class="n">prot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//调用系统函数open打开文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">fdesc</span> <span class="o">=</span> <span class="nf">open</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">posix_mode</span> <span class="o">|</span> <span class="p">(</span><span class="n">is32not64</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">O_LARGEFILE</span><span class="p">),</span> <span class="n">prot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">##else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">fdesc</span> <span class="o">=</span> <span class="nf">open</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">posix_mode</span><span class="p">,</span> <span class="n">prot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">fdesc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//将文件描述符写到_fileno字段里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_fileno</span> <span class="o">=</span> <span class="n">fdesc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_IO_mask_flags</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">read_write</span><span class="p">,</span><span class="n">_IO_NO_READS</span><span class="o">+</span><span class="n">_IO_NO_WRITES</span><span class="o">+</span><span class="n">_IO_IS_APPENDING</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* For append mode, send the file offset to the end of the file.  Don&#39;t
</span></span></span><span class="line"><span class="cl"><span class="cm">     update the offset cache though, since the file handle is not active.  */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">read_write</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_IO_IS_APPENDING</span> <span class="o">|</span> <span class="n">_IO_NO_READS</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="o">==</span> <span class="p">(</span><span class="n">_IO_IS_APPENDING</span> <span class="o">|</span> <span class="n">_IO_NO_READS</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_IO_off64_t</span> <span class="n">new_pos</span> <span class="o">=</span> <span class="nf">_IO_SYSSEEK</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_IO_seek_end</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">new_pos</span> <span class="o">==</span> <span class="n">_IO_pos_BAD</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">ESPIPE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="nf">close_not_cancel</span> <span class="p">(</span><span class="n">fdesc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//调用_IO_link_in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">_IO_link_in</span> <span class="p">((</span><span class="k">struct</span> <span class="n">_IO_FILE_plus</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">fp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_def</span> <span class="p">(</span><span class="n">_IO_file_open</span><span class="p">)</span></span></span></code></pre></div><p>执行完后可以看到<code>_fileno</code>已经被设置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; print new_f-&gt;fp
</span></span><span class="line"><span class="cl"><span class="nv">$17</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">file</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">_flags</span> <span class="o">=</span> -72539004, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_ptr</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_ptr</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_buf_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_buf_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_save_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_backup_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_save_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_markers</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_chain</span> <span class="o">=</span> 0x7ffff7dd2540 &lt;_IO_2_1_stderr_&gt;, 
</span></span><span class="line"><span class="cl">    <span class="nv">_fileno</span> <span class="o">=</span> 3, 
</span></span><span class="line"><span class="cl">    <span class="nv">_flags2</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_old_offset</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_cur_column</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_vtable_offset</span> <span class="o">=</span> <span class="m">0</span> <span class="s1">&#39;\000&#39;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_shortbuf</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_lock</span> <span class="o">=</span> 0x6020f0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_offset</span> <span class="o">=</span> -1, 
</span></span><span class="line"><span class="cl">    <span class="nv">_codecvt</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_wide_data</span> <span class="o">=</span> 0x602100, 
</span></span><span class="line"><span class="cl">    <span class="nv">_freeres_list</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_freeres_buf</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">__pad5</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_mode</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_unused2</span> <span class="o">=</span> <span class="s1">&#39;\000&#39;</span> &lt;repeats <span class="m">19</span> times&gt;
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">  <span class="nv">vtable</span> <span class="o">=</span> 0x7ffff7dd06e0 &lt;_IO_file_jumps&gt;
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></div><h3 id="小结" class="heading-element"><span>小结</span>
  <a href="#%e5%b0%8f%e7%bb%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>fopen的流程：</p>
<blockquote>
<ol>
<li>malloc</li>
<li><code>_IO_no_init</code>初始化</li>
<li><code>_IO_file_init</code>将结构体链接进<code>_IO_list_all</code>链表</li>
<li><code>_IO_file_fopen</code>进行系统调用打开文件</li>
</ol></blockquote>
<p>整个流程还是比较简单的，fopen返回之后<code>_IO_list_all</code>链表指向返回的FILE结构体，且FILE结构体的_chain字段指向之前的结构体（没有其他额外打开文件的话，将是指向<code>stderr</code>），同时其他的字段大多都是默认的null值，<code>vtable</code>存储的是<code>__GI__IO_file_jumps</code>函数表，</p>
<h2 id="io_file之fread详解" class="heading-element"><span>IO_FILE之fread详解</span>
  <a href="#io_file%e4%b9%8bfread%e8%af%a6%e8%a7%a3" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>上面写了fopen的分析，讲了系统是如何为FILE结构体分配内存并将其链接进<code>_IO_list_all</code>中的。</p>
<p>本次来讲fread，实现从文件读数据。下面是本次fread的流程图：</p>
<p><img loading="lazy" src='/posts/io_file/image-20210925232855099.png' alt="image-20210925232855099" height="713" width="624"></p>
<p>fread的大致流程：</p>
<p>fread调用<code>_IO_sgetn</code>，之后<code>_IO_sgetn</code>调用vtable中的<code>_IO_XSGETN</code>也就是</p>
<p><code>_IO_file_xsgetn</code>，这个是fread的核心，简单流程：</p>
<ol>
<li>判断<code>fp-&gt;_IO_buf_base</code>输入缓冲区 是否为空，如果为空则调用<code>_IO_doallocbuf</code>初始化输入缓冲区</li>
<li>分配完输入缓冲区或者输入缓冲区不为空的情况下，判断输入缓冲区中是否有数据</li>
<li>如果有数据，直接拷贝到用户缓冲区，如果没有或不够则调用<code>__underflow</code>执行系统调用读取数据到输入缓冲区，再拷贝到用户缓冲区</li>
</ol>
<h3 id="demo" class="heading-element"><span>demo</span>
  <a href="#demo" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include&lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span><span class="o">*</span><span class="n">fp</span><span class="o">=</span><span class="nf">fopen</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">,</span><span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fread</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h3 id="源码分析-1" class="heading-element"><span>源码分析</span>
  <a href="#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>进到fread，看到调用了<code>_IO_fread</code></p>
<p>先看下FILE结构体的fp内容，可以看到<code>_IO_read_ptr</code>、<code>_IO_buf_base</code>等还是空的，后面的分析的重要的步骤也是看这些指针如何被赋值以及发挥作用的。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; print *_IO_list_all
</span></span><span class="line"><span class="cl"><span class="nv">$2</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">file</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">_flags</span> <span class="o">=</span> -72539000, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_ptr</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_ptr</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_buf_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_buf_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_save_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_backup_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_save_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_markers</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_chain</span> <span class="o">=</span> 0x7ffff7dd2540 &lt;_IO_2_1_stderr_&gt;, 
</span></span><span class="line"><span class="cl">    <span class="nv">_fileno</span> <span class="o">=</span> 3, 
</span></span><span class="line"><span class="cl">    <span class="nv">_flags2</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_old_offset</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_cur_column</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_vtable_offset</span> <span class="o">=</span> <span class="m">0</span> <span class="s1">&#39;\000&#39;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_shortbuf</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_lock</span> <span class="o">=</span> 0x6020f0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_offset</span> <span class="o">=</span> -1, 
</span></span><span class="line"><span class="cl">    <span class="nv">_codecvt</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_wide_data</span> <span class="o">=</span> 0x602100, 
</span></span><span class="line"><span class="cl">    <span class="nv">_freeres_list</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_freeres_buf</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">__pad5</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_mode</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_unused2</span> <span class="o">=</span> <span class="s1">&#39;\000&#39;</span> &lt;repeats <span class="m">19</span> times&gt;
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">  <span class="nv">vtable</span> <span class="o">=</span> 0x7ffff7dd06e0 &lt;_IO_file_jumps&gt;
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">pwndbg&gt; print *_IO_list_all-&gt;vtable
</span></span><span class="line"><span class="cl"><span class="nv">$3</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">__dummy</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">  <span class="nv">__dummy2</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">  <span class="nv">__finish</span> <span class="o">=</span> 0x7ffff7a869d0 &lt;_IO_new_file_finish&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__overflow</span> <span class="o">=</span> 0x7ffff7a87740 &lt;_IO_new_file_overflow&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__underflow</span> <span class="o">=</span> 0x7ffff7a874b0 &lt;_IO_new_file_underflow&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__uflow</span> <span class="o">=</span> 0x7ffff7a88610 &lt;__GI__IO_default_uflow&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__pbackfail</span> <span class="o">=</span> 0x7ffff7a89990 &lt;__GI__IO_default_pbackfail&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__xsputn</span> <span class="o">=</span> 0x7ffff7a861f0 &lt;_IO_new_file_xsputn&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__xsgetn</span> <span class="o">=</span> 0x7ffff7a85ed0 &lt;__GI__IO_file_xsgetn&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__seekoff</span> <span class="o">=</span> 0x7ffff7a854d0 &lt;_IO_new_file_seekoff&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__seekpos</span> <span class="o">=</span> 0x7ffff7a88a10 &lt;_IO_default_seekpos&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__setbuf</span> <span class="o">=</span> 0x7ffff7a85440 &lt;_IO_new_file_setbuf&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__sync</span> <span class="o">=</span> 0x7ffff7a85380 &lt;_IO_new_file_sync&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__doallocate</span> <span class="o">=</span> 0x7ffff7a7a190 &lt;__GI__IO_file_doallocate&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__read</span> <span class="o">=</span> 0x7ffff7a861b0 &lt;__GI__IO_file_read&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__write</span> <span class="o">=</span> 0x7ffff7a85b80 &lt;_IO_new_file_write&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__seek</span> <span class="o">=</span> 0x7ffff7a85980 &lt;__GI__IO_file_seek&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__close</span> <span class="o">=</span> 0x7ffff7a85350 &lt;__GI__IO_file_close&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__stat</span> <span class="o">=</span> 0x7ffff7a85b70 &lt;__GI__IO_file_stat&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__showmanyc</span> <span class="o">=</span> 0x7ffff7a89b00 &lt;_IO_default_showmanyc&gt;, 
</span></span><span class="line"><span class="cl">  <span class="nv">__imbue</span> <span class="o">=</span> 0x7ffff7a89b10 &lt;_IO_default_imbue&gt;
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></div><p>fread的调用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">_IO_size_t</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_fread</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">_IO_size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">_IO_size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_size_t</span> <span class="n">bytes_requested</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_size_t</span> <span class="n">bytes_read</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">CHECK_FILE</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">bytes_requested</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_IO_acquire_lock</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  <span class="c1">//调用_IO_sgetn函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">bytes_read</span> <span class="o">=</span> <span class="nf">_IO_sgetn</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bytes_requested</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_IO_release_lock</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">bytes_requested</span> <span class="o">==</span> <span class="n">bytes_read</span> <span class="o">?</span> <span class="nl">count</span> <span class="p">:</span> <span class="n">bytes_read</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_def</span> <span class="p">(</span><span class="n">_IO_fread</span><span class="p">)</span></span></span></code></pre></div><p>继续跟进<code>_IO_sgetn</code>函数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">_IO_size_t</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_sgetn</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">_IO_size_t</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* FIXME handle putback buffer here! */</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">_IO_XSGETN</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_def</span> <span class="p">(</span><span class="n">_IO_sgetn</span><span class="p">)</span></span></span></code></pre></div><p>可以看到他的调用是<code>_IO_XSGETN</code>函数，它的定义：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##define _IO_XSGETN(FP, DATA, N) JUMP2 (__xsgetn, FP, DATA, N)</span></span></span></code></pre></div><p>实际就是调用了vtable中的<code>__xsgetn</code>函数，继续跟：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">_IO_size_t</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_file_xsgetn</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">_IO_size_t</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_size_t</span> <span class="n">want</span><span class="p">,</span> <span class="n">have</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_ssize_t</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">want</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="p">....</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//step1：如果fp-&gt;_IO_buf_base == NULL，调用_IO_doallocbuf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nf">_IO_doallocbuf</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">want</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">have</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//step2：如果输入缓冲区中已有足够的字符，直接将缓冲区中的字符给目标buf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">want</span> <span class="o">&lt;=</span> <span class="n">have</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="nf">memcpy</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">,</span> <span class="n">want</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">+=</span> <span class="n">want</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">want</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//如果缓冲区中有部分字符，但没有达到fread的size，先将已有的拷贝到目标buf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="k">if</span> <span class="p">(</span><span class="n">have</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">##ifdef _LIBC
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	      <span class="n">s</span> <span class="o">=</span> <span class="nf">__mempcpy</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">,</span> <span class="n">have</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">##else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	      <span class="nf">memcpy</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">,</span> <span class="n">have</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	      <span class="n">s</span> <span class="o">+=</span> <span class="n">have</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	      <span class="n">want</span> <span class="o">-=</span> <span class="n">have</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">+=</span> <span class="n">have</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	  <span class="cm">/* Check for backup and repeat */</span>
</span></span><span class="line"><span class="cl">	  <span class="k">if</span> <span class="p">(</span><span class="nf">_IO_in_backup</span> <span class="p">(</span><span class="n">fp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	    <span class="p">{</span>
</span></span><span class="line"><span class="cl">	      <span class="nf">_IO_switch_to_main_get_area</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	  <span class="cm">/* If we now want less than a buffer, underflow and repeat
</span></span></span><span class="line"><span class="cl"><span class="cm">	     the copy.  Otherwise, _IO_SYSREAD directly to
</span></span></span><span class="line"><span class="cl"><span class="cm">	     the user buffer. */</span>
</span></span><span class="line"><span class="cl">	  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span>
</span></span><span class="line"><span class="cl">	      <span class="o">&amp;&amp;</span> <span class="n">want</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	    <span class="p">{</span>
</span></span><span class="line"><span class="cl">	      <span class="k">if</span> <span class="p">(</span><span class="nf">__underflow</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="c1">//step3：如果输入缓冲区不能满足要求，调用__underflow读数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	  <span class="p">.....</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">n</span> <span class="o">-</span> <span class="n">want</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_def</span> <span class="p">(</span><span class="n">_IO_file_xsgetn</span><span class="p">)</span></span></span></code></pre></div><p>函数<code>_IO_file_xsgetn</code>是fread的核心，分为以下几个部分：</p>
<ol>
<li>如果<code>fp-&gt;_IO_buf_base == NULL</code>，表名输入缓冲区还未建立，调用<code>_IO_doallocbuf</code>初始化指针，建立输入缓冲区</li>
<li>输入缓冲区中有数据，即<code>fp-&gt;_IO_read_ptr</code>小于<code>fp-&gt;_IO_read_end</code>，直接将输入缓冲区中的内筒拷贝到目标buf</li>
<li>输入缓冲区为空或者不能满足全部的需求，调用<code>__underflow</code>调用系统调用读入数据</li>
</ol>
<p>接下来就是具体介绍这几个部分。</p>
<h4 id="step1初始化输入缓冲区" class="heading-element"><span>step1：初始化输入缓冲区</span>
  <a href="#step1%e5%88%9d%e5%a7%8b%e5%8c%96%e8%be%93%e5%85%a5%e7%bc%93%e5%86%b2%e5%8c%ba" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>如果<code>fp-&gt;_IO_buf_base == NULL</code>则调用<code>_IO_doallocbuf</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_doallocbuf</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_UNBUFFERED</span><span class="p">)</span> <span class="o">||</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">_IO_DOALLOCATE</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_IO_setb</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_shortbuf</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_shortbuf</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_def</span> <span class="p">(</span><span class="n">_IO_doallocbuf</span><span class="p">)</span></span></span></code></pre></div><p>先检查<code>fp-&gt;_IO_buf_base</code>是否为空，不为空代表缓冲区已被初始化，直接返回，然后检查<code>fp-&gt;_flags</code>是不是<code>_IO_UNBUFFERED</code>或者<code>fp-&gt;_mode</code>大于0。</p>
<p>如果满足则执行<code>_IO_DOALLOCATE</code>，及调用vtable中的<code>_IO_file_doallocate</code>，跟进去看看：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_file_doallocate</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_size_t</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">stat64</span> <span class="n">st</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">##ifndef _LIBC
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="cm">/* If _IO_cleanup_registration_needed is non-zero, we should call the
</span></span></span><span class="line"><span class="cl"><span class="cm">     function it points to.  This is to make sure _IO_cleanup gets called
</span></span></span><span class="line"><span class="cl"><span class="cm">     on exit.  We call it from _IO_file_doallocate, since that is likely
</span></span></span><span class="line"><span class="cl"><span class="cm">     to get called by any program that does buffered I/O. */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">__glibc_unlikely</span> <span class="p">(</span><span class="n">_IO_cleanup_registration_needed</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="o">*</span><span class="n">_IO_cleanup_registration_needed</span><span class="p">)</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="n">size</span> <span class="o">=</span> <span class="n">_IO_BUFSIZ</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_fileno</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nf">__builtin_expect</span> <span class="p">(</span><span class="nf">_IO_SYSSTAT</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//调用_IO_SYSSTAT获取FILE信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nf">S_ISCHR</span> <span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="cm">/* Possibly a tty.  */</span>
</span></span><span class="line"><span class="cl">	  <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="cp">##ifdef DEV_TTY_P
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	      <span class="nf">DEV_TTY_P</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	      <span class="nf">local_isatty</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_fileno</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_LINE_BUF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">##if _IO_HAVE_ST_BLKSIZE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_blksize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">size</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">st_blksize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">p</span> <span class="o">=</span> <span class="nf">malloc</span> <span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">__glibc_unlikely</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_IO_setb</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//调用_IO_setb设置缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_def</span> <span class="p">(</span><span class="n">_IO_file_doallocate</span><span class="p">)</span></span></span></code></pre></div><p>可以看到<code>_IO_file_doallocate</code>先调用<code>_IO_SYSSTAT</code>获取文件信息（<code>_IO_SYSSTAT</code>是vtable中的<code>_start</code>函数，获取文件信息，修改相应需要申请的size）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; print st
</span></span><span class="line"><span class="cl"><span class="nv">$7</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">st_dev</span> <span class="o">=</span> 2049, 
</span></span><span class="line"><span class="cl">  <span class="nv">st_ino</span> <span class="o">=</span> 545917, 
</span></span><span class="line"><span class="cl">  <span class="nv">st_nlink</span> <span class="o">=</span> 1, 
</span></span><span class="line"><span class="cl">  <span class="nv">st_mode</span> <span class="o">=</span> 33188, 
</span></span><span class="line"><span class="cl">  <span class="nv">st_uid</span> <span class="o">=</span> 1000, 
</span></span><span class="line"><span class="cl">  <span class="nv">st_gid</span> <span class="o">=</span> 1000, 
</span></span><span class="line"><span class="cl">  <span class="nv">__pad0</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">  <span class="nv">st_rdev</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">  <span class="nv">st_size</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">  <span class="nv">st_blksize</span> <span class="o">=</span> 4096, 
</span></span><span class="line"><span class="cl">  <span class="nv">st_blocks</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">  <span class="nv">st_atim</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">tv_sec</span> <span class="o">=</span> 1632561914, 
</span></span><span class="line"><span class="cl">    <span class="nv">tv_nsec</span> <span class="o">=</span> <span class="m">519216733</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">  <span class="nv">st_mtim</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">tv_sec</span> <span class="o">=</span> 1632490672, 
</span></span><span class="line"><span class="cl">    <span class="nv">tv_nsec</span> <span class="o">=</span> <span class="m">158707989</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">  <span class="nv">st_ctim</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">tv_sec</span> <span class="o">=</span> 1632490672, 
</span></span><span class="line"><span class="cl">    <span class="nv">tv_nsec</span> <span class="o">=</span> <span class="m">158707989</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">  <span class="nv">__glibc_reserved</span> <span class="o">=</span> <span class="o">{</span>0, 0, 0<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></div><p>可以看到<code>st_blksize</code>为0x1000，malloc之后调用了<code>_IO_setb</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_setb</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">eb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_USER_BUF</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span><span class="c1">//设置了_IO_buf_base 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span> <span class="o">=</span> <span class="n">eb</span><span class="p">;</span><span class="c1">//设置_IO_buf_end
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">_IO_USER_BUF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_USER_BUF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_def</span> <span class="p">(</span><span class="n">_IO_setb</span><span class="p">)</span></span></span></code></pre></div><p>设置了<code>_IO_buf_base</code>和<code>_IO_buf_end</code>，<code>_IO_setb</code>执行完后<code>_IO_buf_base</code>和<code>_IO_buf_end</code>已被赋值：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">print</span> <span class="o">*</span><span class="n">_IO_list_all</span>
</span></span><span class="line"><span class="cl"><span class="err">$</span><span class="mi">2</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">file</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_flags</span> <span class="o">=</span> <span class="o">-</span><span class="mi">72539000</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_IO_read_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_IO_read_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_IO_write_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_IO_write_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="mh">0x602240</span> <span class="s">&#34;&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_IO_buf_end</span> <span class="o">=</span> <span class="mh">0x603240</span> <span class="s">&#34;&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_IO_save_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_IO_backup_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_IO_save_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_markers</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_chain</span> <span class="o">=</span> <span class="mh">0x7ffff7dd2540</span> <span class="o">&lt;</span><span class="n">_IO_2_1_stderr_</span><span class="o">&gt;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_fileno</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_flags2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_old_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_cur_column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_vtable_offset</span> <span class="o">=</span> <span class="mi">0</span> <span class="sc">&#39;\000&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_shortbuf</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_lock</span> <span class="o">=</span> <span class="mh">0x6020f0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_codecvt</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_wide_data</span> <span class="o">=</span> <span class="mh">0x602100</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_freeres_list</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_freeres_buf</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">__pad5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_unused2</span> <span class="o">=</span> <span class="sc">&#39;\000&#39;</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">19</span> <span class="n">times</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> 
</span></span><span class="line"><span class="cl">  <span class="n">vtable</span> <span class="o">=</span> <span class="mh">0x7ffff7dd06e0</span> <span class="o">&lt;</span><span class="n">_IO_file_jumps</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>初始化之后返回到<code>_IO_file_doallocate</code>，然后<code>_IO_file_doallocate</code>也执行完成 ，返回到<code>_IO_file_xsgetn</code>中。</p>
<h4 id="step2拷贝输入缓冲区数据" class="heading-element"><span>step2：拷贝输入缓冲区数据</span>
  <a href="#step2%e6%8b%b7%e8%b4%9d%e8%be%93%e5%85%a5%e7%bc%93%e5%86%b2%e5%8c%ba%e6%95%b0%e6%8d%ae" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>初始化完成后就到了第二步，拷贝输入缓冲区数据。如果输入缓冲区中已有足够的字符，直接将缓冲区中的字符给目标buf。<code>fp-&gt;_IO_read_ptr</code>指向的是输入缓冲区的其实地址，<code>fp-&gt;_IO_read_end</code>指向输入缓冲区的结束。</p>
<h4 id="step3执行系统调用读取数据" class="heading-element"><span>step3：执行系统调用读取数据</span>
  <a href="#step3%e6%89%a7%e8%a1%8c%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8%e8%af%bb%e5%8f%96%e6%95%b0%e6%8d%ae" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>当输入缓冲区为0或者不能满足需求的时候会执行<code>__underflow</code>调用系统调用read读取数据并放到输入缓冲区中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="nf">__underflow</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//一些检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="nf">_IO_vtable_offset</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nf">_IO_fwide</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_IO_fwide</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">_IO_in_put_mode</span> <span class="p">(</span><span class="n">fp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">_IO_switch_to_get_mode</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">&lt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">_IO_in_backup</span> <span class="p">(</span><span class="n">fp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">_IO_switch_to_main_get_area</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">&lt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">_IO_have_markers</span> <span class="p">(</span><span class="n">fp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nf">save_for_backup</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">_IO_have_backup</span> <span class="p">(</span><span class="n">fp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_IO_free_backup_area</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">_IO_UNDERFLOW</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_def</span> <span class="p">(</span><span class="n">__underflow</span><span class="p">)</span></span></span></code></pre></div><p>其中一个检查是如果<code>fp-&gt;_IO_read_ptr</code>小于<code>fp-&gt;_IO_read_end</code>则表明输入缓冲区里存在数据，可直接返回，否则则表示需要继续读入数据。都通过的话会执行<code>_IO_UNDERFLOW</code>，它是vtable中的<code>_IO_new_file_underflow</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_new_file_underflow</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_IO_ssize_t</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果存在_IO_NO_READS标志，则直接返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_NO_READS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">__set_errno</span> <span class="p">(</span><span class="n">EBADF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果输入缓冲区里存在数据，则直接返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">&lt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果没有输入缓冲区，则调用_IO_doallocbuf分配输入缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">      <span class="nf">_IO_doallocbuf</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 设置FILE结构体指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_end</span>
</span></span><span class="line"><span class="cl">    <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//调用_IO_SYSREAD函数最终执行系统调用读取数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">count</span> <span class="o">=</span> <span class="nf">_IO_SYSREAD</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 设置结构体指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">libc_hidden_ver</span> <span class="p">(</span><span class="n">_IO_new_file_underflow</span><span class="p">,</span> <span class="n">_IO_file_underflow</span><span class="p">)</span></span></span></code></pre></div><p><code>_IO_new_file_underflow</code>是最终执行系统调用的地方，调用前仍有一些检查：</p>
<ol>
<li>检查FILE结构体的<code>_flag</code>标志位是否包含<code>_IO_NO_READS</code>，如果存在这个标志位则直接返回<code>EOF</code>，其中<code>_IO_NO_READS</code>标志位的定义是<code>#define _IO_NO_READS 4 /* Reading not allowed */</code>。</li>
<li>如果<code>fp-&gt;_IO_buf_base</code>位null，则调用<code>_IO_doallocbuf</code>分配输入缓冲区。</li>
<li>接着初始化设置FILE结构体指针，将他们都设置成<code>fp-&gt;_IO_buf_base</code></li>
<li>调用<code>_IO_SYSREAD</code>（vtable中的<code>_IO_file_read</code>函数），该函数最终执行系统调用read，读取文件数据，数据读入到<code>fp-&gt;_IO_buf_base</code>中，读入大小为输入缓冲区的大小<code>fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base</code>。</li>
<li>设置输入缓冲区已有数据的size，即设置<code>fp-&gt;_IO_read_end</code>为<code>fp-&gt;_IO_read_end += count</code>。</li>
</ol>
<p>其中第四步的<code>_IO_SYSREAD</code>（vtable中的<code>_IO_file_read</code>函数）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">_IO_ssize_t</span>
</span></span><span class="line"><span class="cl"><span class="nf">_IO_file_read</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">_IO_ssize_t</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="p">(</span><span class="nf">__builtin_expect</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags2</span> <span class="o">&amp;</span> <span class="n">_IO_FLAGS2_NOTCANCEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">           <span class="o">?</span> <span class="nf">read_not_cancel</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_fileno</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">           <span class="o">:</span> <span class="nf">read</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_fileno</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span></span></span></code></pre></div><p>执行完后，FILE结构体的各个指针已被赋值，</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; print *_IO_list_all
</span></span><span class="line"><span class="cl"><span class="nv">$6</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">file</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">_flags</span> <span class="o">=</span> -72539000, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_ptr</span> <span class="o">=</span> 0x602240 <span class="s2">&#34;111111111\n&#34;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_end</span> <span class="o">=</span> 0x60224a <span class="s2">&#34;&#34;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_read_base</span> <span class="o">=</span> 0x602240 <span class="s2">&#34;111111111\n&#34;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_base</span> <span class="o">=</span> 0x602240 <span class="s2">&#34;111111111\n&#34;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_ptr</span> <span class="o">=</span> 0x602240 <span class="s2">&#34;111111111\n&#34;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_write_end</span> <span class="o">=</span> 0x602240 <span class="s2">&#34;111111111\n&#34;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_buf_base</span> <span class="o">=</span> 0x602240 <span class="s2">&#34;111111111\n&#34;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_buf_end</span> <span class="o">=</span> 0x603240 <span class="s2">&#34;&#34;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_save_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_backup_base</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_IO_save_end</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_markers</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_chain</span> <span class="o">=</span> 0x7ffff7dd2540 &lt;_IO_2_1_stderr_&gt;, 
</span></span><span class="line"><span class="cl">    <span class="nv">_fileno</span> <span class="o">=</span> 3, 
</span></span><span class="line"><span class="cl">    <span class="nv">_flags2</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_old_offset</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_cur_column</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_vtable_offset</span> <span class="o">=</span> <span class="m">0</span> <span class="s1">&#39;\000&#39;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_shortbuf</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>, 
</span></span><span class="line"><span class="cl">    <span class="nv">_lock</span> <span class="o">=</span> 0x6020f0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_offset</span> <span class="o">=</span> -1, 
</span></span><span class="line"><span class="cl">    <span class="nv">_codecvt</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_wide_data</span> <span class="o">=</span> 0x602100, 
</span></span><span class="line"><span class="cl">    <span class="nv">_freeres_list</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_freeres_buf</span> <span class="o">=</span> 0x0, 
</span></span><span class="line"><span class="cl">    <span class="nv">__pad5</span> <span class="o">=</span> 0, 
</span></span><span class="line"><span class="cl">    <span class="nv">_mode</span> <span class="o">=</span> -1, 
</span></span><span class="line"><span class="cl">    <span class="nv">_unused2</span> <span class="o">=</span> <span class="s1">&#39;\000&#39;</span> &lt;repeats <span class="m">19</span> times&gt;
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, 
</span></span><span class="line"><span class="cl">  <span class="nv">vtable</span> <span class="o">=</span> 0x7ffff7dd06e0 &lt;_IO_file_jumps&gt;
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></div><h3 id="小结-1" class="heading-element"><span>小结</span>
  <a href="#%e5%b0%8f%e7%bb%93-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ol>
<li><code>_IO_sgetn</code>函数调用了vtable的<code>_IO_file_xsgetn</code>。</li>
<li><code>_IO_doallocbuf</code>函数调用了vtable的<code>_IO_file_doallocate</code>以初始化输入缓冲区。</li>
<li>vtable中的<code>_IO_file_doallocate</code>调用了vtable中的<code>__GI__IO_file_stat</code>以获取文件信息。</li>
<li><code>__underflow</code>函数调用了vtable中的<code>_IO_new_file_underflow</code>实现文件数据读取。</li>
<li>vtable中的<code>_IO_new_file_underflow</code>调用了vtable<code>__GI__IO_file_read</code>最终去执行系统调用read。</li>
</ol>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2021-09-24 23:09:51">Updated on 2021-09-24&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on X" data-sharer="twitter" data-url="http://localhost:1313/posts/io_file/" data-title="IO_FILE调试&#43;详解" data-hashtags="PWN"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/io_file/" data-hashtag="PWN"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://localhost:1313/posts/io_file/" data-title="IO_FILE调试&#43;详解"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/pwn/" class="post-tag" title="Tags - PWN">PWN</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/buu-web-0x30-0x3f/" class="post-nav-item" rel="prev" title="BUU_WEB刷题_0x30-0x3F"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>BUU_WEB刷题_0x30-0x3F</a><a href="/posts/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%95%B4%E7%90%86/" class="post-nav-item" rel="next" title="PHP反序列化整理">PHP反序列化整理<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.145.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.17-8212d6fd"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"version":"v0.3.17-8212d6fd"};console.log('Page config:', window.config);</script><script src="/js/theme.min.js" defer></script></body>
</html>
