<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Windows内核(一)——保护模式 - 敬渊&#39;s Blog</title><meta name="author" content="">
<meta name="description" content="[toc]
001.保护模式 x86CPU三个模式：实模式， 保护模式，虚拟8086模式
"><meta name="keywords" content='Win32'>
  <meta itemprop="name" content="Windows内核(一)——保护模式">
  <meta itemprop="description" content="[toc]
001.保护模式 x86CPU三个模式：实模式， 保护模式，虚拟8086模式">
  <meta itemprop="datePublished" content="2022-09-26T00:00:00+00:00">
  <meta itemprop="dateModified" content="2022-09-26T00:00:00+00:00">
  <meta itemprop="wordCount" content="11462">
  <meta itemprop="keywords" content="Win32"><meta property="og:url" content="https://nesl42.github.io/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/">
  <meta property="og:site_name" content="敬渊&#39;s Blog">
  <meta property="og:title" content="Windows内核(一)——保护模式">
  <meta property="og:description" content="[toc]
001.保护模式 x86CPU三个模式：实模式， 保护模式，虚拟8086模式">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-09-26T00:00:00+00:00">
    <meta property="article:modified_time" content="2022-09-26T00:00:00+00:00">
    <meta property="article:tag" content="Win32">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Windows内核(一)——保护模式">
  <meta name="twitter:description" content="[toc]
001.保护模式 x86CPU三个模式：实模式， 保护模式，虚拟8086模式">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="https://nesl42.github.io/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/" title="Windows内核(一)——保护模式 - 敬渊&#39;s Blog" /><link rel="prev" type="text/html" href="https://nesl42.github.io/posts/2022-hw/" title="HW日记" /><link rel="next" type="text/html" href="https://nesl42.github.io/posts/2022-9-%E8%BF%99%E4%B8%A4%E5%B9%B4%E6%88%91%E5%AD%A6%E5%88%B0%E4%BA%86%E4%BB%80%E4%B9%88/" title="这两年我学到了什么" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Windows内核(一)——保护模式",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/nesl42.github.io\/posts\/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F\/"
    },"genre": "posts","keywords": "Win32","wordcount":  11462 ,
    "url": "https:\/\/nesl42.github.io\/posts\/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F\/","datePublished": "2022-09-26T00:00:00+00:00","dateModified": "2022-09-26T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Author"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/">文章</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/">标签</a></li><li class="menu-item">
              <a class="menu-link" href="/about/">关于</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/">分类</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="/posts/">文章</a></li><li class="menu-item"><a class="menu-link" href="/tags/">标签</a></li><li class="menu-item"><a class="menu-link" href="/about/">关于</a></li><li class="menu-item"><a class="menu-link" href="/categories/">分类</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Windows内核(一)——保护模式</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="published on 2022-09-26 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2022-09-26">2022-09-26</time></span>&nbsp;<span title="11462 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 11500 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>23 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#001保护模式">001.保护模式</a></li>
        <li><a href="#002段寄存器结构">002.段寄存器结构</a></li>
        <li><a href="#003段寄存器属性探测">003.段寄存器属性探测</a></li>
        <li><a href="#004段描述符与段选择子">004.段描述符与段选择子</a>
          <ul>
            <li><a href="#使用les指令修改es">使用LES指令修改ES</a></li>
          </ul>
        </li>
        <li><a href="#005段描述符属性p位和g位">005.段描述符属性：P位和G位</a>
          <ul>
            <li><a href="#练习从gtd表中查找对应的段描述符然后填充到段寄存器中">练习：从GTD表中查找对应的段描述符，然后填充到段寄存器中。</a></li>
          </ul>
        </li>
        <li><a href="#006段描述符属性s位和type域">006.段描述符属性：S位和TYPE域</a></li>
        <li><a href="#007段描述符属性db位">007.段描述符属性：DB位</a></li>
        <li><a href="#008段权限检查">008.段权限检查</a></li>
        <li><a href="#009代码跨段跳转流程">009.代码跨段跳转流程</a></li>
        <li><a href="#010代码跨段跳转实验">010.代码跨段跳转实验</a></li>
        <li><a href="#额外双机调试">额外：双机调试</a></li>
        <li><a href="#011长调用与短调用">011.长调用与短调用</a></li>
        <li><a href="#012调用门无参">012.调用门(无参)</a>
          <ul>
            <li><a href="#调用门提权">调用门提权</a></li>
            <li><a href="#读高2g内存">读高2G内存</a></li>
          </ul>
        </li>
        <li><a href="#013调用门有参-">013.调用门(有参 )</a>
          <ul>
            <li><a href="#调用门总结">调用门总结</a></li>
            <li><a href="#调用门阶段测试">调用门阶段测试</a>
              <ul>
                <li><a href="#test1">Test1</a></li>
                <li><a href="#test2">Test2</a></li>
                <li><a href="#test3">Test3</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#014中断门">014.中断门</a>
          <ul>
            <li><a href="#中断门描述符">中断门描述符</a></li>
            <li><a href="#提权不提权">提权&amp;不提权</a></li>
            <li><a href="#读取idt表项">读取IDT表项</a></li>
            <li><a href="#调用门中使用iretd返回中断门实现retf返回">调用门中使用IRETD返回，中断门实现RETF返回</a>
              <ul>
                <li><a href="#中断门">中断门</a></li>
                <li><a href="#调用门">调用门</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#015陷阱门">015.陷阱门</a></li>
        <li><a href="#0x16任务段">0x16.任务段</a>
          <ul>
            <li><a href="#tr寄存器的读写">TR寄存器的读写</a></li>
          </ul>
        </li>
        <li><a href="#0x17任务段">0x17.任务段</a>
          <ul>
            <li><a href="#修改tr寄存器">修改TR寄存器</a></li>
            <li><a href="#call访问任务段正确返回">CALL访问任务段，正确返回</a></li>
            <li><a href="#jmp访问任务段正确返回">JMP访问任务段，正确返回</a></li>
          </ul>
        </li>
        <li><a href="#0x18任务门">0x18.任务门</a>
          <ul>
            <li><a href="#练习">练习</a></li>
          </ul>
        </li>
        <li><a href="#0x1910-10-12分页">0x19.10-10-12分页</a></li>
        <li><a href="#020pde_pte">020.PDE_PTE</a></li>
        <li><a href="#021pde_pte属性p_rw">021.PDE_PTE属性(P_RW)</a>
          <ul>
            <li><a href="#修改常量">修改常量</a></li>
          </ul>
        </li>
        <li><a href="#022pde_pte属性us_ps_a_d-">022.PDE_PTE属性(US_PS_A_D )</a>
          <ul>
            <li><a href="#us位">U/S位</a></li>
            <li><a href="#读高2g内存地址">读高2G内存地址：</a></li>
            <li><a href="#ps位">P/S位</a></li>
            <li><a href="#a位">A位</a></li>
            <li><a href="#d位">D位</a></li>
          </ul>
        </li>
        <li><a href="#023页目录表基址">023.页目录表基址</a>
          <ul>
            <li><a href="#页目录表pdt">页目录表PDT</a></li>
            <li><a href="#页表ptt">页表PTT</a></li>
          </ul>
        </li>
        <li><a href="#024页表基址">024.页表基址</a></li>
        <li><a href="#0252-9-9-12分页">025.2-9-9-12分页</a>
          <ul>
            <li><a href="#查看物理地址">查看物理地址</a></li>
          </ul>
        </li>
        <li><a href="#0262-9-9-12分页">026.2-9-9-12分页</a>
          <ul>
            <li><a href="#pdpte">PDPTE</a></li>
            <li><a href="#pde">PDE</a></li>
            <li><a href="#pte">PTE</a></li>
            <li><a href="#给0线性地址挂上物理页">给0线性地址挂上物理页</a></li>
            <li><a href="#公式">公式</a></li>
          </ul>
        </li>
        <li><a href="#027tlb">027.TLB</a>
          <ul>
            <li><a href="#证明tlb存在">证明TLB存在</a></li>
          </ul>
        </li>
        <li><a href="#028控制寄存器">028.控制寄存器</a>
          <ul>
            <li><a href="#cr0">Cr0</a></li>
            <li><a href="#cr2">Cr2</a></li>
            <li><a href="#cr4">Cr4</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>[toc]</p>
<h2 id="001保护模式" class="heading-element"><span>001.保护模式</span>
  <a href="#001%e4%bf%9d%e6%8a%a4%e6%a8%a1%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>x86CPU三个模式：实模式， 保护模式，虚拟8086模式</p>
<p>市面上能见到的x64对x86向下兼容，是x86的扩展</p>
<p>保护模式特点：</p>
<ul>
<li>段的机制</li>
<li>页的基址</li>
</ul>
<h2 id="002段寄存器结构" class="heading-element"><span>002.段寄存器结构</span>
  <a href="#002%e6%ae%b5%e5%af%84%e5%ad%98%e5%99%a8%e7%bb%93%e6%9e%84" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>学段机制之前先要知道段寄存器结构</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="no">ds</span><span class="p">:[</span><span class="mi">0x123456</span><span class="p">],</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">实际上读的地址是：</span><span class="nf">ds.base</span> <span class="err">+</span> <span class="mi">0x123456</span></span></span></code></pre></div><p>段寄存器共8个：</p>
<p><code>ES,CS,SS,DS,FS,GS,LDTR,TR</code></p>
<blockquote>
<p>LDRT在win中不用</p></blockquote>
<p>段寄存器共96位，其中高80位不可见，低16位可见</p>
<p>段寄存器在读的时候只能读16位：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">ax</span><span class="p">,</span><span class="no">es</span><span class="err">//也就是</span><span class="no">Selector部分</span></span></span></code></pre></div><h2 id="003段寄存器属性探测" class="heading-element"><span>003.段寄存器属性探测</span>
  <a href="#003%e6%ae%b5%e5%af%84%e5%ad%98%e5%99%a8%e5%b1%9e%e6%80%a7%e6%8e%a2%e6%b5%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>寄存器的96位：</p>
<pre tabindex="0"><code>Selector	//16，可见部分
Atrribute	//16
Base		//32
Limit		//32</code></pre><p><strong>LDTR和TR寄存器不能使用mov读写</strong></p>
<p>不同系统红色部分可能不同：</p>
<p>GS寄存器win没有使用</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926221649224.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926221649224.png" height="404" width="1104"></p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220705133725810.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220705133725810.png" height="151" width="355"></p>
<h2 id="004段描述符与段选择子" class="heading-element"><span>004.段描述符与段选择子</span>
  <a href="#004%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e4%b8%8e%e6%ae%b5%e9%80%89%e6%8b%a9%e5%ad%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>介绍两张表：GDT(全局描述符表)和LDT(局部描述符表，该表在win并没有使用)</p>
<p>当执行类似mov ds,ax指令时，cpu会查表，</p>
<p>主要是查GDT	表。</p>
<p>本来要是用32的，这里使用x64来演示，其实都差不多：</p>
<p>gdtr和gdtl 分别可以知道gdt这个表的位置和大小，dd指令可以查看指定位置的数据：</p>
<pre tabindex="0"><code>0: kd&gt; r gdtr
gdtr=fffff8023406afb0
0: kd&gt; r gdtl
gdtl=0057
0: kd&gt; dd fffff8023406afb0
fffff802`3406afb0  00000000 00000000 00000000 00000000
fffff802`3406afc0  00000000 00209b00 00000000 00409300
fffff802`3406afd0  0000ffff 00cffb00 0000ffff 00cff300
fffff802`3406afe0  00000000 0020fb00 00000000 00000000
fffff802`3406aff0  90000067 34008b06 fffff802 00000000
fffff802`3406b000  00003c00 0040f300 00000000 00000000
fffff802`3406b010  00000000 00000000 00000000 00000000
fffff802`3406b020  00000000 00000000 00000000 00000000</code></pre><p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220705143157265.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220705143157265.png" height="265" width="471"></p>
<blockquote>
<p>换成32位xp后：</p></blockquote>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915155154854.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915155154854.png" height="310" width="418"></p>
<p>段描述符，一个段描述符有8字节，查看段描述符一般使用dq查看，即qword，如上图</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220409162131390.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220409162131390.png" height="750" width="1124"></p>
<p>段选择子：16位的端描述符，</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926221614422.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926221614422.png" height="498" width="1186"></p>
<p>除了MOV指令，我们还可以使用LES、LSS、LDS、LFS、LGS指令修改寄存器.
CS不能通过上述的指令进行修改，CS为代码段,CS的改变会导致EIP的改变，要改CS，必须要保证CS与EIP一起改，后面会讲.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">__asm</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">les</span> <span class="n">ecx</span><span class="p">,</span><span class="n">fword</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="n">buffer</span><span class="p">]</span> <span class="c1">//高2个字节给es，低四个字节给ecx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//fword 为6字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span></span></span></code></pre></div><p>注意:RPL&lt;=DPL(在数值上)，上述指令才能运行</p>
<p>DPL：描述符特权级</p>
<h3 id="使用les指令修改es" class="heading-element"><span>使用LES指令修改ES</span>
  <a href="#%e4%bd%bf%e7%94%a8les%e6%8c%87%e4%bb%a4%e4%bf%ae%e6%94%b9es" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &#34;stdafx.h&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// RPL &lt;= DPL
</span></span></span><span class="line"><span class="cl"><span class="c1">// Selector: 0000 0000 0011 1000(0038)
</span></span></span><span class="line"><span class="cl"><span class="c1">// LES高2字节给ES，低4字节给ECX，其他指令如LSS,LDS依此类推
</span></span></span><span class="line"><span class="cl"><span class="c1">// RPL是段选择子的权限，DPL是段描述符的权限，数值越大权限越小
</span></span></span><span class="line"><span class="cl"><span class="c1">// 因此当RPL=3时，只能访问DPL=3的段描述符；当RPL=0时，可以访问所有段描述符
</span></span></span><span class="line"><span class="cl"><span class="c1">// 下面的buffer作为源操作数执行les指令，会把ES写为0x0038，EAX写为0x11223344
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x44</span><span class="p">,</span><span class="mh">0x33</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// LES修改段寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">les</span> <span class="n">ecx</span><span class="p">,</span><span class="n">fword</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="n">buffer</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>可以看到ECX和ES被修改：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220925124839590.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220925124839590.png" height="390" width="926"></p>
<h2 id="005段描述符属性p位和g位" class="heading-element"><span>005.段描述符属性：P位和G位</span>
  <a href="#005%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e5%b1%9e%e6%80%a7p%e4%bd%8d%e5%92%8cg%e4%bd%8d" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>P=1：段描述符有效，0为无效</p>
<p>G位：</p>
<ul>
<li>当G=0时，Limit的范围是<code>0x00000000-0x000FFFFF</code>，其中，段描述符的20位在低位，高位补0.</li>
<li>当G=1时，Limit的范围是<code>0x00000FFF-0xFFFFFFFF</code>，其中，段描述符的20位在高位，低位补F。</li>
</ul>
<p>段寄存器：</p>
<pre tabindex="0"><code>Selector	//16,段选择子（已确定）
Atrribute	//16，高32位中的：8--23位
Base		//32，有三部分，在上面的图都能找到
Limit		//32，上面有20位，也就是最多FFFFF,当G=0时，单位为字节，那么0x000FFFFF；当G=1时，单位为4KB，0xFFFFFFFF</code></pre><p>目前不要使用FS，FS与线程相关。</p>
<h3 id="练习从gtd表中查找对应的段描述符然后填充到段寄存器中" class="heading-element"><span>练习：从GTD表中查找对应的段描述符，然后填充到段寄存器中。</span>
  <a href="#%e7%bb%83%e4%b9%a0%e4%bb%8egtd%e8%a1%a8%e4%b8%ad%e6%9f%a5%e6%89%be%e5%af%b9%e5%ba%94%e7%9a%84%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e7%84%b6%e5%90%8e%e5%a1%ab%e5%85%85%e5%88%b0%e6%ae%b5%e5%af%84%e5%ad%98%e5%99%a8%e4%b8%ad" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>段选择子：23 2B 30 3B 53</p>
<pre tabindex="0"><code>23：0010 0011
index:4
00cff300`0000ffff
WORD Selector: 23
WORD Atrribute: cff3
DWORD Base: 00000000
DWORD Limit: ffffffff

2B：0010 1011
index:5
80008b04`200020ab
WORD Selector: 2B
WORD Atrribute: 008b
DWORD Base: 80042000
DWORD Limit:000020ab

30：0011 0000
index:6
ffc093df`f0000001
WORD Selector: 30
WORD Atrribute: c093
DWORD Base: ffdff000
DWORD Limit: 00001fff

3B：0011 1011
index:7
0040f300`00000fff
WORD Selector: 3B
WORD Atrribute: 40f3
DWORD Base: 00000000
DWORD Limit: 00000fff

53：0101 0011
index:A
80008954`af000068
WORD Selector: 53
WORD Atrribute: 0089
DWORD Base: 8054af00
DWORD Limit: 00000068</code></pre><h2 id="006段描述符属性s位和type域" class="heading-element"><span>006.段描述符属性：S位和TYPE域</span>
  <a href="#006%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e5%b1%9e%e6%80%a7s%e4%bd%8d%e5%92%8ctype%e5%9f%9f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>S=1：代码段或者数据段描述符</p>
<p>S=0：系统段描述符</p>
<p>DPL只有两种情况，00和11</p>
<p>也就是说只有第五位为9或者F时这里是代码段或者数据段，否则不是：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220409170300022.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220409170300022.png" height="308" width="502"></p>
<p>当type第11位为0时是数据段，1时是代码段：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220409170426468.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220409170426468.png" height="799" width="1673"></p>
<p>A：是否被访问过</p>
<p>W：是否可写</p>
<p>E：向下扩展位，</p>
<p>R：是否可读</p>
<p>C：一致位</p>
<p>上面是当S=1的情况，下面是S=0，也就是系统段描述符的情况：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220409171001033.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220409171001033.png" height="778" width="1380"></p>
<h2 id="007段描述符属性db位" class="heading-element"><span>007.段描述符属性：DB位</span>
  <a href="#007%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e5%b1%9e%e6%80%a7db%e4%bd%8d" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><pre tabindex="0"><code>情况一︰对CS段的影响
    D=1:采用32位寻址方式
    D=0:采用16位寻址方式
    前缀67：改变寻址方式（见下图）
情况二:对SS段的影响
    D=1:隐式堆栈访问指令(如:PUSH POP CALL）使用32位堆栈指针寄存器ESP
    D=О:隐式堆栈访问指令(如:PUSH POP CALL）使用16位堆栈指针寄存器SP
情况三:向下拓展的数据段
    D=1:段上线为4GB
    D=0:段上线为64KB
    D=1:段上线为4GB
    D=0:段上线为64KB</code></pre><p>32位寻址：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915160041371.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915160041371.png" height="303" width="545"></p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926221836085.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926221836085.png" height="809" width="896"></p>
<h2 id="008段权限检查" class="heading-element"><span>008.段权限检查</span>
  <a href="#008%e6%ae%b5%e6%9d%83%e9%99%90%e6%a3%80%e6%9f%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926221851332.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926221851332.png" height="419" width="594"></p>
<p>==如何查看程序是哪一环：CPL（当前特权级）==</p>
<p>==CS和SS中存储的段选择子的后2位==</p>
<pre tabindex="0"><code>//这种就是0 环
0: kd&gt; r
rax=000000000000df01 rbx=fffff80230fa6180 rcx=0000000000000001
rdx=0000002500000000 rsi=0000000000000001 rdi=ffffc009d5bf0040
rip=fffff80231dc00a0 rsp=fffff80234081b78 rbp=0000000000000000
 r8=000000000000014a  r9=ffffc009d18a1000 r10=00000000000000a4
r11=fffff80234081c08 r12=000000256c72b900 r13=0000000000000000
r14=fffff78000000300 r15=0000000000000001
iopl=0         nv up ei pl nz na pe nc
cs=0010  ss=0018  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
nt!DbgBreakPointWithStatus:
fffff802`31dc00a0 cc              int     3</code></pre><pre tabindex="0"><code>//这种就是3环
0:000&gt; r
rax=0000000000000000 rbx=0000000000000010 rcx=00007ffb95e4d214
rdx=0000000000000000 rsi=00007ffb95ee1a90 rdi=0000006091902000
rip=00007ffb95e806b0 rsp=0000006091a7f2a0 rbp=0000000000000000
 r8=0000006091a7f298  r9=0000000000000000 r10=0000000000000000
r11=0000000000000246 r12=0000000000000040 r13=0000000000000000
r14=00007ffb95ed48f0 r15=00000202241a0000
iopl=0         nv up ei pl zr na po nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
ntdll!LdrpDoDebuggerBreak+0x30:
00007ffb`95e806b0 cc              int     3</code></pre><p>CPL：CPU当前的权限级别(当前程序)
DPL：(Descriptor Privilege Level:描述符特权级别)如果你想访问我，你应该具备什么样的权限，描述符特权级
RPL ：用什么权限去访问一企段，请求特权级</p>
<pre tabindex="0"><code>参考如下代码:
比如当前程序处于0环，也就是说CPL=O
Mov ax,00OB //1011 RPL = 3
Mov ds,ax   //ax指向的段描述符的DPL=0

数据段的权限检查:
CPL&lt;= DPL 并且 RPL&lt;= DPL(数值上的比较)
注意:
代码段和系统段描述符中的检查方式并不一样,具体参加后面课程.</code></pre><h2 id="009代码跨段跳转流程" class="heading-element"><span>009.代码跨段跳转流程</span>
  <a href="#009%e4%bb%a3%e7%a0%81%e8%b7%a8%e6%ae%b5%e8%b7%b3%e8%bd%ac%e6%b5%81%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><strong>代码跨段本质就是修改CS段寄存器</strong></p>
<pre tabindex="0"><code>1、代码间的跳转(段间跳转非调用门之类的)

段间跳转，有2种情况，即要跳转的段是一致代码段还是非一致代码段(如何区分参见之前视频)

同时修改CS与EIP的指令
JMP FAR/CALL FAR/RETF /INT/IRETED
注意:
只改变EIP的指令
JMP / CALL /JcC/RET


2、代码间的跳转(段间跳转非调用门之类的)执行流程:
JMP 0x20:0x004183D7 CPU如何执行这行代码?
    (1)段选择子拆分
        Ox20对应二进制形式0000 0000 0010 0000
        RPL= 00
        TI=0
        lndex = 4
    (2)查表得到段描述符
        TI=0 所以查GDT表
        Index=4 找到对应的段描述符
        四种情况可以跳转:代码段、调用门、TSS任务段、任务门
    (3)权限检查
    	如果是非一致代码段，要求:CPL == DPL并且RPL&lt;= DPL
    	如果是一致代码段，要求:CPL &gt;= DPL
    (4)加载段描述符
    	通过上面的权限检查后，CPU会将段描述符加载到CS段寄存器中.
    (5)代码执行
        CPU将CS.Base + Offset的值写入EIP然后执行CS:EIP处的代码，段间跳转结束.
6、总结:
对于一致代码段:也就是共享的段
	特权级高的程序不允许访问特权级低的数据:O核心态不允许访问用户态的数据
	特权级低的程序可以访问到特权级高的数据，但特权级不会改变:用户态还是用户态
对于普通代码段:也就是非一致代码段
	只允许同级访问
	绝对禁止不同级别的访问:核心态不是用户态，用户态也不是核心态.</code></pre><p>直接对代码段进行JMP或者CALL的操作，无论目标是一致代码段还是非一致代码段，CPL都不会发生改变.如果要提升CPL的权限，只能通过调用门.</p>
<h2 id="010代码跨段跳转实验" class="heading-element"><span>010.代码跨段跳转实验</span>
  <a href="#010%e4%bb%a3%e7%a0%81%e8%b7%a8%e6%ae%b5%e8%b7%b3%e8%bd%ac%e5%ae%9e%e9%aa%8c" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>1.构造段描述符</p>
<p>​	找一个非一致代码段描述符，复制一份，写入到GDT表中</p>
<p>将上面的那个写到下面空的地方：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915163111192.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915163111192.png" height="289" width="694"></p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220705205746223.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220705205746223.png" height="179" width="654"></p>
<p>在od中：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915163545870.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915163545870.png" height="455" width="1385"></p>
<p>执行后，ip和cs都会改变，成功执行：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915163613567.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915163613567.png" height="486" width="1509"></p>
<p>下面修改段描述符的权限级别DPL，为00cf9b00`0000ffff，在od中跳转的内容不变，执行后会发现。跳转不成功，权限检查错误，跳到了ntdll里：</p>
<pre tabindex="0"><code>kd&gt; eq 8003f048 00cf9b00`0000ffff
kd&gt; g</code></pre><p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915164138159.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915164138159.png" height="530" width="1384"></p>
<p>上面是非一致代码段，下面将该段描述符改为一致代码段(允许低权限执行)，改为00cf9f00xxxxxx，                                                                                              成功跳转：</p>
<pre tabindex="0"><code>kd&gt; eq 8003f048 00cf9f00`0000ffff
kd&gt; g</code></pre><p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915164331943.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915164331943.png" height="417" width="1482"></p>
<p>总结:</p>
<p>1、为了对数据进行保护，普通代码段是禁止不同级别进行访问的。用户态的代码不能访问内核的数据，同样，内核态的代码也不能访问用户态的数据.
2、如果想提供一些通用的功能，而且这些功能并不会破坏内核数据，那么可以选择一致代码段，这样低级别的程序可以在不提升CPL权限等级的情况下即可以访问.
3、如果想访问普通代码段，只有通过“调用门&quot;等提示CPL权限，才能访问。</p>
<h2 id="额外双机调试" class="heading-element"><span>额外：双机调试</span>
  <a href="#%e9%a2%9d%e5%a4%96%e5%8f%8c%e6%9c%ba%e8%b0%83%e8%af%95" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><strong>从这里开始换调试环境了，换成winxp32位了。</strong></p>
<p>改boot.ini</p>
<pre tabindex="0"><code>[boot loader]
timeout=30
default=multi(0)disk(0)rdisk(0)partition(1)\WINDOWS
[operating systems]
multi(0)disk(0)rdisk(0)partition(1)\WINDOWS=&#34;Microsoft Windows XP Professional&#34; /noexecute=optin /fastdetect
multi(0)disk(0)rdisk(0)partition(1)\WINDOWS=&#34;Microsoft Windows XP Professional&#34; /noexecute=optin /fastdetect /debug /debugport=com1 /baudrate=115200</code></pre><p>添加串行端口：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915154318677.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915154318677.png" height="520" width="608"></p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915154357463.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915154357463.png" height="548" width="441"></p>
<pre tabindex="0"><code>C:\Program Files (x86)\Windows Kits\10\Debuggers\x86&gt;windbg.exe -b -k com:port=\\.\pipe\com_1,baud=115200,pipe</code></pre><h2 id="011长调用与短调用" class="heading-element"><span>011.长调用与短调用</span>
  <a href="#011%e9%95%bf%e8%b0%83%e7%94%a8%e4%b8%8e%e7%9f%ad%e8%b0%83%e7%94%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>短调用就是我们在汇编常见的<code>CALL</code>指令，<code>call</code>后会将EIP压栈。</p>
<p>长调用分为两种，一种提权，一种不提权，调用格式为：指令格式：<code>CALL CS:EIP</code>，其中<code>EIP</code>是废弃的，<code>CS</code>为指向<code>调用门</code>的段选择子。</p>
<p>通过<strong>JMP FAR</strong>可以实现段间的跳转如果要实现跨段的调用就必须要<strong>CALL FAR</strong>，也就是长调用.
<strong>CALL FAR</strong>比<strong>JMP FAR</strong>要复杂，<code>JMP</code>并不影响堆栈,但<code>CALL</code>指令会影响.</p>
<ol>
<li>
<p>短调用：</p>
<p>指令格式：<code>call 立即数/寄存器/内存</code></p>
<p>CALL的时候会将下一行代码的地址压入栈，call后eip与esp都会变。</p>
<p>ret 的时候会将写入的地址写入eip，esp也会变。</p>
</li>
<li>
<p>长调用（跨段不提权）</p>
<p>指令格式：<code>call cs:eip(eip是废弃的)</code></p>
<p>发生改变的寄存器有<code>ESP</code>、<code>EIP</code>和<code>CS</code>，比段调用多了一个<code>CS</code></p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926211210422.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926211210422.png" height="681" width="1371"></p>
</li>
<li>
<p>长调用（跨段并提权）</p>
<p>指令格式：<code>call cs:eip(eip是废弃的)</code></p>
<p>发生改变的寄存器有<code>ESP</code>、<code>EIP</code>、<code>CS</code>和`SS。</p>
</li>
</ol>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915170010817.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915170010817.png" height="389" width="891"><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915170021012.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220915170021012.png" height="344" width="540"></p>
<p>5、总结：</p>
<ol>
<li>跨段调用时，一旦有权限切换，就会切换堆栈.</li>
<li>CS的权限一旦改变，SS的权限也要随着改变，CS与SS的等级必须一样.</li>
<li><code>JMP FAR</code> 只能跳转到同级非一致代码段，但<code>CALL FAR</code>可以通过调用门提权，提升CPL的权限.</li>
</ol>
<h2 id="012调用门无参" class="heading-element"><span>012.调用门(无参)</span>
  <a href="#012%e8%b0%83%e7%94%a8%e9%97%a8%e6%97%a0%e5%8f%82" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>win无调用门但是可以手写</p>
<p>p位：12bit=0：系统描述符</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916164814247.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916164814247.png" height="328" width="965"></p>
<pre tabindex="0"><code>调用门执行流程

指令格式：CALL  CS:EIP(EIP是废弃的)
执行步骤：
1) 根据CS的值 查GDT表，找到对应的段描述符  这个描述符是一个调用门.
2) 在调用门描述符中存储另一个代码段段的选择子.
3) 选择子指向的段  段.Base + 偏移地址 就是真正要执行的地址.</code></pre><p>可以在0x48的位置写，这个位置没有被用到，防止蓝屏。</p>
<h3 id="调用门提权" class="heading-element"><span>调用门提权</span>
  <a href="#%e8%b0%83%e7%94%a8%e9%97%a8%e6%8f%90%e6%9d%83" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>构造一个调用门描述符：</p>
<pre tabindex="0"><code>0000 EC00 0008 0000</code></pre><p>写到gdt表：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916232442504.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916232442504.png" height="491" width="657"></p>
<p>观察堆栈和寄存器变化：</p>
<p>找到地址：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916233410021.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916233410021.png" height="281" width="544"></p>
<p>这时的寄存器：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916233912720.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916233912720.png" height="233" width="440"></p>
<p>所以说要改调用门为：<code>0040EC00 00081020</code></p>
<p>发生中断后，中断到了0环调试器：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916233949926.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916233949926.png" height="159" width="986"></p>
<p>可以看到cs和eip还有esp都发生了变化，成功提权，这时已经是0环权限了。</p>
<p>并且新的栈中，压入了原来esp和cs等内容。</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916234159283.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916234159283.png" height="332" width="942"></p>
<h3 id="读高2g内存" class="heading-element"><span>读高2G内存</span>
  <a href="#%e8%af%bb%e9%ab%982g%e5%86%85%e5%ad%98" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>地址没变，所以gdt表的内容没改。</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916235233228.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916235233228.png" height="729" width="1201">
<code>sgdt</code>指令是用来读取<code>GDTR</code>这个寄存器的，3环也可以做到(ret就行)：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="nf">FunctionHas0CPL</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">sgdt</span> <span class="n">GDT</span>
</span></span><span class="line"><span class="cl">		<span class="n">ret</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h2 id="013调用门有参-" class="heading-element"><span>013.调用门(有参 )</span>
  <a href="#013%e8%b0%83%e7%94%a8%e9%97%a8%e6%9c%89%e5%8f%82-" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>调用门描述符和上节还是一样，如果有参数的话如下：<code>0000 EC03 0008 0000(3个参数)</code></p>
<p>这时的堆栈：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917094545158.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917094545158.png" height="371" width="839"></p>
<p>跟上一节一样，该gdtr</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917100052830.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917100052830.png" height="732" width="978"></p>
<p>测试代码及结果</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917100007067.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917100007067.png" height="756" width="1147"></p>
<h3 id="调用门总结" class="heading-element"><span>调用门总结</span>
  <a href="#%e8%b0%83%e7%94%a8%e9%97%a8%e6%80%bb%e7%bb%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><pre tabindex="0"><code>1) 当通过门，权限不变的时候，只会PUSH两个值：CS  返回地址
	新的CS的值由调用门决定

2) 当通过门，权限改变的时候，会PUSH四个值：SS、ESP、CS、返回地址   
	新的CS的值由调用门决定  
	新的SS和ESP由TSS提供

3) 通过门调用时，要执行哪行代码有调用门决定，但使用RETF返回时，由堆栈中压人的值决定，这就是说，进门时只能按指定路线走，出门时可以翻墙(只要改变堆栈里面的值就可以想去哪去哪)	
4) 可不可以再建个门出去呢?也就是用Call  当然可以了 前门进 后门出	</code></pre><h3 id="调用门阶段测试" class="heading-element"><span>调用门阶段测试</span>
  <a href="#%e8%b0%83%e7%94%a8%e9%97%a8%e9%98%b6%e6%ae%b5%e6%b5%8b%e8%af%95" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="test1" class="heading-element"><span>Test1</span>
  <a href="#test1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>构造调用门，实现R3读高2G内存</p>
<p>还是上面的，注意构造的调用门描述符</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916235233228.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220916235233228.png" height="729" width="1201"></p>
<h4 id="test2" class="heading-element"><span>Test2</span>
  <a href="#test2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>在第一题的基础上进行修改，实现通过fq的方式返回到其他地址</p>
<p>意思就是不走原来的RETF，而知修改栈里面的ret地址，跳到其他地址执行。</p>
<p>注意修改返回地址</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926204910845.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926204910845.png" height="566" width="955"></p>
<h4 id="test3" class="heading-element"><span>Test3</span>
  <a href="#test3" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>在第一题的基础上进行修改，在门中再建一个门跳转到其他地址</p>
<p>需要注意，从第一个函数跳到第二个函数时，调用门中的DPL要设置成0，因为此时裸函数1的CPL=0.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">dwHigh2GValue</span><span class="p">;</span> <span class="c1">// 高2G内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">BOOL</span> <span class="n">bFunctionHas0CPL1Called</span><span class="p">;</span> <span class="c1">// 证明函数1被调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">BOOL</span> <span class="n">bFunctionHas0CPL2Called</span><span class="p">;</span> <span class="c1">// 证明函数2被调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">gate1</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span> <span class="c1">// 0041ec00`00081000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="n">gate2</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x90</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span> <span class="c1">// 00418c00`00081020
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 该函数通过 CALL FAR 调用，使用调用门提权，拥有0环权限
</span></span></span><span class="line"><span class="cl"><span class="c1">// 00401000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="nf">FunctionHas0CPL1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//int 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushfd</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">al</span><span class="p">,</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">byte</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="n">bFunctionHas0CPL1Called</span><span class="p">],</span><span class="n">al</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 读取了GDT表第二项的低4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span><span class="mh">0x8003f008</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">dwHigh2GValue</span><span class="p">,</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">call</span> <span class="n">fword</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="n">gate2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">popfd</span>
</span></span><span class="line"><span class="cl">		<span class="n">popad</span>		
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">retf</span>	<span class="c1">// 注意堆栈平衡，写错蓝屏
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 00401020
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="nf">FunctionHas0CPL2</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//int 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushfd</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">al</span><span class="p">,</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">byte</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="n">bFunctionHas0CPL2Called</span><span class="p">],</span><span class="n">al</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">popfd</span>
</span></span><span class="line"><span class="cl">		<span class="n">popad</span>
</span></span><span class="line"><span class="cl">		<span class="n">retf</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>	
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">call</span> <span class="n">fword</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="n">gate1</span><span class="p">]</span> <span class="c1">// 长调用，使用调用门提权
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">dwHigh2GValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%d %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">bFunctionHas0CPL1Called</span><span class="p">,</span><span class="n">bFunctionHas0CPL2Called</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>成功执行：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926205843621.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926205843621.png" height="561" width="970"></p>
<h2 id="014中断门" class="heading-element"><span>014.中断门</span>
  <a href="#014%e4%b8%ad%e6%96%ad%e9%97%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>win中没有使用调用门，但是使用了中断门，比如系统调用和调试。</p>
<p>（老的CPU使用的是系统调用，新的是使用快速调用）</p>
<p>IDT表，即中断描述符表，每个描述符都占8字节，IDT的第一个不为空：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917100944324.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917100944324.png" height="287" width="593"></p>
<p>IDT表中只有三种描述符：</p>
<ol>
<li>任务门描述符</li>
<li>中断门描述符</li>
<li>陷阱们描述符</li>
</ol>
<h3 id="中断门描述符" class="heading-element"><span>中断门描述符</span>
  <a href="#%e4%b8%ad%e6%96%ad%e9%97%a8%e6%8f%8f%e8%bf%b0%e7%ac%a6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917101400290.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917101400290.png" height="364" width="831"></p>
<h3 id="提权不提权" class="heading-element"><span>提权&amp;不提权</span>
  <a href="#%e6%8f%90%e6%9d%83%e4%b8%8d%e6%8f%90%e6%9d%83" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>提权&amp;不提权时的栈情况：</p>
<ul>
<li>不提权时：压入<code>EFLAF</code>，<code>CS</code>，<code>EIP</code></li>
<li>提权时：压入<code>EFLAF</code>，<code>CS</code>，<code>EIP</code>，并且压入<code>SS</code>和<code>ESP</code></li>
</ul>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926212001922.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926212001922.png" height="441" width="883"></p>
<p>构造中断门：<code>0000EE00 00080000</code></p>
<h3 id="读取idt表项" class="heading-element"><span>读取IDT表项</span>
  <a href="#%e8%af%bb%e5%8f%96idt%e8%a1%a8%e9%a1%b9" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>在IDT表中找个p=0的无效项</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917103115783.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917103115783.png" height="464" width="612"></p>
<p>可以看到正确读取了</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917103501066.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917103501066.png" height="637" width="1604"></p>
<p>当<strong>CPL=DPL</strong>时，才能成功触发中断。</p>
<h3 id="调用门中使用iretd返回中断门实现retf返回" class="heading-element"><span>调用门中使用IRETD返回，中断门实现RETF返回</span>
  <a href="#%e8%b0%83%e7%94%a8%e9%97%a8%e4%b8%ad%e4%bd%bf%e7%94%a8iretd%e8%bf%94%e5%9b%9e%e4%b8%ad%e6%96%ad%e9%97%a8%e5%ae%9e%e7%8e%b0retf%e8%bf%94%e5%9b%9e" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>这里要对调用门(提权)和中断门(提权)的栈情况有了解。（见上面几小节</p>
<p>popfd将EFLAG弹出。</p>
<h4 id="中断门" class="heading-element"><span>中断门</span>
  <a href="#%e4%b8%ad%e6%96%ad%e9%97%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">BYTE</span> <span class="n">IDTItem0</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// R0 函数，读取了IDT表第一项
</span></span></span><span class="line"><span class="cl"><span class="c1">// 00401000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="nf">R0Function</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//int 3 // 调试用的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushfd</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span><span class="mh">0x8003f400</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">ebx</span><span class="p">,[</span><span class="n">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">ecx</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="n">IDTItem0</span><span class="p">],</span><span class="n">ebx</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="n">IDTItem0</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="n">ecx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 要求用 retf 返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">add</span> <span class="n">esp</span><span class="p">,</span><span class="mh">0x2c</span>		<span class="c1">// esp指向eflags
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">popfd</span>				<span class="c1">// esp指向3环esp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">esp</span><span class="p">]</span>		<span class="c1">// 将原ESP和SS向低地址移动4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="p">[</span><span class="n">esp</span><span class="o">-</span><span class="mh">0x4</span><span class="p">],</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">sub</span> <span class="n">esp</span><span class="p">,</span><span class="mh">0x30</span>		<span class="c1">// 还原esp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">popfd</span>
</span></span><span class="line"><span class="cl">		<span class="n">popad</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">retf</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span> 
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">INT</span> <span class="mh">0x20</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%08x %08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)</span><span class="n">IDTItem0</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">IDTItem0</span><span class="o">+</span><span class="mh">0x4</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>成功返回：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926213928875.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926213928875.png" height="554" width="1030"></p>
<h4 id="调用门" class="heading-element"><span>调用门</span>
  <a href="#%e8%b0%83%e7%94%a8%e9%97%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">dwHigh2GValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 该函数通过 CALL FAR 调用，使用调用门提权，拥有0环权限
</span></span></span><span class="line"><span class="cl"><span class="c1">// 00401000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="nf">FunctionHas0CPL</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushfd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 读取了GDT表第二项的低4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span><span class="mh">0x8003f008</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">dwHigh2GValue</span><span class="p">,</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 要求用 iretd 返回		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">add</span> <span class="n">esp</span><span class="p">,</span><span class="mh">0x30</span>		<span class="c1">// esp指向ss
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">esp</span><span class="p">]</span>		<span class="c1">// 将原ESP和SS向高地址移动4字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">esp</span><span class="o">-</span><span class="mh">0x4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushfd</span>
</span></span><span class="line"><span class="cl">		<span class="n">sub</span> <span class="n">esp</span><span class="p">,</span><span class="mh">0x2c</span>		<span class="c1">// 还原esp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="n">popfd</span>
</span></span><span class="line"><span class="cl">		<span class="n">popad</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">iretd</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">call</span> <span class="n">fword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">buff</span><span class="p">]</span> <span class="c1">// 长调用，使用调用门提权
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">dwHigh2GValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>成功返回：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926214258402.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220926214258402.png" height="567" width="957"></p>
<h2 id="015陷阱门" class="heading-element"><span>015.陷阱门</span>
  <a href="#015%e9%99%b7%e9%98%b1%e9%97%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>陷阱门描述符：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917104302437.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917104302437.png" height="329" width="846"></p>
<p>构造一个陷阱门描述符：<code>0000EF00 0008 0000</code></p>
<p>陷阱门与中断门几乎一直，唯一区别是：中断门执行时，将IF位清零，但陷阱门不会。</p>
<h2 id="0x16任务段" class="heading-element"><span>0x16.任务段</span>
  <a href="#0x16%e4%bb%bb%e5%8a%a1%e6%ae%b5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>调用门中断门与陷阱门出现权限切换时，堆栈回切换，由于CS的CPL发生改变，也导致了SS也必须要切换。</p>
<p>切换时，会有新的ESP和SS(CS是由中断门或者调用门指定)，这两个值是从TSS (Task-state segment )，任务状态段，而来</p>
<p>TSS是一块内存，大小为104字节：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917172922264.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917172922264.png" height="611" width="570"></p>
<p><strong>作用：同时切换一堆寄存器(任务切换)</strong></p>
<p>TSS的地址在<code>TR</code>段寄存器中。</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917173106598.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917173106598.png" height="520" width="647"></p>
<p>TSS段描述符：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917173121555.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917173121555.png" height="470" width="809"></p>
<h3 id="tr寄存器的读写" class="heading-element"><span>TR寄存器的读写</span>
  <a href="#tr%e5%af%84%e5%ad%98%e5%99%a8%e7%9a%84%e8%af%bb%e5%86%99" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ol>
<li>
<p>将TSS段描述符加载到TR寄存器</p>
<p>指令：LTR</p>
<p>说明：</p>
<ul>
<li>
<pre><code> 用LTR指令去装载的话，仅仅是改变TR寄存器的值(96位) ，并没有真正改变TSS 
</code></pre>
</li>
<li>
<pre><code> LTR指令只能在系统层使用
</code></pre>
</li>
<li>
<pre><code> 加载后TSS段描述符会状态位会发生改变
</code></pre>
</li>
</ul>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">MOV AX,SelectorTSS
LTR AX</code></pre></li>
<li>
<p>读TR寄存器</p>
<p>指令：<code>STR</code></p>
<p>说明：如果用STR去读的话，只读了TR的16位，也就是选择子</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">STR</span> <span class="no">AX</span></span></span></code></pre></div></li>
</ol>
<h2 id="0x17任务段" class="heading-element"><span>0x17.任务段</span>
  <a href="#0x17%e4%bb%bb%e5%8a%a1%e6%ae%b5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>CPU通过<code>TR段寄存器</code>来找到TSS，如果我们想用自己的TSS段来替换原来的寄存器，就要修改TR寄存器，TR寄存器的值又是来自TSS段描述符，那么我们接下来先构造一个段描述符</p>
<h3 id="修改tr寄存器" class="heading-element"><span>修改TR寄存器</span>
  <a href="#%e4%bf%ae%e6%94%b9tr%e5%af%84%e5%ad%98%e5%99%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ol>
<li>
<p>在Ring0 我们可以通过<code>LTR</code>指令去修改TR寄存器</p>
</li>
<li>
<p>在Ring3 我们可以通过<code>CALL FAR</code> 或者 <code>JMP FAR</code>指令来修改</p>
</li>
</ol>
<p>用JMP去访问一个代码段的时候，改变的是CS和EIP ：</p>
<ol>
<li>
<p>JMP 0x48:0x123456  如果0x48是代码段</p>
</li>
<li>
<p>执行后：CS&ndash;&gt;0x48  EIP&ndash;&gt;0x123456</p>
</li>
</ol>
<p>用JMP去访问一个任务段的时候：</p>
<ol>
<li>如果0x48是TSS段描述符，先修改TR寄存器，</li>
<li>再用TR.Base指向的TSS中的值修改当前的寄存器</li>
</ol>
<h3 id="call访问任务段正确返回" class="heading-element"><span>CALL访问任务段，正确返回</span>
  <a href="#call%e8%ae%bf%e9%97%ae%e4%bb%bb%e5%8a%a1%e6%ae%b5%e6%ad%a3%e7%a1%ae%e8%bf%94%e5%9b%9e" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>构造TSS段描述符：<code>xx00 E9xx xxxx0068</code></p>
<p><code>eq xxxxxxx 0000E93A 00000068</code></p>
<pre tabindex="0"><code>!process 0 0//查看Dirbase，即CR3</code></pre><p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917214509330.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917214509330.png" height="291" width="1000"></p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917214430495.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917214430495.png" height="668" width="1256"></p>
<p>代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">dwOk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">dwESP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">dwCS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 任务切换后的EIP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="nf">R0Func</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushfd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">push</span> <span class="n">fs</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="mi">3</span> <span class="c1">// int 3 会修改FS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">pop</span> <span class="n">fs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="n">dwOk</span><span class="p">],</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span><span class="n">esp</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="n">dwESP</span><span class="p">],</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">ax</span><span class="p">,</span><span class="n">cs</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">word</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="n">dwCS</span><span class="p">],</span><span class="n">ax</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">popfd</span>
</span></span><span class="line"><span class="cl">		<span class="n">popad</span>
</span></span><span class="line"><span class="cl">		<span class="n">iretd</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>	
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">dwCr3</span><span class="p">;</span> <span class="c1">// windbg获取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span> <span class="n">esp</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span> <span class="c1">// 任务切换后的栈，数组名就是ESP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	
</span></span><span class="line"><span class="cl">	<span class="c1">// 此数组的地址就是TSS描述符中的Base
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="o">*</span><span class="n">TSS</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)</span><span class="nf">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="n">MEM_COMMIT</span><span class="p">,</span><span class="n">PAGE_READWRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">TSS</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;VirtualAlloc 失败，%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">GetLastError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">		<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;请在windbg执行: eq 8003f048 %02x00e9%02x`%04x0068</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">TSS</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">,((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">TSS</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">,</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">TSS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;请在windbg中执行!process 0 0，复制TSS.exe进程DirBase的值，并输入.</span><span class="se">\n</span><span class="s">CR3: &#34;</span><span class="p">);</span> <span class="c1">// 在windbg中执行 !process 0 0 获取，DirBase: 13600420  这个数要启动程序后现查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%x&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwCr3</span><span class="p">);</span> <span class="c1">// 注意是%x
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	
</span></span><span class="line"><span class="cl">	<span class="n">TSS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// Previous Task Link CPU填充，表示上一个任务的选择子
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// ESP0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// SS0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// ESP1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// SS1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// ESP2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// SS2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">dwCr3</span><span class="p">;</span> <span class="c1">// CR3 学到页就知道是啥了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">R0Func</span><span class="p">;</span> <span class="c1">// EIP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EFLAGS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EAX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// ECX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EDX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EBX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x900</span><span class="p">;</span> <span class="c1">// ESP，解释：esp是一个0x1000的字节数组，作为裸函数的栈，这里传进去的应该是高地址，压栈才不会越界
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EBP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// ESI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EDI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000023</span><span class="p">;</span> <span class="c1">// ES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000008</span><span class="p">;</span> <span class="c1">// CS 0x0000001B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000010</span><span class="p">;</span> <span class="c1">// SS 0x00000023
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000023</span><span class="p">;</span> <span class="c1">// DS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000030</span><span class="p">;</span> <span class="c1">// FS 0x0000003B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// GS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// LDT Segment Selector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20ac0000</span><span class="p">;</span> <span class="c1">// I/O Map Base Address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>	
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">call</span> <span class="n">fword</span> <span class="n">ptr</span><span class="p">[</span><span class="n">buff</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ok: %d</span><span class="se">\n</span><span class="s">ESP: %x</span><span class="se">\n</span><span class="s">CS: %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">dwOk</span><span class="p">,</span> <span class="n">dwESP</span><span class="p">,</span> <span class="n">dwCS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>上面是通过CALL去访问任务段，下面是通过JMP访问，并且可以返回：</p>
<h3 id="jmp访问任务段正确返回" class="heading-element"><span>JMP访问任务段，正确返回</span>
  <a href="#jmp%e8%ae%bf%e9%97%ae%e4%bb%bb%e5%8a%a1%e6%ae%b5%e6%ad%a3%e7%a1%ae%e8%bf%94%e5%9b%9e" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>和CALL FAR对比，NT位不会置1，TSS previous task link 也不会填充旧的TR，因此想要返回，可以先保存旧的TR，然后JMP FAR回去。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">dwOk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">dwESP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">dwCS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 任务切换后的EIP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="nf">R0Func</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushfd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">push</span> <span class="n">fs</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="mi">3</span> <span class="c1">// int 3 会修改FS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">pop</span> <span class="n">fs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="n">dwOk</span><span class="p">],</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span><span class="n">esp</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="n">dwESP</span><span class="p">],</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">ax</span><span class="p">,</span><span class="n">cs</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">word</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="n">dwCS</span><span class="p">],</span><span class="n">ax</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">popfd</span>
</span></span><span class="line"><span class="cl">		<span class="n">popad</span>
</span></span><span class="line"><span class="cl">		<span class="n">iretd</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>	
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">dwCr3</span><span class="p">;</span> <span class="c1">// windbg获取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span> <span class="n">esp</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span> <span class="c1">// 任务切换后的栈，数组名就是ESP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	
</span></span><span class="line"><span class="cl">	<span class="c1">// 此数组的地址就是TSS描述符中的Base
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="o">*</span><span class="n">TSS</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)</span><span class="nf">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="n">MEM_COMMIT</span><span class="p">,</span><span class="n">PAGE_READWRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">TSS</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;VirtualAlloc 失败，%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">GetLastError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">		<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;请在windbg执行: eq 8003f048 %02x00e9%02x`%04x0068</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">TSS</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">,((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">TSS</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">,</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">TSS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;请在windbg中执行!process 0 0，复制TSS.exe进程DirBase的值，并输入.</span><span class="se">\n</span><span class="s">CR3: &#34;</span><span class="p">);</span> <span class="c1">// 在windbg中执行 !process 0 0 获取，DirBase: 13600420  这个数要启动程序后现查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%x&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwCr3</span><span class="p">);</span> <span class="c1">// 注意是%x
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	
</span></span><span class="line"><span class="cl">	<span class="n">TSS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// Previous Task Link CPU填充，表示上一个任务的选择子
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// ESP0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// SS0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// ESP1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// SS1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// ESP2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// SS2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">dwCr3</span><span class="p">;</span> <span class="c1">// CR3 学到页就知道是啥了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">R0Func</span><span class="p">;</span> <span class="c1">// EIP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EFLAGS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EAX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// ECX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EDX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EBX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x900</span><span class="p">;</span> <span class="c1">// ESP，解释：esp是一个0x1000的字节数组，作为裸函数的栈，这里传进去的应该是高地址，压栈才不会越界
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EBP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// ESI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EDI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000023</span><span class="p">;</span> <span class="c1">// ES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000008</span><span class="p">;</span> <span class="c1">// CS 0x0000001B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000010</span><span class="p">;</span> <span class="c1">// SS 0x00000023
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000023</span><span class="p">;</span> <span class="c1">// DS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000030</span><span class="p">;</span> <span class="c1">// FS 0x0000003B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// GS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// LDT Segment Selector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20ac0000</span><span class="p">;</span> <span class="c1">// I/O Map Base Address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>	
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">call</span> <span class="n">fword</span> <span class="n">ptr</span><span class="p">[</span><span class="n">buff</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ok: %d</span><span class="se">\n</span><span class="s">ESP: %x</span><span class="se">\n</span><span class="s">CS: %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">dwOk</span><span class="p">,</span> <span class="n">dwESP</span><span class="p">,</span> <span class="n">dwCS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h2 id="0x18任务门" class="heading-element"><span>0x18.任务门</span>
  <a href="#0x18%e4%bb%bb%e5%8a%a1%e9%97%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>本节通过任务门访问任务段。</p>
<p>注意，任务门描述符在IDT表中，但其中的TSS选择子在GDT表中，其实画个图就全知道了</p>
<p>任务门描述符(Reserved为保留位，填0即可)：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917215214051.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917215214051.png" height="486" width="1013"></p>
<p>任务门执行过程：</p>
<ol>
<li><code>INT N</code>（即查IDT索引）</li>
<li>查IDT表，找到任务门描述符</li>
<li>通过任务门描述符，查GDT表，找到TSS段描述符</li>
<li>使用TSS段中的值修改TR寄存器</li>
<li><code>IRETD</code>返回</li>
</ol>
<h3 id="练习" class="heading-element"><span>练习</span>
  <a href="#%e7%bb%83%e4%b9%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>需要构造任务门描述符和TSS描述符：</p>
<pre tabindex="0"><code>eq 8003f500 0000e500`00480000	//任务门描述符
eq 8003f048 xx00e9xx`xxxx0068	//TSS描述符,xxxx是TSS malloc（(104)的地址</code></pre><p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917221940639.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220917221940639.png" height="670" width="1529"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="o">*</span><span class="n">TSS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">dwOk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 任务切换后的EIP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="nf">R0Func</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">dwOk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">iretd</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>	
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">dwCr3</span><span class="p">;</span> <span class="c1">// windbg获取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span> <span class="n">esp</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span> <span class="c1">// 任务切换后的栈，数组名就是ESP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	
</span></span><span class="line"><span class="cl">	<span class="c1">// 此数组的地址就是TSS描述符中的Base
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)</span><span class="nf">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="n">MEM_COMMIT</span><span class="p">,</span><span class="n">PAGE_READWRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">TSS</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;VirtualAlloc 失败，%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">GetLastError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">		<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// GDT：TSS描述符
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;请在windbg执行: eq 8003f048 %02x00e9%02x`%04x0068</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">TSS</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">,((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">TSS</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">,</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span><span class="n">TSS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// IDT：任务门描述符
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;请在windbg执行: eq 8003f500 0000e500`00480000</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;请在windbg中执行!process 0 0，复制TSS.exe进程DirBase的值，并输入.</span><span class="se">\n</span><span class="s">CR3: &#34;</span><span class="p">);</span> <span class="c1">// 在windbg中执行 !process 0 0 获取，DirBase: 13600420  这个数要启动程序后现查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%x&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwCr3</span><span class="p">);</span> <span class="c1">// 注意是%x
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	
</span></span><span class="line"><span class="cl">	<span class="n">TSS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// Previous Task Link CPU填充，表示上一个任务的选择子
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// ESP0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// SS0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// ESP1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// SS1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// ESP2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// SS2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">dwCr3</span><span class="p">;</span> <span class="c1">// CR3 学到页就知道是啥了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">R0Func</span><span class="p">;</span> <span class="c1">// EIP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EFLAGS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EAX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// ECX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EDX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EBX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x500</span><span class="p">;</span> <span class="c1">// ESP，解释：esp是一个0x1000的字节数组，作为裸函数的栈，这里传进去的应该是高地址，压栈才不会越界
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EBP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// ESI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// EDI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000023</span><span class="p">;</span> <span class="c1">// ES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000008</span><span class="p">;</span> <span class="c1">// CS 0x0000001B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000010</span><span class="p">;</span> <span class="c1">// SS 0x00000023
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000023</span><span class="p">;</span> <span class="c1">// DS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000030</span><span class="p">;</span> <span class="c1">// FS 0x0000003B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// GS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// LDT Segment Selector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">TSS</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20ac0000</span><span class="p">;</span> <span class="c1">// I/O Map Base Address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>	
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//call fword ptr[buff]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">//jmp fword ptr[buff]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kt">int</span> <span class="mh">0x20</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ok: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">dwOk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h2 id="0x1910-10-12分页" class="heading-element"><span>0x19.10-10-12分页</span>
  <a href="#0x1910-10-12%e5%88%86%e9%a1%b5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>首先说下，有效地址 ，线性地址，物理地址：</p>
<p><code>MOV eax,dword ptr ds:[0x12345678]</code></p>
<ul>
<li>其中,0x12345678 是有效地址</li>
<li><code>ds.Base + 0x12345678</code> 是线性地址</li>
<li>物理地址就不用说了，要找的就是这个</li>
</ul>
<p>x86中分页的方式有两种：</p>
<ul>
<li><code>10-10-12</code></li>
<li><code>2-9-9-12</code></li>
</ul>
<p>修改boot.ini，之后重启：</p>
<pre tabindex="0"><code>multi(0)disk(0)rdisk(0)partition(1)\WINDOWS=&#34;Microsoft Windows XP Professional&#34; /execute=optin /fastdetect /debug /debugport=com1 /baudrate=115200</code></pre><p>这时就是10-10-12分页了。</p>
<p>打开个记事本，写点东西，之后CE打开，注意选择unicode：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918144624863.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918144624863.png" height="431" width="651"></p>
<p>再随便修改下，找到线性地址：<code>000AB468</code></p>
<pre tabindex="0"><code>000A B468
0000 0000 0000 1010 1011 0100 0110 1000
0000 0000 00//0
00 1010 1011//AB，这里后面查的时候需要*4=2AC
0100 0110 1000//468</code></pre><p>每个进程都有一个<code>CR3</code>(这里存的是物理地址)，准确的说是都一个CR3的值，CR3本身是个寄存器，一个核，只有一套寄存器。</p>
<p>CR3指向一个物理页，一共4096字节</p>
<p>之后找到CR3，也就是DirBase：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918145721145.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918145721145.png" height="117" width="930"></p>
<p>查物理内存的话是<code>!dd</code></p>
<p>第一级：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918150026313.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918150026313.png" height="210" width="596"></p>
<p>每四字节最后的是属性，用的时候填0即可。</p>
<p>第二级：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918150143370.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918150143370.png" height="220" width="576"></p>
<p>第三级：helloworld就存在这里(物理地址)</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918150308389.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918150308389.png" height="400" width="893"></p>
<h2 id="020pde_pte" class="heading-element"><span>020.PDE_PTE</span>
  <a href="#020pde_pte" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>注意区别：<code>PDT，PTT，PDE，PTE</code></p>
<p>PTE可以不指向物理页，多个PTE也可以指向同一个物理页</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918151003514.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918151003514.png" height="542" width="646"></p>
<p>正常编程中，不能读写NULL，原因是NULL指针没有对应的物理页，因此，只要我们让NULL指针最终映射到一块可读写的物理页，就可以用NULL去读写数据了。</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918152409888.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918152409888.png" height="486" width="1202"></p>
<p>x的物理地址查找：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918152641394.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918152641394.png" height="617" width="817"></p>
<p>一个进程只有一个CR3，分解NULL后：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918152850045.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918152850045.png" height="403" width="561"></p>
<p>用!ed指令改写成x的PTE：0f746867
<img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918153023964.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918153023964.png" height="238" width="599"></p>
<p>成功在NULL地址写入：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918153103508.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918153103508.png" height="492" width="1199"></p>
<h2 id="021pde_pte属性p_rw" class="heading-element"><span>021.PDE_PTE属性(P_RW)</span>
  <a href="#021pde_pte%e5%b1%9e%e6%80%a7p_rw" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><strong><code>物理页的属性 = PDE属性 &amp; PTE属性</code></strong></p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918153555496.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918153555496.png" height="248" width="927"></p>
<h3 id="修改常量" class="heading-element"><span>修改常量</span>
  <a href="#%e4%bf%ae%e6%94%b9%e5%b8%b8%e9%87%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include&lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="s">&#34;Hello World&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;线性地址：0x%08x, 4*0x%x 4*0x%x 0x%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">&gt;&gt;</span><span class="mi">22</span><span class="p">,(</span><span class="n">addr</span><span class="o">&gt;&gt;</span><span class="mi">12</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x000002FF</span><span class="p">,</span><span class="n">addr</span><span class="o">&amp;</span><span class="mh">0x00000FFF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span> <span class="c1">// 修改 PDE PTE 的 RW 位为1，使物理页可读可写
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;Q&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;修改后：%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>修改PTE的RW=1即可：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918214341108.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918214341108.png" height="395" width="684"></p>
<p>成功修改：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918214451606.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918214451606.png" height="673" width="971"></p>
<h2 id="022pde_pte属性us_ps_a_d-" class="heading-element"><span>022.PDE_PTE属性(US_PS_A_D )</span>
  <a href="#022pde_pte%e5%b1%9e%e6%80%a7us_ps_a_d-" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="us位" class="heading-element"><span>U/S位</span>
  <a href="#us%e4%bd%8d" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>U/S=0：特权用户可以访问</li>
<li>U/S=1：普通用户可以访问</li>
</ul>
<h3 id="读高2g内存地址" class="heading-element"><span>读高2G内存地址：</span>
  <a href="#%e8%af%bb%e9%ab%982g%e5%86%85%e5%ad%98%e5%9c%b0%e5%9d%80" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include&lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include&lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">PWORD</span> <span class="n">p</span><span class="o">=</span><span class="p">(</span><span class="n">PWORD</span><span class="p">)</span><span class="mi">0</span><span class="n">X8003f00C</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;高2G地址：%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>查找并修改PDE和PTE：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918220530341.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918220530341.png" height="405" width="494"></p>
<p>成功读取：</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918220442272.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220918220442272.png" height="501" width="1091"></p>
<h3 id="ps位" class="heading-element"><span>P/S位</span>
  <a href="#ps%e4%bd%8d" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>只对PDE有意义，<code>PS = PageSize</code>的意思，当PS=1的时候，PDE直接指向物理页，无PTE，低22位是页内偏移。</p>
<p>线性地址只能拆成2段：大小为4MB   俗称“大页”</p>
<h3 id="a位" class="heading-element"><span>A位</span>
  <a href="#a%e4%bd%8d" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>是否被访问（读或者写）过 ，访问过置1 ，即使只访问一个字节也会导致PDE PTE置1</p>
<h3 id="d位" class="heading-element"><span>D位</span>
  <a href="#d%e4%bd%8d" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>脏位，是否被写过，0没有被写过，1被写过</p>
<h2 id="023页目录表基址" class="heading-element"><span>023.页目录表基址</span>
  <a href="#023%e9%a1%b5%e7%9b%ae%e5%bd%95%e8%a1%a8%e5%9f%ba%e5%9d%80" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="页目录表pdt" class="heading-element"><span>页目录表PDT</span>
  <a href="#%e9%a1%b5%e7%9b%ae%e5%bd%95%e8%a1%a8pdt" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><code>0xC0300000</code> 指向<code>PDT</code>
<code>0xC0000000</code> 指向第一张页表<code>PTT</code>
页目录表其实是一张特殊的页表，它是第0x300张页表。
页目录表中每项PTE都指向一张页表，其中第0x300项指向了页目录表自己。</p>
<h3 id="页表ptt" class="heading-element"><span>页表PTT</span>
  <a href="#%e9%a1%b5%e8%a1%a8ptt" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>页表总共有1024张，每张4KB，总共占了1024*4KB=4MB内存，1024张页表的线性地址是连续的，但物理地址不连续。
页表被映射到了从0xC0000000到0xC03FFFFF的4MB地址空间。
在这1024个页表中，第0x300个是一张特殊的表：页目录表。</p>
<h2 id="024页表基址" class="heading-element"><span>024.页表基址</span>
  <a href="#024%e9%a1%b5%e8%a1%a8%e5%9f%ba%e5%9d%80" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>XP 10-10-12分页下PDT、PTT、物理页关系图</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220919215916582.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220919215916582.png" height="791" width="944"></p>
<p>这意味着我们可以通过 <code>0xC0000000</code> 找到任何一个 PTE。公式如下（PDI 是页目录表的下标，PTI是页表的下标）：</p>
<p><strong><code>PDE = 0xC0300000 + PDI * 4</code></strong>
<strong><code>PTE = 0xC0000000 + PDI * 4KB + PTI * 4</code></strong></p>
<h2 id="0252-9-9-12分页" class="heading-element"><span>025.2-9-9-12分页</span>
  <a href="#0252-9-9-12%e5%88%86%e9%a1%b5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>10-10-12分页还是2-9-9-12分页都是从后面分的。</p>
<p>2-9-9-12分页,又称为PAE（物理地址扩展）分页</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220920000300402.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220920000300402.png" height="497" width="856"></p>
<h3 id="查看物理地址" class="heading-element"><span>查看物理地址</span>
  <a href="#%e6%9f%a5%e7%9c%8b%e7%89%a9%e7%90%86%e5%9c%b0%e5%9d%80" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">a</span><span class="o">=</span><span class="mh">0x12345678</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;address:%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p><code>!vtop</code>指令可以查看各表：</p>
<pre tabindex="0"><code>kd&gt; !vtop 02880320 0012ff7c
X86VtoP: Virt 000000000012ff7c, pagedir 0000000002880320
X86VtoP: PAE PDPE 0000000002880320 - 000000000dd5d801
X86VtoP: PAE PDE 000000000dd5d000 - 000000000dcc0867
X86VtoP: PAE PTE 000000000dcc0978 - 800000000e145867
X86VtoP: PAE Mapped phys 000000000e145f7c
Virtual address 12ff7c translates to physical address e145f7c.
kd&gt; !dd 000000000e145f7c
## e145f7c 12345678 0012ffc0 00401569 00000001
## e145f8c 00380ff0 00381078 00241fe4 0012f7bc
## e145f9c 7ffdc000 00000001 00000006 0012ff94
## e145fac 806224ce 0012ffe0 00406b50 0040e238
## e145fbc 00000000 0012fff0 7c817077 00241fe4
## e145fcc 0012f7bc 7ffdc000 8054c6ed 0012ffc8
## e145fdc 81ccb348 ffffffff 7c839ad8 7c817080
## e145fec 00000000 00000000 00000000 00401480</code></pre><h2 id="0262-9-9-12分页" class="heading-element"><span>026.2-9-9-12分页</span>
  <a href="#0262-9-9-12%e5%88%86%e9%a1%b5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="pdpte" class="heading-element"><span>PDPTE</span>
  <a href="#pdpte" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>一共有四个</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220920000407513.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220920000407513.png" height="195" width="767"></p>
<h3 id="pde" class="heading-element"><span>PDE</span>
  <a href="#pde" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>1、当PS=1时是大页，35-21位是大页的物理地址，这样36位的物理地址的低21位为0，这就意味着页的大小为2MB，且都是2MB对齐。2、当PS=0时，35-12位是页表基址,低12位补0，共36位。</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220920000444805.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220920000444805.png" height="372" width="571"></p>
<h3 id="pte" class="heading-element"><span>PTE</span>
  <a href="#pte" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220920000540021.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220920000540021.png" height="197" width="679"></p>
<p>改成2-9-9-12分页：</p>
<pre tabindex="0"><code>[boot loader]
timeout=30
default=multi(0)disk(0)rdisk(0)partition(1)\WINDOWS
[operating systems]
multi(0)disk(0)rdisk(0)partition(1)\WINDOWS=&#34;Microsoft Windows XP Professional&#34; /noexecute=optin /fastdetect
multi(0)disk(0)rdisk(0)partition(1)\WINDOWS=&#34;Microsoft Windows XP Professional&#34; /noexecute=optin /fastdetect /debug /debugport=com1 /baudrate=115200</code></pre><p><code>!vtop</code>指令可以查看各表：</p>
<pre tabindex="0"><code>kd&gt; !vtop 028802a0 0
X86VtoP: Virt 0000000000000000, pagedir 00000000028802a0
X86VtoP: PAE PDPE 00000000028802a0 - 000000000c47a801
X86VtoP: PAE PDE 000000000c47a000 - 000000001ba0a867
X86VtoP: PAE PTE 000000001ba0a000 - 0000000000000000
X86VtoP: PAE zero PTE
Virtual address 0 translation fails, error 0xD0000147.</code></pre><h3 id="给0线性地址挂上物理页" class="heading-element"><span>给0线性地址挂上物理页</span>
  <a href="#%e7%bb%990%e7%ba%bf%e6%80%a7%e5%9c%b0%e5%9d%80%e6%8c%82%e4%b8%8a%e7%89%a9%e7%90%86%e9%a1%b5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;可用的物理页基址：%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;请在windbg中给NULL挂物理页.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span> <span class="c1">// windbg...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 读写NULL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mh">0x20201008</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;*NULL = %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>线性地址：<code>0x0012EF80</code></p>
<pre tabindex="0"><code>kd&gt; !vtop 028801e0  0012ef80
X86VtoP: Virt 000000000012ef80, pagedir 00000000028801e0
X86VtoP: PAE PDPE 00000000028801e0 - 000000000da11801
X86VtoP: PAE PDE 000000000da11000 - 0000000013b23867
X86VtoP: PAE PTE 0000000013b23970 - 800000001c0e8867
X86VtoP: PAE Mapped phys 000000001c0e8f80
Virtual address 12ef80 translates to physical address 1c0e8f80.</code></pre><p>不能直接<code>!eq</code>，需要<code>!ed</code>：</p>
<pre tabindex="0"><code>kd&gt; !vtop 028801e0  0012ef80
X86VtoP: Virt 000000000012ef80, pagedir 00000000028801e0
X86VtoP: PAE PDPE 00000000028801e0 - 000000000da11801
X86VtoP: PAE PDE 000000000da11000 - 0000000013b23867
X86VtoP: PAE PTE 0000000013b23970 - 800000001c0e8867
X86VtoP: PAE Mapped phys 000000001c0e8f80
Virtual address 12ef80 translates to physical address 1c0e8f80.
kd&gt; !ed 13b23000 1c0e8867
kd&gt; !ed 13b23004 80000000
kd&gt; g</code></pre><p>挂载成功</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220924211956538.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220924211956538.png" height="425" width="1062"></p>
<h3 id="公式" class="heading-element"><span>公式</span>
  <a href="#%e5%85%ac%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mi">2</span><span class="o">-</span><span class="mi">9</span><span class="o">-</span><span class="mi">9</span><span class="o">-</span><span class="mi">12</span>					
</span></span><span class="line"><span class="cl"><span class="n">PDPTI</span><span class="o">-</span><span class="n">PDI</span><span class="o">-</span><span class="n">PTI</span><span class="o">-</span><span class="n">OFFSET</span>					
</span></span><span class="line"><span class="cl">					
</span></span><span class="line"><span class="cl"><span class="err">公式：</span>					
</span></span><span class="line"><span class="cl"><span class="n">pPDE</span> <span class="o">=</span> <span class="mh">0xc0600000</span> <span class="o">+</span> <span class="p">(</span><span class="n">PDPTI</span><span class="o">*</span><span class="mi">4</span><span class="n">KB</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">PDI</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>					
</span></span><span class="line"><span class="cl"><span class="n">pPTE</span> <span class="o">=</span> <span class="mh">0xc0000000</span> <span class="o">+</span> <span class="p">(</span><span class="n">PDPTI</span><span class="o">*</span><span class="mi">2</span><span class="n">MB</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">PDI</span><span class="o">*</span><span class="mi">4</span><span class="n">KB</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">PTI</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span></span></span></code></pre></div><h2 id="027tlb" class="heading-element"><span>027.TLB</span>
  <a href="#027tlb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>TLB（Translation Lookaside Buffer）</p>
<p>当程序访问一个线性地址，需要先查PDPT，然后查PDT，然后查页表PTT，最后才是访问物理页。这期间多次访问内存，效率非常低。于是TLB就被设计出来了。</p>
<p>TLB 是CPU内部的表，一个CPU有一张TLB表，用来缓存线性地址和物理地址的映射关系，以及属性和访问次数。</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220925121337378.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220925121337378.png" height="107" width="744"></p>
<p>说明：</p>
<ol>
<li>
<p>ATTR（属性）：属性是PDPE PDE PTE三个属性AND起来的. 如果是10-10-12 就是PDE and PTE</p>
</li>
<li>
<p>不同的CPU 这个表的大小不一样.</p>
</li>
<li>
<p>只要Cr3变了，TLB立马刷新，一核一套TLB.</p>
</li>
</ol>
<p>操作系统的高2G映射基本不变，如果Cr3改了，TLB刷新 重建高2G以上很浪费。所以PDE和PTE中有个G标志位，如果G位为1刷新TLB时将不会刷新 PDE/PTE的G位为1的页，当TLB满了，根据统计信息将不常用的地址废弃，最近最常用的保留.</p>
<h3 id="证明tlb存在" class="heading-element"><span>证明TLB存在</span>
  <a href="#%e8%af%81%e6%98%8etlb%e5%ad%98%e5%9c%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>在R0给NULL挂一个物理页，并写入数据，然后修改NULL的物理页，然后读NULL，发现读取了之前写入的值，这证明第二次访问NULL的时候是从TLB中取的物理地址，证明了TLB的存在。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include&lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">TempVal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="nf">R0Function</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushfd</span>		
</span></span><span class="line"><span class="cl">		<span class="c1">// 1.给NULL挂物理页（修改PTE，这里概率蓝屏）0x01234867(G=0) 0x01234967(G=1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="mh">0xc0000000</span><span class="p">],</span><span class="mh">0x01234867</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 2.写NULL指针，生成TLB记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="mi">0</span><span class="p">],</span><span class="mh">0x12345678</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 3.再次修改物理页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="mh">0xc0000000</span><span class="p">],</span><span class="mh">0x02345867</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 4.读NULL，发现读了之前赋的值，证明了TLB的存在
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">TempVal</span><span class="p">,</span><span class="n">eax</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">popfd</span>
</span></span><span class="line"><span class="cl">		<span class="n">popad</span>		
</span></span><span class="line"><span class="cl">		<span class="n">iretd</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;在IDT表构建中断门，请在windbg中执行下面的指令：</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;eq 8003f500 %04xee00`0008%04x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">R0Function</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">,(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">R0Function</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span> <span class="kt">int</span> <span class="mh">0x20</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">TempVal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220925123759825.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220925123759825.png" height="567" width="1145"></p>
<h2 id="028控制寄存器" class="heading-element"><span>028.控制寄存器</span>
  <a href="#028%e6%8e%a7%e5%88%b6%e5%af%84%e5%ad%98%e5%99%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>控制寄存器用于控制和确定CPU的操作模式。有：<code>Cr0</code>，<code>Cr1</code>，<code>Cr2</code>，<code>Cr3</code>，<code>Cr4</code>，其中<code>Cr1</code> 保留<code>Cr3</code> 页目录表基址</p>
<h3 id="cr0" class="heading-element"><span>Cr0</span>
  <a href="#cr0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220925121843125.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220925121843125.png" height="113" width="788"></p>
<p>说明：</p>
<ol>
<li>PE：CR0的位0是启用保护（Protection Enable）标志。
<ul>
<li>PE=1保护模式</li>
<li>PE=0 实地址模式 这个标志仅开启段级保护，而并没有启用分页机制。</li>
<li>若要启用分页机制，那么PE和PG标志都要置位。</li>
</ul>
</li>
<li>PG：当设置该位时即开启了分页机制。在开启这个标志之前必须已经或者同时开启PE标志。</li>
</ol>
<blockquote>
<p>PG=0且PE=0  处理器工作在实地址模式下
PG=0且PE=1  处理器工作在没有开启分页机制的保护模式下
PG=1且PE=0  在PE没有开启的情况下  无法开启PG
PG=1且PE=1  处理器工作在开启了分页机制的保护模式下</p></blockquote>
<h3 id="cr2" class="heading-element"><span>Cr2</span>
  <a href="#cr2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220925122123519.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220925122123519.png" height="104" width="775"></p>
<p>当CPU访问某个无效页面时，会产生缺页异常，此时，CPU会将引起异常的线性地址存放在CR2中。</p>
<h3 id="cr4" class="heading-element"><span>Cr4</span>
  <a href="#cr4" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220925122137925.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220925122137925.png" height="130" width="840"></p>
<p>PAE=1 是2-9-9-12分页  PAE=0 是10-10-12分页。</p>
<p><img loading="lazy" src='/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220925122155565.png' alt="/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220925122155565.png" height="298" width="810"></p>
<p>Windows保护模式就此告一段落，下来是驱动的内容&hellip;</p>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2022-09-26 00:00:00">Updated on 2022-09-26&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on X" data-sharer="twitter" data-url="https://nesl42.github.io/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/" data-title="Windows内核(一)——保护模式" data-hashtags="Win32"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://nesl42.github.io/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/" data-hashtag="Win32"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://nesl42.github.io/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/" data-title="Windows内核(一)——保护模式"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/win32/" class="post-tag" title="Tags - Win32">Win32</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/2022-hw/" class="post-nav-item" rel="prev" title="HW日记"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>HW日记</a><a href="/posts/2022-9-%E8%BF%99%E4%B8%A4%E5%B9%B4%E6%88%91%E5%AD%A6%E5%88%B0%E4%BA%86%E4%BB%80%E4%B9%88/" class="post-nav-item" rel="next" title="这两年我学到了什么">这两年我学到了什么<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.145.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.17-8212d6fd"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"version":"v0.3.17-8212d6fd"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
