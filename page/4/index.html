<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
	<meta name="generator" content="Hugo 0.149.0">
    
      <meta name="theme" content='FixIt v0.3.17-8212d6fd'>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>敬渊&#39;s Blog</title><meta name="author" content="">
<meta name="description" content="">
  <meta itemprop="name" content="敬渊&#39;s Blog">
  <meta itemprop="datePublished" content="2025-09-02T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-09-02T00:00:00+00:00"><meta property="og:url" content="https://nesl42.github.io/">
  <meta property="og:site_name" content="敬渊&#39;s Blog">
  <meta property="og:title" content="敬渊&#39;s Blog">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="website">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="敬渊&#39;s Blog">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="https://nesl42.github.io/" title="敬渊&#39;s Blog" /><link rel="alternate" type="application/rss+xml" href="https://nesl42.github.io/index.xml" title="敬渊's Blog"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "WebSite",
    "url": "https:\/\/nesl42.github.io\/","inLanguage": "zh-CN","name": "敬渊's Blog"
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/">文章</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/">标签</a></li><li class="menu-item">
              <a class="menu-link" href="/about/">关于</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/">分类</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="/posts/">文章</a></li><li class="menu-item"><a class="menu-link" href="/tags/">标签</a></li><li class="menu-item"><a class="menu-link" href="/about/">关于</a></li><li class="menu-item"><a class="menu-link" href="/categories/">分类</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><div class="page home posts"><article class="single summary" itemscope itemtype="http://schema.org/Article"><h2 class="single-title" itemprop="name headline"><a href="/posts/202509-uniswap17/">16.Uniswap V3 Cross Tick Swap</a>
  </h2><div class="post-meta"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span>&nbsp;<span class="post-publish" title='2025-09-02 00:00:00'>published on <time datetime="2025-09-02">2025-09-02</time></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="content"><h4 id="核心摘要-key-takeaways" class="heading-element"><span><strong>核心摘要 (Key Takeaways)</strong></span>
  <a href="#%e6%a0%b8%e5%bf%83%e6%91%98%e8%a6%81-key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>跨Tick交易的核心机制</strong>：当一笔交易的规模大到足以耗尽当前价格区间（Tick Range）内的流动性时，交易会“穿越”到一个新的、相邻的活跃价格区间，并利用新区间的流动性继续完成剩余部分的兑换。</li>
<li><strong>迭代循环过程</strong>：跨Tick交易并非一次性计算，而是一个循环过程。系统在当前区间内完成部分交易，计算剩余未兑换量，然后寻找下一个活跃Tick，更新流动性，再对剩余量进行计算，如此往复，直至交易完成或流动性耗尽。</li>
<li><strong>两大基础工具</strong>：整个跨Tick交易的实现依赖于两个核心数据结构：<strong>Tick Bitmap</strong> 用于快速查找下一个有流动性的活跃Tick；<strong>Liquidity Net</strong> 用于在穿越Tick边界时，高效地计算出新价格区间的总流动性。</li>
<li><strong>V3与V2的复杂度对比</strong>：Uniswap V3由于引入了集中流动性，其<code>swap</code>（交易）的数学逻辑和代码实现复杂度远超V2。V2的交易遵循简单的 $x \times y = k$ 恒定乘积公式，而V3则需要处理离散的、分段的流动性，进行复杂的迭代计算。</li>
</ul>
<h4 id="1-交易机制回顾与铺垫" class="heading-element"><span><strong>1. 交易机制回顾与铺垫</strong></span>
  <a href="#1-%e4%ba%a4%e6%98%93%e6%9c%ba%e5%88%b6%e5%9b%9e%e9%a1%be%e4%b8%8e%e9%93%ba%e5%9e%ab" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><h5 id="11-基础概念回顾" class="heading-element"><span>1.1 基础概念回顾</span>
  <a href="#11-%e5%9f%ba%e7%a1%80%e6%a6%82%e5%bf%b5%e5%9b%9e%e9%a1%be" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><ul>
<li><strong>横坐标 (价格/Tick)</strong>：智能合约使用 <strong>Tick Bitmap</strong> 来记录哪些价格点（Ticks）是活跃的（即作为某个流动性区间的边界）。</li>
<li><strong>纵坐标 (流动性)</strong>：使用 <strong>Liquidity Net</strong> 记录在每个Tick点上流动性的净变化量。当价格穿越一个Tick时，总流动性会根据该Tick的<code>liquidityNet</code>值进行更新。</li>
<li><strong>流动性叠加</strong>：在某个价格区间，多个用户提供的流动性会叠加起来，形成一个总的、更高的流动性池。</li>
</ul>
<h5 id="12-单一价格区间内的交易-未跨tick" class="heading-element"><span>1.2 单一价格区间内的交易 (未跨Tick)</span>
  <a href="#12-%e5%8d%95%e4%b8%80%e4%bb%b7%e6%a0%bc%e5%8c%ba%e9%97%b4%e5%86%85%e7%9a%84%e4%ba%a4%e6%98%93-%e6%9c%aa%e8%b7%a8tick" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><p>这是跨Tick交易的基础。在一个固定的价格区间 <code>[PA, PB]</code> 内，流动性 <code>L</code> 是恒定的。</p></div><div class="post-footer">
    <a href="/posts/202509-uniswap17/">Read More</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/web3/' class="post-tag">Web3</a></div></div>
</article><article class="single summary" itemscope itemtype="http://schema.org/Article"><h2 class="single-title" itemprop="name headline"><a href="/posts/202509-uniswap16/">16.Uniswap V3 LiquidityNet</a>
  </h2><div class="post-meta"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span>&nbsp;<span class="post-publish" title='2025-09-02 00:00:00'>published on <time datetime="2025-09-02">2025-09-02</time></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="content"><h4 id="核心摘要-key-takeaways" class="heading-element"><span><strong>核心摘要 (Key Takeaways)</strong></span>
  <a href="#%e6%a0%b8%e5%bf%83%e6%91%98%e8%a6%81-key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>智能合约的效率限制</strong>：Uniswap v3 智能合约因存储和计算成本的限制，不会记录每个价格区间的具体流动性值。它采用一种更高效的动态计算方法，只在流动性发生变化的 <code>tick</code> 边界点记录关键信息。</li>
<li><strong>核心概念 <code>Liquidity Net</code></strong>：合约追踪流动性的核心是记录在每个被初始化的 <code>tick</code> 上的 <strong><code>Liquidity Net</code> (流动性净变化量)</strong>。这是一个<strong>有符号</strong>的值 (<code>ΔL</code>)，表示当价格穿越该 <code>tick</code> 时，池中活跃流动性的<strong>变化量</strong>。</li>
<li><strong>边界点的符号规则</strong>：当用户在 <code>[tick_lower, tick_upper]</code> 区间添加流动性 <code>L</code> 时，合约会在 <code>tick_lower</code> 处记录一个正的净变化量 (<code>+L</code>)，在 <code>tick_upper</code> 处记录一个负的净变化量 (<code>-L</code>)。移除流动性则符号相反。</li>
<li><strong>流动性的动态计算</strong>：在交易（swap）过程中，当价格从一个区间穿越 <code>tick</code> 进入下一个区间时，合约通过一个简单的累加公式实时更新当前的活跃流动性：$L_{新区间} = L_{旧区间} + \Delta L_{tick}$。这使得合约只需追踪当前区间的流动性，而无需预存所有区间的流动性信息。</li>
</ul>
<h4 id="1-背景问题uniswap-v3-如何高效追踪流动性" class="heading-element"><span><strong>1. 背景问题：Uniswap v3 如何高效追踪流动性？</strong></span>
  <a href="#1-%e8%83%8c%e6%99%af%e9%97%ae%e9%a2%98uniswap-v3-%e5%a6%82%e4%bd%95%e9%ab%98%e6%95%88%e8%bf%bd%e8%b8%aa%e6%b5%81%e5%8a%a8%e6%80%a7" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>在 Uniswap v3 中，流动性提供者可以在任意自定义的价格区间（由 <code>tick</code> 界定）内提供流动性。这导致了池子的总流动性在不同价格段是阶梯式变化的。</p></div><div class="post-footer">
    <a href="/posts/202509-uniswap16/">Read More</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/web3/' class="post-tag">Web3</a></div></div>
</article><article class="single summary" itemscope itemtype="http://schema.org/Article"><h2 class="single-title" itemprop="name headline"><a href="/posts/202509-uniswap18/">18.Uniswap V3 手续费计算（一）</a>
  </h2><div class="post-meta"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span>&nbsp;<span class="post-publish" title='2025-09-02 00:00:00'>published on <time datetime="2025-09-02">2025-09-02</time></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="content"><h4 id="核心摘要-key-takeaways" class="heading-element"><span><strong>核心摘要 (Key Takeaways)</strong></span>
  <a href="#%e6%a0%b8%e5%bf%83%e6%91%98%e8%a6%81-key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>V3手续费的复杂性根源</strong>：与V2的全范围流动性不同，Uniswap V3的<strong>集中流动性</strong>允许LP在自定义价格区间（<code>ticks</code>）提供流动性，这使得手续费的计算和分配变得极其复杂。</li>
<li><strong>全局手续费累加器 <code>feeGrowthGlobal</code></strong>：Uniswap V3引入了一个全局状态变量 <code>feeGrowthGlobal</code>，它代表<strong>每单位流动性</strong>可以获得的总手续费。这个值会随着每笔交易单调递增。</li>
<li><strong>手续费按<code>token in</code>收取</strong>：手续费只对交易中“进入”池子的代币收取。因此，系统需要为交易对中的两种代币（<code>token0</code> 和 <code>token1</code>）分别维护两个独立的<code>feeGrowthGlobal</code>变量，导致其增长呈现阶梯状。</li>
<li><strong>LP的核心关注点 <code>feeGrowthInside</code></strong>：LP只关心在其提供的流动性区间内产生的手су费。因此，需要从全局<code>feeGrowthGlobal</code>中剥离掉区间外的部分，得到<code>feeGrowthInside</code>。</li>
<li><strong>精巧的边界记录机制 <code>feeGrowthOutside</code></strong>：V3通过在每个<code>tick</code>边界上记录一个名为<code>feeGrowthOutside</code>的值，来巧妙地计算任意区间的<code>feeGrowthInside</code>。当价格穿越一个<code>tick</code>时，该<code>tick</code>的<code>feeGrowthOutside</code>值会被更新，从而精确追踪内外手续费的累积情况。</li>
</ul>
<h4 id="1-uniswap-v2-vs-v3-手续费机制对比" class="heading-element"><span><strong>1. Uniswap V2 vs. V3 手续费机制对比</strong></span>
  <a href="#1-uniswap-v2-vs-v3-%e6%89%8b%e7%bb%ad%e8%b4%b9%e6%9c%ba%e5%88%b6%e5%af%b9%e6%af%94" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><h5 id="11-uniswap-v2简单直接" class="heading-element"><span><strong>1.1 Uniswap V2：简单直接</strong></span>
  <a href="#11-uniswap-v2%e7%ae%80%e5%8d%95%e7%9b%b4%e6%8e%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><ul>
<li><strong>流动性模型</strong>：流动性平均分布在从 <code>0</code> 到 <code>+∞</code> 的整个价格曲线上。</li>
<li><strong>手续费收取</strong>：
<ul>
<li>对每笔交易收取固定的千分之三（0.3%）手续费。</li>
<li>手续费只对 <strong><code>token in</code></strong> （交易中流入池子的代币）收取。</li>
<li><strong>案例</strong>：
<ul>
<li>用 X 换 Y：收取 <code>0.003 * X</code>，实际用于交易的是 <code>0.997 * X</code>。</li>
<li>用 Y 换 X：收取 <code>0.003 * Y</code>，实际用于交易的是 <code>0.997 * Y</code>。</li>
</ul>
</li>
</ul>
</li>
<li><strong>手续费分配</strong>：收取的手续费会自动累积到流动性池中，为LP实现<strong>自动复投</strong>增值，无需任何额外操作。</li>
</ul>
<h5 id="12-uniswap-v3挑战重重" class="heading-element"><span><strong>1.2 Uniswap V3：挑战重重</strong></span>
  <a href="#12-uniswap-v3%e6%8c%91%e6%88%98%e9%87%8d%e9%87%8d" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><ul>
<li><strong>核心挑战</strong>：<strong>集中流动性 (Concentrated Liquidity)</strong>。
<ul>
<li>不同的LP可以在<strong>不同的价格区间</strong>（由<code>tick lower</code>和<code>tick upper</code>定义，视频中也称为<code>PA</code>和<code>PB</code>）提供流动性。</li>
<li><strong>手续费档位</strong>：V3提供了多个手续费档位供流动性池选择，如 <code>0.01%</code>, <code>0.05%</code>, <code>0.3%</code>, <code>1%</code>。</li>
</ul>
</li>
<li><strong>需要解决的问题</strong>：
<ol>
<li><strong>按比例分配</strong>：在同一个<code>tick</code>区间内，手续费需按LP提供的流动性比例进行分配。</li>
<li><strong>跨<code>tick</code>计算</strong>：当交易价格跨越<code>tick</code>边界，导致总流动性发生变化时，如何精确计算每个LP在其活跃区间内应得的手续费。</li>
</ol>
</li>
</ul>
<h4 id="2-手续费分配的基本原理与" class="heading-element"><span><strong>2. 手续费分配的基本原理与 <code>feeGrowth</code> 的引入</strong></span>
  <a href="#2-%e6%89%8b%e7%bb%ad%e8%b4%b9%e5%88%86%e9%85%8d%e7%9a%84%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86%e4%b8%8e" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><h5 id="21-单次交易的分配逻辑" class="heading-element"><span><strong>2.1 单次交易的分配逻辑</strong></span>
  <a href="#21-%e5%8d%95%e6%ac%a1%e4%ba%a4%e6%98%93%e7%9a%84%e5%88%86%e9%85%8d%e9%80%bb%e8%be%91" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><ul>
<li><strong>核心思想</strong>：LP在某个价格区间获得的手续费，等于该区间产生的<strong>总手续费</strong>乘以该LP提供的<strong>流动性占比</strong>。</li>
<li><strong>案例：单次跨<code>tick</code>交易</strong>
<ul>
<li><strong>背景</strong>：
<ul>
<li>一个LP在某个范围内提供了流动性，大小为 <code>S</code>。</li>
<li>一笔交易发生，使得价格从<code>tick_0</code>移动到<code>tick_1</code>。</li>
<li>在$tick_0$区间的总流动性为$L_0$，产生的总手续费为$F_0$。</li>
<li>在<code>tick_1</code>区间的总流动性为$L_1$，产生的总手续费为$F_1$。</li>
</ul>
</li>
<li><strong>计算LP应得手续费</strong>：该LP获得的手续费 $Fee_S$ 是其在每个<code>tick</code>区间所获手续费的总和。
$$
Fee_S = \left(F_0 \cdot \frac{S}{L_0}\right) + \left(F_1 \cdot \frac{S}{L_1}\right)
$$</li>
</ul>
</li>
</ul>
<h5 id="22" class="heading-element"><span><strong>2.2 <code>feeGrowthGlobal</code>：全局手续费累加器</strong></span>
  <a href="#22" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><ul>
<li><strong>概念推导</strong>：将上述逻辑扩展到 <code>N</code> 次交易，LP的总手续费可以表示为：
$$
Fee_S = S \cdot \sum_{i=0}^{N} \frac{F_i}{L_i}
$$</li>
<li><strong>定义</strong>：Uniswap V3将公式中求和的部分 $\sum_{i=0}^{N} \frac{F_i}{L_i}$ 定义为一个全局变量，称为 <strong><code>feeGrowthGlobal</code></strong> (视频中简称为<code>FG</code>)。
<ul>
<li><strong>物理含义</strong>：<code>feeGrowthGlobal</code> 代表从系统部署开始，<strong>每单位流动性 (<code>S=1</code>)</strong> 累计可以获得的总手续费。</li>
<li><strong>简化公式</strong>：LP的总手续费 $Fee_S = S \cdot feeGrowthGlobal$。</li>
</ul>
</li>
<li><strong>核心特性</strong>：
<ol>
<li><strong>全局状态</strong>：<code>feeGrowthGlobal</code> 是一个存储在合约中的全局变量，随每次交易更新。</li>
<li><strong>单调递增</strong>：只要有交易发生，<code>feeGrowthGlobal</code> 的值就会不断累积，永远不会减少。</li>
<li><strong>按代币分离</strong>：由于手续费只对 <strong><code>token in</code></strong> 收取，因此合约为交易对中的两个代币分别维护了两个<code>feeGrowthGlobal</code>变量：
<ul>
<li><code>**feeGrowthGlobal0**</code> (针对 <code>token0</code>)</li>
<li><code>**feeGrowthGlobal1**</code> (针对 <code>token1</code>)</li>
</ul>
</li>
<li><strong>阶梯式增长</strong>：
<ul>
<li>当价格上涨时（例如，用<code>token0</code>换<code>token1</code>），<code>feeGrowthGlobal0</code>会增加，而<code>feeGrowthGlobal1</code>保持不变（呈水平线）。</li>
<li>当价格下跌时（例如，用<code>token1</code>换<code>token0</code>），<code>feeGrowthGlobal1</code>会增加，而<code>feeGrowthGlobal0</code>保持不变。</li>
<li>这导致每个<code>feeGrowthGlobal</code>变量的增长曲线都呈现出<strong>阶梯状</strong>。</li>
</ul>
</li>
</ol>
</li>
</ul>
<h4 id="3-从全局到局部计算" class="heading-element"><span><strong>3. 从全局到局部：计算 <code>feeGrowthInside</code></strong></span>
  <a href="#3-%e4%bb%8e%e5%85%a8%e5%b1%80%e5%88%b0%e5%b1%80%e9%83%a8%e8%ae%a1%e7%ae%97" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>LP的视角</strong>：一个在特定价格区间 $[i_l, i_u]$ (<code>tick lower</code>, <code>tick upper</code>) 提供流动性的LP，只关心在这个区间内（<code>inside</code>）累积的手续费，区间外（<code>outside</code>）的与他无关。</li>
<li><strong>核心概念</strong>：
<ul>
<li><strong>feeGrowthInside</strong>：在LP指定的 $[i_l, i_u]$ 区间内累积的每单位流动性手续费。</li>
<li><strong>feeGrowthOutside</strong>：在该区间之外累积的手续费。</li>
</ul>
</li>
<li><strong>计算逻辑</strong>：<code>feeGrowthInside</code> 等于全局的 <code>feeGrowthGlobal</code> 减去所有在区间之外累积的部分。
<ul>
<li><strong>白皮书与视频中的公式</strong> (变量名来自视频讲解)：
$$
F_{R(i_l, i_u)} = F_g - F_{B(i_l)} - F_{A(i_u)}
$$</li>
<li><strong>公式解读</strong>：
<ul>
<li>$F_{R(i_l, i_u)}$：我们想求的 <strong><code>feeGrowthInside</code></strong> (Range Fee)。</li>
<li>$F_g$：当前的全局 <strong><code>feeGrowthGlobal</code></strong>。</li>
<li>$F_{B(i_l)}$：所有<strong>低于</strong>下边界 $i_l$ 的手续费累积 (<code>Fee Below</code>)。</li>
<li>$F_{A(i_u)}$：所有<strong>高于</strong>上边界 $i_u$ 的手续费累积 (<code>Fee Above</code>)。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="4" class="heading-element"><span><strong>4. <code>feeGrowthOutside</code>：精巧的边界状态记录机制</strong></span>
  <a href="#4" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>为了高效计算任意区间的$F_{B(i_l)}$和$F_{A(i_u)}$，V3合约并不直接记录它们，而是采用了一个更巧妙的机制：在<strong>每个被激活的<code>tick</code>上</strong>记录一个状态变量 <code>**feeGrowthOutside**</code> (视频中简称为$F_{O(i)}$)。</p></div><div class="post-footer">
    <a href="/posts/202509-uniswap18/">Read More</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/web3/' class="post-tag">Web3</a></div></div>
</article><article class="single summary" itemscope itemtype="http://schema.org/Article"><h2 class="single-title" itemprop="name headline"><a href="/posts/202509-uniswap19/">19.Uniswap V3 手续费计算（二）</a>
  </h2><div class="post-meta"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span>&nbsp;<span class="post-publish" title='2025-09-02 00:00:00'>published on <time datetime="2025-09-02">2025-09-02</time></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="content"><h4 id="uniswap-v3-手续费计算深度解析-二" class="heading-element"><span><strong>Uniswap V3 手续费计算深度解析 (二)</strong></span>
  <a href="#uniswap-v3-%e6%89%8b%e7%bb%ad%e8%b4%b9%e8%ae%a1%e7%ae%97%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90-%e4%ba%8c" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><h5 id="核心摘要-key-takeaways" class="heading-element"><span><strong>核心摘要 (Key Takeaways)</strong></span>
  <a href="#%e6%a0%b8%e5%bf%83%e6%91%98%e8%a6%81-key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><ul>
<li><strong>核心公式</strong>: 为特定价格区间 $(i_l, i_u)$ 计算手续费的核心思想是：用全局累计手续费 $f_g$ 减去该区间下方的累计手续费 $f_b$ 和上方的累计手续费 $f_a$。公式为：$f_r(i_l, i_u) = f_g - f_b(i_l) - f_a(i_u)$。</li>
<li><strong>关键变量 $f_{o,i}$</strong>: Uniswap V3 引入了一个名为 <strong><code>feeOutside</code></strong> (笔记中记为 $f_{o,i}$) 的关键变量。每个 tick <code>i</code> 都会记录这个值，它巧妙地追踪了当价格在 tick <code>i</code> 的“外部”时所累积的单位流动性手续费。</li>
<li><strong>$f_{o,i}$ 的更新机制</strong>: 当价格穿越一个 tick <code>i</code> 时，该 tick 对应的 $f_{o,i}$ 会进行一次“翻转”更新。更新规则为：$f_{o,i}^{\text{new}} = f_g^{\text{current}} - f_{o,i}^{\text{old}}$。这个机制是整个计算逻辑的精髓。</li>
<li><strong>推导关系</strong>: 通过 $f_{o,i}$ 和当前全局手续费 $f_g$，可以精确推导出任意时刻的 $f_b$ 和 $f_a$。它们的值取决于当前价格 $i_c$ 相对于目标 tick <code>i</code> 的位置。</li>
</ul>
<hr>
<h4 id="1-背景v3-手续费计算的复杂性" class="heading-element"><span><strong>1. 背景：V3 手续费计算的复杂性</strong></span>
  <a href="#1-%e8%83%8c%e6%99%afv3-%e6%89%8b%e7%bb%ad%e8%b4%b9%e8%ae%a1%e7%ae%97%e7%9a%84%e5%a4%8d%e6%9d%82%e6%80%a7" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li>
<p><strong>根本原因</strong>: <strong>集中流动性 (Concentrated Liquidity)</strong>。与 V2 不同，V3 的流动性提供者 (LP) 将资金集中在特定的价格区间内。</p></div><div class="post-footer">
    <a href="/posts/202509-uniswap19/">Read More</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/web3/' class="post-tag">Web3</a></div></div>
</article><article class="single summary" itemscope itemtype="http://schema.org/Article"><h2 class="single-title" itemprop="name headline"><a href="/posts/202509-uniswap20/">20.Uniswap V4 简介</a>
  </h2><div class="post-meta"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span>&nbsp;<span class="post-publish" title='2025-09-02 00:00:00'>published on <time datetime="2025-09-02">2025-09-02</time></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="content"><h4 id="uniswap-v4-简介" class="heading-element"><span>Uniswap V4 简介</span>
  <a href="#uniswap-v4-%e7%ae%80%e4%bb%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><h5 id="核心摘要-key-takeaways" class="heading-element"><span><strong>核心摘要 (Key Takeaways)</strong></span>
  <a href="#%e6%a0%b8%e5%bf%83%e6%91%98%e8%a6%81-key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><ul>
<li><strong>架构性革新</strong>: Uniswap V4 的核心升级在于<strong>代码架构</strong>而非底层的 AMM 数学原理。它从 V2/V3 的“工厂模式”转变为“单例模式”，旨在大幅降低 Gas 费并提升效率。</li>
<li><strong>高度可定制化 (Hooks)</strong>: V4 引入了**“钩子 (Hooks)”**机制，允许开发者在交易生命周期的关键节点（如交易前/后、添加流动性前/后）插入自定义逻辑，极大地增强了协议的灵活性和可扩展性。</li>
<li><strong>显著降低 Gas 费</strong>: 通过<strong>单例模式</strong>、<strong>闪电记账 (Flash Accounting)</strong> 和支持<strong>原生 ETH</strong> 交易，V4 从多个维度解决了 V3 及之前版本中 Gas 费用高昂的问题，尤其是在多路径交易和涉及 ETH 的交易中。</li>
<li><strong>战略定位转变</strong>: V4 的发布标志着 Uniswap 从一个单纯的去中心化交易所 (DEX) 向一个<strong>DeFi 基础设施平台</strong>的战略转型，旨在搭建一个舞台，让更多开发者在其之上构建多样化的应用。</li>
</ul>
<hr>
<h4 id="一-uniswap-v4-发展历程" class="heading-element"><span><strong>一、 Uniswap V4 发展历程</strong></span>
  <a href="#%e4%b8%80-uniswap-v4-%e5%8f%91%e5%b1%95%e5%8e%86%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>发布形式</strong>: 以一种创新的 <strong>“社区共建”</strong> 模式发布。
<ul>
<li><strong>2023年6月13日</strong>: Uniswap 官方发布了 V4 的<strong>代码草案 (Code Draft)</strong>，当时代码完成度约 60-70%。</li>
<li><strong>社区参与</strong>: 官方并未像传统项目那样先完成内部开发和审计，而是提前将代码开源，并设立了 <strong>1550 万美元</strong>的悬赏基金，鼓励全球社区共同寻找 Bug 和安全漏洞。</li>
</ul>
</li>
<li><strong>正式上线</strong>:
<ul>
<li>经过约一年半的社区共建和测试，Uniswap V4 于<strong>2024年1月</strong>正式发布到生产环境。</li>
</ul>
</li>
</ul>
<h4 id="二-uniswap-版本演进与-v3-的痛点" class="heading-element"><span><strong>二、 Uniswap 版本演进与 V3 的痛点</strong></span>
  <a href="#%e4%ba%8c-uniswap-%e7%89%88%e6%9c%ac%e6%bc%94%e8%bf%9b%e4%b8%8e-v3-%e7%9a%84%e7%97%9b%e7%82%b9" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>每个新版本的发布都是为了解决前一版本的问题。</p></div><div class="post-footer">
    <a href="/posts/202509-uniswap20/">Read More</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/web3/' class="post-tag">Web3</a></div></div>
</article><article class="single summary" itemscope itemtype="http://schema.org/Article"><h2 class="single-title" itemprop="name headline"><a href="/posts/202509-uniswap01/">01.Uniswap 简介</a>
  </h2><div class="post-meta"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span>&nbsp;<span class="post-publish" title='2025-09-01 00:00:00'>published on <time datetime="2025-09-01">2025-09-01</time></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="content"><h3 id="uniswap-简介" class="heading-element"><span>Uniswap 简介</span>
  <a href="#uniswap-%e7%ae%80%e4%bb%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="核心摘要-key-takeaways" class="heading-element"><span>核心摘要 (Key Takeaways)</span>
  <a href="#%e6%a0%b8%e5%bf%83%e6%91%98%e8%a6%81-key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>Uniswap 作为 DeFi 核心基础设施：</strong> 掌握 Uniswap V2, V3, V4 能帮助深度理解 DeFi 领域，超越行业内90-95%的人。其团队以创新力著称，而非营销。</li>
<li><strong>恒定乘积做市商模型 (AMM) 的起源：</strong> Vitalik Buterin 在2017年提出无订单簿交易方案，核心是 $X \cdot Y = K$ 公式，由 Hayden Adams 实现并部署了 Uniswap V1。</li>
<li><strong>Uniswap V2 引爆 DeFi 赛道：</strong> 2020年5月发布，引入 ERC20-ERC20 直换、闪电贷、预言机等，直接推动 DeFi 总锁仓量 (TVL) 从平稳期飙升至千亿规模。</li>
<li><strong>创新与竞争：</strong> Uniswap V2 因其宽松的开源协议被 SushiSwap 抄袭并挖走大量流动性，促使 Uniswap 发行 UNI 代币并空投反击。此事件凸显了创新与营销在加密货币领域的博弈。</li>
<li><strong>V3 与 V4 的技术飞跃：</strong> V3 引入<strong>集中流动性</strong>和 <strong>LP NFT</strong>，显著提升资本效率并改进开源协议（2年商用保护期）。V4 引入 <strong>Hooks (钩子)</strong> 和 <strong>Singleton 架构</strong>，旨在成为更快、更省 Gas、更易集成的 DeFi 基础设施。</li>
</ul>
<h4 id="1-uniswap-简介与重要性" class="heading-element"><span>1. Uniswap 简介与重要性</span>
  <a href="#1-uniswap-%e7%ae%80%e4%bb%8b%e4%b8%8e%e9%87%8d%e8%a6%81%e6%80%a7" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li>本系列将以 Uniswap 为主线，深入讲解其 V2、V3、V4 版本。</li>
<li><strong>深度理解 DeFi：</strong> 大部分人对于Uniswap仅停留在 <code>X * Y = K</code> 的肤浅认知。</li>
<li><strong>创新驱动：</strong> Uniswap 团队是业界极具创新力的团队，与多数仅靠营销的项目不同。它为行业带来了巨大的变革和创新。</li>
<li><strong>DeFi 基础设施：</strong> 如果只了解一个区块链项目，那必须是 Uniswap。</li>
</ul>
<h4 id="2-uniswap-v1恒定乘积做市商的诞生" class="heading-element"><span>2. Uniswap V1：恒定乘积做市商的诞生</span>
  <a href="#2-uniswap-v1%e6%81%92%e5%ae%9a%e4%b9%98%e7%a7%af%e5%81%9a%e5%b8%82%e5%95%86%e7%9a%84%e8%af%9e%e7%94%9f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>诞生时间：</strong> 2017年6月22日，Vitalik Buterin 发表文章。</li>
<li><strong>Vitalik 的文章：</strong>
<ul>
<li><strong>标题：</strong> &ldquo;On Path Independence&rdquo;</li>
<li><strong>核心思想：</strong> 提出无需订单簿模式也能完成代币互换 (swap) 的方案。</li>
<li><strong>数学机制：</strong> 基于 <strong>恒定乘积做市商 (Constant Product Market Maker, CPMM)</strong> 模型，即：
$$
X \cdot Y = K
$$
其中，$X$ 和 $Y$ 分别代表两种代币的储备量，$K$ 是一个常数。价格波动通过曲线上代币余额的变化来体现。</li>
</ul>
</li>
<li><strong>Hayden Adams 的实现：</strong>
<ul>
<li><strong>背景故事：</strong> 曾是西门子机械工程师，被解雇后在好友 Karl 的建议下开始学习以太坊和智能合约开发。Hayden 在《A Short History of Uniswap》中记录了这段经历。</li>
<li><strong>对话案例：</strong>
<ul>
<li>Hayden: &ldquo;我刚被开除了&hellip;&rdquo;</li>
<li>Karl: &ldquo;恭喜你！这是你身上发生的最好的事情了！以太坊是未来，你的新使命就是写智能合约。&rdquo;</li>
<li>Hayden: &ldquo;我也不知道怎么写代码啊&hellip;&rdquo;</li>
<li>Karl: &ldquo;没事，写代码很简单，而且那个时候（2017年）也没人知道怎么写智能合约，学学就好了。&rdquo;</li>
</ul>
</li>
<li><strong>开发历程：</strong> 学习 Solidity 和 JavaScript 两个月后开始编写代码，并与团队伙伴共同尝试实现 Vitalik 的公式。</li>
</ul>
</li>
<li><strong>部署与初期影响：</strong>
<ul>
<li><strong>部署时间：</strong> 2018年11月2日，在 <strong>伊斯坦布尔会议</strong> 期间正式部署到以太坊主网。</li>
<li><strong>市场环境：</strong> 处于熊市 (比特币价格约 $3000-$4000，此前高峰 $20000)，因此 V1 发布后并未引起广泛关注。</li>
<li><strong>开发语言：</strong> 使用 <strong>Viper</strong> 语言编写 (类似 Python)，由 Vitalik 建议。</li>
</ul>
</li>
<li><strong>V1 的局限性：</strong>
<ul>
<li><strong>仅支持 ERC20-ETH 互换：</strong> 所有流动性池都必须是 ERC20 代币与 ETH 的配对。</li>
<li><strong>案例：</strong> 若要将 DAI 兑换为 USDC，必须先将 DAI 兑换为 ETH，再将 ETH 兑换为 USDC，需要两次交易。</li>
</ul>
</li>
<li><strong>合约结构：</strong>
<ul>
<li><code>UniswapExchange</code>：负责代币互换逻辑，代码逻辑简单，约 <strong>490行</strong>。</li>
<li><code>UniswapFactory</code>：负责创建新的交易对。</li>
<li><strong>特点：</strong> 合约代码简洁，被视为“历史遗迹”。</li>
</ul>
</li>
<li><strong>名字由来：</strong>
<ul>
<li><strong>最初内部名称：</strong> UniPeg (铆钉)。</li>
<li><strong>Vitalik 建议：</strong> UniSwap。</li>
<li><strong>Logo：</strong> 独角兽 (Unicorn)。</li>
</ul>
</li>
</ul>
<h4 id="3-uniswap-v2引爆-defi-赛道" class="heading-element"><span>3. Uniswap V2：引爆 DeFi 赛道</span>
  <a href="#3-uniswap-v2%e5%bc%95%e7%88%86-defi-%e8%b5%9b%e9%81%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>发布时间：</strong> 2020年5月。</li>
<li><strong>核心特性：</strong>
<ul>
<li><strong>ERC20-ERC20 直接互换：</strong> 允许任意两种 ERC20 代币直接组成流动性池 (例如 DAI-USDC 池)，无需通过 ETH 中转。</li>
<li><strong>闪电贷 (Flash Swaps)：</strong> 允许用户在同一笔交易中借入资产、使用、并归还，无需抵押品。</li>
<li><strong>价格预言机 (Price Oracles)：</strong> 提供链上价格数据，供其他 DeFi 协议使用。</li>
<li><strong>改进手续费设计。</strong></li>
</ul>
</li>
<li><strong>对 DeFi 行业的影响 (引爆 DeFi)：</strong>
<ul>
<li><strong>数据案例：</strong> 2020年5月 V2 发布后，DeFi 领域的 <strong>总锁仓量 (TVL)</strong> 从平稳状态迅速飙升，并在2021年达到约2000亿美元的峰值。V2 的发布是这一增长的起点。</li>
<li><strong>个人经历案例：</strong> 2020年7月，老师的朋友主动联系讨论 Fork Uniswap，显示了 V2 巨大的市场热度。</li>
</ul>
</li>
</ul>
<h5 id="31-uniswap-与-sushiswap-的竞争uni-代币的诞生" class="heading-element"><span>3.1 Uniswap 与 SushiSwap 的竞争：UNI 代币的诞生</span>
  <a href="#31-uniswap-%e4%b8%8e-sushiswap-%e7%9a%84%e7%ab%9e%e4%ba%89uni-%e4%bb%a3%e5%b8%81%e7%9a%84%e8%af%9e%e7%94%9f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><ul>
<li><strong>背景：</strong> Uniswap V2 采用宽松的开源协议，允许任何人商用其代码。</li>
<li><strong>SushiSwap (2020年8月发布)：</strong>
<ul>
<li><strong>策略：</strong> Fork Uniswap V2 代码，并在此基础上增加了对 <strong>流动性提供者 (LP) 的奖励</strong> (即<strong>流动性挖矿</strong>)。</li>
<li><strong>影响：</strong> 通过 SUSHI 代币的激励，SushiSwap 从 Uniswap 挖走了数十亿美元的流动性，对 Uniswap 造成巨大冲击。</li>
</ul>
</li>
<li><strong>Uniswap 的反击 (2020年9月)：</strong>
<ul>
<li><strong>发行 UNI 代币：</strong> 作为治理代币。</li>
<li><strong>空投：</strong> 向所有在特定时间点前使用过 Uniswap 的地址空投 <strong>400个 UNI 代币</strong>。
<ul>
<li><strong>价值案例：</strong> 以当前价格 $7/UNI 计算，空投价值 $2800。历史最高价曾达 $40/UNI。</li>
</ul>
</li>
<li><strong>意义：</strong> 这是 Uniswap 团队夺回劳动成果、反击抄袭者的一种方式。</li>
</ul>
</li>
<li><strong>Hayden Adams 的理念与团队风格：</strong>
<ul>
<li><strong>反浮躁：</strong> 批评加密货币领域过度炒作、高估值（例如：“不是所有项目一发布就必须成为独角兽”）。他认为，一个项目在百万到十亿级别（$10^7 \sim 10^9$）的市场估值已是非常了不起的成就。</li>
<li><strong>注重实际价值：</strong> 认为项目估值应基于实际成就，而非短期炒作。</li>
<li><strong>团队风格：</strong> Uniswap 团队秉持踏实、有远见的风格，不追求短期利益和泡沫，不频繁喊单，因此能够走得更远，成为行业创新的引领者。</li>
</ul>
</li>
</ul>
<h4 id="4-uniswap-v3资本效率的飞跃" class="heading-element"><span>4. Uniswap V3：资本效率的飞跃</span>
  <a href="#4-uniswap-v3%e8%b5%84%e6%9c%ac%e6%95%88%e7%8e%87%e7%9a%84%e9%a3%9e%e8%b7%83" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>发布时间：</strong> 2021年5月。</li>
<li><strong>核心特性：</strong>
<ul>
<li><strong>集中流动性 (Concentrated Liquidity)：</strong> 允许 LP 将其流动性集中在特定的价格区间内，显著提高资本效率。</li>
<li><strong>优化手续费设置：</strong> 提供多层手续费选项。</li>
<li><strong>LP Token 作为 NFT：</strong> 流动性提供者代币 (LPT) 从 ERC20 形式改为 NFT 形式，以支持集中流动性的复杂性。</li>
<li><strong>改进开源协议：</strong> 引入 <strong>2年商业使用保护期</strong>。在此期间，社区成员可学习代码，但禁止直接 Fork 并发布商用产品。</li>
<li><strong>市场影响：</strong> 2023年5月保护期结束后，许多 DEX 纷纷宣布“更新到 V3”，实则抄袭了 Uniswap V3 的代码。市场会通过自我纠错机制，最终认可创新而非简单的抄袭。</li>
</ul>
</li>
</ul>
<h4 id="5-uniswap-v4-草案基础设施愿景" class="heading-element"><span>5. Uniswap V4 (草案)：基础设施愿景</span>
  <a href="#5-uniswap-v4-%e8%8d%89%e6%a1%88%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd%e6%84%bf%e6%99%af" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>代码草案发布时间：</strong> 2023年6月23日。</li>
<li><strong>核心特性：</strong>
<ul>
<li><strong>Hooks (钩子)：</strong> 允许开发者在 Uniswap 协议的固定操作点 (如 <code>beforeSwap</code>, <code>afterSwap</code>) 插入自定义逻辑。
<ul>
<li><strong>案例：</strong> 可用于创建带有 KYC 验证的去中心化交易所 (在 Swap 前调用 Hook 检查地址的 KYC 信息)。</li>
</ul>
</li>
<li><strong>Singleton 架构：</strong> 将所有交易对部署在一个合约中，而非每个交易对一个合约，显著降低部署成本和 Gas 费用。解决了 V2/V3 中每个交易对都需要独立部署合约的问题。</li>
<li><strong>重新引入原生 ETH 支持 (Reintroduction of Native ETH)：</strong> V4 将再次支持原生 ETH，无需 WETH 中转。</li>
<li><strong>Flash Accounting。</strong></li>
</ul>
</li>
<li><strong>目标：</strong> 成为一个更快、更省 Gas、更易集成、更具可扩展性的 DeFi 领域基础设施平台。</li>
</ul>
<h4 id="6-核心概念解析eth-erc20-weth" class="heading-element"><span>6. 核心概念解析：ETH, ERC20, WETH</span>
  <a href="#6-%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5%e8%a7%a3%e6%9e%90eth-erc20-weth" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>ETH (以太坊原生代币)：</strong>
<ul>
<li><strong>定义：</strong> 以太坊区块链的原生代币，用于支付 Gas 费用。</li>
<li><strong>ERC20 兼容性：</strong> <strong>不符合</strong> ERC20 标准。</li>
<li><strong>原因：</strong> ETH 早于 ERC20 标准诞生。它没有 <code>approve</code>、<code>transferFrom</code> 等 ERC20 标准中定义的函数。</li>
<li><strong>转账方式：</strong> 在智能合约中，转账原生 ETH 通常使用 <code>address.transfer()</code> 或 <code>address.call{value: ...}()</code>。</li>
</ul>
</li>
<li><strong>ERC20 (代币标准)：</strong>
<ul>
<li><strong>定义：</strong> 以太坊上的第20个改进提案 (EIP-20) 提出的一种代币协议标准。</li>
<li><strong>功能：</strong> 规定了代币必须实现的一系列函数 (如 <code>transfer</code>, <code>transferFrom</code>, <code>approve</code>, <code>balanceOf</code>) 和事件 (如 <code>Transfer</code>, <code>Approval</code>)。</li>
<li><strong>目的：</strong> 确保不同代币之间的互操作性。</li>
</ul>
</li>
<li><strong>WETH (Wrapped ETH / 封装的 ETH)：</strong>
<ul>
<li><strong>定义：</strong> 将原生 ETH “封装”成符合 ERC20 标准的代币。</li>
<li><strong>作用：</strong> 由于 Uniswap V2 和 V3 等 DEX 主要支持 ERC20 代币之间的交易，原生 ETH 无法直接参与。<strong>WETH 使得 ETH 能够以 ERC20 的形式在这些智能合约和 DeFi 协议中使用。</strong></li>
<li><strong>历史版本支持：</strong>
<ul>
<li><strong>Uniswap V1：</strong> 支持原生 ETH。</li>
<li><strong>Uniswap V2/V3：</strong> <strong>依赖 WETH</strong> 才能与 ERC20 代币配对。</li>
<li><strong>Uniswap V4：</strong> 重新引入对原生 ETH 的支持。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="7-uniswap-v2-与-sushiswap-竞争时序图" class="heading-element"><span>7. Uniswap V2 与 SushiSwap 竞争时序图</span>
  <a href="#7-uniswap-v2-%e4%b8%8e-sushiswap-%e7%ab%9e%e4%ba%89%e6%97%b6%e5%ba%8f%e5%9b%be" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>以下 Mermaid 时序图展示了 Uniswap V2 发布后，SushiSwap 如何通过 Fork 代码和流动性挖矿与 Uniswap 竞争，以及 Uniswap 如何通过发行 UNI 代币反击的过程。</p></div><div class="post-footer">
    <a href="/posts/202509-uniswap01/">Read More</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/web3/' class="post-tag">Web3</a></div></div>
</article><ul class="pagination"><li class="page-item">
          <span class="page-link">
            <a href="/">1</a>
          </span>
        </li><li class="page-item">
          <span class="page-link">
            <a href="/page/2/">2</a>
          </span>
        </li><li class="page-item">
          <span class="page-link">
            <a href="/page/3/">3</a>
          </span>
        </li><li class="page-item active">
          <span class="page-link">
            <a href="/page/4/">4</a>
          </span>
        </li><li class="page-item">
          <span class="page-link">
            <a href="/page/5/">5</a>
          </span>
        </li><li class="page-item">
          <span class="page-link">
            <a href="/page/6/">6</a>
          </span>
        </li><li class="page-item">
          <span class="page-link" aria-hidden="true">&hellip;</span>
        </li><li class="page-item">
          <span class="page-link">
            <a href="/page/18/">18</a>
          </span>
        </li></ul></div></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.149.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.17-8212d6fd"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"version":"v0.3.17-8212d6fd"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
