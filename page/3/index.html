<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
	<meta name="generator" content="Hugo 0.149.0">
    
      <meta name="theme" content='FixIt v0.3.17-8212d6fd'>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>敬渊&#39;s Blog</title><meta name="author" content="">
<meta name="description" content="">
  <meta itemprop="name" content="敬渊&#39;s Blog">
  <meta itemprop="datePublished" content="2025-09-02T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-09-02T00:00:00+00:00"><meta property="og:url" content="https://nesl42.github.io/">
  <meta property="og:site_name" content="敬渊&#39;s Blog">
  <meta property="og:title" content="敬渊&#39;s Blog">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="website">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="敬渊&#39;s Blog">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="https://nesl42.github.io/" title="敬渊&#39;s Blog" /><link rel="alternate" type="application/rss+xml" href="https://nesl42.github.io/index.xml" title="敬渊's Blog"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "WebSite",
    "url": "https:\/\/nesl42.github.io\/","inLanguage": "zh-CN","name": "敬渊's Blog"
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/">文章</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/">标签</a></li><li class="menu-item">
              <a class="menu-link" href="/about/">关于</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/">分类</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="敬渊&#39;s Blog"><span class="header-title-text">敬渊&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="/posts/">文章</a></li><li class="menu-item"><a class="menu-link" href="/tags/">标签</a></li><li class="menu-item"><a class="menu-link" href="/about/">关于</a></li><li class="menu-item"><a class="menu-link" href="/categories/">分类</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><div class="page home posts"><article class="single summary" itemscope itemtype="http://schema.org/Article"><h2 class="single-title" itemprop="name headline"><a href="/posts/202509-uniswap10/">10.Uniswap V3 流动性计算</a>
  </h2><div class="post-meta"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span>&nbsp;<span class="post-publish" title='2025-09-02 00:00:00'>published on <time datetime="2025-09-02">2025-09-02</time></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="content"><p>好的，这是根据你的要求修改和完善后的最终学习笔记。</p>
<h4 id="核心摘要-key-takeaways" class="heading-element"><span><strong>核心摘要 (Key Takeaways)</strong></span>
  <a href="#%e6%a0%b8%e5%bf%83%e6%91%98%e8%a6%81-key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>Uniswap V3 的核心创新</strong>：通过引入<strong>价格区间</strong> $p \in [p_a, p_b]$ 和<strong>虚拟流动性</strong> ($x_{virtual}$, $y_{virtual}$) 的概念，实现了<strong>集中流动性</strong>，允许用户将资金集中在特定价格范围，从而极大地提高了资金效率。</li>
<li><strong>V3 核心公式</strong>：V3 的流动性计算公式是 V2 中 $x \cdot y = L^2$ 的演进，具体形式为 $$(x_{real} + \frac{L}{\sqrt{p_b}}) \cdot (y_{real} + L\sqrt{p_a}) = L^2$$。这个公式是理解 V3 机制的关键。</li>
<li><strong>资金效率与价格区间的关系</strong>：用户设定的价格区间 $[p_a, p_b]$ 越窄（即 $p_a$ 越大，$p_b$ 越小，两者越接近），提供的虚拟流动性就越大。这意味着可以用更少的真实资金（$x_{real}$, $y_{real}$）达到与 V2 相同的流动性深度（<code>L</code> 值），即资金效率越高。</li>
<li><strong>模拟限价订单</strong>：利用价格区间特性，用户可以通过在价格区间的某一端点（如 $p_a$）存入单一资产，当市场价格穿过整个区间到达另一端点（$p_b$）时，该资产会被完全兑换成另一种资产，从而实现类似<strong>限价订单</strong>的效果。</li>
</ul>
<hr>
<h4 id="1-uniswap-v3-核心概念回顾" class="heading-element"><span><strong>1. Uniswap V3 核心概念回顾</strong></span>
  <a href="#1-uniswap-v3-%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5%e5%9b%9e%e9%a1%be" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><h5 id="11-集中流动性与虚拟流动性" class="heading-element"><span><strong>1.1 集中流动性与虚拟流动性</strong></span>
  <a href="#11-%e9%9b%86%e4%b8%ad%e6%b5%81%e5%8a%a8%e6%80%a7%e4%b8%8e%e8%99%9a%e6%8b%9f%e6%b5%81%e5%8a%a8%e6%80%a7" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><ul>
<li><strong>Uniswap V2</strong>: 流动性平均分布在 $(0, +∞)` 的整个价格曲线上。</li>
<li><strong>Uniswap V3</strong>: 引入了<strong>价格区间</strong> $[p_a, p_b]$ 的概念，允许流动性提供者（LP）将资金集中在他们认为最可能发生交易的价格范围内。</li>
<li><strong>虚拟流动性 (Virtual Liquidity)</strong>: 为了在有限的价格区间 $[p_a, p_b]$ 内构建出一条标准的 $x \cdot y = k$ 曲线，V3 引入了虚拟的 <code>x</code> 和 <code>y</code> 资产（$x_{virtual}$ 和 $y_{virtual}$）。
<ul>
<li>这些虚拟资产<strong>仅用于数学计算</strong>，并不需要用户真实提供。</li>
<li>用户实际提供的资产被称为<strong>真实流动性 (Real Liquidity)</strong>（$x_{real}$ 和 $y_{real}$）。</li>
<li>总流动性 = 真实流动性 + 虚拟流动性。
<ul>
<li>总 X: $$x_{total} = x_{real} + x_{virtual}$$</li>
<li>总 Y: $$y_{total} = y_{real} + y_{virtual}$$</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="2-uniswap-v3-核心公式推导" class="heading-element"><span><strong>2. Uniswap V3 核心公式推导</strong></span>
  <a href="#2-uniswap-v3-%e6%a0%b8%e5%bf%83%e5%85%ac%e5%bc%8f%e6%8e%a8%e5%af%bc" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><h5 id="21-基础关系确定-x-y-l-p-的关系" class="heading-element"><span><strong>2.1 基础关系：确定 X, Y, L, P 的关系</strong></span>
  <a href="#21-%e5%9f%ba%e7%a1%80%e5%85%b3%e7%b3%bb%e7%a1%ae%e5%ae%9a-x-y-l-p-%e7%9a%84%e5%85%b3%e7%b3%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><ol>
<li>
<p><strong>基础恒定乘积公式</strong>:
$$
x \cdot y = k = L^2
$$
其中 $L$ 代表流动性 (Liquidity)。</p></div><div class="post-footer">
    <a href="/posts/202509-uniswap10/">Read More</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/web3/' class="post-tag">Web3</a></div></div>
</article><article class="single summary" itemscope itemtype="http://schema.org/Article"><h2 class="single-title" itemprop="name headline"><a href="/posts/202509-uniswap11/">11.Uniswap V3 Tick 与价格表示</a>
  </h2><div class="post-meta"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span>&nbsp;<span class="post-publish" title='2025-09-02 00:00:00'>published on <time datetime="2025-09-02">2025-09-02</time></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="content"><h3 id="核心摘要-key-takeaways" class="heading-element"><span>核心摘要 (Key Takeaways)</span>
  <a href="#%e6%a0%b8%e5%bf%83%e6%91%98%e8%a6%81-key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li><strong><code>tick</code> 引入目的与作用</strong>: Uniswap V3 引入了 <strong><code>tick</code></strong> 机制，将连续的价格范围离散化，以解决集中流动性中用户随意设置价格区间导致的高 Gas 消耗问题，从而大幅节省 Gas 费用。</li>
<li><strong>价格与 <code>tick</code> 的数学关系</strong>: Uniswap V3 中的价格 $P$ 与 <code>tick</code> 索引 $T$ 之间通过公式 $P = 1.0001^T$ 建立精确的指数关系。</li>
<li><strong>合约价格存储</strong>: Uniswap V3 合约的 <code>slot0</code> 结构中，价格信息并非直接存储为 $P$，而是以 <strong>$\sqrt{P} \times 2^{96}$</strong> 的形式（即 <code>sqrtPriceX96</code>）存储，并采用 <strong>Q64.96 定点数格式</strong>，以适应 Solidity 对浮点数处理的限制并优化 Gas 消耗。</li>
<li><strong>实际价格计算的复杂性</strong>: 从合约中读取的价格需要考虑 <strong>Token 精度差异</strong> 和 <strong><code>token0</code>/<code>token1</code> 顺序</strong>（可能导致价格倒数）进行修正，才能得到真实的市场价格。</li>
<li><strong><code>tick</code> 范围的由来</strong>: <code>tick</code> 的范围被限制在 <strong>-887272 到 +887272</strong>，这一范围是根据 <code>Q64.96</code> 定点数格式所能表示的 $\sqrt{P}$ 的上下限，通过价格与 <code>tick</code> 的数学关系推导而来，并硬编码在合约中。</li>
</ul>
<hr>
<h3 id="1-tick-的引入与作用" class="heading-element"><span>1. <code>tick</code> 的引入与作用</span>
  <a href="#1-tick-%e7%9a%84%e5%bc%95%e5%85%a5%e4%b8%8e%e4%bd%9c%e7%94%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="11-问题背景集中流动性的-gas-消耗" class="heading-element"><span>1.1 问题背景：集中流动性的 Gas 消耗</span>
  <a href="#11-%e9%97%ae%e9%a2%98%e8%83%8c%e6%99%af%e9%9b%86%e4%b8%ad%e6%b5%81%e5%8a%a8%e6%80%a7%e7%9a%84-gas-%e6%b6%88%e8%80%97" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>Uniswap V3 的核心创新</strong>: 引入了<strong>集中流动性 (Concentrated Liquidity)</strong>，允许用户在任意价格区间 $P_a$ 和 $P_b$ 内提供流动性。</li>
<li><strong>潜在问题</strong>: 如果用户可以随意设置 $P_a$ 和 $P_b$ (例如 $1795.0234$ 到 $1800.00012$)，会带来以下问题：
<ul>
<li>每个用户设置的价格范围都是独一无二且随意的。</li>
<li>维护和记录每个用户添加的 $P_a$ 和 $P_b$ 范围会消耗巨量的 <strong>Gas 费用</strong>，因为合约状态需要存储大量不规则的数据。</li>
</ul>
</li>
</ul>
<h4 id="12-解决方案引入-tick-进行离散化" class="heading-element"><span>1.2 解决方案：引入 <code>tick</code> 进行离散化</span>
  <a href="#12-%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88%e5%bc%95%e5%85%a5-tick-%e8%bf%9b%e8%a1%8c%e7%a6%bb%e6%95%a3%e5%8c%96" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><img loading="lazy" src='/posts/202509-uniswap11/tickTickTickTick.jpg' alt="An illustration of Uniswap price curve getting sliced by ticks" height="1080" width="1920"></p></div><div class="post-footer">
    <a href="/posts/202509-uniswap11/">Read More</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/web3/' class="post-tag">Web3</a></div></div>
</article><article class="single summary" itemscope itemtype="http://schema.org/Article"><h2 class="single-title" itemprop="name headline"><a href="/posts/202509-uniswap12/">12.Uniswap V3 添加流动性案例</a>
  </h2><div class="post-meta"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span>&nbsp;<span class="post-publish" title='2025-09-02 00:00:00'>published on <time datetime="2025-09-02">2025-09-02</time></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="content"><h4 id="核心摘要-key-takeaways" class="heading-element"><span><strong>核心摘要 (Key Takeaways)</strong></span>
  <a href="#%e6%a0%b8%e5%bf%83%e6%91%98%e8%a6%81-key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>Uniswap V3 的核心是集中流动性</strong>：与 V2 的无限价格范围不同，V3 允许流动性提供者（LP）将资金集中在特定的价格区间 <code>[Pa, Pb]</code> 内，其底层数学模型可以看作是对 V2 的 <code>x * y = k</code> 模型进行了平移和截断。</li>
<li><strong>价格变动消耗特定 Token</strong>：在设定的价格区间内，当价格从当前价 <code>P</code> 下降至 <code>Pa</code> 时，池子会消耗 <code>Y</code> Token；当价格从 <code>P</code> 上升至 <code>Pb</code> 时，池子会消耗 <code>X</code> Token。理解这一点是计算所需流动性的关键。</li>
<li><strong>流动性计算基于虚拟曲线</strong>：尽管 V3 的真实曲线是分段的，但其流动性数量 $\Delta X$ 和 $\Delta Y$ 的计算可以基于 V2 的 $x \cdot y = L^2$ 和 $P = y/x$ 这两个基础公式，应用在一条“虚拟”的、经过平移的曲线上进行推导。</li>
<li><strong>工程实现中的核心逻辑</strong>：在实际添加流动性时，智能合约会根据用户提供的两种 Token ($\Delta X$ 和 $\Delta Y$) 分别计算出两个可能的流动性值 <code>L</code>，并最终选择<strong>较小</strong>的那个作为最终的流动性。这可能导致实际使用的某一种 Token 数量略少于用户最初提供的数量。</li>
</ul>
<hr>
<h4 id="一-uniswap-v3-核心公式与概念回顾" class="heading-element"><span><strong>一、 Uniswap V3 核心公式与概念回顾</strong></span>
  <a href="#%e4%b8%80-uniswap-v3-%e6%a0%b8%e5%bf%83%e5%85%ac%e5%bc%8f%e4%b8%8e%e6%a6%82%e5%bf%b5%e5%9b%9e%e9%a1%be" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><h5 id="1-v3-流动性公式与曲线" class="heading-element"><span><strong>1. V3 流动性公式与曲线</strong></span>
  <a href="#1-v3-%e6%b5%81%e5%8a%a8%e6%80%a7%e5%85%ac%e5%bc%8f%e4%b8%8e%e6%9b%b2%e7%ba%bf" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><p>Uniswap V3 引入了<strong>集中流动性</strong>的概念，允许将流动性提供在指定的价格区间 <code>[Pa, Pb]</code>。其公式可以理解为对 V2 公式的平移。</p></div><div class="post-footer">
    <a href="/posts/202509-uniswap12/">Read More</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/web3/' class="post-tag">Web3</a></div></div>
</article><article class="single summary" itemscope itemtype="http://schema.org/Article"><h2 class="single-title" itemprop="name headline"><a href="/posts/202509-uniswap13/">13.Uniswap V3 单价格区间内 Swap 机制</a>
  </h2><div class="post-meta"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span>&nbsp;<span class="post-publish" title='2025-09-02 00:00:00'>published on <time datetime="2025-09-02">2025-09-02</time></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="content"><h4 id="uniswap-v3单价格区间内-swap-机制与数学实现" class="heading-element"><span><strong>Uniswap V3：单价格区间内 Swap 机制与数学实现</strong></span>
  <a href="#uniswap-v3%e5%8d%95%e4%bb%b7%e6%a0%bc%e5%8c%ba%e9%97%b4%e5%86%85-swap-%e6%9c%ba%e5%88%b6%e4%b8%8e%e6%95%b0%e5%ad%a6%e5%ae%9e%e7%8e%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><h5 id="核心摘要-key-takeaways" class="heading-element"><span><strong>核心摘要 (Key Takeaways)</strong></span>
  <a href="#%e6%a0%b8%e5%bf%83%e6%91%98%e8%a6%81-key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><ul>
<li><strong>两步核心算法</strong>：在 Uniswap V3 的单个价格区间内执行 <strong>swap</strong> 的核心逻辑分为两步：首先，根据输入的代币数量和当前流动性，计算出交易完成后的<strong>新价格</strong>；然后，利用新旧两个价格点和流动性，计算出可以兑换出的输出代币数量。</li>
<li><strong>基石数学关系</strong>：所有计算都基于 <strong>流动性 (L)</strong>、<strong>代币 X 数量</strong>、<strong>代币 Y 数量</strong> 和 <strong>价格 (P)</strong> 之间的恒定关系。具体来说，$X = L / \sqrt{P}$ 和 $Y = L \cdot \sqrt{P}$ 是推导所有 <code>swap</code> 公式的基石。</li>
<li><strong>价格方向决定公式形态</strong>：无论是用 Y 买 X（价格上升）还是用 X 卖 Y（价格下降），其底层的数学原理是统一的。公式的具体形态（谁减谁）取决于价格的高低（$P_{upper}$ vs $P_{lower}$），最终可以抽象为统一的表达式。</li>
</ul>
<hr>
<h4 id="1-基础回顾价格tick-与流动性" class="heading-element"><span><strong>1. 基础回顾：价格、Tick 与流动性</strong></span>
  <a href="#1-%e5%9f%ba%e7%a1%80%e5%9b%9e%e9%a1%be%e4%bb%b7%e6%a0%bctick-%e4%b8%8e%e6%b5%81%e5%8a%a8%e6%80%a7" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>在深入 <code>swap</code> 逻辑之前，我们首先要回顾 Uniswap V3 的基本概念。协议通过 <strong>Tick</strong> 来离散化价格，并将 Tick 转换为实际计算中使用的 $\sqrt{P}$ (square root price)。在一个给定的价格点 <code>P</code>，流动性 <code>L</code> 与两种代币（X 和 Y）的数量关系如下：</p></div><div class="post-footer">
    <a href="/posts/202509-uniswap13/">Read More</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/web3/' class="post-tag">Web3</a></div></div>
</article><article class="single summary" itemscope itemtype="http://schema.org/Article"><h2 class="single-title" itemprop="name headline"><a href="/posts/202509-uniswap14/">14.Uniswap V3 Tick Bitmap</a>
  </h2><div class="post-meta"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span>&nbsp;<span class="post-publish" title='2025-09-02 00:00:00'>published on <time datetime="2025-09-02">2025-09-02</time></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="content"><h4 id="核心摘要-key-takeaways" class="heading-element"><span><strong>核心摘要 (Key Takeaways)</strong></span>
  <a href="#%e6%a0%b8%e5%bf%83%e6%91%98%e8%a6%81-key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>Tick BitMap 的核心目的</strong>: 为了高效、低成本地跟踪 Uniswap V3 池中哪些价格点（Ticks）被用作了流动性区间的边界，从而知道哪些价格范围是活跃的。</li>
<li><strong>精巧的数据压缩</strong>: <code>Tick BitMap</code> 抛弃了为每个 Tick 单独存储状态的朴素方案（成本过高），而是通过位运算将 256 个连续的 Tick 状态压缩存储在一个 <code>uint256</code> 变量中，极大地节省了 Gas 费和存储空间。</li>
<li><strong>关键转换公式</strong>: 任何一个 <code>tick</code> (类型为 <code>int24</code>) 都可以通过数学运算定位到它在 BitMap 中的具体位置。其核心是两个坐标：<code>wordPosition</code> (确定在哪一个 <code>uint256</code> 组里) 和 <code>bitPosition</code> (确定在该组的第几位)。
<ul>
<li><code>wordPosition = tick / 256</code></li>
<li><code>bitPosition = tick % 256</code></li>
</ul>
</li>
<li><strong>数据结构</strong>: <code>Tick BitMap</code> 在合约中实现为一个 <code>mapping(int16 =&gt; uint256)</code>。其中 <code>key (int16)</code> 是 <code>wordPosition</code>，<code>value (uint256)</code> 是一个 256 位的位图，每一位代表一个 <code>tick</code> 的活跃状态（1 表示活跃，0 表示不活跃）。</li>
<li><strong>状态更新机制</strong>: 添加或移除流动性时，通过生成一个特定的<strong>掩码 (Mask)</strong>，并与 BitMap 中对应的 <code>uint256</code> 值进行<strong>按位或 (OR)</strong> 或<strong>按位与 (AND)</strong> 运算，来精确地将某一位从 0 改为 1 或从 1 改为 0，而不影响其他位。</li>
</ul>
<hr>
<h4 id="1-tick-的回顾与作用" class="heading-element"><span><strong>1. Tick 的回顾与作用</strong></span>
  <a href="#1-tick-%e7%9a%84%e5%9b%9e%e9%a1%be%e4%b8%8e%e4%bd%9c%e7%94%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>定义</strong>: <strong>Tick</strong> (也称 <strong>Tick Index</strong>) 是 Uniswap V3 中用来标记离散化价格点的单位。</li>
<li><strong>价格公式</strong>: 价格 <code>P</code> 与 <code>tick</code> <code>T</code> 的关系通过以下公式定义：
$$
P = 1.0001^T
$$
其中 <code>T</code> 就是 <code>tick</code> 的索引。当 <code>T</code> 增大时，价格 <code>P</code> 上升；当 <code>T</code> 减小时，价格 <code>P</code> 下降。</li>
<li><strong>Tick 范围</strong>:
<ul>
<li>合约中 <code>tick</code> 的类型为 <code>int24</code>，其理论范围是从 <code>-887272</code> 到 <code>+887272</code>。</li>
<li><strong>案例</strong>: 这个范围足以表示极其宽广的价格区间。
<ul>
<li>当 <code>tick</code> 为 <code>-887272</code> 时，价格约为 $2.938 \times 10^{-39}$。</li>
<li>当 <code>tick</code> 为 <code>+887272</code> 时，价格约为 $3.4 \times 10^{38}$。</li>
<li>这个范围远超比特币等主流资产的价格波动范围，因此在设计上是足够用的。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="2-核心问题如何跟踪活跃的流动性区间" class="heading-element"><span><strong>2. 核心问题：如何跟踪活跃的流动性区间？</strong></span>
  <a href="#2-%e6%a0%b8%e5%bf%83%e9%97%ae%e9%a2%98%e5%a6%82%e4%bd%95%e8%b7%9f%e8%b8%aa%e6%b4%bb%e8%b7%83%e7%9a%84%e6%b5%81%e5%8a%a8%e6%80%a7%e5%8c%ba%e9%97%b4" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>背景</strong>: 在 Uniswap V3 中，用户在自定义的价格区间 <code>[PA, PB]</code> (对应 <code>[Tick_A, Tick_B]</code>) 内添加流动性。</li>
<li><strong>挑战</strong>: 一个活跃的交易对（如 BTC/USDT）可能有成千上万的用户在各种不同的、甚至重叠的价格区间添加流动性。合约需要一种高效的方式来跟踪哪些 <code>tick</code> 成为了这些流动性区间的边界（即被激活）。
<ul>
<li><strong>案例</strong>: 假设一个用户在 <code>tick</code> 范围 <code>[-10, -5]</code> 添加了流动性，而另一个用户在 <code>[-4, 1]</code> 添加了流动性。此外，还可能存在重叠区间，例如用户 A 在 <code>[6, 10]</code> 添加流动性，用户 B 在 <code>[7, 12]</code> 添加流动性，那么在 <code>[7, 10]</code> 区间内流动性是重叠的。合约必须有效管理这一切。</li>
</ul>
</li>
<li><strong>从 ERC20 到 ERC721</strong>:
<ul>
<li><strong>V2</strong>: 所有流动性提供者的 LP 凭证是同质化的 <strong>ERC20</strong> 代币。</li>
<li><strong>V3</strong>: 由于每个人的流动性价格区间和数量都可能不同，LP 凭证变成了非同质化的 <strong>ERC721</strong> 代币（NFT）。</li>
<li><strong>案例</strong>: 一个 V3 LP NFT (通过 <code>NonfungiblePositionManager</code> 合约管理) 记录了如 <code>tickLower</code>、<code>tickUpper</code> 和 <code>liquidity (uint128)</code> 等唯一信息，代表一个独一无二的流动性仓位。</li>
</ul>
</li>
<li><strong>根本问题</strong>: 尽管 NFT 记录了每个仓位的具体信息，但 <code>Pool</code> 合约本身如何宏观地、低成本地知道在任意一个 <code>tick</code> 上，是否有流动性边界存在？</li>
</ul>
<h4 id="3-一种被否决的朴素方案" class="heading-element"><span><strong>3. 一种被否决的朴素方案</strong></span>
  <a href="#3-%e4%b8%80%e7%a7%8d%e8%a2%ab%e5%90%a6%e5%86%b3%e7%9a%84%e6%9c%b4%e7%b4%a0%e6%96%b9%e6%a1%88" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>思路</strong>: 设计一个简单的键值对（Key-Value）结构来记录每个 <code>tick</code> 的状态。
<ul>
<li><code>mapping(int24 =&gt; bool)</code></li>
<li><code>Key</code>: <code>tick</code> 索引 (例如: -10000, 20000)</li>
<li><code>Value</code>: <code>true</code> (被用作边界) 或 <code>false</code> (未被用作边界)</li>
</ul>
</li>
<li><strong>致命缺陷</strong>:
<ol>
<li><strong>存储量巨大</strong>: <code>tick</code> 的总数约有 177 万个。为每一个 <code>tick</code> 都创建一个存储槽位在区块链上是无法承受的，成本极高。</li>
<li><strong>计算量巨大 (高 Gas 费)</strong>: 当一笔交易（swap）需要跨越成千上万个 <code>tick</code> 时，如果需要逐一查询这些 <code>tick</code> 的状态，将会导致交易的 Gas 费极高，用户无法接受。</li>
</ol>
</li>
</ul>
<h4 id="4-uniswap-v3-的精巧解决方案tick-bitmap" class="heading-element"><span><strong>4. Uniswap V3 的精巧解决方案：Tick BitMap</strong></span>
  <a href="#4-uniswap-v3-%e7%9a%84%e7%b2%be%e5%b7%a7%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88tick-bitmap" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><img loading="lazy" src='/posts/202509-uniswap14/tick_bitmap.png' alt="Tick indexes in tick bitmap" height="432" width="1058"></p></div><div class="post-footer">
    <a href="/posts/202509-uniswap14/">Read More</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/web3/' class="post-tag">Web3</a></div></div>
</article><article class="single summary" itemscope itemtype="http://schema.org/Article"><h2 class="single-title" itemprop="name headline"><a href="/posts/202509-uniswap15/">15.Uniswap V3 Tick Bitmap 寻找下一个 Tick</a>
  </h2><div class="post-meta"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span>&nbsp;<span class="post-publish" title='2025-09-02 00:00:00'>published on <time datetime="2025-09-02">2025-09-02</time></span><span class="post-included-in">&nbsp;included in <a href="/categories/technology/" class="post-category" title="Category - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="content"><h4 id="核心摘要-key-takeaways" class="heading-element"><span><strong>核心摘要 (Key Takeaways)</strong></span>
  <a href="#%e6%a0%b8%e5%bf%83%e6%91%98%e8%a6%81-key-takeaways" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li><strong>Tick Bitmap 的核心作用</strong>：它是一个 <code>uint256</code> 的位图，用于高效追踪 Uniswap V3 池中哪些价格点（Ticks）被用作了流动性区间的边界。<code>1</code> 代表该 Tick 活跃（有流动性），<code>0</code> 代表不活跃。</li>
<li><strong>寻找下一个 Tick 的目的</strong>：在进行交易（Swap）时，价格会发生变动。当价格穿过一个活跃的 Tick，意味着当前流动性区间的流动性（L）将被耗尽，合约必须找到下一个有流动性的价格区间才能继续完成交易。</li>
<li><strong>通过位运算实现高效查找</strong>：寻找下一个活跃 Tick 的过程利用了**掩码（Mask）<strong>和</strong>按位与（Bitwise AND）**运算。通过构建特定的掩码，可以快速地隔离出目标方向（价格升高或降低）上所有活跃的 Ticks。</li>
<li><strong>交易方向决定搜索方向</strong>：
<ul>
<li>当交易导致<strong>价格上涨</strong>时（例如用 USDC 买 ETH），需要在 Tick Bitmap 中向<strong>左</strong>搜索（寻找更大的 Tick）。</li>
<li>当交易导致<strong>价格下跌</strong>时（例如卖出 ETH 换 USDC），需要在 Tick Bitmap 中向<strong>右</strong>搜索（寻找更小的 Tick）。</li>
</ul>
</li>
<li><strong>Bitmap 内部方向与全局 Tick 轴方向的区别</strong>：在 Bitmap（一个 <code>uint256</code>）内部，索引位（<code>bit position</code>）从右到左增大，因此向<strong>左</strong>查找意味着寻找<strong>更大</strong>的 Tick 值。这与全局价格数轴上数值从左到右增大的直觉相反，需要注意区分。</li>
</ul>
<hr>
<h4 id="i-tick-bitmap-核心概念回顾" class="heading-element"><span><strong>I. Tick Bitmap 核心概念回顾</strong></span>
  <a href="#i-tick-bitmap-%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5%e5%9b%9e%e9%a1%be" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>本节内容对应 <code>TickBitmap.sol</code> 库合约中的核心逻辑。</p></div><div class="post-footer">
    <a href="/posts/202509-uniswap15/">Read More</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/web3/' class="post-tag">Web3</a></div></div>
</article><ul class="pagination"><li class="page-item">
          <span class="page-link">
            <a href="/">1</a>
          </span>
        </li><li class="page-item">
          <span class="page-link">
            <a href="/page/2/">2</a>
          </span>
        </li><li class="page-item active">
          <span class="page-link">
            <a href="/page/3/">3</a>
          </span>
        </li><li class="page-item">
          <span class="page-link">
            <a href="/page/4/">4</a>
          </span>
        </li><li class="page-item">
          <span class="page-link">
            <a href="/page/5/">5</a>
          </span>
        </li><li class="page-item">
          <span class="page-link" aria-hidden="true">&hellip;</span>
        </li><li class="page-item">
          <span class="page-link">
            <a href="/page/18/">18</a>
          </span>
        </li></ul></div></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.149.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.17-8212d6fd"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"version":"v0.3.17-8212d6fd"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
